<?xml version="1.0" encoding="UTF-8"?>
<application name="STP" code="100" log_level="INFO">
    <!-- 商户系统交易 -->
    
    <!--  交易日志记录配置  -->
    <include file="etc/public/STPCTL_TRC.XML"/>
    <!--公共宏文件引入-->
    <include file="etc/public/Merchant_MACRO.XML"/>
    <include file="etc/public/Order_MACRO.XML"/>
    
    <!--  交易前处理  -->
    <before>
     <set name="USRIP"         expr="_REQUESTATTR.REQIP"/>
     <set name="MsgTyp"        value="N"/>
     <set name="RspCod"        value="00000"/>
     <!-- 当前日期  -->
     <set name="nowDate"       expr="GETDATETIME('YYYYMMDD')"/>
     <!-- 当前时间  -->
     <set name="nowTime"       expr="GETDATETIME('HHMISS')"/> 
     <!-- 取公共参数配置 -->
     <set name="ConfigName"    value="BeforeCfg"/>
     <quote name="ReadXmlCfg"/>
     
     <do func="DumpMsg" />
     
    </before>
    
    <!--  交易后处理  -->
    <after>
     <if condition="IS_EQUAL_STRING(RspCod,'00000')">
       <set name="MsgTyp"       value="N"/>
       <set name="RspMsg"       value="交易成功"/>
     </if>
     <else>
       <set name="MsgTyp"       value="E"/>
     </else>
     <do expr="@tangdi.engine.context.Msg@dump()"/>
    </after>
    
    <macro name="DirectChannelCCB">
       <!--建行银企直连 START-->
       <!--获取序号 -->
       <do func="GetSeqNo"  error="IGNORE">
          <para name="TblNam"   value="stpseqrec"/>
          <para name="KeyNam"   value="KeyNam"/>
          <para name="KeyVal"   expr="STRCAT('StpBnkPay','REQUEST_SN')"/>
          <para name="SeqNam"   value="KeyVal"/>
          <para name="Len"      value="8"/>
          <para name="Circle"   value="1"/>
       </do>
       <if condition="#RetCod!=0">
          <set name="MsgTyp"    value="E"/>
          <set name="RspCod"    value="09001"/>
          <set name="RspMsg"    value="获取序号错误"/>
          <return/>
       </if>
       <set name="REQUEST_SN"   expr="STRCAT(SUBSTR(GETDATETIME(),0,8),KeyVal)"/>
       
       <!--读取xml参数-->
       <set name="ConfigName"   value="StpBnkPayCfg"/>
       <quote name="ReadXmlCfg"/>
       
       <set name="TXAMT"         expr="STLAMT"/>
       <set name="PayTyp"        value="01"/><!--代发类型 00-用户提现代发 01-商户结算代发-->
       <set name="PaySts"        value="00"/><!--00:等待处理 01:交易成功 02:交易失败-->
       <set name="ACC_NO2"       expr="DES_ENCRYPT(CUST_STL_BANK_AC_NO)"/><!--收款账户账号-->
       <set name="RECV_ACC_NAME" expr="CUST_BANK_DEPOSIT_NAME"/><!--收款账户户名-->
       <set name="USEOF"         value="商户提现"/><!--用途-->
       
       <!--登记银行代付信息-->
       <do func="InsertRecord" error="IGNORE">
          <para name="TblNam"   value="StpBnkPay" />
       </do>
       <if condition="#RetCod!=0">
          <set name="MsgTyp"    value="E"/>
          <set name="RspCod"    value="09999"/>
          <set name="RspMsg"    value="系统错误"/>
          <return/>
       </if>
       
       <set name="AMOUNT"        expr="AMTADDDOT(TXAMT)"/><!--代发金额-->
       
       <if condition="OR(IS_EQUAL_STRING(SUBSTR(BANK_REL_NO,1,3),'102'),IS_EQUAL_STRING(SUBSTR(BANK_REL_NO,1,3),'105'))"><!--建行-->
          <set name="ThdCde"              value="6W8010"/>
          <set name="UBANK_NO"            value="56888"/>
          <set name="RECV_EXCHANGENO"     value="56888"/>
          <set name="RECV_OPENACC_DEPT"   value="广东省分行"/>
          <set name="RECV_COUNTERNO"      value="440000000"/>
       </if>
       <else><!--非建行-->
          <set name="BankCode"  expr="SUBSTR(BANK_REL_NO,1,3)"/>
          <set name="ThdCde"    value="6W8060"/>
          <do func="ReadRecord"><!--获取超级网银联行号-->
            <para name="SqlCmd" sql="SelUBANKNO" />
          </do>
          <if condition="#RetCod!=0">
            <set name="RSPCOD" value="02040"/>
            <set name="RspMsg" value="超级网银联行号不存在，请联系系统管理"/>
            <return/>
          </if>
          
          <set name="UBANK_NO"          expr="UBANK_NO"/><!--转入账户联行号-->
          <set name="RECV_OPENACC_DEPT" expr="BankNam"/><!--转入账户开户机构名称-->
       </else>
       
       <!--调用建行企业网银转账-->
       <do func="CallThird" error="IGNORE">
          <para name="channel"  value="STHDCCB1"/>
          <para name="code"     expr="ThdCde"/>
       </do>
       <if condition="OR(#RetCod==1,#RetCod==10,#RetCod==-1)">
         <if condition="ISNULL(RETURN_CODE)"><!--超时需线下业务人工处理-->
           <set name="PaySts"       value="00"/><!--00:等待处理 01:交易成功 02:交易失败-->
         </if>
         <else>
           <if condition="IS_NOEQUAL_STRING(RETURN_CODE,'000000')">
             <set name="PaySts"     value="02"/><!--00:等待处理 01:交易成功 02:交易失败-->
           </if>
           <else>
             <set name="PaySts"     value="01"/><!--00:等待处理 01:交易成功 02:交易失败-->
           </else>
         </else>
         <set name="RETURN_CODE"  expr="RETURN_CODE"/>
         <set name="RETURN_MSG"   expr="RETURN_MSG"/>
       </if>
       <elseif condition="#RetCod==0">
         <if condition="IS_EQUAL_STRING(RETURN_CODE,'000000')">
           <set name="PaySts"       value="01"/><!--00:等待处理 01:交易成功 02:交易失败-->
         </if>
         <elseif condition="IS_EQUAL_STRING(RETURN_CODE,'WLPT_Err1001')"><!--银企直连客户端与建行通讯超时-->
           <set name="PaySts"       value="00"/><!--00:等待处理 01:交易成功 02:交易失败-->
         </elseif>
         <else>
           <set name="PaySts"       value="02"/><!--00:等待处理 01:交易成功 02:交易失败-->
         </else>
         <set name="RETURN_CODE"   expr="RETURN_CODE"/>
         <set name="RETURN_MSG"    expr="RETURN_MSG"/>
       </elseif>
       <else>
         <set name="PaySts"         value="02"/><!--00:等待处理 01:交易成功 02:交易失败-->
         <set name="RETURN_CODE"    expr="RETURN_CODE"/>
         <set name="RETURN_MSG"     expr="RETURN_MSG"/>
       </else>
       
       <!--更新银行代付信息-->
       <do func="UpdateRecord" error="IGNORE">
          <para name="TblNam"   value="StpBnkPay"/>
          <para name="CndSts"   sql="UpdBnkPay"/>
       </do>
       <if condition="#RetCod!=0">
          <set name="MsgTyp"    value="E"/>
          <set name="RspCod"    value="09999"/>
          <set name="RspMsg"    value="系统错误"/>
          <return/>
       </if>
       
       <do func="CommitWork"/>
       
       <!-- 商户结算失败 -->
       <if condition="IS_NOEQUAL_STRING(PaySts,'01')">
          <set name="MsgTyp"   value="E"/>
          <set name="RspCod"   expr="RETURN_CODE"/>
          <set name="RspMsg"   expr="RETURN_MSG"/>
          <return/>
       </if>
       <!--建行银企直连 END-->
    </macro>
    
    <transaction code="settleExportForward" desc="商户结算对账单导出跳转">
     <process>
       <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/settleman/settleExport.jsp')" />
       
     </process>
    </transaction>
    
    <transaction code="StlExportForDate"  desc="商户结算对账单导出">
     <sql name="qryySettxq">
         SELECT distinct f.MERNO CUST_ID,f.PrdOrdNo,f.BATNO,r.PROD_NAME,
                 TO_CHAR(to_number(nvl(f.ordAmt,0.00))/100,'FM9999,999,999,990.00') ORDAMT,
                 TO_CHAR(to_number(nvl(f.fee,0.00))/100,'FM9999,999,999,990.00')  comamt,'0.00' rfcomamt,
                 TO_CHAR(to_number(nvl(f.ordAmt,0.00)-nvl(f.fee,0.00))/100,'FM9999,999,999,990.00') netRecAmt,
                 TO_CHAR(to_date(p.STL_DATE,'yyyyMMdd'),'yyyy-MM-dd') STL_DATE ,
                 TO_CHAR(to_date(f.orderTime,'yyyyMMdd hh24miss'),'yyyy-MM-dd hh24:mi:ss') ORDERTIME 
            FROM  ARP_BANK_PAY_STL p  , ARP_BANK_REC_STL f inner join stpproinf r on r.prod_code=f.prodcode
           WHERE f.batNo=p.BATCH_NO and f.merno=p.mer_no and f.merno=#{CUST_ID} ${qry1}  order by PrdOrdNo
     </sql> 
     <process>
          <set name="CUST_ID"                expr="SESSIONS.MERID"/>
          <!--检查商户登录平台是否正确-->
          <if condition="IS_NOEQUAL_STRING(SysCod,'2201')">
             <set name="MsgTyp"       value="E"/>
             <set name="RspCod"       value="01001"/>
             <set name="RspMsg"       value="商户登录平台不正确"/>
             <return/>
          </if>
          
           <!-- 开始时间范围 -->
           <if condition="IS_EQUAL_STRING(STARTDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="startDate"   expr="CALCDATE(GETDATE(),'-','d',30)" />
               <set name="startDate"   expr="FMTDATE(startDate,0,4)"/>
               <set name="start_date"  expr="FMTDATE(STARTDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(STARTDATE),4,8)">
                   <set name="startDate"   expr="FMTDATE(STARTDATE,4,0)" />         <!-- 开始时间 -->
                   <set name="start_date"  expr="startDate"/>
               </if>
           </else>
           
           <set name="APPLYSTARTDATE"  expr="startDate"/>
           <set name="qry1"        expr="STRCAT('and substr(p.STL_DATE,1,8) = \'',startDate,'\'  ')"/> 
            
            <do func="QueryInGroup" error="IGNORE">
               <para name="SqlCmd"     sql="qryySettxq"/>
               <para name="RecordName" value="reportList"/>
               <para name="RecNum"     value="RECNUM"/>
            </do>
            <if condition="#RetCod==-1">
             <set name="RspCod"    value="09101"/>
             <set name="RspMsg"    value="操作数据库失败!"/>
             <return/>
           </if>
           <do func="ReportExport" error="IGNORE">
               <para name="Root"          value="reportList"/>
               <para name="FileDemo"      value="merStlRecod"/> <!--导出模板名-->
               <para name="NameForUser"   value="merStlRecod"/> <!--导出文件名-->
               <para name="FilePath"      value="rptdemo"/>       <!--导出模板路径-->
               <para name="FileToPath"    value="/dat/download"/> <!--导出目标地址-->
               <para name="WebPath"       expr="GETCURAPPHOME()"/>
               <para name="params"        value="CUST_ID/PRDORDNO/PROD_NAME/ORDAMT/COMAMT/NETRECAMT/STL_DATE/BATNO"/>
               <para name="collectParams" value=""/> <!--导出总条数，总金额如果没有传空-->
           </do>
           <if condition="#RetCod!=0">
               <set name="RspCod"          value="02103"/>
               <set name="RspMsg"          value="导出出错!"/>
               <set name="DWZ_STATUS_CODE" value="300"/>
               <set name="DWZ_RSP_MSG"     expr="RSPMSG"/> 
               <return/>
           </if>
           <set name="FILENAME"    expr="#FILENAME"/>
           <!--读取xml参数 -->
           <set name="ConfigName"   value="FtpGetToResinMerchant"/>
           <quote name="ReadXmlCfg"/>
           
           <do func="MoveFile">
               <para name="srcDir" expr="LclDir"    />
               <para name="srcFil" expr="FILENAME"  />
               <para name="tarDir" expr="ObjDir"    />
           </do>
           <if condition="#RetCod!=0"> 
               <set name="RspCod"  value="01007"/>  
               <set name="RspMsg"  value="移动文件错误!"/>  
               <return/> 
           </if>
           
           <set name="pos_webapps"              expr="GETSTRPOS(ObjDir,'/webapps/')"                                />
           <set name="ObjDir"                   expr="RIGHTSTR(ObjDir,SUB(STRLEN(ObjDir),ADD(pos_webapps,8)))"      />
         
           <set name="_REQUESTATTR.REDIRECTURL" expr="STRCAT('/',ObjDir,'/',FILENAME)"/>
           <set name="RspMsg"                   value="上传服务保存成功,导出成功"/>
           <set name="DWZ_STATUS_CODE"          value="DWZ_SUCCESS_CODE"/>
           <set name="DWZ_RSP_MSG"              expr="RspMsg"/>
           <set name="RspCod"                   value="00000"/>
           
     </process>
    </transaction>
    
    <transaction code="netTranRecord" desc="线上交易查询">
       <sql name="QMerTotalOrdInfo">
         select count(*) as TOTALRECNUMS,TO_CHAR(to_number(nvl(sum(ordAmt),0))/100,'FM9999,999,999,990.00') TOTALPRDAMT 
         from StpPrdInf b where  b.merno=#{merid} and b.OrdStatus='01' ${ordprdOrdNo} ${ordprdName} ${orderDate} ${prdordamt} 
       </sql>
       <sql name="QMerOrdInfoAll">    <!-- 查询所有的交易记录  商品订单左连接支付订单 -->
         select distinct(case when b.OrdStatus in ('01','12') then ('01'||c.actdat||b.prdordno) else ('00'||b.orderTime||b.prdordno) end) as seqno,
                b.biztype,b.merNo,b.cust_id as userID,b.prdOrdNo,b.PRDORDTYPE,
                TO_CHAR(to_number(nvl(b.ordAmt,0))/100,'FM9999,999,999,990.00') as ordamt,
                case when  b.ordertime != ' ' then To_Char(to_date(b.orderTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end orderTime,
                b.OrdStatus,nvl(b.prdName,' ') as prdName,nvl(b.ordAmt,0) ordtotalAmt,
                CASE when b.PRDORDTYPE='1' then '4' when b.PRDORDTYPE='0' then '2' 
                when b.PRDORDTYPE='2' then '2' when b.PRDORDTYPE='3' then '4' end  PAGEFLAGS,
                nvl(b.RFTOTALAMT,0) RFTOTALAMT,
                TO_CHAR(to_number(nvl(b.ordAmt,0)-nvl(b.RFTOTALAMT,0))/100,'FM9999,999,999,990.00') as KERFAMT,
                TO_CHAR(to_number(nvl(b.RFTOTALAMT,0))/100,'FM9999,999,999,990.00') as RFAMT,
                case when c.actdat !=' ' then TO_CHAR(to_date(c.actdat,'yyyymmddhh24miss'),'yyyy-mm-dd  hh24:mi:ss')end actdat
         from StpPrdInf b  left join stppayinf c on (trim(b.prdOrdNo)=trim(c.prdOrdNo)) and b.payordno = c.payordno
         where b.merno=#{merid} and ((b.OrdStatus in ('01','12') and c.ordstatus='01') or b.OrdStatus not in ('01','12')) 
         ${ordprdOrdNo} ${ordprdName} ${orderDate} ${prdOrdStatus} ${prdordamt} ${txnDate}
         order by seqno desc
       </sql>
     <process>
         
         <if condition="IS_EQUAL_STRING(OPERATING,'0')">
              <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/tranRecord.jsp')" />
         </if>
         <else>
            <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/OnlineTradRecd.jsp')" />
         </else>
         
         <set name="FLAG"        value="01"/>
         <set name="merid"       expr="SESSIONS.MERID"/>
         
         <!-- 分页参数定义 -->
         <if condition="ISNULL(PageNum)">
            <set name="PageNum" value="1"/>
         </if>
         <if condition="ISNULL(NumPerPag)">
            <set name="NumPerPag" value="10"/>
         </if>
           <set name="Fh" value="'" />
           
           <!--商品订单号 -->
           <if condition="IS_EQUAL_STRING(prdOrdNo,'')">
                <set name="ordprdOrdNo" value=""/>
           </if>
           <else>
                <set name="ordprdOrdNo" expr="STRCAT(' and b.prdOrdNo = ',fh,prdOrdNo,fh)"/>
           </else>
           
           <!--交易商品名称 -->
           <if condition="IS_EQUAL_STRING(prdName,'')">
                <set name="ordprdName"  value=""/>
           </if>
           <else>
                <set name="ordprdName"  expr="STRCAT(' and b.prdName like ',fh,'%',prdName,'%',fh)"/>
           </else>
           
           <!--订单状态--> 
           <if condition="IS_EQUAL_STRING(OrdStatus,'')">
                <set name="prdOrdStatus"     value=""/>
           </if>
           <else>
                <set name="prdOrdStatus"    expr="STRCAT(' and b.OrdStatus = ',fh,OrdStatus,fh)"/>
           </else>
           
           <!--订单最小金额 -->
           <if condition="ISNULL(minAmt)">
                <set name="minAmt"     value=""/>
           </if>
           <else>
               <set name="minAmt"            expr="AMTPOWER(minAmt,'2')"/>
           </else>
           <!--订单最大金额 -->
           <if condition="ISNULL(maxAmt)">
                <set name="maxAmt"     value=""/>
           </if>
           <else>
               <set name="maxAmt"        expr="AMTPOWER(maxAmt,'2')"/>
           </else>
           <if condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt" value=""/>
           </if>
           <elseif condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_NOEQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and b.ordAmt  &gt;= to_number(',Fh, minAmt ,Fh,')')" />
           </elseif>
           <elseif condition="AND(IS_NOEQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and  b.ordAmt &lt;= to_number(',Fh, maxAmt ,Fh,')')" />
           </elseif>
           <else>
             <if condition="INTCMP(maxAmt,1,minAmt)">
                 <set name="RspCod" value="08040" />
                 <set name="RspMsg" value="最大金额小于最小金额" />
                 <return />
             </if>
             <set name="prdordamt"  expr="STRCAT(' and b.ordAmt between to_number(\'',minAmt,'\') and to_number(\'',maxAmt,'\')')"/>
             
           </else>
           <!-- 开始和结束时间范围 -->
           <if condition="IS_EQUAL_STRING(STARTDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="startDate" expr="CALCDATE(GETDATE(),'-','d',30)" />
               <set name="startDate" expr="FMTDATE(startDate,0,4)"/>
               <set name="start_date"  expr="FMTDATE(STARTDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(STARTDATE),4,8)">
                   <set name="startDate"   expr="FMTDATE(STARTDATE,4,0)" />         <!-- 开始时间 -->
                   <set name="start_date"  expr="startDate"/>
               </if>
           </else>

           <if condition="IS_EQUAL_STRING(ENDDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="endDate"  expr="GETDATETIME('YYYYMMDD')" />
               <set name="endDate"  expr="FMTDATE(endDate,0,4)"/>
               <set name="end_date"  expr="FMTDATE(ENDDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(ENDDATE),4,8)">
                   <set name="endDate"   expr="FMTDATE(ENDDATE,4,0)" />       <!-- 结束时间 -->
                   <set name="end_date"  expr="endDate"/>
               </if>
           </else>
           
           <if condition="INTCMP(end_date,1,start_date)">
               <set name="RspCod" value="08040" />
               <set name="RspMsg" value="订单结束日期小于开始日期" />
               <return />
           </if>
           <set name="orderDate"  expr="STRCAT(' and b.ordertime  &gt;= ',Fh, STRCAT(start_date,'000000'),Fh,' and  b.ordertime &lt;=',Fh,STRCAT(end_date,'235959'),Fh)" />
           
           <!-- 支付开始和结束时间范围 -->
            <if condition="AND(NOT(ISNULL(PAYSTARTDATE)),NOT(ISNULL(PAYENDDATE)))">
                <if condition="INTCMP(STRCMP(FMTDATE(PAYSTARTDATE,4,0),FMTDATE(PAYENDDATE,4,0)),6,0)">
                	<set name="RsgMsg"          value="01002"   />
                	<set name="RspMsg"          value="支付开始日期不能早于结束日期"/>
                	<set name="DWZ_STATUS_CODE" value="300"     />
                	<set name="DWZ_RSP_MSG"     expr="RspMsg"   />
                	<return/>
                </if>
            		<set name="PAY_START_DATE" expr="STRCAT(FMTDATE(PAYSTARTDATE,4,0),'000000')" />
            		<set name="PAY_END_DATE"   expr="STRCAT(FMTDATE(PAYENDDATE,4,0),'235959')" />
            		<set name="txnDate" expr="STRCAT(' AND c.actdat BETWEEN  ',fh,PAY_START_DATE,fh,' AND ',fh,PAY_END_DATE,fh)"/>
            </if>
            <elseif condition="AND(NOT(ISNULL(PAYSTARTDATE)),ISNULL(pay_end_date))">
                    <set name="PAY_START_DATE" expr="STRCAT(FMTDATE(PAYSTARTDATE,4,0),'000000')" />
            		<set name="PAY_END_DATE"   value="20991231235959" />
            		<set name="txnDate" expr="STRCAT(' AND c.actdat BETWEEN  ',fh,PAY_START_DATE,fh,' AND ',fh,PAY_END_DATE,fh)"/>
            </elseif>
            <elseif condition="AND(ISNULL(PAYSTARTDATE),NOT(ISNULL(pay_end_date)))">
                    <set name="PAY_START_DATE" value="19700101000000" />
            		<set name="PAY_END_DATE"   expr="STRCAT(FMTDATE(PAYENDDATE,4,0) ,'235959')" />
            		<set name="txnDate" expr="STRCAT(' AND c.actdat BETWEEN  ',fh,PAY_START_DATE,fh,' AND ',fh,PAY_END_DATE,fh)"/>
            </elseif>
            <else>
            	<set name="txnDate" value=""/>
            </else>
           
           <!-- 统计成功的总笔数和总金额 -->
           <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QMerTotalOrdInfo" />
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录!"/>
             <set name="TOTALRECNUMS" value="0"/>
             <set name="TOTALPRDAMT"  value="0.00"/>
           </if>
           <elseif condition="#RetCod!=0">
              <set name="RspCod"    value="09101"/>
              <set name="RspMsg"    value="操作数据库失败!"/>
              <return/>
           </elseif>
           
           <!--查询商品订单信息 -->
           <do func="PagedQuery" error="IGNORE">
                  <para name="PageNum" expr="PageNum"/>
                  <para name="NumPerPag" expr="NumPerPag"/>
                  <para name="Sql" sql="QMerOrdInfoAll"/>
             </do>
           <if condition="#RetCod==2">
             <set name="MsgTyp"    value="N"/>
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录！!"/>
           </if>
           <elseif condition="#RetCod!=0">
             <set name="RspCod"    value="09101"/>
             <set name="RspMsg"    value="操作数据库失败!"/>
             <return/>
           </elseif>
         
           <set name="ALLPAGENUM" expr="DIV(TOLCNT,NUMPERPAG)" />
           <set name="mob" expr="MOD(TOLCNT,NUMPERPAG)" />
           <if condition="IS_NOEQUAL_STRING(MOB,'0')">
              <set name="ALLPAGENUM" expr="ADD(ALLPAGENUM,1)" />
           </if>
           <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
              <set name="PageNum" expr="ALLPAGENUM" />
           </if>
           <if condition="INTCMP(ALLPAGENUM,6,'0')">
              <if condition="INTCMP(PageNum,3,'0')">
                 <set name="PageNum" value="1" />
              </if>
           </if>
         
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
    <transaction code="QryTranDetail" desc="商品详细查询">
       <sql name="QryMerOrdetail"> <!-- 查询商户订单信息   -->
         select p.cust_id as userID,p.merNo,p.prdOrdNo,
         TO_CHAR(to_number(ordamt)/100,'FM9999,999,999,990.00') as ORDERAMT,
         TO_CHAR(to_number(nvl(RFTOTALAMT,0))/100,'FM9999,999,999,990.00') as RFAMT,
         case when   ordertime != ' ' then To_Char(to_date( orderTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end  orderTime,
         substr(case when ordertime !=' ' then To_Char(to_date(ordertime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')end ,1,10) orderDate,
         substr(case when ordertime !=' ' then  To_Char(to_date(orderTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end ,11,19) orderTime,
         ordCcy,p.prdName,
          CASE when p.PRDORDTYPE='1' then '充值' when p.PRDORDTYPE='0' then '消费' 
           when p.PRDORDTYPE='2' then '担保支付' when p.PRDORDTYPE='3' then '商户充值' 
            when p.PRDORDTYPE='4' then '理财转入'  when p.PRDORDTYPE='5' then '理财转出'
           end  PRDORDTYPE,
         CASE when c.paytype='00' then '支付帐号' when c.paytype='01' then '网银支付' 
         when c.paytype='02' then '终端' when c.paytype='03' then '快捷支付' 
         when c.paytype='04' then '混合支付'  
         END paytype,
      CASE WHEN p.OrdStatus='00' THEN '未支付'   WHEN p.OrdStatus='01' THEN '交易成功'
        WHEN p.OrdStatus='02' THEN '退款成功' WHEN p.OrdStatus='03' THEN '退款失败'
         WHEN p.OrdStatus='11' THEN '订单作废'  WHEN p.OrdStatus='12' THEN '支付成功'   END OrdStatus
         from StpPrdInf  p left join stppayinf c  on (trim(p.prdOrdNo)=trim(c.prdOrdNo)) 
         where p.prdOrdNo=#{PRDORDNO} 
         order by p.orderTime desc
       </sql>
       <sql name="QryMerBackInf"> <!-- 查询商户退款信息 -->
         select a.ORDSTATUS,a.refordNo PRDORDNO,a.ORIPRDORDNO ,b.prdName,
           TO_CHAR(to_number(nvl(b.ordAmt,0))/100,'FM9999,999,999,990.00') as ORDERAMT,
           nvl(b.ordAmt,0) ordtotalAmt,  nvl(b.RFTOTALAMT,0) RFTOTALAMT,a.RFSAKE,
           TO_CHAR(to_number(nvl(a.RFAMT,0))/100,'FM9999,999,999,990.00') as RFAMT,
           case when  b.ordertime != ' ' then To_Char(to_date(b.orderTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end  ORDERDATE,
           case when a.rfordtime !=' ' then to_char(to_date(substr(a.rfOrdTime,0,8),'yyyymmdd'),'yyyy-mm-dd') end  rforderTime,
           case when a.rfReqDate !=' ' then  to_char(to_date(substr(a.rfReqDate,0,8),'yyyymmdd'),'yyyy-mm-dd') end ORDERDATE,
           case when a.rfReqDate != ' ' then To_Char(to_date(a.rfReqDate,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end  orderTime,
           CASE when b.PRDORDTYPE='1' then '充值' when b.PRDORDTYPE='0' then '消费' 
           when b.PRDORDTYPE='2' then '担保支付' when b.PRDORDTYPE='3' then '商户充值' 
            when b.PRDORDTYPE='4' then '理财转入'  when b.PRDORDTYPE='5' then '理财转出'
           end  PRDORDTYPE,
          CASE WHEN a.OrdStatus='00' THEN '未支付'  WHEN a.OrdStatus='03' THEN '退款失败'
          WHEN a.OrdStatus='02' THEN '退款成功'     END OrdStatus,
           nvl(a.cust_id,'') as userid,6 as pageflags 
           from stprefinf a left join stpprdinf b on trim(a.oriPrdOrdNo)=trim(b.prdOrdNo)
           where  REFORDNO=#{prdOrdNo}
       </sql>
     <process>
         
         <set name="prdOrdNo"     expr="PRDORDNO"/>
         <set name="PAGEFLAGS"   expr="PAGEFLAGS"/>
         <!-- 退款详情查询 -->
         <if condition="IS_EQUAL_STRING(PAGEFLAGS,'6')"> 
           <do func="ReadRecord" error="IGNORE">
             <para name="SqlCmd"        sql="QryMerBackInf"/>
           </do>
         </if>
         <else>
             <!-- 商品订单详情查询 -->
             <do func="ReadRecord" error="IGNORE">
                 <para name="SqlCmd"        sql="QryMerOrdetail"/>
               </do>
         </else>
         <if condition="#RetCod==2">
            <set name="MsgType"    value="E"/> 
            <set name="RspCod"     value="01003"/>
            <set name="RspMsg"     value="无符合条件记录"/>
            <return/>
         </if>
         <elseif condition="#RetCod!=0">
            <set name="MsgType"    value="E"/> 
            <set name="RspCod"     value="09999"/>
            <set name="RspMsg"     value="系统错误"/>
            <return/> 
         </elseif>
         
         <if condition="IS_EQUAL_STRING(refflag,'0')">
             <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/refundTran.jsp')" />
         </if>
         <else>
             <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/trandetail.jsp')" />
       </else>
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
    <transaction code="netRefundRecord" desc="商户退款查询">
     <sql name="QryMerRefInf"> <!-- 查询商户退款信息  -->
       select a.ORDSTATUS,a.refordNo PRDORDNO,a.ORIPRDORDNO ,b.prdName,
              TO_CHAR(to_number(nvl(b.ordAmt,0))/100,'FM9999,999,999,990.00') as ordamt,
              nvl(b.ordAmt,0) ordtotalAmt,nvl(b.RFTOTALAMT,0) RFTOTALAMT,
              TO_CHAR(to_number(nvl(a.RFAMT,0))/100,'FM9999,999,999,990.00') as RFAMT,
              case when  b.ordertime != ' ' then To_Char(to_date(b.orderTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end  orderdateTime,
              case when a.rfordtime !=' ' then to_char(to_date(a.rfOrdTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end  ORDERTIME,
              case when a.rfReqDate != ' ' then To_Char(to_date(a.rfReqDate,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end  RFREQDATE,
              nvl(a.cust_id,'') as userid,6 as pageflags 
        from stprefinf a left join stpprdinf b on trim(a.oriPrdOrdNo)=trim(b.prdOrdNo)
       where a.MERNO=#{MERID}  ${ordprdOrdNo} ${ordprdName} ${orderDate} ${prdOrdStatus} ${prdordamt}
        order by a.rfReqDate desc
     </sql>
     <sql name="QryMertotalInf"> <!-- 统计退款成功的总笔数和总金额  -->
       select count(*) as TOTALRECNUMS ,TO_CHAR(to_number(nvl(sum(RFAMT),0))/100,'FM9999,999,999,990.00') TOTALPRDAMT
         from stprefinf b
        where b.ORDSTATUS='00' and b.MERNO=#{MERID} 
     </sql>
     <process>
           <if condition="IS_EQUAL_STRING(OPERATING,'0')">
              <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/tranRecord.jsp')" />
           </if>
           <else>
              <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/OnlineTradRecd.jsp')" />
           </else>
           <set name="FLAG"        value="02"/>
           <set name="merid"       expr="SESSIONS.MERID"/>
           
           <!-- 分页参数定义 -->
           <if condition="ISNULL(PageNum)">
              <set name="PageNum" value="1"/>
           </if>
           <if condition="ISNULL(NumPerPag)">
              <set name="NumPerPag" value="10"/>
           </if>
           <set name="Fh" value="'" />
           
           <!--商品订单号 -->
           <if condition="IS_EQUAL_STRING(prdOrdNo,'')">
                <set name="ordprdOrdNo" value=""/>
           </if>
           <else>
                <set name="ordprdOrdNo" expr="STRCAT(' and a.refordNo = ',fh,prdOrdNo,fh)"/>
           </else>
           
           <!--交易商品名称 -->
           <if condition="IS_EQUAL_STRING(prdName,'')">
                <set name="ordprdName"  value=""/>
           </if>
           <else>
                <set name="ordprdName"  expr="STRCAT(' and b.prdName like ',fh,'%',prdName,'%',fh)"/>
           </else>
           
           <!--订单状态--> 
           <if condition="IS_EQUAL_STRING(OrdStatus,'')">
                <set name="prdOrdStatus"     value=""/>
           </if>
           <else>
                <set name="prdOrdStatus"    expr="STRCAT(' and a.OrdStatus like ',fh,'%',OrdStatus,'%',fh)"/>                                      
           </else>
           
           <!--订单最小金额 -->
           <if condition="ISNULL(minAmt)">
                <set name="minAmt"     value=""/>
           </if>
           <else>
                 <set name="minAmt"            expr="AMTPOWER(minAmt,'2')"/>
           </else>
           <!--订单最大金额 -->
           <if condition="ISNULL(maxAmt)">
                <set name="maxAmt"     value=""/>
           </if>
           <else>
                 <set name="maxAmt"        expr="AMTPOWER(maxAmt,'2')"/>
           </else>
           <if condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt" value=""/>
           </if>
           <elseif condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_NOEQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and b.ordAmt  &gt;= to_number(',Fh, minAmt ,Fh,')')" />
           </elseif>
           <elseif condition="AND(IS_NOEQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and  b.ordAmt &lt;= to_number(',Fh, maxAmt ,Fh,')')" />
           </elseif>
           <else>
             <if condition="INTCMP(maxAmt,1,minAmt)">
                 <set name="RspCod" value="08040" />
                 <set name="RspMsg" value="最大金额小于最小金额" />
                 <return />
             </if>
             <set name="prdordamt"  expr="STRCAT(' and b.ordAmt between to_number(\'',minAmt,'\') and to_number(\'',maxAmt,'\')')"/>
             
           </else>
           <!-- 开始和结束时间范围 -->
           <if condition="IS_EQUAL_STRING(STARTDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="startDate" expr="CALCDATE(GETDATE(),'-','d',30)" />
               <set name="startDate" expr="FMTDATE(startDate,0,4)"/>
               <set name="start_date"  expr="FMTDATE(STARTDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(STARTDATE),4,8)">
                   <set name="startDate"   expr="FMTDATE(STARTDATE,4,0)" />         <!-- 开始时间 -->
                   <set name="start_date"  expr="startDate"/>
               </if>
           </else>

           <if condition="IS_EQUAL_STRING(ENDDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="endDate"  expr="GETDATETIME('YYYYMMDD')" />
               <set name="endDate"  expr="FMTDATE(endDate,0,4)"/>
               <set name="end_date"  expr="FMTDATE(ENDDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(ENDDATE),4,8)">
                   <set name="endDate"   expr="FMTDATE(ENDDATE,4,0)" />       <!-- 结束时间 -->
                   <set name="end_date"  expr="endDate"/>
               </if>
           </else>
           
           <if condition="INTCMP(end_date,1,start_date)">
               <set name="RspCod" value="08040" />
               <set name="RspMsg" value="结束日期小于开始日期" />
               <return />
           </if>
           <set name="orderDate"  expr="STRCAT(' and b.ordertime  &gt;= ',Fh, STRCAT(start_date,'000000'),Fh,' and  b.ordertime &lt;=',Fh,STRCAT(end_date,'235959'),Fh)" />
           
           <!-- 统计成功的总笔数和总金额 -->
           <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryMertotalInf" />
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录!"/>
             <set name="TOTALRECNUMS" value="0"/>
             <set name="TOTALPRDAMT"  value="0.00"/>
           </if>
           <elseif condition="#RetCod!=0">
                <set name="RspCod"    value="09101"/>
                <set name="RspMsg"    value="操作数据库失败!"/>
                <return/>
           </elseif>
           
           <!--查询商品订单信息 -->
         <do func="PagedQuery" error="IGNORE">
           <para name="PageNum"    expr="PageNum"/>
           <para name="NumPerPag"  expr="NumPerPag"/>
           <para name="Sql"        sql="QryMerRefInf"/>
         </do>
         <if condition="#RetCod==2">
           <set name="RspCod"    value="02103"/>
           <set name="RspMsg"    value="无记录!"/>
         </if>
         <elseif condition="#RetCod!=0">
           <set name="RspCod"    value="09101"/>
           <set name="RspMsg"    value="操作数据库失败!"/>
           <return/>
         </elseif>
           
           <set name="ALLPAGENUM" expr="DIV(TOLCNT,NUMPERPAG)" />
           <set name="mob" expr="MOD(TOLCNT,NUMPERPAG)" />
           <if condition="IS_NOEQUAL_STRING(MOB,'0')">
               <set name="ALLPAGENUM" expr="ADD(ALLPAGENUM,1)" />
           </if>
           <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
               <set name="PageNum" expr="ALLPAGENUM" />
           </if>
           <if condition="INTCMP(ALLPAGENUM,6,'0')">
               <if condition="INTCMP(PageNum,3,'0')">
                   <set name="PageNum" value="1" />
               </if>
           </if>
         
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
    <transaction code="queryAccountRecord" desc="商户系统账户详细信息查询">
       <sql name="meracc"> 
         select SEQ_NO,JNL_NO,CUST_ID,PAY_AC_NO,AC_TYPE,TXN_TYP,DR_CR_FLAG,IS_ACT,
         TO_CHAR(TO_NUMBER(NVL(TXN_AMT,0))/100,'FM9999,999,999,990.00') TXN_AMT,
         TO_CHAR(to_date(TXN_DAT,'yyyymmdd'),'yyyy-mm-dd')AS TXN_DAT ,
         TO_CHAR(to_date(TXN_TIM,'hh24miss'),'hh24:mi:ss')AS TXNTIM,
         TO_CHAR(to_date(TXN_DAT||TXN_TIM,'yyyyMMdd hh24miss'),'yyyy-MM-dd hh24:mi:ss') ORDERTIME 
         from STPJNLINF  
         WHERE 1=1 and  cust_id=#{merid} ${orderDate}  ${DR_CR_FLAG_TEMP} ${JNL_NO_TEMP} ${TXN_TYP_TEMP} ${TXN_AMT_TEMP}
          order by TXN_DAT||TXN_TIM desc
       </sql>
       <sql name="QryMerAccInf"> <!--  查询商户结算申请信息 -->
        select cust_id, 
         TO_CHAR(TO_NUMBER(sum(case  when DR_CR_FLAG = '+' then  TXN_AMT  else  '0' end)) / 100, 'FM9999,999,999,990.00') TOTALINTOAMT,
          TO_CHAR(TO_NUMBER( sum(case when DR_CR_FLAG = '-' then  TXN_AMT else  '0'   end  )) / 100,  'FM9999,999,999,990.00') TOTALOffAMT
           from stpjnlinf where cust_id = #{merid}  ${orderDate}  ${DR_CR_FLAG_TEMP} ${JNL_NO_TEMP} ${TXN_TYP_TEMP} ${TXN_AMT_TEMP} group by cust_id
       </sql>
       <process> 
           <set name="merid"       expr="SESSIONS.MERID"/>
           
           <if condition="IS_EQUAL_STRING(OPERATING,'0')">
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/account/merTranRecord.jsp')" />
           </if>
           <else>
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/account/merAccountRecord.jsp')" />
           </else>
           <!-- 分页参数定义 -->
           <if condition="ISNULL(PageNum)">
              <set name="PageNum" value="1"/>
           </if>
           <if condition="ISNULL(NumPerPag)">
              <set name="NumPerPag" value="10"/>
           </if>
           <set name="Fh" value="'" />
           <!-- 开始和结束时间范围 -->
           <if condition="IS_EQUAL_STRING(STARTDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="startDate" expr="CALCDATE(GETDATE(),'-','d',30)" />
               <set name="startDate" expr="FMTDATE(startDate,0,4)"/>
               <set name="start_date"  expr="FMTDATE(STARTDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(STARTDATE),4,8)">
                   <set name="startDate"   expr="FMTDATE(STARTDATE,4,0)" />         <!-- 开始时间 -->
                   <set name="start_date"  expr="startDate"/>
               </if>
           </else>
           
           <if condition="IS_EQUAL_STRING(ENDDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="endDate"  expr="GETDATETIME('YYYYMMDD')" />
               <set name="endDate"  expr="FMTDATE(endDate,0,4)"/>
               <set name="end_date"  expr="FMTDATE(ENDDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(ENDDATE),4,8)">
                   <set name="endDate"   expr="FMTDATE(ENDDATE,4,0)" />       <!-- 结束时间 -->
                   <set name="end_date"  expr="endDate"/>
               </if>
           </else>
           
           <if condition="INTCMP(end_date,1,start_date)">
               <set name="RspCod" value="08040" />
               <set name="RspMsg" value="结束日期小于开始日期" />
               <return />
           </if>
           <set name="orderDate"  expr="STRCAT(' and TXN_DAT||TXN_TIM  &gt;= ',Fh, STRCAT(start_date,'000000'),Fh,' and  TXN_DAT||TXN_TIM &lt;=',Fh,STRCAT(end_date,'235959'),Fh)" />

           <!--出账入账 -->
           <if condition="IS_EQUAL_STRING(DR_CR_FLAG,'')">
                <set name="DR_CR_FLAG_TEMP" value=""/>
           </if>
           <else>
           	<if condition="IS_EQUAL_STRING(DR_CR_FLAG,'1')">
           		<set name="DR_CR_FLAG_TEMP" expr="STRCAT(' and DR_CR_FLAG = ',fh,'-',fh)"/>
           	</if>
           	<else>
           		<set name="DR_CR_FLAG_TEMP" expr="STRCAT(' and DR_CR_FLAG = ',fh,'+',fh)"/>
           	</else>
           </else>
           
           <!--订单编号-->
           <if condition="IS_EQUAL_STRING(JNL_NO,'')">
                <set name="JNL_NO_TEMP"  value=""/>
           </if>
           <else>
                <set name="JNL_NO_TEMP"  expr="STRCAT(' and JNL_NO like ',fh,'%',JNL_NO,'%',fh)"/>
           </else>
           
            <!--交易名称 -->
           <if condition="IS_EQUAL_STRING(TXN_TYP,'')">
                <set name="TXN_TYP_TEMP"     value=""/>
           </if>
           <else>
                <set name="TXN_TYP_TEMP"    expr="STRCAT(' and TXN_TYP = ',fh,TXN_TYP,fh)"/>
           </else>
           
           <!--订单最小金额 -->
           <if condition="ISNULL(MINAMT)">
                <set name="MINAMT_TEMP"     value=""/>
           </if>
           <else>
               <set name="MINAMT_TEMP"            expr="AMTPOWER(MINAMT,'2')"/>
           </else>
           <!--订单最大金额 -->
           <if condition="ISNULL(MAXAMT)">
                <set name="MAXAMT_TEMP"     value=""/>
           </if>
           <else>
               <set name="MAXAMT_TEMP"        expr="AMTPOWER(MAXAMT,'2')"/>
           </else>
           <if condition="AND(IS_EQUAL_STRING(MAXAMT_TEMP,''),IS_EQUAL_STRING(MINAMT_TEMP,''))">
                <set name="TXN_AMT_TEMP" value=""/>
           </if>
           <elseif condition="AND(IS_EQUAL_STRING(MAXAMT_TEMP,''),IS_NOEQUAL_STRING(MINAMT_TEMP,''))">
                <set name="TXN_AMT_TEMP"    expr="STRCAT(' and TXN_AMT  &gt;= to_number(',Fh, MINAMT_TEMP ,Fh,')')" />
           </elseif>
           <elseif condition="AND(IS_NOEQUAL_STRING(MAXAMT_TEMP,''),IS_EQUAL_STRING(MINAMT_TEMP,''))">
                <set name="TXN_AMT_TEMP"    expr="STRCAT(' and  TXN_AMT  &lt;= to_number(',Fh, MAXAMT_TEMP ,Fh,')')" />
           </elseif>
           <else>
             <if condition="INTCMP(MAXAMT_TEMP,1,MINAMT_TEMP)">
                 <set name="RspCod" value="08040" />
                 <set name="RspMsg" value="最大金额小于最小金额" />
                 <return />
             </if>
             <set name="TXN_AMT_TEMP"  expr="STRCAT(' and TXN_AMT between to_number(\'',MINAMT_TEMP,'\') and to_number(\'',MAXAMT_TEMP,'\')')"/>
             
           </else>
                    
           <!-- 统计成功的总笔数和总金额 -->
           <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryMerAccInf" />
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录!"/>
             <set name="TOTALINTOAMT" value="0.00"/>
             <set name="TOTALOFFAMT"  value="0.00"/>
           </if>
           <elseif condition="#RetCod!=0">
                <set name="RspCod"    value="09101"/>
                <set name="RspMsg"    value="操作数据库失败!"/>
                <return/>
           </elseif>
           
         <!-- 账户详细信息 -->
         <do func="PagedQuery"            error="IGNORE">
            <para name="PageNum"           expr="PageNum"/>
            <para name="NumPerPag"         expr="NumPerPag"/>
            <para name="Sql"               sql="meracc"/>
         </do>                                   
         <!--原子函数 2 数据库没有找到信息   -1 数据库错误  0 有信息切查询成功-->
         <if condition="#RetCod==2">
             <set name="RspCod"            value="02001"/>
             <set name="RspMsg"            value="无信息"/>
         </if> 
         <elseif condition="#RetCod!=0">
             <set name="RspCod"            value="09999"/>
             <set name="RspMsg"            value="系统错误"/>
             <return/>
         </elseif>
         
           <set name="ALLPAGENUM" expr="DIV(TOLCNT,NUMPERPAG)" />
           <set name="mob" expr="MOD(TOLCNT,NUMPERPAG)" />
           <if condition="IS_NOEQUAL_STRING(MOB,'0')">
               <set name="ALLPAGENUM" expr="ADD(ALLPAGENUM,1)" />
           </if>
           <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
               <set name="PageNum" expr="ALLPAGENUM" />
           </if>
           <if condition="INTCMP(ALLPAGENUM,6,'0')">
               <if condition="INTCMP(PageNum,3,'0')">
                   <set name="PageNum" value="1" />
               </if>
           </if>
           
         <set name="RspCod"               value="00000"/>
         <set name="RspMsg"               value="交易成功"/>
       </process>
    </transaction>
    
    <transaction code="settleRecord"        desc="商户结算记录查询">
       <sql name="QryMerOver"> <!--  查询商户结算信息 -->
         SELECT a.BATCH_NO,b.cust_id,TO_CHAR(to_date(a.TX_DATE,'yyyymmdd'),'yyyy-mm-dd') TX_DATE,a.REC_BANK_NAME,a.REC_STL_AC_NO,a.REC_NAME,
               TO_CHAR( (TO_NUMBER(a.TOT_ORD_AMT))/100,'FM9999,999,999,990.00') TOT_ORD_AMT,
               TO_CHAR(TO_NUMBER(NVL(a.TOT_TXN_FEE,0))/100,'FM9999,999,999,990.00') TOT_TXN_FEE,
               TO_CHAR((TO_NUMBER(a.STL_AMT))/100,'FM9999,999,999,990.00') STL_AMT,
               a.PAY_STL_STATUS,b.CUST_NAME
          FROM ARP_BANK_PAY_STL a ,STPCUSINF b
         WHERE a.MER_NO=b.cust_id and a.MER_NO=#{cust_id}  ${Qry1}  ${conf}
       </sql>
       <sql name="QryMerOverInf"> <!--  查询商户结算申请信息 -->
         select count(*) as TOTALRECNUMS,TO_CHAR(to_number(nvl(sum(a.TOT_ORD_AMT),0))/100,'FM9999,999,999,990.00') TOTALSTLAMT  
         FROM ARP_BANK_PAY_STL a ,STPCUSINF b
         WHERE a.MER_NO=b.cust_id and a.PAY_STL_STATUS='2' and a.MER_NO=#{cust_id}  ${Qry1}  ${conf}
       </sql>
       <process>
           
           <if condition="IS_EQUAL_STRING(OPERATING,'0')">
              <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/settleman/tranRecord.jsp')" />
           </if>
           <else>
              <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/settleman/settleTradRecd.jsp')" />
           </else>
           
           <set name="cust_id"       expr="SESSIONS.MERID"/>
           
           <!-- 分页参数定义 -->
           <if condition="ISNULL(PageNum)">
              <set name="PageNum"   value="1"/>
           </if>
           <if condition="ISNULL(NumPerPag)">
              <set name="NumPerPag" value="10"/>
           </if>
           <set name="Fh" value="'" />
           
           <if condition="AND(ISNULL(EXP_PAY_BGN_DATE),ISNULL(EXP_PAY_END_DATE))">
             <set name="Qry1"                   value=""/>
           </if> 
           <elseif condition="IS_EQUAL_STRING(EXP_PAY_BGN_DATE,EXP_PAY_END_DATE)">
              <set name="EXP_PAY_BGN_DATE1"     expr="FMTDATE(EXP_PAY_BGN_DATE,4,0)"/>
              <set name="Qry1"                  expr="STRCAT('and a.TX_DATE like \'%',EXP_PAY_BGN_DATE1,'%\'')"/> 
           </elseif> 
           <elseif  condition="IS_NOEQUAL_STRING(EXP_PAY_BGN_DATE,EXP_PAY_END_DATE)">
             <if condition="ISNULL(EXP_PAY_BGN_DATE)">
                <set name="EXP_PAY_BGN_DATE"    expr="EXP_PAY_BGN_DATE"/>
             </if> 
             <else>
               <set name="EXP_PAY_BGN_DATE1"     expr="FMTDATE(EXP_PAY_BGN_DATE,4,0)"/>
               <set name="Qry1"                 expr="STRCAT('and a.TX_DATE &gt;= \'',EXP_PAY_BGN_DATE1,'\' ')"/> 
             </else>
             <if condition="ISNULL(EXP_PAY_END_DATE)">
               <set name="EXP_PAY_END_DATE"    expr="EXP_PAY_END_DATE"/>
             </if> 
             <else>
               <set name="EXP_PAY_END_DATE1"     expr="FMTDATE(EXP_PAY_END_DATE,4,0)"/>
               <set name="Qry1"                 expr="STRCAT('and a.TX_DATE &lt;= \'',EXP_PAY_END_DATE1,'\' ')"/> 
             </else>
             
             <if condition="AND(NOT(ISNULL(EXP_PAY_BGN_DATE)),NOT(ISNULL(EXP_PAY_END_DATE)))">
                <set name="EXP_PAY_BGN_DATE1"     expr="FMTDATE(EXP_PAY_BGN_DATE,4,0)"/>
                <set name="EXP_PAY_END_DATE1"     expr="FMTDATE(EXP_PAY_END_DATE,4,0)"/>
               <set name="Qry1"                    expr="STRCAT('and a.TX_DATE between \'',EXP_PAY_BGN_DATE1,'\' and \'',EXP_PAY_END_DATE1,'\'')"/> 
             </if>
           </elseif> 
         
           <!--0-待处理；2-付款成功；3-付款失败-->
           <if condition="ISNULL(PAY_STL_STATUS)">  
             <set name="conf"                    value=""/>
           </if>
           <else> 
             <set name="conf"                    expr="STRCAT(' and a.PAY_STL_STATUS =\'' ,PAY_STL_STATUS,'\'')"/>
           </else> 
           <if condition="ISNULL(PageNum)">
             <set name="PageNum"                 value="1"/>
           </if>
           <if condition="ISNULL(NumPerPag)">
             <set name="NumPerPag"               value="19"/>
           </if> 
           
           <!-- 统计成功的总笔数和总金额 -->
           <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryMerOverInf" />
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"       value="01002"/>
             <set name="RspMsg"       value="无记录!"/>
             <set name="TOTALRECNUMS" value="0"/>
             <set name="TOTALSTLAMT"  value="0.00"/>
           </if>
           <elseif condition="#RetCod!=0">
                <set name="RspCod"    value="09101"/>
                <set name="RspMsg"    value="操作数据库失败!"/>
                <return/>
           </elseif>
           
           <!--查询结算信息 -->
           <do func="PagedQuery" error="IGNORE">
             <para name="PageNum"    expr="PageNum"/>
             <para name="NumPerPag"  expr="NumPerPag"/>
             <para name="Sql"        sql="QryMerOver"/>
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录!"/>
           </if>
           <elseif condition="#RetCod!=0">
             <set name="RspCod"    value="09101"/>
             <set name="RspMsg"    value="操作数据库失败!"/>
             <return/>
           </elseif>
           
           <set name="ALLPAGENUM" expr="DIV(TOLCNT,NUMPERPAG)" />
           <set name="mob" expr="MOD(TOLCNT,NUMPERPAG)" />
           <if condition="IS_NOEQUAL_STRING(MOB,'0')">
               <set name="ALLPAGENUM" expr="ADD(ALLPAGENUM,1)" />
           </if>
           <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
               <set name="PageNum" expr="ALLPAGENUM" />
           </if>
           <if condition="INTCMP(ALLPAGENUM,6,'0')">
               <if condition="INTCMP(PageNum,3,'0')">
                   <set name="PageNum" value="1" />
               </if>
           </if>
           
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
    <transaction code="QrySettleDetail"     desc="结算详细查询">
        <sql name="qryySettInf">
         select merNo,batNo,PrdOrdNo,TO_CHAR(to_date(orderTime,'yyyymmdd'),'yyyy-mm-dd') orderTime,
                TO_CHAR( (TO_NUMBER(ordAmt))/100,'FM9999,999,999,990.00') ordAmt,
                TO_CHAR( (TO_NUMBER(fee))/100,'FM9999,999,999,990.00') fee ,a.prodCode,b.prod_name PRODNAME
           from ARP_BANK_REC_STL a,STPPROINF b
          where merNo=#{CUST_ID} and batNo=#{BATCH_NO} and a.prodCode=b.prod_code 
        </sql>
        <process> 
           <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/settleman/trandetail.jsp')" />
           <set name="CUST_ID"                 expr="SESSIONS.MERID"/>
           <if condition="ISNULL(PageNum)">
             <set name="PageNum"              value="1"/>
           </if>
           <if condition="IS_EQUAL_STRING(PageNum,1)">
             <set name="BATCH_NO"             expr="DELBOTHSPACE(BATCH_NO)"/>
           </if>
           <else>
             <set name="BATCH_NO"             expr="DELBOTHSPACE(STLBATNO)"/> 
           </else>
           <if condition="ISNULL(NumPerPag)">
            <set name="NumPerPag"            value="19"/>
           </if>
           <do func="PagedQuery"             error="IGNORE">
             <para name="PageNum"            expr="PageNum"/>
             <para name="NumPerPag"          expr="NumPerPag"/>
             <para name="sql"                sql="qryySettInf"/>
           </do>
           <if condition="#RetCod==2">
              <set name="TOLCNT"             value="0"/>
              <set name="RspCod"             value="219999"/>
              <set name="RspMsg"             value="没有符合条件的数据"/>
              <return/>
           </if>
           <if condition="#RetCod!=0">
             <set name="RSPCOD"              value="329999"/>
             <set name="RSPMSG"              value="查询失败!"/>
             <return/>
           </if>
           
           <set name="MsgTyp"       value="N"/>
           <set name="RspCod"       value="00000"/>
           <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
    <transaction code="MerStlDetailExport"  desc="商户结算交易明细导出">
       <sql name="qryySettInf">
        select merNo,batNo,PrdOrdNo,TO_CHAR(to_date(orderTime,'yyyymmdd'),'yyyy-mm-dd') orderTime,
               TO_CHAR( (TO_NUMBER(ordAmt))/100,'FM9999,999,999,990.00') ordAmt,
               TO_CHAR( (TO_NUMBER(fee))/100,'FM9999,999,999,990.00') fee ,a.prodCode,b.prod_name PRODNAME
          from ARP_BANK_REC_STL a,STPPROINF b
         where merNo=#{CUST_ID} and batNo=#{BATCH_NO} and a.prodCode=b.prod_code
       </sql>
       <process> 
         
           <!--检查商户登录平台是否正确-->
           <if condition="IS_NOEQUAL_STRING(SysCod,'2201')">
              <set name="MsgTyp"       value="E"/>
              <set name="RspCod"       value="01001"/>
              <set name="RspMsg"       value="商户登录平台不正确"/>
              <return/>
           </if>
           <set name="CUST_ID"     expr="SESSIONS.MERID"/> 
           
           <do func="QueryInGroup" error="IGNORE">
              <para name="SqlCmd"     sql="qryySettInf"/>
              <para name="RecordName" value="reportList"/>
              <para name="RecNum"     value="RECNUM"/>
           </do>
           <if condition="#RetCod==-1">
              <set name="RspCod"    value="09101"/>
              <set name="RspMsg"    value="操作数据库失败!"/>
              <return/>
           </if>
           
           <!--导出文件-->
           <do func="ReportExport" error="IGNORE">
               <para name="Root"          value="reportList"/>
               <para name="FileDemo"      value="merchantsetDetail"/> <!--导出模板名-->
               <para name="NameForUser"   value="merchantsetDetail"/> <!--导出文件名-->
               <para name="FilePath"      value="rptdemo"/>       <!--导出模板路径-->
               <para name="FileToPath"    value="/dat/download"/> <!--导出目标地址-->
               <para name="WebPath"       expr="GETCURAPPHOME()"/>
               <para name="params"        value="PRDORDNO/PRODCODE/PRODNAME/ORDAMT/FEE/ORDERTIME"/>
               <para name="collectParams" value="CUST_ID/BATCH_NO"/> <!--导出头-->
           </do>
           <if condition="#RetCod!=0">
               <set name="RspCod"          value="02103"/>
               <set name="RspMsg"          value="导出出错!"/>
               <set name="DWZ_STATUS_CODE" value="300"/>
               <set name="DWZ_RSP_MSG"     expr="RSPMSG"/> 
               <return/>
           </if>

           <!--读取xml参数 -->
           <set name="ConfigName"          value="FtpGetToResinMerchant"/>
           <quote name="ReadXmlCfg"/>   
           
           <!--移动文件-->
           <set name="FILENAME"            expr="#FILENAME"/>
           <do func="MoveFile">
               <para name="srcDir" expr="LclDir"    />
               <para name="srcFil" expr="FILENAME"  />
               <para name="tarDir" expr="ObjDir"    />
           </do>
           <if condition="#RetCod!=0"> 
               <set name="RspCod"  value="01007"/>  
               <set name="RspMsg"  value="移动文件错误!"/>  
               <return/> 
           </if>
           
           <set name="pos_webapps"              expr="GETSTRPOS(ObjDir,'/webapps/')"                                />
           <set name="ObjDir"                   expr="RIGHTSTR(ObjDir,SUB(STRLEN(ObjDir),ADD(pos_webapps,8)))"      />
         
           <set name="_REQUESTATTR.REDIRECTURL" expr="STRCAT('/',ObjDir,'/',FILENAME)"/>
           <set name="MsgTyp"       value="N"/>
           <set name="RspCod"       value="00000"/>
           <set name="RspMsg"       value="交易成功"/>
          
       </process>
    </transaction>
    
    <transaction code="tofindPwdForward" desc="商户支付密码找回跳转">
     <process>
           <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/logpwd/findLogPwd.jsp')" />
       <set name="MsgTyp"       value="N"/>
       <set name="RspCod"       value="00000"/>
       <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
    <transaction code="merPwdForward" desc="商户登录密码修改跳转">
     <process>
       <if condition="IS_EQUAL_STRING(paypwdflag,'1')">
           <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/logpwd/findLogPwd.jsp')" />
       </if>
       <else>
          <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/account/modifyloginpwd.jsp')" />
       </else>
       <set name="MsgTyp"       value="N"/>
       <set name="RspCod"       value="00000"/>
       <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
    <transaction code="merUpdLoginPwd" desc="商户密码修改">
	     <sql name="UdPASS"><!--修改密码-->
	       update STPMERINF set login_pwd=#{NPASS} where cust_ID=#{MER_ID}
	     </sql>
	     <sql name="mer_qry"><!--验证原密码-->
	       select login_pwd,LOGIN_NAME from STPMERINF where cust_ID=#{MER_ID}
	     </sql>    
        <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
            SELECT 
            EXTRACT(DAY FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*24*60 + EXTRACT(HOUR FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*60 +  EXTRACT(MINUTE FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND )) as timeDifference,
            CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
            FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
            INSERT INTO STPLOGTMP
            (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
            VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
        </sql>
        <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
            LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
            WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
     <process>
       <!--检查商户（平台商）登录平台是否正确-->
       <if condition="IS_NOEQUAL_STRING(SysCod,'0002')">
         <set name="MsgTyp"    value="E"/>
         <set name="RspCod"    value="01001"/>
         <set name="RspMsg"    value="商户登录平台不正确"/>
         <return/>
       </if>
       <set name="MER_ID" expr="SESSIONS.MERID"/>
       
       <!--查询密码-->
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd" sql="mer_qry"/>
       </do>
       <if condition="#RetCod!=0">
         <set name="RspCod" value="02007"/>
         <set name="RspMsg" value="操作失败"/>
         <return/>
       </if>
       
       <!-- 商户登录密码锁定次数判断 -->
       <set name="USER_ID"   expr="DELBOTHSPACE(LOGIN_NAME)" />
       <set name="CUSTTYPE"  value="1"/><!--0用户 1 商户 2企业-->
       <set name="PWDTYPE"   value="0"/><!--0:登录密码 1:支付密码-->
       <set name="FailFlag"  value="0"/>
       <set name="ConfigName"   value="G_CheckPwd"/>
         <quote name="ReadXmlCfg"/>
         <set name="G_ERRORCOUNT" expr="G_ERRORCOUNT"/><!--错误次数-->
         <set name="G_LOCK_MIN"   expr="G_LOCK_MIN"/><!--锁定分钟数-->
         <!--  查询用户登录失败次数及第一次失败时间  -->
         <do func="ReadRecord"   error="IGNORE">
           <para name="SqlCmd"    sql="QryUserLogFail"/>
         </do>
         <if condition="#RetCod==0">
            <if condition="OR(ISNULL(LOGIN_FAIL_COUNT),IS_EQUAL_STRING(DELBOTHSPACE(LOGIN_FAIL_COUNT),''))">
                <!--没有次数记录 没有登录过--> 
                <set name="FailFlag"  value="1"/>
            </if>
            <else>
                <set name="FailFlag"  expr="LOGIN_FAIL_COUNT"/>
                <!--判断该用户此次登录时间是否达到规定时间-->
                <if condition="OR(ISNULL(CURRENT_LOGIN_TIME),IS_EQUAL_STRING(DELBOTHSPACE(CURRENT_LOGIN_TIME),''))">
                    <!--没有时间记录 没有登录--> 
                    <set name="FailFlag"  expr="ADD(FailFlag,1)"/>
                </if>
                <else>
                  <!--存在最后一次异常登录时间-->
                  <set name="timeDifference"  expr="timeDifference"/><!--时间差-->
                  <!--如果是在5分钟内 只要更新次数+1-->
                  <if condition="DOUBLECMP(timeDifference,2,G_LOCK_MIN)">
                     <!--判断登录次数是否超过五次-->
                     <if condition="INTCMP(FailFlag,5,G_ERRORCOUNT)">
                         <!--5分钟内且第五次以上登录-->
                         <set name="MsgTyp"    value="E"/>
                         <set name="RspCod"    value="02075" />
                         <set name="RspMsg"     expr="STRCAT('输入密码连续失败',G_ERRORCOUNT,',请',G_LOCK_MIN,'分钟后再试！')"/>   
                         <quote name="UpLoginInfo"/>
                         <return/>
                     </if>
                     <else>
                         <!--五分钟内 登录次数少于五次时-->
                         <set name="FailFlag"  expr="ADD(FailFlag,1)"/>
                     </else>
                  </if>
                  <else>
                      <!--超过五分钟-->
                      <set name="FailFlag"  value="1"/>
                  </else>
                </else>
            </else>
         </if>
         <elseif condition="#RetCod==2">
            <!--添加用户登录失败信息-->
            <do func="ExecSql" error="IGNORE">
              <para name="SqlCmd" sql="InsUsrLogInfo"/>
            </do>
            <if condition="#RetCod!=0">
              <set name="RSPCOD" value="02040"/>
              <set name="RSPMSG" value="初始化登录信息失败!"/> 
              <return/>
            </if>
            <!--没有次数记录 没有登录过--> 
            <set name="FailFlag"  value="1"/>
         </elseif>
         <else>
            <do func="RollBackWork"/>
            <set name="RSPCOD" value="02038"/>
            <set name="RSPMSG" value="请稍后再试!"/>
            <return/>
          </else>
          
       <!-- 商户登录密码锁定次数判断 -->
        
       <!--pin转加密-->
       <set name="NewPwd"          expr="UsrPwd"/>
       <quote name="MerPwdToDes"/>
       <set name="PASS"   expr="NewPwd"/>
       
       <if condition="IS_NOEQUAL_STRING(login_pwd,PASS)">
         <set name="RspCod" value="02105"/>
         <set name="RspMsg" value="旧密码错误"/>
         <quote name="UpLoginInfo"/>
         <return/>
       </if>
       
       <if condition="IS_NOEQUAL_STRING(nUsrpwd,NUSRPWD1)">
         <set name="RspCod" value="02105"/>
         <set name="RspMsg" value="新密码和确认密码不一致"/>
         <return/>
       </if>
       
       <!--pin转加密-->
       <set name="NewPwd"          expr="nUsrpwd"/>
       <quote name="MerPwdToDes"/>
       <set name="NPASS"   expr="NewPwd"/>
       
       <!--更新密码-->
       <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="UdPASS"/>
       </do>
       <if condition="#RetCod!=0">
         <set name="RspCod"    value="02103"/>
         <set name="RspMsg"    value="修改密码失败!"/>
         <return/>
       </if>
     
        <!-- 修改登记失败信息表 -->
        <do func="ExecSql" error="IGNORE">
           <para name="SqlCmd" sql="UpdUsrLogInfo"/>
        </do>
        <if condition="#RetCod!=0">
           <set name="RSPCOD" value="02040"/>
           <set name="RSPMSG" value="更新登录信息失败!"/> 
           <return/>
        </if>
        
       <!--set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/common/main.jsp')" /-->
       <set name="MsgTyp"       value="N"/>
       <set name="RspCod"       value="00000"/>
       <set name="RspMsg"       value="交易成功"/>
       
     </process>
    </transaction>
    
    <transaction code="forPayRecord" desc="代付订单查询">
       <sql name="QryMerOver"> <!--  查询商户结算信息 -->
        select ORDER_NO, APPLY_TIME as APPLY_TIMES, PAYMENT_TYPE, PAY_STT, DEAL_TIME, TOTAL_AMT,
         SUB_TYPE, FILE_NAME, MERCH_NO, TOTAL_FEE, AUDIT1, AUDIT_DATE1, 
         AUDIT2, AUDIT_DATE2, AUDIT_STT, REMARK,
         To_Char(to_date(APPLY_TIME,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as APPLY_TIME,
         to_char(to_number(a.total_amt)/100,'999999999990.00') as total_amts  
         from STPPMTLST a where 1=1  
          and MERCH_NO=#{cust_id}  ${ordprdOrdNo}  ${orderDate} ${prdOrdStatus} ${prdordamt} 
         order by apply_time desc
       </sql>
       <sql name="QryMerOverInf"> <!--  查询商户结算申请信息 -->
         select count(*) as TOTALRECNUMS,
         TO_CHAR(to_number(nvl(sum(TOTAL_AMT),0))/100,'FM9999,999,999,990.00') TOTALSTLAMT  
         from STPPMTLST where trim(MERCH_NO)=#{cust_id} and PAY_STT='2'
       </sql>
     <process>
           
           <if condition="IS_EQUAL_STRING(OPERATING,'0')">
        <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/batchpaid/payRecord.jsp')" />
           </if>
           <else>
        <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/batchpaid/forpayRecd.jsp')" />
           </else>
           
           <set name="cust_id"       expr="SESSIONS.MERID"/>
           <set name="pageflag"      value="0"/>
           <!-- 分页参数定义 -->
           <if condition="ISNULL(PageNum)">
              <set name="PageNum" value="1"/>
           </if>
           <if condition="ISNULL(NumPerPag)">
              <set name="NumPerPag" value="10"/>
           </if>
           <set name="Fh" value="'" />
           
           <!--商品订单号 -->
           <if condition="IS_EQUAL_STRING(prdOrdNo,'')">
                <set name="ordprdOrdNo" value=""/>
           </if>
           <else>
                <set name="ordprdOrdNo" expr="STRCAT(' and ORDER_NO like ',fh,'%',prdOrdNo,'%',fh)"/>
           </else>
           
           <!--订单状态--> 
           <if condition="IS_EQUAL_STRING(OrdStatus,'')">
                <set name="prdOrdStatus"     value=""/>
           </if>
           <else>
                <set name="prdOrdStatus"    expr="STRCAT(' and PAY_STT = ',fh,OrdStatus,fh)"/>                                      
           </else>
           
           <!--订单最小金额 -->
           <if condition="ISNULL(minAmt)">
                <set name="minAmt"     value=""/>
           </if>
           <else>
                 <set name="minAmt"            expr="AMTPOWER(minAmt,'2')"/>
           </else>
           <!--订单最大金额 -->
           <if condition="ISNULL(maxAmt)">
                <set name="maxAmt"     value=""/>
           </if>
           <else>
                 <set name="maxAmt"        expr="AMTPOWER(maxAmt,'2')"/>
           </else>
           <if condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt" value=""/>
           </if>
           <elseif condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_NOEQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and TOTAL_AMT  &gt;= ', minAmt  )" />
           </elseif>
           <elseif condition="AND(IS_NOEQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and TOTAL_AMT &lt;=', maxAmt  )" />
           </elseif>
           <else>
               <if condition="INTCMP(maxAmt,1,minAmt)">
                   <set name="RspCod" value="08040" />
                   <set name="RspMsg" value="最大金额小于最小金额" />
                   <return />
               </if>
               <set name="prdordamt"  expr="STRCAT(' and TOTAL_AMT  &gt;= ',  minAmt , ' and  TOTAL_AMT &lt;=', maxAmt  )" />
           </else>
           <!-- 开始和结束时间范围 -->
           <if condition="IS_EQUAL_STRING(STARTDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="startDate" expr="CALCDATE(GETDATE(),'-','d',30)" />
               <set name="startDate" expr="FMTDATE(startDate,0,4)"/>
               <set name="start_date"  expr="FMTDATE(STARTDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(STARTDATE),4,8)">
                   <set name="startDate"   expr="FMTDATE(STARTDATE,4,0)" />         <!-- 开始时间 -->
                   <set name="start_date"  expr="startDate"/>
               </if>
           </else>

           <if condition="IS_EQUAL_STRING(ENDDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="endDate"  expr="GETDATETIME('YYYYMMDD')" />
               <set name="endDate"  expr="FMTDATE(endDate,0,4)"/>
               <set name="end_date"  expr="FMTDATE(ENDDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(ENDDATE),4,8)">
                   <set name="endDate"   expr="FMTDATE(ENDDATE,4,0)" />       <!-- 结束时间 -->
                   <set name="end_date"  expr="endDate"/>
               </if>
           </else>
           
           <if condition="INTCMP(end_date,1,start_date)">
               <set name="RspCod" value="08040" />
               <set name="RspMsg" value="结束日期小于开始日期" />
               <return />
           </if>
           <set name="orderDate"  expr="STRCAT(' and APPLY_TIME  &gt;= ',Fh, STRCAT(start_date,'000000'),Fh,' and  APPLY_TIME &lt;=',Fh,STRCAT(end_date,'235959'),Fh)" />
           
           <!-- 统计成功的总笔数和总金额 -->
           <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryMerOverInf" />
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录!"/>
             <set name="TOTALRECNUMS" value="0"/>
             <set name="TOTALSTLAMT"  value="0.00"/>
           </if>
           <elseif condition="#RetCod!=0">
                <set name="RspCod"    value="09101"/>
                <set name="RspMsg"    value="操作数据库失败!"/>
                <return/>
           </elseif>
           
           <!--查询结算信息 -->
           <do func="PagedQuery" error="IGNORE">
             <para name="PageNum"    expr="PageNum"/>
             <para name="NumPerPag"  expr="NumPerPag"/>
             <para name="Sql"        sql="QryMerOver"/>
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录!"/>
             <return/>
           </if>
           <elseif condition="#RetCod!=0">
             <set name="RspCod"    value="09101"/>
             <set name="RspMsg"    value="操作数据库失败!"/>
             <return/>
           </elseif>
           
           <set name="ALLPAGENUM" expr="DIV(TOLCNT,NUMPERPAG)" />
           <set name="mob" expr="MOD(TOLCNT,NUMPERPAG)" />
           <if condition="IS_NOEQUAL_STRING(MOB,'0')">
               <set name="ALLPAGENUM" expr="ADD(ALLPAGENUM,1)" />
           </if>
           <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
               <set name="PageNum" expr="ALLPAGENUM" />
           </if>
           <if condition="INTCMP(ALLPAGENUM,6,'0')">
               <if condition="INTCMP(PageNum,3,'0')">
                   <set name="PageNum" value="1" />
               </if>
           </if>
           
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
    <transaction code="payApplyprd" desc="申请代付订单查询">
       <sql name="QryMerOver"> <!--  查询商户结算信息 -->
        select ORDER_NO, APPLY_TIME as APPLY_TIMES, PAYMENT_TYPE, PAY_STT, DEAL_TIME, TOTAL_AMT,
         SUB_TYPE, FILE_NAME, MERCH_NO, TOTAL_FEE, AUDIT1, AUDIT_DATE1, 
         AUDIT2, AUDIT_DATE2, AUDIT_STT, REMARK,
         To_Char(to_date(APPLY_TIME,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as APPLY_TIME,
         to_char(to_number(a.total_amt)/100,'999999999990.00') as TOTAL_AMTS  
         from STPPMTLST a where 1=1  
          and MERCH_NO=#{cust_id}  ${ordprdOrdNo}  ${orderDate} ${prdOrdStatus} ${prdordamt} 
         order by apply_time desc
       </sql>
       <sql name="QryMerOverInf"> <!--  查询商户结算申请信息 -->
         select count(*) as TOTALRECNUMS,
         TO_CHAR(to_number(nvl(sum(TOTAL_AMT),0))/100,'FM9999,999,999,990.00') TOTALSTLAMT  
         from STPPMTLST where trim(MERCH_NO)=#{cust_id} and PAY_STT='2'
       </sql>
     <process>
           
           <if condition="IS_EQUAL_STRING(OPERATING,'0')">
        <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/batchpaid/payApplyRecord.jsp')" />
           </if>
           <else>
        <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/batchpaid/payApplyprdRecd.jsp')" />
           </else>
           
           <set name="cust_id"       expr="SESSIONS.MERID"/>
           <set name="PAGEFLAG"      value="1"/>
           <!-- 分页参数定义 -->
           <if condition="ISNULL(PageNum)">
              <set name="PageNum" value="1"/>
           </if>
           <if condition="ISNULL(NumPerPag)">
              <set name="NumPerPag" value="10"/>
           </if>
           <set name="Fh" value="'" />
           
           <!--商品订单号 -->
           <if condition="IS_EQUAL_STRING(prdOrdNo,'')">
                <set name="ordprdOrdNo" value=""/>
           </if>
           <else>
                <set name="ordprdOrdNo" expr="STRCAT(' and ORDER_NO like ',fh,'%',prdOrdNo,'%',fh)"/>
           </else>
           
           <!--订单状态--> 
           <if condition="IS_EQUAL_STRING(OrdStatus,'')">
                <set name="prdOrdStatus"     value=""/>
           </if>
           <else>
                <set name="prdOrdStatus"    expr="STRCAT(' and PAY_STT like ',fh,'%',OrdStatus,'%',fh)"/>                                      
           </else>
           
           <!--订单最小金额 -->
           <if condition="ISNULL(minAmt)">
                <set name="minAmt"     value=""/>
           </if>
           <else>
                 <set name="minAmt"            expr="AMTPOWER(minAmt,'2')"/>
           </else>
           <!--订单最大金额 -->
           <if condition="ISNULL(maxAmt)">
                <set name="maxAmt"     value=""/>
           </if>
           <else>
                 <set name="maxAmt"        expr="AMTPOWER(maxAmt,'2')"/>
           </else>
           <if condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt" value=""/>
           </if>
           <elseif condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_NOEQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and TOTAL_AMT  &gt;= ',  minAmt  )" />
           </elseif>
           <elseif condition="AND(IS_NOEQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and TOTAL_AMT &lt;=', maxAmt  )" />
           </elseif>
           <else>
               <if condition="INTCMP(maxAmt,1,minAmt)">
                   <set name="RspCod" value="08040" />
                   <set name="RspMsg" value="最大金额小于最小金额" />
                   <return />
               </if>
               <set name="prdordamt"  expr="STRCAT(' and TOTAL_AMT  &gt;= ',  minAmt , ' and  TOTAL_AMT &lt;=',  maxAmt  )" />
           </else>
           <!-- 开始和结束时间范围 -->
           <if condition="IS_EQUAL_STRING(STARTDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="startDate" expr="CALCDATE(GETDATE(),'-','d',30)" />
               <set name="startDate" expr="FMTDATE(startDate,0,4)"/>
               <set name="start_date"  expr="FMTDATE(STARTDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(STARTDATE),4,8)">
                   <set name="startDate"   expr="FMTDATE(STARTDATE,4,0)" />         <!-- 开始时间 -->
                   <set name="start_date"  expr="startDate"/>
               </if>
           </else>

           <if condition="IS_EQUAL_STRING(ENDDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="endDate"  expr="GETDATETIME('YYYYMMDD')" />
               <set name="endDate"  expr="FMTDATE(endDate,0,4)"/>
               <set name="end_date"  expr="FMTDATE(ENDDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(ENDDATE),4,8)">
                   <set name="endDate"   expr="FMTDATE(ENDDATE,4,0)" />       <!-- 结束时间 -->
                   <set name="end_date"  expr="endDate"/>
               </if>
           </else>
           
           <if condition="INTCMP(end_date,1,start_date)">
               <set name="RspCod" value="08040" />
               <set name="RspMsg" value="结束日期小于开始日期" />
               <return />
           </if>
           <set name="orderDate"  expr="STRCAT(' and APPLY_TIME  &gt;= ',Fh, STRCAT(start_date,'000000'),Fh,' and  APPLY_TIME &lt;=',Fh,STRCAT(end_date,'235959'),Fh)" />
           
           <!-- 统计成功的总笔数和总金额 -->
           <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryMerOverInf" />
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录!"/>
             <set name="TOTALRECNUMS" value="0"/>
             <set name="TOTALSTLAMT"  value="0.00"/>
           </if>
           <elseif condition="#RetCod!=0">
                <set name="RspCod"    value="09101"/>
                <set name="RspMsg"    value="操作数据库失败!"/>
                <return/>
           </elseif>
           
           <!--查询结算信息 -->
           <do func="PagedQuery" error="IGNORE">
             <para name="PageNum"    expr="PageNum"/>
             <para name="NumPerPag"  expr="NumPerPag"/>
             <para name="Sql"        sql="QryMerOver"/>
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录!"/>
             <return/>
           </if>
           <elseif condition="#RetCod!=0">
             <set name="RspCod"    value="09101"/>
             <set name="RspMsg"    value="操作数据库失败!"/>
             <return/>
           </elseif>
           
           <set name="ALLPAGENUM" expr="DIV(TOLCNT,NUMPERPAG)" />
           <set name="mob" expr="MOD(TOLCNT,NUMPERPAG)" />
           <if condition="IS_NOEQUAL_STRING(MOB,'0')">
               <set name="ALLPAGENUM" expr="ADD(ALLPAGENUM,1)" />
           </if>
           <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
               <set name="PageNum" expr="ALLPAGENUM" />
           </if>
           <if condition="INTCMP(ALLPAGENUM,6,'0')">
               <if condition="INTCMP(PageNum,3,'0')">
                   <set name="PageNum" value="1" />
               </if>
           </if>
           
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
    <transaction code="QrypayDetail" desc="代付订单详情">
       <sql name="QrypayMer"> <!--  订单详情 -->
        select TRAORDNO, TRATIME, CLEARDAT, ORDSTATUS, TXCCY, TXAMT, TGETACCNO, TGETACCNAM,
         BACKERROR, BANKCODE, TRATYPE, BATNO,  ORDER_NO, TOTAMT, RECIEVENO,FILED1,
         To_Char(to_date(TRATIME,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as TRATIMES,
         to_char(to_number(TOTAMT)/100,'999999999990.00') as TOTAMTS ,
         to_char(to_number(TXAMT)/100,'999999999990.00') as TXAMTS 
         from STPSALARYPAYINF b where b.order_no =#{ORDER_NO}
         order by TRATIME desc
       </sql>
     <process>
           <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/batchpaid/payDetailRecord.jsp')" />
           <set name="cust_id"       expr="SESSIONS.MERID"/>
           <set name="ORDER_NO"      expr="ORDER_NO"/>
           <!-- 分页参数定义 -->
           <if condition="ISNULL(PageNum)">
              <set name="PageNum" value="1"/>
           </if>
           <if condition="ISNULL(NumPerPag)">
              <set name="NumPerPag" value="10"/>
           </if>
           <set name="Fh" value="'" />
           
           <!--查询结算信息 -->
           <do func="PagedQuery" error="IGNORE">
             <para name="PageNum"    expr="PageNum"/>
             <para name="NumPerPag"  expr="NumPerPag"/>
             <para name="Sql"        sql="QrypayMer"/>
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录!"/>
             <return/>
           </if>
           <elseif condition="#RetCod!=0">
             <set name="RspCod"    value="09101"/>
             <set name="RspMsg"    value="操作数据库失败!"/>
             <return/>
           </elseif>
           
           <set name="ALLPAGENUM" expr="DIV(TOLCNT,NUMPERPAG)" />
           <set name="mob" expr="MOD(TOLCNT,NUMPERPAG)" />
           <if condition="IS_NOEQUAL_STRING(MOB,'0')">
               <set name="ALLPAGENUM" expr="ADD(ALLPAGENUM,1)" />
           </if>
           <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
               <set name="PageNum" expr="ALLPAGENUM" />
           </if>
           <if condition="INTCMP(ALLPAGENUM,6,'0')">
               <if condition="INTCMP(PageNum,3,'0')">
                   <set name="PageNum" value="1" />
               </if>
           </if>
           
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
    <transaction code="LoginMerchant"   desc="商户登录校验">
      <sql name="QryMerCusInf">     <!-- 查询客户信息 用于校验用户状态-->
         SELECT CUST_STATUS,cust_name,m.LOGIN_NAME,m.LOGIN_PWD,m.cust_id ACCOUNT,
         round(to_number(sysdate-to_date(last_uppwd_date,'yyyy-mm-dd hh24:mi:ss'))) as timdif,
         LAST_UPPWD_DATE,PWD_CHANUM,m.COMPANY_BRIEF,m.AUT_STS
         FROM StpCusInf c,stpmerinf m WHERE c.cust_id=m.cust_id and m.LOGIN_NAME=#{USER_ID}
      </sql>
      <sql name="lastLoginInf"><!--查询用户上次登录信息-->
        select LOG_SUC_TIME,LOG_SUC_NUM,To_Char(to_date(LOG_SUC_TIME,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as lognTime 
        from stpcuslog  where cust_id =#{ACCOUNT} 
      </sql>
        <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
            SELECT 
            EXTRACT(DAY FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*24*60 + EXTRACT(HOUR FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*60 +  EXTRACT(MINUTE FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND )) as timeDifference,
            CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
            FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
            INSERT INTO STPLOGTMP
            (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
            VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
        </sql>
        <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
            LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
            WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="upcuslogtime">
            cust_id =  #{ACCOUNT}
        </sql>
      <process>
         <set name="sys_id"  expr="syscod"/>
         <if condition="OR(ISNULL(SYSCOD),ISNULL(USER_ID))">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01001"/>
            <set name="RSPMSG"    value="接收参数不符合条件,登录失败!"/>
            <return/>
         </if>
         
         <if condition="ISNULL(DELSPACE(USER_ID,'all'))">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09002"/>
            <set name="RspMsg"    value="账户名不能为空,请输入正确的账户名!"/>
            <return/>
         </if>
         <if condition="ISNULL(DELSPACE(USRPWD,'all'))">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09003"/>
            <set name="RspMsg"    value="密码不能为空,请正确输入账户密码!"/>
            <return/>
         </if>
         <if condition="ISNULL(DELSPACE(rand,'all'))">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09004"/>
            <set name="RspMsg"    value="验证码不能为空,请重新输入验证码!"/>
            <return/>
         </if>
         
         <!-- 查询商户信息 -->
         <quote name="merCusChk"/>
         
         <set name="USER_ID"   expr="DELBOTHSPACE(USER_ID)" />
         <set name="CUSTTYPE"  value="1"/><!--0用户1 商户 2企业-->
         <set name="PWDTYPE"   value="0"/><!--0:登录密码 1:支付密码-->
         <set name="FailFlag"  value="0"/>
         <set name="ConfigName"   value="G_CheckPwd"/>
         <quote name="ReadXmlCfg"/>
         <set name="G_ERRORCOUNT" expr="G_ERRORCOUNT"/><!--错误次数-->
         <set name="G_LOCK_MIN"   expr="G_LOCK_MIN"/><!--锁定分钟数-->
         <!--  查询用户登录失败次数及第一次失败时间  -->
         <do func="ReadRecord"   error="IGNORE">
           <para name="SqlCmd"    sql="QryUserLogFail"/>
         </do>
         <if condition="#RetCod==0">
            <if condition="OR(ISNULL(LOGIN_FAIL_COUNT),IS_EQUAL_STRING(DELBOTHSPACE(LOGIN_FAIL_COUNT),''))">
                <!--没有次数记录 没有登录过--> 
                <set name="FailFlag"  value="1"/>
            </if>
            <else>
                <set name="FailFlag"  expr="LOGIN_FAIL_COUNT"/>
                <!--判断该用户此次登录时间是否达到规定时间-->
                <if condition="OR(ISNULL(CURRENT_LOGIN_TIME),IS_EQUAL_STRING(DELBOTHSPACE(CURRENT_LOGIN_TIME),''))">
                    <!--没有时间记录 没有登录--> 
                    <set name="FailFlag"  expr="ADD(FailFlag,1)"/>
                </if>
                <else>
                  <!--存在最后一次异常登录时间-->
                  <set name="timeDifference"  expr="timeDifference"/><!--时间差-->
                  <!--如果是在5分钟内 只要更新次数+1-->
                  <if condition="DOUBLECMP(timeDifference,2,G_LOCK_MIN)">
                     <!--判断登录次数是否超过五次-->
                     <if condition="INTCMP(FailFlag,5,G_ERRORCOUNT)">
                         <!--5分钟内且第五次以上登录-->
                         <set name="MsgTyp"    value="E"/>
                         <set name="RspCod"    value="02075" />
                         <set name="RspMsg"     expr="STRCAT('连续登录失败',G_ERRORCOUNT,',请',G_LOCK_MIN,'分钟后再试！')"/>   
                         <quote name="UpLoginInfo"/>
                         <return/>
                     </if>
                     <else>
                         <!--五分钟内 登录次数少于五次时-->
                         <set name="FailFlag"  expr="ADD(FailFlag,1)"/>
                     </else>
                  </if>
                  <else>
                      <!--超过五分钟-->
                      <set name="FailFlag"  value="1"/>
                  </else>
                </else>
            </else>
         </if>
         <elseif condition="#RetCod==2">
            <!--添加用户登录失败信息-->
            <do func="ExecSql" error="IGNORE">
              <para name="SqlCmd" sql="InsUsrLogInfo"/>
            </do>
            <if condition="#RetCod!=0">
              <set name="RSPCOD" value="02040"/>
              <set name="RSPMSG" value="初始化登录信息失败!"/> 
              <return/>
            </if>
            <!--没有次数记录 没有登录过--> 
            <set name="FailFlag"  value="1"/>
         </elseif>
         <else>
            <do func="RollBackWork"/>
            <set name="RSPCOD" value="02038"/>
            <set name="RSPMSG" value="请稍后再试!"/>
            <return/>
          </else>
          
         <!--验证码验证-->
         <set name="RA"  expr="SESSIONS.SRA"/>
        <set name="RAND" expr="TOUPPER(RAND)"/>
        <if condition="IS_NOEQUAL_STRING(RA,RAND)">
          <set name="RspCod"        value="02006"/>
          <set name="RspMsg"        value="验证码输入错误"/>
          <return/>
        </if> 
         <!--pin转加密-->
         <set name="paypwd"          expr="USRPWD"/>
         <quote name="MerPwdAesToDes"/>
         <set name="NEW_USER_PWD"   expr="NewPwd"/>
         <!--判断密码是否正确-->
         <if condition="IS_NOEQUAL_STRING(NEW_USER_PWD,LOGIN_PWD)">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09005"/>
            <set name="RspMsg"    value="账号名或密码输入有误,请重新输入!"/>
            <quote name="UpLoginInfo"/>
            <return/>
         </if>
         
         <!--验证登录用户密码过期校验 start-->
         <set name="staleSign"      value="0"/><!--过期标识 0 正常 1 过期-->
         <!--记录过期时间 单位:天 从配置文件中读取参数-->
         <set name="pastTime"   expr="USER_EXPIRED_TIME"/>
         <if condition="OR(ISNULL(DELBOTHSPACE(pastTime)),IS_EQUAL_STRING('',DELBOTHSPACE(pastTime)))">
            <set name="pastTime"      value="0"/>
         </if>
         
         <!--验证登录密码过期校验-->
         <set name="timdif" expr="timdif"/>
         <if condition="OR(ISNULL(DELBOTHSPACE(timdif)),IS_EQUAL_STRING('',DELBOTHSPACE(timdif)))">
              <set name="staleSign"      value="1"/>
         </if>
         <elseif condition="DOUBLECMP(timdif,5,pastTime)">
               <set name="staleSign"    value="1"/>
         </elseif>
         <else>
              <!--出现没有记录上次密码修改时间的或者查询数据库失败的都默认为密码过期-->
              <set name="staleSign"  value="1"/>
         </else>
         <if condition="OR(ISNULL(pwd_chanum),IS_EQUAL_STRING(pwd_chanum,'0'))">
              <set name="pwd_chanum" value="0"/><!--密码修改的次数 0是初始值-->
              <!--出现没有记录上次密码修改时间的或者查询数据库失败的都默认为密码过期-->
              <set name="staleSign"  value="1"/>
         </if>
         <else>
              <set name="pwd_chanum" expr="pwd_chanum"/><!--密码修改的次数 0是初始值-->
         </else>
         <!--密码过期或者密码修改次数是0 则第一次登录 需登录修改-->
         <set name="reqip" expr="GetRequestAttr('REQIP')" />
         <!--查询用户上次登录信息-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="lastLoginInf"/>
         </do>
         <if condition="#RetCod==2">
            <set name="LOG_SUC_TIME" expr="GETDATETIME('YYYYMMDDHHMI')" /><!--获得当前登录时间-->
            <!-- 登录次数+1 -->
            <set name="cust_id"          expr="ACCOUNT"/>
            <set name="PRE_LOG_SUC_TIM"  expr="LOG_SUC_TIME" />
            <set name="PRE_LOG_SUC_IP"   expr="LOG_SUC_IP" />
            <set name="LOG_SUC_NUM"      value="0" />
            <set name="LOG_SUC_TIME"     expr="GETDATETIME()" />
            <set name="LOG_SUC_IP"       expr="reqip" />
            <do func="InsertRecord" error="IGNORE">
                <para name="TblNam" value="STPCUSLOG" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspMsg" value="修改登录次数，失败" />
            </if>
         </if>
         <elseif condition="#RetCod==0">
              <!-- 登录次数+1 -->
              <set name="PRE_LOG_SUC_TIM" expr="LOG_SUC_TIME" />
              <set name="PRE_LOG_SUC_IP"  expr="LOG_SUC_IP" />
              <set name="LOG_SUC_NUM"     expr="ADD(LOG_SUC_NUM,1)" />
              <set name="LOG_SUC_TIME"    expr="GETDATETIME('YYYYMMDDHHMI')" />
              <set name="LOG_SUC_IP"      expr="reqip" />
              <do func="UpdateRecord" error="IGNORE">
                  <para name="TblNam" value="STPCUSLOG" />
                  <para name="CndSts" sql="upcuslogtime" />
              </do>
              <if condition="#RetCod!=0">
                  <set name="RspMsg" value="修改登录次数，失败" />
              </if>
         </elseif>
         
         <set name="currentTime" expr="GETDATETIME()"/><!--获得当前登录时间-->
         
          <!-- 修改登记失败信息表 -->
          <do func="ExecSql" error="IGNORE">
             <para name="SqlCmd" sql="UpdUsrLogInfo"/>
          </do>
          <if condition="#RetCod!=0">
             <set name="RSPCOD" value="02040"/>
             <set name="RSPMSG" value="更新登录信息失败!"/> 
             <return/>
          </if>
          
          <set name="SESSIONS.USERID"      expr="user_id"/>   <!--用户ID-->
          <set name="SESSIONS.MERID"       expr="account"/>   <!--供中台使用-->
          <set name="SESSIONS.LOGNTIME"    expr="lognTime"/>  <!--上次登录时间-->
          <set name="SESSIONS.LOGNIP"      expr="logn_ip"/>   <!--上次登录IP-->
          <set name="SESSIONS.BUSNAME"     expr="cust_name" />
          <set name="SESSIONS.AUT_STS"     expr="AUT_STS" />
          <set name="SESSIONS.USERSIGN"    expr="crea_sign"/> <!--记录当前登录者是超级管理员还是普通管理员-->
          <set name="SESSIONS.STALESIGN"   expr="STALESIGN" /><!--过期标识 0 正常 1 过期-->
          
          <set name="RSPCOD" value="00000"/>
          <set name="RSPMSG" value="该用户可以正常登录!"/>
          
      </process>
    </transaction>
    
    <transaction code="enterMerchant" desc="进入商户系统获取所有权限">
        <sql name="querySysInf"><!--查询系统基本信息-->
          select a.sys_nam,a.sys_state, a.sys_rootid,b.menu_url as denglu_url 
          from limsysinf a,limmeninf b  where a.sys_id=b.sys_id and
           b.menu_par_id='00' and a.sys_id=#{SYS_ID}
        </sql>
        <sql name="queryUserMainQx"><!--查询登录用户在此系统中权限集合-->
           select d.menu_id, d.menu_par_id, d.menu_nam, d.menu_url, d.menu_state, 
           d.node_type from limmeninf d where d.menu_id in
           (select distinct a.menu_id from limumrele a,limrmrele b 
           where a.menu_id=b.menu_id and a.user_id=#{USER_ID} and a.account=#{ROLE_ACCOUNT} ) 
           and d.menu_state='1' 
           and d.menu_par_id='21' order by d.menu_id asc
        </sql>
        <sql name="queryUserMorenQx">
          select d.menu_id, d.menu_par_id, d.menu_nam, d.menu_url, d.menu_state, 
          d.node_type from limmeninf d where d.menu_id in ( ${menulims} )
        </sql>
        <sql name="QryMerCusInf">     <!-- 查询客户信息 用于校验用户状态-->
           SELECT cust_name,m.LOGIN_NAME,m.cust_id ACCOUNT,m.AUT_STS
           FROM StpCusInf c,stpmerinf m WHERE c.cust_id=m.cust_id and m.LOGIN_NAME=#{MEREMAIL}
        </sql>
        <process>
            <!--商户系统id 2201 用户10000000000000 公共角色权限 10000000000000-->
            <set name="SYS_ID"         value="2201" />
            <set name="USER_ID"        value="admin"/>
            <set name="ROLE_ACCOUNT"   value="10000000000000"/>
            
            <set name="STALESIGN"      expr="SESSIONS.STALESIGN" />
            <set name="MERID"        expr="SESSIONS.MERID"/>
            <set name="MEREMAIL"     expr="SESSIONS.USERID"/>
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryMerCusInf"/>
            </do>
            <if condition="#RetCod==-1">
                <do func="RollBackWork"/>
                <set name="status"  value="0"/>
                <set name="RSPMSG"  value="获取信息失败!"/>
                <return/>
            </if>
            
            <set name="SESSIONS.AUT_STS"     expr="AUT_STS" />
            <!--查询当前用户是否有指定系统的权限 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="querySysInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RSPMSG" value="获取系统信息失败!" />
                <set name="_REQUESTATTR.FORWARDURL" value="index.jsp" />
                <return />
            </if>
            
            <set name="STALESIGN"  value="0"/>
            <!--密码过期或者第一次登陆修改密码都使用修改密码的菜单编号21,2101,210105-->
            <if condition="INTCMP(STALESIGN,3,1)">
               <set name="merchantLimits" value="21,2101,210105"/>
               <set name="menulims"  expr="merchantLimits"/>
               <do func="QueryInGroup" error="IGNORE">
                  <para name="SqlCmd" sql="queryUserMorenQx"/>
                  <para name="RecordName" value="GRP" />
               </do>
               <if condition="#RetCod!=-1">
                  <set name="RSPCOD" value="00000"/>
                  <set name="status" value="1"/>
                  <set name="outUrl" expr="outUrl"/>
                  <set name="RSPMSG" value="登录成功!"/>
                  <return/>
               </if>
               <else>
                  <set name="RSPCOD" value="02040"/>
                  <set name="status" value="0"/>
                  <set name="RSPMSG" value="获取用户菜单信息失败,访问失败!"/>
                  <set name="outUrl" expr="initLogUrl"/>
                  <return/>
               </else>
            </if>
            <else>
                <do func="QueryInGroup" error="IGNORE">
                    <para name="SqlCmd" sql="queryUserMainQx" />
                    <para name="RecordName" value="GRP" />
                </do>
                <if condition="#RetCod!=-1">
                    <set name="RSPCOD" value="00000" />
                    <set name="RSPMSG" value="登录成功!" />
                </if>
                <else>
                    <set name="RSPCOD" value="02040" />
                    <set name="RSPMSG" value="获取用户菜单信息失败,访问失败!" />
                    <set name="_REQUESTATTR.FORWARDURL" value="index.jsp" />
                    <return />
                </else>
            </else>
            
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="登录成功" />
            <set name="LoginSign" value="1" />  <!-- 登录标识 -->
            <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/common/topmenu.jsp')" />
        </process>
    </transaction>
    
    <transaction code="getMerFuncMenu" desc="查询商户系统一级菜单下的子功能菜单">
        <sql name="queryUserMainQx"><!--查询登录用户在此系统中权限集合-->
           select d.menu_id, d.menu_par_id, d.menu_nam, d.menu_url, d.menu_state, 
           d.node_type from limmeninf d where d.menu_id in
           (select distinct a.menu_id from limumrele a,limrmrele b 
           where a.menu_id=b.menu_id and a.user_id=#{USER_ID} and a.account=#{ROLE_ACCOUNT} ) 
           and d.menu_state='1' 
           and d.menu_par_id=#{PAR_MENU_ID} order by d.menu_id asc
        </sql>
        <sql name="queryUserMorenQx">
          select d.menu_id, d.menu_par_id, d.menu_nam, d.menu_url, d.menu_state, 
          d.node_type from limmeninf d where d.menu_id in ( ${menulims} )
        </sql>
        <process>
            <set name="MERID"       expr="SESSIONS.MERID" />
            <if condition="OR(IS_EQUAL_STRING(MERID,''),ISNULL(MERID))"> <!-- 检测没有登录则跳转首页 -->
               <set name="_REQUESTATTR.REDIRECTURL" value="index.jsp" />
               <return/>
            </if>
            
            <set name="_REQUESTATTR.FORWARDURL"
                expr="STRCAT('html/', SESSIONS.LANGUAGE, '/common/content.jsp')" />
            <set name="SYS_ID"         value="2201" />
            <set name="USER_ID"        value="admin"/>
            <set name="ROLE_ACCOUNT"   value="10000000000000"/>
            <set name="STALESIGN"      expr="SESSIONS.STALESIGN" />
            
            <set name="STALESIGN"  value="0"/>
            <if condition="INTCMP(STALESIGN,3,1)">
               <!--密码过期或者第一次登陆修改密码都使用修改密码的菜单编号21,2101,210105-->
               <set name="merchantLimits" value="21,2101,210105"/>
               <set name="menulims"  expr="merchantLimits"/>
               <do func="QueryInGroup" error="IGNORE">
                  <para name="SqlCmd" sql="queryUserMorenQx"/>
                  <para name="RecordName" value="GRP" />
               </do>
            </if>
            <else>
              <do func="QueryInGroup" error="IGNORE">
                  <para name="SqlCmd" sql="queryUserMainQx" />
                  <para name="RecordName" value="GRP" />
              </do>
            </else>
            <if condition="#RetCod==-1">
                <set name="RSPCOD" value="02040" />
                <set name="RSPMSG" value="获取用户菜单信息失败,访问失败!" />
                <set name="_REQUESTATTR.FORWARDURL" value="index.jsp" />
                <return />
            </if>
            
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="登录成功" />
        </process>
    </transaction>
    
    <transaction code="MercheckAcc" desc="商户电子邮箱是否注册">
        <sql name="QryMerPayno"> <!-- 账号检测 -->
             select u.LOGIN_NAME   from stpmerinf u  where u.LOGIN_NAME=#{meremail}  
        </sql>
        <process>
            
            <!-- 账号检测 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryMerPayno" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02009" />
                <set name="RspMsg" value="电子邮箱不存在，可以注册" />
            </if>
            <elseif condition="#RetCod==-1">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09998" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>

            <if condition="IS_EQUAL_STRING(flag,'0')"> <!-- 用于注册时的账户检测 -->
               <return/>
            </if>
            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
    </transaction>
    
    <transaction code="MerSendCod" desc="商户注册邮箱-验证申请">
        <sql name="QryMerPayno"> <!-- 账号检测 -->
            select u.LOGIN_NAME   from stpmerinf u    where u.LOGIN_NAME=#{meremail} 
        </sql>
       <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
         DELETE FROM STPVERIFY  WHERE VER_ID=#{EMAIL} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
       </sql>
       <sql name="InsUsrrandom"> <!--  插入用户验证信息  --> 
         INSERT INTO  STPVERIFY (VER_ID,VER_TYPE,InsTim,Random,TimeOut,SERVICE_TYPE,VER_TRAN_NO) 
         VALUES (#{EMAIL},#{VER_TYPE}, sysdate ,#{Random},#{TimeOut},#{SERVICE_TYPE},#{TRANCODE}) 
       </sql>
       <process>
           <!--  检测商户登录平台：2201 -->
           <if condition="IS_NOEQUAL_STRING(SysCod,'2201')">
             <set name="MsgTyp"        value="E"/>
             <set name="RspCod"        value="01001"/>
             <set name="RspMsg"        value="登录平台不正确"/>
             <return/>
           </if>
           
           <!--  检测电子邮箱是否为空  -->
           <set name="MerEmail"          expr="DELBOTHSPACE(phone)"/>
           <if condition="IS_EQUAL_STRING(MerEmail,'')"> 
             <set name="MsgTyp"        value="E"/>
             <set name="RspCod"        value="02035"/>
             <set name="RspMsg"        value="电子邮箱为空"/>
             <return/>
           </if>
           <if condition="IS_EQUAL_STRING(verifycode,'')"> 
             <set name="MsgTyp"        value="E"/>
             <set name="RspCod"        value="02035"/>
             <set name="RspMsg"        value="验证码为空"/>
             <return/>
           </if>
           <set name="verifycode"     expr="TOUPPER(verifycode)"/>
           <set name="RA"  expr="SESSIONS.SRA"/>
           <if condition="IS_NOEQUAL_STRING(RA,verifycode)">
             <set name="MsgTyp"       value="E"/>
             <set name="RspCod"       value="02035"/>
             <set name="RspMsg"       value="验证码错误"/>
             <return/>
           </if>
           <!--  检测商户是否存在  -->
           <do func="ReadRecord" error="IGNORE">
             <para name="SqlCmd"   sql="QryMerPayno" />
           </do>
           <if condition="#RetCod==2">
             <set name="MsgTyp"        value="E"/>
             <set name="RspCod"        value="02008"/>
             <set name="RspMsg"        value="电子邮箱不存在，可以注册"/>
           </if>
           <elseif condition="#RetCod==-1">
             <set name="MsgTyp"        value="E"/>
             <set name="RspCod"        value="09999"/>
             <set name="RspMsg"        value="系统错误"/>
             <return/>
           </elseif>
           <elseif condition="#RetCod==0">
             <set name="MsgTyp"        value="E"/>
             <set name="RspCod"        value="09998"/>
             <set name="RspMsg"        value="电子邮箱已存在，不可以注册"/>
             <return/>
           </elseif>
           
           <if condition="IS_EQUAL_STRING(TimeOut,'')">
              <set name="TimeOut" value="10" />
           </if>
           <set name="EMAIL"           expr="DELBOTHSPACE(MerEmail)"/>
           <set name="VER_TYPE"        value="1"/><!--验证类型 0：短信验证 1：邮箱验证 -->
           <set name="TimeOut"         expr="MUL(24,60)" />
           <set name="TimeOut"         value="1440"/>
           <!--  验证 -->
           <if condition="ISNULL(SERVICE_TYPE)">
               <set name="SERVICE_TYPE" value="00"/><!--验证码服务类型 00-注册短信验证 01-修改密码短信验证 02-找回密码短信验证 03-数字证书短信验证 04-帐号变更短信验证 05-消费支付短信验证 -->
           </if>
           <else>
               <set name="SERVICE_TYPE" expr="SERVICE_TYPE" />
           </else>
           
           <!--  删除已有验证码申请信息  -->
           <do func="ExecSql" error="IGNORE">
             <para name="SqlCmd"  sql="DelUsrIdInfo" />
           </do>
           <if condition="#RetCod==2">
             <set name="MsgTyp"        value="N"/>
             <set name="RspCod"        value="00000"/>
             <set name="RspMsg"        value="未找到验证码登记信息"/>
           </if>
           <elseif condition="#RetCod!=0">
             <set name="MsgTyp"        value="E"/>
             <set name="RspCod"        value="09999"/>
             <set name="RspMsg"        value="系统错误"/>
             <return/>
           </elseif>
           
           <!--  随机字符串长度  -->
           <!--  随机字符: ALL 字母和数字;  NUM 数字;   STR 字母  -->
           <!--  大小写标识: MIX 混合;   UPP 大写;   LOW 小写;  -->
           <do expr="@TdRandom@generateMixRandom(6, 'NUM', 'LOW')"/>
           <!--邮件发送取公共参数配置-->
           <set name="ConfigName"   value="CheckEmailNew"/>
           <quote name="ReadXmlCfg"/>
           <set name="EmText"        value="欢迎"/>
           <set name="EmerchantOper" value="usr"/>
           <set name="EmerchantId"   expr="Email"/>
           <set name="EmResAddr"     expr="G_VALURLMER"/>
           <set name="G_EMCOMPHTTP"  expr="G_VALURLMER"/>
           <set name="checkUrl"      expr="STRCAT(G_VALURLMER,'merchkcod.tran?a=2201&amp;b=',EMAIL,'&amp;c=',EMAIL,'&amp;d=',Random)"/> 
           <set name="G_VALURL"      expr="checkUrl"/>
           <!--  发送邮件至指定邮箱  -->
           <quote name="MerSendEmail"/>
           
           <do func="ExecSql" error="IGNORE">
             <para name="SqlCmd" sql="InsUsrrandom"/>
           </do>
           <if condition="#RetCod!=0">
             <set name="MsgTyp"        value="E"/>
             <set name="RspCod"        value="09999"/>
             <set name="RspMsg"        value="系统错误"/>
             <return/>
           </if>
           <do func="CommitWork"/>
           <delete name="Random"/>
           <set name="MsgTyp"          value="N"/>
           <set name="RspCod"          value="00000"/>
           <set name="RspMsg"          value="交易成功"/>
           
       </process>
    </transaction>
    
    <transaction code="merchkcod" desc="商户邮箱注册-邮箱验证">
       <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
         SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,TimeOut,VER_TYPE,InsTim,Random 
         FROM STPVERIFY 
         WHERE VER_ID=#{Email} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
       </sql>
       <sql name="QryMerPayno"> <!-- 账号检测 -->
            select u.LOGIN_NAME   from stpmerinf u  where u.LOGIN_NAME=#{EMAIL}  
        </sql>
       <process>
          <do func="DumpEtf"/>
          <set name="SYSCOD"     expr="a"/>
          <set name="USRMP"      expr="b"/>
          <set name="EMAIL"      expr="c"/>
          <set name="RANDSTR"    expr="d"/>
          
          
         <!--  检测电子邮箱是否为空  -->
         <set name="Email"          expr="DELBOTHSPACE(EMAIL)"/>
         <if condition="IS_EQUAL_STRING(Email,'')"> 
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="02042"/>
           <set name="RspMsg"        value="用户名不能为空"/>
           <set name="RspMsg"        value="连接失效或已经经过验证，请重新获取验证码"/>
           <!-- 默认错误跳转页面 -->
           <set name="_REQUESTATTR.FORWARDURL" value="/html/zh-CN/error/error.jsp" />
           <return/>
         </if>
         <!--  检测商户是否存在  -->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd"   sql="QryMerPayno" />
         </do>
         <if condition="#RetCod==2">
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="02008"/>
           <set name="RspMsg"        value="电子邮箱不存在，可以注册"/>
         </if>
         <elseif condition="#RetCod==-1">
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="09999"/>
           <set name="RspMsg"        value="系统错误"/>
           <!-- 默认错误跳转页面 -->
           <set name="_REQUESTATTR.FORWARDURL" value="/html/zh-CN/error/error.jsp" />
           <return/>
         </elseif>
         <elseif condition="#RetCod==0">
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="09998"/>
           <set name="RspMsg"        value="电子邮箱已经存在，请直接登录！"/>
           <!-- 默认错误跳转页面 -->
           <set name="_REQUESTATTR.FORWARDURL" value="/html/zh-CN/error/error.jsp" />
           <return/>
         </elseif>
         
         <set name="VER_TYPE" value="1"/><!--验证类型 0：短信验证 1：邮箱验证 -->
         <!--  帐号变更短信验证 -->
         <if condition="ISNULL(SERVICE_TYPE)">
             <set name="SERVICE_TYPE" value="00"/><!--验证码服务类型 00-注册短信验证 01-修改密码短信验证 02-找回密码短信验证 03-数字证书短信验证 04-帐号变更短信验证 05-消费支付短信验证 -->
         </if>
         <else>
             <set name="SERVICE_TYPE" expr="SERVICE_TYPE" />
         </else>
         <!--  查询用户申请的验证记录  -->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="QryUsrIdverifycode" />
         </do>
         <if condition="#RetCod==2">
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="02009"/>
           <set name="RspMsg"        value="该用户未申请验证码"/>
           <set name="RspMsg"        value="连接失效或已经经过验证，请重新获取验证码"/>
           <!-- 默认错误跳转页面 -->
           <set name="_REQUESTATTR.FORWARDURL" value="/html/zh-CN/error/error.jsp" />
           <return/>
         </if>
         <elseif condition="#RetCod!=0">
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="09999"/>
           <set name="RspMsg"        value="系统错误"/>
           <!-- 默认错误跳转页面 -->
           <set name="_REQUESTATTR.FORWARDURL" value="/html/zh-CN/error/error.jsp" />
           <return/>
         </elseif>
         <!--超时时间判断,timdif为距离现在间隔多少分钟，timeout超时时间-->
         <if condition="INTCMP(timdif,6,timeout)">
           <set name="RspCod"        value="02005"/>
           <set name="RspMsg"        value="验证码已失效,请重新获取验证码"/>
           <!-- 默认错误跳转页面 -->
           <set name="_REQUESTATTR.FORWARDURL" value="/html/zh-CN/error/error.jsp" />
           <return/>
         </if>
         <!--  判断验证码是否正确  -->
         <if condition="IS_NOEQUAL_STRING(RandStr,Random)">
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="02006"/>
           <set name="RspMsg"        value="验证码已被篡改，请重新获取验证码"/>
           <!-- 默认错误跳转页面 -->
           <set name="_REQUESTATTR.FORWARDURL" value="/html/zh-CN/error/error.jsp" />
           <return/>
         </if>
         <delete name="Random"/>
         
         <!-- 下一步跳转页面 -->
         <set name="PAGE"   expr="STRCAT('/register/filluserinfo.jsp?EMAIL=',EMAIL)" />
         <set name="_REQUESTATTR.REDIRECTURL" expr="STRCAT('html/zh-CN', PAGE)" />
         
         <set name="MsgTyp"          value="N"/>
         <set name="RspCod"          value="00000"/>
         <set name="RspMsg"          value="交易成功"/>
       </process>
    </transaction>
    
    <transaction code="MerOpenAcc"   desc="线上商户开户">
     <sql name="QryMerPayno"> <!-- 账号检测 -->
          select u.login_name,COMPANY_BRIEF,AUT_STS  from stpmerinf u  
          where u.LOGIN_NAME=#{MEREMAIL} 
     </sql>
     <process>
        <if condition="IS_EQUAL_STRING(FLAG,'1')">
           <set name="PAGE"   value="/register/otherauthentic.jsp" />
           <set name="_REQUESTATTR.REDIRECTURL" expr="STRCAT('html/zh-CN', PAGE)" />
           <return/>
        </if>
        <set name="LOGIN_NAME"     expr="MEREMAIL"/>
        <set name="COMPAY_EMAIL"   expr="MEREMAIL"/>
        
        <!--  检测电子邮箱是否为空  -->
        <set name="MerEmail"          expr="DELBOTHSPACE(MEREMAIL)"/>
        <if condition="IS_EQUAL_STRING(MerEmail,'')"> 
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="电子邮箱为空"/>
         <return/>
        </if>
        
        <!--  检测商户是否存在  -->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd"   sql="QryMerPayno" />
         </do>
         <if condition="#RetCod==2">
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="02008"/>
           <set name="RspMsg"        value="电子邮箱不存在，可以注册"/>
         </if>
         <elseif condition="#RetCod==-1">
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="09999"/>
           <set name="RspMsg"        value="系统错误"/>
           <return/>
         </elseif>
         <elseif condition="#RetCod==0">
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="09998"/>
           <set name="RspMsg"        value="电子邮箱已经存在，请直接登录！"/>
           <return/>
         </elseif>
         
        <!-- 操作员  -->
        <set name="admin"         value="ADMIN"/> 
        <set name="OPEN_NAME"     expr="admin"/> 
        <!-- 当前日期  -->
        <set name="OPEN_DATE"     expr="GETDATE()"/>
        <!-- 复核参数 -->
        <set name="AUT_STATUS"      value="0"/><!--审核状态 0 未审核 1审核不通过 2审核通过-->
        <set name="AUT_STS"         value="0"/><!--认证状态 0 未认证  1 认证通过 2 认证拒绝 3 认证中-->
        <set name="MER_TYPE"        value="0"/><!--商户类型 0：一般商户；1：平台商户  -->
        <!--pin转加密-->
        <set name="paypwd"          expr="UsrPwd"/>
        <quote name="MerPwdAesToDes"/>
        <set name="LOGIN_PWD"      expr="NewPwd"/>
        
        <!-- 获取商户编号  -->
        <do func="GetSeqNo"  error="IGNORE">
          <para name="TblNam" value="stpseqrec"/>
          <para name="KeyNam" value="KeyNam"/>
          <para name="KeyVal" value="STPCUSINF_CUSTID"/>
          <para name="SeqNam" value="KeyVal"/>
          <para name="Len"    value="8"/>
          <para name="Circle" value="1"/>
        </do>
        <if condition="#RetCod!=0">
          <set name="RspCod"    value="9001"/>
          <set name="RspMsg"    value="生产商户号错误，请重新提交。"/>
          <set name="DWZ_STATUS_CODE" value="300"/>
          <set name="DWZ_RSP_MSG" expr="RSPMSG"/>
          <return/>
        </if>
        <set name="CUST_ID"              expr="STRCAT('000000',KeyVal)"/>
        <set name="company_brief"        expr="CUST_NAME"/>
        
        <!--修改商户信息审核成功-->
        <do func="InsertRecord" error="IGNORE">
           <para name="TblNam"  value="STPMERINF" />
        </do>
        
        <!-- 客户状态  -->
        <set name="CUST_STATUS"     value="0"/>
        <!-- 客户类型  -->
        <set name="CUST_TYPE"       value="1"/>
        <!-- 客户证件类型 9 企业营业执照  -->
        <set name="CUST_CRED_TYPE"  value="9"/>
        <!-- 客户名称  -->
        <set name="CUST_NAME"          expr="CUST_NAME"/>
        <!-- 客户证件号  -->
        <set name="CUST_CRED_NO"       value=""/>
        <!-- 开户操作员 -->
        <set name="CUST_REG_ID"        expr="admin"/>
        <!-- 开户日期 -->
        <set name="CUST_REG_DATE"      expr="nowDate"/>
        <!-- 开户时间 -->
        <set name="CUST_REG_TIME"      expr="nowTime"/>
        
        <do func="InsertRecord" error="IGNORE">
            <para name="TblNam"  value="STPCUSINF" />
        </do>
        <if condition="#RetCod!=0">
            <set name="MRspCod"    value="09999"/>
            <set name="MRspMsg"    value="系统错误"/>
            <do func="RollBackWork"/>
            <return/>
        </if>
        
        <!-- 账户类型 -->
        <set name="AC_TYPE"           value="01"/>
        <!-- 生成商户现金支付账号  -->
        <set name="PAY_AC_NO"            expr="STRCAT(CUST_ID,'01')"/> 
        <quote name="openMer"/>
        <!-- 账户类型 01现金账户；02结算账户-->
        <set name="AC_TYPE"           value="02"/>
        <!-- 生成商户结算支付账号  -->
        <set name="PAY_AC_NO"            expr="STRCAT(CUST_ID,'02')"/> 
        <quote name="openMer"/>
        
         <!--do func="GetSeqNo"  error="IGNORE">
            <para name="TblNam" value="stpseqrec"/>
            <para name="KeyNam" value="KeyNam"/>
            <para name="KeyVal" expr="STRCAT('STPMERPAPPAP_ID',GETDATE())"/>
            <para name="SeqNam" value="KeyVal"/>
            <para name="Len"    value="5"/>
            <para name="Circle" value="1"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09001"/>
            <set name="RspMsg"    value="获取序号错误"/>
            <return/>
         </if>
         <set name="seqno"      value="1"/>
         <set name="PAP_ID"         expr="STRCAT(GETDATETIME('YYMMDD'),KeyVal)"/>
         <set name="PAP_BUS_ID"     expr="CUST_ID"/>
         <set name="PAP_SEQ"        expr="seqno"/>
         <set name="PAP_QUES"       expr="question1"/>
         <set name="PAP_ANSW"       expr="answer1"/> 
         <set name="PAP_DATE"       expr="GETDATETIME('YYYYMMDDHHMISS')"/>
         <set name="PAP_LAST_DATE"  expr="GETDATETIME('YYYYMMDDHHMISS')"/>
         
         <set name="PAP_ANSW"   expr="DES_ENCRYPT(PAP_ANSW)"  />
         
         <do func="InsertRecord" >
            <para name="TblNam"  value="STPMERPAP" />
         </do>
         <if condition="#RetCod==3">
            <set name="RspCod"    value="09996"/>
            <set name="RspMsg"    value="数据库主键冲突"/>
            <return/>
         </if>
         <elseif condition="#RetCod!=0">
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </elseif-->
         
        <!--风控操作类型1新增，2修改-->
        <set name="DTYPE"       value="1"/>
        <set name="DTYPE"                              expr="DTYPE"/>
        <set name="CCODE"                              expr="CUST_ID"/>
        <set name="PCAD"                               expr="PAY_AC_NO"/>
        <set name="CNAME"                              expr="CUST_NAME"/>
        <set name="CDATE"                              expr="CONTRACT_STR_DATE"/>
        <set name="MDATE"                              expr="CONTRACT_END_DATE"/>
        <set name="DATE"                               expr="nowDate"/>
        <set name="TIME"                               expr="nowTime"/>
        <set name="sthCode"                            value="540505"/>
        <quote name="rcsMaro"/>
        
        <set name="SESSIONS.account"     expr="CUST_ID"/>   <!--商户系统的账户号-->
        <set name="SESSIONS.MERID"       expr="CUST_ID"/>   <!--供中台使用-->
        <set name="SESSIONS.userId"      expr="MEREMAIL"/>   <!--邮箱-->
        <set name="SESSIONS.MERPAYACNO"  expr="PAY_AC_NO"/>
        <set name="SESSIONS.BUSNAME"     expr="CUST_NAME" />
        <set name="SESSIONS.AUT_STS"     expr="AUT_STS" />
        <set name="RspCod"    value="00000"/>
        <set name="RspMsg"    value="商户开户成功！"/>
        <set name="MsgTyp"        value="N"/>
        
     </process>
    </transaction>
    
    <transaction code="MerVerify" desc="商户身份认证信息">
       <sql name="UpdMerAut"> <!-- 修改商户审核信息 -->
            UPDATE STPMERINF SET COMPAY_TEL_NO=#{COMPAY_TEL_NO},AUT_STS=#{AUT_STS},
            COMPAY_EMAIL=#{MEREMAIL},CUST_STL_BANK_AC_NO=#{CUST_STL_BANK_AC_NO},
            BANK_REL_NO=#{BANK_REL_NO}, LAW_PERSON_CRET_TYPE='0',
            ORGANIZATION_NO=#{ORGANIZATION_NO},LAW_PERSON_CRET_NO=#{LAW_PERSON_CRET_NO},
            TAX_REGISTRATION_NO=#{TAX_REGISTRATION_NO},DEPOSIT_BANK_BRCH_NAME=#{DEPOSIT_BANK_BRCH_NAME},
            MER_LAW_PERSON=#{MER_LAW_PERSON}, CUST_BANK_DEPOSIT_NAME=#{CUST_BANK_DEPOSIT_NAME}, 
            CRED_PIC=#{FILENAME1S},ORG_PIC=#{FILENAME2S},
            LAW_PIC1=#{FILENAME3S},LAW_PIC2=#{FILENAME4S} WHERE CUST_ID=#{MERID}
       </sql>
       <sql name="QryMerInfo"> <!-- 账号检测 -->
            select login_name,login_pwd,mer_type,cust_id,compay_email,AUT_STS OLD_AUT_STS
             from stpmerinf where cust_id=#{MERID} 
        </sql>
        <sql name="QryMerInfoMore"> <!-- 查询商户信息 -->
            select * from stpmerinf where cust_id=#{MERID} 
        </sql>
        <sql name="QMerInFo">
            select m.*,f.remark,c.cust_cred_no MER_BUSREGNUM from stpmerinf m ,stpmerautinf f,stpcusinf c  where  m.cust_id =f.cust_id and c.cust_id =m.cust_id and m.cust_id=#{MERID} 
        </sql>
        <sql name="UpdCustMer"> <!-- 修改客户信息 -->
            update stpcusinf set cust_cred_type='9',cust_cred_no=#{MER_BUSREGNUM} where CUST_ID=#{MERID}
        </sql>
        <sql name="UpdMerInf"> <!-- 修改商户信息 -->
            CUST_ID=#{MERID}
        </sql>
        <sql name="UpdMerAutInf"> <!-- 修改商户审核信息 -->
            UPDATE STPMERAUTINF SET CRED_PIC=#{CRED_PIC},
            ORG_PIC=#{ORG_PIC},LAW_PIC1=#{LAW_PIC1},
            LAW_PIC2=#{LAW_PIC2}  WHERE CUST_ID=#{MERID}
        </sql>
         <sql name="QryCitys2">
               SELECT CITYID,CITY FROM STPCITYTB WHERE FATHERID =#{BANK_PRO_ID}
         </sql>
          <sql name="QryCnaps">       <!--  查询单条结算开户行的信息  -->
               SELECT bank_city_id,bank_pro_id,CNAPS_CODE,bank_name,sub_branch FROM  CNAPS where 1=1 AND  CNAPS_CODE=#{BANK_REL_NO}
          </sql>
          <sql name="QryCnapsList">       <!--  查询所有的信息  -->
               SELECT  bank_name  FROM  CNAPS where 1=1 
               AND  bank_city_id=#{bank_city_id} and bank_pro_id=#{bank_pro_id} 
               group by bank_name
          </sql>
          <sql name="QrycodeList">       <!--  查询所有的信息  -->
               SELECT  max(sub_branch) sub_branch,CNAPS_CODE  FROM  CNAPS where 1=1 
               AND  bank_city_id=#{bank_city_id} and bank_pro_id=#{bank_pro_id} 
               group by CNAPS_CODE
          </sql>
        <process>
            <!-- 检查用户登录平台是否正确   -->
            <if condition="IS_NOEQUAL_STRING(SysCod,'2201')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>
            <set name="pasNow"       expr="pasNow"/>
            
            <if condition="AND(NOT(ISNULL(SESSIONS.MERID)),IS_NOEQUAL_STRING(SESSIONS.MERID,''))">
                <set name="MERID"        expr="SESSIONS.MERID"/>
            </if>
            
            <if condition="AND(NOT(ISNULL(SESSIONS.USERID)),IS_NOEQUAL_STRING(SESSIONS.USERID,''))">
                <set name="MEREMAIL"     expr="SESSIONS.USERID"/>
            </if>
            
            <!-- 注册跳过实名验证标识 1标识跳过   -->
            <if condition="IS_EQUAL_STRING(PASNOW,'1')">
                <set name="PAGE" value="/register/registesuccessed.jsp" />
                <set name="_REQUESTATTR.REDIRECTURL" expr="STRCAT('html/zh-CN', PAGE)" />
                <return />
            </if>
            <!-- 线上实名验证标识 1标识   -->
            <if condition="IS_EQUAL_STRING(flag,'1')">
                <set name="PAGE" value="/identify/meridentify.jsp" />
                <set name="_REQUESTATTR.REDIRECTURL" expr="STRCAT('html/zh-CN', PAGE)" />
                <return />
            </if>
            
            <!--认证失败 线上实名验证标识    -->
            <if condition="IS_EQUAL_STRING(flag,'9')">
                
                <do func="ReadRecord"    error="IGNORE">
                   <para name="SqlCmd"   sql="QMerInFo" />
                </do>
                <if condition="#RetCod==2">
                   <set name="MsgTyp"        value="E"/>
                   <set name="RspCod"        value="02008"/>
                   <set name="RspMsg"        value="该商户不存在！"/>
                   <return/>
                </if>
                <!--解密证件号码-->
                <set name="MER_BUSREGNUM"                  expr="DES_DECRYPT(MER_BUSREGNUM)"/>
                <set name="LAW_PERSON_CRET_NO"             expr="DES_DECRYPT(LAW_PERSON_CRET_NO)"/>
                <do func="SelPro"                          error="IGNORE"/>
                <do func="ReadRecord"                       error="IGNORE">
                   <para name="SqlCmd"                       sql="QryCnaps"/>
                 </do>
                 <set name="BANK_PRO_ID"  expr="bank_pro_id"/>
                 <set name="BANK_CITY_ID" expr="bank_city_id"/>
                 <if condition="OR(ISNULL(BANK_PRO_ID),IS_EQUAL_STRING(BANK_PRO_ID,''))">
                     <set name="BANK_PRO_ID"   value="110000"/>
                 </if>
                 <!--查询开户城市-->
                 <do func="QueryInGroup" error="IGNORE">
                    <para name="SqlCmd"                    sql="QryCitys2" />
                    <para name="RecordName"                value="CITYS2"/>
                 </do>
                 
                <do func="QueryInGroup" error="IGNORE">
                  <para name="SqlCmd"  sql="QryCnapsList"/>
                  <para name="RecordName"    value="GRPCNAPS"/>
                </do>
                <do func="QueryInGroup" error="IGNORE">
                  <para name="SqlCmd"  sql="QrycodeList"/>
                  <para name="RecordName"    value="GRPCODE"/>
                </do>
                <set name="PAGE" value="/identify/meridentify.jsp" />
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/zh-CN', PAGE)" />
                <return />
            </if>
            
            <!--线上附件上传跳转页面   -->
            <if condition="IS_EQUAL_STRING(pflag,'1')">
                <set name="PAGE" value="/identify/identif.jsp" />
                <set name="_REQUESTATTR.REDIRECTURL" expr="STRCAT('html/zh-CN', PAGE)" />
                <return />
            </if>
            
            <!-- 线上实名验证标识 1标识   -->
            <if condition="IS_EQUAL_STRING(pflag,'2')">
                <set name="PAGE" value="/identify/submitsuccess.jsp" />
                <set name="_REQUESTATTR.REDIRECTURL" expr="STRCAT('html/zh-CN', PAGE)" />
                <return />
            </if>
            
            <do func="ReadRecord"    error="IGNORE">
               <para name="SqlCmd"   sql="QryMerInfo" />
            </do>
            <if condition="#RetCod==2">
               <set name="MsgTyp"        value="E"/>
               <set name="RspCod"        value="02008"/>
               <set name="RspMsg"        value="该商户不存在！"/>
               <return/>
            </if>
            <if condition="IS_EQUAL_STRING(OLD_AUT_STS,3)">
               <set name="MsgTyp"        value="E"/>
               <set name="RspCod"        value="02099"/>
               <set name="RspMsg"        value="该商户认证中！"/>
               <return/>
            </if>
            <elseif condition="IS_EQUAL_STRING(OLD_AUT_STS,1)">
               <set name="MsgTyp"        value="E"/>
               <set name="RspCod"        value="02098"/>
               <set name="RspMsg"        value="该商户已认证通过！"/>
               <return/>
            </elseif>
            
            <!-- 操作员  -->
            <set name="admin"         value="ADMIN"/> 
            <set name="OPEN_NAME"     expr="admin"/> 
            <!-- 当前日期  -->
            <set name="OPEN_DATE"     expr="GETDATE()"/>
            <!-- 复核参数 -->
            <set name="AUT_STATUS"      value="0"/><!--审核状态 0 未审核 1 审核不通过 2 审核通过-->
            <set name="AUT_TYPE"        value="2"/><!--审核类型 1 商户开户 2 商户修改-->
            <set name="AUT_STS"         value="0" /><!--认证状态 0 未认证 1 认证通过 2 认证拒绝 3认证中-->
            <!--注册不跳过实名认证-->
            <if condition="IS_EQUAL_STRING(PASNOW,'0')">
               <set name="AUT_STS"  value="3" /><!--认证状态 0 未认证 1 认证通过 2 认证拒绝 3认证中-->
            </if>
            
            <!-- 线上实名验证标识-->
            <if condition="IS_EQUAL_STRING(pflag,'3')"> <!--上传证件照片进行认证-->
                <do func="ReadRecord"    error="IGNORE">
                   <para name="SqlCmd"   sql="QryMerInfoMore" />
                </do>
                <if condition="#RetCod==2">
                   <set name="MsgTyp"        value="E"/>
                   <set name="RspCod"        value="02008"/>
                   <set name="RspMsg"        value="该商户不存在！"/>
                   <return/>
                </if>
                
                <!-- 获取序列编号 -->
                <do func="GetSeqNo"  error="IGNORE">
                  <para name="TblNam" value="stpseqrec"/>
                  <para name="KeyNam" value="KeyNam"/>
                  <para name="KeyVal" value="STPMERAUTINF_ID"/>
                  <para name="SeqNam" value="KeyVal"/>
                  <para name="Len"    value="8"/>
                  <para name="Circle" value="1"/>
                </do>
                <if condition="#RetCod!=0">
                  <set name="RspCod"    value="9001"/>
                  <set name="RspMsg"    value="生产序列号错误，请重新提交。"/>
                  <set name="DWZ_STATUS_CODE" value="300"/>
                  <set name="DWZ_RSP_MSG" expr="RSPMSG"/>
                  <return/>
                </if>
                <set name="ID"           expr="STRCAT(GETDATETIME('YYMMDD'),KeyVal)"/>
                
                <set name="CRED_PIC"     expr="fileupload1"/>
                <set name="ORG_PIC"      expr="fileupload2"/>
                <set name="LAW_PIC1"     expr="fileupload3"/>
                <set name="LAW_PIC2"     expr="fileupload4"/>
                <set name="AUT_STS"      value="3" /><!--认证状态 0 未认证 1 认证通过 2 认证拒绝 3认证中-->
                
                <!--入库商户信息审核表-->
                <do func="InsertRecord" error="IGNORE">
                   <para name="TblNam"  value="STPMERAUTINF" />
                </do>
                <if condition="#RetCod!=0">
                   <set name="MsgTyp"    value="E"/>
                   <set name="RspCod"    value="09999"/>
                   <set name="RspMsg"    value="系统错误"/>
                   <set name="DWZ_STATUS_CODE"   value="300"/>
                   <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
                   <return/>
                </if>
            </if>
            <else> <!--未上传证件照片暂不认证-->
                <!--验证身份认证信息是否输入为空-->
                <quote name="MerVeifyupd"/>
                
                <!--3des加密营业执照号和法人证件号-->
                <set name="MER_BUSREGNUM"         expr="DES_ENCRYPT(MER_BUSREGNUM)"  />
                <set name="LAW_PERSON_CRET_NO"    expr="DES_ENCRYPT(LAW_PERSON_CRET_NO)"  />
                <set name="LAW_PERSON_CRET_TYPE"  value="0"/>
                
                <set name="CRED_PIC"     expr="FILENAME1S"/>
                <set name="ORG_PIC"      expr="FILENAME2S"/>
                <set name="LAW_PIC1"     expr="FILENAME3S"/>
                <set name="LAW_PIC2"     expr="FILENAME4S"/>
                <set name="AUT_STS"      value="0" /><!--认证状态 0 未认证 1 认证通过 2 认证拒绝 3认证中-->
            </else>
            
            <!-- 修改商户信息 -->
            <do func="UpdateRecord" error="IGNORE">
               <para name="TblNam" value="STPMERINF"/>
               <para name="CndSts" sql="UpdMerInf"/>
            </do>
            <if condition="#RetCod==2">
               <set name="RspCod"    value="01003"/>
               <set name="RspMsg"    value="无该商户信息"/>
               <do func="RollBackWork"/>
               <return/>
            </if>
            <elseif condition="#RetCod!=0">
               <set name="RspCod"    value="06003"/>
               <set name="RspMsg"    value="系统错误，请联系管理员"/>
               <return/>
            </elseif>
             
             <!--更新商户客户营业执照号-->
             <do func="ExecSql" error="IGNORE">
               <para name="SqlCmd" sql="UpdCustMer"/>
             </do>
             <if condition="#RetCod!=0">
               <set name="RspCod"    value="02103"/>
               <set name="RspMsg"    value="修改营业执照号失败!"/>
               <return/>
             </if>
             
            <!--风控操作类型1新增，2修改-->
            <set name="DTYPE"       value="2"/>
            <set name="DTYPE"                              expr="DTYPE"/>
            <set name="CCODE"                              expr="MERID"/>
            <set name="PCAD"                               expr="STRCAT(MERID,'02')"/>
            <set name="CNAME"                              expr="COMPANY_BRIEF"/>
            <set name="CDATE"                              expr="CONTRACT_STR_DATE"/>
            <set name="MDATE"                              expr="CONTRACT_END_DATE"/>
            <set name="DATE"                               expr="nowDate"/>
            <set name="TIME"                               expr="nowTime"/>
            <set name="sthCode"                            value="540505"/>
            <quote name="rcsMaro"/>
            
            <set name="SESSIONS.BUSNAME"     expr="COMPANY_BRIEF" />
            <set name="SESSIONS.AUT_STS"     expr="AUT_STS" />
            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
            
        </process>
    </transaction>
    
    <transaction code="merBalance" desc="查询商户余额">
        <sql name="SelMerAccInf"> <!-- 查询商户余额   -->
            select a.pay_ac_no,b.AC_STATUS,
            to_char(to_number(b.cash_ac_bal-b.froz_balance)/100,'999999999990.00') as cash_ac_bal,
            to_char(to_number(b.froz_balance)/100,'999999999990.00') as froz_balance 
            from arp_ac_cust_rel a, arp_ac_profile b 
            where a.pay_ac_no=b.pay_ac_no and a.cust_id=#{CUSTNO} and  b.ac_type=#{actype} 
        </sql>
        <sql name="qryMerInf">
           select m.CUST_ID, m.COMPANY_BRIEF,AUT_STS,  MER_TYPE
              from STPMERINF m   where  m.cust_id=#{CUSTNO}
         </sql>
        <sql name="qryMerStlInf">
              select to_char(to_number(nvl(sum(nvl(tot_ord_amt,0)),0))/100,'999999999990.00') HISTORYSUMTOAL,count(*) TRANSCOUNT
                from arp_bank_pay_stl 
               where pay_stl_status='2' and mer_no=#{CUSTNO}
        </sql>
        <process>
            <if condition="IS_NOEQUAL_STRING(SysCod,'2201')">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="01001"/>
                <set name="RspMsg"    value="商户登录平台不正确"/>
                <return/>
            </if>
            <!--商户信息查询 -->  
            <set name="CUSTNO"    expr="SESSIONS.MERID" />
            
            <!--商户信息查询 -->    
            <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd"       sql="qryMerInf"/> 
            </do>
            <if condition="OR(#RetCod==1,#RetCod==10)">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09000"/>
               <set name="RspMsg"    value="通知超时"/>
               <return/>
            </if>
            <elseif condition="#RetCod!=0">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09999"/>
               <set name="RspMsg"    value="系统错误,清稍后再试！"/>
               <return/>    
            </elseif> 
            
            <set name="actype"       value="02"/>
            <quote name="merChkAcc"/>
            <set name="DAYSUMTOAL"   expr="cash_ac_bal"/>
            
            <set name="actype"       value="01"/>
            <quote name="merChkAcc"/>
            
            <!--历史结算总金额查询 -->    
            <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd"   sql="qryMerStlInf"/> 
            </do>
            <if condition="#RetCod!=0">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09999"/>
               <set name="RspMsg"    value="系统错误,清稍后再试！"/>
               <return/>    
            </if> 
            <set name="HISTORYSUMTOAL" expr="HISTORYSUMTOAL"/>
            <set name="TRANSCOUNT"     expr="TRANSCOUNT"/>
            
        </process>
    </transaction>
    
    <transaction code="merchantInfoQuery" desc="商户信息显示"> 
      <sql name="qryMerInf">
       select c.CUST_CRED_NO,a.remark,a.aut_status,m.*
          from STPCUSINF c,STPMERINF m  left join stpmerautinf a on a.cust_id=m.cust_id 
          where c.cust_id=m.cust_id and m.cust_id=#{MERID}
     </sql>
     <sql name="QryCitys2">
           SELECT CITYID,CITY FROM STPCITYTB WHERE FATHERID =#{BANK_PRO_ID}
     </sql>
      <sql name="QryCnaps">       <!--  查询单条结算开户行的信息  -->
           SELECT bank_city_id,bank_pro_id,CNAPS_CODE,bank_name,sub_branch FROM  CNAPS where 1=1 AND  CNAPS_CODE=#{BANK_REL_NO}
      </sql>
      <sql name="QryCnapsList">       <!--  查询所有的信息  -->
           SELECT  bank_name  FROM  CNAPS where 1=1 
           AND  bank_city_id=#{bank_city_id} and bank_pro_id=#{bank_pro_id} 
           group by bank_name
      </sql>
      <sql name="QrycodeList">       <!--  查询所有的信息  -->
           SELECT  max(sub_branch) sub_branch,CNAPS_CODE  FROM  CNAPS where 1=1 
           AND  bank_city_id=#{bank_city_id} and bank_pro_id=#{bank_pro_id} 
           group by CNAPS_CODE
      </sql>
     <process>
         <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/account/merchantinfo.jsp')" />
         <!--检查商户登录平台是否正确-->
         <!--if condition="IS_NOEQUAL_STRING(SysCod,'2201')">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="01001"/>
           <set name="RspMsg"    value="商户登录平台不正确"/>
           <return/>
         </if-->
         <set name="MERID"           expr="SESSIONS.MERID"/>
         <!--商户信息查询 -->    
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd"       sql="qryMerInf"/> 
         </do>
         <if condition="OR(#RetCod==1,#RetCod==10)">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="09000"/>
           <set name="RspMsg"    value="通知超时"/>
           <return/>
         </if>
         <elseif condition="#RetCod!=0">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="09999"/>
           <set name="RspMsg"    value="系统错误,清稍后再试！"/>
           <return/>    
         </elseif> 
         
         <!-- 省市 -->
         <!--if condition="IS_NOEQUAL_STRING(city,'')">
            <set name="proinfo"          expr="GETWORDDELIMITER(city,':',1)"/>
            <set name="proId"            expr="GETWORDDELIMITER(proinfo,',',1)"/>
            <set name="proNam"           expr="GETWORDDELIMITER(proinfo,',',2)"/>
            <set name="cityinfo"         expr="GETWORDDELIMITER(city,':',2)"/>
            <set name="cityId"           expr="GETWORDDELIMITER(cityinfo,',',1)"/>
            <set name="cityNam"          expr="GETWORDDELIMITER(cityinfo,',',2)"/>
         </if>
         <else>
             <set name="proid"   value="110000"/>
         </else>
         <do func="SelPro"                          error="IGNORE"/>
         <do func="SelCity"                         error="IGNORE">
            <para name="PROID"                     expr="PROID"/>
         </do>
         <do func="ReadRecord"                       error="IGNORE">
           <para name="SqlCmd"                       sql="QryCnaps"/>
         </do>
         <set name="BANK_PRO_ID"  expr="bank_pro_id"/>
         <set name="BANK_CITY_ID" expr="bank_city_id"/>
         <if condition="OR(ISNULL(BANK_PRO_ID),IS_EQUAL_STRING(BANK_PRO_ID,''))">
             <set name="BANK_PRO_ID"   value="110000"/>
         </if>
         <do func="QueryInGroup" error="IGNORE">
            <para name="SqlCmd"                    sql="QryCitys2" />
            <para name="RecordName"                value="CITYS2"/>
         </do>
         
         <do func="QueryInGroup" error="IGNORE">
          <para name="SqlCmd"  sql="QryCnapsList"/>
          <para name="RecordName"    value="GRPCNAPS"/>
         </do>
         <do func="QueryInGroup" error="IGNORE">
          <para name="SqlCmd"  sql="QrycodeList"/>
          <para name="RecordName"    value="GRPCODE"/>
         </do-->
         
         <!--解密证件号码-->
         <set name="LAW_PERSON_CRET_NO"        expr="DES_DECRYPT(LAW_PERSON_CRET_NO)"/>
         <set name="CUST_CRED_NO"              expr="DES_DECRYPT(CUST_CRED_NO)"/>
         
         <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/account/merchantinfo.jsp')" />
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
    </process>
    </transaction>
    
    <transaction code="merAccountInfo" desc="商户账户首页信息">
     <process>
       <!-- 检查用户登录平台是否正确  -->
       <!--if condition="IS_NOEQUAL_STRING(SysCod,'2201')">
         <set name="MsgTyp"    value="E"/>
         <set name="RspCod"    value="01001"/>
         <set name="RspMsg"    value="用户登录平台不正确"/>
         <return/>
       </if-->
       <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/account/accounthome.jsp')" />
       <set name="MsgTyp"       value="N"/>
       <set name="RspCod"       value="00000"/>
       <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
    <transaction code="Uploading" desc="图片上传">
        <sql name="UpdMerAut"> <!-- 修改商户审核信息 -->
            UPDATE STPMERINF SET COMPAY_TEL_NO=#{COMPAY_TEL_NO},AUT_STS=#{AUT_STS},
            COMPAY_EMAIL=#{MEREMAIL},CUST_STL_BANK_AC_NO=#{CUST_STL_BANK_AC_NO},
            BANK_REL_NO=#{BANK_REL_NO}, LAW_PERSON_CRET_TYPE='0',
            ORGANIZATION_NO=#{ORGANIZATION_NO},LAW_PERSON_CRET_NO=#{LAW_PERSON_CRET_NO},
            TAX_REGISTRATION_NO=#{TAX_REGISTRATION_NO},DEPOSIT_BANK_BRCH_NAME=#{DEPOSIT_BANK_BRCH_NAME},
            MER_LAW_PERSON=#{MER_LAW_PERSON}, CUST_BANK_DEPOSIT_NAME=#{CUST_BANK_DEPOSIT_NAME}, 
            CRED_PIC=#{FILENAME1},ORG_PIC=#{FILENAME2},
            LAW_PIC1=#{FILENAME3},LAW_PIC2=#{FILENAME4} WHERE CUST_ID=#{MERID}
        </sql>
        <sql name="QryMerInfo"> <!-- 账号检测 -->
            select login_name,login_pwd,mer_type,cust_id,compay_email,COMPANY_BRIEF,AUT_STS OLD_AUT_STS
            from stpmerinf where cust_id=#{MERID} 
        </sql>
        <sql name="QryMerInfoMore"> <!-- 查询商户信息 -->
            select * from stpmerinf where cust_id=#{MERID} 
        </sql>
        <sql name="UpdCustMer"> <!-- 修改客户信息 -->
            update stpcusinf set cust_cred_type='9',cust_cred_no=#{MER_BUSREGNUM} where CUST_ID=#{MERID}
        </sql>
        <sql name="UpdMerInf"> <!-- 修改商户信息 -->
            CUST_ID=#{MERID}
        </sql>
        <sql name="UpdMerAutInf"> <!-- 修改商户审核信息 -->
            UPDATE STPMERAUTINF SET CRED_PIC=#{CRED_PIC},AUT_STS=#{AUT_STS},
            ORG_PIC=#{ORG_PIC},LAW_PIC1=#{LAW_PIC1},
            LAW_PIC2=#{LAW_PIC2}  WHERE CUST_ID=#{MERID}
        </sql>
        <process>
            <set name="MERID"        expr="SESSIONS.MERID"/>
            <set name="MEREMAIL"     expr="SESSIONS.USERID"/>
            
            <set name="FILESTATUS1"   expr="GETUPLOADFILESTATUS()" />
            <set name="UPLOADMESSAGE" expr="FILESTATUS1" />
            <set name="PAGEFLAG"      expr="GETREQUESTATTR('PAGEFLAG')" />
            <set name="UPLOADMESSAGE" expr="STRCAT(UPLOADMESSAGE,',',PAGEFLAG)" />
            <if condition="IS_NOEQUAL_STRING(FILESTATUS1,'S')">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02106" />
                <set name="RspMsg" value="上传失败" />
                <return />
            </if>
            <set name="MERID"         expr="GETREQUESTATTR('MERID')" />
            
            <!--得到营业执照图片 -->
            <set name="FILEPATH1" expr="GETUPLOADFILEPATH('FILEUPLOAD1')" />
            <set name="FILENAME1" expr="GETUPLOADFILENAME('FILEUPLOAD1')" />
            
            <!--得到组织机构图片 -->
            <set name="FILEPATH2" expr="GETUPLOADFILEPATH('FILEUPLOAD2')" />
            <set name="FILENAME2" expr="GETUPLOADFILENAME('FILEUPLOAD2')" />
            
            <!--得到证件正面图片 -->
            <set name="FILEPATH3" expr="GETUPLOADFILEPATH('FILEUPLOAD3')" />
            <set name="FILENAME3" expr="GETUPLOADFILENAME('FILEUPLOAD3')" />
            
            <!--得到证件反面图片 -->
            <set name="FILEPATH4" expr="GETUPLOADFILEPATH('FILEUPLOAD4')" />
            <set name="FILENAME4" expr="GETUPLOADFILENAME('FILEUPLOAD4')" />
            
            <set name="ConfigName" value="FtpGetToPay" />
            <quote name="ReadXmlCfg" />
            
            <!--将图片存到服务器上-->  
            <set name="PATH"  expr="GETREQUESTATTR('PATH')"/>  
            <do func="MoveFile">
              <para name="srcDir" expr="STRCAT(PATH,ObjDir)"/>  <!--目前对象路径-->
              <para name="srcFil" expr="STRCAT(FILENAME1,',',FILENAME2,',',FILENAME3,',',FILENAME4)"/>  
              <para name="tarDir" expr="STRCAT(WebPath,LclDir)"/>  <!--目标路径-->
            </do>
            <if condition="#RetCod!=0"> 
                <!--调用FtpGet方法将图片存到ftp服务器上-->  
                <set name="RspCod" value="01007"/>  
                <set name="RspMsg" value="移动文件失败!"/>  
                <set name="UPLOADMESSAGE" value="F"/>  
                <return/>
            </if>
            
            <set name="UPLOADMESSAGE" expr="STRCAT(UPLOADMESSAGE,',',FILENAME1,',',FILENAME2,',',FILENAME3,',',FILENAME4)" />
            
            <do func="ReadRecord"    error="IGNORE">
               <para name="SqlCmd"   sql="QryMerInfo" />
            </do>
            <if condition="#RetCod==2">
               <set name="MsgTyp"        value="E"/>
               <set name="RspCod"        value="02008"/>
               <set name="RspMsg"        value="该商户不存在！"/>
               <set name="UPLOADMESSAGE" value="A"/>  
               <return/>
            </if>
            <if condition="IS_EQUAL_STRING(OLD_AUT_STS,3)">
               <set name="MsgTyp"        value="E"/>
               <set name="RspCod"        value="02099"/>
               <set name="RspMsg"        value="该商户认证中！"/>
               <set name="UPLOADMESSAGE" value="A"/>  
               <return/>
            </if>
            <elseif condition="IS_EQUAL_STRING(OLD_AUT_STS,1)">
               <set name="MsgTyp"        value="E"/>
               <set name="RspCod"        value="02098"/>
               <set name="RspMsg"        value="该商户已认证通过！"/>
               <set name="UPLOADMESSAGE" value="A"/>  
               <return/>
            </elseif>
            
            <!-- 操作员  -->
            <set name="admin"         value="ADMIN"/> 
            <set name="OPEN_NAME"     expr="admin"/> 
            <!-- 当前日期  -->
            <set name="OPEN_DATE"     expr="GETDATE()"/>
            <!-- 复核参数 -->
            <set name="AUT_STATUS"      value="0"/><!--审核状态 0 未审核 1 审核不通过 2 审核通过-->
            <set name="AUT_TYPE"        value="2"/><!--审核类型 1 商户开户 2 商户修改-->
            <set name="AUT_STS"         value="0" /><!--认证状态 0 未认证 1 认证通过 2 认证拒绝 3认证中-->
            
            <!--跳过实名认证标志 1-跳过实名认证 其他-不跳过实名认证-->
            <if condition="IS_NOEQUAL_STRING(PASNOW,'1')">
               <!-- 商户登录后分步认证标志 3-分步认证 其他-邮箱链接一步认证 -->
               <if condition="IS_EQUAL_STRING(upflag,'3')"> <!-- 分步认证 最后这步只上传证件照片信息 -->
                  <do func="ReadRecord"    error="IGNORE">
                     <para name="SqlCmd"   sql="QryMerInfoMore" />
                  </do>
                  <if condition="#RetCod==2">
                     <set name="MsgTyp"        value="E"/>
                     <set name="RspCod"        value="02008"/>
                     <set name="RspMsg"        value="该商户不存在！"/>
                     <set name="UPLOADMESSAGE" value="A"/>
                     <return/>
                  </if>
               </if>
               <else>
                  <quote name="meruploadingveify"/>
                  
                  <!--3des加密营业执照号和法人证件号-->
                  <set name="MER_BUSREGNUM"         expr="DES_ENCRYPT(MER_BUSREGNUM)"/>
                  <set name="LAW_PERSON_CRET_NO"    expr="DES_ENCRYPT(LAW_PERSON_CRET_NO)"/>
               </else>
               
               <set name="AUT_STS"  value="3" /><!--认证状态 0 未认证 1 认证通过 2 认证拒绝 3认证中-->
               
               <set name="CRED_PIC"     expr="FILENAME1"/>
               <set name="ORG_PIC"      expr="FILENAME2"/>
               <set name="LAW_PIC1"     expr="FILENAME3"/>
               <set name="LAW_PIC2"     expr="FILENAME4"/>
               
               <!-- 获取序列编号 -->
               <do func="GetSeqNo"  error="IGNORE">
                 <para name="TblNam" value="stpseqrec"/>
                 <para name="KeyNam" value="KeyNam"/>
                 <para name="KeyVal" value="STPMERAUTINF_ID"/>
                 <para name="SeqNam" value="KeyVal"/>
                 <para name="Len"    value="8"/>
                 <para name="Circle" value="1"/>
               </do>
               <if condition="#RetCod!=0">
                 <set name="RspCod"    value="9001"/>
                 <set name="RspMsg"    value="生产序列号错误，请重新提交。"/>
                 <set name="DWZ_STATUS_CODE" value="300"/>
                 <set name="DWZ_RSP_MSG" expr="RSPMSG"/>
                 <return/>
               </if>
               <set name="ID" expr="STRCAT(GETDATETIME('YYMMDD'),KeyVal)"/>
               
               <!--入库商户信息审核表-->
               <do func="InsertRecord" error="IGNORE">
                  <para name="TblNam"  value="STPMERAUTINF" />
               </do>
               <if condition="#RetCod!=0">
                  <set name="MsgTyp"    value="E"/>
                  <set name="RspCod"    value="09999"/>
                  <set name="RspMsg"    value="系统错误"/>
                  <set name="DWZ_STATUS_CODE"   value="300"/>
                  <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
                  <return/>
               </if>
            </if>
            
            <!-- 修改商户信息 -->
            <do func="UpdateRecord" error="IGNORE">
               <para name="TblNam" value="STPMERINF"/>
               <para name="CndSts" sql="UpdMerInf"/>
            </do>
            <if condition="#RetCod==2">
               <set name="RspCod"    value="01003"/>
               <set name="RspMsg"    value="无该商户信息"/>
               <set name="UPLOADMESSAGE" value="A"/>  
               <do func="RollBackWork"/>
               <return/>
            </if>
            <elseif condition="#RetCod!=0">
               <set name="RspCod"    value="06003"/>
               <set name="RspMsg"    value="系统错误，请联系管理员"/>
               <return/>
            </elseif>
            
            <!--更新商户客户营业执照号-->
            <do func="ExecSql" error="IGNORE">
              <para name="SqlCmd" sql="UpdCustMer"/>
            </do>
            <if condition="#RetCod!=0">
              <set name="RspCod"    value="02103"/>
              <set name="RspMsg"    value="修改营业执照号失败!"/>
              <set name="UPLOADMESSAGE" value="A"/>  
              <return/>
            </if>
            
            <!--风控操作类型1新增，2修改-->
            <set name="DTYPE"       value="2"/>
            <set name="DTYPE"                              expr="DTYPE"/>
            <set name="CCODE"                              expr="MERID"/>
            <set name="PCAD"                               expr="STRCAT(MERID,'02')"/>
            <set name="CNAME"                              expr="COMPANY_BRIEF"/>
            <set name="CDATE"                              expr="CONTRACT_STR_DATE"/>
            <set name="MDATE"                              expr="CONTRACT_END_DATE"/>
            <set name="DATE"                               expr="nowDate"/>
            <set name="TIME"                               expr="nowTime"/>
            <set name="sthCode"                            value="540505"/>
            <quote name="rcsMaro"/>
            
            <set name="SESSIONS.AUT_STS"     expr="AUT_STS" />
            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
            
            <set name="UPLOADMESSAGE" expr="STRCAT(UPLOADMESSAGE,',',RspCod)" />
            
        </process>
    </transaction>
    
    <transaction code="allProd"             desc="产品大全查询">
       <sql name="qryProdInf">
          select prod_code,prod_name,prod_class,prod_type from stpproinf where prod_flag='0' order by last_upd_date,last_upd_time
       </sql>
       <sql name="qryProdClassInf">
          select distinct prod_class from stpproinf where prod_flag='0' order by prod_class
       </sql>
       <process>
         <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/product/allProduct.jsp')" />
         
         <do func="QueryInGroup" error="IGNORE">
            <para name="SqlCmd"     sql="qryProdInf"/>
            <para name="RecordName" value="PROD"/>
            <para name="RecNum"     value="RECNUM"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if>
         
         <do func="QueryInGroup" error="IGNORE">
            <para name="SqlCmd"     sql="qryProdClassInf"/>
            <para name="RecordName" value="CLASS"/>
            <para name="RecNum"     value="CLSNUM"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if>
         
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
       </process>
    </transaction>
    
    <transaction code="prodDetailForward"   desc="产品详情页面跳转">
       <sql name="qryPkgInf">
         select pkg_name,case when pkg_type='0' then '单笔阶梯费率' else '包量套餐' end pkg_type,pkg_type pkg_type1,
                TO_CHAR(to_number(pre_amt)/100,'FM9999,999,999,990.00') as pre_amt,fee_code,
                TO_CHAR(to_number(txn_flow)/100,'FM9999,999,999,990.00') as txn_flow,serv_period
           from STPPKGINF 
          where prod_code=#{prdCod}
       </sql>
       <process>
         
         <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/product/product_',prdNam,'.jsp')" />
         
         <set name="prdCod"   expr="prdCod"/>
         <!--查询产品关联的套餐信息-->
         <do func="QueryInGroup" error="IGNORE">
           <para name="SqlCmd"     sql="qryPkgInf" />
           <para name="RecordName" value="PKG_LST" />
         </do>
         <if condition="#RetCod==2">
           <set name="RSPCOD" value="01002" />
           <set name="RSPMSG" value="没有套餐信息!" />
           <set name="COUNT"  value="0" />
           <return />
         </if>
         <elseif condition="#RetCod!=0">
           <set name="RSPCOD" value="09999" />
           <set name="RSPMSG" value="系统错误" />
           <return />
         </elseif>
         
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
       </process>
    </transaction>
    
    <transaction code="prodSignForward"     desc="签约页面跳转">
       <sql name="qryPkgInf">
         select   biz_type 
           from STPMERSIG  where sign_sts='1'  and mer_no=#{mer_no} group  by   biz_type  
       </sql>
       <process>
         <if condition="IS_EQUAL_STRING(PDflag,'1')"> 
             <set name="mer_no"    expr="mer_no"/>
         </if>
         <else>
           <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/product/sign_',prdNam,'.jsp')" />
	         <set name="mer_no"                expr="SESSIONS.MERID"/>
         </else>
         <set name="pkgflag"             value="1"/><!--1 有签约数据 2 没有签约数据-->
         <do func="ReadRecord"             error="IGNORE">
           <para name="SqlCmd"             sql="qryPkgInf"/>
         </do>
         <if condition="#RetCod==2">
           <set name="RSPCOD"              value="01002"/>
           <set name="RSPMSG"              value="未签约产品!"/>
           <set name="pkgflag"             value="2"/>
         </if>
         <elseif condition="#RetCod!=0">
           <set name="RSPCOD"              value="09999"/>
           <set name="RSPMSG"              value="系统错误"/>
           <return/>
         </elseif>
         
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
       </process>
    </transaction>  
    
    <transaction code="merProSign"          desc="商户签约">
       <sql name="selMerProInf">
         select sign_code,prod_code,pack_code,VAL_DATE,EXP_DATE from STPMERSIG where prod_code=#{prod_code} and mer_no=#{mer_no}
       </sql>
       <sql name="selProPkgInf">
         select a.prod_code,a.pkg_name pack_name,b.prod_name,a.fee_code,a.serv_period 
           from STPPKGINF a,STPPROINF b 
          where a.prod_code=b.prod_code and a.pkg_code=#{pack_code} and b.prod_flag='0'
       </sql>
       <process>
        
         <!--检查产品套餐信息是否存在-->
         <do func="ReadRecord"             error="IGNORE">
           <para name="SqlCmd"             sql="selProPkgInf"/>
         </do>
         <if condition="#RetCod==2">
           <set name="RSPCOD"              value="01002"/>
           <set name="RSPMSG"              value="此产品套餐不存在!"/>
           <return/>
         </if>
         <elseif condition="#RetCod!=0">
           <set name="RSPCOD"              value="09999"/>
           <set name="RSPMSG"              value="系统错误"/>
           <return/>
         </elseif>
         
         <!--检查商户是否已签约此产品套餐-->
         <do func="ReadRecord"             error="IGNORE">
           <para name="SqlCmd"             sql="selMerProInf"/>
         </do>
         <if condition="#RetCod==0">
           <set name="DATE"                expr="GETDATE()"/>
           <if condition="AND(NOT(ISNULL(VAL_DATE)),NOT(ISNULL(EXP_DATE)))">
              <if condition="AND(INTCMP(DATE,5,VAL_DATE),INTCMP(DATE,2,EXP_DATE))">
                 <set name="RSPCOD"              value="32001"/>
                 <set name="RSPMSG"              value="此产品已经签约，不能重复签约!"/>
                 <return/>  
              </if>
           </if>
           <else>
              <set name="RSPCOD"              value="32001"/>
              <set name="RSPMSG"              value="此产品已经提交申请，不能重复提交!"/>
              <return/>  
           </else>
         </if>
         <elseif condition="#RetCod!=2">
           <set name="RSPCOD"              value="09999"/>
           <set name="RSPMSG"              value="系统错误"/>
           <return/>
         </elseif>
         
         <!--获取序号--> 
         <do func="GetSeqNo"  error="IGNORE">
           <para name="TblNam" value="stpseqrec"/>
           <para name="KeyNam" value="KeyNam"/>
           <para name="KeyVal" value="STPMERSIG_SIGN_CODE"/>
           <para name="SeqNam" value="KeyVal"/>
           <para name="Len"    value="4"/>
           <para name="Circle" value="1"/>
         </do>
         <if condition="#RetCod!=0">
           <set name="RspCod"          value="09001"/>
           <set name="RspMsg"          value="生成序列号错误"/>
           <set name="DWZ_STATUS_CODE" value="300"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
         </if> 
         
         <!--登记签约信息-->
         <set name="sign_code"    expr="STRCAT('S',biz_type,'-',SUBSTR(GETDATE(),3,6),'-',KeyVal)"/>
         <set name="mer_no"       expr="mer_no"/>         <!--商户号--> 
         <set name="biz_type"     expr="biz_type"/>       <!--行业类别--> 
         <set name="web_addr"     expr="web_addr"/>       <!--网址--> 
         <set name="real_name"    expr="real_name"/>      <!--真实姓名--> 
         <set name="phone"        expr="phone"/>          <!--联系电话--> 
         <set name="mail_addr"    expr="mail_addr"/>      <!--电子邮箱--> 
         <set name="cons_addr"    expr="cons_addr"/>      <!--联系地址--> 
         <!--set name="VAL_DATE"     expr="GETDATE()"/-->      <!--生效日期--> 
         <!--set name="EXP_DATE"     expr="CALCDATE(CALCDATE(VAL_DATE,'+','m',serv_period),'-','d','1')"/--> <!--失效日期--> 
         <set name="sign_sts"     value="0"/>             <!--审核状态--> 
         <set name="apply_time"   expr="GETDATETIME()"/>
         <do func="InsertRecord">
            <para name="TblNam"  value="STPMERSIG" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if> 
         
         <set name="zhCn"         expr="SESSIONS.LANGUAGE"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
       </process>
    </transaction>
    

    <transaction code="sigMng"              desc="商户签约信息查询">
       <sql name="selMerInf">
         select distinct a.biz_type,b.Enm_Dat_Des biz_nam,web_addr,real_name,phone,mail_addr,cons_addr
           from STPMERSIG a,lyxdicenm b
          where mer_no=#{mer_no} and a.biz_type=b.Enm_Dat_Opt and Enm_En_Nam='biz_type' and real_name is not null and phone is not null
       </sql>
       <sql name="qryMerProInf">
         select sign_code,TO_CHAR(to_date(a.apply_time,'yyyyMMdd hh24miss'),'yyyy-MM-dd hh24:mi:ss') apply_time,
                a.prod_code,a.pack_name pack_name,a.prod_name,a.fee_code,
                TO_CHAR(to_date(a.aut_time,'yyyyMMdd hh24miss'),'yyyy-MM-dd hh24:mi:ss') aut_time,
                case when a.sign_sts='0' then '等待审核' when a.sign_sts='1' then '签约成功' else '审核未通过' end signsts ,a.sign_sts,a.refud_reson
           from STPMERSIG a
          where a.mer_no=#{mer_no} 
       </sql>
       <process>
         <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/product/sign_manage.jsp')" />
         <set name="mer_no"                expr="SESSIONS.MERID"/>
         
         <!--检查商户是否已签约-->
         <do func="ReadRecord"             error="IGNORE">
           <para name="SqlCmd"             sql="selMerInf"/>
         </do>
         <if condition="#RetCod==2">
           <set name="RSPCOD"              value="01002"/>
           <set name="RSPMSG"              value="商户未进行签约!"/>
           <return/>
         </if>
         <elseif condition="#RetCod!=0">
           <set name="RSPCOD"              value="09999"/>
           <set name="RSPMSG"              value="系统错误"/>
           <return/>
         </elseif>
         
         <if condition="ISNULL(PageNum)">
           <set name="PageNum"             value="1"/>
         </if>
         <if condition="ISNULL(NumPerPag)">
           <set name="NumPerPag"           value="19"/>
         </if>
         <do func="PagedQuery"             error="IGNORE">
           <para name="PageNum"            expr="PageNum"/>
           <para name="NumPerPag"          expr="NumPerPag"/>
           <para name="sql"                sql="qryMerProInf"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if>        
         
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
       </process>
    </transaction>
    
    <transaction code="merSigDetail"        desc="商户签约详情查询">
      <sql name="selMerSignInf">
        select a.sign_code,a.prod_name,a.pack_name,TO_CHAR(to_number(b.pre_amt)/100,'FM9999,999,999,990.00') pre_amt,
               TO_CHAR(to_date(a.apply_time,'yyyyMMdd hh24miss'),'yyyy-MM-dd hh24:mi:ss') apply_time,a.biz_type,c.Enm_Dat_Des biz_nam,
               To_Char(to_date(VAL_DATE,'yyyymmdd'),'yyyy-mm-dd') VAL_DATE,
               To_Char(to_date(EXP_DATE,'yyyymmdd'),'yyyy-mm-dd') EXP_DATE,sign_sts sign_sts1 ,refud_reson,
               case when a.sign_sts='0' then '等待审核' when a.sign_sts='1' then '签约成功' else '审核未通过' end sign_sts
          from STPMERSIG a,STPPKGINF b,lyxdicenm c
         where a.biz_type=c.Enm_Dat_Opt and c.Enm_En_Nam='biz_type' and a.pack_code=b.pkg_code and sign_code=#{sign_code}
      </sql>
      <process>
        <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/product/sign_detail.jsp')" />
        <do func="ReadRecord" error="IGNORE">
          <para name="SqlCmd" sql="selMerSignInf" />
        </do>
        <if condition="#RetCod==2">
          <set name="RSPCOD"   value="01002" />
          <set name="RSPMSG"   value="商户无签约信息" />
          <return />
        </if>
        <elseif condition="#RetCod!=0">
          <set name="RSPCOD"   value="09999" />
          <set name="RSPMSG"   value="系统错误" />
          <return />
        </elseif>
        
        <set name="zhCn"      expr="SESSIONS.LANGUAGE"/>
        <set name="RspCod"    value="00000"/>
        <set name="RspMsg"    value="交易成功"/>
      </process>
    </transaction>
    
    <transaction code="signEdit"            desc="商户签约信息修改-查询">
       <sql name="selMerInf">
         select distinct a.biz_type,b.Enm_Dat_Des biz_nam,web_addr,real_name,phone,mail_addr,cons_addr,pack_code,sign_code
           from STPMERSIG a,lyxdicenm b
          where SIGN_CODE=#{SIGN_CODE} and a.biz_type=b.Enm_Dat_Opt and Enm_En_Nam='biz_type'
       </sql>
       <process>
         <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/product/sign_edit.jsp')" />
         <set name="mer_no"                expr="SESSIONS.MERID"/>
         
         <!--检查商户是否已签约-->
         <do func="ReadRecord"             error="IGNORE">
           <para name="SqlCmd"             sql="selMerInf"/>
         </do>
         <if condition="#RetCod==2">
           <set name="RSPCOD"              value="01002"/>
           <set name="RSPMSG"              value="商户未进行签约!"/>
           <return/>
         </if>
         <elseif condition="#RetCod!=0">
           <set name="RSPCOD"              value="09999"/>
           <set name="RSPMSG"              value="系统错误"/>
           <return/>
         </elseif>
         
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
       </process>
    </transaction>
    
    <transaction code="merProSignEdit"      desc="商户签约修改">
       <sql name="updMerPro">
         update STPMERSIG set web_addr=#{web_addr},BIZ_TYPE=#{BIZ_TYPE},real_name=#{real_name},phone=#{phone},mail_addr=#{mail_addr},cons_addr=#{cons_addr},sign_sts='0'
          where sign_code=#{sign_code}
       </sql>
       <process>
          
         <set name="web_addr"     expr="web_addr"/>       <!--网址--> 
         <set name="real_name"    expr="real_name"/>      <!--真实姓名--> 
         <set name="phone"        expr="phone"/>          <!--联系电话--> 
         <set name="mail_addr"    expr="mail_addr"/>      <!--电子邮箱--> 
         <set name="cons_addr"    expr="cons_addr"/>      <!--联系地址--> 
         <do func="ExecSql">
            <para name="SqlCmd" sql="updMerPro"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if> 
         
         <set name="zhCn"         expr="SESSIONS.LANGUAGE"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
       </process>
    </transaction>
    
    <transaction code="exportTranRecord" desc="导出线上交易记录">
       <sql name="QMerTotalOrdInfo">
         select count(*) as TOTALRECNUMS,TO_CHAR(to_number(nvl(sum(ordAmt),0))/100,'FM9999,999,999,990.00') TOTALPRDAMT 
         from StpPrdInf b where  b.merno=#{merid} and b.OrdStatus='01' ${ordprdOrdNo} ${ordprdName} ${orderDate} ${prdordamt} 
       </sql>
       <sql name="QMerOrdInfoAll">    <!-- 查询所有的交易记录  商品订单左连接支付订单 -->
         select distinct(case when b.OrdStatus in ('01','12') then ('01'||c.actdat||b.prdordno) else ('00'||b.orderTime||b.prdordno) end) as seqno,
                b.biztype,b.merNo,b.cust_id as userID,b.prdOrdNo,b.PRDORDTYPE,
                TO_CHAR(to_number(nvl(b.ordAmt,0))/100,'FM9999,999,999,990.00') as ordamt,
                case when  b.ordertime != ' ' then To_Char(to_date(b.orderTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end orderTime,
                case when  b.ORDSTATUS = '00' then '未支付'  when  b.ORDSTATUS = '01' then '交易成功'  when  b.ORDSTATUS = '11' then '订单作废' when  b.ORDSTATUS = '12' then '支付成功 ' else '未知' end ORDSTATUS, 
                nvl(b.prdName,' ') as prdName,nvl(b.ordAmt,0) ordtotalAmt,
                CASE when b.PRDORDTYPE='1' then '4' when b.PRDORDTYPE='0' then '2' 
                when b.PRDORDTYPE='2' then '2' when b.PRDORDTYPE='3' then '4' end  PAGEFLAGS,
                nvl(b.RFTOTALAMT,0) RFTOTALAMT,
                TO_CHAR(to_number(nvl(b.ordAmt,0)-nvl(b.RFTOTALAMT,0))/100,'FM9999,999,999,990.00') as KERFAMT,
                TO_CHAR(to_number(nvl(b.RFTOTALAMT,0))/100,'FM9999,999,999,990.00') as RFAMT,
                case when c.actdat !=' ' then TO_CHAR(to_date(c.actdat,'yyyymmddhh24miss'),'yyyy-mm-dd  hh24:mi:ss')end actdat 
         from StpPrdInf b  left join stppayinf c on (trim(b.prdOrdNo)=trim(c.prdOrdNo)) and b.payordno = c.payordno
         where b.merno=#{merid} and ((b.OrdStatus in ('01','12') and c.ordstatus='01') or b.OrdStatus not in ('01','12')) 
         ${ordprdOrdNo} ${ordprdName} ${orderDate} ${prdOrdStatus} ${prdordamt} ${txnDate} 
         order by seqno desc
       </sql>
     <process>
                        
         <set name="FLAG"        value="01"/>
         <set name="merid"       expr="SESSIONS.MERID"/>
         

           <set name="Fh" value="'" />
           
           <!--商品订单号 -->
           <if condition="IS_EQUAL_STRING(prdOrdNo,'')">
                <set name="ordprdOrdNo" value=""/>
           </if>
           <else>
                <set name="ordprdOrdNo" expr="STRCAT(' and b.prdOrdNo = ',fh,prdOrdNo,fh)"/>
           </else>
           
           <!--交易商品名称 -->
           <if condition="IS_EQUAL_STRING(prdName,'')">
                <set name="ordprdName"  value=""/>
           </if>
           <else>
                <set name="ordprdName"  expr="STRCAT(' and b.prdName like ',fh,'%',prdName,'%',fh)"/>
           </else>
           
           <!--订单状态--> 
           <if condition="IS_EQUAL_STRING(OrdStatus,'')">
                <set name="prdOrdStatus"     value=""/>
           </if>
           <else>
                <set name="prdOrdStatus"    expr="STRCAT(' and b.OrdStatus = ',fh,OrdStatus,fh)"/>
           </else>
           
           <!--订单最小金额 -->
           <if condition="ISNULL(minAmt)">
                <set name="minAmt"     value=""/>
           </if>
           <else>
               <set name="minAmt"            expr="AMTPOWER(minAmt,'2')"/>
           </else>
           <!--订单最大金额 -->
           <if condition="ISNULL(maxAmt)">
                <set name="maxAmt"     value=""/>
           </if>
           <else>
               <set name="maxAmt"        expr="AMTPOWER(maxAmt,'2')"/>
           </else>
           <if condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt" value=""/>
           </if>
           <elseif condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_NOEQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and b.ordAmt  &gt;= to_number(',Fh, minAmt ,Fh,')')" />
           </elseif>
           <elseif condition="AND(IS_NOEQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and  b.ordAmt &lt;= to_number(',Fh, maxAmt ,Fh,')')" />
           </elseif>
           <else>
             <if condition="INTCMP(maxAmt,1,minAmt)">
                 <set name="RspCod" value="08040" />
                 <set name="RspMsg" value="最大金额小于最小金额" />
                 <return />
             </if>
             <set name="prdordamt"  expr="STRCAT(' and b.ordAmt between to_number(\'',minAmt,'\') and to_number(\'',maxAmt,'\')')"/>
             
           </else>
           <!-- 开始和结束时间范围 -->
           <if condition="IS_EQUAL_STRING(STARTDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="startDate" expr="CALCDATE(GETDATE(),'-','d',30)" />
               <set name="startDate" expr="FMTDATE(startDate,0,4)"/>
               <set name="start_date"  expr="FMTDATE(STARTDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(STARTDATE),4,8)">
                   <set name="startDate"   expr="FMTDATE(STARTDATE,4,0)" />         <!-- 开始时间 -->
                   <set name="start_date"  expr="startDate"/>
               </if>
           </else>

           <if condition="IS_EQUAL_STRING(ENDDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="endDate"  expr="GETDATETIME('YYYYMMDD')" />
               <set name="endDate"  expr="FMTDATE(endDate,0,4)"/>
               <set name="end_date"  expr="FMTDATE(ENDDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(ENDDATE),4,8)">
                   <set name="endDate"   expr="FMTDATE(ENDDATE,4,0)" />       <!-- 结束时间 -->
                   <set name="end_date"  expr="endDate"/>
               </if>
           </else>
           
           <if condition="INTCMP(end_date,1,start_date)">
               <set name="RspCod" value="08040" />
               <set name="RspMsg" value="结束日期小于开始日期" />
               <return />
           </if>
           <set name="orderDate"  expr="STRCAT(' and b.ordertime  &gt;= ',Fh, STRCAT(start_date,'000000'),Fh,' and  b.ordertime &lt;=',Fh,STRCAT(end_date,'235959'),Fh)" />
          
           <!-- 支付开始和结束时间范围 -->
            <if condition="AND(NOT(ISNULL(PAYSTARTDATE)),NOT(ISNULL(PAYENDDATE)))">
                <if condition="INTCMP(STRCMP(FMTDATE(PAYSTARTDATE,4,0),FMTDATE(PAYENDDATE,4,0)),6,0)">
                	<set name="RsgMsg"          value="01002"   />
                	<set name="RspMsg"          value="支付开始日期不能早于结束日期"/>
                	<set name="DWZ_STATUS_CODE" value="300"     />
                	<set name="DWZ_RSP_MSG"     expr="RspMsg"   />
                	<return/>
            		</if>
            		<set name="PAY_START_DATE" expr="STRCAT(FMTDATE(PAYSTARTDATE,4,0),'000000')" />
            		<set name="PAY_END_DATE"   expr="STRCAT(FMTDATE(PAYENDDATE,4,0),'235959')" />
            		<set name="txnDate" expr="STRCAT(' AND c.actdat BETWEEN  ',fh,PAY_START_DATE,fh,' AND ',fh,PAY_END_DATE,fh)"/>
            </if>
            <elseif condition="AND(NOT(ISNULL(PAYSTARTDATE)),ISNULL(pay_end_date))">
                <set name="PAY_START_DATE" expr="STRCAT(FMTDATE(PAYSTARTDATE,4,0),'000000')" />
            		<set name="PAY_END_DATE"   value="20991231235959" />
            		<set name="txnDate" expr="STRCAT(' AND c.actdat BETWEEN  ',fh,PAY_START_DATE,fh,' AND ',fh,PAY_END_DATE,fh)"/>
            </elseif>
            <elseif condition="AND(ISNULL(PAYSTARTDATE),NOT(ISNULL(pay_end_date)))">
                <set name="PAY_START_DATE" value="19700101000000" />
            		<set name="PAY_END_DATE"   expr="STRCAT(FMTDATE(PAYENDDATE,4,0) ,'235959')" />
            		<set name="txnDate" expr="STRCAT(' AND c.actdat BETWEEN  ',fh,PAY_START_DATE,fh,' AND ',fh,PAY_END_DATE,fh)"/>
            </elseif>
            <else>
            	<set name="txnDate" value=""/>
            </else>           
           <!-- 统计成功的总笔数和总金额 -->
           <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QMerTotalOrdInfo" />
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录!"/>
             <set name="TOTALRECNUMS" value="0"/>
             <set name="TOTALPRDAMT"  value="0.00"/>
           </if>
           <elseif condition="#RetCod!=0">
              <set name="RspCod"    value="09101"/>
              <set name="RspMsg"    value="操作数据库失败!"/>
              <return/>
           </elseif>
           
           <!--查询商品订单信息 -->
           <do func="QueryInGroup" error="IGNORE">
              <para name="SqlCmd"     sql="QMerOrdInfoAll"/>
              <para name="RecordName" value="reportList"/>
              <para name="RecNum"     value="RECNUM"/>
           </do>
           <if condition="#RetCod==-1">
              <set name="RspCod"    value="09101"/>
              <set name="RspMsg"    value="操作数据库失败!"/>
              <return/>
           </if>
           
           <!--导出文件-->
           <do func="ReportExport" error="IGNORE">
               <para name="Root"          value="reportList"/>
               <para name="FileDemo"      value="merchantTranRecord"/> <!--导出模板名-->
               <para name="NameForUser"   value="merchantTranRecord"/> <!--导出文件名-->
               <para name="FilePath"      value="rptdemo"/>       <!--导出模板路径-->
               <para name="FileToPath"    value="/dat/download"/> <!--导出目标地址-->
               <para name="WebPath"       expr="GETCURAPPHOME()"/>
               <para name="params"        value="ORDERTIME/ACTDAT/PRDORDNO/PRDNAME/ORDAMT/RFAMT/ORDSTATUS"/>
               <para name="collectParams" value="TOTALRECNUMS/TOTALPRDAMT"/> <!--导出头-->
           </do>
           <if condition="#RetCod!=0">
               <set name="RspCod"          value="02103"/>
               <set name="RspMsg"          value="导出出错!"/>
               <set name="DWZ_STATUS_CODE" value="300"/>
               <set name="DWZ_RSP_MSG"     expr="RSPMSG"/> 
               <return/>
           </if>

           <!--读取xml参数 -->
           <set name="ConfigName"          value="FtpGetToResinMerchant"/>
           <quote name="ReadXmlCfg"/>   
           
           <!--移动文件-->
           <set name="FILENAME"            expr="#FILENAME"/>
           <do func="MoveFile">
               <para name="srcDir" expr="LclDir"    />
               <para name="srcFil" expr="FILENAME"  />
               <para name="tarDir" expr="ObjDir"    />
           </do>
           <if condition="#RetCod!=0"> 
               <set name="RspCod"  value="01007"/>  
               <set name="RspMsg"  value="移动文件错误!"/>  
               <return/> 
           </if>
         
           <set name="pos_webapps"              expr="GETSTRPOS(ObjDir,'/webapps/')"                                />
           <set name="ObjDir"                   expr="RIGHTSTR(ObjDir,SUB(STRLEN(ObjDir),ADD(pos_webapps,8)))"      />
         		<set name="FILEPATH" expr="STRCAT('/',ObjDir,'/',FILENAME)"/>
           <!--set name="_REQUESTATTR.REDIRECTURL" expr="STRCAT('/',ObjDir,'/',FILENAME)"/-->         
           
           <do func="DeleteNode" error="IGNORE">
           		<para name="NodeName"          value="REPORTLIST"/>
           </do>
           
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction> 

    <transaction code="exportRefundRecord" desc="导出商户退款记录">
     <sql name="QryMerRefInf"> <!-- 查询商户退款信息  -->
       select case when  a.ORDSTATUS = '00' then '等待处理'  when  a.ORDSTATUS = '02' then '退货成功'  else '退货失败' end ORDSTATUS,
       				a.refordNo PRDORDNO,a.ORIPRDORDNO ,b.prdName,
              TO_CHAR(to_number(nvl(b.ordAmt,0))/100,'FM9999,999,999,990.00') as ordamt,
              nvl(b.ordAmt,0) ordtotalAmt,nvl(b.RFTOTALAMT,0) RFTOTALAMT,
              TO_CHAR(to_number(nvl(a.RFAMT,0))/100,'FM9999,999,999,990.00') as RFAMT,
              case when  b.ordertime != ' ' then To_Char(to_date(b.orderTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end  orderdateTime,
              case when a.rfordtime !=' ' then to_char(to_date(a.rfOrdTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end  ORDERTIME,
              case when a.rfReqDate != ' ' then To_Char(to_date(a.rfReqDate,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end  RFREQDATE,
              nvl(a.cust_id,'') as userid,6 as pageflags 
        from stprefinf a left join stpprdinf b on trim(a.oriPrdOrdNo)=trim(b.prdOrdNo)
       where a.MERNO=#{MERID}  ${ordprdOrdNo} ${ordprdName} ${orderDate} ${prdOrdStatus} ${prdordamt}
        order by a.rfReqDate desc
     </sql>
     <sql name="QryMertotalInf"> <!-- 统计退款成功的总笔数和总金额  -->
       select count(*) as TOTALRECNUMS ,TO_CHAR(to_number(nvl(sum(RFAMT),0))/100,'FM9999,999,999,990.00') TOTALPRDAMT
         from stprefinf b
        where b.ORDSTATUS='00' and b.MERNO=#{MERID} 
     </sql>
     <process>
           
           <set name="FLAG"        value="02"/>
           <set name="merid"       expr="SESSIONS.MERID"/>
           

           <set name="Fh" value="'" />
           
           <!--商品订单号 -->
           <if condition="IS_EQUAL_STRING(prdOrdNo,'')">
                <set name="ordprdOrdNo" value=""/>
           </if>
           <else>
                <set name="ordprdOrdNo" expr="STRCAT(' and a.refordNo = ',fh,prdOrdNo,fh)"/>
           </else>
           
           <!--交易商品名称 -->
           <if condition="IS_EQUAL_STRING(prdName,'')">
                <set name="ordprdName"  value=""/>
           </if>
           <else>
                <set name="ordprdName"  expr="STRCAT(' and b.prdName like ',fh,'%',prdName,'%',fh)"/>
           </else>
           
           <!--订单状态--> 
           <if condition="IS_EQUAL_STRING(OrdStatus,'')">
                <set name="prdOrdStatus"     value=""/>
           </if>
           <else>
                <set name="prdOrdStatus"    expr="STRCAT(' and a.OrdStatus like ',fh,'%',OrdStatus,'%',fh)"/>                                      
           </else>
           
           <!--订单最小金额 -->
           <if condition="ISNULL(minAmt)">
                <set name="minAmt"     value=""/>
           </if>
           <else>
                 <set name="minAmt"            expr="AMTPOWER(minAmt,'2')"/>
           </else>
           <!--订单最大金额 -->
           <if condition="ISNULL(maxAmt)">
                <set name="maxAmt"     value=""/>
           </if>
           <else>
                 <set name="maxAmt"        expr="AMTPOWER(maxAmt,'2')"/>
           </else>
           <if condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt" value=""/>
           </if>
           <elseif condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_NOEQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and b.ordAmt  &gt;= to_number(',Fh, minAmt ,Fh,')')" />
           </elseif>
           <elseif condition="AND(IS_NOEQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and  b.ordAmt &lt;= to_number(',Fh, maxAmt ,Fh,')')" />
           </elseif>
           <else>
             <if condition="INTCMP(maxAmt,1,minAmt)">
                 <set name="RspCod" value="08040" />
                 <set name="RspMsg" value="最大金额小于最小金额" />
                 <return />
             </if>
             <set name="prdordamt"  expr="STRCAT(' and b.ordAmt between to_number(\'',minAmt,'\') and to_number(\'',maxAmt,'\')')"/>
             
           </else>
           <!-- 开始和结束时间范围 -->
           <if condition="IS_EQUAL_STRING(STARTDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="startDate" expr="CALCDATE(GETDATE(),'-','d',30)" />
               <set name="startDate" expr="FMTDATE(startDate,0,4)"/>
               <set name="start_date"  expr="FMTDATE(STARTDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(STARTDATE),4,8)">
                   <set name="startDate"   expr="FMTDATE(STARTDATE,4,0)" />         <!-- 开始时间 -->
                   <set name="start_date"  expr="startDate"/>
               </if>
           </else>

           <if condition="IS_EQUAL_STRING(ENDDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="endDate"  expr="GETDATETIME('YYYYMMDD')" />
               <set name="endDate"  expr="FMTDATE(endDate,0,4)"/>
               <set name="end_date"  expr="FMTDATE(ENDDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(ENDDATE),4,8)">
                   <set name="endDate"   expr="FMTDATE(ENDDATE,4,0)" />       <!-- 结束时间 -->
                   <set name="end_date"  expr="endDate"/>
               </if>
           </else>
           
           <if condition="INTCMP(end_date,1,start_date)">
               <set name="RspCod" value="08040" />
               <set name="RspMsg" value="结束日期小于开始日期" />
               <return />
           </if>
           <set name="orderDate"  expr="STRCAT(' and b.ordertime  &gt;= ',Fh, STRCAT(start_date,'000000'),Fh,' and  b.ordertime &lt;=',Fh,STRCAT(end_date,'235959'),Fh)" />
           
           <!-- 统计成功的总笔数和总金额 -->
           <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryMertotalInf" />
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录!"/>
             <set name="TOTALRECNUMS" value="0"/>
             <set name="TOTALPRDAMT"  value="0.00"/>
           </if>
           <elseif condition="#RetCod!=0">
                <set name="RspCod"    value="09101"/>
                <set name="RspMsg"    value="操作数据库失败!"/>
                <return/>
           </elseif>
           
           <!--查询商品订单信息 -->
           <do func="QueryInGroup" error="IGNORE">
              <para name="SqlCmd"     sql="QryMerRefInf"/>
              <para name="RecordName" value="reportList"/>
              <para name="RecNum"     value="RECNUM"/>
           </do>
           <if condition="#RetCod==-1">
              <set name="RspCod"    value="09101"/>
              <set name="RspMsg"    value="操作数据库失败!"/>
              <return/>
           </if>
           
           <!--导出文件-->
           <do func="ReportExport" error="IGNORE">
               <para name="Root"          value="reportList"/>
               <para name="FileDemo"      value="merchantRefundRecord"/> <!--导出模板名-->
               <para name="NameForUser"   value="merchantRefundRecord"/> <!--导出文件名-->
               <para name="FilePath"      value="rptdemo"/>       <!--导出模板路径-->
               <para name="FileToPath"    value="/dat/download"/> <!--导出目标地址-->
               <para name="WebPath"       expr="GETCURAPPHOME()"/>
               <para name="params"        value="ORDERTIME/PRDORDNO/PRDNAME/ORDAMT/RFAMT/ORDSTATUS"/>
               <para name="collectParams" value="TOTALRECNUMS/TOTALPRDAMT"/> <!--导出头-->
           </do>
           <if condition="#RetCod!=0">
               <set name="RspCod"          value="02103"/>
               <set name="RspMsg"          value="导出出错!"/>
               <set name="DWZ_STATUS_CODE" value="300"/>
               <set name="DWZ_RSP_MSG"     expr="RSPMSG"/> 
               <return/>
           </if>

           <!--读取xml参数 -->
           <set name="ConfigName"          value="FtpGetToResinMerchant"/>
           <quote name="ReadXmlCfg"/>   
           
           <!--移动文件-->
           <set name="FILENAME"            expr="#FILENAME"/>
           <do func="MoveFile">
               <para name="srcDir" expr="LclDir"    />
               <para name="srcFil" expr="FILENAME"  />
               <para name="tarDir" expr="ObjDir"    />
           </do>
           <if condition="#RetCod!=0"> 
               <set name="RspCod"  value="01007"/>  
               <set name="RspMsg"  value="移动文件错误!"/>  
               <return/> 
           </if>

           <set name="pos_webapps"              expr="GETSTRPOS(ObjDir,'/webapps/')"                                />
           <set name="ObjDir"                   expr="RIGHTSTR(ObjDir,SUB(STRLEN(ObjDir),ADD(pos_webapps,8)))"      />
         	<set name="FILEPATH" expr="STRCAT('/',ObjDir,'/',FILENAME)"/>
           <!--set name="_REQUESTATTR.REDIRECTURL" expr="STRCAT('/',ObjDir,'/',FILENAME)"/--> 
           
           <do func="DeleteNode" error="IGNORE">
           		<para name="NodeName"          value="REPORTLIST"/>
           </do>
             
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
    
    <transaction code="accountTransfer" desc="商户批量转账">
       <sql name="selMerTraApply">
         select c.cust_name,a.usrlogin,TO_CHAR(to_number(nvl(a.txamt,0.00))/100,'FM9999,999,999,990.00') txamt,a.remark from STPTRANSITINF a,stpusrinf b,stpcusinf c
         where a.usrlogin=b.cust_login and b.cust_id=c.cust_id and a.batno=#{batno}
       </sql>
       <sql name="selCountMerTraApply">
         select count(*) countnum,TO_CHAR(to_number(nvl(sum(txamt),0.00))/100,'FM9999,999,999,990.00') sumamt from STPTRANSITINF where batno=#{batno}
       </sql>
       <sql name="delMerTraApply"> 
         delete STPTRANSITINF where batno=#{applybatno}
       </sql>
       <sql name="QryUsrID"><!-- 查询客户信息-->
         SELECT b.CUST_ID USERID,b.CUST_NAME USERNAME,b.CUST_STATUS FROM StpUsrInf a,StpCusInf b WHERE a.CUST_ID=b.CUST_ID and a.CUST_LOGIN=#{USRLOGIN}
       </sql>
       <sql name="QryCusInf"><!-- 查询客户信息-->
         SELECT CUST_STATUS FROM StpCusInf WHERE CUST_ID=#{USERID}
       </sql>
       <sql name="SelMerAccInf"><!-- 查询客户账户信息-->
         SELECT a.AC_STATUS,cash_ac_bal,froz_balance FROM ARP_AC_PROFILE a,ARP_AC_CUST_REL b WHERE b.CUST_ID=#{USERID} AND a.PAY_AC_NO=b.PAY_AC_NO and a.ac_type='01'
       </sql>
       <sql name="UpdSts"> <!-- 更新转账订单表 -->
         UPDATE STPTRAINF SET ORDSTATUS=#{OrdStatus} WHERE batno=#{batno}
       </sql>
       <process> 
           <set name="merid"       expr="SESSIONS.MERID"/>
           <if condition="IS_NOEQUAL_STRING(SysCod,'2201')">
             <set name="MsgTyp"       value="E"/>
             <set name="RspCod"       value="01001"/>
             <set name="RspMsg"       value="商户登录平台不正确"/>
             <return/>
           </if>
           <if condition="IS_EQUAL_STRING(MerApplyFlag,'1')"> <!--ajax查询申请列表-->
             <do func="QueryInGroup" error="IGNORE">
               <para name="SqlCmd"     sql="selMerTraApply"/>
               <para name="RecordName" value="MerTraApplyList"/>
               <para name="RecNum"     value="MerTraApplyRECNUM"/>
             </do>
             <if condition="#RetCod!=0">
               <set name="RspCod"    value="09101"/>
               <set name="RspMsg"    value="查询数据失败!"/>
               <return/>
             </if>
             <do func="ReadRecord"             error="IGNORE">
               <para name="SqlCmd"             sql="selCountMerTraApply"/>
             </do>
             <if condition="#RetCod!=0">
               <set name="RSPCOD"              value="09999"/>
               <set name="RSPMSG"              value="查询数据失败!"/>
               <return/>
             </if>
           </if>
           <elseif condition="IS_EQUAL_STRING(MerApplyFlag,'2')"><!--商户转账处理-->
             <set name="submitFlag" expr="submitFlag"/>
             <set name="sumamt"     expr="AMTPOWER(sumamt,2)"/>
             <set name="countnum"   expr="countnum"/>
             <if condition="IS_EQUAL_STRING(submitFlag,'T')"><!--确认付款-->
                <set name="userId"     expr="SESSIONS.MERID"/>
                <set name="TRACUSID"   expr="userId"/>          <!-- 付款（转出）客户编号 -->
                <set name="TRACUSNAM"  expr="SESSIONS.BUSNAME"/><!--付款（转出）客户名称 -->

                <do func="ReadRecord" error="IGNORE">
                  <para name="SqlCmd" sql="QryCusInf" />
                </do>
                <if condition="#RetCod!=0">
                   <set name="RspCod"    value="09999"/>
                   <set name="RspMsg"    value="商户信息不存在"/>
                   <set name="DWZ_STATUS_CODE"   value="200"/>
                   <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
                   <return/>
                </if>
                <if condition="IS_NOEQUAL_STRING(CUST_STATUS,'0')">
                   <set name="RspCod"    value="08040"/>
                   <set name="RspMsg"    value="客户状态不正常"/>
                   <set name="DWZ_STATUS_CODE"   value="300"/>
                   <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
                   <return/>
                </if>
                <quote name="merChkAcc"/>
                
                <if condition="INTCMP(SUB(cash_ac_bal,froz_balance),1,sumamt)">
                   <set name="MsgTyp"    value="E"/>
                   <set name="RspCod"    value="09001"/>
                   <set name="RspMsg"    value="商户现金账户余额不足！"/>
                   <return/>
                </if>
                <set name="PARAMS"      expr="STRCAT(merid,'/','01','/','-','/','CNY','/',sumamt,'/','Y','/')"/>  <!--转出方记账参数-->

                <do func="GetSeqNo"  error="IGNORE">
                   <para name="TblNam" value="stpseqrec"/>
                   <para name="KeyNam" value="KeyNam"/>
                   <para name="KeyVal" expr="STRCAT('StpTraInf','BatNo')"/>
                   <para name="SeqNam" value="KeyVal"/>
                   <para name="Len"    value="8"/>
                   <para name="Circle" value="1"/>
                </do>
                <if condition="#RetCod!=0">
                   <set name="MsgTyp"    value="E"/>
                   <set name="RspCod"    value="09001"/>
                   <set name="RspMsg"    value="获取序号错误"/>
                   <return/>
                </if>
                <set name="batNo"    expr="STRCAT(SUBSTR(GETDATE(),2,7),KeyVal)"/>   <!--批次号-->
                
                <set name="i"         value="0"/>
                <set name="usrTOAmt"  value="0"/>
                <while condition="INTCMP(i,1,countnum)">
                   <do func="GetValue"  error="IGNORE">
                      <para name="SourName" expr="STRCAT('USRLOGIN_',i)"/>
                      <para name="DestName" value="USRLOGIN"/>
                   </do>
                   <do func="GetValue"  error="IGNORE">
                      <para name="SourName" expr="STRCAT('TRAAMT_',i)"/>
                      <para name="DestName" value="TRAAMT"/>
                   </do>
                   <do func="GetValue"  error="IGNORE">
                      <para name="SourName" expr="STRCAT('REMARK_',i)"/>
                      <para name="DestName" value="REMARK"/>
                   </do>
                   
                   <set name="TRAAMT"       expr="AMTPOWER(TRAAMT,2)"/>
                   <set name="usrTOAmt"     expr="ADD(usrTOAmt,TRAAMT)"/>
                                      
                   <if condition="NOT(ISNUMBER(txAmt))">
                       <set name="MsgTyp"    value="E"/>
                       <set name="RspCod"    value="01001"/>
                       <set name="RspMsg"    value="金额格式不正确！"/>
                       <do func="RollBackWork"/>
                       <return/>
                   </if>
                   
                   <!--获取序号 -->
                   <do func="GetSeqNo"  error="IGNORE">
                      <para name="TblNam" value="stpseqrec"/>
                      <para name="KeyNam" value="KeyNam"/>
                      <para name="KeyVal" expr="STRCAT('StpTraInf','TraOrdNo')"/>
                      <para name="SeqNam" value="KeyVal"/>
                      <para name="Len"    value="8"/>
                      <para name="Circle" value="1"/>
                   </do>
                   <if condition="#RetCod!=0">
                      <set name="MsgTyp"    value="E"/>
                      <set name="RspCod"    value="09001"/>
                      <set name="RspMsg"    value="获取序号错误"/>
                      <do func="RollBackWork"/>
                      <return/>
                   </if>
                   <set name="traOrdNo"    expr="STRCAT('T',SUBSTR(GETDATE(),2,7),KeyVal)"/>
                  
                   <set name="traTime"     expr="GETDATETIME()"/> <!--转账时间 -->
                   <set name="OrdStatus"   value="00"/>           <!--订单状态-->
                   <set name="txCcy"       value="CNY"/>          <!--货币类型  -->
                   <set name="txamt"       expr="TRAAMT"/>          <!--订单金额  -->
                   
                   <set name="FEE"         value="0"/>         <!-- 如需修改，请调用获取手续费的宏进行计算 -->
                   
                   <!--查询客户ID，用于下面检查客户信息和转账表维护-->
                   <do func="ReadRecord" error="IGNORE">
                     <para name="SqlCmd" sql="QryUsrID"/>
                   </do>
                   <if condition="#RetCod!=0">
                     <set name="RspCod"    value="02103"/>
                     <set name="RspMsg"    value="查询转入方客户信息失败!"/>
                     <do func="RollBackWork"/>
                     <return/>
                   </if>
                   
                   <!-- 校验转入方账户信息 -->
                   <quote name="merChkAcc"/><!--转入方账户检查-->

                   <set name="getCusNam"   expr="USERNAME"/> <!-- 收款（转入）客户名称 -->
                   <set name="getCusId"    expr="USERID"/>  <!-- 收款（转入）客户编号 -->
                   <set name="REMARK"      expr="REMARK"/>     <!--转账说明 -->

                   <do func="InsertRecord" error="IGNORE">
                      <para name="TblNam"  value="StpTraInf" />
                   </do>
                   <if condition="#RetCod!=0">
                      <set name="MsgTyp"    value="E"/>
                      <set name="RspCod"    value="09999"/>
                      <set name="RspMsg"    value="系统错误"/>
                      <do func="RollBackWork"/>
                      <return/>
                   </if>
                   <set name="usrPar"      expr="STRCAT(USERID,'/','01','/','+','/','CNY','/',TRAAMT,'/','Y','/')"/>  <!--转出方记账参数-->
                   <set name="PARAMS"      expr="STRCAT(PARAMS,',',usrPar)"/>
                   
                   <delete name="USRLOGIN"/>
                   <delete name="TRAAMT"/>
                   <delete name="REMARK"/>
                   <set name="i" expr="ADD(i,'1')"/>
                </while>

                <if condition="IS_NOEQUAL_STRING(usrTOAmt,sumamt)">
                    <set name="MsgTyp"       value="E"/>
                    <set name="RspCod"       value="23456"/>
                    <set name="RspMsg"       value="订单金额不一致"/>
                    <return/>
                </if>

                <!--记账处理-->
                <set name="prdordno"     expr="batno"/>
                <set name="TXN_TYP"      value="3"/>      <!--用途 3 转账-->
                <quote name="accProcess"/>
                <if condition="#RetCod!=0">
                   <set name="MsgTyp"    value="E"/>
                   <set name="RspCod"    value="08043"/>
                   <set name="RspMsg"    value="转账失败"/>
                   <do func="RollBackWork" />
                   <return/>
                </if>
              
                <!--更新订单状态-->
                <set name="OrdStatus"    value="01"/>
                <do func="ExecSql">
                   <para name="SqlCmd" sql="UpdSts"/>
                </do>
                <if condition="#RetCod!=0">
                   <set name="MsgTyp"    value="E"/>
                   <set name="RspCod"    value="09999"/>
                   <set name="RspMsg"    value="系统错误"/>
                   <do func="RollBackWork" />
                   <return/>
                </if>
             </if>
             <else><!--取消付款-->
                <do func="ExecSql" error="IGNORE">
                  <para name="SqlCmd" sql="delMerTraApply"/>
                </do>
                <if condition="#RetCod!=0">
                  <set name="RspCod"    value="02103"/>
                  <set name="RspMsg"    value="取消付款失败!"/>
                  <return/>
                </if>
             </else>
           </elseif>
           <else>
             <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/account/accountTransfer.jsp')" />
           </else>

           <set name="RspCod"               value="00000"/>
           <set name="RspMsg"               value="交易成功"/>
       </process>
    </transaction>

    <transaction code="accountWithdrawals" desc="商户提现">
       <sql name="qryMerStlInf">
         select  CUST_STL_BANK_AC_NO,CUST_BANK_DEPOSIT_NAME,BANK_REL_NO ,DEPOSIT_BANK_BRCH_NAME from stpmerinf where cust_id=#{merid}
       </sql>
       <sql name="UpdBnkPay"><!--更新银行代付信息-->
         REQUEST_SN = #{REQUEST_SN}
       </sql>
       <sql name="SelMerAccInf"><!-- 查询客户账户信息-->
         SELECT a.AC_STATUS,cash_ac_bal,froz_balance,a.PAY_AC_NO FROM ARP_AC_PROFILE a,ARP_AC_CUST_REL b WHERE b.CUST_ID=#{merid} AND a.PAY_AC_NO=b.PAY_AC_NO and a.ac_type='01'
       </sql>
       <sql name="QryCusInf"><!-- 查询客户信息-->
         SELECT CUST_STATUS FROM StpCusInf WHERE CUST_ID=#{merid}
       </sql>
       <sql name="SelFrzInf">
        select PAY_AC_NO,FROZ_AMT,BIZ_CODE,STATUS,FROZ_NO from ARP_AC_FORZZ_DETAILS where BIZ_CODE=#{CASORDNO} and STATUS='01'
       </sql>
       <sql name="UpdFrezInf"><!-- 更新冻结信息-->
         UPDATE ARP_AC_FORZZ_DETAILS SET STATUS='00',LST_UPT_DATE=#{LST_UPT_DATE},LST_UPT_TIME=#{LST_UPT_TIME} WHERE FROZ_NO=#{FROZ_NO}
       </sql>
       <sql name="UpdCasStatus">
         UPDATE STPCASINF SET SUCDAT=#{SucDat},ORDSTATUS=#{ORDSTATUS},BANKERROR=#{ERROR} WHERE CASORDNO=#{CASORDNO}
       </sql>
       <process>
          <set name="merid"       expr="SESSIONS.MERID"/>
          <if condition="IS_NOEQUAL_STRING(SysCod,'2201')">
            <set name="MsgTyp"       value="E"/>
            <set name="RspCod"       value="01001"/>
            <set name="RspMsg"       value="商户登录平台不正确"/>
            <return/>
          </if>
          
          <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryCusInf" />
          </do>
          <if condition="#RetCod!=0">
             <set name="RspCod"    value="09999"/>
             <set name="RspMsg"    value="商户信息不存在"/>
             <set name="DWZ_STATUS_CODE"   value="200"/>
             <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
             <return/>
          </if>
          
          <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd"       sql="qryMerStlInf"/> 
          </do>
          <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误,清稍后再试！"/>
            <return/>    
          </if>
          
          <if condition="IS_EQUAL_STRING(MerApplyFlag,'1')"> <!--商户提现-->
            <if condition="OR(IS_NOEQUAL_STRING(CUST_STL_BANK_AC_NO,CUST_STL_BANK_AC_NO1),IS_NOEQUAL_STRING(CUST_BANK_DEPOSIT_NAME,CUST_BANK_DEPOSIT_NAME1),IS_NOEQUAL_STRING(BANK_REL_NO,BANK_REL_NO1))">
               <set name="MsgTyp"       value="E"/>
               <set name="RspCod"       value="01001"/>
               <set name="RspMsg"       value="参数遭到篡改，拒绝交易"/>
               <return/>
            </if>
            
            <if condition="IS_NOEQUAL_STRING(CUST_STATUS,'0')">
               <set name="RspCod"    value="08040"/>
               <set name="RspMsg"    value="客户状态不正常"/>
               <set name="DWZ_STATUS_CODE"   value="300"/>
               <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
               <return/>
            </if>
            <quote name="merChkAcc"/>
            
            <if condition="INTCMP(SUB(cash_ac_bal,froz_balance),1,AMTPOWER(STLAMT,2))">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09001"/>
               <set name="RspMsg"    value="商户现金账户余额不足！"/>
               <return/>
            </if>
            
            <!--银行卡号-->
            <do func="GetCrdInfo">
                <para name="CrdNo" expr="CUST_STL_BANK_AC_NO" />
            </do>
            <if condition="#RetCod!=0">
               <set name="CPSCod" value="99" />
               <set name="RspMsg" value="获取卡bin信息失败" />
               <return />
            </if>
            <set name="ISSBANKNAME"  expr="ISSNAM" />
            <set name="BANKCARDTYPE" expr="DCFLAG" /><!-- 卡类型 01：借记卡 02：信用卡 -->
            <set name="CARD_BANK"    expr="ISSNO" />
            
            <if condition="IS_NOEQUAL_STRING(BANKCARDTYPE,'01')">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="01003"/>
               <set name="RspMsg"    value="提现银行卡号不是借记卡，不能提现！"/>
               <return/>
            </if>
            
            <!--收款卡号加密-->
            <set name="CARD_NO"      expr="DES_ENCRYPT(CUST_STL_BANK_AC_NO)"   />
            
            <do func="GetSeqNo" error="IGNORE">
              <para name="TblNam" value="stpseqrec" />
              <para name="KeyNam" value="KeyNam" />
              <para name="KeyVal" expr="STRCAT('StpCasInf','CasOrdNo')" />
              <para name="SeqNam" value="KeyVal" />
              <para name="Len" value="8" />
              <para name="Circle" value="1" />
            </do>
            <if condition="#RetCod!=0">
              <set name="MsgTyp" value="E" />
              <set name="RspCod" value="09001" />
              <set name="RspMsg" value="获取序号错误" />
              <return />
            </if>
            <set name="bankCode" expr="CARD_BANK" />
            <set name="bankPayAcNo"   expr="CARD_NO"/>
            <set name="CasOrdNo" expr="STRCAT('C',SUBSTR(GETDATE(),2,7),KeyVal)" />
            <set name="ActDat"   expr="GETDATETIME()" />
            <set name="CUST_ID"  expr="merid" />
            <set name="bankPayUserNm" expr="SESSIONS.BUSNAME" />
            <set name="OrdStatus" value="00" />
            <set name="FEE" value="0" />
            <set name="txCcy"         value="CNY"/>
            <set name="txAmt"         expr="AMTPOWER(STLAMT,2)"/>
            <set name="netRecAmt"     expr="AMTPOWER(STLAMT,2)"/>
            <set name="SucDat"        value=""/>
            <!--登记提现订单信息 -->
            <do func="InsertRecord" error="IGNORE">
              <para name="TblNam" value="StpCasInf" />
            </do>
            <if condition="#RetCod!=0">
              <set name="MsgTyp" value="E" />
              <set name="RspCod" value="09999" />
              <set name="RspMsg" value="系统错误" />
              <return />
            </if>
            <!--冻结用户提现金额+交易手续费 -->
            <set name="txAmt" expr="ADD(AMTPOWER(STLAMT,2),FEE)" />
            <set name="RCS_PRD_NO" expr="CasOrdNo" /><!--订单号，如果不涉及置空 -->
            <set name="PAY_AC_NO" expr="PAY_AC_NO" />
            <quote name="frezzAmt" />
           
            <!--登记冻结信息 -->
            <set name="BIZ_CODE" expr="CasOrdNo" />
            <set name="FROZ_REASON" value="提现" />
            <quote name="InsFrozInf" />
            
            <!--quote name="DirectChannelCCB" /--><!--建行银企直连通道-->
              
            <!--将扣除的提现金额解冻 并从账户里扣除-->
            <set name="RCS_PRD_NO"    expr="CASORDNO"/><!--订单号，如果不涉及置空-->
            <set name="PAY_AC_NO"     expr="PAY_AC_NO"/>
            <set name="txAmt"         expr="STRCAT('-',txAmt)"/>
            <quote name="frezzAmt"/>
            <!--更新冻结状态-->
            <quote name="UpdFrezz"/>
            
            <set name="usrPar"       expr="STRCAT(merid,'/','01','/','-','/','CNY','/',AMTPOWER(STLAMT,2),'/','Y','/')"/>  <!--用户记账参数-->
            <set name="PARAMS"       expr="usrPar"/>
            <!--记账处理-->
            <set name="TXN_TYP"      value="4"/>      <!--用途 4 提现-->
            <set name="prdordno"     expr="CASORDNO"/>
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
              <set name="RspCod"     value="08042"/>
              <set name="RspMsg"     value="提现失败"/>
              <set name="DWZ_STATUS_CODE" value="300"/>
              <set name="DWZ_RSP_MSG"  expr="RSPMSG"/>
              <do func="RollBackWork"/>
              <return/>
            </if>
            <set name="ERROR"  value=""/>
            <!-- 更新提现订单 -->
            <set name="SucDat"       expr="GETDATETIME()"/>
            <set name="ORDSTATUS"     value="01"/>
            <do func="ExecSql" >
              <para name="SqlCmd" sql="UpdCasStatus"/>
            </do>
            <if condition="#RetCod!=0">
              <set name="RspCod"     value="08042"/>
              <set name="RspMsg"     value="提现失败"/>
              <set name="DWZ_STATUS_CODE" value="300"/>
              <set name="DWZ_RSP_MSG"  expr="RSPMSG"/>
              <do func="RollBackWork"/>
              <return/>
            </if>
              
          </if>
          <else> 
             <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/account/accountWithdrawals.jsp')" />
          </else>
                   
          <set name="RspCod"       value="00000"/>
          <set name="RspMsg"       value="交易成功"/>
       </process>
    </transaction>
    
    <transaction code="accountPayment" desc="商户批量付款">
       <sql name="selMerTraApply">
         select a.USRLOGIN cust_name,a.BankCardNum usrlogin,TO_CHAR(to_number(nvl(a.txamt,0.00))/100,'FM9999,999,999,990.00') txamt,TO_CHAR(to_number(nvl(a.fee,0.00))/100,'FM9999,999,999,990.00') fee,a.remark 
         from STPTRANSITINF a
         where a.batno=#{batno}
       </sql>
       <sql name="selCountMerTraApply">
         select count(*) countnum,TO_CHAR(to_number(nvl(sum(txamt),0.00))/100,'FM9999,999,999,990.00') sumamt,TO_CHAR(to_number(nvl(sum(fee),0.00))/100,'FM9999,999,999,990.00') sumfee from STPTRANSITINF where batno=#{batno}
       </sql>
       <sql name="delMerTraApply"> 
         delete STPTRANSITINF where batno=#{applybatno}
       </sql>
       <sql name="delMerTraApplyByBatNo"> 
         delete BatchCollectInf where batno=#{applybatno}
       </sql>
       <sql name="QryUsrID"><!-- 查询客户信息-->
         SELECT b.CUST_ID USERID,b.CUST_NAME USERNAME,b.CUST_STATUS FROM StpUsrInf a,StpCusInf b WHERE a.CUST_ID=b.CUST_ID and a.CUST_LOGIN=#{USRLOGIN}
       </sql>
       <sql name="QryCusInf"><!-- 查询客户信息-->
         SELECT CUST_STATUS FROM StpCusInf WHERE CUST_ID=#{USERID}
       </sql>
       <sql name="SelMerAccInf"><!-- 查询客户账户信息-->
         SELECT a.PAY_AC_NO,a.AC_STATUS,cash_ac_bal,froz_balance FROM ARP_AC_PROFILE a,ARP_AC_CUST_REL b WHERE b.CUST_ID=#{USERID} AND a.PAY_AC_NO=b.PAY_AC_NO and a.ac_type='01'
       </sql>
       <sql name="UpdBatCasSts"> <!-- 更新转账订单表 -->
         UPDATE BatchCollectInf SET BatSTATUS=#{BatSTATUS} WHERE batno=#{applybatno}
       </sql>
       <process> 
           <set name="merid"       expr="SESSIONS.MERID"/>
           <if condition="IS_NOEQUAL_STRING(SysCod,'2201')">
             <set name="MsgTyp"       value="E"/>
             <set name="RspCod"       value="01001"/>
             <set name="RspMsg"       value="商户登录平台不正确"/>
             <return/>
           </if>
           <if condition="IS_EQUAL_STRING(MerApplyFlag,'1')"> <!--ajax查询申请列表-->
             <do func="QueryInGroup" error="IGNORE">
               <para name="SqlCmd"     sql="selMerTraApply"/>
               <para name="RecordName" value="MerTraApplyList"/>
               <para name="RecNum"     value="MerTraApplyRECNUM"/>
             </do>
             <if condition="#RetCod!=0">
               <set name="RspCod"    value="09101"/>
               <set name="RspMsg"    value="查询数据失败!"/>
               <return/>
             </if>
             <do func="ReadRecord"             error="IGNORE">
               <para name="SqlCmd"             sql="selCountMerTraApply"/>
             </do>
             <if condition="#RetCod!=0">
               <set name="RSPCOD"              value="09999"/>
               <set name="RSPMSG"              value="查询数据失败!"/>
               <return/>
             </if>
           </if>
           <elseif condition="IS_EQUAL_STRING(MerApplyFlag,'2')"><!--商户付款处理-->
             <set name="submitFlag" expr="submitFlag"/>
             <set name="sumamt"     expr="AMTPOWER(sumamt,2)"/>
             <set name="sumfee"     expr="AMTPOWER(sumfee,2)"/>
             <set name="countnum"   expr="countnum"/>
             <if condition="IS_EQUAL_STRING(submitFlag,'T')"><!--确认付款-->
                <set name="userId"     expr="SESSIONS.MERID"/>
                <set name="TRACUSID"   expr="userId"/>          <!-- 付款（转出）客户编号 -->
                <set name="TRACUSNAM"  expr="SESSIONS.BUSNAME"/><!--付款（转出）客户名称 -->

                <do func="ReadRecord" error="IGNORE">
                  <para name="SqlCmd" sql="QryCusInf" />
                </do>
                <if condition="#RetCod!=0">
                   <set name="RspCod"    value="09999"/>
                   <set name="RspMsg"    value="商户信息不存在"/>
                   <set name="DWZ_STATUS_CODE"   value="200"/>
                   <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
                   <return/>
                </if>
                <if condition="IS_NOEQUAL_STRING(CUST_STATUS,'0')">
                   <set name="RspCod"    value="08040"/>
                   <set name="RspMsg"    value="客户状态不正常"/>
                   <set name="DWZ_STATUS_CODE"   value="300"/>
                   <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
                   <return/>
                </if>
                <quote name="merChkAcc"/>
                
                <if condition="INTCMP(SUB(cash_ac_bal,froz_balance),1,ADD(sumamt,sumfee))">
                   <set name="MsgTyp"    value="E"/>
                   <set name="RspCod"    value="09001"/>
                   <set name="RspMsg"    value="商户现金账户余额不足！"/>
                   <return/>
                </if>
                
                <set name="i"         value="0"/>
                <set name="usrTOAmt"  value="0"/>
                <while condition="INTCMP(i,1,countnum)">
                   <do func="GetValue"  error="IGNORE">
                      <para name="SourName" expr="STRCAT('USRLOGIN_',i)"/>
                      <para name="DestName" value="USRLOGIN"/>
                   </do>
                   <do func="GetValue"  error="IGNORE">
                      <para name="SourName" expr="STRCAT('CUST_NAME_',i)"/>
                      <para name="DestName" value="CUST_NAME"/>
                   </do>
                   <do func="GetValue"  error="IGNORE">
                      <para name="SourName" expr="STRCAT('TRAAMT_',i)"/>
                      <para name="DestName" value="TRAAMT"/>
                   </do>
                   <do func="GetValue"  error="IGNORE">
                      <para name="SourName" expr="STRCAT('TRAFEE_',i)"/>
                      <para name="DestName" value="TRAFEE"/>
                   </do>
                   <do func="GetValue"  error="IGNORE">
                      <para name="SourName" expr="STRCAT('REMARK_',i)"/>
                      <para name="DestName" value="REMARK"/>
                   </do>
                   
                   <set name="TRAAMT"       expr="AMTPOWER(TRAAMT,2)"/><!--付款金额-->
                   <set name="TRAFEE"       expr="AMTPOWER(TRAFEE,2)"/><!--付款手续费-->
                   <set name="usrTOAmt"     expr="ADD(usrTOAmt,TRAAMT)"/><!--累计付款金额-->
                                      
                   <if condition="OR(NOT(ISNUMBER(TRAAMT)),NOT(ISNUMBER(TRAFEE)))">
                       <set name="MsgTyp"    value="E"/>
                       <set name="RspCod"    value="01001"/>
                       <set name="RspMsg"    value="金额格式不正确！"/>
                       <do func="RollBackWork"/>
                       <return/>
                   </if>
                   
                   <!--获取序号 -->
                   <do func="GetSeqNo"  error="IGNORE">
                      <para name="TblNam" value="stpseqrec"/>
                      <para name="KeyNam" value="KeyNam"/>
                      <para name="KeyVal" expr="STRCAT('StpCasInf','CasOrdNo')"/>
                      <para name="SeqNam" value="KeyVal"/>
                      <para name="Len"    value="8"/>
                      <para name="Circle" value="1"/>
                   </do>
                   <if condition="#RetCod!=0">
                      <set name="MsgTyp"    value="E"/>
                      <set name="RspCod"    value="09001"/>
                      <set name="RspMsg"    value="获取序号错误"/>
                      <return/>
                   </if>
                   
                   <do func="GetCrdInfo">
                     <para name="CrdNo" expr="USRLOGIN" />
                   </do>
                   <if condition="#RetCod!=0">
                     <set name="RspMsg" value="获取卡bin信息失败" />
                     <return />
                   </if>
                   
                   <set name="bankCode"      expr="ISSNO"/>
                   <set name="bankPayAcNo"   expr="DES_ENCRYPT(USRLOGIN)"/>
                   <set name="bankPayUserNm" expr="CUST_NAME"/>
                   <set name="CUST_ID"       expr="SESSIONS.MERID"/>
                   
                   <set name="CasOrdNo"      expr="STRCAT('FK',SUBSTR(GETDATE(),2,7),KeyVal)"/> 
                   <set name="batNo"         expr="applybatno"/> <!--批次号-->
                   <set name="ActDat"        expr="GETDATETIME()"/>
                   <set name="OrdStatus"     value="00"/> 
                   <set name="txAmt"         expr="TRAAMT"/>
                   <set name="fee"           expr="TRAFEE"/>
                   <set name="netRecAmt"     expr="ADD(TRAAMT,TRAFEE)"/>
                   <set name="txCcy"         value="CNY"/>
                   <set name="SucDat"        value=""/>
                   
                   <!--登记提现订单信息-->
                   <do func="InsertRecord" error="IGNORE">
                      <para name="TblNam"  value="STPCASPAYINF" />
                   </do>
                   <if condition="#RetCod!=0">
                      <set name="MsgTyp"    value="E"/>
                      <set name="RspCod"    value="09999"/>
                      <set name="RspMsg"    value="系统错误"/>
                      <return/>
                   </if>
                   
                   <!--冻结商户付款金额 -->  
                   <set name="RCS_PRD_NO"      expr="CasOrdNo"/><!--订单号，如果不涉及置空-->
                   <set name="PAY_AC_NO"       expr="PAY_AC_NO"/>
                   <quote name="frezzAmt"/>
                   
                   <!--登记冻结信息-->
                   <set name="BIZ_CODE"        expr="CasOrdNo"/>
                   <set name="FROZ_REASON"     value="提现"/>
                   <quote name="InsFrozInf"/>
                   
                   <delete name="USRLOGIN"/>
                   <delete name="CUST_NAME"/>
                   <delete name="TRAAMT"/>
                   <delete name="TRAFEE"/>
                   <delete name="REMARK"/>
                   <set name="i" expr="ADD(i,'1')"/>
                </while>

                <if condition="IS_NOEQUAL_STRING(usrTOAmt,sumamt)">
                    <set name="MsgTyp"       value="E"/>
                    <set name="RspCod"       value="23456"/>
                    <set name="RspMsg"       value="订单金额不一致"/>
                    <return/>
                </if>
              
                <!--更新批量付款订单状态为等待处理-->
                <set name="BatSTATUS"    value="01"/>
                <do func="ExecSql">
                   <para name="SqlCmd" sql="UpdBatCasSts"/>
                </do>
                <if condition="#RetCod!=0">
                   <set name="MsgTyp"    value="E"/>
                   <set name="RspCod"    value="09999"/>
                   <set name="RspMsg"    value="系统错误"/>
                   <do func="RollBackWork" />
                   <return/>
                </if>
             </if>
             <else><!--取消付款-->
                <do func="ExecSql" error="IGNORE">
                  <para name="SqlCmd" sql="delMerTraApply"/>
                </do>
                <if condition="#RetCod!=0">
                  <set name="RspCod"    value="02103"/>
                  <set name="RspMsg"    value="取消付款失败!"/>
                  <return/>
                </if>
                <do func="ExecSql" error="IGNORE">
                  <para name="SqlCmd" sql="delMerTraApplyByBatNo"/>
                </do>
                <if condition="#RetCod!=0">
                  <set name="RspCod"    value="02103"/>
                  <set name="RspMsg"    value="取消付款失败!"/>
                  <return/>
                </if>
             </else>
           </elseif>
           <else>
             <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/account/accountPayment.jsp')" />
           </else>

           <set name="RspCod"               value="00000"/>
           <set name="RspMsg"               value="交易成功"/>
       </process>
    </transaction>
    
    <transaction code="timeAccountPayment" desc="商户批量付款-定时任务">
       <sql name="selNewMerCasApply">
          select * from (select * from BatchCollectInf where BATSTATUS='01' order by crtdat desc)  where  rownum=1
       </sql>
       <sql name="selMerCasByBat">
         select * from STPCASPAYINF where batno=#{batno}
       </sql>
       <sql name="SelMerStatus">  <!--查询客户账户状态 -->
        select a.AC_STATUS,a.PAY_AC_NO
        from ARP_AC_PROFILE a,ARP_AC_CUST_REL b where a.PAY_AC_NO=b.PAY_AC_NO 
        and b.cust_id =#{CUST_ID} and a.AC_TYPE='01'
       </sql>
       <sql name="SelUBANKNO">
        SELECT UBANK_NO,BankNam FROM StpBnkCde WHERE BankCode=#{BankCode}
       </sql>
       <sql name="UpdBnkPay"><!--更新银行代付信息-->
         REQUEST_SN = #{REQUEST_SN}
       </sql>
       <sql name="UpdCasStatus">
         UPDATE STPCASPAYINF SET SUCDAT=#{SucDat},ORDSTATUS=#{ORDSTATUS},BANKERROR=#{ERROR} WHERE CASORDNO=#{CASORDNO}
       </sql>
       <sql name="UpdFrezInf"><!-- 更新冻结信息-->
         UPDATE ARP_AC_FORZZ_DETAILS SET STATUS='00',LST_UPT_DATE=#{LST_UPT_DATE},LST_UPT_TIME=#{LST_UPT_TIME} WHERE FROZ_NO=#{FROZ_NO}
       </sql>
       <sql name="UpdBatCasSts"> <!-- 更新转账订单表 -->
         UPDATE BatchCollectInf SET BatSTATUS=#{BatSTATUS} WHERE batno=#{batno}
       </sql>
       <sql name="SelFrzInf">
        select PAY_AC_NO,FROZ_AMT,BIZ_CODE,STATUS,FROZ_NO from ARP_AC_FORZZ_DETAILS where BIZ_CODE=#{CASORDNO} and STATUS='01'
       </sql>
       <process> 
           <if condition="IS_NOEQUAL_STRING(SysCod,'2201')">
             <set name="MsgTyp"       value="E"/>
             <set name="RspCod"       value="01001"/>
             <set name="RspMsg"       value="商户登录平台不正确"/>
             <return/>
           </if>
           
           <do func="ReadRecord"             error="IGNORE">
             <para name="SqlCmd"             sql="selNewMerCasApply"/>
           </do>
           <if condition="#RetCod==2">
             <set name="RSPCOD"              value="09999"/>
             <set name="RSPMSG"              value="暂无需要处理的付款申请!"/>
             <return/>
           </if>
           <elseif condition="#RetCod==0">
              <do func="QueryInGroup" error="IGNORE">
                <para name="SqlCmd"     sql="selMerCasByBat"/>
                <para name="RecordName" value="MerCasApplyList"/>
                <para name="RecNum"     value="MerCasApplyRECNUM"/>
              </do>
              <if condition="#RetCod==2">
                <set name="RSPCOD"              value="09999"/>
                <set name="RSPMSG"              value="暂无需要处理的付款申请!"/>
                <return/>
              </if>
              <elseif condition="#RetCod==0">
                 <!--更新批量付款订单状态为处理中-->
                 <set name="BatSTATUS"    value="02"/>
                 <do func="ExecSql">
                    <para name="SqlCmd" sql="UpdBatCasSts"/>
                 </do>
                 <if condition="#RetCod!=0">
                    <set name="MsgTyp"    value="E"/>
                    <set name="RspCod"    value="09999"/>
                    <set name="RspMsg"    value="系统错误"/>
                    <do func="RollBackWork" />
                    <return/>
                 </if>
                
                 <!-- 查询商户帐号信息 -->
                 <do func="ReadRecord"       error="IGNORE">
                    <para name="SqlCmd"       sql="SelMerStatus"/>
                 </do>
                 <set name="AC_STATUS"       expr="AC_STATUS"/>
                 <if condition="IS_EQUAL_STRING(AC_STATUS,'2')">
                    <set name="MsgTyp"    value="E"/>
                    <set name="RspCod"    value="01003"/>
                    <set name="RspMsg"    value="商户账户已经被冻结，不能付款操作！"/>
                    <return/>
                 </if>
                
                 <foreach name="MerCasApplyList"       iterator="#CAS">
                    <set name="CASORDNO"         expr="#CAS.CASORDNO"/>   
                    <set name="CUST_ID"          expr="#CAS.CUST_ID"/> 
                    <set name="ORDSTATUS"        expr="#CAS.ORDSTATUS"/>    
                    <set name="TXAMT"            expr="#CAS.TXAMT"/>
                    <set name="FEE"              expr="#CAS.FEE"/>
                    <set name="BANKCODE"         expr="#CAS.BANKCODE"/>
                    <set name="BANKPAYACNO"      expr="#CAS.BANKPAYACNO"/>
                    <set name="BANKPAYUSERNM"    expr="#CAS.BANKPAYUSERNM"/>
                    <if condition="OR(ISNULL(CASORDNO),IS_EQUAL_STRING(CASORDNO,''),ISNULL(CUST_ID),IS_EQUAL_STRING(CUST_ID,''),ISNULL(ORDSTATUS),IS_EQUAL_STRING(ORDSTATUS,''),ISNULL(BANKPAYACNO),IS_EQUAL_STRING(BANKPAYACNO,''))">
                      <set name="RspMsg"       value="无效数据，默认跳过！"/>
                      <continue/>
                    </if>
                    <if condition="OR(ISNULL(TXAMT),IS_EQUAL_STRING(TXAMT,''),ISNULL(FEE),IS_EQUAL_STRING(FEE,''),ISNULL(BANKCODE),IS_EQUAL_STRING(BANKCODE,''),ISNULL(BANKPAYUSERNM),IS_EQUAL_STRING(BANKPAYUSERNM,''))">
                      <set name="RspMsg"       value="无效数据，默认跳过！"/>
                      <continue/>
                    </if>
                    <if condition="IS_EQUAL_STRING(ORDSTATUS,'01')">
                      <set name="RspMsg"         value="该订单已提现成功，跳过！"/>
                      <continue/>
                    </if>
                    <elseif condition="IS_EQUAL_STRING(ORDSTATUS,'02')">
                       <set name="RspMsg"        value="订单状态已经是提现失败，不能进行更新。跳过！"/>
                       <continue/>
                    </elseif>
                    
                    <!--线上提现，则接入银行提现接口代码-->
                    <set name="bankcode"      expr="bankcode"/><!--银行编码-->
                    <set name="bankpayusernm" expr="BANKPAYUSERNM"/><!--收款人姓名-->
                    <set name="bankpayacno"   expr="DES_DECRYPT(BANKPAYACNO)"/><!--收款卡号-->
                     
                    <!--获取序号 -->
                    <do func="GetSeqNo"  error="IGNORE">
                       <para name="TblNam"   value="stpseqrec"/>
                       <para name="KeyNam"   value="KeyNam"/>
                       <para name="KeyVal"   expr="STRCAT('StpBnkPay','REQUEST_SN')"/>
                       <para name="SeqNam"   value="KeyVal"/>
                       <para name="Len"      value="8"/>
                       <para name="Circle"   value="1"/>
                    </do>
                    <if condition="#RetCod!=0">
                       <set name="MsgTyp"    value="E"/>
                       <set name="RspCod"    value="09001"/>
                       <set name="RspMsg"    value="获取序号错误"/>
                       <return/>
                    </if>
                    <set name="REQUEST_SN"   expr="STRCAT(SUBSTR(ActDat,0,8),KeyVal)"/>
                    
                    <!--读取xml参数-->
                    <set name="ConfigName"   value="StpBnkPayCfg"/>
                    <quote name="ReadXmlCfg"/>
                    <set name="USEOF"    value="商户代发"/>
                     
                    <set name="TXAMT"              expr="TXAMT"/>
                    <set name="PayTyp"             value="02"/><!--代发类型 00-用户提现代发 01-商户结算代发 02-商户付款代发-->
                    <set name="PaySts"             value="00"/><!--00:等待处理 01:交易成功 02:交易失败-->
                    <set name="RECV_ACC_NAME"      expr="bankpayusernm"/>
                    <set name="ACC_NO2"            expr="bankpayacno"/>
                    
                    <!--登记银行代付信息-->
                    <do func="InsertRecord" error="IGNORE">
                       <para name="TblNam"   value="StpBnkPay" />
                    </do>
                    <if condition="#RetCod!=0">
                       <set name="MsgTyp"    value="E"/>
                       <set name="RspCod"    value="09999"/>
                       <set name="RspMsg"    value="系统错误"/>
                       <return/>
                    </if>
                    
                    <set name="AMOUNT"     expr="AMTADDDOT(TXAMT)"/> <!--代发金额-->
                    <if condition="IS_EQUAL_STRING(BANKCODE, '01050000')"><!--建行-->
                       <set name="ThdCde"              value="6W8010"/>
                       <set name="UBANK_NO"            value="56888"/>
                       <set name="RECV_EXCHANGENO"     value="56888"/>
                       <set name="RECV_OPENACC_DEPT"   value="广东省分行"/>
                       <set name="RECV_COUNTERNO"      value="440000000"/>
                    </if>
                    <else>
                       <set name="ThdCde"    value="6W8060"/>
                       <do func="ReadRecord"><!--获取超级网银联行号-->
                         <para name="SqlCmd" sql="SelUBANKNO" />
                       </do>
                       <if condition="#RetCod!=0">
                         <set name="RSPCOD" value="02040"/>
                         <set name="RspMsg" value="超级网银联行号不存在，请联系系统管理"/>
                         <return/>
                       </if>
                       
                       <set name="UBANK_NO"          expr="UBANK_NO"/><!--转入账户联行号-->
                       <set name="RECV_OPENACC_DEPT" expr="BankNam"/><!--转入账户开户机构名称-->
                    </else>
                    
                    <!--调用建行企业网银转账-->
                    <!--do func="CallThird" error="IGNORE">
                       <para name="channel"  value="STHDCCB1"/>
                       <para name="code"     expr="ThdCde"/>
                    </do-->
                    <set name="#RetCod" value="0"/>
                    <set name="RETURN_CODE" value="000000"/>
                    <if condition="OR(#RetCod==1,#RetCod==10,#RetCod==-1)">
                      <if condition="ISNULL(RETURN_CODE)"><!--超时需线下业务人工处理-->
                        <set name="PaySts"       value="00"/><!--00:等待处理 01:交易成功 02:交易失败-->
                      </if>
                      <else>
                        <if condition="IS_NOEQUAL_STRING(RETURN_CODE,'000000')">
                          <set name="PaySts"     value="02"/><!--00:等待处理 01:交易成功 02:交易失败-->
                        </if>
                        <else>
                          <set name="PaySts"     value="01"/><!--00:等待处理 01:交易成功 02:交易失败-->
                        </else>
                      </else>
                      <set name="RETURN_CODE"  expr="RETURN_CODE"/>
                      <set name="RETURN_MSG"   expr="RETURN_MSG"/>
                    </if>
                    <elseif condition="#RetCod==0">
                      <if condition="IS_EQUAL_STRING(RETURN_CODE,'000000')">
                        <set name="PaySts"       value="01"/><!--00:等待处理 01:交易成功 02:交易失败-->
                      </if>
                      <elseif condition="IS_EQUAL_STRING(RETURN_CODE,'WLPT_Err1001')"><!--银企直连客户端与建行通讯超时-->
                        <set name="PaySts"       value="00"/><!--00:等待处理 01:交易成功 02:交易失败-->
                      </elseif>
                      <else>
                        <set name="PaySts"       value="02"/><!--00:等待处理 01:交易成功 02:交易失败-->
                      </else>
                      <set name="RETURN_CODE"   expr="RETURN_CODE"/>
                      <set name="RETURN_MSG"    expr="RETURN_MSG"/>
                    </elseif>
                    <else>
                      <set name="PaySts"         value="02"/><!--00:等待处理 01:交易成功 02:交易失败-->
                      <set name="RETURN_CODE"    expr="RETURN_CODE"/>
                      <set name="RETURN_MSG"     expr="RETURN_MSG"/>
                    </else>
                    
                    <!--更新银行代付信息-->
                    <do func="UpdateRecord" error="IGNORE">
                       <para name="TblNam"   value="StpBnkPay"/>
                       <para name="CndSts"   sql="UpdBnkPay"/>
                    </do>
                    <if condition="#RetCod!=0">
                       <set name="MsgTyp"    value="E"/>
                       <set name="RspCod"    value="09999"/>
                       <set name="RspMsg"    value="系统错误"/>
                       <return/>
                    </if>
                    
                    <do func="CommitWork"/>
                    
                    <!-- 提现成功 -->
                    <if condition="IS_EQUAL_STRING(PaySts,'01')">
                      <set name="SucDat"       expr="GETDATETIME()"/>
                      <set name="ORDSTATUS"     value="01"/>
                      <quote name="SelFrzInf"/>
                      
                      <!--将扣除的提现金额解冻 并从账户里扣除-->
                      <set name="RCS_PRD_NO"    expr="CASORDNO"/><!--订单号，如果不涉及置空-->
                      <set name="PAY_AC_NO"     expr="PAY_AC_NO"/>
                      <set name="txAmt"         expr="STRCAT('-',FROZ_AMT)"/>
                      <quote name="frezzAmt"/>
                      <set name="txAmt"         expr="FROZ_AMT"/>
                      <!--更新冻结状态-->
                      <quote name="UpdFrezz"/>
                      
                      <set name="usrPar"       expr="STRCAT(CUST_ID,'/','01','/','-','/','CNY','/',ADD(TXAMT,FEE),'/','Y','/')"/>  <!--用户记账参数-->  
                      <set name="PARAMS"       expr="usrPar"/>
                      <!--记账处理-->
                      <set name="TXN_TYP"      value="4"/>      <!--用途 4 提现-->
                      <set name="prdordno"     expr="CASORDNO"/>
                      <quote name="accProcess"/>
                      <if condition="#RetCod!=0">
                        <set name="RspCod"     value="08042"/>
                        <set name="RspMsg"     value="提现失败"/>
                        <set name="DWZ_STATUS_CODE" value="300"/>
                        <set name="DWZ_RSP_MSG"  expr="RSPMSG"/>
                        <do func="RollBackWork"/>
                        <return/>
                      </if>
                      <set name="ERROR"  value=""/>
                      <!-- 更新提现订单 -->
                      <do func="ExecSql" >
                        <para name="SqlCmd" sql="UpdCasStatus"/>
                      </do>
                      <if condition="#RetCod!=0">
                        <set name="RspCod"     value="08042"/>
                        <set name="RspMsg"     value="提现失败"/>
                        <set name="DWZ_STATUS_CODE" value="300"/>
                        <set name="DWZ_RSP_MSG"  expr="RSPMSG"/>
                        <do func="RollBackWork"/>
                        <return/>
                      </if>
                      <set name="retCode"   value="0001"/>
                    </if>
                    <elseif condition="IS_EQUAL_STRING(PaySts,'02')"><!--提现失败-->
                      <set name="ORDSTATUS"    value="02"/>
                      <set name="SucDat"       value=""/>
                      
                      <quote name="SelFrzInf"/>
                      <!--将提现金额解冻、退回支付账号 -->
                      <set name="RCS_PRD_NO"   expr="CASORDNO"/><!--订单号，如果不涉及置空-->
                      <set name="PAY_AC_NO"    expr="PAY_AC_NO"/>
                      <set name="txAmt"        expr="STRCAT('-',FROZ_AMT)"/>
                      <quote name="frezzAmt"/>
                      <set name="txAmt"        expr="FROZ_AMT"/>
                      <!--更新冻结状态-->
                      <quote name="UpdFrezz"/>
                      
                      <set name="ERROR"  expr="RETURN_MSG"/>
                      <!-- 更新提现订单 -->
                      <do func="ExecSql" >
                        <para name="SqlCmd" sql="UpdCasStatus"/>
                      </do>
                      <if condition="#RetCod!=0">
                        <set name="RspCod"    value="08042"/>
                        <set name="RspMsg"    value="提现失败"/>
                        <set name="DWZ_STATUS_CODE" value="300"/>
                        <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
                        <do func="RollBackWork"/>
                        <return/>
                      </if>
                      <set name="retCode"   value="0002"/>
                      <set name="RspMsg"    value="提现失败"/>
                      <return/>
                    </elseif>
                    <else><!--提现超时状态不明，暂不做处理-->
                       <set name="RspCod"    value="00000"/>
                       <set name="retCode"  value="0003"/>
                       <set name="RspMsg"   value="提现超时状态不明，请等待"/>
                       <return/>
                    </else>

                    <!-- 删除节点 PAT_AC_NO一个批次中不会变 无需删除-->
                    <delete name="CASORDNO"/>
                    <delete name="CUST_ID"/>
                    <delete name="ORDSTATUS"/>
                    <delete name="FEE"/>
                    <delete name="BANKCODE"/>
                    <delete name="BANKPAYACNO"/>
                    <delete name="BANKPAYUSERNM"/>
                 </foreach>
                 
                 <!--更新批量付款订单状态为已完成-->
                 <set name="BatSTATUS"    value="03"/>
                 <do func="ExecSql">
                    <para name="SqlCmd" sql="UpdBatCasSts"/>
                 </do>
                 <if condition="#RetCod!=0">
                    <set name="MsgTyp"    value="E"/>
                    <set name="RspCod"    value="09999"/>
                    <set name="RspMsg"    value="系统错误"/>
                    <do func="RollBackWork" />
                    <return/>
                 </if>
              </elseif>
              <else condition="#RetCod!=0">
                <set name="RspCod"    value="09101"/>
                <set name="RspMsg"    value="系统内部错误！!"/>
                <return/>
              </else>
           </elseif>
           <else>
             <set name="MsgTyp"       value="E"/>
             <set name="RspCod"       value="01002"/>
             <set name="RspMsg"       value="系统内部错误！"/>
             <return/>
           </else>

           <set name="RspCod"               value="00000"/>
           <set name="RspMsg"               value="交易成功"/>
       </process>
    </transaction>
    
    <transaction code="netWithdrawRecord" desc="商户提现交易查询">
       <sql name="QMerTotalWithdraw">
         select count(*) as TOTALRECNUMS,TO_CHAR(to_number(nvl(sum(ordamt),0))/100,'FM9999,999,999,990.00') TOTALPRDAMT
         from (
               select distinct a.ordstatus,a.casordno,To_Char(to_date(a.actdat,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') actdat,a.bankpayusernm,a.bankpayacno,trim(b.ISSNAM) BANKNAME,TO_CHAR(to_number(nvl(a.txamt,0))/100,'FM9999,999,999,990.00') as txamt,a.txamt ordamt
               from stpcasinf a,unionfit b
               where a.cust_id=#{merid} and trim(a.bankcode)=trim(b.ISSNO) ${ordprdOrdNo} ${prdOrdStatus} ${orderDate}  ${prdordamt} ${ordprdName}
         ) 
       </sql>
       <sql name="QMerOrdInfoAll">
         select distinct a.ordstatus,a.casordno,To_Char(to_date(a.actdat,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') actdat,a.bankpayusernm,a.bankpayacno,trim(b.ISSNAM) BANKNAME,TO_CHAR(to_number(nvl(a.txamt,0))/100,'FM9999,999,999,990.00') as txamt
         from stpcasinf a,unionfit b
         where a.cust_id=#{merid} and trim(a.bankcode)=trim(b.ISSNO) ${ordprdOrdNo} ${prdOrdStatus} ${orderDate}  ${prdordamt} ${ordprdName}
         order by actdat desc
       </sql>
     <process>
         
         <if condition="IS_EQUAL_STRING(OPERATING,'0')">
              <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/tranRecord.jsp')" />
         </if>
         <else>
            <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/OnlineTradRecd.jsp')" />
         </else>
         
         <set name="FLAG"        value="03"/>
         <set name="merid"       expr="SESSIONS.MERID"/>
         
         <!-- 分页参数定义 -->
         <if condition="ISNULL(PageNum)">
            <set name="PageNum" value="1"/>
         </if>
         <if condition="ISNULL(NumPerPag)">
            <set name="NumPerPag" value="10"/>
         </if>
           <set name="Fh" value="'" />
           
           <!--商品订单号 -->
           <if condition="IS_EQUAL_STRING(prdOrdNo,'')">
                <set name="ordprdOrdNo" value=""/>
           </if>
           <else>
                <set name="ordprdOrdNo" expr="STRCAT(' and a.casordno = ',fh,prdOrdNo,fh)"/>
           </else>
           
           <!--收款人名称 -->
           <if condition="IS_EQUAL_STRING(prdName,'')">
                <set name="ordprdName"  value=""/>
           </if>
           <else>
                <set name="ordprdName"  expr="STRCAT(' and a.bankpayusernm like ',fh,'%',prdName,'%',fh)"/>
           </else>
           
           <!--订单状态--> 
           <if condition="IS_EQUAL_STRING(OrdStatus,'')">
                <set name="prdOrdStatus"     value=""/>
           </if>
           <else>
                <set name="prdOrdStatus"    expr="STRCAT(' and a.OrdStatus = ',fh,OrdStatus,fh)"/>
           </else>
           
           <!--订单最小金额 -->
           <if condition="ISNULL(minAmt)">
                <set name="minAmt"     value=""/>
           </if>
           <else>
               <set name="minAmt"            expr="AMTPOWER(minAmt,2)"/>
           </else>
           <!--订单最大金额 -->
           <if condition="ISNULL(maxAmt)">
                <set name="maxAmt"     value=""/>
           </if>
           <else>
               <set name="maxAmt"        expr="AMTPOWER(maxAmt,2)"/>
           </else>
           <if condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt" value=""/>
           </if>
           <elseif condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_NOEQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and a.txAmt  &gt;= to_number(',Fh, minAmt ,Fh,')')" />
           </elseif>
           <elseif condition="AND(IS_NOEQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and  a.txAmt &lt;= to_number(',Fh, maxAmt ,Fh,')')" />
           </elseif>
           <else>
             <if condition="INTCMP(maxAmt,1,minAmt)">
                 <set name="RspCod" value="08040" />
                 <set name="RspMsg" value="最大金额小于最小金额" />
                 <return />
             </if>
             <set name="prdordamt"  expr="STRCAT(' and a.txAmt between to_number(\'',minAmt,'\') and to_number(\'',maxAmt,'\')')"/>
             
           </else>
           <!-- 开始和结束时间范围 -->
           <if condition="IS_EQUAL_STRING(STARTDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="startDate" expr="CALCDATE(GETDATE(),'-','d',30)" />
               <set name="startDate" expr="FMTDATE(startDate,0,4)"/>
               <set name="start_date"  expr="FMTDATE(STARTDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(STARTDATE),4,8)">
                   <set name="startDate"   expr="FMTDATE(STARTDATE,4,0)" />         <!-- 开始时间 -->
                   <set name="start_date"  expr="startDate"/>
               </if>
           </else>

           <if condition="IS_EQUAL_STRING(ENDDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="endDate"  expr="GETDATETIME('YYYYMMDD')" />
               <set name="endDate"  expr="FMTDATE(endDate,0,4)"/>
               <set name="end_date"  expr="FMTDATE(ENDDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(ENDDATE),4,8)">
                   <set name="endDate"   expr="FMTDATE(ENDDATE,4,0)" />       <!-- 结束时间 -->
                   <set name="end_date"  expr="endDate"/>
               </if>
           </else>
           
           <if condition="INTCMP(end_date,1,start_date)">
               <set name="RspCod" value="08040" />
               <set name="RspMsg" value="结束日期小于开始日期" />
               <return />
           </if>
           <set name="orderDate"  expr="STRCAT(' and a.actdat  &gt;= ',Fh, STRCAT(start_date,'000000'),Fh,' and  a.actdat &lt;=',Fh,STRCAT(end_date,'235959'),Fh)" />
           
           <!-- 统计成功的总笔数和总金额 -->
           <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QMerTotalWithdraw" />
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录!"/>
             <set name="TOTALRECNUMS" value="0"/>
             <set name="TOTALPRDAMT"  value="0.00"/>
           </if>
           <elseif condition="#RetCod!=0">
              <set name="RspCod"    value="09101"/>
              <set name="RspMsg"    value="操作数据库失败!"/>
              <return/>
           </elseif>
           
           <!--查询商品订单信息 -->
           <do func="PagedQuery" error="IGNORE">
                  <para name="PageNum" expr="PageNum"/>
                  <para name="NumPerPag" expr="NumPerPag"/>
                  <para name="RecordName" value="GRP" />
                  <para name="Sql" sql="QMerOrdInfoAll"/>
           </do>
           <if condition="#RetCod==2">
             <set name="MsgTyp"    value="N"/>
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录！!"/>
           </if>
           <elseif condition="#RetCod!=0">
             <set name="RspCod"    value="09101"/>
             <set name="RspMsg"    value="操作数据库失败!"/>
             <return/>
           </elseif>
           
           <foreach name="GRP" iterator="#grp">
                <set name="sDeData" expr="#grp.BANKPAYACNO" />
                <if condition="INTCMP(STRLEN(sDeData),1,32)">
                    <set name="First" expr="SUBSTR(sDeData,1,3)" />
                    <set name="End"   expr="SUBSTR(sDeData,SUB(STRLEN(sDeData),3),STRLEN(sDeData))" />
                    <set name="bankdata" expr="STRCAT(First,'****',End)" />
                    <set name="descryptdata" expr="End" />
                </if>
                <else>
                    <set name="sDeData" expr="DES_DECRYPT(sDeData)" />
                    <set name="First"   expr="SUBSTR(sDeData,1,3)" />
                    <set name="End"     expr="SUBSTR(sDeData,SUB(STRLEN(sDeData),3),STRLEN(sDeData))" />
                    <set name="bankdata" expr="STRCAT(First,'****',End)" />
                    <set name="descryptdata" expr="End" />
                </else>
                <do func="loopSetEach">
                    <para name="ele" expr="#grp.BANKPAYACNO" />
                    <para name="value" expr="bankdata" />
                </do>
                <if condition="#RetCod!=0">
                    <set name="RspCod" value="09998" />
                    <set name="RspMsg" value="系统错误" />
                    <set name="DWZ_STATUS_CODE" value="300" />
                    <set name="DWZ_RSP_MSG" expr="RspMsg" />
                    <return />
                </if>
           </foreach>
         
           <set name="ALLPAGENUM" expr="DIV(TOLCNT,NUMPERPAG)" />
           <set name="mob" expr="MOD(TOLCNT,NUMPERPAG)" />
           <if condition="IS_NOEQUAL_STRING(MOB,'0')">
              <set name="ALLPAGENUM" expr="ADD(ALLPAGENUM,1)" />
           </if>
           <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
              <set name="PageNum" expr="ALLPAGENUM" />
           </if>
           <if condition="INTCMP(ALLPAGENUM,6,'0')">
              <if condition="INTCMP(PageNum,3,'0')">
                 <set name="PageNum" value="1" />
              </if>
           </if>
         
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
    <transaction code="netTransferRecord" desc="商户转账交易查询">
       <sql name="QMerTotalTransfer">
         select count(*) as TOTALRECNUMS,TO_CHAR(to_number(nvl(sum(ordamt),0))/100,'FM9999,999,999,990.00') TOTALPRDAMT
         from (
               select To_Char(to_date(a.tratime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') tratime,a.traordno,a.ordstatus,TO_CHAR(to_number(nvl(a.txamt,0))/100,'FM9999,999,999,990.00') txamt,a.remark,a.getcusnam,b.cust_login,a.txamt ordamt
               from stptrainf a,stpusrinf b
               where tracusid=#{merid} and a.getcusid=b.cust_id ${ordprdOrdNo} ${prdOrdStatus} ${orderDate}  ${prdordamt} ${ordprdName}
               order by tratime desc
         ) 
       </sql>
       <sql name="QMerOrdInfoAll">
         select To_Char(to_date(a.tratime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') tratime,a.traordno,a.ordstatus,TO_CHAR(to_number(nvl(a.txamt,0))/100,'FM9999,999,999,990.00') txamt,a.remark,a.getcusnam,b.cust_login
         from stptrainf a,stpusrinf b
         where tracusid=#{merid} and a.getcusid=b.cust_id ${ordprdOrdNo} ${prdOrdStatus} ${orderDate}  ${prdordamt} ${ordprdName}
         order by tratime desc
       </sql>
     <process>
         
         <if condition="IS_EQUAL_STRING(OPERATING,'0')">
              <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/tranRecord.jsp')" />
         </if>
         <else>
            <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/OnlineTradRecd.jsp')" />
         </else>
         
         <set name="FLAG"        value="04"/>
         <set name="merid"       expr="SESSIONS.MERID"/>
         
         <!-- 分页参数定义 -->
         <if condition="ISNULL(PageNum)">
            <set name="PageNum" value="1"/>
         </if>
         <if condition="ISNULL(NumPerPag)">
            <set name="NumPerPag" value="10"/>
         </if>
           <set name="Fh" value="'" />
           
           <!--商品订单号 -->
           <if condition="IS_EQUAL_STRING(prdOrdNo,'')">
                <set name="ordprdOrdNo" value=""/>
           </if>
           <else>
                <set name="ordprdOrdNo" expr="STRCAT(' and a.traordno = ',fh,prdOrdNo,fh)"/>
           </else>
           
           <!--收款人名称 -->
           <if condition="IS_EQUAL_STRING(prdName,'')">
                <set name="ordprdName"  value=""/>
           </if>
           <else>
                <set name="ordprdName"  expr="STRCAT(' and a.getcusnam like ',fh,'%',prdName,'%',fh)"/>
           </else>
           
           <!--订单状态--> 
           <if condition="IS_EQUAL_STRING(OrdStatus,'')">
                <set name="prdOrdStatus"     value=""/>
           </if>
           <else>
                <set name="prdOrdStatus"    expr="STRCAT(' and a.OrdStatus = ',fh,OrdStatus,fh)"/>
           </else>
           
           <!--订单最小金额 -->
           <if condition="ISNULL(minAmt)">
                <set name="minAmt"     value=""/>
           </if>
           <else>
               <set name="minAmt"            expr="AMTPOWER(minAmt,2)"/>
           </else>
           <!--订单最大金额 -->
           <if condition="ISNULL(maxAmt)">
                <set name="maxAmt"     value=""/>
           </if>
           <else>
               <set name="maxAmt"        expr="AMTPOWER(maxAmt,2)"/>
           </else>
           <if condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt" value=""/>
           </if>
           <elseif condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_NOEQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and a.txAmt  &gt;= to_number(',Fh, minAmt ,Fh,')')" />
           </elseif>
           <elseif condition="AND(IS_NOEQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and  a.txAmt &lt;= to_number(',Fh, maxAmt ,Fh,')')" />
           </elseif>
           <else>
             <if condition="INTCMP(maxAmt,1,minAmt)">
                 <set name="RspCod" value="08040" />
                 <set name="RspMsg" value="最大金额小于最小金额" />
                 <return />
             </if>
             <set name="prdordamt"  expr="STRCAT(' and a.txAmt between to_number(\'',minAmt,'\') and to_number(\'',maxAmt,'\')')"/>
             
           </else>
           <!-- 开始和结束时间范围 -->
           <if condition="IS_EQUAL_STRING(STARTDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="startDate" expr="CALCDATE(GETDATE(),'-','d',30)" />
               <set name="startDate" expr="FMTDATE(startDate,0,4)"/>
               <set name="start_date"  expr="FMTDATE(STARTDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(STARTDATE),4,8)">
                   <set name="startDate"   expr="FMTDATE(STARTDATE,4,0)" />         <!-- 开始时间 -->
                   <set name="start_date"  expr="startDate"/>
               </if>
           </else>

           <if condition="IS_EQUAL_STRING(ENDDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="endDate"  expr="GETDATETIME('YYYYMMDD')" />
               <set name="endDate"  expr="FMTDATE(endDate,0,4)"/>
               <set name="end_date"  expr="FMTDATE(ENDDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(ENDDATE),4,8)">
                   <set name="endDate"   expr="FMTDATE(ENDDATE,4,0)" />       <!-- 结束时间 -->
                   <set name="end_date"  expr="endDate"/>
               </if>
           </else>
           
           <if condition="INTCMP(end_date,1,start_date)">
               <set name="RspCod" value="08040" />
               <set name="RspMsg" value="结束日期小于开始日期" />
               <return />
           </if>
           <set name="orderDate"  expr="STRCAT(' and a.tratime  &gt;= ',Fh, STRCAT(start_date,'000000'),Fh,' and  a.tratime &lt;=',Fh,STRCAT(end_date,'235959'),Fh)" />
           
           <!-- 统计成功的总笔数和总金额 -->
           <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QMerTotalTransfer" />
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录!"/>
             <set name="TOTALRECNUMS" value="0"/>
             <set name="TOTALPRDAMT"  value="0.00"/>
           </if>
           <elseif condition="#RetCod!=0">
              <set name="RspCod"    value="09101"/>
              <set name="RspMsg"    value="操作数据库失败!"/>
              <return/>
           </elseif>
           
           <!--查询商品订单信息 -->
           <do func="PagedQuery" error="IGNORE">
                  <para name="PageNum" expr="PageNum"/>
                  <para name="NumPerPag" expr="NumPerPag"/>
                  <para name="RecordName" value="GRP" />
                  <para name="Sql" sql="QMerOrdInfoAll"/>
             </do>
           <if condition="#RetCod==2">
             <set name="MsgTyp"    value="N"/>
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录！!"/>
           </if>
           <elseif condition="#RetCod!=0">
             <set name="RspCod"    value="09101"/>
             <set name="RspMsg"    value="操作数据库失败!"/>
             <return/>
           </elseif>
         
           <set name="ALLPAGENUM" expr="DIV(TOLCNT,NUMPERPAG)" />
           <set name="mob" expr="MOD(TOLCNT,NUMPERPAG)" />
           <if condition="IS_NOEQUAL_STRING(MOB,'0')">
              <set name="ALLPAGENUM" expr="ADD(ALLPAGENUM,1)" />
           </if>
           <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
              <set name="PageNum" expr="ALLPAGENUM" />
           </if>
           <if condition="INTCMP(ALLPAGENUM,6,'0')">
              <if condition="INTCMP(PageNum,3,'0')">
                 <set name="PageNum" value="1" />
              </if>
           </if>
         
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
    <transaction code="netPaymentDetail" desc="商户付款交易查询-详情">
       <sql name="QMerPaymentDetail">
         select TO_CHAR(to_date(ACTDAT,'yyyymmddhh24miss'),'yyyy-mm-dd  hh24:mi:ss') ACTDAT,
                TO_CHAR(to_number(TXAMT)/100,'FM9999,999,999,990.00') TXAMT,
                TO_CHAR(to_number(nvl(FEE,0))/100,'FM9999,999,999,990.00') FEE,
                DECRYPT_DES(BANKPAYACNO,'0123456789ABCDEF') AS BANKPAYACNO,CASORDNO,BANKPAYUSERNM,ORDSTATUS
         from STPCASPAYINF where batno=#{batno}
       </sql>
     <process>
         <do func="QueryInGroup" error="IGNORE">
             <para name="SqlCmd"     sql="QMerPaymentDetail"/>
             <para name="RecordName" value="GRP"/>
             <para name="RecNum"     value="RECNUM"/>
         </do>
         <if condition="#RetCod==2">
           <set name="MsgTyp"    value="N"/>
           <set name="RspCod"    value="02103"/>
           <set name="RspMsg"    value="无记录！!"/>
         </if>
         <elseif condition="#RetCod!=0">
           <set name="RspCod"    value="09101"/>
           <set name="RspMsg"    value="操作数据库失败!"/>
           <return/>
         </elseif>
         
         <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/trandetail.jsp')" />
         
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
        <transaction code="netPaymentRecord" desc="商户付款交易查询">
       <sql name="QMerTotalTransfer">
         select count(*) as TOTALRECNUMS,TO_CHAR(to_number(nvl(sum(ordamt),0))/100,'FM9999,999,999,990.00') TOTALPRDAMT
         from (
               select To_Char(to_date(a.CRTDAT,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') tratime,a.BATNO,a.BATSTATUS,TO_CHAR(to_number(nvl(a.SUMAMT,0))/100,'FM9999,999,999,990.00') txamt,a.RCOUNT,a.SUMAMT ordamt
               from BatchCollectInf a
               where CUST_ID=#{merid} ${ordprdOrdNo} ${prdOrdStatus} ${orderDate}  ${prdordamt}
               order by tratime desc
         ) 
       </sql>
       <sql name="QMerOrdInfoAll">
         select To_Char(to_date(a.CRTDAT,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') tratime,a.BATNO,a.BATSTATUS,TO_CHAR(to_number(nvl(a.SUMAMT,0))/100,'FM9999,999,999,990.00') txamt,a.RCOUNT
         from BatchCollectInf a
         where CUST_ID=#{merid} ${ordprdOrdNo} ${prdOrdStatus} ${orderDate}  ${prdordamt}
         order by tratime desc
       </sql>
     <process>
         
         <if condition="IS_EQUAL_STRING(OPERATING,'0')">
              <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/tranRecord.jsp')" />
         </if>
         <else>
            <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/OnlineTradRecd.jsp')" />
         </else>
         
         <set name="FLAG"        value="05"/>
         <set name="merid"       expr="SESSIONS.MERID"/>
         
         <!-- 分页参数定义 -->
         <if condition="ISNULL(PageNum)">
            <set name="PageNum" value="1"/>
         </if>
         <if condition="ISNULL(NumPerPag)">
            <set name="NumPerPag" value="10"/>
         </if>
           <set name="Fh" value="'" />
           
           <!--批次号 -->
           <if condition="IS_EQUAL_STRING(prdOrdNo,'')">
                <set name="ordprdOrdNo" value=""/>
           </if>
           <else>
                <set name="ordprdOrdNo" expr="STRCAT(' and a.BATNO = ',fh,prdOrdNo,fh)"/>
           </else>

           <!--订单状态--> 
           <if condition="IS_EQUAL_STRING(OrdStatus,'')">
                <set name="prdOrdStatus"     value=""/>
           </if>
           <else>
                <set name="prdOrdStatus"    expr="STRCAT(' and a.BATSTATUS = ',fh,OrdStatus,fh)"/>
           </else>
           
           <!--订单最小金额 -->
           <if condition="ISNULL(minAmt)">
                <set name="minAmt"     value=""/>
           </if>
           <else>
               <set name="minAmt"            expr="AMTPOWER(minAmt,2)"/>
           </else>
           <!--订单最大金额 -->
           <if condition="ISNULL(maxAmt)">
                <set name="maxAmt"     value=""/>
           </if>
           <else>
               <set name="maxAmt"        expr="AMTPOWER(maxAmt,2)"/>
           </else>
           <if condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt" value=""/>
           </if>
           <elseif condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_NOEQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and a.SUMAMT  &gt;= to_number(',Fh, minAmt ,Fh,')')" />
           </elseif>
           <elseif condition="AND(IS_NOEQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and  a.SUMAMT &lt;= to_number(',Fh, maxAmt ,Fh,')')" />
           </elseif>
           <else>
             <if condition="INTCMP(maxAmt,1,minAmt)">
                 <set name="RspCod" value="08040" />
                 <set name="RspMsg" value="最大金额小于最小金额" />
                 <return />
             </if>
             <set name="prdordamt"  expr="STRCAT(' and a.SUMAMT between to_number(\'',minAmt,'\') and to_number(\'',maxAmt,'\')')"/>
             
           </else>
           <!-- 开始和结束时间范围 -->
           <if condition="IS_EQUAL_STRING(STARTDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="startDate" expr="CALCDATE(GETDATE(),'-','d',30)" />
               <set name="startDate" expr="FMTDATE(startDate,0,4)"/>
               <set name="start_date"  expr="FMTDATE(STARTDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(STARTDATE),4,8)">
                   <set name="startDate"   expr="FMTDATE(STARTDATE,4,0)" />         <!-- 开始时间 -->
                   <set name="start_date"  expr="startDate"/>
               </if>
           </else>

           <if condition="IS_EQUAL_STRING(ENDDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="endDate"  expr="GETDATETIME('YYYYMMDD')" />
               <set name="endDate"  expr="FMTDATE(endDate,0,4)"/>
               <set name="end_date"  expr="FMTDATE(ENDDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(ENDDATE),4,8)">
                   <set name="endDate"   expr="FMTDATE(ENDDATE,4,0)" />       <!-- 结束时间 -->
                   <set name="end_date"  expr="endDate"/>
               </if>
           </else>
           
           <if condition="INTCMP(end_date,1,start_date)">
               <set name="RspCod" value="08040" />
               <set name="RspMsg" value="结束日期小于开始日期" />
               <return />
           </if>
           <set name="orderDate"  expr="STRCAT(' and a.CRTDAT  &gt;= ',Fh, STRCAT(start_date,'000000'),Fh,' and  a.CRTDAT &lt;=',Fh,STRCAT(end_date,'235959'),Fh)" />
           
           <!-- 统计成功的总笔数和总金额 -->
           <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QMerTotalTransfer" />
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录!"/>
             <set name="TOTALRECNUMS" value="0"/>
             <set name="TOTALPRDAMT"  value="0.00"/>
           </if>
           <elseif condition="#RetCod!=0">
              <set name="RspCod"    value="09101"/>
              <set name="RspMsg"    value="操作数据库失败!"/>
              <return/>
           </elseif>
           
           <!--查询商品订单信息 -->
           <do func="PagedQuery" error="IGNORE">
                  <para name="PageNum" expr="PageNum"/>
                  <para name="NumPerPag" expr="NumPerPag"/>
                  <para name="RecordName" value="GRP" />
                  <para name="Sql" sql="QMerOrdInfoAll"/>
             </do>
           <if condition="#RetCod==2">
             <set name="MsgTyp"    value="N"/>
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录！!"/>
           </if>
           <elseif condition="#RetCod!=0">
             <set name="RspCod"    value="09101"/>
             <set name="RspMsg"    value="操作数据库失败!"/>
             <return/>
           </elseif>
         
           <set name="ALLPAGENUM" expr="DIV(TOLCNT,NUMPERPAG)" />
           <set name="mob" expr="MOD(TOLCNT,NUMPERPAG)" />
           <if condition="IS_NOEQUAL_STRING(MOB,'0')">
              <set name="ALLPAGENUM" expr="ADD(ALLPAGENUM,1)" />
           </if>
           <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
              <set name="PageNum" expr="ALLPAGENUM" />
           </if>
           <if condition="INTCMP(ALLPAGENUM,6,'0')">
              <if condition="INTCMP(PageNum,3,'0')">
                 <set name="PageNum" value="1" />
              </if>
           </if>
         
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
        
    <transaction code="exportWithdrawRecord" desc="导出商户提现交易记录">
       <sql name="QMerTotalWithdraw">
         select count(*) as TOTALRECNUMS,TO_CHAR(to_number(nvl(sum(ordamt),0))/100,'FM9999,999,999,990.00') TOTALPRDAMT
         from (
               select distinct a.ordstatus,a.casordno,To_Char(to_date(a.actdat,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') actdat,a.bankpayusernm,a.bankpayacno,trim(b.ISSNAM) BANKNAME,TO_CHAR(to_number(nvl(a.txamt,0))/100,'FM9999,999,999,990.00') as txamt,a.txamt ordamt
               from stpcasinf a,unionfit b
               where a.cust_id=#{merid} and trim(a.bankcode)=trim(b.ISSNO) ${ordprdOrdNo} ${prdOrdStatus} ${orderDate}  ${prdordamt} ${ordprdName}
         ) 
       </sql>
       <sql name="QMerOrdInfoAll">
         select distinct a.casordno,
         case when  a.ordstatus = '00' then '等待处理'  when  a.ordstatus = '01' then '交易成功'  when  a.ordstatus = '02' then '交易失败' else '未知' end ordstatus,
         To_Char(to_date(a.actdat,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') actdat,a.bankpayusernm,a.bankpayacno,trim(b.ISSNAM) BANKNAME,TO_CHAR(to_number(nvl(a.txamt,0))/100,'FM9999,999,999,990.00') as txamt
         from stpcasinf a,unionfit b
         where a.cust_id=#{merid} and trim(a.bankcode)=trim(b.ISSNO) ${ordprdOrdNo} ${prdOrdStatus} ${orderDate}  ${prdordamt} ${ordprdName}
         order by actdat desc
       </sql>
     <process>
                 
         <set name="FLAG"        value="01"/>
         <set name="merid"       expr="SESSIONS.MERID"/>

           <set name="Fh" value="'" />
           
           <!--商品订单号 -->
           <if condition="IS_EQUAL_STRING(prdOrdNo,'')">
                <set name="ordprdOrdNo" value=""/>
           </if>
           <else>
                <set name="ordprdOrdNo" expr="STRCAT(' and a.casordno = ',fh,prdOrdNo,fh)"/>
           </else>
           
           <!--订单状态--> 
           <if condition="IS_EQUAL_STRING(OrdStatus,'')">
                <set name="prdOrdStatus"     value=""/>
           </if>
           <else>
                <set name="prdOrdStatus"    expr="STRCAT(' and a.OrdStatus = ',fh,OrdStatus,fh)"/>
           </else>
           
            <!--收款人名称 -->
           <if condition="IS_EQUAL_STRING(prdName,'')">
                <set name="ordprdName"  value=""/>
           </if>
           <else>
                <set name="ordprdName"  expr="STRCAT(' and a.bankpayusernm like ',fh,'%',prdName,'%',fh)"/>
           </else>
           
           <!--订单最小金额 -->
           <if condition="ISNULL(minAmt)">
                <set name="minAmt"     value=""/>
           </if>
           <else>
               <set name="minAmt"            expr="AMTPOWER(minAmt,2)"/>
           </else>
           <!--订单最大金额 -->
           <if condition="ISNULL(maxAmt)">
                <set name="maxAmt"     value=""/>
           </if>
           <else>
               <set name="maxAmt"        expr="AMTPOWER(maxAmt,2)"/>
           </else>
           <if condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt" value=""/>
           </if>
           <elseif condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_NOEQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and a.txAmt  &gt;= to_number(',Fh, minAmt ,Fh,')')" />
           </elseif>
           <elseif condition="AND(IS_NOEQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and  a.txAmt &lt;= to_number(',Fh, maxAmt ,Fh,')')" />
           </elseif>
           <else>
             <if condition="INTCMP(maxAmt,1,minAmt)">
                 <set name="RspCod" value="08040" />
                 <set name="RspMsg" value="最大金额小于最小金额" />
                 <return />
             </if>
             <set name="prdordamt"  expr="STRCAT(' and a.txAmt between to_number(\'',minAmt,'\') and to_number(\'',maxAmt,'\')')"/>
             
           </else>
           <!-- 开始和结束时间范围 -->
           <if condition="IS_EQUAL_STRING(STARTDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="startDate" expr="CALCDATE(GETDATE(),'-','d',30)" />
               <set name="startDate" expr="FMTDATE(startDate,0,4)"/>
               <set name="start_date"  expr="FMTDATE(STARTDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(STARTDATE),4,8)">
                   <set name="startDate"   expr="FMTDATE(STARTDATE,4,0)" />         <!-- 开始时间 -->
                   <set name="start_date"  expr="startDate"/>
               </if>
           </else>

           <if condition="IS_EQUAL_STRING(ENDDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="endDate"  expr="GETDATETIME('YYYYMMDD')" />
               <set name="endDate"  expr="FMTDATE(endDate,0,4)"/>
               <set name="end_date"  expr="FMTDATE(ENDDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(ENDDATE),4,8)">
                   <set name="endDate"   expr="FMTDATE(ENDDATE,4,0)" />       <!-- 结束时间 -->
                   <set name="end_date"  expr="endDate"/>
               </if>
           </else>
           
           <if condition="INTCMP(end_date,1,start_date)">
               <set name="RspCod" value="08040" />
               <set name="RspMsg" value="结束日期小于开始日期" />
               <return />
           </if>
           <set name="orderDate"  expr="STRCAT(' and a.actdat  &gt;= ',Fh, STRCAT(start_date,'000000'),Fh,' and  a.actdat &lt;=',Fh,STRCAT(end_date,'235959'),Fh)" />
           
           <!-- 统计成功的总笔数和总金额 -->
           <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QMerTotalWithdraw" />
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录!"/>
             <set name="TOTALRECNUMS" value="0"/>
             <set name="TOTALPRDAMT"  value="0.00"/>
           </if>
           <elseif condition="#RetCod!=0">
              <set name="RspCod"    value="09101"/>
              <set name="RspMsg"    value="操作数据库失败!"/>
              <return/>
           </elseif>
           
           <!--查询商品订单信息 -->
           <do func="QueryInGroup" error="IGNORE">
              <para name="SqlCmd"     sql="QMerOrdInfoAll"/>
              <para name="RecordName" value="reportList"/>
              <para name="RecNum"     value="RECNUM"/>
           </do>
           <if condition="#RetCod==-1">
              <set name="RspCod"    value="09101"/>
              <set name="RspMsg"    value="操作数据库失败!"/>
              <return/>
           </if>
           
           <!--导出文件-->
           <do func="ReportExport" error="IGNORE">
               <para name="Root"          value="reportList"/>
               <para name="FileDemo"      value="merchantWithdrawRecord"/> <!--导出模板名-->
               <para name="NameForUser"   value="merchantWithdrawRecord"/> <!--导出文件名-->
               <para name="FilePath"      value="rptdemo"/>       <!--导出模板路径-->
               <para name="FileToPath"    value="/dat/download"/> <!--导出目标地址-->
               <para name="WebPath"       expr="GETCURAPPHOME()"/>
               <para name="params"        value="ACTDAT/CASORDNO/BANKPAYUSERNM/BANKPAYACNO/BANKNAME/TXAMT/ORDSTATUS"/>
               <para name="collectParams" value="TOTALRECNUMS/TOTALPRDAMT"/> <!--导出头-->
           </do>
           <if condition="#RetCod!=0">
               <set name="RspCod"          value="02103"/>
               <set name="RspMsg"          value="导出出错!"/>
               <set name="DWZ_STATUS_CODE" value="300"/>
               <set name="DWZ_RSP_MSG"     expr="RSPMSG"/> 
               <return/>
           </if>

           <!--读取xml参数 -->
           <set name="ConfigName"          value="FtpGetToResinMerchant"/>
           <quote name="ReadXmlCfg"/>   
           
           <!--移动文件-->
           <set name="FILENAME"            expr="#FILENAME"/>
           <do func="MoveFile">
               <para name="srcDir" expr="LclDir"    />
               <para name="srcFil" expr="FILENAME"  />
               <para name="tarDir" expr="ObjDir"    />
           </do>
           <if condition="#RetCod!=0"> 
               <set name="RspCod"  value="01007"/>  
               <set name="RspMsg"  value="移动文件错误!"/>  
               <return/> 
           </if>
           
           <set name="pos_webapps"              expr="GETSTRPOS(ObjDir,'/webapps/')"                                />
           <set name="ObjDir"                   expr="RIGHTSTR(ObjDir,SUB(STRLEN(ObjDir),ADD(pos_webapps,8)))"      />
         
           <!--set name="_REQUESTATTR.REDIRECTURL" expr="STRCAT('/',ObjDir,'/',FILENAME)"/--> 
         <set name="FILEPATH" expr="STRCAT('/',ObjDir,'/',FILENAME)"/>        
         <do func="DeleteNode" error="IGNORE">
           		<para name="NodeName"          value="REPORTLIST"/>
         </do>
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
    <transaction code="exportTransferRecord" desc="导出商户付款交易记录">
       <sql name="QMerTotalTransfer">
         select count(*) as TOTALRECNUMS,TO_CHAR(to_number(nvl(sum(ordamt),0))/100,'FM9999,999,999,990.00') TOTALPRDAMT
         from (
               select To_Char(to_date(a.tratime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') tratime,a.traordno,a.ordstatus,TO_CHAR(to_number(nvl(a.txamt,0))/100,'FM9999,999,999,990.00') txamt,a.remark,a.getcusnam,b.cust_login,a.txamt ordamt
               from stptrainf a,stpusrinf b
               where tracusid=#{merid} and a.getcusid=b.cust_id ${ordprdOrdNo} ${prdOrdStatus} ${orderDate}  ${prdordamt} ${ordprdName}
               order by tratime desc
         ) 
       </sql>
       <sql name="QMerOrdInfoAll">
         select To_Char(to_date(a.tratime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') tratime,a.traordno,
         case when  a.ordstatus = '00' then '等待付款'  when  a.ordstatus = '01' then '交易成功'   else '未知' end ordstatus,
         TO_CHAR(to_number(nvl(a.txamt,0))/100,'FM9999,999,999,990.00') txamt,a.remark,a.getcusnam,b.cust_login
         from stptrainf a,stpusrinf b
         where tracusid=#{merid} and a.getcusid=b.cust_id ${ordprdOrdNo} ${prdOrdStatus} ${orderDate}  ${prdordamt} ${ordprdName}
         order by tratime desc
       </sql>
     <process>
           
         <set name="FLAG"        value="01"/>
         <set name="merid"       expr="SESSIONS.MERID"/>
         
           <set name="Fh" value="'" />
           
           <!--商品订单号 -->
           <if condition="IS_EQUAL_STRING(prdOrdNo,'')">
                <set name="ordprdOrdNo" value=""/>
           </if>
           <else>
                <set name="ordprdOrdNo" expr="STRCAT(' and a.traordno = ',fh,prdOrdNo,fh)"/>
           </else>
           
           <!--收款人名称 -->
           <if condition="IS_EQUAL_STRING(prdName,'')">
                <set name="ordprdName"  value=""/>
           </if>
           <else>
                <set name="ordprdName"  expr="STRCAT(' and a.getcusnam like ',fh,'%',prdName,'%',fh)"/>
           </else>
           
           <!--订单状态--> 
           <if condition="IS_EQUAL_STRING(OrdStatus,'')">
                <set name="prdOrdStatus"     value=""/>
           </if>
           <else>
                <set name="prdOrdStatus"    expr="STRCAT(' and a.OrdStatus = ',fh,OrdStatus,fh)"/>
           </else>
           
           <!--订单最小金额 -->
           <if condition="ISNULL(minAmt)">
                <set name="minAmt"     value=""/>
           </if>
           <else>
               <set name="minAmt"            expr="AMTPOWER(minAmt,2)"/>
           </else>
           <!--订单最大金额 -->
           <if condition="ISNULL(maxAmt)">
                <set name="maxAmt"     value=""/>
           </if>
           <else>
               <set name="maxAmt"        expr="AMTPOWER(maxAmt,2)"/>
           </else>
           <if condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt" value=""/>
           </if>
           <elseif condition="AND(IS_EQUAL_STRING(maxAmt,''),IS_NOEQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and a.txAmt  &gt;= to_number(',Fh, minAmt ,Fh,')')" />
           </elseif>
           <elseif condition="AND(IS_NOEQUAL_STRING(maxAmt,''),IS_EQUAL_STRING(minAmt,''))">
                <set name="prdordamt"    expr="STRCAT(' and  a.txAmt &lt;= to_number(',Fh, maxAmt ,Fh,')')" />
           </elseif>
           <else>
             <if condition="INTCMP(maxAmt,1,minAmt)">
                 <set name="RspCod" value="08040" />
                 <set name="RspMsg" value="最大金额小于最小金额" />
                 <return />
             </if>
             <set name="prdordamt"  expr="STRCAT(' and a.txAmt between to_number(\'',minAmt,'\') and to_number(\'',maxAmt,'\')')"/>
             
           </else>
           <!-- 开始和结束时间范围 -->
           <if condition="IS_EQUAL_STRING(STARTDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="startDate" expr="CALCDATE(GETDATE(),'-','d',30)" />
               <set name="startDate" expr="FMTDATE(startDate,0,4)"/>
               <set name="start_date"  expr="FMTDATE(STARTDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(STARTDATE),4,8)">
                   <set name="startDate"   expr="FMTDATE(STARTDATE,4,0)" />         <!-- 开始时间 -->
                   <set name="start_date"  expr="startDate"/>
               </if>
           </else>

           <if condition="IS_EQUAL_STRING(ENDDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="endDate"  expr="GETDATETIME('YYYYMMDD')" />
               <set name="endDate"  expr="FMTDATE(endDate,0,4)"/>
               <set name="end_date"  expr="FMTDATE(ENDDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(ENDDATE),4,8)">
                   <set name="endDate"   expr="FMTDATE(ENDDATE,4,0)" />       <!-- 结束时间 -->
                   <set name="end_date"  expr="endDate"/>
               </if>
           </else>
           
           <if condition="INTCMP(end_date,1,start_date)">
               <set name="RspCod" value="08040" />
               <set name="RspMsg" value="结束日期小于开始日期" />
               <return />
           </if>
           <set name="orderDate"  expr="STRCAT(' and a.tratime  &gt;= ',Fh, STRCAT(start_date,'000000'),Fh,' and  a.tratime &lt;=',Fh,STRCAT(end_date,'235959'),Fh)" />
           
           <!-- 统计成功的总笔数和总金额 -->
           <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QMerTotalTransfer" />
           </do>
           <if condition="#RetCod==2">
             <set name="RspCod"    value="02103"/>
             <set name="RspMsg"    value="无记录!"/>
             <set name="TOTALRECNUMS" value="0"/>
             <set name="TOTALPRDAMT"  value="0.00"/>
           </if>
           <elseif condition="#RetCod!=0">
              <set name="RspCod"    value="09101"/>
              <set name="RspMsg"    value="操作数据库失败!"/>
              <return/>
           </elseif>
           
           <!--查询商品订单信息 -->
           <do func="QueryInGroup" error="IGNORE">
              <para name="SqlCmd"     sql="QMerOrdInfoAll"/>
              <para name="RecordName" value="reportList"/>
              <para name="RecNum"     value="RECNUM"/>
           </do>
           <if condition="#RetCod==-1">
              <set name="RspCod"    value="09101"/>
              <set name="RspMsg"    value="操作数据库失败!"/>
              <return/>
           </if>
           
           <!--导出文件-->
           <do func="ReportExport" error="IGNORE">
               <para name="Root"          value="reportList"/>
               <para name="FileDemo"      value="merchantTransferRecord"/> <!--导出模板名-->
               <para name="NameForUser"   value="merchantTransferRecord"/> <!--导出文件名-->
               <para name="FilePath"      value="rptdemo"/>       <!--导出模板路径-->
               <para name="FileToPath"    value="/dat/download"/> <!--导出目标地址-->
               <para name="WebPath"       expr="GETCURAPPHOME()"/>
               <para name="params"        value="TRATIME/TRAORDNO/GETCUSNAM/CUST_LOGIN/TXAMT/ORDSTATUS/REMARK"/>
               <para name="collectParams" value="TOTALRECNUMS/TOTALPRDAMT"/> <!--导出头-->
           </do>
           <if condition="#RetCod!=0">
               <set name="RspCod"          value="02103"/>
               <set name="RspMsg"          value="导出出错!"/>
               <set name="DWZ_STATUS_CODE" value="300"/>
               <set name="DWZ_RSP_MSG"     expr="RSPMSG"/> 
               <return/>
           </if>

           <!--读取xml参数 -->
           <set name="ConfigName"          value="FtpGetToResinMerchant"/>
           <quote name="ReadXmlCfg"/>   
           
           <!--移动文件-->
           <set name="FILENAME"            expr="#FILENAME"/>
           <do func="MoveFile">
               <para name="srcDir" expr="LclDir"    />
               <para name="srcFil" expr="FILENAME"  />
               <para name="tarDir" expr="ObjDir"    />
           </do>
           <if condition="#RetCod!=0"> 
               <set name="RspCod"  value="01007"/>  
               <set name="RspMsg"  value="移动文件错误!"/>  
               <return/> 
           </if>
           
           <set name="pos_webapps"              expr="GETSTRPOS(ObjDir,'/webapps/')"                                />
           <set name="ObjDir"                   expr="RIGHTSTR(ObjDir,SUB(STRLEN(ObjDir),ADD(pos_webapps,8)))"      />
         
           <!--set name="_REQUESTATTR.REDIRECTURL" expr="STRCAT('/',ObjDir,'/',FILENAME)"/--> 
         <set name="FILEPATH" expr="STRCAT('/',ObjDir,'/',FILENAME)"/>        
         <do func="DeleteNode" error="IGNORE">
           		<para name="NodeName"          value="REPORTLIST"/>
         </do>
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
     </process>
    </transaction>
    
    
    <transaction code="exportAccountRecord" desc="商户系统账户详细信息导出">
       <sql name="meracc"> 
         select SEQ_NO,JNL_NO,CUST_ID,PAY_AC_NO,AC_TYPE,
         case when TXN_TYP = '1' then '充值'    when TXN_TYP = '2' then '消费'    when TXN_TYP = '3' then '转账'    when TXN_TYP = '4' then '提现'    when TXN_TYP = '5' then '保证金'    when TXN_TYP = '6' then '错账调账'    when TXN_TYP = '7' then '退款'    when TXN_TYP = '8' then '结算' else '未知' end TXN_TYP,
         case when DR_CR_FLAG='+' then '入账' when DR_CR_FLAG='-'then '出账' else '未知' end DR_CR_FLAG,IS_ACT,
         TO_CHAR(TO_NUMBER(NVL(TXN_AMT,0))/100,'FM9999,999,999,990.00') TXN_AMT,
         TO_CHAR(to_date(TXN_DAT,'yyyymmdd'),'yyyy-mm-dd')AS TXN_DAT ,
         TO_CHAR(to_date(TXN_TIM,'hh24miss'),'hh24:mi:ss')AS TXNTIM,
         TO_CHAR(to_date(TXN_DAT||TXN_TIM,'yyyyMMdd hh24miss'),'yyyy-MM-dd hh24:mi:ss') ORDERTIME 
         from STPJNLINF  
         WHERE 1=1 and  cust_id=#{merid} ${orderDate}  ${DR_CR_FLAG_TEMP} ${JNL_NO_TEMP} ${TXN_TYP_TEMP} ${TXN_AMT_TEMP}
          order by TXN_DAT||TXN_TIM desc
       </sql>
       <process> 
           <set name="merid"       expr="SESSIONS.MERID"/>
           
           <set name="Fh" value="'" />
           <!-- 开始和结束时间范围 -->
           <if condition="IS_EQUAL_STRING(STARTDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="startDate" expr="CALCDATE(GETDATE(),'-','d',30)" />
               <set name="startDate" expr="FMTDATE(startDate,0,4)"/>
               <set name="start_date"  expr="FMTDATE(STARTDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(STARTDATE),4,8)">
                   <set name="startDate"   expr="FMTDATE(STARTDATE,4,0)" />         <!-- 开始时间 -->
                   <set name="start_date"  expr="startDate"/>
               </if>
           </else>
           
           <if condition="IS_EQUAL_STRING(ENDDATE,'')">            <!-- 如果没输入，就传送空值 -->
               <set name="endDate"  expr="GETDATETIME('YYYYMMDD')" />
               <set name="endDate"  expr="FMTDATE(endDate,0,4)"/>
               <set name="end_date"  expr="FMTDATE(ENDDATE,4,0)" />
           </if>
           <else>
               <if condition="INTCMP(STRLEN(ENDDATE),4,8)">
                   <set name="endDate"   expr="FMTDATE(ENDDATE,4,0)" />       <!-- 结束时间 -->
                   <set name="end_date"  expr="endDate"/>
               </if>
           </else>
           
           <if condition="INTCMP(end_date,1,start_date)">
               <set name="RspCod" value="08040" />
               <set name="RspMsg" value="结束日期小于开始日期" />
               <return />
           </if>
           <set name="orderDate"  expr="STRCAT(' and TXN_DAT||TXN_TIM  &gt;= ',Fh, STRCAT(start_date,'000000'),Fh,' and  TXN_DAT||TXN_TIM &lt;=',Fh,STRCAT(end_date,'235959'),Fh)" />

           <!--出账入账 -->
           <if condition="IS_EQUAL_STRING(DR_CR_FLAG,'')">
                <set name="DR_CR_FLAG_TEMP" value=""/>
           </if>
           <else>
           	<if condition="IS_EQUAL_STRING(DR_CR_FLAG,'1')">
           		<set name="DR_CR_FLAG_TEMP" expr="STRCAT(' and DR_CR_FLAG = ',fh,'-',fh)"/>
           	</if>
           	<else>
           		<set name="DR_CR_FLAG_TEMP" expr="STRCAT(' and DR_CR_FLAG = ',fh,'+',fh)"/>
           	</else>
           </else>
           
           <!--订单编号-->
           <if condition="IS_EQUAL_STRING(JNL_NO,'')">
                <set name="JNL_NO_TEMP"  value=""/>
           </if>
           <else>
                <set name="JNL_NO_TEMP"  expr="STRCAT(' and JNL_NO like ',fh,'%',JNL_NO,'%',fh)"/>
           </else>
           
            <!--交易名称 -->
           <if condition="IS_EQUAL_STRING(TXN_TYP,'')">
                <set name="TXN_TYP_TEMP"     value=""/>
           </if>
           <else>
                <set name="TXN_TYP_TEMP"    expr="STRCAT(' and TXN_TYP = ',fh,TXN_TYP,fh)"/>
           </else>
           
           <!--订单最小金额 -->
           <if condition="ISNULL(MINAMT)">
                <set name="MINAMT_TEMP"     value=""/>
           </if>
           <else>
               <set name="MINAMT_TEMP"            expr="AMTPOWER(MINAMT,'2')"/>
           </else>
           <!--订单最大金额 -->
           <if condition="ISNULL(MAXAMT)">
                <set name="MAXAMT_TEMP"     value=""/>
           </if>
           <else>
               <set name="MAXAMT_TEMP"        expr="AMTPOWER(MAXAMT,'2')"/>
           </else>
           <if condition="AND(IS_EQUAL_STRING(MAXAMT_TEMP,''),IS_EQUAL_STRING(MINAMT_TEMP,''))">
                <set name="TXN_AMT_TEMP" value=""/>
           </if>
           <elseif condition="AND(IS_EQUAL_STRING(MAXAMT_TEMP,''),IS_NOEQUAL_STRING(MINAMT_TEMP,''))">
                <set name="TXN_AMT_TEMP"    expr="STRCAT(' and TXN_AMT  &gt;= to_number(',Fh, MINAMT_TEMP ,Fh,')')" />
           </elseif>
           <elseif condition="AND(IS_NOEQUAL_STRING(MAXAMT_TEMP,''),IS_EQUAL_STRING(MINAMT_TEMP,''))">
                <set name="TXN_AMT_TEMP"    expr="STRCAT(' and  TXN_AMT  &lt;= to_number(',Fh, MAXAMT_TEMP ,Fh,')')" />
           </elseif>
           <else>
             <if condition="INTCMP(MAXAMT_TEMP,1,MINAMT_TEMP)">
                 <set name="RspCod" value="08040" />
                 <set name="RspMsg" value="最大金额小于最小金额" />
                 <return />
             </if>
             <set name="TXN_AMT_TEMP"  expr="STRCAT(' and TXN_AMT between to_number(\'',MINAMT_TEMP,'\') and to_number(\'',MAXAMT_TEMP,'\')')"/>
             
           </else>
                    
           <!--查询信息 -->
           <do func="QueryInGroup" error="IGNORE">
              <para name="SqlCmd"     sql="meracc"/>
              <para name="RecordName" value="reportList"/>
              <para name="RecNum"     value="RECNUM"/>
           </do>
           <if condition="#RetCod==-1">
              <set name="RspCod"    value="09101"/>
              <set name="RspMsg"    value="操作数据库失败!"/>
              <return/>
           </if>
           
           <!--导出文件-->
           <do func="ReportExport" error="IGNORE">
               <para name="Root"          value="reportList"/>
               <para name="FileDemo"      value="merchantAccountRecord"/> <!--导出模板名-->
               <para name="NameForUser"   value="merchantAccountRecord"/> <!--导出文件名-->
               <para name="FilePath"      value="rptdemo"/>       <!--导出模板路径-->
               <para name="FileToPath"    value="/dat/download"/> <!--导出目标地址-->
               <para name="WebPath"       expr="GETCURAPPHOME()"/>
               <para name="params"        value="ORDERTIME/JNL_NO/TXN_TYP/DR_CR_FLAG/TXN_AMT"/>
               <para name="collectParams" value=""/> <!--导出头-->
           </do>
           <if condition="#RetCod!=0">
               <set name="RspCod"          value="02103"/>
               <set name="RspMsg"          value="导出出错!"/>
               <set name="DWZ_STATUS_CODE" value="300"/>
               <set name="DWZ_RSP_MSG"     expr="RSPMSG"/> 
               <return/>
           </if>

           <!--读取xml参数 -->
           <set name="ConfigName"          value="FtpGetToResinMerchant"/>
           <quote name="ReadXmlCfg"/>   
           
           <!--移动文件-->
           <set name="FILENAME"            expr="#FILENAME"/>
           <do func="MoveFile">
               <para name="srcDir" expr="LclDir"    />
               <para name="srcFil" expr="FILENAME"  />
               <para name="tarDir" expr="ObjDir"    />
           </do>
           <if condition="#RetCod!=0"> 
               <set name="RspCod"  value="01007"/>  
               <set name="RspMsg"  value="移动文件错误!"/>  
               <return/> 
           </if>
           
           <set name="pos_webapps"              expr="GETSTRPOS(ObjDir,'/webapps/')"                                />
           <set name="ObjDir"                   expr="RIGHTSTR(ObjDir,SUB(STRLEN(ObjDir),ADD(pos_webapps,8)))"      />
         
           <!--set name="_REQUESTATTR.REDIRECTURL" expr="STRCAT('/',ObjDir,'/',FILENAME)"/--> 
         <set name="FILEPATH" expr="STRCAT('/',ObjDir,FILENAME)"/>        
         <do func="DeleteNode" error="IGNORE">
           		<para name="NodeName"          value="REPORTLIST"/>
         </do>
         <set name="MsgTyp"       value="N"/>
         <set name="RspCod"       value="00000"/>
         <set name="RspMsg"       value="交易成功"/>
       </process>
    </transaction>
</application>
