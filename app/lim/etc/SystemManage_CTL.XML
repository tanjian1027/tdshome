<?xml version="1.0" encoding="UTF-8"?>
<application name="CTHDMNG1" code="100"  log_level="DEBUG">
   <!--权限系统编码 -->
   <before>
     <set name="UrlConfig"          value="UrlConfig"/>
     <quote name="ReadXmlCfg"/>
     <set name="DWZ_ERROR_CODE"     value="300"/>
     <set name="DWZ_SUCCESS_CODE"   value="200"/>
     <set name="DWZ_TIME_OUT_CODE"  value="301"/>
     <do func="DumpMsg"/>
   </before>

   <after>
     <do func="DumpMsg"/>
   </after>

   <!--读取XML配置-->
   <macro name="ReadXmlCfg">
     <!-- 读取XML配置文件中的数据，添加到ETF树上 -->
     <!--0 成功; -1参数错误;2 取XML配置父节点失败 -->
     <do func="ReadXmlConfig" error="IGNORE">
       <para name="FILNAM"     value="etc/LIM_CONFIG.XML"/>
       <para name="NAME"       expr="UrlConfig"/>
     </do>
     <if condition="#RetCod==-1">
       <set name="RspCod"    value="08020"></set>
       <set name="RspMsg"    value="参数错误"></set>
       <return/>
     </if>
     <elseif condition="#RetCod==2">
       <set name="RspCod"    value="08021"></set>
       <set name="RspMsg"    value="取XML配置父节点失败"></set>
       <return/>
     </elseif>
     <elseif condition="#RetCod!=0">
       <set name="RspCod"    value="09998"></set>
       <set name="RspMsg"    value="系统错误"></set>
       <return/>
     </elseif>
   </macro>
   
   <!--更新用户登录状态-->
   <macro name="UpLoginSta">
     <set name="FailFlag" expr="FailFlag"/>        <!--登录失败次数-->
     <set name="FailTime" expr="GETDATETIME()"/>   <!--获得当前登录时间-->
     <if condition="INTCMP(FailFlag,3,0)">
       <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="updateLogSta1"/>
       </do>
     </if>
     <else>
       <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="updateLogSta2"/>
       </do>
     </else>

     <if condition="#RetCod==-1">
      <do func="RollBackWork"/>
       <set name="RSPCOD" value="02038"/>
       <set name="RSPMSG" value="更新数据库失败,请稍后再试!"/>
       <return/>
     </if>
   </macro>
   
   <!--更新用户登录状态-->
   <macro name="UpLoginInfo">
      <set name="login_status"   expr="login_status"/>   <!--登录状态 1 失败、 0 成功-->
      <set name="login_msg"      expr="login_msg"/>      <!--登录提示信息-->
      <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="UpsysLognInfo"/>
      </do>
      <if condition="#RetCod!=0">
         <set name="RSPCOD" value="02040"/>
         <set name="RSPMSG" value="更新登录信息失败!"/> 
         <return/>
      </if>
   </macro>
   
   
   <!-- 获取登录日志序列号 -->
   <macro name="GetLogSeqNo">
       <do func="GetSeqNo"  error="IGNORE">
             <para name="TblNam" value="stpseqrec"/>
             <para name="KeyNam" value="KeyNam"/>
             <para name="KeyVal" value="LIMLOGINF"/>
             <para name="SeqNam" value="KeyVal"/>
             <para name="Len"    value="8"/>
             <para name="Circle" value="1"/>
        </do>
        <if condition="#RetCod!=0">
             <set name="RspCod"    value="9001"/>
             <set name="RspMsg"    value="生产序号错误，请重新提交。"/>
             <return/>
         </if>
           
       <set name="SEQ_NO"   expr="STRCAT(GETDATETIME('YYYYMMDD'),KeyVal)"/>
   </macro>
   
   
   
   <macro name="chekUserLog">
     <set name="FailFlag"  value="0"/>
     <!--  查询用户登录失败次数及第一次失败时间  -->
     <do func="ReadRecord"   error="IGNORE">
       <para name="SqlCmd"    sql="QryUserLogFail"/>
     </do>
     <if condition="#RetCod==0">
        <if condition="OR(ISNULL(LOGIN_FAIL_COUNT),IS_EQUAL_STRING(DELBOTHSPACE(LOGIN_FAIL_COUNT),''))">
          <!--没有次数记录 没有登录过--> 
          <set name="FailFlag"  value="1"/>
        </if>
        <else>
          <set name="FailFlag"  expr="LOGIN_FAIL_COUNT"/>
          <!--判断该用户此次登录时间是否达到规定时间-->
          <if condition="OR(ISNULL(CURRENT_LOGIN_TIME),IS_EQUAL_STRING(DELBOTHSPACE(CURRENT_LOGIN_TIME),''))">
            <!--没有时间记录 没有登录--> 
            <set name="FailFlag"  expr="ADD(FailFlag,1)"/>
          </if>
          <else>
            <!--存在最后一次异常登录时间-->
            <set name="timeDifference"  expr="SUB(GETDATETIME(),CURRENT_LOGIN_TIME)"/><!--时间差-->
            <!--如果是在5分钟内 只要更新次数+1-->
            <if condition="DOUBLECMP(timeDifference,2,500)">
               
               <!--判断登录次数是否超过五次-->
               <if condition="INTCMP(FailFlag,5,5)">
                 <!--5分钟内且第五次以上登录-->
                 <set name="MsgTyp"    value="E"/>
                 <set name="RspCod"    value="02075" />
                 <set name="RspMsg"    value="登录失败大于等于5次,请五分钟后登录或联系客服"/>
                 <set name="login_status"   value="1"/>  
                 <set name="login_msg"      expr="RspMsg"/>
                 <quote name="UpLoginInfo"/>
                 <return/>
               </if>
               <else>
                 <!--五分钟内 登录次数少于五次时-->
                 <set name="FailFlag"  expr="ADD(FailFlag,1)"/>
               </else>
            </if>
            <else>
              <!--超过五分钟-->
              <set name="FailFlag"  value="1"/>
            </else>
          </else>
        </else>
     </if>
     <elseif condition="#RetCod==-1">
        <do func="RollBackWork"/>
        <set name="RSPCOD" value="02038"/>
        <set name="RSPMSG" value="更新数据库失败,请稍后再试!"/>
        <set name="login_status"   value="1"/>  
        <set name="login_msg"      expr="RspMsg"/>
        <quote name="UpLoginInfo"/>
        <return/>
      </elseif>
   </macro>

   <transaction code="568001"   desc="用户登录验证">
     <sql name="queryExist"><!--查询该用户是否存在 查询指定用户ID、指定账户号(内部系统默认)在内部系统中是否存在-->
       select count(user_id) as status_one from limuseinf where user_id=#{UID} and account=#{innAccount}
     </sql>
     <sql name="queryCheckPwd"><!--验证密码是否匹配-->
       select count(user_id) as status_two from limuseinf where user_id=#{UID} and USER_PWD=#{USERPWD} and account=#{innAccount} 
     </sql>
     <sql name="queryUserState"><!--查询该用户的状态  1 可用  0禁用  -->
       select STATE as status_three from limuseinf where USER_ID=#{UID} and account=#{innAccount}
     </sql>
     <sql name="queryRoleState"><!--查询该用户对应的角色状态 1可用 0禁用-->
         select role_state as status_four from limrolinf where account=#{innAccount} and role_id=(select role_id from limrurele where user_id=#{UID} and account=#{innAccount})
     </sql>
     <sql name="queryUserName">
        select user_nam as userName1 from limuseinf where USER_ID=#{UID} and account=#{innAccount}
     </sql>
     <sql name="QryUserLoing_Count"><!--查询用户已经登录次数-->
       select count(*) as LOGIN_COUNT from limloginf where account=#{innAccount} and user_id=#{UID}
     </sql>
     <sql name="InsertsysLogn"><!--每次登录都添加一条登录记录 用户ID和时间是主键-->  <!--添加登录状态字段，添加登录结果信息 -->
       insert into limloginf (account, user_id, logn_ip, sys_id, logn_time,seq_no) values
      (#{innAccount},#{UID}, #{USRIP}, #{innSysId}, #{currentTime},#{seq_no} )
     </sql>
     <sql name="UpsysLognInfo"><!--记录登录的状态-->
       update limloginf set login_status=#{login_status} , login_msg=#{login_msg}  where seq_no=#{seq_no}
     </sql>
     <sql name="UpsysLognRandom"><!--更新随机数-->
       update limloginf set random=#{random}  where seq_no=#{seq_no}
     </sql>
     <sql name="upUserRadom">
       update limuseinf set random = #{RANDOM} where user_id = #{UID} and account=#{innAccount}
     </sql>
     <sql name="QryUserLogFail"><!--查询用户登录失败次数及第一次失败时间-->
       select LOGIN_FAIL_COUNT,CURRENT_LOGIN_TIME from LIMUSEINF where user_id = #{UID} and account=#{innAccount}
     </sql>
     <sql name="updateLogSta1"><!--更新用户登录状态-->
       update limuseinf set LOGIN_FAIL_COUNT=#{FailFlag} where user_id = #{UID} and account=#{innAccount}
     </sql>
     <sql name="updateLogSta2">
       update limuseinf set LOGIN_FAIL_COUNT=#{FailFlag},CURRENT_LOGIN_TIME=#{FailTime} where user_id = #{UID} and account=#{innAccount}
     </sql>
     <sql name="queryLatPwdDate">
       select round(to_number(sysdate-to_date(last_uppwd_date,'yyyy-mm-dd hh24:mi:ss'))) as timdif from limuseinf where account=#{innAccount} and user_id=#{UID}
     </sql>
     <sql name="queryUseinnTime"><!--查询用户对应过期时间间隔 单位:天-->
       select USER_EXPIRED_TIME from limuseinf where account=#{innAccount} and user_id=#{UID}
     </sql>
     <sql name="querylimcount">
       select count(*) as LOG_LIM_COUNT from limumrele where account=#{innAccount} and user_id=#{UID}
     </sql>
     
     <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
       DELETE FROM STPVERIFY  WHERE VER_ID=#{accuser} AND VER_TYPE='0'
     </sql>
     <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
       SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random FROM STPVERIFY WHERE VER_ID=#{accuser} AND VER_TYPE='0' ORDER BY InsTim DESC
     </sql>
     <sql name="QryUsrInf"> <!--  查询用户注册手机号  -->
       select tel as USRMP,Email from limuseinf where account=#{innAccount} and USER_ID=#{UID}
     </sql>
     
     <process>
       <set name="SESSIONS.RSPMSG" value=""/>
       <if condition="ISNULL(USERNAME)">
          <set name="RSPCOD" value="02034"/>
          <set name="RSPMSG" value="用户名或密码不能为空"/>
          <return/>
       </if>
        
        
      <if condition="ISNULL(SESSIONS.MCRYPT_KEY)">
          <set name="RSPCOD" value="10001"/>
          <set name="RSPMSG" value="密码控件key为空"/>
          <return/>
       </if>
              
       <!--pin转加密-->
       <do func="TdPwdAesToMD5"    error="IGNORE">
          <para name="AesKey"      expr="SESSIONS.MCRYPT_KEY"/> 
          <para name="AesPwd"      expr="USERPWD"/> 
       </do>
       <if condition="#RetCod!=0">
          <set name="RspCod"         value="09997"/>
          <set name="RspMsg"         value="密码转加密失败"/>
          <set name="login_status"   value="1"/>  
          <set name="login_msg"      expr="RspMsg"/>
          <quote name="UpLoginInfo"/>
          <return/>
       </if> 
       <set name="USERPWD"            expr="NewPwd"/>
       <set name="UID"                 expr="USERNAME"/>
       
       
       <set name="UID"                  expr="DELBOTHSPACE(UID)"/>
       <set name="USERNAME"             expr="DELBOTHSPACE(USERNAME)"/>
       <set name="SESSIONS.USERACCOUNT" expr="innAccount"/>
       <set name="SESSIONS.UID"         expr="USERNAME"/>
       <set name="SESSIONS.LOGINIP"     expr="USRIP"/>
       <set name="currentTime"     expr="GETDATETIME()"/><!--获得当前登录时间-->
       
       <quote  name="GetLogSeqNo"    />
       <!--添加用户登录信息-->
       <do func="ExecSql" error="IGNORE">
          <para name="SqlCmd" sql="InsertsysLogn"/>
       </do>
       <if condition="#RetCod!=0">
       	  <set name="RSPCOD" value="02040"/>
          <set name="RSPMSG" value="初始化登录信息失败!"/> 
          <return/>
       </if>
       <!--在内部系统中查询此用户是否存在-->
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd" sql="queryExist"/>
       </do>
       <if condition="#RetCod!=0">
         <if condition="#RetCod==-1">
           <set name="RSPCOD" value="02032"/>
           <set name="RSPMSG" value="系统错误,查询数据库失败"/>
         </if>
         <else>
           <set name="RSPCOD" value="02033"/>
           <set name="RSPMSG" value="对不起,该系统无此用户！"/>
         </else>
         <set name="login_status"   value="1"/>  
         <set name="login_msg"      expr="RspMsg"/>
         <quote name="UpLoginInfo"/>
         <return/>
       </if>
       <else>
         <quote name="chekUserLog"/>
         <set name="SRA"        expr="SESSIONS.SRA"/>
         <if condition="IS_NOEQUAL_STRING(TOUPPER(RAND),SRA)">
          <quote name="UpLoginSta"/>
          <set name="RSPCOD"  value="02034"/>
          <set name="RSPMSG"  value="验证码错误,请重新输入"/>
          <set name="login_status"   value="1"/>  
          <set name="login_msg"      expr="RspMsg"/>
          <quote name="UpLoginInfo"/>
          <return/>
         </if>
         
         
         <if condition="IS_EQUAL_STRING(DFactors,'AAA')"><!-- 双因素开关 后台暂不开启，写死AAAA-->
               
           <!--查询手机号是否存在-->
            <do func="ReadRecord"       error="IGNORE">
                <para name="SqlCmd"       sql="QryUsrInf" />
            </do>
            <if condition="#RetCod==0">
                <set name="NOTE"          value="N"/>
                <set name="RspCod"        value="02001"/>
                <set name="RspMsg"        value="查询成功"/>
            </if>
            <elseif condition="#RetCod==2">
                <set name="RspMsg"        value="该用户没有手机号"/>
            </elseif>
            <else>
                <set name="RspCod"        value="09998"/>
                <set name="RspMsg"        value="系统错误"/>
                <set name="login_status"   value="1"/>  
                <set name="login_msg"      expr="RspMsg"/>
                <quote name="UpLoginInfo"/>
                <return/>
            </else>
            <set name="accuser"    expr="STRCAT(innAccount,'_',UID)" />
            <!--判断手机检验码  start-->
            <do func="ReadRecord" error="IGNORE">
              <para name="SqlCmd" sql="QryUsrIdverifycode" />
            </do>
            <if condition="#RetCod==2">
              <set name="MsgTyp"        value="E"/>
              <set name="RspCod"        value="02009"/>
              <set name="RspMsg"        value="该用户未申请校验码"/>
              <set name="login_status"   value="1"/>  
              <set name="login_msg"      expr="RspMsg"/>
              <quote name="UpLoginInfo"/>
              <return/>
            </if>
            <elseif condition="#RetCod==-1">
              <set name="MsgTyp"        value="E"/>
              <set name="RspCod"        value="09999"/>
              <set name="RspMsg"        value="系统错误"/>
              <set name="login_status"   value="1"/>  
              <set name="login_msg"      expr="RspMsg"/>
              <quote name="UpLoginInfo"/>
              <return/>
            </elseif>
            <elseif condition="#RetCod!=0">
              <set name="MsgTyp"        value="E"/>
              <set name="RspCod"        value="09998"/>
              <set name="RspMsg"        value="系统错误"/>
              <set name="login_status"   value="1"/>  
              <set name="login_msg"      expr="RspMsg"/>
              <quote name="UpLoginInfo"/>
              <return/>
            </elseif>
         
            <!--  超时时间判断,时间判断需要再修改  -->
            <if condition="INTCMP(timdif,6,'1800')">
              <set name="RspCod"        value="02005"/>
              <set name="RspMsg"        value="校验码已失效,请重新获取校验码"/>
              <set name="login_status"   value="1"/>  
              <set name="login_msg"      expr="RspMsg"/>
              <quote name="UpLoginInfo"/>
              <return/>
            </if>
         
            <!-- 比较验证码 -->
            <if condition="IS_NOEQUAL_STRING(ccode,Random)">
              <set name="MsgTyp"        value="E"/>
              <set name="RspCod"        value="02006"/>
              <set name="RspMsg"        value="校验码错误，请重新输入。"/>
              <set name="login_status"  value="1"/>  
              <set name="login_msg"     expr="RspMsg"/>
              <quote name="UpLoginInfo"/>
              <return/>
            </if>
               
         </if>

         <if condition="IS_EQUAL_INT(status_one,1)">
           <!--验证用户密码-->
           <do func="ReadRecord" error="IGNORE">
             <para name="SqlCmd" sql="queryCheckPwd"/>
           </do> 
           <if condition="IS_EQUAL_INT(status_two,1)">
             <!--查询用户状态-->
             <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd" sql="queryUserState"/>
             </do>
             <if condition="IS_EQUAL_INT(status_three,1)">
                <!--查询用户对应角色状态-->
                <do func="ReadRecord" error="IGNORE">
                   <para name="SqlCmd" sql="queryRoleState"/>
                </do>
                <if condition="#RetCod!=0">
                  <quote name="UpLoginSta"/>
                  <set name="RSPCOD" value="02036"/>
                  <set name="RSPMSG" value="校验用户角色信息失败!"/>
                  <set name="login_status"   value="1"/>  
                  <set name="login_msg"      expr="RspMsg"/>
                  <quote name="UpLoginInfo"/>
                  <return/>
                </if>
                <if condition="NOT(IS_EQUAL_INT(status_four,1))">
                  <quote name="UpLoginSta"/>
                  <set name="RSPCOD" value="02039"/>
                  <set name="RSPMSG" value="对不起,您所属角色暂时处于禁用状态,请联系管理员!"/>
                  <set name="login_status"   value="1"/>  
                  <set name="login_msg"      expr="RspMsg"/>
                  <quote name="UpLoginInfo"/>
                  <return/>
                </if>
                <do func="ReadRecord" error="IGNORE">
                   <para name="SqlCmd" sql="queryUserName"/>
                </do>
                <if condition="#RetCod!=0">
                  <quote name="UpLoginSta"/>
                  <set name="RSPCOD" value="02039"/>
                  <set name="RSPMSG" value="获取用户姓名失败!"/>
                  <set name="login_status"   value="1"/>  
                  <set name="login_msg"      expr="RspMsg"/>
                  <quote name="UpLoginInfo"/>
                  <return/>
                </if>
                <set name="SESSIONS.userName1" expr="userName1"/>
                <do expr="@TdRandom@generateMixRandom(10, 'ALL','LOW')"/> 
                <set name="RANDOM"          expr="RANDOM"/>
                <set name="SESSIONS.RANDOM" expr="RANDOM"/>
                <set name="currentTime"     expr="GETDATETIME()"/><!--获得当前登录时间-->
                <do func="ExecSql" error="IGNORE"> <!-- 更新登录随机数 -->
                  <para name="SqlCmd" sql="UpsysLognRandom"/>
                </do>
                <if condition="#RetCod!=0">
                	  <set name="RSPCOD" value="02040"/>
                    <set name="RSPMSG" value="更新登录随机数信息失败!"/> 
                    <return/>
                </if>
                <!--查询用户历史登录次数 -->
                <do func="ReadRecord" error="IGNORE">
                  <para name="SqlCmd" sql="QryUserLoing_Count"/>
                </do>
                <!--保存随机数到用户表-->
                <do func="ExecSql" error="IGNORE">
                  <para name="SqlCmd" sql="upUserRadom"/>
                </do>
                <if condition="#RetCod==0">
                  <set name="staleSign"      value="0"/><!--过期标识 0 正常 1 过期-->
                  <!--查询内部系统的设置过期时间 单位:天-->
                  <do func="ReadRecord" error="IGNORE">
                    <para name="SqlCmd" sql="queryUseinnTime"/>
                  </do>
                  <!--如果查询失败或者没有查到该系统对应过期时间段则默认为没有过期-->
                  <if condition="#RetCod!=0">
                    <set name="staleSign"      value="0"/>
                  </if>
                  <else>
                    <!--记录过期时间 单位:天-->
                    <set name="pastTime"   expr="USER_EXPIRED_TIME"/>
                    <if condition="OR(ISNULL(DELBOTHSPACE(pastTime)),IS_EQUAL_STRING('',DELBOTHSPACE(pastTime)))">
                       <set name="pastTime"      value="0"/>
                    </if>
                    <!--查询该用户密码最后修改时间是否到期-->
                    <do func="ReadRecord" error="IGNORE">
                      <para name="SqlCmd" sql="queryLatPwdDate"/>
                    </do>
                    <if condition="#RetCod==0">
                      <!--用户最后修改密码时间距离当前时间为 空、空串、过期 都要重新设置密码-->
                      <set name="timdif" expr="timdif"/>
                      <if condition="OR(ISNULL(DELBOTHSPACE(timdif)),IS_EQUAL_STRING('',DELBOTHSPACE(timdif)))">
                        <set name="staleSign"      value="1"/>
                      </if>
                      <else>
                        <if condition="DOUBLECMP(timdif,5,pastTime)">
                          <set name="staleSign"    value="1"/>
                        </if>
                      </else>
                    </if>
                    <else>
                       <!--出现没有记录上次密码修改时间的或者查询数据库失败的都默认为密码过期-->
                       <set name="staleSign"  value="1"/>
                    </else>
                  </else>
                  <!--验证用户的权限-->
                  <do func="ReadRecord" error="IGNORE">
                    <para name="SqlCmd" sql="querylimcount"/>
                  </do>
                  <if condition="#RetCod==0">
                     <if condition="INTCMP(LOG_LIM_COUNT,1,1)">
                       <do func="RollBackWork"/>
                       <quote name="UpLoginSta"/>
                       <set name="RSPCOD"         value="02077"/>
                       <set name="RSPMSG"         value="权限不足,请联系管理员!"/>
                       <set name="login_status"   value="1"/>  
                       <set name="login_msg"      expr="RspMsg"/>
                       <quote name="UpLoginInfo"/>
                       <return/>
                     </if>
                     <else>
                        <set name="FailFlag" value="0"/>
                        <quote name="UpLoginSta"/>
                        <set name="RSPCOD"         value="00000"/>
                        <set name="RSPMSG"         value="用户身份合法"/>
                        <set name="login_status"   value="0"/>  
                        <set name="login_msg"      value="登录成功"/>
                        <quote name="UpLoginInfo"/>
                        <return/>
                     </else>
                  </if>
                  <else>
                   <do func="RollBackWork"/>
                   <quote name="UpLoginSta"/>
                   <set name="RSPCOD"         value="02040"/>
                   <set name="RSPMSG"         value="查询用户权限失败!"/> 
                   <set name="login_status"   value="1"/>  
                   <set name="login_msg"      expr="RspMsg"/>
                   <quote name="UpLoginInfo"/>
                   <return/>
                  </else>
                </if>
                <else>
                  <do func="RollBackWork"/>
                  <quote name="UpLoginSta"/>
                  <set name="RSPCOD"         value="02036"/>
                  <set name="RSPMSG"         value="更新用户信息失败!"/>
                  <set name="login_status"   value="1"/>  
                  <set name="login_msg"      expr="RspMsg"/>
                  <quote name="UpLoginInfo"/>
                  <return/>
                </else>                 
             </if>
             <else>
               <do func="RollBackWork"/>
               <quote name="UpLoginSta"/>
               <set name="RSPCOD"         value="02039"/>
               <set name="RSPMSG"         value="账户处于禁用状态,请联系管理员!"/> 
               <set name="login_status"   value="1"/>  
               <set name="login_msg"      expr="RspMsg"/>
               <quote name="UpLoginInfo"/>
               <return/>
             </else>
           </if>
           <else>
             <quote name="UpLoginSta"/>
             <set name="RSPCOD"         value="02033"/>
             <set name="RSPMSG"         value="用户名或密码错误,请重新输入!"/>
             <set name="login_status"   value="1"/>  
             <set name="login_msg"      expr="RspMsg"/>
             <quote name="UpLoginInfo"/>
             <return/>
           </else>
         </if>
         <else>
           <set name="RSPCOD"         value="02033"/>
           <set name="RSPMSG"         value="用户名或密码错误！"/>
           <set name="login_status"   value="1"/>  
           <set name="login_msg"      expr="RspMsg"/>
           <quote name="UpLoginInfo"/>
           <return/>
         </else>
       </else>
     </process>
   </transaction>

   <transaction code="568052"   desc="获取系统条目">
     <sql name="querySysList"><!--查询所有内部系统并为可用状态信息-->
        select sys_id,sys_nam,sys_state,sys_url from limsysinf where sys_id in(
        select b.sys_id from limsysinf b ,limmeninf a where a.sys_id=b.sys_id and  a.menu_id in 
        (select distinct b.menu_id from limumrele a,limrmrele b where a.account=b.account and a.menu_id=b.menu_id and user_id=#{user_id} and a.account=#{innAccount}
        and b.role_id=(select role_id from limrurele where account=#{innAccount} and user_id=#{user_id})) and a.menu_par_id='00' and b.sys_type=#{innSysId}  and b.sys_state='1'
        ) order by sys_id asc
     </sql>
     <sql name="queryLatPwdDate">
       select round(to_number(sysdate-to_date(last_uppwd_date,'yyyy-mm-dd hh24:mi:ss'))) as timdif from limuseinf where account=#{innAccount} and user_id=#{user_id}
     </sql>
     <sql name="queryUseinnTime"><!--查询用户对应过期时间间隔 单位:天-->   
        select USER_EXPIRED_TIME from limuseinf where account=#{innAccount} and user_id=#{user_id}
     </sql>
     <sql name="innerSysList">
       select sys_id,sys_nam,sys_state,sys_url from limsysinf where sys_id='1101'
     </sql>
     <process>
         <set name="user_id"        expr="SESSIONS.UID"/>
         <set name="staleSign"      value="0"/><!--过期标识 0 正常 1 过期-->
         <!--查询内部系统的设置过期时间 单位:天-->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="queryUseinnTime"/>
         </do>
         <!--如果查询失败或者没有查到该系统对应过期时间段则默认为没有过期-->
         <if condition="#RetCod!=0">
           <set name="staleSign"      value="0"/>
         </if>
         <else>
           <!--记录过期时间 单位:天-->
           <set name="pastTime"       expr="USER_EXPIRED_TIME"/>
           <if condition="OR(ISNULL(DELBOTHSPACE(pastTime)),IS_EQUAL_STRING('',DELBOTHSPACE(pastTime)))">
              <set name="pastTime"      value="0"/>
           </if>
           <!--查询该用户密码最后修改时间是否到期-->
           <do func="ReadRecord" error="IGNORE">
             <para name="SqlCmd" sql="queryLatPwdDate"/>
           </do>
           <if condition="#RetCod==0">
             <!--用户最后修改密码时间距离当前时间为 空、空串、过期 都要重新设置密码-->
             <set name="timdif" expr="timdif"/>
             <if condition="OR(ISNULL(DELBOTHSPACE(timdif)),IS_EQUAL_STRING('',DELBOTHSPACE(timdif)))">
               <set name="staleSign"      value="1"/>
             </if>
             <else>
               <if condition="DOUBLECMP(timdif,5,pastTime)">
                 <set name="staleSign"      value="1"/>
               </if>
             </else>
           </if>
           <else>
              <!--出现没有记录上次密码修改时间的或者查询数据库失败的都默认为密码过期-->
              <set name="staleSign"  value="1"/>
           </else>
         </else>
         <!--获取指定系统信息-->
         <if condition="INTCMP(staleSign,3,1)">
           <do func="QueryInGroup" error="IGNORE">
              <para name="SqlCmd" sql="innerSysList"/>
              <para name="RecordName" value="SYS_LST"/>
           </do>
           <if condition="#RetCod!=0">
              <set name="RSPCOD" value="02031"/>   
               <set name="RSPMSG" value="查询系统集合失败!"/>
               <set name="_REQUESTATTR.FORWARDURL" value="/WEB-INF/html/initLogin/top.jsp"/>
           </if>
           <else>
              <set name="RSPCOD" value="00000"/>
              <set name="RSPMSG" value="获取系统信息成功"/>
              <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('/WEB-INF/html/initLogin/top.jsp?v=',staleSign)"/>
           </else>
         </if>
         <else>
           <do func="QueryInGroup" error="IGNORE">
              <para name="SqlCmd" sql="querySysList"/>
              <para name="RecordName" value="SYS_LST"/>
           </do>
           <if condition="#RetCod!=0">
              <set name="RSPCOD" value="02031"/>   
               <set name="RSPMSG" value="查询系统集合失败!"/>
               <set name="_REQUESTATTR.FORWARDURL" value="/WEB-INF/html/initLogin/top.jsp"/>
           </if>
           <else>
              <set name="RSPCOD" value="00000"/>   
              <set name="RSPMSG" value="获取系统信息成功"/>
              <set name="_REQUESTATTR.FORWARDURL" value="/WEB-INF/html/initLogin/top.jsp"/>
           </else>
         </else>
      </process>
   </transaction>
   
   <transaction code="568053"   desc="底部页面路径">
    <process>
       <set name="_REQUESTATTR.FORWARDURL" value="/WEB-INF/html/initLogin/bottom.jsp"/>
    </process>
   </transaction>

   <transaction code="568002"   desc="用户登录">
     <process>
         <set name="UID" expr="SESSIONS.UID"/>
         <set name="RANDOM" expr="SESSIONS.RANDOM"/>
         <set name="_REQUESTATTR.FORWARDURL" value="/WEB-INF/html/initLogin/index.jsp"/>
     </process>
   </transaction>

   <transaction code="568003"   desc="查询权限集合">
     <sql name="QryLoginDistory">
        select logn_ip,  to_char(to_date(logn_time,'yyyy-mm-dd hh24:mi:ss'),'yyyy-mm-dd hh24:mi:ss') as logn_time from limloginf  where user_id=#{UID} and account='100000' and logn_time=
       (select max(logn_time) from limloginf  where user_id=#{UID} and account='100000' and logn_time !=(select max(logn_time) from limloginf  where user_id=#{UID} and account='100000'
        and logn_time=(select max(logn_time) from limloginf  where user_id=#{UID} and account='100000')))
     </sql>
     <sql name="queryUserExit"><!--查询用户是否存在-->
        select pwd_chanum from limuseinf where user_id =#{UID} and sys_id =#{INNSYSID}  and account=#{INNACCOUNT}
     </sql>
     <process>
       <set name="UID"          expr="SESSIONS.UID"/>
       <set name="SYS_ID"       expr="SYS_ID"/>
       <set name="STALESIGN"    expr="V"/>
       <set name="LOGIN_COUNT"  expr="LOGIN_COUNT"/>
       <if condition="OR(IS_EQUAL_STRING(LOGIN_COUNT,''),ISNULL(LOGIN_COUNT))">
          <set name="LOGIN_COUNT" value="0"/>
       </if>
       <!--查询历史登录信息-->
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd" sql="QryLoginDistory"/>
       </do>
       <if condition="#RetCod!=0">
         <set name="LOGIN_COUNT" value="0"/>
       </if>
       
       <!--首次登陆修改密码-->
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd" sql="queryUserExit"/>
       </do>
       <if condition="#RetCod!=0">
         <set name="status"  value="0"/>
         <set name="RSPMSG"  value="验证该操作员账户名是否存在时,操作数据库失败!"/>
         <set name="_REQUESTATTR.REDIRECTURL" expr="initLogUrl"/>
         <return/>
       </if>
        
       <if condition="OR(ISNULL(pwd_chanum),IS_EQUAL_STRING(pwd_chanum,'0'))">
         <set name="STALESIGN"    value="1"/><!--0：正常 1:过期-->
       </if>
       
       <!--权限系统登录判断该用户密码是否过期 过期:仅赋予登录用户修改密码权限，正常:通过正常渠道去获取权限-->
       <if condition="OR(ISNULL(DELBOTHSPACE(V)),IS_EQUAL_STRING('',DELBOTHSPACE(V)))">
         <set name="STALESIGN"    value="0"/><!--0：正常 1:过期-->
       </if>
       <set name="TxnCod"         value="568031"/>
       <delete name="MENU"/>
       <do func="CallThirdOther" error="IGNORE">
         <para name="code"     value="568050"/>
         <para name="channel"  value="STHDMNG1"/>
       </do>
       <if condition="#RetCod!=0">
         <if condition="#RetCod==-1">
           <set name="RSPCOD"                   value="02032"/>
           <set name="SESSIONS.RSPMSG"          value="调用第三方接口出现异常,登录失败!"/>
           <set name="_REQUESTATTR.REDIRECTURL" expr="initLogUrl"/>
           <return/>
         </if>
         <else>
           <set name="RSPCOD"                   value="02033"/>
           <set name="SESSIONS.RSPMSG"          value="系统错误,登录失败!"/>
           <set name="_REQUESTATTR.REDIRECTURL" expr="initLogUrl"/>
           <return/>
         </else>
       </if>
       <else>
         <if condition="IS_EQUAL_INT(status,'1')">
           <if condition="#RetCod==0">
             <set name="RSPCOD"                  value="00000"/>
             <set name="SESSIONS.UID"            expr="id"/>
             <set name="SESSIONS.randomStr"      expr="randomStr"/>
             <set name="SESSIONS.USERNAME1"      expr="name"/>
             <set name="SESSIONS.SYS_ID"         expr="systemId"/>
             <set name="SESSIONS.groupNam"       expr="groupNam"/>
             <set name="SESSIONS.STHDoutUrl"     expr="STHDoutUrl"/>
             <set name="SESSIONS.STHDinitLogUrl" expr="STHDinitLogUrl"/>
             
             <do func="SetliSes" error="IGNORE"/>
       
             <if condition="AND(NOT(ISNULL(MENUSTR)),IS_NOEQUAL_STRING(DELSPACE(MENUSTR,'all'),''))">
               <set name="MENUSTR" expr="SUBSTR(MENUSTR,1,SUB(STRLEN(MENUSTR),1))"/>
             </if>
             <set name="RSPMSG"                   value="登录成功!"/>
             <set name="_REQUESTATTR.FORWARDURL"  expr="loginUrl"/>
             <return/>
           </if>
           <else>
             <set name="RSPCOD"                  value="02034"/>
             <set name="SESSIONS.RSPMSG"         value="寻找系统路径失败!"/>
             <set name="_REQUESTATTR.FORWARDURL" expr="STHDoutUrl"/>
             <return/>
           </else>
         </if>
         <else>
           <set name="RSPCOD"                    value="02034"/>
           <set name="SESSIONS.RSPMSG"           expr="retMsg"/>
           <set name="_REQUESTATTR.REDIRECTURL"  expr="STHDoutUrl"/>
           <return/>
         </else>
       </else>
     </process>
   </transaction>

   <transaction code="568099"   desc="内部接口失败退出路径">
      <process>
         <set name="SESSIONS.RANDOM" value="0"/>
         <if condition="ISNULL(RSPMSG)">
           <set name="RSPMSG" expr="SESSIONS.RSPMSG"/>
         </if>
         <if condition="ISNULL(RSPMSG)">
           <set name="RSPMSG" value="您没有该系统权限，请与系统管理员联系!"/>
         </if>
         <set name="SESSIONS.RSPMSG"         expr="RSPMSG"/>
         <set name="_REQUESTATTR.FORWARDURL" value="/WEB-INF/html/initLogin/index.jsp"/>
         <return/>
      </process>
   </transaction>

   <transaction code="568004"   desc="用户查询">
     <sql name="queryUserList">
       select a.account, a.user_id, a.user_nam, a.user_pwd, a.sys_id, a.crea_sign, a.random, 
       a.user_date,subStr(a.user_Date,1,4)||'-'||subStr(a.user_Date,5,2)||'-'||subStr(a.user_Date,7,2)  userdate, a.state, a.desc_inf ,c.role_nam ,c.role_id from limuseinf a,limrurele b,limrolinf c where a.account=b.account and a.user_id=b.user_id
       and b.account=c.account and b.role_id=c.role_id ${tj} ${role_name} ${newaddtj}
       union
       select a.account, a.user_id, a.user_nam, a.user_pwd, a.sys_id, a.crea_sign, a.random, 
       a.user_date,subStr(a.user_Date,1,4)||'-'||subStr(a.user_Date,5,2)||'-'||subStr(a.user_Date,7,2)  userdate, a.state, a.desc_inf ,c.role_nam ,c.role_id from limuseinf a,limwurinf b, limrolinf c where a.account=b.user_account and a.user_id=b.user_id
       and b.role_account=c.account and b.role_id=c.role_id ${tj} ${role_name} ${newaddtj} order by user_date desc
     </sql>
     <sql name="queryRoleInf">
       select role_id , role_nam from limrolinf where  sys_id=#{sys_id} and role_state='1'
     </sql>
     <process>
       <do func="GetOwnButton"/>
       <set name="t1"                 value="20120223"/>
       <set name="t2"                 expr="FMTDATE(t1,0,4)"/> <!--查询条件 USR_STATE 用户状态  START_DAT/END_DAT 注册开始/结束时间 -->
       <set name="UID"                expr="SESSIONS.UID"/>
       <set name="INNACCT"            expr="innAccount"/>
       <set name="tj"                 value=""/>
       <set name="role_name"          value=""/>
       <set name="sys_id"             expr="innSysId"/>
       <if condition="ISNULL(sys_id)">
          <do func="RollBackWork"/>
          <set name="RSPCOD"          value="02036"/>
          <set name="RSPMSG"          value="无法识别当前的系统ID,请检查配置文件是否正确!"/>
          <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
          <return/>
       </if>
       <if condition="AND(NOT(ISNULL(USR_STATE)),IS_NOEQUAL_STRING(USR_STATE,'-1'))">
         <set name="tj"               expr="STRCAT(tj,' and a.state = \'', USR_STATE ,'\'')"/>
       </if>
       <else> 
         <set name="USR_STATE"        value="-1"/>
       </else>
       <if condition="AND(NOT(ISNULL(ROLE_ID)),IS_NOEQUAL_STRING(ROLE_ID,'-1'))">
          <set name="role_name"       expr="STRCAT(role_name,' and c.role_id = \'', ROLE_ID ,'\'')"/>
        </if>
       <if condition="AND(NOT(ISNULL(START_DAT)),ISNULL(END_DAT))">
        <set name="END_DAT"           expr="GETDATE()"/>
       </if>
       <set name="newaddtj"           value=""/>
       <if condition="AND(NOT(ISNULL(ACCOUNT)),IS_NOEQUAL_STRING(ACCOUNT,''))">
         <set name="newaddtj"         expr="STRCAT(' and a.account=\'',ACCOUNT,'\'')"/>
       </if>
       <if condition="AND(NOT(ISNULL(START_DAT)),NOT(ISNULL(END_DAT)))">
         <if condition="INTCMP(END_DAT,1,START_DAT)">
           <set name="RSPCOD"          value="02036"/>
           <set name="RSPMSG"          value="开始日期不能小于结束日期!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
         </if>
       </if>
       <if condition="AND(NOT(ISNULL(START_DAT)),NOT(ISNULL(END_DAT)))">
          <set name="tj"               expr="STRCAT(tj,' and subStr(a.user_date,1,8) &gt;= \'', START_DAT, '\' and subStr(a.user_date,1,8) &lt;= \'', END_DAT,'\'')"/>
       </if>
       <if condition="AND(NOT(ISNULL(END_DAT)),ISNULL(START_DAT))">
          <set name="tj"               expr="STRCAT(tj,' and subStr(a.user_date,1,8) &lt;= \'', END_DAT,'\'')"/>
       </if>
       <set name="tj"                  expr="STRCAT(tj,' and a.user_nam like \'%',USR_NAM_STR,'%\'')"/>
       <if condition="AND(NOT(ISNULL(ROLE_NAM_STR)),IS_NOEQUAL_STRING(ROLE_NAM_STR,'-1'))">
          <set name="tj"               expr="STRCAT(tj,' and c.role_nam like \'%',ROLE_NAM_STR,'%\'')"/>
       </if>
       <!--PageNum===>页码  NumPerPag ======>每页显示的条数 (默认 20)    recordNum========>查询出来的记录名(默认为GRP)   sql ========>SQL语句-->
       <if condition="ISNULL(PageNum)">
         <set name="PageNum"           value="1"/>
       </if> 
       <if condition="ISNULL(NumPerPag)">
         <set name="NumPerPag"         value="19"/>
       </if>
       <do func="QueryInGroup" error="IGNORE">
         <para name="SqlCmd"     sql="queryRoleInf"/>
         <para name="RecordName" value="ROLQX_LST"/>
       </do>
       <if condition="#RetCod==0">
          <set name="RSPCOD"                  value="00000"/>   
          <set name="RSPMSG"                  value="获取添加用户前置信息成功"/>
          <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/usr/show_userList.jsp"/>
       </if>
       <else>
         <do func="RollBackWork"/>
         <set name="RSPCOD"          value="02037"/>
         <set name="RSPMSG"          value="获取系统角色信息失败!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </else>
       <do func="PagedQuery" error="ignore">
         <para name="PageNum"    expr="PageNum"/>
         <para name="NumPerPag"  expr="NumPerPag"/>
         <para name="Sql"        sql="queryUserList"/>
       </do>
       <if condition="#RetCod!=-1">
         <set name="RSPCOD"                  value="00000"/>   
         <set name="RSPMSG"                  value="查询用户成功!"/>
         <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/usr/show_userList.jsp"/>
         <return/>
       </if>
       <else>
         <set name="RSPCOD"           value="02036"/>
         <set name="RSPMSG"           value="用户信息查询失败!"/>
         <set name="DWZ_STATUS_CODE"  expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"      expr="RSPMSG"/>
         <return/>
       </else>
     </process>
   </transaction>
   
   <transaction code="568087"   desc="用户修改-查询">
     <sql name="queryUserList">
      select a.account, a.user_id, a.user_nam, a.user_pwd, a.sys_id, a.crea_sign, a.random, a.user_date,
             subStr(a.user_Date,1,4)||'-'||subStr(a.user_Date,5,2)||'-'||subStr(a.user_Date,7,2)  userdate, a.state, a.desc_inf ,c.role_nam ,c.role_id 
        from limuseinf a,limrurele b,limrolinf c 
       where a.account=b.account and a.user_id=b.user_id and b.account=c.account and b.role_id=c.role_id ${tj} ${newaddtj}
      union
      select a.account, a.user_id, a.user_nam, a.user_pwd, a.sys_id, a.crea_sign, a.random, a.user_date,
             subStr(a.user_Date,1,4)||'-'||subStr(a.user_Date,5,2)||'-'||subStr(a.user_Date,7,2)  userdate, a.state, a.desc_inf ,c.role_nam ,c.role_id 
        from limuseinf a,limwurinf b, limrolinf c 
       where a.account=b.user_account and a.user_id=b.user_id and b.role_account=c.account and b.role_id=c.role_id ${tj} ${newaddtj} order by user_date desc
     </sql>
     <process>
        <do func="GetOwnButton"/>
        <set name="t1"          value="20120223"/>
        <set name="t2"          expr="FMTDATE(t1,0,4)"/>
        <!--查询条件 USR_STATE 用户状态  START_DAT/END_DAT 注册开始/结束时间 -->
        <set name="UID"         expr="SESSIONS.UID"/>
        <set name="INNACCT"     expr="innAccount"/>
        <set name="newaddtj"    value=""/>
        <if condition="AND(NOT(ISNULL(ACCOUNT)),IS_NOEQUAL_STRING(ACCOUNT,''))">
          <set name="newaddtj"  expr="STRCAT(' and a.account=\'',ACCOUNT,'\'')"/>
        </if>
        <set name="tj"          value=""/>
         <if condition="AND(NOT(ISNULL(USR_STATE)),IS_NOEQUAL_STRING(USR_STATE,'-1'))">
           <set name="tj"       expr="STRCAT(tj,' and a.state = \'', USR_STATE ,'\'')"/>
         </if>
         <else> 
           <set name="USR_STATE" value="-1"/>
         </else>
         
         <if condition="AND(NOT(ISNULL(START_DAT)),ISNULL(END_DAT))">
          <set name="END_DAT"    expr="GETDATE()"/>
         </if>
         <if condition="AND(NOT(ISNULL(START_DAT)),NOT(ISNULL(END_DAT)))">
           <if condition="INTCMP(END_DAT,1,START_DAT)">
             <set name="RSPCOD"          value="02036"/>
             <set name="RSPMSG"          value="开始日期不能小于结束日期!"/>
             <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
             <return/>
           </if>
         </if>
         <if condition="AND(NOT(ISNULL(START_DAT)),NOT(ISNULL(END_DAT)))">
             <set name="tj" expr="STRCAT(tj,' and subStr(a.user_date,1,8) &gt;= \'', START_DAT, '\' and subStr(a.user_date,1,8) &lt;= \'', END_DAT,'\'')"/>
         </if>
         <if condition="AND(NOT(ISNULL(END_DAT)),ISNULL(START_DAT))">
             <set name="tj" expr="STRCAT(tj,' and subStr(a.user_date,1,8) &lt;= \'', END_DAT,'\'')"/>
         </if>
         <set name="tj"     expr="STRCAT(tj,' and a.user_nam like \'%',USR_NAM_STR,'%\'')"/>
         <if condition="AND(NOT(ISNULL(ROLE_NAM_STR)),IS_NOEQUAL_STRING(ROLE_NAM_STR,'-1'))">
         <set name="tj"     expr="STRCAT(tj,' and c.role_nam like \'%',ROLE_NAM_STR,'%\'')"/>
         </if>
         <!--PageNum===>页码  NumPerPag ======>每页显示的条数 (默认 20)    recordNum========>查询出来的记录名(默认为GRP)   sql ========>SQL语句-->
         <if condition="ISNULL(PageNum)">
           <set name="PageNum"   value="1"/>
         </if> 
         <if condition="ISNULL(NumPerPag)">
           <set name="NumPerPag" value="19"/>
         </if>
         
         <do func="PagedQuery" error="ignore">
           <para name="PageNum"   expr="PageNum"/>
           <para name="NumPerPag" expr="NumPerPag"/>
           <para name="Sql"       sql="queryUserList"/>
         </do>
         <if condition="#RetCod!=-1">
           <set name="RSPCOD" value="00000"/>   
           <set name="RSPMSG" value="查询用户成功!"/>
           <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/usr/update_userinf.jsp"/>
           <return/>
         </if>
         <else>
           <set name="RSPCOD"          value="02036"/>
           <set name="RSPMSG"          value="用户信息查询失败!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
         </else>
     </process>
   </transaction>
   
   <transaction code="568088"   desc="用户删除-查询">
     <sql name="queryUserList">
       select a.account, a.user_id, a.user_nam, a.user_pwd, a.sys_id, a.crea_sign, a.random, 
              a.user_date,subStr(a.user_Date,1,4)||'-'||subStr(a.user_Date,5,2)||'-'||subStr(a.user_Date,7,2)  userdate, 
              a.state, a.desc_inf ,c.role_nam ,c.role_id 
         from limuseinf a,limrurele b,limrolinf c 
        where a.account=b.account and a.user_id=b.user_id and b.account=c.account and b.role_id=c.role_id ${tj} ${newaddtj}
       union
       select a.account, a.user_id, a.user_nam, a.user_pwd, a.sys_id, a.crea_sign, a.random, 
              a.user_date,subStr(a.user_Date,1,4)||'-'||subStr(a.user_Date,5,2)||'-'||subStr(a.user_Date,7,2)  userdate, 
              a.state, a.desc_inf ,c.role_nam ,c.role_id 
         from limuseinf a,limwurinf b, limrolinf c 
        where a.account=b.user_account and a.user_id=b.user_id and b.role_account=c.account and b.role_id=c.role_id ${tj} ${newaddtj} 
        order by user_date desc
     </sql>
     <sql name="queryRoleInf">
       select role_id , role_nam from limrolinf where sys_id=#{sys_id} and role_state='1'
     </sql>
     <process>
        <do func="GetOwnButton"/>
        <set name="t1"                value="20120223"/>
        <set name="t2"                expr="FMTDATE(t1,0,4)"/><!--查询条件 USR_STATE 用户状态  START_DAT/END_DAT 注册开始/结束时间 -->
        <set name="UID"               expr="SESSIONS.UID"/>
        <set name="INNACCT"           expr="innAccount"/>
        <set name="tj"                value=""/>
        <set name="sys_id"            expr="innSysId"/>
        <if condition="ISNULL(sys_id)">
          <do func="RollBackWork"/>
          <set name="RSPCOD"          value="02036"/>
          <set name="RSPMSG"          value="无法识别当前的系统ID,请检查配置文件是否正确!"/>
          <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
          <return/>
        </if>
        <if condition="AND(NOT(ISNULL(USR_STATE)),IS_NOEQUAL_STRING(USR_STATE,'-1'))">
          <set name="tj"             expr="STRCAT(tj,' and a.state = \'', USR_STATE ,'\'')"/>
        </if>
        <else> 
          <set name="USR_STATE"      value="-1"/>
        </else>
        <set name="newaddtj"         value=""/>
        <if condition="AND(NOT(ISNULL(ACCOUNT)),IS_NOEQUAL_STRING(ACCOUNT,''))">
          <set name="newaddtj"       expr="STRCAT(' and a.account=\'',ACCOUNT,'\'')"/>
        </if>
        <if condition="AND(NOT(ISNULL(START_DAT)),ISNULL(END_DAT))">
         <set name="END_DAT"         expr="GETDATE()"/>
        </if>
        <if condition="AND(NOT(ISNULL(START_DAT)),NOT(ISNULL(END_DAT)))">
          <if condition="INTCMP(END_DAT,1,START_DAT)">
            <set name="RSPCOD"          value="02036"/>
            <set name="RSPMSG"          value="开始日期不能小于结束日期!"/>
            <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
            <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
            <return/>
          </if>
        </if>
        <if condition="AND(NOT(ISNULL(START_DAT)),NOT(ISNULL(END_DAT)))">
           <set name="tj" expr="STRCAT(tj,' and subStr(a.user_date,1,8) &gt;= \'', START_DAT, '\' and subStr(a.user_date,1,8) &lt;= \'', END_DAT,'\'')"/>
        </if>
        <if condition="AND(NOT(ISNULL(END_DAT)),ISNULL(START_DAT))">
           <set name="tj" expr="STRCAT(tj,' and subStr(a.user_date,1,8) &lt;= \'', END_DAT,'\'')"/>
        </if>
        <set name="tj"    expr="STRCAT(tj,' and a.user_nam like \'%',USR_NAM_STR,'%\'')"/>
        <if condition="AND(NOT(ISNULL(ROLE_NAM_STR)),IS_NOEQUAL_STRING(ROLE_NAM_STR,'-1'))">
           <set name="tj" expr="STRCAT(tj,' and c.role_nam like \'%',ROLE_NAM_STR,'%\'')"/>
        </if>
        <!--PageNum===>页码  NumPerPag ======>每页显示的条数 (默认 20)    recordNum========>查询出来的记录名(默认为GRP)   sql ========>SQL语句-->
        <if condition="ISNULL(PageNum)">
          <set name="PageNum"   value="1"/>
        </if> 
        <if condition="ISNULL(NumPerPag)">
          <set name="NumPerPag" value="19"/>
        </if>
        <do func="QueryInGroup" error="IGNORE">
          <para name="SqlCmd"     sql="queryRoleInf"/>
          <para name="RecordName" value="ROLQX_LST"/>
        </do>
        <if condition="#RetCod==0">
          <set name="RSPCOD"                  value="00000"/>   
          <set name="RSPMSG"                  value="获取添加用户前置信息成功"/>
          <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/usr/delete_user.jsp"/>
        </if>
        <else>
          <do func="RollBackWork"/>
          <set name="RSPCOD"          value="02037"/>
          <set name="RSPMSG"          value="获取系统角色信息失败!"/>
          <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
          <return/>
        </else>
        <do func="PagedQuery" error="ignore">
          <para name="PageNum"    expr="PageNum"/>
          <para name="NumPerPag"  expr="NumPerPag"/>
          <para name="Sql"        sql="queryUserList"/>
        </do>
        <if condition="#RetCod!=-1">
          <set name="RSPCOD"                  value="00000"/>   
          <set name="RSPMSG"                  value="查询用户成功!"/>
          <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/usr/delete_user.jsp"/>
          <return/>
        </if>
        <else>
          <set name="RSPCOD" value="02036"/>
          <set name="RSPMSG" value="用户信息查询失败!"/>
          <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG" expr="RSPMSG"/>
          <return/>
        </else>
     </process>
   </transaction>

   <transaction code="568005"   desc="添加用户初始信息">
     <sql name="queryRoleInf"><!--获得内部系统下所有可用角色-->
        select role_id , role_nam from limrolinf where account=#{account} and sys_id=#{sys_id} and role_state='1'
     </sql>
     <process>
      <do func="GetOwnButton"/>              <!--权限按钮控制-->
       <set name="ROLE_ID" expr="DELBOTHSPACE(ROLE_ID)"/>
       <if condition="ISNULL(ROLE_ID)">
         <set name="ROLE_ID" value="-1"/>
       </if>
       <set name="TUSER_ID"  expr="USER_ID"/>
       <set name="STATE"  expr="STATE"/>
       <if condition="IS_NOEQUAL_STRING(STATE,'0')">
         <set name="STATE" value="1"/>
       </if>
       <else>
         <set name="STATE" value="0"/>
       </else>
       
       <set name="TUSER_NAM"     expr="USER_NAM"/>
       <set name="TUSER_PWD2"    expr="USER_PWD2"/>
       <set name="TDESC_INF"     expr="DESC_INF"/>
       <set name="TPWD_EXPIRED"  expr="PWD_EXPIRED"/> 
       <!--从当前配置文件中获得内部系统的账户号和系统编号-->
       <set name="account"       expr="innAccount"/>
       <set name="sys_id"        expr="innSysId"/>
       <if condition="OR(ISNULL(account),ISNULL(sys_id))">
          <do func="RollBackWork"/>
          <set name="RSPCOD"          value="02036"/>
          <set name="RSPMSG"          value="无法识别当前的系统ID或账户号,请检查配置文件是否正确!"/>
          <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
          <return/>
       </if>
       <do func="QueryInGroup" error="IGNORE">
         <para name="SqlCmd"     sql="queryRoleInf"/>
         <para name="RecordName" value="ROLQX_LST"/>
       </do>
       <if condition="#RetCod==0">
          <set name="RSPCOD"                  value="00000"/>   
          <set name="DWZ_STATUS_CODE"         value="200"/>
          <set name="RSPMSG"                  value="获取添加用户前置信息成功"/>
          <set name="_REQUESTATTR.FORWARDURL" value="/WEB-INF/html/usr/add_userInf.jsp"/>
          <return/>
       </if>
       <else>
         <do func="RollBackWork"/>
         <set name="RSPCOD"                   value="02037"/>
         <set name="RSPMSG"                   value="获取系统角色信息失败!"/>
         <set name="DWZ_STATUS_CODE"          expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"              expr="RSPMSG"/>
         <return/>
       </else>
     </process>
   </transaction>
   
   <transaction code="568006"   desc="查看用户详细信息">      
     <sql name="queryUserInf"><!--查询用户基本信息-->
        select user_nam, sys_id, crea_sign, random, user_date, state, desc_inf,tel,email,USER_EXPIRED_TIME from limuseinf where account=#{account} and user_id=#{user_id}
     </sql>
     <sql name="queryUserqx"><!--当前用户拥有的所有权限-->
       select menu_id as PAGID,menu_par_id as PAREID,menu_nam as PAGNAM from limmeninf where menu_id in 
       (select menu_id from limumrele  where user_id=#{user_id} and account=#{account}) order by menu_id asc
     </sql>
     <sql name="queryRoleqx"><!--角色即模板权限-->
        select menu_id as PAGID,menu_par_id as PAREID,menu_nam as PAGNAM from limmeninf where menu_id in 
        (select menu_id from limrmrele  where role_id=#{role_id} and account=#{role_account}) order by menu_id asc
     </sql>
     <sql name="queryRoleInf"><!--查询用户的角色信息-->
        select role_id,role_nam,role_state,account as role_account from limrolinf where account=#{account} and role_id=#{role_id}
     </sql>
     <sql name="queryRoleInf1"><!--查询商户/企业会员的角色信息-->
        select role_id,role_nam,role_state,account as role_account from limrolinf where account=(select role_account from limwurinf  where user_account=#{account}  and user_id=#{user_id})  
        and role_id= (select role_id from limwurinf  where user_account=#{account}  and user_id=#{user_id})
     </sql>
     <sql name="querySysInf"><!--系统信息-->
        select sys_nam from limsysinf where sys_id=#{sys_id}
     </sql>
     <process>
       <if condition="ISNULL(jumppath)">
         <set name="RSPCOD" value="02038"/>
         <set name="RSPMSG" value="获取跳转路径失败,无法继续执行操作!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </if>
       <set name="account" expr="account"/>
       <if condition="OR(ISNULL(DELSPACE(account,'all')),ISNULL(DELSPACE(user_id,'all')),ISNULL(role_id))">
         <set name="RSPCOD" value="02038"/>
         <set name="RSPMSG" value="获取用户信息失败!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </if>
       <else>
         <!--基本信息-->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="queryUserInf"/>
         </do>
         <if condition="#RetCod==0">  
           <!--查询用户角色信息 -->
           <if condition="IS_EQUAL_STRING(SYS_ID,'1000')">
               <do func="ReadRecord" error="IGNORE">
                 <para name="SqlCmd" sql="queryRoleInf"/>
               </do>
           </if>
           <!--商户、企业会员角色-->
           <else>
               <do func="ReadRecord" error="IGNORE">
                 <para name="SqlCmd" sql="queryRoleInf1"/>
               </do>
               <set name="account"  expr="role_account"/>
           </else>
           <if condition="#RetCod!=-1">
             <!--查询系统信息 -->
             <if condition="IS_EQUAL_STRING(SYS_ID,'1000')">
                <set name="sys_nam" value="内部系统"/>
             </if>
             <else>
             <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd" sql="querySysInf"/>
             </do>
             </else>
               <!--用户的模板权限-->
               <do func="QueryInGroup" error="IGNORE">
                 <para name="SqlCmd"     sql="queryRoleqx"/>
                 <para name="RecordName" value="ROLEQX_LST"/>
               </do>
               <!--用户的自身权限-->
               <do func="QueryInGroup" error="IGNORE">
                 <para name="SqlCmd"     sql="queryUserqx"/>
                 <para name="RecordName" value="USERRQX_LST"/>
               </do>
               <if condition="#RetCod!=-1">
                 <set name="RSPCOD"      value="00000"/>
                 <set name="RSPMSG"      value="成功获取用户信息"/>
                 
                 <set name="url"         expr="STRCAT('WEB-INF/html/usr/',jumppath)"/>
                 <set name="_REQUESTATTR.FORWARDURL" expr="url"/>
                 <return/>
               </if>
               <else>
                 <set name="RSPCOD"            value="02039"/>
                 <set name="RSPMSG"            value="查询用户权限信息失败!"/>
                 <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
                 <set name="DWZ_CALLBACK_TYPE" value="forward"/>  
                 <set name="DWZ_FORWARD_URL"   value="568004.lim"/>
                 <set name="DWZ_RSP_MSG"       expr="RSPMSG"/> 
                 <return/>
               </else>
           </if>
           <else>
             <set name="RSPCOD"                value="02038"/>
             <set name="RSPMSG"                value="系统错误,操作数据库失败!"/>
             <set name="DWZ_CALLBACK_TYPE"     value="forward"/>  
             <set name="DWZ_FORWARD_URL"       value="568004.lim"/>
             <set name="DWZ_STATUS_CODE"       expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_RSP_MSG"           expr="RSPMSG"/>
             <return/>
           </else>
           </if>
           <else>
             <set name="RSPCOD"               value="02038"/>
             <set name="RSPMSG"               value="操作数据库失败,系统错误!"/>
             <set name="DWZ_CALLBACK_TYPE"    value="forward"/>  
             <set name="DWZ_FORWARD_URL"      value="568004.lim"/>
             <set name="DWZ_STATUS_CODE"      expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_RSP_MSG"          expr="RSPMSG"/>
             <return/>
           </else>
       </else>
     </process>
   </transaction>

   <transaction code="568007"   desc="添加用户-验证用户查询权限">
     <sql name="queryUserExit">
       select count(user_id) as userExit from limuseinf where account=#{account} and user_id=#{user_id}
     </sql>
     <sql name="queryRoleqx">
       select menu_id as PAGID, menu_par_id as PAREID, menu_nam as PAGNAM from  limmeninf where menu_id in 
       (select menu_id from limrmrele where account=#{account} and role_id=#{role_id}) order by  sys_id,menu_id asc
     </sql>
     <process>
       <set name="sys_id"      expr="sys_id"/>    <!--内部系统ID默认为1000-->
       <set name="account"     expr="account"/>   <!--内部系统账户默认为100000-->
       <set name="user_id"     expr="user_id"/>   <!--新增用户用户ID-->
       <set name="role_id"     expr="role_id"/>   <!--角色ID-->
       <set name="user_nam"    expr="user_nam"/>  <!--新增用户名字-->
       <set name="user_pwd"    expr="user_pwd"/>  <!--新增用户密码-->
       <set name="quer_pwd"    expr="quer_pwd"/>  <!--确认密码-->
       <set name="state"       expr="state"/>     <!--新增用户状态-->
       <set name="desc_inf"    expr="desc_inf"/>  <!--新增用户备注信息-->
       <set name="pwd_expired" expr="pwd_expired"/>
       <!--判断有没有选择角色-->
       <set name="USER_PWD2"   expr="user_pwd"/>
       <if condition="OR(IS_EQUAL_STRING(role_id,'-1'),ISNULL(role_id))">
         <set name="RSPCOD"          value="02040"/>
         <set name="RSPMSG"          value="请选择角色!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </if>
       <if condition="OR(ISNULL(account),ISNULL(sys_id),ISNULL(user_id),IS_EQUAL_STRING(user_nam,'null'),ISNULL(DELSPACE(user_nam,'all')),ISNULL(user_pwd),ISNULL(quer_pwd))">
         <set name="RSPCOD"          value="02038"/>
         <set name="RSPMSG"          value="您输入信息不完整,请核对后再提交"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </if>
       <if condition="ISCHIN(user_id)">
         <set name="RSPCOD"          value="02037"/>
         <set name="RSPMSG"          value="用户名不能含有中文域!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </if>
       <if condition="ISNUMBER(user_nam)">
         <set name="RSPCOD"          value="02038"/>
         <set name="RSPMSG"          value="真实姓名不能全为数字!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </if>
       <if condition="ISNULL(DELSPACE(user_pwd,'all'))">
         <set name="RSPCOD"          value="02038"/>
         <set name="RSPMSG"          value="输入密码不能为空或空字符串!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </if>
       <if condition="IS_NOEQUAL_STRING(quer_pwd,user_pwd)">
         <set name="RSPCOD"          value="02040"/>
         <set name="RSPMSG"          value="您两次输入的密码不一致请重新输入!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </if>
       <else>
           <if condition="INTCMP(STRLEN(user_pwd),1,6)">
             <set name="RSPCOD"          value="02039"/>
             <set name="RSPMSG"          value="您输入的密码不足6位,为保证您的密码安全,请重新输入!"/>
             <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
             <return/> 
           </if>
           <else>
           <do func="ReadRecord" error="IGNORE">
             <para name="SqlCmd" sql="queryUserExit"/>
           </do>
           <if condition="INTCMP(userExit,3,0)">
             <do func="QueryInGroup" error="IGNORE">
               <para name="SqlCmd"     sql="queryRoleqx"/>
               <para name="RecordName" value="ROQX_LST"/>
             </do>
             <if condition="#RetCod!=-1">
               <set name="RSPCOD"          value="00000"/>
               <set name="USER_PWD1"       expr="MD5STR(USER_PWD)"/>
               <set name="RSPMSG"          value="验证用户添加信息成功!"/>
               <set name="_REQUESTATTR.FORWARDURL" value="/WEB-INF/html/usr/add_userqx.jsp"/>
               <return/>
             </if>
             <else>
               <do func="RollBackWork"/>
               <set name="RSPCOD"            value="02038"/>
               <set name="RSPMSG"            value="初始化模板权限集合出现异常,添加用户失败!"/>
               <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
               <set name="DWZ_CALLBACK_TYPE" value="forward"/>
               <set name="DWZ_FORWARD_URL"   value="568004.lim"/>
               <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
               <return/>
             </else>
           </if>
           <else>
             <do func="RollBackWork"/>
             <set name="RSPCOD"              value="02038"/>
             <set name="RSPMSG"              value="当前系统中,该用户名已存在,请重新输入!"/>
             <set name="DWZ_STATUS_CODE"     expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_RSP_MSG"         expr="RSPMSG"/>
             <return/>
           </else>
         </else>
       </else>
     </process>
   </transaction>

   <transaction code="568040"   desc="添加用户">
     <sql name="insertUserInf"><!--添加用户基本信息-->
        insert into limuseinf (account, user_id, user_nam, user_pwd, sys_id, crea_sign, user_date, state, desc_inf,LAST_UPPWD_DATE,USER_EXPIRED_TIME,TEL,EMAIL) values
        (#{ACCOUNT}, #{USER_ID}, #{USER_NAM}, #{USER_PWD}, #{SYS_ID}, '1', #{cuerrTime}, #{STATE}, #{DESC_INF},#{cuerrTime},#{PWD_EXPIRED},#{TEL},#{EMAIL})
     </sql>
     <sql name="insertRuRele"><!--添加用户角色关联信息-->
        insert into limrurele (account, role_id, user_id) values (#{ACCOUNT}, #{ROLE_ID}, #{USER_ID})
     </sql>
     <sql name="deleteUmRele"><!--删除该账户下该用户ID对应定的菜单-->
       delete from limumrele where user_id=#{USER_ID} and account=#{ACCOUNT}
     </sql>
     <process>
       <!--验证重要信息是否齐全-->
       <if condition="OR(ISNULL(sys_id),ISNULL(ACCOUNT),ISNULL(ROLE_ID),ISNULL(user_id),ISNULL(DELSPACE(user_nam,'all')),ISNULL(user_pwd))">
         <set name="RSPCOD"            value="02038"/>
         <set name="RSPMSG"            value="校验用户信息失败,添加用户失败!"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_CALLBACK_TYPE" value="forward"/>
         <set name="DWZ_FORWARD_URL"   value="568004.lim"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </if>
       <else>
         <set name="cuerrTime"         expr="GETDATETIME()"/>
         <if condition="ISNULL(TEL)">
             <set name="TEL" value=""/>
          </if>
          <if condition="ISNULL(EMAIL)">
             <set name="EMAIL" value=""/>
          </if>
         <!--添加用户信息-->
         <do func="ExecSql" error="IGNORE">
            <para name="SqlCmd"  sql="insertUserInf"/>
         </do>
         <if condition="#RetCod==0">
           <!--添加用户角色关联信息-->
           <do func="ExecSql" error="IGNORE">
             <para name="SqlCmd" sql="insertRuRele"/>
           </do>
           <!--删除遗留用户菜单关联-->
           <if condition="#RetCod==0">
             <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="deleteUmRele"/>
             </do>
             <if condition="#RetCod==-1">
                 <do func="RollBackWork"/>
                 <set name="RSPCOD"            value="02038"/>
                 <set name="RSPMSG"            value="删除遗留用户菜单关联信息失败!"/>
                 <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
                 <set name="DWZ_CALLBACK_TYPE" value="forward"/>
                 <set name="DWZ_FORWARD_URL"   value="568004.lim"/>
                 <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>      
                 <return/>
             </if>
             <!--添加用户菜单信息-->
             <set name="aaa" expr="GETMENUSTR('')"/>
             <foreach name="MENU_ID" iterator="#tmp">
               <set name="MENU_ID"   expr="#tmp"/>
               <do func="InsertRecord" error="IGNORE">
                 <para name="TblNam"  value="limumrele"/>
               </do>
             </foreach>
             <if condition="#RetCod!=-1">
               <set name="RSPCOD"            value="02039"/>
               <set name="RSPMSG"            value="添加用户成功!"/>
               <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
               <set name="DWZ_CALLBACK_TYPE" value="forward"/>
               <set name="DWZ_FORWARD_URL"   value="568004.lim"/>
               <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
               <return/>
             </if>
             <else>
               <do func="RollBackWork"/>
               <set name="RSPCOD"            value="02039"/>
               <set name="RSPMSG"            value="录入用户菜单关联信息失败!"/>
               <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
               <set name="DWZ_CALLBACK_TYPE" value="forward"/>
               <set name="DWZ_FORWARD_URL"   value="568004.lim"/>
               <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
               <return/>
             </else>
           </if>
           <else>
             <do func="RollBackWork"/>
             <set name="RSPCOD"            value="02039"/>
             <set name="RSPMSG"            value="录入用户角色关联信息失败!"/>
             <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_CALLBACK_TYPE" value="forward"/>
             <set name="DWZ_FORWARD_URL"   value="568004.lim"/>
             <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
             <return/>
           </else>
         </if>
         <else>
           <do func="RollBackWork"/>
           <set name="RSPCOD"             value="02038"/>
           <set name="RSPMSG"             value="录入数据异常,添加用户信息失败!"/>
           <set name="DWZ_STATUS_CODE"    expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_CALLBACK_TYPE"  value="forward"/>
           <set name="DWZ_FORWARD_URL"    value="568004.lim"/>
           <set name="DWZ_RSP_MSG"        expr="RSPMSG"/>
           <return/>
         </else>
       </else>
     </process>
   </transaction>

   <transaction code="568009"   desc="修改用户信息">
     <sql name="upUserInf"><!--更新用户信息-->
       update limuseinf set user_nam=#{user_nam},state=#{state},desc_inf=#{desc_inf},USER_EXPIRED_TIME=#{USER_EXPIRED_TIME},TEL=#{TEL},EMAIL=#{EMAIL} where account=#{account} and user_id=#{user_id}
     </sql>
     <sql name="deleteUmRele"><!--删除用户菜单关联信息-->
       delete from limumrele where account=#{account} and user_id=#{user_id}
     </sql>
     <sql name="upUserpwd">
       update limuseinf set user_pwd = #{NEW_USER_PWD} ,LAST_UPPWD_DATE = #{cuerrTime} where user_id = #{USER_ID} and account=#{account}
      </sql>
     <process>
       <set name="cuerrTime"    expr="GETDATETIME()"/>
       <do func="GetOwnButton"/>
       <set name="account"      expr="account"/>
       <if condition="OR(ISNULL(DELSPACE(user_id,'all')),ISNULL(DELSPACE(account,'all')),ISNULL(DELSPACE(role_id,'all')))">
         <do func="RollBackWork"/>
         <set name="RSPCOD"            value="02038"/>
         <set name="RSPMSG"            value="用户头信息丢失,修改失败!"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_CALLBACK_TYPE" value="forward"/>
         <set name="DWZ_FORWARD_URL"   value="568087.lim?operating=update_userinf.jsp"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </if>
       <if condition="ISNULL(TEL)">
         <set name="TEL"              value=""/>
       </if>
       <if condition="ISNULL(EMAIL)">
         <set name="EMAIL"              value=""/>
       </if>
       <if condition="OR(ISNULL(user_nam),INTCMP(STRLEN(user_nam),1,2),ISNUMBER(user_nam))">
         <set name="RSPCOD"            value="02038"/>
         <set name="RSPMSG"            value="您的输入不合法,用户长度不能少于2位字符,且不能全为数字！"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </if>
       <else>
         <!--修改用户基本信息-->
         <do func="ExecSql" error="IGNORE">
           <para name="SqlCmd" sql="upUserInf"/>
         </do>
         <if condition="#RetCod==0">
            <!--新增重置密码功能-->
            <if condition="ISNULL(pwdreset)">
               <set name="pwdreset"  value="0"/>
            </if>
            <set name="UrlConfig"    value="passwdper"/>
            <quote name="ReadXmlCfg"/>
            <if condition="IS_EQUAL_STRING(pwdreset,'1')">
              <set name="NEW_USER_PWD" expr="MD5STR(merpasswd)"/>
              <do func="ExecSql" error="IGNORE">
                 <para name="SqlCmd" sql="upUserpwd"/>
              </do>
            </if> 
            <if condition="#RetCod!=0">
              <do func="RollBackWork"/>
              <set name="RSPCOD"            value="02038"/>
              <set name="RSPMSG"            value="重置密码失败!"/>
              <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
              <set name="DWZ_CALLBACK_TYPE" value="forward"/>
              <set name="DWZ_FORWARD_URL"   value="568087.lim?operating=update_userinf.jsp"/>
              <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
              <return/>
            </if>
            <!--删除权限信息-->
            <do func="ExecSql" error="IGNORE">
              <para name="SqlCmd" sql="deleteUmRele"/>
            </do>
            <if condition="#RetCod!=-1">
              <!--新增权限信息-->
              <set name="aaa"      expr="GETMENUSTR('')"/>
              <foreach name="MENU_ID" iterator="#tmp">
              <set name="MENU_ID"  expr="#tmp"/>
              <do func="InsertRecord" error="IGNORE">
                <para name="TblNam"  value="limumrele"/>
              </do>
              <if condition="#RetCod==-1">
                 <do func="RollBackWork"/>
                 <set name="RSPCOD"            value="02038"/>
                 <set name="RSPMSG"            value="修改权限失败!"/>
                 <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
                 <set name="DWZ_CALLBACK_TYPE" value="forward"/>
                 <set name="DWZ_FORWARD_URL"   value="568087.lim?operating=update_userinf.jsp"/>
                 <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
                 <return/>
               </if>
               </foreach>
               <if condition="#RetCod==-1">
                 <do func="RollBackWork"/>
                 <set name="RSPCOD"            value="02038"/>
                 <set name="RSPMSG"            value="试图添加重复菜单,修改失败!"/>
                 <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
                 <set name="DWZ_CALLBACK_TYPE" value="forward"/>
                 <set name="DWZ_FORWARD_URL"   value="568087.lim?operating=update_userinf.jsp"/>
                 <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
                 <return/>
               </if>
               <else>
                 <set name="RSPCOD"            value="02038"/>
                 <set name="RSPMSG"            value="成功修改用户信息!"/>
                 <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
                 <set name="DWZ_CALLBACK_TYPE" value="forward"/>
                 <set name="DWZ_FORWARD_URL"   value="568087.lim?operating=update_userinf.jsp"/>
                 <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
                 <return/>
               </else>
             </if>
             <else>
               <do func="RollBackWork"/>
               <set name="RSPCOD"            value="02038"/>
               <set name="RSPMSG"            value="系统错误,操作数据库失败!"/>
               <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
               <set name="DWZ_CALLBACK_TYPE" value="forward"/>
               <set name="DWZ_FORWARD_URL"   value="568087.lim?operating=update_userinf.jsp"/>
               <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
               <return/>
             </else>
             </if>
             <else>
               <do func="RollBackWork"/>
               <set name="RSPCOD"            value="02038"/>
               <set name="RSPMSG"            value="更新用户信息失败!"/>
               <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
               <set name="DWZ_CALLBACK_TYPE" value="forward"/>
               <set name="DWZ_FORWARD_URL"   value="568087.lim?operating=update_userinf.jsp"/>
               <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
               <return/>
             </else>
           </else>
     </process>
   </transaction>

   <transaction code="568011"     desc="确认提示删除用户">
     <sql name="queryUserLoginYN"><!--验证用户是否登录-->
       select random from limuseinf where account=#{account} and user_id=#{user_id}
     </sql>
     <sql name="deleteUrRele"><!--删除用户角色关联-->
       delete from limrurele where account=#{account} and user_id= #{user_id}
     </sql>
     <sql name="deleteUmRele"><!--删除用户菜单关联-->
       delete from limumrele where account=#{account} and user_id=#{user_id}
     </sql>
     <sql name="deleUserLoginInf"> <!--删除登录信息-->
       delete from limloginf where account=#{account} and user_id=#{user_id}
     </sql>
     <sql name="deleteUserInf"><!--删除用户信息-->
       delete from limuseinf where account=#{account} and user_id=#{user_id} and crea_sign != 0
     </sql>
     <process>
       <set name="UID"         expr="SESSIONS.UID"/>
       <set name="USERACC"     expr="SESSIONS.USERACCOUNT"/>
       <if condition="OR(ISNULL(DELSPACE(user_id,'all')),ISNULL(DELSPACE(account,'all')),ISNULL(DELSPACE(role_id,'all')))">
         <set name="RSPCOD"            value="02038"/>
         <set name="RSPMSG"            value="获取该用户头信息失败,请检查网络状态或数据库信息!"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_CALLBACK_TYPE" value="forward"/>
         <set name="DWZ_FORWARD_URL"   value="568088.lim?operating=delete_user.jsp"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </if>
       <else>
         <if condition="AND(IS_EQUAL_STRING(USER_ID,UID),IS_EQUAL_STRING(account,USERACC))">
           <set name="RSPCOD"            value="02045"/>
           <set name="RSPMSG"            value="不能删除自己!"/>
           <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_CALLBACK_TYPE" value="forward"/>
           <set name="DWZ_FORWARD_URL"   value="568088.lim?operating=delete_user.jsp"/>
           <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
           <return/>
         </if>
         <!--查询用户是否登录-->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="queryUserLoginYN"/>
         </do>
         <if condition="OR(ISNULL(random),IS_EQUAL_STRING(random,''))">
           <do func="ExecSql" error="IGNORE">
             <para name="SqlCmd" sql="deleteUrRele"/>
           </do>
           <if condition="#RetCod==-1">
             <do func="RollBackWork"/>
             <set name="RSPCOD"            value="02035"/>
             <set name="RSPMSG"            value="删除用户角色关联信息失败!"/>
             <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_CALLBACK_TYPE" value="forward"/>
             <set name="DWZ_FORWARD_URL"   value="568088.lim?operating=delete_user.jsp"/>
             <set name="DWZ_RSP_MSG"       expr="RSPMSG"/> 
             <return/>
           </if>
           <else>
             <do func="ExecSql" error="delete"> 
                <para name="SqlCmd" sql="deleteUmRele"/>
             </do>
              <if condition="#RetCod==-1">
                <do func="RollBackWork"/>
                <set name="RSPCOD"            value="02035"/>
                <set name="RSPMSG"            value="删除用户菜单关联信息失败!"/>
                <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
                <set name="DWZ_CALLBACK_TYPE" value="forward"/>
                <set name="DWZ_FORWARD_URL"   value="568088.lim?operating=delete_user.jsp"/>
                <set name="DWZ_RSP_MSG"       expr="RSPMSG"/> 
                <return/> 
              </if>
               <else>
                  <do func="ExecSql" error="IGNORE">
                    <para name="SqlCmd" sql="deleUserLoginInf"/>
                  </do>
                  <if condition="#RetCod==-1">
                   <do func="RollBackWork"/>
                   <set name="RSPCOD"            value="02039"/>
                   <set name="RSPMSG"            value="删除用户登录信息失败!"/>
                   <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
                   <set name="DWZ_CALLBACK_TYPE" value="forward"/>
                   <set name="DWZ_FORWARD_URL"   value="568088.lim?operating=delete_user.jsp"/>
                   <set name="DWZ_RSP_MSG"       expr="RSPMSG"/> 
                   <return/>
                  </if>
                 <do func="ExecSql" error="IGNORE">
                   <para name="SqlCmd" sql="deleteUserInf"/>
                 </do>
                 <if condition="#RetCod==-1">
                   <do func="RollBackWork"/>
                   <set name="RSPCOD"            value="02035"/>
                   <set name="RSPMSG"            value="删除用户信息失败!"/>
                   <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
                   <set name="DWZ_CALLBACK_TYPE" value="forward"/>
                   <set name="DWZ_FORWARD_URL"   value="568088.lim?operating=delete_user.jsp"/>
                   <set name="DWZ_RSP_MSG"       expr="RSPMSG"/> 
                   <return/>
                 </if>
                 <else>
                   <set name="RSPCOD"            value="02035"/>
                   <set name="RSPMSG"            value="删除用户成功!"/>
                   <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
                   <set name="DWZ_CALLBACK_TYPE" value="forward"/>
                   <set name="DWZ_FORWARD_URL"   value="568088.lim?operating=delete_user.jsp"/>
                   <set name="DWZ_RSP_MSG"       expr="RSPMSG"/> 
                   <return/>
                 </else>
               </else>
           </else>
         </if>
         <else>
           <set name="RSPCOD"                value="02035"/>
           <set name="RSPMSG"                value="此用户正在登录,不能删除!"/>
           <set name="DWZ_STATUS_CODE"       expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_CALLBACK_TYPE"     value="forward"/>
           <set name="DWZ_FORWARD_URL"       value="568088.lim?operating=delete_user.jsp"/>
           <set name="DWZ_RSP_MSG"           expr="RSPMSG"/> 
           <return/>
         </else>
       </else>
     </process>
   </transaction>

   <transaction code="568020"   desc="查询用户的基本信息">
     <sql name="queryExist"><!--查询该用户存不存在-->
       select count(user_id) as userCount from limuseinf  where user_id=#{user_id} and account=#{USER_ACCOUNT}
     </sql>
     <sql name="queryUserInf"><!--查询用户基本信息-->
      select account, user_nam, user_pwd, sys_id, crea_sign, random, user_date, state, desc_inf,USER_EXPIRED_TIME from limuseinf where user_id=#{user_id} and account=#{USER_ACCOUNT}
     </sql>
     <sql name="lastLoginInf"><!--查询用户上次登录信息-->
       select logn_ip, logn_time from limloginf  where user_id=#{user_id} and account=#{USER_ACCOUNT} and logn_time=
       (select max(logn_time) from limloginf  where user_id=#{user_id} and account=#{USER_ACCOUNT} and logn_time !=(select max(logn_time) from limloginf  where user_id=#{user_id} and account=#{USER_ACCOUNT}
        and logn_time=(select max(logn_time) from limloginf  where user_id=#{user_id} and account=#{USER_ACCOUNT})))
     </sql>
     <sql name="queryGroupInf"><!--查询用户对应角色信息-->
      select role_id, role_nam from limrolinf  where role_id=(select role_id from limrurele where account=#{USER_ACCOUNT} and user_id=#{user_id}) and account=#{USER_ACCOUNT}
     </sql>
     <sql name="querySysInf"><!--查询用户对应系统信息-->
       select  sys_nam, sys_state from limsysinf where sys_id=#{sys_id}
     </sql>
     <sql name="queryUserqx"><!--用户对应菜单集合-->
       select d.menu_id as PAGID, d.menu_par_id as PAREID, d.menu_nam as PAGNAM from limmeninf d where d.menu_id in
       (select distinct b.menu_id from limumrele a,limrmrele b where a.account=b.account and a.menu_id=b.menu_id and user_id=#{user_id} and a.account=#{USER_ACCOUNT}
       and b.role_id=(select role_id from limrurele where account=#{USER_ACCOUNT} and user_id=#{user_id})) order by  d.menu_id asc
     </sql>
     <process>
       <do func="GetOwnButton"/>              <!--权限按钮控制-->
       <!--查询用户基本信息-->
       <set name="USER_ID"      expr="SESSIONS.UID"/>
       <set name="USER_ACCOUNT" expr="SESSIONS.USERACCOUNT"/>
       
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd" sql="queryExist"/>
       </do>
       <if condition="#RetCod!=0">
         <set name="RSPCOD"          value="02043"/>
         <set name="RSPMSG"          value="系统错误,验证用户信息失败!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </if>
       <if condition="INTCMP(userCount,4,1)">
         <set name="RSPCOD"          value="02042"/>
         <set name="RSPMSG"          value="数据库信息有误,验证用户信息失败!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </if>
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd" sql="queryUserInf"/>
       </do>
       <if condition="#RetCod!=0">
         <set name="RSPCOD"          value="02042"/>
         <set name="RSPMSG"          value="数据库信息有误,查询获取用户信息失败!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </if>
       <do func="ReadRecord" error="IGNORE">
          <para name="SqlCmd" sql="queryGroupInf"/>
       </do>
       <if condition="#RetCod==-1">
         <set name="RSPCOD"          value="02042"/>
         <set name="RSPMSG"          value="数据库信息有误,获取用户角色信息有误!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </if>
       <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="lastLoginInf"/>
       </do>
       <if condition="IS_EQUAL_STRING(SYS_ID,'1000')">
          <set name="sys_state"  value="1"/>
          <set name="sys_nam"    value="内部系统"/>
       </if>
       <else>
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="querySysInf"/>
         </do>
       </else>
       <!--查询权限信息-->
       <if condition="#RetCod==-1">
         <set name="RSPCOD"          value="02042"/>
         <set name="RSPMSG"          value="数据库信息有误,获取模板权限有误!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
       </if>
       <do func="QueryInGroup" error="IGNORE">
          <para name="SqlCmd"     sql="queryUserqx"/>
          <para name="RecordName" value="USER_LST"/>
       </do>
       <if condition="#RetCod==-1">
         <set name="RSPCOD"          value="02043"/>
         <set name="RSPMSG"          value="数据库信息有误,获取用户权限有误!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
       </if>
       <else>
         <if condition="IS_EQUAL_STRING(USER_EXPIRED_TIME,'')">
           <set name="USER_EXPIRED_TIME" expr="USER_EXPIRED_TIME"/>
         </if>
         <set name="RSPMSG"                  value="查询用户信息成功!"/>
         <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/right/show_right_inf.jsp"/>
         <return/>
       </else>
     </process>
   </transaction>
   
   <transaction code="568022"   desc="修改用户密码">
     <sql name="queryExist">
       select count(user_id) userExist from limuseinf where account=#{USER_ACCOUNT} and user_id=#{user_id} and user_pwd=#{OLA_USER_PWD}
     </sql>
     <sql name="upUserpwd">
       update limuseinf set user_pwd = #{NEW_USER_PWD} ,LAST_UPPWD_DATE = #{cuerrTime},
       pwd_chanum = (SELECT case when pwd_chanum is null then 1 else pwd_chanum+1 end pwd_chanum from limuseinf where user_id = #{USER_ID} and account=#{USER_ACCOUNT} )
        where user_id = #{USER_ID} and account=#{USER_ACCOUNT} 
     </sql>
     <process>
       <set name="USER_ACCOUNT" expr="SESSIONS.USERACCOUNT"/>
       <set name="USER_ID"      expr="SESSIONS.UID"/>
       <set name="NEW_USER_PWD" expr="newPassword"/>
       <set name="OLA_USER_PWD" expr="oldPassword"/> 
       <set name="cuerrTime"    expr="GETDATETIME()"/>
       <if condition="OR(ISNULL(USER_ID),ISNULL(NEW_USER_PWD),ISNULL(OLA_USER_PWD))">
         <set name="RSPCOD"          value="02047"/>
         <set name="RSPMSG"          value="您输入的信息有误,请重新输入!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </if>
       <else>
         <set name="OLA_USER_PWD" expr="MD5STR(OLA_USER_PWD)"/> 
         <set name="NEW_USER_PWD" expr="MD5STR(NEW_USER_PWD)"/> 
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="queryExist"/>
         </do>
         <if condition="INTCMP(userExist,3,1)">
           <!--判断新修改密码不能和原密码相同 add 邓文康 for 2013-04-08-->
           <if condition="IS_EQUAL_STRING(OLA_USER_PWD,NEW_USER_PWD)">
             <set name="RSPCOD"          value="02049"/>
             <set name="RSPMSG"          value="新密码不能和原密码相同,请重新输入新密码!"/>
             <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
             <return/>
           </if>
           <do func="ExecSql" error="IGNORE">
             <para name="SqlCmd" sql="upUserpwd"/>
           </do>
           <if condition="#RetCod==0">
             <set name="RSPCOD"            value="00000"/>
             <set name="RSPMSG"            value="成功修改密码,请重新登录！"/>
             <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
             <set name="DWZ_CALLBACK_TYPE" value="forward"/>
             <set name="DWZ_FORWARD_URL"   value="568020.lim"/>
             <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
             <return/>
           </if>
           <else>
             <do func="RollBackWork"/>
             <set name="RSPCOD"            value="02049"/>
             <set name="RSPMSG"            value="修改密码失败!"/>
             <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
             <return/>
           </else>
         </if>
         <else>
           <set name="RSPCOD"              value="02048"/>
           <set name="RSPMSG"              value="原密码不正确!"/>
           <set name="DWZ_STATUS_CODE"     expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"         expr="RSPMSG"/>
           <return/>
         </else>
       </else>
     </process>
   </transaction>
   
   <transaction code="568026"   desc="重置密码">
     <sql name="risteUserPwd">
       update limuseinf set user_pwd=#{NEW_USER_PWD} where user_id=#{user_id} and account=#{account}
     </sql>
     <process>
       <if condition="OR(ISNULL(user_id),ISNULL(account))">
         <set name="RSPCOD"          value="02051"/>
         <set name="RSPMSG"          value="获取用户基本信息失败!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/> 
       </if>
       <set name="UrlConfig"    value="passwdper"/>
       <quote name="ReadXmlCfg"/>
       <set name="NEW_USER_PWD" expr="MD5STR(merpasswd)"/> 
       <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="risteUserPwd"/>
       </do>
       <if condition="#RetCod!=0">
         <if condition="#RetCod==-1">
           <do func="RollBackWork"/>
           <set name="RSPCOD"            value="02051"/>
           <set name="RSPMSG"            value="操作数据库失败,重置密码失败!"/>
           <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_CALLBACK_TYPE" value="forward"/>
           <set name="DWZ_FORWARD_URL"   value="568004.lim"/>
           <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
           <return/>
         </if>
         <else>
           <do func="RollBackWork"/>
           <set name="RSPCOD"            value="02051"/>
           <set name="RSPMSG"            value="用户密码重置失败!"/>
           <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_CALLBACK_TYPE" value="forward"/>
           <set name="DWZ_FORWARD_URL"   value="568004.lim"/>
           <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
           <return/>
         </else>
       </if>
       <else>
         <set name="RSPCOD"              value="00000"/>
         <set name="RSPMSG"              expr="STRCAT('重置密码成功,重置密码为', merpasswd,'请牢记!')"/>
         <set name="DWZ_STATUS_CODE"     expr="DWZ_SUCCESS_CODE"/>
         <set name="DWZ_CALLBACK_TYPE"   value="forward"/>
         <set name="DWZ_FORWARD_URL"     value="568004.lim"/>
         <set name="DWZ_RSP_MSG"         expr="RSPMSG"/>
         <return/>
       </else>
     </process>
   </transaction>

   <transaction code="568027"   desc="分页且带条条件查询菜单信息">
     <sql name="queryMenuList">
         select a.menu_id, (case when node_type ='menu' then '菜单' when node_type ='button' then '按钮' when node_type ='approval' then '后台特殊菜单' else '未知' end) node_type
         , (select count(menu_id) from limmeninf where menu_par_id=a.menu_id and sys_id=a.sys_id ) as menu_count, a.menu_par_id, a.menu_nam, a.menu_url, a.menu_state, a.sys_id ,(case when 
        (select sys_type from limsysinf where sys_id=a.sys_id)='1000' then '内部系统' else (select sys_nam from limsysinf where sys_id=a.sys_id) end) as sys_nam ,parnam
        from limmeninf a,(select menu_id as  parid ,menu_nam as parnam from limmeninf ) b
         where menu_par_id = parid ${tj} order by a.menu_date desc, a.menu_id desc
     </sql>
     <sql name="querySysIdList">
       select sys_id,sys_nam from limsysinf where sys_type !='1000'
     </sql>
     <process>
        <do func="GetOwnButton"/>              <!--权限按钮控制-->
        <set name="tj" value=""/>
        <!--菜单状态-->
        <if condition="AND(NOT(ISNULL(MENU_STATE)),IS_NOEQUAL_STRING(MENU_STATE,'-1'))">
         <set name="tj" expr="STRCAT(tj,' and menu_state = \'', MENU_STATE ,'\'')"/>
        </if>
        <else>
          <set name="MENU_STATE" value="-1"/>
        </else>
        <!--菜单类型-->
        <if condition="AND(NOT(ISNULL(NODE_TYPE)),IS_NOEQUAL_STRING(NODE_TYPE,'-1'))">
          <if condition="IS_EQUAL_STRING(NODE_TYPE,'2')">
            <set name="tj" expr="STRCAT(tj,' and NODE_TYPE like \'button\'')"/>
          </if>
          <elseif condition="IS_EQUAL_STRING(NODE_TYPE,'1')">
            <set name="tj" expr="STRCAT(tj,' and NODE_TYPE like \'menu\'')"/>
          </elseif>
          <else>
            <set name="NODE_TYPE" value="-1"/>
          </else>
        </if>
        <else>
          <set name="NODE_TYPE"   value="-1"/>
        </else>
        <!--系统类型-->
        <if condition="AND(NOT(ISNULL(SYS_ID)),IS_NOEQUAL_STRING(SYS_ID,'-1'))">
        <if condition="IS_EQUAL_STRING(SYS_ID,'1000')">
           <set name="tj" expr="STRCAT(tj,' and a.sys_id in (select sys_id from limsysinf where sys_type =\'', SYS_ID ,'\')')"/>
        </if>
        <else>
           <set name="tj" expr="STRCAT(tj,' and a.sys_id = \'', SYS_ID ,'\'')"/>
        </else>
       </if>
       <else>
         <set name="SYS_ID" value="-1"/>
       </else>
       <set name="tj" expr="STRCAT(tj,' and menu_nam like \'%' ,MENU_NAM_SIGN,'%\'')"/>
       <set name="tj" expr="STRCAT(tj,' and parnam like \'%' ,MENU_PAR_NAM_SIGN,'%\'')"/>
       <!--查询系统信息集合-->
       <do func="QueryInGroup" error="IGNORE">
         <para name="SqlCmd"     sql="querySysIdList"/>
         <para name="RecordName" value="SYSL_LST"/>
       </do>
       <if condition="#RetCod!=-1">
         <if condition="ISNULL(PageNum)">
           <set name="PageNum" value="1"/>
         </if>
         <if condition="ISNULL(NumPerPag)">
           <set name="NumPerPag" value="19"/>
         </if>
         <do func="PagedQuery" error="IGNORE">
           <para name="PageNum"   expr="PageNum"/>
           <para name="NumPerPag" expr="NumPerPag"/>
           <para name="sql"       sql="queryMenuList"/>
         </do>
         <set name="SYS_ID" expr="DELSPACE(SYS_ID,'all')"/>
         <if condition="#RetCod!=-1">
           <!--查询成功-->
           <set name="RSPCOD" value="00000"/>   
           <set name="RSPMSG" value="查询菜单信息成功!"/>
           <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/right/show_menu_list.jsp"/>
           <return/>
         </if>
         <else>
           <set name="RSPCOD" value="00000"/>   
           <set name="RSPMSG" value="查询菜单信息成功!"/>
           <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/right/show_menu_list.jsp"/>
           <return/>
         </else>
       </if>
       <!--分页查询菜单信息集合-->
       <else>
         <set name="RSPCOD" value="02061"/>
         <set name="RSPMSG" value="查询系统系统时,操作数据库有误!"/>
         <set name="_REQUESTATTR.FORWARDURL" value="right/show_menu_list.jsp"/>
         <return/>
       </else>
     </process>
   </transaction>

   <transaction code="568029"   desc="分页查询系统信息">
     <sql name="querySysInf">
       select sys_id, sys_nam, sys_abbr, sys_state, sys_desc, sys_type, sys_url from limsysinf where 1=1 ${tj} order by sys_date desc
     </sql>
     <process>
        <do func="GetOwnButton"/>              <!--权限按钮控制-->
        <set name="tj" value=""/>
        <!--系统状态-->
        <if condition="AND(NOT(ISNULL(SYS_STATE_SIGN)),IS_NOEQUAL_STRING(SYS_STATE_SIGN,'-1'))">
          <set name="tj" expr="STRCAT(tj,' and sys_state = \'', SYS_STATE_SIGN ,'\'')"/>
        </if>
        <else>
          <set name="SYS_STATE_SIGN" value="-1"/>
        </else>
        <!--系统类型-->
        <if condition="AND(NOT(ISNULL(SYS_TYPE_SIGN)),IS_NOEQUAL_STRING(SYS_TYPE_SIGN,'-1'))">
          <if condition="IS_EQUAL_STRING(SYS_TYPE_SIGN,'1000')">
            <set name="tj" expr="STRCAT(tj,' and sys_type = \'', SYS_TYPE_SIGN ,'\'')"/>
          </if>
          <else>
            <set name="tj" expr="STRCAT(tj,' and sys_type != 1000')"/>
          </else>
       </if>
       <else>
         <set name="SYS_TYPE_SIGN" value="-1"/>
       </else>
       <set name="tj" expr="STRCAT(tj,' and sys_nam like \'%' ,SYS_NAM_SIGN,'%\'')"/>
       
       <if condition="ISNULL(PageNum)">
         <set name="PageNum" value="1"/>
       </if>
       <if condition="ISNULL(NumPerPag)">
         <set name="NumPerPag" value="19"/>
       </if>
       <do func="PagedQuery" error="IGNORE">
         <para name="PageNum"   expr="PageNum"/>
         <para name="NumPerPag" expr="NumPerPag"/>
         <para name="Sql"       sql="querySysInf"/>
       </do>
       <if condition="#RetCod!=-1">
         <set name="RSPCOD" value="00000"/>   
         <set name="RSPMSG" value="查询系统信息成功!"/>
         <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/right/show_sys_list.jsp"/>
         <return/>
       </if>
       <else>
         <set name="RSPCOD" value="02036"/>
         <set name="RSPMSG" value="操作数据库失败,查询系统信息失败!"/>
         <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/right/show_sys_list.jsp"/>
         <return/>
       </else>
     </process>
   </transaction>

   <transaction code="568041"   desc="用户退出">
     <process>      
       <set name="USER_ID"    expr="SESSIONS.UID"/>
       <set name="RANDOM"     expr="SESSIONS.RANDOM"/>
       <set name="isvalid"    expr="SetSessionInvalid()"/><!--清空session-->
       <set name="TxnCod"     value="568038"/>
       <do func="CallThirdOther" error="IGNORE">
         <para name="code"     value="568051"/>
         <para name="channel"  value="STHDMNG1"/>
       </do>
       <if condition="#RetCod!=0">
         <set name="RSPCOD" value="02037"/>
         <set name="RSPMSG" value="调用退出接口失败!"/>
         <set name="RSPMSG" expr="retMsg"/>
         <set name="_REQUESTATTR.FORWARDURL" value="/tran_error.jsp"/>
         <return/>
         <return/>
       </if>
       <else>
         <set name="RSPCOD" value="00000"/>
         <set name="RSPMSG" expr="retMsg"/>
         <set name="status" expr="status"/>
         <set name="_REQUESTATTR.REDIRECTURL" expr="outUrl"/>
         <return/>
       </else>
     </process>
   </transaction>
   
   <transaction code="568042"   desc="添加菜单前置信息查询">
    <sql name="querySysIdList">
       select sys_id,sys_nam from limsysinf
     </sql>
     <sql name="queryButtonList">
        select button_id, button_ch_nam,button_en_nam from limbutinf where button_show='1' order by button_id
     </sql>
     <sql name="queryAdbpiList"><!--查询一个固定的信息-->
     select 'adbpi' as ADBPI from dual
     </sql>
     <process>
       <do func="QueryInGroup" error="IGNORE">
          <para name="SqlCmd"     sql="queryButtonList"/>
          <para name="RecordName" value="BUT_LST"/>
       </do>
       <if condition="#RetCod==-1">
           <do func="RollBackWork"/>
           <set name="RSPCOD"          value="02063"/>
           <set name="RSPMSG"          value="获取按钮信息失败!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
       </if>
       <do func="QueryInGroup" error="IGNORE">
          <para name="SqlCmd"     sql="querySysIdList"/>
          <para name="RecordName" value="SYS_LST"/>
       </do>
       <if condition="#RetCod!=-1">
         <do func="QueryInGroup" error="IGNORE">
          <para name="SqlCmd"     sql="queryAdbpiList"/>
          <para name="RecordName" value="MORE_LST"/>
         </do>
          <set name="RSPCOD" value="00000"/>
          <set name="RSPMSG" value="查询添加菜单前置信息成功!"/>
          <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/right/add_menu_info.jsp"/>
          <return/>
       </if>
       <else>
           <do func="RollBackWork"/>
           <set name="RSPCOD"          value="02061"/>
           <set name="RSPMSG"          value="查询系统信息失败!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
       </else>
     </process>
   </transaction>

   <transaction code="568043"   desc="添加菜单">
     <sql name="insertMenuInf">
      insert into limmeninf (MENU_ID, MENU_PAR_ID, MENU_NAM, MENU_URL, MENU_STATE, NODE_TYPE, SYS_ID, MENU_DATE, BUTTON_ID)
      values (#{MENU_ID}, #{MENU_PAR_ID}, #{MENU_NAM}, #{MENU_URL}, #{MENU_STATE}, #{NODE_TYPE}, #{SYS_ID}, #{currentTime}, #{BUT_ID})
     </sql>
     <sql name="queryButName">
     select button_ch_nam as menu_nam from limbutinf where button_id=#{BUT_ID}
     </sql>
     <process>
        <set name="SYS_ID"  expr="SYS_ID1"/>
        <if condition="OR(ISNULL(SYS_ID),IS_EQUAL_STRING(SYS_ID,'-1'))">
           <set name="RSPCOD"          value="02071"/>
           <set name="RSPMSG"          value="请选择所属系统,谢谢!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
        </if>
        <if condition="OR(ISNULL(MENU_LEVEL),IS_EQUAL_STRING(MENU_LEVEL,'-1'))">
           <set name="RSPCOD"          value="02071"/>
           <set name="RSPMSG"          value="请选择菜单级别,谢谢!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
        </if>
        <if condition="OR(ISNULL(MENU_PAR_ID),IS_EQUAL_STRING(MENU_PAR_ID,'-1'))">
           <set name="RSPCOD"          value="02071"/>
           <set name="RSPMSG"          value="请选择对应父节菜单,谢谢!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
        </if>
        <if condition="OR(ISNULL(MENU_NAM),IS_EQUAL_STRING(MENU_NAM,''))">
           <set name="RSPCOD"          value="02073"/>
           <set name="RSPMSG"          value="菜单名称不能为空,请输入菜单名称,谢谢!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
        </if>
        <set name="MENU_ID"      expr="GETNODE(MENU_PAR_ID,SYS_ID)"/> <!--获取新增菜单的ID-->
        <set name="MENU_STATE"   expr="MENU_STATE"/>                      <!--新增菜单状态 1 可用 0禁用-->
        <set name="NODE_TYPE"    value="menu"/>                           <!--新增菜单类型-->
        <set name="currentTime"  expr="GETDATETIME()"/>                   <!--新增菜单时系统时间-->
        <set name="BUT_ID"       value=""/>                               <!--菜单按钮ID-->
        <!--添加菜单-->
        <do func="ExecSql" error="IGNORE">
          <para name="SqlCmd" sql="insertMenuInf"/>
        </do>
        <if condition="#RetCod==-1">
            <do func="RollBackWork"/>
            <set name="RSPCOD"            value="02076"/>
            <set name="RSPMSG"            value="操作数据库错误,添加菜单失败!"/>
            <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
            <set name="DWZ_CALLBACK_TYPE" value="forward"/>
            <set name="DWZ_FORWARD_URL"   value="568027.lim"/>
            <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
            <return/>
        </if>
        <set name="MENU_PAR_ID"   expr="MENU_ID"/>
        <delete name="MENU_ID"/>   <!--防止和按钮获取的菜单ID重复-->
        <set name="NODE_TYPE"     value="button"/>
        <!--为新增按钮新增名称、url 状态 start-->
        <foreach name="typeInf" iterator="#tmp">
          <if condition="AND(NOT(ISNULL(#tmp)),IS_NOEQUAL_STRING(#tmp,''))">
           <set name="BUT_ID"           expr="GETWORDDELIMITER(#tmp,'-^',1)"/>
           <set name="MENU_NAM"         expr="GETWORDDELIMITER(#tmp,'-^',2)"/>
           <set name="MENU_URL"         expr="GETWORDDELIMITER(#tmp,'-^',3)"/>
           <set name="MENU_STATE"       expr="GETWORDDELIMITER(#tmp,'-^',4)"/>
           <set name="MENU_ID"          expr="GETNODE(MENU_PAR_ID,SYS_ID)"/>
           <do func="ExecSql"  error="IGNORE">
             <para name="SqlCmd"  sql="insertMenuInf"/>
           </do>
           <if condition="#RetCod==-1">
             <do func="RollBackWork"/>
             <set name="RSPCOD"            value="02076"/>
             <set name="RSPMSG"            value="操作数据库错误,添加菜单失败!"/>
             <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_CALLBACK_TYPE" value="forward"/>
             <set name="DWZ_FORWARD_URL"   value="568027.lim"/>
             <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
             <return/>
           </if>
          </if>
          <else>
           <!--不添加按钮的时候或集合中间有不添加按钮的情况-->
           <set name="#RetCod" value="0"/>
          </else>
       </foreach>
       <if condition="#RetCod==0">
          <set name="RSPCOD"            value="00000"/>
          <set name="RSPMSG"            value="添加菜单成功!"/>
          <set name="menuurl"           expr="STRCAT('568027.lim?SYS_ID=',SYS_ID)"/>
          <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
          <set name="DWZ_CALLBACK_TYPE" value="forward"/>
          <set name="DWZ_FORWARD_URL"   expr="menuurl"/>
          <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
          <return/>
       </if>
       <else>
          <do func="RollBackWork"/>
          <set name="RSPCOD"            value="02076"/>
          <set name="RSPMSG"            value="操作数据库错误,添加菜单失败!"/>
          <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_CALLBACK_TYPE" value="forward"/>
          <set name="DWZ_FORWARD_URL"   value="568027.lim"/>
          <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
          <return/>
       </else>   
     </process>
   </transaction>

   <transaction code="568044"   desc="删除菜单">
       <sql name="deleteMenuById">
         delete from limmeninf where (menu_id=#{MENU_ID} and menu_par_id=#{MENU_PAR_ID}) or (menu_par_id = #{MENU_ID} and NODE_TYPE like 'button%')  and sys_id=#{SYS_ID}
       </sql> 
       <process>
        <if condition="OR(ISNULL(MENU_ID),ISNULL(MENU_PAR_ID),ISNULL(SYS_ID))">
           <set name="RSPCOD"          value="02078"/>
           <set name="RSPMSG"          value="获取该项菜单信息有误,删除失败!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
        </if>
        <!--删除菜单信息-->
        <do func="ExecSql" error="IGNORE">
          <para name="SqlCmd" sql="deleteMenuById"/>
        </do>
        <if condition="#RetCod==0">
           <set name="RSPCOD"            value="00000"/>
           <set name="RSPMSG"            value="删除成功!"/>  
           <set name="menuurl"           expr="STRCAT('568027.lim?SYS_ID=',SYS_ID)"/>
           <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
           <set name="DWZ_CALLBACK_TYPE" value="forward"/>
           <set name="DWZ_FORWARD_URL"   expr="menuurl"/>
           <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
           <return/>
        </if>
        <else>
           <do func="RollBackWork"/>
           <set name="RSPCOD"          value="02079"/>
           <set name="RSPMSG"          value="删除菜单失败!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
        </else>
       </process>
   </transaction>

   <transaction code="568045"   desc="修改菜单-查询指定菜单信息">
      <sql name="queryMenuinf">
       select length(menu_id)/2 as menu_level,menu_url,menu_id,menu_par_id,menu_nam ,menu_state,sys_nam from limmeninf m,limsysinf s where m.sys_id=s.sys_id and m.menu_id=#{MENU_ID} and m.menu_par_id=#{MENU_PAR_ID} and m.sys_id=#{SYS_ID} and m.node_type !='button'
      </sql>
      <sql name="queryButList">
         select * from limbutinf b left join  ( select button_id as button_xs  from  limmeninf where menu_par_id=#{MENU_ID} and node_type='button') s on b.button_id=s.button_xs
      </sql>
      <sql name="queryISMneuOrBut">
       select node_type from limmeninf where menu_id =#{MENU_ID}
      </sql>
      <sql name="queryButinf">
      select menu_url,menu_id,(select menu_nam from limmeninf where menu_id =m.menu_par_id )  as menu_par_nam,menu_nam ,menu_state,sys_nam from limmeninf m,limsysinf s where m.sys_id=s.sys_id and m.menu_id=#{MENU_ID} and m.menu_par_id=#{MENU_PAR_ID} and m.sys_id=#{SYS_ID} and m.node_type ='button'
      </sql>
      <sql name="queryButtonList">
        SELECT BUTTON_ID, BUTTON_CH_NAM,BUTTON_EN_NAM FROM LIMBUTINF WHERE BUTTON_SHOW='1' ORDER BY BUTTON_ID 
      </sql>
      <sql name="queryButCount">
       SELECT COUNT(*) AS BUTCOUNT FROM LIMMENINF WHERE MENU_PAR_ID=#{MENU_ID} AND NODE_TYPE='button' AND SYS_ID=#{SYS_ID}
      </sql>
      <sql name="queryMenuHasBut">
        SELECT MENU_ID,MENU_PAR_ID,MENU_NAM ,MENU_URL,BUTTON_ID,MENU_STATE FROM LIMMENINF WHERE MENU_PAR_ID=#{MENU_ID} AND NODE_TYPE='button' AND SYS_ID=#{SYS_ID} ORDER BY MENU_ID
      </sql>
      <sql name="queryMenuNotHasBut">
        SELECT '' AS MENU_ID ,'' AS MENU_PAR_ID,'' AS MENU_NAM,'' AS MENU_URL,'' SYS_ID,'' AS BUTTON_ID,'1' AS MENU_STATE FROM DUAL
      </sql>
      <process>
        <if condition="OR(ISNULL(MENU_ID),ISNULL(MENU_PAR_ID),ISNULL(SYS_ID))">
          <set name="RSPCOD"          value="02080"/>
          <set name="RSPMSG"          value="获取该项菜单信息有误,跳转失败!"/>
          <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
          <return/>
        </if>
        <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="queryISMneuOrBut"/>
        </do>
        <if condition="#RetCod!=0">
           <set name="RSPCOD"            value="02038"/>
           <set name="RSPMSG"            value="获取菜单详细信息失败!"/>
           <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
           <return/>
        </if>
        <!--按钮-->
        <if condition="IS_EQUAL_STRING(NODE_TYPE,'button')">
          <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="queryButinf"/>
          </do>
          <if condition="#RetCod!=0">
             <if condition="#RetCod==2">
               <set name="RSPCOD"            value="02038"/>
               <set name="RSPMSG"            value="该按钮信息为空,修改失败!"/>
               <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
               <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
               <return/>
             </if>
             <else>
               <set name="RSPCOD"            value="02038"/>
               <set name="RSPMSG"            value="获取按钮详细信息失败!"/>
               <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
               <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
               <return/>
             </else>
          </if>
          <else>
            <set name="RSPCOD" value="00000"/>
            <set name="RSPMSG" value="查询该条按钮信息记录成功!"/>
            <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/right/up_button_info.jsp"/>
            <return/>
          </else>
        </if>
        <!--菜单和后台特殊菜单-->
        <else>
           <do func="QueryInGroup" error="IGNORE">
              <para name="SqlCmd"      sql="queryButtonList"/>
              <para name="RecordName"  value="BUT_LST"/>
           </do>
           <if condition="#RetCod==-1">
              <set name="RSPCOD"            value="02039"/>
              <set name="RSPMSG"            value="获取按钮信息失败!"/>
              <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
              <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
              <return/>
           </if>
           <!--查询该菜单包含几个按钮-->
           <do func="ReadRecord" error="IGNORE">
              <para name="SqlCmd" sql="queryButCount"/>
           </do>
           <if condition="#RetCod==-1">
              <set name="RSPCOD"            value="02040"/>
              <set name="RSPMSG"            value="获取按钮信息失败!"/>
              <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
              <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
              <return/>
           </if>
           <if condition="INTCMP(BUTCOUNT,6,0)">
             <!--有按钮-->
             <do func="QueryInGroup" error="IGNORE">
              <para name="SqlCmd"      sql="queryMenuHasBut"/>
              <para name="RecordName"  value="HASMOM_LST"/>
             </do>
           </if>
           <else>
             <!--没有按钮-->
             <do func="QueryInGroup" error="IGNORE">
              <para name="SqlCmd"      sql="queryMenuNotHasBut"/>
              <para name="RecordName"  value="HASMOM_LST"/>
             </do>
           </else>
           <do func="ReadRecord" error="IGNORE">
              <para name="SqlCmd" sql="queryMenuinf"/>
           </do>
           <if condition="#RetCod==0">
             <set name="RSPCOD"          value="00000"/>
             <set name="node_type"       expr="DELSPACE(node_type,'all')"/>
             <set name="RSPMSG"          value="查询该条菜单记录成功!"/>
             <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/right/up_menu_info.jsp"/>
             <return/>
           </if>
           <elseif condition="#RetCod==2">
             <set name="RSPCOD"          value="02081"/>
             <set name="RSPMSG"          value="查询该条记录为空,页面跳转失败!"/>
             <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
             <return/>
           </elseif>
           <else>
             <set name="RSPCOD"          value="02082"/>
             <set name="RSPMSG"          value="查询系统数据失败!"/>
             <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
             <return/>
           </else>
        </else>
      </process>
   </transaction>
   
   <transaction code="568046"   desc="修改菜单">
     <sql name="updateMenuInf">
       update limmeninf set menu_nam = #{MENU_NAM}, menu_url = #{MENU_URL}, menu_state = #{MENU_STATE},MENU_DATE=#{currentTime} where menu_id = #{MENU_ID}  and sys_id = #{SYS_ID}
     </sql>
     <sql name="deleteButonLst"><!--删除该菜单原控制按钮 非操作按钮-->
      delete from  limmeninf where menu_par_id=#{MENU_ID} and node_type='button'and sys_id = #{SYS_ID}
     </sql>
     <sql name="insertMenuInf">
      insert into limmeninf (MENU_ID, MENU_PAR_ID, MENU_NAM, MENU_URL, MENU_STATE, NODE_TYPE, SYS_ID, MENU_DATE, BUTTON_ID)
      values (#{MENU_ID}, #{MENU_PAR_ID}, #{MENU_NAM}, #{MENU_URL}, #{MENU_STATE}, #{NODE_TYPE}, #{SYS_ID}, #{currentTime}, #{BUT_ID})
     </sql>
     <sql name="queryButName">
      select button_ch_nam as menu_nam from limbutinf where button_id=#{BUT_ID}
     </sql>
     <process> 
        <if condition="OR(ISNULL(MENU_ID),ISNULL(SYS_ID))">
          <set name="RSPCOD"          value="02081"/>
          <set name="RSPMSG"          value="获取该项菜单信息有误,跳转失败!"/>
          <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG"     expr="RSPMSGs"/>
          <return/>
        </if>
        <if condition="ISNULL(MENU_NAM)">
          <set name="RSPCOD"          value="02083"/>
          <set name="RSPMSG"          value="菜单名称不能为空!"/>
          <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
          <return/>
        </if>
        <set name="currentTime"       expr="GETDATETIME"/>
        <!--修改菜单信息-->
        <do func="ExecSql" error="IGNORE">
           <para name="SqlCmd" sql="updateMenuInf"/>
        </do>
        <if condition="#RetCod != 0">
          <do func="RollBackWork"/>
          <if condition="#RetCod==2">
            <set name="RSPCOD"          value="02088"/>
            <set name="RSPMSG"          value="对不起,数据库中没有该项记录,修改失败!"/>
            <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
            <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
            <return/>
          </if>
          <else>
             <set name="RSPCOD"          value="02089"/>
             <set name="RSPMSG"          value="数据库操作有误,修改失败!"/>
             <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
             <return/>
          </else>
        </if>
        <!--修改对应按钮信息-->
        <!--删除原来所有按钮-->
        <do func="ExecSql" error="IGNORE">
           <para name="SqlCmd" sql="deleteButonLst"/>
        </do>
        <if condition="#RetCod==-1">
           <do func="RollBackWork"/>
           <set name="RSPCOD"          value="02089"/>
           <set name="RSPMSG"          value="清空原按钮信息时数据库操作有误,修改失败!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
        </if>
        <!--增加新按钮-->
        <set name="MENU_PAR_ID"    expr="MENU_ID"/>
        <delete name="MENU_ID"/>   <!--防止和按钮获取的菜单ID重复-->
        <set name="NODE_TYPE"      value="button"/>
        <!--为修改菜单按钮新增名称、url 状态-->
        <foreach name="typeInf" iterator="#tmp">
           <if condition="AND(NOT(ISNULL(#tmp)),IS_NOEQUAL_STRING(#tmp,''))">
            <set name="BUT_ID"           expr="GETWORDDELIMITER(#tmp,'-^',1)"/>
            <set name="MENU_NAM"         expr="GETWORDDELIMITER(#tmp,'-^',2)"/>
            <set name="MENU_URL"         expr="GETWORDDELIMITER(#tmp,'-^',3)"/>
            <set name="MENU_STATE"       expr="GETWORDDELIMITER(#tmp,'-^',4)"/>
            <set name="MENU_ID" expr="GETNODE(MENU_PAR_ID,SYS_ID)"/>
            <do func="ExecSql"  error="IGNORE">
              <para name="SqlCmd"  sql="insertMenuInf"/>
            </do>
            <if condition="#RetCod==-1">
              <do func="RollBackWork"/>
              <set name="RSPCOD" value="02076"/>
              <set name="RSPMSG" value="操作数据库错误,添加菜单失败!"/>
              <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
              <set name="DWZ_CALLBACK_TYPE" value="forward"/>
              <set name="DWZ_FORWARD_URL" value="568027.lim"/>
              <set name="DWZ_RSP_MSG" expr="RSPMSG"/>
              <return/>
            </if>
           </if>
           <else>
            <!--不添加按钮的时候或集合中间有不添加按钮的情况-->
            <set name="#RetCod" value="0"/>
           </else>
        </foreach>
        <if condition="#RetCod!=-1">
          <set name="RSPCOD"            value="00000"/>
          <set name="RSPMSG"            value="修改菜单成功!"/>  
          <set name="menuurl"           expr="STRCAT('568027.lim?SYS_ID=',SYS_ID)"/>
          <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
          <set name="DWZ_CALLBACK_TYPE" value="forward"/>
          <set name="DWZ_FORWARD_URL"   expr="menuurl"/>
          <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
        </if>
        <else>
          <do func="RollBackWork"/>
          <set name="RSPCOD"            value="02089"/>
          <set name="RSPMSG"            value="发生未知错误,修改失败!"/>
          <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
          <return/>
        </else>
      </process>
   </transaction>
   
   <transaction code="568047"   desc="添加系统">
     <sql name="querySysId1">
         select (max(sys_id)+5) || '' as CURRSYSID  from limsysinf where sys_type=#{SYS_TYPE}
     </sql>
      <sql name="querySysId2">
         select (max(sys_id)+1) || '' as CURRSYSID from limsysinf where sys_type !='1000'
     </sql>
     <sql name="querySysExit">
       select count(sys_id) as signCount from limsysinf where sys_abbr=#{SYS_ABBR}
     </sql>
     <sql name="querySysNameExit">
       select count(sys_id) as signNameCount from limsysinf where sys_nam=#{SYS_NAM}
     </sql>
     <sql name="queryMenuExit">
       select count(menu_id) as menuCount from limmeninf where menu_par_id='00' and menu_id=#{SYS_ROOTID}
     </sql>
     <sql name="insetSystInf">
        insert into limsysinf (sys_id, sys_nam, sys_abbr, sys_state, sys_desc, sys_type, sys_url, sys_rootid,sys_date) values
      (#{SYS_ID}, #{SYS_NAM}, #{SYS_ABBR}, #{SYS_STATE}, #{SYS_DESC}, #{SYS_TYPE}, #{SYS_URL},#{SYS_ROOTID},#{currentTime})
     </sql>
     <sql name="insetMenuInf">
        insert into limmeninf (menu_id, menu_par_id, menu_nam, menu_url, menu_state, node_type, sys_id,menu_date) values
        (#{SYS_ROOTID},'00', #{SYS_NAM}, #{MENU_URL}, #{SYS_STATE}, 'menu', #{SYS_ID},#{currentTime})
     </sql>
      <process>
         <if condition="OR(ISNULL(SYS_TYPE),IS_EQUAL_STRING(SYS_TYPE,'-1'))">
           <set name="RSPCOD"          value="02071"/>
           <set name="RSPMSG"          value="请选择系统类型,谢谢!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
        </if>
        <if condition="OR(ISNULL(SYS_ROOTID),ISNULL(SYS_NAM),ISNULL(SYS_ABBR),ISNULL(SYS_URL))">
           <set name="RSPCOD"          value="02089"/>
           <set name="RSPMSG"          value="您输入的信息不完整,请完善信息后在提交!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
        </if>
        <if condition="NOT(ISNUMBER(SYS_ROOTID))">
           <set name="RSPCOD"          value="02089"/>
           <set name="RSPMSG"          value="系统根节点编号必须为数字类型!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
        </if>
        <!--生成系统ID-->
        <if condition="IS_EQUAL_STRING(SYS_TYPE,'1000')">
           <do func="ReadRecord" error="IGNORE">
              <para name="SqlCmd" sql="querySysId1"/>
           </do>
        </if>
        <else>
           <do func="ReadRecord" error="IGNORE">
              <para name="SqlCmd" sql="querySysId2"/>
           </do>
        </else>
        <set name="SYS_ID" expr="CURRSYSID"/>
        <if condition="ISNULL(SYS_ID)">
           <do func="RollBackWork"/>
           <set name="RSPCOD"          value="02093"/>
           <set name="RSPMSG"          value="系统ID生成失败,请稍后再试此操作!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/> 
        </if>

        <!--验证输入的系统ID和系统简称是否有重复 单一重复也不行-->
        <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="querySysExit"/>
        </do>
        <if condition="#RetCod==0">
           <if condition="NOT(IS_EQUAL_INT(signCount,0))">
             <do func="RollBackWork"/>
             <set name="RSPCOD"          value="02089"/>
             <set name="RSPMSG"          value="该系统ID或简称已重复,请重新输入!"/>
             <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
             <return/>
           </if>
           <!--验证系统根节点编号是否已占用-->
           <do func="ReadRecord" error="IGNORE">
              <para name="SqlCmd" sql="queryMenuExit"/>
           </do>
           <if condition="#RetCod!=0">
             <do func="RollBackWork"/>
             <set name="RSPCOD"          value="02089"/>
             <set name="RSPMSG"          value="验证系统根节点编号时,操作数据库有误!"/>
             <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
             <return/>
           </if>
           <if condition="NOT(IS_EQUAL_INT(menuCount,0))">
             <do func="RollBackWork"/>
             <set name="RSPCOD"          value="02089"/>
             <set name="RSPMSG"          value="您输入的系统根节点编号已经被使用,请重新输入!"/>
             <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
             <return/>
           </if>
           <!--验证系统名称是否重复-->
           <do func="ReadRecord" error="IGNORE">
              <para name="SqlCmd" sql="querySysNameExit"/>
           </do>
           <if condition="#RetCod!=0">
             <do func="RollBackWork"/>
             <set name="RSPCOD"          value="02089"/>
             <set name="RSPMSG"          value="验证系统名称是否重复时,操作数据库有误!"/>
             <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
             <return/>
           </if>
           <if condition="NOT(IS_EQUAL_INT(menuCount,0))">
             <do func="RollBackWork"/>
             <set name="RSPCOD"          value="02089"/>
             <set name="RSPMSG"          value="您输入的系统名称已经被使用,请重新输入!"/>
             <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
             <return/>
           </if>
           <set name="currentTime"       expr="GETDATETIME()"/><!--获得当前登录时间-->
           <!--添加系统-->
           <do func="ExecSql" error="IGNORE">
              <para name="SqlCmd" sql="insetSystInf"/>
           </do>
           <if condition="#RetCod!=0">
             <do func="RollBackWork"/>
             <set name="RSPCOD"            value="02090"/>
             <set name="RSPMSG"            value="添加系统信息失败,请稍后再试!"/>
             <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_CALLBACK_TYPE" value="forward"/>
             <set name="DWZ_FORWARD_URL"   value="568029.lim"/>
             <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
             <return/>
           </if>
           <!--添加系统菜单-->
           <!--<do func="ExecSql" error="IGNORE">
             <para name="SqlCmd" sql="insetMenuInf"/>
           </do>
           <if condition="#RetCod!=0">
             <do func="RollBackWork"/>
             <set name="RSPCOD"            value="02091"/>
             <set name="RSPMSG"            value="添加系统菜单信息失败,请稍后再试!"/>
             <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_CALLBACK_TYPE" value="forward"/>
             <set name="DWZ_FORWARD_URL"   value="568029.lim"/>
             <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
             <return/>
           </if>-->
           <else>
             <set name="RSPCOD"            value="00000"/>
             <set name="RSPMSG"            value="添加系统成功!"/>
             <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
             <set name="DWZ_CALLBACK_TYPE" value="forward"/>
             <set name="DWZ_FORWARD_URL"   value="568029.lim"/>
             <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
             <return/>
           </else>
        </if>
        <elseif>
           <do func="RollBackWork"/>
           <set name="RSPCOD"           value="02089"/>
           <set name="RSPMSG"           value="验证系统ID和简称时,操作数据库有误!"/>
           <set name="DWZ_STATUS_CODE"  expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"      expr="RSPMSG"/>
           <return/>
        </elseif>
        <else>
           <do func="RollBackWork"/>
           <set name="RSPCOD"           value="02089"/>
           <set name="RSPMSG"           value="系统数据返回空!"/>
           <set name="DWZ_STATUS_CODE"  expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"      expr="RSPMSG"/>
           <return/>
        </else>
      </process>
   </transaction>

   <transaction code="568048"   desc="更改系统状态">
     <sql name="updateSysInf">
       update limsysinf set sys_state=#{SYS_STATE} where sys_id=#{SYS_ID}
     </sql>
     <sql name="updateMenuInf">
       update limmeninf set menu_state=#{SYS_STATE} where sys_id=#{SYS_ID}
     </sql>
     <process>
      <if condition="OR(ISNULL(SYS_ID),ISNULL(SYS_STATE))">
        <set name="RSPCOD"          value="02091"/>
        <set name="RSPMSG"          value="获取请求参数失败!,更新失败!"/>
        <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
        <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
        <return/>
      </if>
      <do func="ExecSql" error="IGNORE">
        <para name="SqlCmd" sql="updateSysInf"/>
      </do>
      <do func="ExecSql" error="IGNORE">
        <para name="SqlCmd" sql="updateMenuInf"/>
      </do>
      <if condition="#RetCod==0">
        <set name="RSPCOD"            value="00000"/>
        <set name="RSPMSG"            value="成功更新系统状态!"/>
        <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
        <set name="DWZ_CALLBACK_TYPE" value="forward"/>
        <set name="DWZ_FORWARD_URL"   value="568029.lim"/>
        <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
        <return/>
      </if>
      <elseif condition="#RetCod==-1">
        <do func="RollBackWork"/>
        <set name="RSPCOD"            value="02095"/>
        <set name="RSPMSG"            value="更新系统状态时,操作数据库失败!"/>
        <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
        <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
        <return/>
      </elseif>
      <else>
        <do func="RollBackWork"/>
        <set name="RSPCOD"            value="02097"/>
        <set name="RSPMSG"            value="检测该条数据为空,更新失败!"/>
        <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
        <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
        <return/>
      </else>
     </process>
   </transaction>

   <transaction code="568049"   desc="删除系统">
     <sql name="deleMenuSysInf">
       delete from  limmeninf where sys_id=#{SYS_ID}
     </sql>
     <sql name="deleSysInf">
       delete limsysinf where sys_id = #{SYS_ID}
     </sql>
     <process>
         <if condition="ISNULL(SYS_ID)">
           <set name="RSPCOD"          value="02091"/>
           <set name="RSPMSG"          value="获取请求参数失败!,删除失败!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
         </if>
         <!--判断当前这个人有无删除该系统的权限-->
         
         <!--删除系统菜单关联信息-->
         <do func="ExecSql" error="deleMenuSysInf">
           <para name="SqlCmd" sql="deleMenuSysInf"/>
         </do>
         <if condition="#RetCod==-1">
           <do func="RollBackWork"/>
           <set name="RSPCOD"          value="02092"/>
           <set name="RSPMSG"          value="删除系统菜单时,操作数据有误,删除失败!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
         </if>
         <!--删除系统信息-->
         <do func="ExecSql" error="deleSysInf">
           <para name="SqlCmd" sql="deleSysInf"/>
         </do>
           <if condition="#RetCod==0">
              <set name="RSPCOD"           value="00000"/>
             <set name="RSPMSG"            value="删除系统成功!"/>
             <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
             <set name="DWZ_CALLBACK_TYPE" value="forward"/>
             <set name="DWZ_FORWARD_URL"   value="568029.lim"/>
             <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
            <return/>
           </if>
           <elseif condition="#RetCod==-1">
            <do func="RollBackWork"/>
            <set name="RSPCOD"          value="02093"/>
            <set name="RSPMSG"          value="删除系统失败!"/>
            <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
            <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
            <return/>
           </elseif>
          <else>
            <do func="RollBackWork"/>
            <set name="RSPCOD"          value="02094"/>
            <set name="RSPMSG"          value="该项统信息不规范,删除失败!"/>
            <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
            <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
            <return/>
          </else>
      </process>
   </transaction>
   
   <transaction code="568050"   desc="查询指定系统详细信息">
     <sql name="querySysInf">
        select sys_id,sys_nam, sys_abbr, sys_state, sys_desc, sys_type, sys_url, sys_rootid from limsysinf where sys_id=#{SYS_ID}
     </sql>
     <process>
        <if condition="OR(ISNULL(SYS_ID),IS_EQUAL_STRING(DELSPACE(SYS_ID,'all'),''))">
           <set name="RSPCOD"          value="02098"/>
           <set name="RSPMSG"          value="获取系统信息有误,跳转失败!"/>
           <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <return/>
        </if>
        <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="querySysInf"/>
        </do>
        <if condition="INTCMP(sys_type,3,1000)">
           <set name="SYS_TYPE_Z"      value="内部系统"/>
        </if>
        <else>
           <set name="SYS_TYPE_Z"      value="外部系统"/>
        </else>
        <if condition="#RetCod==0">
           <if condition="ISNUMBER(sys_type)">
              <set name="SYS_TYPE_STR" value="-1"/>
           </if>
           <set name="RSPCOD" value="00000"/>
           <set name="RSPMSG" value="查询该条系统信息记录成功!"/>
           <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/right/up_sys_info.jsp"/>
           <return/>
        </if>
        <else>
          <if condition="#RetCod==-1">
            <set name="RSPCOD" value="02031"/>
            <set name="RSPMSG" value="查询该项系统详细记录时,操作数据库有误!"/>
            <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
            <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
            <return/>
          </if>
          <else>
            <set name="RSPCOD" value="02032"/>
            <set name="RSPMSG" value="查询该项系统详细记录时,查询结果为空!"/>
            <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
            <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
            <return/>
          </else>
        </else>
     </process>
   </transaction>
   
   <transaction code="568061"   desc="修改系统信息">
    <sql name="querySysInf">
      select count(sys_id) as signCount from limsysinf where sys_abbr!=#{SYS_ABBR} and sys_nam !=#{SYS_NAM} and (sys_abbr = #{SYS_ABBR} or sys_nam =#{SYS_NAM})
    </sql>
    <sql name="updateSysInf">  
      update limsysinf set sys_nam = #{SYS_NAM},sys_abbr = #{SYS_ABBR},sys_state = #{SYS_STATE},
      sys_desc = #{SYS_DESC},sys_url = #{SYS_URL} where sys_id = #{SYS_ID}
    </sql>
    <process>
      <if condition="OR(ISNULL(SYS_ID),IS_EQUAL_STRING(DELSPACE(SYS_ID,'all'),''))">
         <set name="RSPCOD"            value="02100"/>
         <set name="RSPMSG"            value="获取用户ID信息失败,修改失败!"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_CALLBACK_TYPE" value="forward"/>
         <set name="DWZ_FORWARD_URL"   value="568029.lim"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
      </if>
      <if condition="OR(ISNULL(SYS_NAM),ISNULL(SYS_ABBR),ISNULL(SYS_URL))">
        <set name="RSPCOD"          value="02101"/>
        <set name="RSPMSG"          value="你输入的信息不完整,请完善后再提交!"/>
        <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
        <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
        <return/>
      </if>
      <set name="SYS_ABBR"          expr="TOUPPER(SYS_ABBR)"/>
      <do func="ReadRecord" error="IGNORE">
        <para name="SqlCmd" sql="querySysInf"/>
      </do>
      <if condition="#RetCod!=0">
        <set name="RSPCOD"          value="02102"/>
        <set name="RSPMSG"          value="对不起,验证系统名称和简称时操作数据库失败,请稍后再做修改!"/>
        <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
        <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
        <return/>
      </if>
      <if condition="INTCMP(signCount,4,0)">
        <set name="RSPCOD"          value="02102"/>
        <set name="RSPMSG"          value="对不起,您输入的系统名称或简称已被占用,请重新输入!"/>
        <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
        <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
        <return/>
      </if>
      
      <do func="ExecSql" error="IGNORE">
        <para name="SqlCmd" sql="updateSysInf"/>
      </do>
      <if condition="#RetCod!=0">
         <do func="RollBackWork"/>
         <set name="RSPMSG"            value="修改系统信息失败！"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_CALLBACK_TYPE" value="forward"/>
         <set name="DWZ_FORWARD_URL"   value="568029.lim"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
      </if>
      <else>
         <set name="RSPMSG"            value="修改系统信息成功"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
         <set name="DWZ_CALLBACK_TYPE" value="forward"/>
         <set name="DWZ_FORWARD_URL"   value="568029.lim"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
      </else>
     </process>
   </transaction>
   
    <transaction code="568008"   desc="密码修改页面跳转">
     <process> 
         <set name="_REQUESTATTR.FORWARDURL" expr="url"/>                                      
        <return/>
     </process>
   </transaction>
   
   <transaction code="568010"   desc="跳转到首页">
     <process>
        <set name="_REQUESTATTR.FORWARDURL" expr="URL"/>
        <return/>
     </process>
   </transaction>
   
   <transaction code="568070"   desc="添加角色初始信息">
     <sql name="queryRoleqx"><!--查询该用户对应的权限和用户对应的角色对应的权限的交集-->
       select d.menu_id as PAGID, d.menu_par_id as  PAREID, d.menu_nam as PAGNAM  from limmeninf d where d.menu_id in
       (select distinct b.menu_id from limumrele a,limrmrele b where a.account=b.account and a.menu_id=b.menu_id and user_id=#{user_id} and a.account=#{account}
       and b.role_id=(select role_id from limrurele where account=#{account} and user_id=#{user_id})) order by  d.menu_id asc
     </sql>
     <process>
        <do func="GetOwnButton"/>              <!--权限按钮控制-->
        <!--保证了被添加的用户和添加人是同一系统-->
        <set name="SYSID"         expr="innSysId"/>
        <set name="account"       expr="SESSIONS.USERACCOUNT"/>
        <set name="user_id"       expr="SESSIONS.UID"/>
        <!--  当前用户能分配的权限  -->
        <do func="QueryInGroup" error="IGNORE">
           <para name="SqlCmd"      sql="queryRoleqx"/>
           <para name="RecordName"  value="ROLEQXS_LST"/>
         </do>
        <if condition="#RetCod==-1">
           <do func="RollBackWork"/>
           <set name="RSPCOD"            value="02039"/>
           <set name="RSPMSG"            value="查询角色模块权限失败!"/>
           <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
           <return/>
        </if>
        <else>
          <set name="RSPCOD" value="00000"/>
          <set name="RSPMSG" value="成功获取菜单信息"/>
          <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/role/add_role.jsp"/>
        </else>
     </process>
   </transaction>

    <transaction code="568071"   desc="角色添加">
     <sql name="queryRoleExist">
       select * from LIMROLINF where account=#{ACCOUNT} and role_nam=#{ROLE_NAM}
     </sql>
     <sql name="deleteRmRele">
       delete from LIMRMRELE where account=#{ACCOUNT} and role_id=#{ROLE_ID}
     </sql>
     <sql name="InsRoleInf"><!--添加角色基本信息-->
      insert into limrolinf (account, role_id, role_nam, role_desc, role_state, sys_id, crea_sign,role_date)
      values (#{ACCOUNT}, #{ROLE_ID}, #{ROLE_NAM}, #{ROLE_DESC}, #{ROLE_STATE}, #{SYSID},'1',#{currentTime})
     </sql>
     <process>
        <if condition="ISNULL(ROLE_NAM)">
          <set name="RSPCOD"            value="02040"/>
          <set name="RspMsg"            value="角色名称不能为空，请重新输入"/>
          <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
          <return/>
        </if>
        <if condition="OR(ISNULL(ACCOUNT),ISNULL(SYSID))">
          <set name="RSPCOD"            value="02040"/>
          <set name="RspMsg"            value="登录超时，请重新等了后再试！"/>
          <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
          <return/>
        </if>
        <!-- 查询角色名称是否存在 -->
       <do func="ReadRecord"   error="IGNORE">
         <para name="SqlCmd"      sql="queryRoleExist"/>
       </do>
       <if condition="#RetCod==-1">
         <do func="RollBackWork"/>
         <set name="RSPCOD"            value="02040"/>
         <set name="RspMsg"            value="系统错误"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </if>
       <elseif condition="#RetCod==2">
         <set name="RSPCOD"            value="00000"/>
         <set name="RspMsg"            value="没有该角色，可以添加"/>
       </elseif>
       <elseif condition="#RetCod==0">
         <do func="RollBackWork"/>
         <set name="RSPCOD"            value="02050"/>
         <set name="RspMsg"            value="系统检测在当前账户下,该角色名称存在,请重新输入！"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </elseif>
       <else>
         <set name="RSPCOD"            value="02050"/>
         <do func="RollBackWork"/>
         <set name="RspMsg"            value="验证该角色是否存在时,出现未知异常,添加角色失败！"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </else>
       <!-- 生成角色编号 -->
       <set name="ROLE_ID"    expr="ROLE_ID"/>
                 
         <!--获取序号 -->
         <do func="GetSeqNo"  error="IGNORE">
            <para name="TblNam" value="stpseqrec"/>
            <para name="KeyNam" value="KeyNam"/>
            <para name="KeyVal" value="LIMROLINF_ROLE_ID"/>
            <para name="SeqNam" value="KeyVal"/>
            <para name="Len"    value="6"/>
            <para name="Circle" value="1"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"              value="E"/>
            <set name="RspCod"              value="09001"/>
            <set name="RspMsg"              value="系统繁忙，请稍后重试"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </if>
                <!--  随机字符串长度  -->
       <!--  随机字符: ALL 字母和数字;  NUM 数字;   STR 字母  -->
       <!--  大小写标识: MIX 混合;   UPP 大写;   LOW 小写;  -->
       <do expr="@TdRandom@generateMixRandom(4, 'NUM', 'LOW')"/>
       <!-- 角色ID生成策略：  YYMMDD+4位随机数+6位序列号-->
       <set name="ROLE_ID"     expr="STRCAT(SUBSTR(GETDATE(),3,6),Random,KeyVal)"/>
       <!--  添加角色  -->
       <set name="currentTime"         expr="GETDATETIME()"/><!--获得当前登录时间-->
       <do func="ExecSql" error="IGNORE">
          <para name="SqlCmd" sql="InsRoleInf"/>
       </do>
       <if condition="#RetCod==-1">
        <do func="RollBackWork"/>
        <set name="RspCod"            value="09999"/>
        <set name="RspMsg"            value="添加角色时,操作数据库失败!"/>
        <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
        <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
        <return/>
      </if>
      <elseif condition="#RetCod==3">
        <do func="RollBackWork"/>
        <set name="RspCod"            value="09999"/>
        <set name="RspMsg"            value="对不起,已经存在该角色,不能继续添加！"/>
        <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
        <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
        <return/>
      </elseif>
      <elseif condition="#RetCod==0">
        <set name="RspCod"           value="00000"/>
        <set name="RspMsg"           value="角色添加成功!"/>
      </elseif>
      <else>
        <do func="RollBackWork"/>
        <set name="RspCod"            value="09910"/>
        <set name="RspMsg"            value="出现未知错误,角色添加失败！"/>
        <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
        <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
        <return/> 
      </else>
      <!--  删除角色下的权限   -->
      <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="deleteRmRele"/>
      </do>
      <if condition="#RetCod!=-1">
        <set name="aaa"        expr="GETMENUSTR('')"/>
        <foreach name="MENU_ID" iterator="#tmp">
          <set name="MENU_ID"  expr="#tmp"/>
          <do func="InsertRecord" error="IGNORE">
            <para name="TblNam"  value="LIMRMRELE"/>
          </do>
        </foreach>
        <if condition="#RetCod==-1">
          <do func="RollBackWork"/>
          <set name="RSPCOD"            value="02038"/>
          <set name="RSPMSG"            value="角色权限信息添加失败!"/>
          <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
          <return/>
        </if>
        <else>
          <set name="RSPCOD"            value="02038"/>
          <set name="RSPMSG"            value="角色信息添加成功!"/>
          <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
          <set name="DWZ_CALLBACK_TYPE" value="forward"/>
          <set name="DWZ_FORWARD_URL"   value="568072.lim"/>
          <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
          <return/>
        </else>
      </if>
      <else>
        <do func="RollBackWork"/>
        <set name="RSPCOD"            value="02038"/>
        <set name="RSPMSG"            value="系统检测该角色ID有遗留权限菜单,试图删除失败!"/>
        <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
        <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
        <return/>
      </else>
     </process>
   </transaction>

   <transaction code="568072"   desc="角色重置-查询">
     <sql name="queryMenuList">
         select ACCOUNT,ROLE_ID,ROLE_NAM,ROLE_DESC,ROLE_STATE,CREA_SIGN,a.SYS_ID,
         (case when a.SYS_ID='1000' then '内部系统'
         else (select sys_nam from limsysinf where sys_id=a.sys_id) end) as sys_nam 
         FROM LIMROLINF a 
         where 1=1 ${tj} order by a.role_date desc
     </sql>
     <sql name="querySysIdList">
       select sys_id,sys_nam from limsysinf where sys_type!='1000'
     </sql>
     <process>
        <do func="GetOwnButton"/>              <!--权限按钮控制-->
        <set name="cuerrAccount" expr="SESSIONS.USERACCOUNT"/>
        <set name="tj" value=""/>
        <!--菜单状态-->
        <if condition="AND(NOT(ISNULL(ROLE_STATE)),IS_NOEQUAL_STRING(ROLE_STATE,'-1'))">
         <set name="tj" expr="STRCAT(tj,' and ROLE_state = \'', ROLE_STATE ,'\'')"/>
       </if>
       <else>
        <set name="ROLE_STATE" value="-1"/>
       </else>
       
       <!--系统类型-->
       <if condition="AND(NOT(ISNULL(SYS_ID)),IS_NOEQUAL_STRING(SYS_ID,'-1'))">
         <set name="tj" expr="STRCAT(tj,' and a.sys_id = \'', SYS_ID ,'\'')"/>
       </if>
       <else>
         <set name="SYS_ID" value="-1"/>
       </else>
       <set name="tj" expr="STRCAT(tj,' and role_nam like \'%' ,ROLE_NAM,'%\'')"/>
       <!--查询系统信息集合-->
       <do func="QueryInGroup" error="IGNORE">
         <para name="SqlCmd" sql="querySysIdList"/>
         <para name="RecordName" value="SYS_LST"/>
       </do>
       <if condition="#RetCod!=-1">
         <if condition="ISNULL(PageNum)">
           <set name="PageNum" value="1"/>
         </if>
         <if condition="ISNULL(NumPerPag)">
           <set name="NumPerPag" value="19"/>
         </if>
         <do func="PagedQuery" error="IGNORE">
           <para name="PageNum"   expr="PageNum"/>
           <para name="NumPerPag" expr="NumPerPag"/>
           <para name="sql"       sql="queryMenuList"/>
         </do>
         <set name="SYS_ID" expr="DELSPACE(SYS_ID,'all')"/>
         <if condition="#RetCod!=-1">
           <!--查询成功-->
           <set name="RSPCOD" value="00000"/>
           <set name="RSPMSG" value="查询角色信息成功!"/>
           <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/role/show_roleList.jsp"/>
           <return/>
         </if>
         <else>
           <set name="RSPCOD" value="00000"/>   
           <set name="RSPMSG" value="查询角色信息失败!"/>
           <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
           <return/>
         </else>
       </if>
       <!--分页查询菜单信息集合-->
       <else>
         <set name="RSPCOD" value="02061"/>
         <set name="RSPMSG" value="查询系统集合时,操作数据库有误!"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </else>
     </process>
   </transaction>
   
   <transaction code="568089"   desc="角色修改-查询">
     <sql name="queryMenuList">
         select ACCOUNT,ROLE_ID,ROLE_NAM,ROLE_DESC,ROLE_STATE,CREA_SIGN,a.SYS_ID,
         (case when a.SYS_ID='1000' then '内部系统'
         else (select sys_nam from limsysinf where sys_id=a.sys_id) end) as sys_nam 
         FROM LIMROLINF a 
         where 1=1 ${tj} order by a.role_date desc
     </sql>
     <sql name="querySysIdList">
       select sys_id,sys_nam from limsysinf where sys_type!='1000'
     </sql>
     <process>
        <do func="GetOwnButton"/>              <!--权限按钮控制-->
        <set name="cuerrAccount" expr="SESSIONS.USERACCOUNT"/>
        <set name="tj" value=""/>
        <!--菜单状态-->
        <if condition="AND(NOT(ISNULL(ROLE_STATE)),IS_NOEQUAL_STRING(ROLE_STATE,'-1'))">
         <set name="tj" expr="STRCAT(tj,' and ROLE_state = \'', ROLE_STATE ,'\'')"/>
       </if>
       <else>
        <set name="ROLE_STATE" value="-1"/>
       </else>
       
       <!--系统类型-->
       <if condition="AND(NOT(ISNULL(SYS_ID)),IS_NOEQUAL_STRING(SYS_ID,'-1'))">
         <set name="tj" expr="STRCAT(tj,' and a.sys_id = \'', SYS_ID ,'\'')"/>
       </if>
       <else>
         <set name="SYS_ID" value="-1"/>
       </else>
       <set name="tj" expr="STRCAT(tj,' and role_nam like \'%' ,ROLE_NAM,'%\'')"/>
       <!--查询系统信息集合-->
       <do func="QueryInGroup" error="IGNORE">
         <para name="SqlCmd" sql="querySysIdList"/>
         <para name="RecordName" value="SYS_LST"/>
       </do>
       <if condition="#RetCod!=-1">
         <if condition="ISNULL(PageNum)">
           <set name="PageNum" value="1"/>
         </if>
         <if condition="ISNULL(NumPerPag)">
           <set name="NumPerPag" value="19"/>
         </if>
         <do func="PagedQuery" error="IGNORE">
           <para name="PageNum"   expr="PageNum"/>
           <para name="NumPerPag" expr="NumPerPag"/>
           <para name="sql"       sql="queryMenuList"/>
         </do>
         <set name="SYS_ID" expr="DELSPACE(SYS_ID,'all')"/>
         <if condition="#RetCod!=-1">
           <!--查询成功-->
           <set name="RSPCOD" value="00000"/>
           <set name="RSPMSG" value="查询角色信息成功!"/>
           <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/role/update_role.jsp"/>
           <return/>
         </if>
         <else>
           <set name="RSPCOD"            value="00000"/>   
           <set name="RSPMSG"            value="查询角色信息失败!"/>
           <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
           <return/>
         </else>
       </if>
       <!--分页查询菜单信息集合-->
       <else>
         <set name="RSPCOD"            value="02061"/>
         <set name="RSPMSG"            value="查询系统集合时,操作数据库有误!"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </else>
     </process>
   </transaction>
   
   <transaction code="568090"   desc="角色删除-查询">
     <sql name="queryMenuList">
         select ACCOUNT,ROLE_ID,ROLE_NAM,ROLE_DESC,ROLE_STATE,CREA_SIGN,a.SYS_ID,
         (case when a.SYS_ID='1000' then '内部系统'
         else (select sys_nam from limsysinf where sys_id=a.sys_id) end) as sys_nam 
         FROM LIMROLINF a 
         where 1=1 ${tj} order by a.role_date desc
     </sql>
     <sql name="querySysIdList">
       select sys_id,sys_nam from limsysinf where sys_type!='1000'
     </sql>
     <process>
        <do func="GetOwnButton"/>              <!--权限按钮控制-->
        <set name="cuerrAccount" expr="SESSIONS.USERACCOUNT"/>
        <set name="tj"           value=""/>
        <!--菜单状态-->
        <if condition="AND(NOT(ISNULL(ROLE_STATE)),IS_NOEQUAL_STRING(ROLE_STATE,'-1'))">
         <set name="tj"     expr="STRCAT(tj,' and ROLE_state = \'', ROLE_STATE ,'\'')"/>
       </if>
       <else>
        <set name="ROLE_STATE" value="-1"/>
       </else>
       
       <!--系统类型-->
       <if condition="AND(NOT(ISNULL(SYS_ID)),IS_NOEQUAL_STRING(SYS_ID,'-1'))">
         <set name="tj"     expr="STRCAT(tj,' and a.sys_id = \'', SYS_ID ,'\'')"/>
       </if>
       <else>
         <set name="SYS_ID" value="-1"/>
       </else>
       <set name="tj" expr="STRCAT(tj,' and role_nam like \'%' ,ROLE_NAM,'%\'')"/>
       <!--查询系统信息集合-->
       <do func="QueryInGroup" error="IGNORE">
         <para name="SqlCmd"     sql="querySysIdList"/>
         <para name="RecordName" value="SYS_LST"/>
       </do>
       <if condition="#RetCod!=-1">
         <if condition="ISNULL(PageNum)">
           <set name="PageNum"   value="1"/>
         </if>
         <if condition="ISNULL(NumPerPag)">
           <set name="NumPerPag" value="19"/>
         </if>
         <do func="PagedQuery" error="IGNORE">
           <para name="PageNum"   expr="PageNum"/>
           <para name="NumPerPag" expr="NumPerPag"/>
           <para name="sql"       sql="queryMenuList"/>
         </do>
         <set name="SYS_ID" expr="DELSPACE(SYS_ID,'all')"/>
         <if condition="#RetCod!=-1">
           <!--查询成功-->
           <set name="RSPCOD" value="00000"/>
           <set name="RSPMSG" value="查询角色信息成功!"/>
           <set name="_REQUESTATTR.FORWARDURL" value="WEB-INF/html/role/delete_role.jsp"/>
           <return/>
         </if>
         <else>
           <set name="RSPCOD"            value="00000"/>   
           <set name="RSPMSG"            value="查询角色信息失败!"/>
           <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
           <return/>
         </else>
       </if>
       <!--分页查询菜单信息集合-->
       <else>
         <set name="RSPCOD"            value="02061"/>
         <set name="RSPMSG"            value="查询系统集合时,操作数据库有误!"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </else>
     </process>
   </transaction>

   <transaction code="568073"   desc="查看角色的详细信息">
     <sql name="queryRole">
         select ROLE_NAM,ROLE_DESC,ROLE_STATE,CREA_SIGN,
         (case when a.SYS_ID='1000' then '内部系统' 
         else (select sys_nam from limsysinf where sys_id=a.sys_id) end) as sys_nam
         from LIMROLINF a where account=#{ACCOUNT} and role_id=#{ROLE_ID}
     </sql>
     <sql name="queryRoleQx">
         select menu_id as PAGID,menu_par_id as PAREID,menu_nam as PAGNAM from limmeninf where menu_id in 
       (select menu_id from LIMRMRELE where ROLE_ID=#{ROLE_ID} and ACCOUNT=#{ACCOUNT}) order by menu_id asc
     </sql>
     <process>
       <if condition="OR(ISNULL(jumppath),IS_EQUAL_STRING(jumppath,''))">
         <set name="RSPCOD"            value="02040"/>
         <set name="RspMsg"            value="寻找跳转路径为空,操作执行失败!"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
        <return/>
        </if>
        <!--  查询是否已经有该角色  -->
       <do func="ReadRecord"   error="IGNORE">
         <para name="SqlCmd"     sql="queryRole"/>
       </do>
       <if condition="#RetCod==-1">
         <set name="RSPCOD"            value="02040"/>
         <set name="RspMsg"            value="系统错误"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </if>
       <elseif condition="#RetCod==2">
         <set name="RSPCOD"            value="02050"/>
         <set name="RspMsg"            value="对不起，没有该角色"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </elseif>
       <elseif condition="#RetCod==0">
         <set name="RSPCOD"  value="00000"/>
         <set name="RspMsg"  value="该角色存在，可以操作"/>
       </elseif>
       <else>
         <set name="RSPCOD"            value="02050"/>
         <set name="RspMsg"            value="系统错误！"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </else>
        <!--  当前角色分配的权限  -->
        <do func="QueryInGroup" error="IGNORE">
           <para name="SqlCmd"      sql="queryRoleQx"/>
           <para name="RecordName"  value="ROLEQX_LST"/>
        </do>
        <if condition="#RetCod==2">
           <set name="FLAG"   value="E"/>
           <set name="RSPCOD" value="00000"/>
           <set name="RSPMSG" value="该角色没有任何权限!"/>
           <set name="url"    expr="STRCAT('WEB-INF/html/role/',jumppath)"/>
           <set name="_REQUESTATTR.FORWARDURL" expr="url"/>
           <return/>
        </if>
        <elseif condition="#RetCod==0">
          <set name="FLAG"   value="N"/>
          <set name="RSPCOD" value="00000"/>
          <set name="RSPMSG" value="成功获取菜单信息"/>
          <set name="url"    expr="STRCAT('WEB-INF/html/role/',jumppath)"/>
          <set name="_REQUESTATTR.FORWARDURL" expr="url"/>
          <return/>
        </elseif>
        <else>
           <set name="RSPCOD"            value="02050"/>
           <set name="RSPMSG"            value="获取角色权限失败!"/>
           <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
           <return/>
        </else>
     </process>
   </transaction>
   
   <transaction code="568074"   desc="权限重置">
     <sql name="queryRoleExist"><!--查询该角色是否存在-->
       select * from LIMROLINF where account=#{ACCOUNT} and role_id=#{ROLE_ID}
     </sql>
     <sql name="deleteRmRele"><!--删除原有角色菜单关联信息-->
       delete LIMRMRELE where account=#{ACCOUNT} and role_id=#{ROLE_ID}
     </sql>
     <sql name="queryMenus"><!--查询该角色对应的系统对应的权限-->
        select menu_id from limmeninf where sys_id in (select sys_id from limsysinf where sys_type=#{sys_id}) order by menu_id
     </sql>
     <process>
        <set name="ACCOUNT" expr="ACCOUNT"/>
       <!--查询是否已经有该角色-->
       <do func="ReadRecord"   error="IGNORE">
         <para name="SqlCmd"      sql="queryRoleExist"/>
       </do>
       <if condition="#RetCod!=0">
         <do func="RollBackWork"/>
         <set name="RSPCOD"            value="02040"/>
         <set name="RspMsg"            value="系统校验角色信息异常,重置失败!"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </if>
       <!--   删除该角色对应的权限   -->
       <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="deleteRmRele"/>
       </do>
       <if condition="#RetCod==-1">
           <do func="RollBackWork"/>
           <set name="RSPCOD"            value="02039"/>
           <set name="RSPMSG"            value="清除原有该角色菜单关联信息失败!"/>
           <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
           <return/>
       </if>
       <do func="QueryInGroup" error="IGNORE">
          <para name="SqlCmd"     sql="queryMenus"/>
          <para name="RecordName" value="SYSQX_LST"/>
       </do>
       <if condition="#RetCod==-1">
           <do func="RollBackWork"/>
           <set name="RSPCOD"            value="02039"/>
           <set name="RSPMSG"            value="查询系统模板权限时,系统异常!"/>
           <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
           <return/>
       </if>
         <!--  循环将改角色对应的系统的权限全部赋给该角色    -->
          <foreach name="SYSQX_LST" iterator="#QX">
            <set name="MENU_ID"     expr="#QX.MENU_ID"/>
            <do func="InsertRecord" error="IGNORE">
              <para name="TblNam"   value="LIMRMRELE"/>
            </do>
          </foreach>
          <if condition="#RetCod==0">
            <set name="RSPCOD"            value="02038"/>
            <set name="RSPMSG"            value="权限重置成功!"/>
            <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
            <set name="DWZ_CALLBACK_TYPE" value="forward"/>
            <set name="DWZ_FORWARD_URL"   value="568072.lim"/>
            <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
            <return/>
          </if>
          <else>
            <do func="RollBackWork"/>
            <set name="RSPCOD"            value="02038"/>
            <set name="RSPMSG"            value="权限重置失败!"/>
            <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
            <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
            <return/>
          </else>
     </process>
   </transaction>
   
   <transaction code="568075"   desc="角色修改信息前置">
     <sql name="queryRole">
         select ROLE_NAM,ROLE_DESC,ROLE_STATE,CREA_SIGN,
         (case when a.SYS_ID='1000' then '内部系统' 
         else (select sys_nam from limsysinf where sys_id=a.sys_id) end) as sys_nam
         from LIMROLINF a where account=#{ACCOUNT} and role_id=#{ROLE_ID}
     </sql>
     <sql name="queryRoleQx">
         select menu_id as PAGID,menu_par_id as PAREID,menu_nam as PAGNAM from limmeninf where menu_id in 
       (select menu_id from LIMRMRELE where ROLE_ID=#{ROLE_ID} and ACCOUNT=#{ACCOUNT}) order by menu_id asc
     </sql>
     <sql name="queryAllQX">
         select menu_id as PAGID,menu_par_id as PAREID,menu_nam as PAGNAM from limmeninf where sys_id in 
         (select sys_id from limsysinf where sys_type=#{sys_id}) order by menu_id asc
     </sql>
     <process>
        <if condition="OR(ISNULL(jumppath),IS_EQUAL_STRING(jumppath,''))">
          <set name="RSPCOD"            value="02040"/>
          <set name="RspMsg"            value="寻找跳转路径为空,操作执行失败!"/>
          <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
          <return/>
        </if>
         <!--  查询是否已经有该角色  -->
        <do func="ReadRecord"   error="IGNORE">
          <para name="SqlCmd"     sql="queryRole"/>
        </do>
        <if condition="#RetCod==-1">
          <set name="RSPCOD"            value="02040"/>
          <set name="RspMsg"            value="系统错误"/>
          <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
          <return/>
        </if>
        <!--获取模板权限-->
        <do func="QueryInGroup" error="IGNORE">
           <para name="SqlCmd"     sql="queryAllQX"/>
           <para name="RecordName" value="SYSQX_LST"/>
        </do>
        <if condition="#RetCod==-1">
          <set name="RSPCOD"            value="02040"/>
          <set name="RspMsg"            value="获取角色模板权限时,系统数据异常!"/>
          <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
          <return/>
        </if>
        <!--  当前角色分配的权限  -->
        <do func="QueryInGroup" error="IGNORE">
           <para name="SqlCmd"      sql="queryRoleQx"/>
           <para name="RecordName"  value="ROLEQX_LST"/>
        </do>
        <if condition="#RetCod!=-1">
           <set name="RSPCOD" value="00000"/>
           <set name="RSPMSG" value="角色菜单查询成功!"/>
           <set name="url"    expr="STRCAT('WEB-INF/html/role/',jumppath)"/>
           <set name="_REQUESTATTR.FORWARDURL" expr="url"/>
           <return/>
        </if>
        <else>
           <set name="RSPCOD"            value="02050"/>
           <set name="RSPMSG"            value="获取角色权限失败!"/>
           <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
           <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
           <return/>
        </else>
     </process>
   </transaction>
   
   <transaction code="568076"   desc="修改角色信息">
     <sql name="updateRoleInf">
       update limrolinf set role_nam = #{ROLE_NAM}, role_desc = #{ROLE_DESC}, role_state = #{ROLE_STATE}
       where account = #{ACCOUNT} and role_id = #{ROLE_ID}
     </sql>
     <sql name="deleteRmRele">
       delete from limrmrele where account=#{account} and role_id=#{role_id}
     </sql>
     <sql name="queryRoleExist1">
       select * from LIMROLINF where account=#{ACCOUNT} and role_nam=#{ROLE_NAM}
     </sql>
     <process>
       <if condition="OR(ISNULL(SYS_ID),ISNULL(ROLE_ID),ISNULL(ACCOUNT))">
         <set name="RSPCOD"          value="02039"/>
         <set name="RspMsg"          value="修改角色时获取头信息失败!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </if>
       <if condition="ISNULL(ROLE_NAM)">
         <set name="RSPCOD"          value="02039"/>
         <set name="RSPMSG"          value="角色名不能为空,请重新输入!"/>
         <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </if>
       
       <set name="ROLE_ID_WEB"     expr="ROLE_ID"/>
       <do func="ReadRecord"   error="IGNORE">
         <para name="SqlCmd"      sql="queryRoleExist1"/>
       </do>
       <if condition="#RetCod==-1">
         <do func="RollBackWork"/>
         <set name="RSPCOD"            value="02040"/>
         <set name="RspMsg"            value="系统错误"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </if>
       <elseif condition="#RetCod==2">
         <set name="RSPCOD"  value="00000"/>
         <set name="RspMsg"  value="没有该角色名称，可以修改"/>
       </elseif>
       <elseif condition="#RetCod==0">
         <if condition="IS_NOEQUAL_STRING(ROLE_ID,ROLE_ID_WEB)">
            <do func="RollBackWork"/>
            <set name="RSPCOD"            value="02050"/>
            <set name="RspMsg"            value="系统检测在当前账户下,该角色名称存在,请重新输入！"/>
            <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
            <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
            <return/>
         </if>
       </elseif>
       <else>
         <set name="RSPCOD"            value="02050"/>
         <do func="RollBackWork"/>
         <set name="RspMsg"            value="验证该角色是否存在时,出现未知异常,修改角色失败！"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </else>
       <!--更新角色基本信息-->
       <do func="ExecSql" error="IGNORE">
          <para name="SqlCmd" sql="updateRoleInf"/>
       </do>
       <if condition="#RetCod!=0">
         <do func="RollBackWork"/>
         <set name="RSPCOD"            value="02039"/>
         <set name="RspMsg"            value="更新角色基本信息失败!"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_CALLBACK_TYPE" value="forward"/>
         <set name="DWZ_FORWARD_URL"   value="568089.lim"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </if>
       <!--删除原有角色菜单关联信息-->
       <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="deleteRmRele"/>
       </do>
       <if condition="#RetCod!=-1">
         <set name="aaa"          expr="GETMENUSTR('')"/>
         <foreach name="MENU_ID"  iterator="#tmp">
          <set name="MENU_ID"     expr="#tmp"/>
          <do func="InsertRecord" error="IGNORE">
            <para name="TblNam"   value="LIMRMRELE"/>
          </do>
        </foreach>
        <if condition="#RetCod!=-1">
           <set name="RSPCOD"            value="00000"/>
           <set name="RspMsg"            value="修改角色成功!"/>
           <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
           <set name="DWZ_CALLBACK_TYPE" value="forward"/>
           <set name="DWZ_FORWARD_URL"   value="568089.lim"/>
           <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
           <return/>
        </if>
        <else>
          <do func="RollBackWork"/>
          <set name="RSPCOD"            value="02039"/>
          <set name="RspMsg"            value="修改角色权限时数据异常,修改角色失败!"/>
          <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_CALLBACK_TYPE" value="forward"/>
          <set name="DWZ_FORWARD_URL"   value="568089.lim"/>
          <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
          <return/>
        </else>
     </if>
     <else>
       <do func="RollBackWork"/>
       <set name="RSPCOD"            value="02039"/>
       <set name="RspMsg"            value="删除角色原有权限失败!"/>
       <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
       <set name="DWZ_CALLBACK_TYPE" value="forward"/>
       <set name="DWZ_FORWARD_URL"   value="568089.lim"/>
       <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
       <return/>
     </else>
     </process>
   </transaction>

   <transaction code="568077"   desc="删除角色">
     <sql name="deleteRuRele"><!--删除用户角色关联信息-->
       delete from limrurele where account=#{account} and role_id=#{role_id}
     </sql>
     <sql name="deleteRmRele"><!--删除角色菜单关联信息-->
        delete from limrmrele where account=#{account} and role_id=#{role_id}
     </sql>
     <sql name="deleteRoleInf"><!--删除角色信息-->
        delete from limrolinf where account=#{account} and role_id=#{role_id}
     </sql>
     <sql name="deleteUserInf"><!--删除角色对应的用户-->
        delete from limuseinf where user_id in (select user_id from limrurele where account=#{account} and role_id=#{role_id}) and account=#{account}
     </sql>
     <sql name="deleteUmRele"><!--删除用户对应的菜单-->
        delete from limumrele where user_id in (select user_id from limrurele where account=#{account} and role_id=#{role_id}) and account=#{account}
     </sql>
    <process>
      <if condition="OR(ISNULL(SYS_ID),ISNULL(ROLE_ID),ISNULL(ACCOUNT))">
        <set name="RSPCOD"          value="02039"/>
        <set name="RspMsg"          value="修改角色时获取头信息失败!"/>
        <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
        <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
        <return/>
      </if>
      <do func="ExecSql" error="IGNORE">
        <para name="SqlCmd" sql="deleteUserInf"/>
      </do>
      <if condition="#RetCod==-1">
       <do func="RollBackWork"/>
       <set name="RSPCOD"            value="02039"/>
       <set name="RspMsg"            value="删除角色对应用户失败!"/>
       <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
       <set name="DWZ_CALLBACK_TYPE" value="forward"/>
       <set name="DWZ_FORWARD_URL"   value="568090.lim?operating=delete_role.jsp"/>
       <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
       <return/>
      </if>
      <do func="ExecSql" error="IGNORE">
        <para name="SqlCmd" sql="deleteUmRele"/>
      </do>
      <if condition="#RetCod==-1">
       <do func="RollBackWork"/>
       <set name="RSPCOD"            value="02039"/>
       <set name="RspMsg"            value="删除角色下用户对应的菜单失败!"/>
       <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
       <set name="DWZ_CALLBACK_TYPE" value="forward"/>
       <set name="DWZ_FORWARD_URL"   value="568090.lim?operating=delete_role.jsp"/>
       <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
       <return/>
      </if>
      <do func="ExecSql" error="IGNORE">
        <para name="SqlCmd" sql="deleteRuRele"/>
      </do>
      <if condition="#RetCod==-1">
       <do func="RollBackWork"/>
       <set name="RSPCOD"            value="02039"/>
       <set name="RspMsg"            value="删除角色用户关联信息失败!"/>
       <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
       <set name="DWZ_CALLBACK_TYPE" value="forward"/>
       <set name="DWZ_FORWARD_URL"   value="568090.lim?operating=delete_role.jsp"/>
       <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
       <return/>
      </if>
      <do func="ExecSql" error="IGNORE">
        <para name="SqlCmd" sql="deleteRmRele"/>
      </do>
      <if condition="#RetCod==-1">
       <do func="RollBackWork"/>
       <set name="RSPCOD"            value="02039"/>
       <set name="RspMsg"            value="删除角色菜单关联信息失败!"/>
       <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
       <set name="DWZ_CALLBACK_TYPE" value="forward"/>
       <set name="DWZ_FORWARD_URL"   value="568090.lim?operating=delete_role.jsp"/>
       <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
       <return/>
      </if>
      <do func="ExecSql" error="IGNORE">
        <para name="SqlCmd" sql="deleteRoleInf"/>
      </do>
      <if condition="#RetCod!=0">
       <do func="RollBackWork"/>
       <set name="RSPCOD"            value="02039"/>
       <set name="RspMsg"            value="删除角色信息失败!"/>
       <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
       <set name="DWZ_CALLBACK_TYPE" value="forward"/>
       <set name="DWZ_FORWARD_URL"   value="568090.lim?operating=delete_role.jsp"/>
       <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
       <return/>
      </if>
      <else>
       <set name="RSPCOD"            value="02039"/>
       <set name="RspMsg"            value="删除角色成功!"/>
       <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
       <set name="DWZ_CALLBACK_TYPE" value="forward"/>
       <set name="DWZ_FORWARD_URL"   value="568090.lim?operating=delete_role.jsp"/>
       <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
       <return/>
      </else>
    </process>
   </transaction>
   
   <transaction code="568098"   desc="定义发起的清空随机数">
     <sql name="deleteNotLoginRandom">
       update limuseinf set random='' where (account,user_id) not in (select distinct account,user_id from limloginf )
     </sql>
     <sql name="delteOutTimeRandom">
       update limuseinf set random='' where (account,user_id)  in (select account,user_id from (select account,user_id, max(logn_time) as logn_time from limloginf   group by account,user_id) where (${currentTime} - logn_time)>=10000)
     </sql>
     <process>
        <set name="currentTime" expr="GETDATETIME()"/>
        <!--清空用户登录的随机数-->
        <!--没有最后登录时间或从来没有登录历史的用户都清空-->
        <!--添加用户登录信息-->
        <do func="ExecSql" error="IGNORE">
          <para name="SqlCmd" sql="deleteNotLoginRandom"/>
        </do>
        <if condition="#RetCod!=0">
           <do func="RollBackWork"/>
           <set name="RSPCOD" value="09098"/>
           <set name="RSPMSG" value="定时清除重未登录过的用户的随机数操作失败!"/>
           <return/>
        </if>
         <!--有登录时间的 最后登录时间比当前时间大于1小时清空-->
        <do func="ExecSql" error="IGNORE">
          <para name="SqlCmd" sql="delteOutTimeRandom"/>
        </do>
        <if condition="#RetCod!=0">
          <do func="RollBackWork"/>
          <set name="RSPCOD" value="09097"/>
          <set name="RSPMSG" value="定时清除登录超过一小时的用户的随机数操作失败"/>
          <return/>
        </if>
        <else>
          <set name="RSPCOD" value="00000"/>
          <set name="RSPMSG" value="定时清除用户登录随机数成功!"/>
          <return/>
        </else>
     </process>
   </transaction>

   <transaction code="568078"   desc="商户代理商重置用户权限">
     <sql name="deleteUmRele">
       delete from limumrele where account=#{ACCOUNT} and user_id=#{USER_ID}
     </sql>
     <sql name="insertUmRele">
       insert into limumrele (select #{ACCOUNT} as account,#{USER_ID} as user_id,menu_id from limrmrele
       where account=(select role_account from limwurinf where user_account=#{ACCOUNT} and user_id=#{USER_ID})
       and role_id=(select role_id from limwurinf where user_account=#{ACCOUNT} and user_id=#{USER_ID})) 
     </sql>
     <process>
       <if condition="OR(ISNULL(DELSPACE(USER_ID,'all')),ISNULL(DELSPACE(ACCOUNT,'all')))">
         <do func="RollBackWork"/>
         <set name="RSPCOD"            value="02038"/>
         <set name="RSPMSG"            value="用户头信息丢失,修改失败!"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_CALLBACK_TYPE" value="forward"/>
         <set name="DWZ_FORWARD_URL"   value="568004.lim?operating=update_userinf.jsp"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </if>
       
       <if condition="AND(IS_NOEQUAL_STRING(SYS_ID,'2201'),IS_NOEQUAL_STRING(SYS_ID,'2203'),IS_NOEQUAL_STRING(SYS_ID,'2204'),IS_NOEQUAL_STRING(SYS_ID,'400000'))">
         <set name="RSPCOD"            value="02039"/>
         <set name="RSPMSG"            value="对不起,该用户不能重置菜单权限!"/>
         <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
         <set name="DWZ_CALLBACK_TYPE" value="forward"/>
         <set name="DWZ_FORWARD_URL"   value="568004.lim?operating=update_userinf.jsp"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <return/>
       </if>
       <!--删除用户所有对应菜单-->
          <do func="ExecSql" error="delete"> 
             <para name="SqlCmd" sql="deleteUmRele"/>
          </do>
          <if condition="#RetCod==-1">
             <do func="RollBackWork"/>
             <set name="RSPCOD"            value="02035"/>
             <set name="RSPMSG"            value="删除用户菜单关联信息失败!"/>
             <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_CALLBACK_TYPE" value="forward"/>
             <set name="DWZ_FORWARD_URL"   value="568004.lim?operating=update_userinf.jsp"/>
             <set name="DWZ_RSP_MSG"       expr="RSPMSG"/> 
             <return/> 
          </if>
          
       <!--重置用户菜单权限-->
          <do func="ExecSql" error="delete"> 
             <para name="SqlCmd" sql="insertUmRele"/>
          </do>
          <if condition="#RetCod==-1">
             <do func="RollBackWork"/>
             <set name="RSPCOD"            value="02035"/>
             <set name="RSPMSG"            value="重置用户菜单关联信息失败!"/>
             <set name="DWZ_STATUS_CODE"   expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_CALLBACK_TYPE" value="forward"/>
             <set name="DWZ_FORWARD_URL"   value="568004.lim?operating=update_userinf.jsp"/>
             <set name="DWZ_RSP_MSG"       expr="RSPMSG"/> 
             <return/> 
          </if>
          <else>
            <set name="RSPCOD"            value="00000"/>
            <set name="RSPMSG"            value="用户权限重置成功!"/>
            <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
            <set name="DWZ_CALLBACK_TYPE" value="forward"/>
            <set name="DWZ_FORWARD_URL"   value="568004.lim"/>
            <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
            <return/> 
          </else>
     </process>
   </transaction>

   <transaction code="568081"   desc="获取所选系统拥有菜单总级别">
     <sql name="queryMneuLevel">
       select max(length(menu_id))/2 as MENU_LEVEL from limmeninf where sys_id=#{SYS_ID} and node_type='menu'
     </sql>
     <process>
       <set name="SYS_ID" expr="SYS_ID"/>
       <do func="ReadRecord"   error="IGNORE">
        <para name="SqlCmd"    sql="queryMneuLevel"/>
       </do>
       <if condition="#RetCod==-1">
           <set name="RSPCOD" value="02038"/>
           <set name="RSPMSG" value="获取菜单级别失败!"/>
           <return/>
       </if>
       <else>
         <set name="RSPCOD" value="00000"/>
         <set name="RSPMSG" value="获取菜单级别成功"/>
         <if condition="OR(ISNULL(MENU_LEVEL),IS_EQUAL_STRING(MENU_LEVEL,''),IS_EQUAL_STRING(MENU_LEVEL,'0'))">
           <set name="MENU_LEVEL"  value="1"/><!--即表示该系统还没有任何菜单 默认从第一级别开始-->
         </if>
         <return/>
       </else>
     </process>
   </transaction>
   
   <transaction code="568082"   desc="获取父节点集合">
     <sql name="queryMneuPar">
       select menu_id, menu_nam from limmeninf where node_type='menu' and sys_id=#{SYS_ID} and menu_id in (
       select MENU_ID from limmeninf group by menu_id having length(menu_id)/2=#{MENU_LEVEL}) order by menu_id
     </sql>
     <process>
       <set name="MENU_LEVEL"    expr="MENU_LEVEL"/>
       <set name="SYS_ID"        expr="SYS_ID"/>
       <do func="QueryInGroup" error="IGNORE">
         <para name="SqlCmd" sql="queryMneuPar"/>
         <para name="RecordName" value="PAR_LST"/>
       </do>
       <if condition="#RetCod==-1">
           <set name="RSPCOD" value="02038"/>
           <set name="RSPMSG" value="获取父节点集合失败!"/>
           <return/>
       </if>
       <else>
         <set name="RSPCOD"   value="00000"/>
         <set name="RSPMSG"   value="获取父节点集合成功"/>
         <return/>
       </else>
     </process>
   </transaction>
   
   <transaction code="568086"   desc="修改按钮信息">
     <sql name="updateMenuInf">
       update limmeninf set menu_nam = #{MENU_NAM}, menu_url = #{MENU_URL}, menu_state = #{MENU_STATE} where menu_id = #{MENU_ID}  and sys_id = #{SYS_ID}
     </sql>
     <process> 
        <if condition="OR(ISNULL(MENU_ID),ISNULL(SYS_ID))">
          <set name="RSPCOD"          value="02081"/>
          <set name="RSPMSG"          value="获取该项按钮信息有误,修改失败!"/>
          <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG"     expr="RSPMSGs"/>
          <return/>
        </if>
        <if condition="ISNULL(MENU_NAM)">
          <set name="RSPCOD"          value="02083"/>
          <set name="RSPMSG"          value="按钮名称不能为空!"/>
          <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
          <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
          <return/>
        </if>
        <!--修改按钮信息-->
        <do func="ExecSql" error="IGNORE">
           <para name="SqlCmd" sql="updateMenuInf"/>
        </do>
        <if condition="#RetCod != 0">
          <do func="RollBackWork"/>
          <if condition="#RetCod==2">
            <set name="RSPCOD"          value="02088"/>
            <set name="RSPMSG"          value="对不起,数据库中没有该项记录,修改失败!"/>
            <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
            <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
            <return/>
          </if>
          <else>
             <set name="RSPCOD"          value="02089"/>
             <set name="RSPMSG"          value="数据库操作有误,修改失败!"/>
             <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
             <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
             <return/>
          </else>
        </if>
        <else>
        <set name="RSPCOD" value="00000"/>
             <set name="RSPCOD"            value="00000"/>
             <set name="RSPMSG"            value="修改按钮信息成功!"/>  
             <set name="menuurl"           expr="STRCAT('568027.lim?SYS_ID=',SYS_ID)"/>
             <set name="DWZ_STATUS_CODE"   expr="DWZ_SUCCESS_CODE"/>
             <set name="DWZ_CALLBACK_TYPE" value="forward"/>
             <set name="DWZ_FORWARD_URL"   expr="menuurl"/>
             <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
        </else>
     </process> 
   </transaction>
   
   <transaction code="568091"   desc="获取按钮集合信息">
     <sql name="queryButtonList">
        select button_id, button_ch_nam,button_en_nam from limbutinf where button_show='1' order by button_id
     </sql>
     <process>
       <do func="QueryInGroup" error="IGNORE">
          <para name="SqlCmd" sql="queryButtonList"/>
          <para name="RecordName" value="DE_BUT_LST"/>
       </do>
       <if condition="#RetCod==-1">
           <set name="RSPCOD" value="02082"/>
           <set name="RSPMSG" value="系统有误,获取初始信息失败!"/>
           <return/>
       </if>
       <elseif condition="#RetCod==0">
           <set name="RSPCOD" value="00000"/>
           <set name="RSPMSG" value="获取按钮集合成功!"/>
           <return/>
       </elseif>
       <elseif condition="#RetCod==2">
           <set name="RSPCOD" value="02083"/>
           <set name="RSPMSG" value="获取按钮集合为空,不能新增按钮!"/>
           <return/>
       </elseif>
       <else>
           <set name="RSPCOD" value="02084"/>
           <set name="RSPMSG" value="系统有误,获取初始信息失败!"/>
           <return/>
       </else>
     </process>
   </transaction>
   
   <transaction code="568327"    desc="查询系统菜单">
     <sql name="QuerySysMenu">
        SELECT SYS_ID,MENU_ID,(case when instr(MENU_URL,'?')>0 then substr(MENU_URL,0,instr(menu_url,'?')-1) else menu_url end) as MENU_URL,MENU_NAM,ACC_CONTROL FROM LIMSYSMEN WHERE SYS_ID =#{SYS_ID} ORDER BY ACC_CONTROL ASC,MENU_ID DESC
     </sql>
     <sql name="QuerySysExist">
       SELECT COUNT(*) AS SYS_COUNT FROM LIMSYSINF WHERE SYS_ID=#{SYS_ID}
     </sql>
     <process>
       <set name="SYS_ID"  expr="SYS_ID"/>
       <if condition="OR(ISNULL(SYS_ID),IS_EQUAL_STRING(SYS_ID,''))">
          <set name="RSPCOD" value="000001"/>
          <set name="RSPMSG" value="参数:系统ID不能为空!"/>
          <return/>
       </if>
       <do func="ReadRecord"   error="IGNORE">
        <para name="SqlCmd"    sql="QuerySysExist"/>
       </do>
       <if condition="#RetCod!=0">
           <set name="RSPCOD" value="000002"/>
           <set name="RSPMSG" value="获取该系统信息失败!"/>
           <return/>
       </if>
       <if condition="DOUBLECMP(SYS_COUNT,4,1)">
          <set name="RSPCOD" value="000003"/>
          <set name="RSPMSG" value="该系统信息有误!"/>
          <return/>
       </if>
       <do func="QueryInGroup" error="IGNORE">
          <para name="SqlCmd" sql="QuerySysMenu"/>
          <para name="RecordName" value="SYS_MENU_LST"/>
       </do>
       <if condition="#RetCod==-1">
           <set name="RSPCOD" value="000004"/>
           <set name="RSPMSG" value="系统有误,获取系统菜单失败!"/>
           <return/>
       </if>
       <elseif condition="#RetCod==0">
           <set name="RSPCOD" value="000000"/>
           <set name="RSPMSG" value="获取系统菜单成功!"/>
           <return/>
       </elseif>
       <elseif condition="#RetCod==2">
           <set name="RSPCOD" value="000005"/>
           <set name="RSPMSG" value="获取系统菜单成功,但为空!"/>
           <return/>
       </elseif>
       <else>
           <set name="RSPCOD" value="000004"/>
           <set name="RSPMSG" value="系统有误,获取系统菜单失败!"/>
           <return/>
       </else>
     </process>
   </transaction>
   
   <transaction code="568328"    desc="查询用户菜单">
     <sql name="QueryUsrMenu">
        SELECT D.SYS_ID, D.MENU_ID, D.MENU_NAM, (case when instr(D.MENU_URL,'?')>0 then substr(D.MENU_URL,0,instr(menu_url,'?')-1) else menu_url end) as MENU_URL FROM LIMMENINF D WHERE D.MENU_ID  IN
        (SELECT DISTINCT A.MENU_ID FROM LIMUMRELE A,LIMRMRELE B WHERE A.MENU_ID=B.MENU_ID AND A.ACCOUNT=#{ACCOUNT} AND A.USER_ID=#{USERID} AND B.ACCOUNT=( SELECT ROLE_ACCOUNT FROM LIMWURINF WHERE USER_ACCOUNT=#{ACCOUNT} AND USER_ID=#{USERID} ) AND B.ROLE_ID=(SELECT ROLE_ID FROM LIMWURINF WHERE USER_ACCOUNT=#{ACCOUNT} AND USER_ID=#{USERID}))  ORDER BY D.MENU_ID ASC
     </sql>
     <sql name="QueryUsrExist">
       SELECT COUNT(*) AS USR_COUNT FROM LIMUSEINF WHERE SYS_ID=#{SYS_ID} AND ACCOUNT=#{ACCOUNT} AND USER_ID=#{USERID}
     </sql>
     <process>
       <set name="SYS_ID"  expr="SYS_ID"/>
       <set name="ACCOUNT" expr="ACCOUNT"/>
       <set name="USERID"  expr="USERID"/>
       <if condition="OR(ISNULL(SYS_ID),IS_EQUAL_STRING(SYS_ID,''))">
           <set name="RSPCOD" value="000001"/>
           <set name="RSPMSG" value="参数:系统ID不能为空!"/>
           <return/>
       </if>
       <if condition="OR(ISNULL(ACCOUNT),IS_EQUAL_STRING(ACCOUNT,''))">
           <set name="RSPCOD" value="000002"/>
           <set name="RSPMSG" value="参数:账户号不能为空"/>
           <return/>
       </if>
       <if condition="OR(ISNULL(USERID),IS_EQUAL_STRING(USERID,''))">
           <set name="RSPCOD" value="000003"/>
           <set name="RSPMSG" value="参数:用户ID不能为空!"/>
           <return/>
       </if>
       <do func="ReadRecord"   error="IGNORE">
        <para name="SqlCmd"    sql="QueryUsrExist"/>
       </do>
       <if condition="#RetCod!=0">
           <set name="RSPCOD" value="000002"/>
           <set name="RSPMSG" value="获取该用户信息失败!"/>
           <return/>
       </if>
       <if condition="DOUBLECMP(USR_COUNT,4,1)">
          <set name="RSPCOD" value="000003"/>
          <set name="RSPMSG" value="该用户信息有误!"/>
          <return/>
       </if>
       <do func="QueryInGroup" error="IGNORE">
          <para name="SqlCmd" sql="QueryUsrMenu"/>
          <para name="RecordName" value="USER_MENU_LST"/>
       </do>
       <if condition="#RetCod==-1">
           <set name="RSPCOD" value="000004"/>
           <set name="RSPMSG" value="系统有误,获取用户菜单失败!"/>
           <return/>
       </if>
       <elseif condition="#RetCod==0">
           <set name="RSPCOD" value="000000"/>
           <set name="RSPMSG" value="获取用户菜单成功!"/>
           <return/>
       </elseif>
       <elseif condition="#RetCod==2">
           <set name="RSPCOD" value="000005"/>
           <set name="RSPMSG" value="获取用户菜单成功,但为空!"/>
           <return/>
       </elseif>
       <else>
           <set name="RSPCOD" value="000004"/>
           <set name="RSPMSG" value="系统有误,获取用户菜单失败!"/>
           <return/>
       </else>
     </process>
   </transaction>
   
   <transaction code="568329"    desc="老用户权限初始化">
      <sql name="QueryRoles"><!-- 获取指定系统角色信息 -->
        SELECT ACCOUNT AS ROLE_ACCOUNT,ROLE_ID,SYS_ID FROM LIMROLINF WHERE SYS_ID IN (${SYS_IDS})
      </sql>
      <sql name="DelRmBySysId"><!-- 删除指定角色权限 -->
        DELETE  FROM LIMRMRELE WHERE ACCOUNT=#{ROLE_ACCOUNT} AND ROLE_ID =#{ROLE_ID}
      </sql>
      <sql name="InsertRms"><!-- 插入角色权限信息 -->
        INSERT INTO LIMRMRELE (SELECT #{ROLE_ACCOUNT} ACCOUNT ,#{ROLE_ID} ROLE_ID , MENU_ID FROM LIMMENINF WHERE SYS_ID = #{SYS_ID})
      </sql>
      <sql name="QueryUsers"><!--获取指定系统的用户信息-->
        SELECT ACCOUNT AS USER_ACCOUNT,USER_ID FROM LIMUSEINF WHERE SYS_ID IN (${SYS_IDS})
      </sql>
      <sql name="InsertUms">
        INSERT INTO LIMUMRELE (SELECT  #{USER_ACCOUNT} ACCOUNT ,#{USER_ID} USER_ID , MENU_ID FROM LIMMENINF WHERE MENU_ID IN 
        (SELECT MENU_ID FROM LIMMENINF WHERE MENU_PAR_ID IN (SELECT MENU_ID FROM LIMUMRELE WHERE ACCOUNT=#{USER_ACCOUNT} AND USER_ID=#{USER_ID}) AND NODE_TYPE='button') AND MENU_ID NOT IN (SELECT MENU_ID FROM LIMUMRELE WHERE ACCOUNT=#{USER_ACCOUNT} AND USER_ID=#{USER_ID}))
      </sql>
      <process>
          <if condition="OR(ISNULL(SYS_IDS),IS_EQUAL_STRING(SYS_IDS,''))">
              <set name="SYS_IDS"   value="2201,2204"/>  <!-- 待初始化的系统  该值需要配置-->
          </if>
          <do func="QueryInGroup" error="IGNORE">
             <para name="SqlCmd"  sql="QueryRoles"/>
             <para name="RecordName" value="ROLE_LST"/>
          </do>
          <if condition="#RetCod!=0">
            <set name="RSPCOD"        value="02031"/>
            <set name="RSPMSG"        value="获取系统角色信息有误!"/>
            <return/>
          </if>
          <foreach name="ROLE_LST" iterator="#tmp">
             <set name="ROLE_ACCOUNT"  expr="#tmp.ROLE_ACCOUNT"/>
             <set name="ROLE_ID"       expr="#tmp.ROLE_ID"/>
             <set name="SYS_ID"        expr="#tmp.SYS_ID"/>
             <!-- 删除指定角色权限 -->
             <do func="ExecSql" error="IGNORE">
              <para name="SqlCmd" sql="DelRmBySysId"/>
             </do>
             <if condition="#RetCod==-1">
               <do func="RollBackWork"/>
               <set name="RSPCOD"        value="02032"/>
               <set name="RSPMSG"        value="删除指定角色权限失败!"/>
               <return/>
             </if>
             <!-- 插入角色权限信息 -->
             <do func="ExecSql" error="IGNORE">
              <para name="SqlCmd" sql="InsertRms"/>
             </do>
             <if condition="#RetCod==-1">
               <do func="RollBackWork"/>
               <set name="RSPCOD"        value="02033"/>
               <set name="RSPMSG"        value="插入角色权限信息失败!"/>
               <return/>
             </if>
             <delete name="ROLE_ACCOUNT"/>
             <delete name="ROLE_ID"/>
             <delete name="SYS_ID"/>
          </foreach>
          <do func="QueryInGroup" error="IGNORE">
             <para name="SqlCmd"  sql="QueryUsers"/>
             <para name="RecordName" value="USER_LST"/>
          </do>
          <if condition="#RetCod!=0">
            <set name="RSPCOD"        value="02034"/>
            <set name="RSPMSG"        value="获取系统用户信息有误!"/>
            <return/>
          </if>
          <!--遍历指定系统所有老用户-->
          <foreach name="USER_LST" iterator="#tmp">
            <set name="USER_ACCOUNT"  expr="#tmp.USER_ACCOUNT"/>
            <set name="USER_ID"       expr="#tmp.USER_ID"/>
            <!-- 插入用户权限信息 -->
            <do func="ExecSql" error="IGNORE">
             <para name="SqlCmd" sql="InsertUms"/>
            </do>
            <if condition="#RetCod==-1">
             <do func="RollBackWork"/>
               <set name="RSPCOD"        value="02035"/>
               <set name="RSPMSG"        value="修改用户权限信息失败!"/>
             <return/>
            </if>
            <delete name="USER_ACCOUNT"/>
            <delete name="USER_ID"/>
          </foreach>
          <set name="RSPCOD"        value="00000"/>
          <set name="RSPMSG"        value="老用户权限初始化成功!"/>
      </process>
   </transaction>
   
   
   
   
   <transaction code="563102" desc="用户使用手机注册,发送手机校验码.">
         <sql name="QryUsrInf"> <!--  查询用户注册数据  -->
       select tel as USRMP,tel,EMAIL from limuseinf where account=#{ACCOUNT} and USER_ID=#{USER_ID}
         </sql>
         <sql name="QryMerchantInf"><!--查询商户注册数据-->
         	select BIZ_MOB_NO as USRMP from stpmerinf where cust_id=#{ACCOUNT}  
         	</sql>
         <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
       DELETE FROM STPVERIFY  
              WHERE VER_ID=#{accuser}
         </sql>
         <sql name="InsUsrrandom"> <!--  插入用户验证信息  -->
       INSERT INTO  STPVERIFY (VER_ID,VER_TYPE,InsTim,Random,TimeOut,VER_TRAN_NO,SERVICE_TYPE) 
              VALUES (#{accuser},'0', sysdate ,#{Random},#{TimeOut},#{TRANCODE},'00')
         </sql>
         <sql name="InMsgSed"><!--  登记短信信息  -->
       INSERT INTO STPMSGSED VALUES(#{USRMP},#{MSG_DAT},#{MSG_TIM},#{CUS_NAM},#{SMSCONTENT},'0')
         </sql>
         <sql name="UpdMsgSed"><!--  更新短信发送状态  -->
       UPDATE STPMSGSED SET MSG_STS='1' WHERE PHONE=#{USRMP} AND MSG_TIM=#{MSG_TIM}
         </sql>
         <sql name="QryMsgCon">
                        select Msg_Name as softwareSerialNo,Msg_Key as smspassword from StpMsgCon
         </sql>  
        
      <process>
       <set name="reqip" expr="GetRequestAttr('REQIP')"/>

       <!-- 检查手机号是否为空 -->
       <set name="ACCOUNT"          expr="DELBOTHSPACE(ACCOUNT)"/>
       <if condition="IS_EQUAL_STRING(ACCOUNT,'')">
           <set name="RspCod"       value="02035"/>
           <set name="RspMsg"       value="ID号为空"/>
           <return/>
       </if>
       <set name="USER_ID"          expr="DELBOTHSPACE(USER_ID)"/>
       <if condition="IS_EQUAL_STRING(USER_ID,'')">
           <set name="RspCod"       value="02035"/>
           <set name="RspMsg"       value="账户名为空"/>
           <return/>
        </if>
                                                                                                       
       <if condition="IS_EQUAL_STRING(STRLEN(ACCOUNT),'14')">
       	<!-- 检查手机号是否已注册 -->
       <do func="ReadRecord"       error="IGNORE">
           <para name="SqlCmd"       sql="QryMerchantInf" />
       </do>
       <set name="accuser" expr="ACCOUNT"/>
       	</if> 
       	<else>                                                            
       <!-- 检查手机号是否已注册 -->
       <do func="ReadRecord"       error="IGNORE">
              <para name="SqlCmd"       sql="QryUsrInf" />
       </do>
       <set name="accuser" expr="STRCAT(ACCOUNT,'_',USER_ID)"/>
       </else>
       <if condition="#RetCod==0">
           <set name="NOTE"          value="N"/>
           <set name="RspCod"        value="02001"/>
           <set name="RspMsg"        value="查询成功"/>
       </if> 
       <elseif condition="#RetCod==2">
             <set name="RspMsg"        value="没有该用户"/>
              <return/>
       </elseif>
       <else>
            <set name="RspCod"        value="09998"/>
            <set name="RspMsg"        value="系统错误"/>
            <return/>
       </else>
                                                                                                                                       
              <!--  删除用户验证码表中的记录  -->
       <do func="ExecSql" error="IGNORE">
            <para name="SqlCmd" sql="DelUsrIdInfo" />
       </do>
       <if condition="#RetCod==2">
            <set name="RspMsg"        value="该用户第一次申请验证码，无记录删除"/>
       </if>
       <elseif condition="#RetCod==-1">
            <set name="RspCod"        value="09999"/>
            <set name="RspMsg"        value="系统错误"/>
            <return/>
       </elseif>
       <elseif condition="#RetCod==0">
            <set name="RspMsg"        value="删除用户验证码信息成功"/>
       </elseif>
       <else>
            <set name="RspCod"        value="09998"/>
            <set name="RspMsg"        value="系统错误"/>
            <return/>
       </else>
       <if condition="IS_EQUAL_STRING(TimeOut,'')">
           <set name="TimeOut"   value="30"/>
       </if>
       <do expr="@TdRandom@generateMixRandom(6, 'NUM', 'LOW')" />
       <!--set name="Random"    value="000000"/-->                                                                                                                                                                                     
       <!-- 插入用户验证表 -->
       <set name="InsTim"          expr="GETDATETIME()"/>
       <do func="ExecSql" error="IGNORE">
           <para name="SqlCmd" sql="InsUsrrandom"/>
       </do>
       <if condition="#RetCod!=0">
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="09999"/>
           <set name="RspMsg"        value="系统错误"/>
           <return/>
       </if>
       <do func="CommitWork"/>
       <!-- 设置短信内容 -->
       <set name="SmsContent"      expr="STRCAT('登陆验证码：',Random,'，请在30分钟内完成验证。')"/>
              
       <!-- 插入短信信息 -->
       <set name="Msg_Dat"         expr="GETDATE()"/>
       <set name="Msg_Tim"         expr="GETDATETIME()"/>
       <set name="Cus_Nam"         value="登录用户验证"/>
       
        <if condition="ISNULL(USRMP)">
          <set name="USRMP"         expr="EMAIL"/>
        </if>
       
       
       <do func="ExecSql" error="IGNORE">
            <para name="SqlCmd" sql="InMsgSed"/>
       </do>
       <if condition="#RetCod!=0">
           <set name="RspCod"        value="01006"/>
           <set name="RspMsg"        value="登记短信发送表失败"/>
           <return/>
       </if>
       <do func="CommitWork"/>
      
                                                                                                          
      
       
       
       <if condition="NOT(ISNULL(TEL))"><!-- 手机号不为空优先发送短信-->
       
            <!--取公共参数配置-->
           <set name="ConfigName"   value="SendSms"/>
           <quote name="ReadXmlCfg"/>
           <set name="endpoint"   expr="endpoint"/>
           <set name="account"    expr="account"/>
           <set name="pwd"        expr="pwd"/>
       
           <!--do func="sendMsgyft" error="IGNORE">
               <para name="mobile"           expr="UsrMp"/>
               <para name="msg"              expr="SmsContent"/>
           </do-->
       
           <!-- 发送短信 -->
           <!--取公共参数配置-->
           <!--<set name="ConfigName"   value="TdBbgMes"/>
           <quote name="ReadXmlCfg"/>
           <do func="TdBbgMsgSendWsr" error="IGNORE">
               <para name="userId"             expr="userId"/>
               <para name="password"        expr="password"/>
               <para name="pszMobis"        expr="DELBOTHSPACE(UsrMp)"/>
               <para name="pszMsg"           expr="SmsContent"/>
               <para name="iMobiCount"    expr="iMobiCount"/>
                <para name="pszSubPort"    expr="pszSubPort"/>
          </do>
          <if condition="#RetCod==0">
             <set name="RspCod"                          value="000000"/>
             <set name="RspMsg"                          value="短信发送成功"/>
             <set name="短信网关返回数据"             expr="SENDNUMBER"/>
             <set name="DWZ_STATUS_CODE"      value="200"/>
             <set name="DWZ_RSP_MSG"              expr="RspMsg"/>
         </if>
         <else>
            <set name="RspCod"                          value="001001"/>
            <set name="RspMsg"                          value="短信发送失败"/>
            <set name="短信网关返回数据"            expr="SENDNUMBER"/>
            <set name="DWZ_STATUS_CODE"      value="300"/>
            <set name="DWZ_RSP_MSG"              expr="RspMsg"/> 	
           <return/>
        </else>-->
          <!-- 发送短信  -->
       
       
       </if>
       <else><!-- 发送邮件 -->
       
         <set name="UrlConfig"   value="CheckEmailNew"/>
         <quote name="ReadXmlCfg"/>
         
        <set name="Email"     expr="Email"/>                                                                                                                                       
        <set name="EmResAddr" expr="SmsContent"/>
         <!--发送邮件-->
         <do func="TdMailSendNew" error="IGNORE">
           <para name="EmTo"       expr="Email" />
           <para name="EmTitle"    value="登录验证" />
           <para name="EmText"     expr="Random" />
           <para name="EmResAddr"  expr="EmResAddr" />
         </do>
         <if condition="#RetCod!=0">
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="09999"/>
           <set name="RspMsg"        value="发送邮件失败"/>
           <return/>
         </if>
         <delete name="Random"/>
         <delete name="SmsContent"/>
         <delete name="EmResAddr"/>
         <delete name="G_EMPWD"/>
       
       
       
       </else>
       
       
       
       
       
       
       
       <!-- 更新短信发送状态 --> 
       <do func="ExecSql" error="IGNORE">
           <para name="SqlCmd" sql="UpdMsgSed" />
       </do>
       <if condition="#RetCod!=0">
           <set name="RspCod"       value="08517"/>
           <set name="RspMsg"       value="修改发送状态失败"/>
           <return/>
       </if>
                                                                           
       <delete name="Random"/>
              
       <set name="MsgTyp"          value="N"/>
       <set name="RspCod"          value="00000"/>
       <set name="RspMsg"          value="交易成功"/>
    </process>
  </transaction>   
  
  
   
</application>
