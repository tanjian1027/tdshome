<?xml version="1.0" encoding="UTF-8"?>
<application name="rmp" code="102" log_level="INFO">
   <!-- 公共宏文件引入-->
   <include file="etc/PUBMACRO_RMP.XML"/>
   
   <!--交易日志记录配置-->
   <include file="etc/STPCTL_TRC.XML"/>
   
    <before>
        <do expr="@tangdi.engine.context.Msg@dump()"/>
        <set name="ConfigName"   value="G_VARIABLE"/>
        <quote name="ReadXmlCfg"/>
        <if condition="IS_EQUAL_STRING(TELLERID,'')">
            <set name="TellerID"      value="00000000000000000000"/>
        </if>
        
        <!--读取公共配置-->
        <set name="ConfigName"   value="BeforeCfg"/>
        <quote name="ReadXmlCfg"/>
        <!--取当前日期设置会计日期-->
        <set name="ActDat"        expr="GETDATE()"  />
        <set name="NowDate"       expr="ActDat"  />               <!--当前日期-->
        <set name="NowTime"       expr="GETDATETIME('HHMISS')"/>  <!--当前时间-->
        <set name="TXN_ORG_NO"    value="000001"    /><!--机构号-->
        <!--获取终端号-->
        <set name="TermCode"  expr="DELBOTHSPACE(TermCode)"/>
        <if condition="ISNULL(TermCode)">
            <do func="GetIP2"/>
            <set name="TermCode"   expr="Ip"                />
            <set name="TermCode"   expr="_REQUESTATTR.REQIP"/><!-- GetIp2原子函数不生效，直接从属性中取 -->
        </if>
    </before>
    
    <after>
        <do expr="@tangdi.engine.context.Msg@dump()"/>
        <quote name="returnMsgMacro"/>
    </after>
    
    <transaction code="800000" desc="获取手机验证码">
        <sql name="QryUsrInf"> <!--  查询登录用户数据，并覆盖调UsrMp字段  -->
            SELECT A.USR_MOBILE as UsrMp,B.CUST_NAME 
            FROM STPUSRINF A,STPCUSINF B
            WHERE 
            A.CUST_ID = B.CUST_ID 
            AND CUST_LOGIN=#{UsrMp}
        </sql>
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{UsrMp} 
            <!--
            and VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
            -->
        </sql>
        <sql name="InsUsrrandom"> <!--  插入用户验证信息  -->
            INSERT INTO  STPVERIFY (VER_ID,VER_TYPE,InsTim,Random,TimeOut,SERVICE_TYPE,VER_TRAN_NO) 
            VALUES (#{UsrMp},#{VER_TYPE}, sysdate ,#{Random},#{TimeOut},#{SERVICE_TYPE},#{TRANCODE})
        </sql>
        <sql name="InMsgSed"><!--  登记短信信息  -->
            INSERT INTO STPMSGSED VALUES(#{USRMP},#{MSG_DAT},#{MSG_TIM},#{CUS_NAM},#{SMSCONTENT},'0')
        </sql>
        <sql name="UpdMsgSed"><!--  更新短信发送状态  -->
            UPDATE STPMSGSED SET MSG_STS='1' WHERE PHONE=#{USRMP} AND MSG_TIM=#{MSG_TIM}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value=""/>
            <quote name="ParseRequestParamsNoCheckStatus"/>
            
            <set name="reqip"           expr="GetRequestAttr('REQIP')"  />
            
            <!-- 检查手机号是否为空 -->
            <set name="UsrMp"          expr="DELBOTHSPACE(UsrMp)"/>
            <if condition="IS_EQUAL_STRING(UsrMp,'')">
                <set name="RspCod"       value="02035"      />
                <set name="RspMsg"       value="手机号为空" />
                <return/>
            </if>
            
            <!--  随机字符串  -->
            <set name="random"      expr="RANDOM(6,2)"  />
            <set name="VERIFYNUM"   expr="random"       />
   
            <if condition="IS_EQUAL_STRING(TimeOut,'')">
              <set name="TimeOut" value="10" />
            </if>

            <!--  短信验证 -->
             <if condition="ISNULL(SERVICE_TYPE)">
                 <set name="SERVICE_TYPE" value="00"/><!--验证码服务类型 00-注册短信验证 01-修改密码短信验证 02-找回密码短信验证 03-数字证书短信验证 04-帐号变更短信验证 05-消费支付短信验证 -->
             </if>
             <else>
                 <set name="SERVICE_TYPE" expr="SERVICE_TYPE" />
             </else>
             <if condition="ISNUMBER(UsrMp)">
               <set name="SMS_TYP"   expr="SMS_TYP"/>
               <set name="SMS_TYPE"   expr="SMS_TYPE"/>
               <if condition="AND(ISNULL(SMS_TYP),ISNULL(SMS_TYPE))">
                    <set name="SMS_TYPE"   value="00"/>
                </if>
                <else>
                    <set name="SMS_TYPE"   expr="SMS_TYP"/>
                </else>
                
               <set name="VER_TYPE" value="0"/><!--验证类型 0：短信验证 1：邮箱验证 -->
             </if>
             <else>
               <set name="TimeOut" expr="MUL(24,60)" />
               <set name="VER_TYPE" value="1"/><!--验证类型 0：短信验证 1：邮箱验证 -->
             </else>
            
            <!--  删除用户验证码表中的记录  -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="DelUsrIdInfo" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspMsg"        value="该用户第一次申请验证码，无记录删除"/>
            </if>
            <elseif condition="#RetCod==-1">
                <set name="RspCod"        value="09999"/>
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </elseif>
            <elseif condition="#RetCod==0">
                <set name="RspMsg"        value="删除用户验证码信息成功"/>
            </elseif>
            <else>
                <set name="RspCod"        value="09998"/>
                <set name="RspMsg"        value="系统错误"/>
                <return/>
            </else>
            
            <!-- 插入用户验证表 -->
            <set name="InsTim"      expr="GETDATETIME()"/>
            <set name="Random"      expr="Random"/>
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="InsUsrrandom"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="09999"/>
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </if>
            <do func="CommitWork"/>
            
            <!-- 设置短信内容 --> 
            <set name="SmsContent"      expr="STRCAT('【商物通】 校验码：',Random,'，欢迎您注册商物通账户，请在10分钟内完成校验。请勿将校验码泄露给他人。')"/>
            
            <!-- 插入短信信息 -->
            <set name="Msg_Dat"         expr="GETDATE()"        />
            <set name="Msg_Tim"         expr="GETDATETIME()"    />
            <set name="Cus_Nam"         value="发送手机验证码"  />
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="InMsgSed"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"        value="01006"/>
                <set name="RspMsg"        value="验证码发送失败"/>  <!-- 原错误提示:登记短信发送表失败 -->
                <return/>
            </if>
            <do func="CommitWork"/>
            
            <!--取公共参数配置-->
            <set name="ConfigName"   value="SendSms"/>
            <quote name="ReadXmlCfg"/>
            
            <set name="tels"    expr="STRCAT('[\'',UsrMp,'\']')"/>
            <set name="msg"     expr="SmsContent"/>
            <!-- 短信发送原子函数 --> 
            <do func="sendMesSwt" error="IGNORE">
               <para name="sendUrl"              expr="sendUrl"/>
                <para name="softwareSerialNo"     expr="softwareSerialNo"/>
                <para name="smspassword"          expr="smspassword"/>
                <para name="MobNo"                expr="UsrMp"/>
               <para name="Context"              expr="SmsContent"/>
               <para name="SendId"               expr="SendId"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="RspCod"       value="08516"/>
               <set name="RspMsg"       value="短信发送失败"/>
               <return/>
            </if>
           
            <delete name="sendUrl"/>
            <delete name="softwareSerialNo"/>
            <delete name="smspassword"/>
            <delete name="SendId"/>
            
            <!-- 更新短信发送状态 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="UpdMsgSed" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"       value="08517"/>
                <set name="RspMsg"       value="修改发送状态失败"/>
                <return/>
            </if>
          
            <set name="MsgTyp"          value="N"       />
            <set name="RspCod"          value="000000"  />
            <set name="RspMsg"          value="交易成功"/>
        </process>
    </transaction>
    
    <transaction code="800001" desc="校验手机验证码">
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{USRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>   
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random,TimeOut
            FROM STPVERIFY 
            WHERE VER_ID=#{USRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value=""/>
            <quote name="ParseRequestParamsNoCheckStatus"/>
            
            <set name="USRMP"           expr="USRMP"        desc="手机号"/>
            <set name="VERIFYNUM"       expr="VERIFYNUM"    desc="验证码"/>
            <!--手机验证   -->
           <if condition="ISNULL(SERVICE_TYPE)">
               <set name="SERVICE_TYPE" value="00"/><!--验证码服务类型 00-注册短信验证 01-修改密码短信验证 02-找回密码短信验证 03-数字证书短信验证 04-帐号变更短信验证 05-消费支付短信验证 -->
           </if>
           <else>
               <set name="SERVICE_TYPE" expr="SERVICE_TYPE" />
           </else>
           <if condition="ISNUMBER(UsrMp)">
             <set name="VER_TYPE" value="0"/><!--验证类型 0：短信验证 1：邮箱验证 -->
           </if>
           <else>
             <set name="VER_TYPE" value="1"/><!--验证类型 0：短信验证 1：邮箱验证 -->
           </else>
           
            <!--  查询校验码  -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrIdverifycode" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"        value="002004"/>
                <set name="RspMsg"        value="该用户未申请校验码"/>
                <return/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"        value="999999"        />
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </elseif>
            <!-- 超时时间判断  -->
            <if condition="INTCMP(timdif,6,TimeOut)">
                <set name="RspCod"        value="002005"                        />
                <set name="RspMsg"        value="校验码已失效,请重新获取校验码" />
                <return/>
            </if>
            <!-- 比较校验码 -->
            <if condition="IS_NOEQUAL_STRING(VERIFYNUM,Random)">
                <set name="RspCod"        value="002006"/>
                <set name="RspMsg"        value="校验码输入错误"/>
                <return/>
            </if> 
           
            <!--  防止数据库保存验证码数据量过大，交易成功后即删除用户验证码信息  -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd"  sql="DelUsrIdInfo" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp"        value="N"/>
                <set name="RspCod"        value="00000"/>
                <set name="RspMsg"        value="未找到验证码登记信息"/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="999999"/>
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </elseif>
            
            <set name="RspCod"      value="000000"  />
            <set name="RspMsg"      value="验证通过"/>
        </process>
    </transaction>
    
    <transaction code="800002" desc="用户注册">
        <sql name="QryUsrIdInf"> <!--  查询用户注册信息  -->
            SELECT CUST_ID
            FROM STPUSRINF 
            WHERE  CUST_LOGIN=#{UsrMp} OR USR_MOBILE=#{UsrMp}
        </sql>
        <!--校验证件唯一 -->
        <sql name="QurCusCretNo"><!-- 查询客户信息-->
            SELECT CUST_NAME,CUST_ID FROM stpcusinf where CUST_CRED_TYPE=#{IdTypeCod} and CUST_CRED_NO=#{UserNo}
        </sql>
        <sql name="QryUsrEmail"> <!--  检测邮箱是否使用  -->
            SELECT CUST_ID
            FROM STPUSRINF 
            WHERE  USR_EMAIL=#{email}
        </sql>
        <sql name="InsUsrInfo"> <!--  插入用户注册信息  --><!-- slh添加密码级别的插入6/19 -->
            INSERT INTO STPUSRINF (CUST_ID, CUST_LOGIN, CUST_PWD, USR_MOBILE, USR_EMAIL, NATIONALITY, EMAIL_STATUS, USR_FAX, USR_ADDRESS, USR_ZIP, USR_JOB, USR_TELNUM, USR_BIRTHDAY, USR_GENDER, USR_BEFNAM,PASSWORD_STRENGTH, PAYPWD_STRENGTH, USR_STATUS, USR_PRO, USR_CITY, USR_AREA,SEND_TYPE) 
            VALUES  (#{CUST_ID},#{UsrMp},#{UsrPwd}, #{UsrMp}, #{EMAIL}, #{NATIONALITY},'0','',#{ADDRESS},#{ZIP},'',#{TELNUM},'','',#{USER_BEFORENAME},#{PWDSTRE},#{PAYSTRE},'0',#{Proid},#{cityid},#{Areaid},'2') 
        </sql>
        <sql name="UpdMsgSed"><!--  更新短信发送状态  -->
            UPDATE STPMSGSED SET MSG_STS='1' WHERE PHONE=#{USRMP} AND MSG_TIM=#{MSG_TIM}
        </sql>
        <sql name="InMsgSed"><!--  登记短信信息  -->
            INSERT INTO STPMSGSED
            VALUES(#{USRMP},#{MSG_DAT},#{MSG_TIM},#{CUS_NAM},#{SMSCONTENT},'1')
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="UsrPwd:G_RANDOM1,PAYPWD:G_RANDOM2"/>
            <quote name="ParseRequestParamsNoCheckStatus"/>
            
            <!-- 检查用户名是否为空 -->
            <if condition="IS_EQUAL_STRING(UsrMp,'')">
                <set name="RspCod"        value="002035"/>
                <set name="RspMsg"        value="手机号为空"/>
                <return/>
            </if>
            
            <!-- 检测用户是否存在,存在提示错误 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"  sql="QryUsrIdInf" />
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod"        value="999999"/>
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </if>
            <elseif condition="#RetCod==0">
                <set name="RspCod"        value="002001"/>
                <set name="RspMsg"        value="该账户号已经被注册"/>
                <return/>
            </elseif>
            <elseif condition="#RetCod!=2">
                <set name="RspCod"        value="009998"/>
                <set name="RspMsg"        value="系统错误"/>
                <return/>
            </elseif>
           
            <!-- 检查登陆密码是否为空 --> 
            <if condition="IS_EQUAL_STRING(UsrPwd,'')">
                <set name="RspCod"        value="002058"            />
                <set name="RspMsg"        value="用户登陆密码为空"  />
                <return/>
            </if>
            
            <!--  检查支付密码是否为空  --> 
            <if condition="IS_EQUAL_STRING(PayPwd,'')">
                <set name="RspCod"        value="002059"/>
                <set name="RspMsg"        value="用户支付密码为空"/>
                <return/>
            </if>
            
            <if condition="IS_EQUAL_STRING(UsrPwd,PayPwd)">
                <set name="RspCod"        value="002058"/>
                <set name="RspMsg"        value="登录密码不能与支付密码相同"/>
                <return/>
            </if>
            
            <!--  检查真实姓名是否为空  -->
            <if condition="IS_EQUAL_STRING(UserName,'')">
                <set name="RspCod"        value="002042"/>
                <set name="RspMsg"        value="用户姓名为空"/>
                <return/>
            </if>
            
            <!--  检查证件类型是否为空  -->
            <if condition="IS_EQUAL_STRING(IdTypeCod,'')">
                <set name="RspCod"        value="002044"/>
                <set name="RspMsg"        value="用户证件类型为空"/>
                <return/>
            </if>
            
            <!--  检查证件号码是否为空  -->
            <if condition="IS_EQUAL_STRING(UserNo,'')">
                <set name="RspCod"      value="002045"/>
                <set name="RspMsg"      value="用户证件号码为空"/>
                <return/>
            </if>
            
            <set name="UserNoTemp"         expr="UserNo"  />         
            
            <!-- 身份证件需要加密存储 20150907 -->
            <set name="UserNo"         expr="DES_ENCRYPT(UserNo)"  />         
            
            
            <!-- 检查证件号码是否唯一 -->
             <do func="ReadRecord" error="IGNORE">
                 <para name="SqlCmd"  sql="QurCusCretNo" />
             </do>
             <if condition="#RetCod==-1">
               <set name="RspCod"        value="09999"/>
               <set name="RspMsg"        value="系统错误"/>
               <return/>
                 </if>
             <elseif condition="#RetCod==0">
               <set name="RspCod"        value="02001"/>
               <set name="RspMsg"        value="该身份证号不可重复注册"/>
               <return/>
             </elseif>
 
            
            <if condition="NOT(ISNULL(EMAIL))">
                <!--  检测电子邮箱是否存在  -->
                <do func="ReadRecord" error="IGNORE">
                    <para name="SqlCmd"  sql="QryUsrEmail" />
                </do>
                <if condition="#RetCod==2">
                    <set name="RspMsg"        value="可以使用"/>
                </if>
                <elseif condition="#RetCod==0">
                    <set name="RspCod"        value="002073"/>
                    <set name="RspMsg"        value="此邮箱已经被使用"/>
                    <return/>
                </elseif>
                <elseif condition="#RetCod!=0">
                    <set name="RspCod"        value="009998"/>
                    <set name="RspMsg"        value="系统错误,请稍后再试。"/>
                    <return/>
                </elseif>
            </if>
           
            <!-- 获取用户编号  --> 
            <do func="GetSeqNo"  error="IGNORE">
                <para name="TblNam" value="stpseqrec"       />
                <para name="KeyNam" value="KeyNam"          />
                <para name="KeyVal" value="STPCUSINF_CUSTID"/>
                <para name="SeqNam" value="KeyVal"          />
                <para name="Len"    value="8"               />
                <para name="Circle" value="1"               />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"          value="9001"/>
                <set name="RspMsg"          value="生产商户号错误，请重新提交。"/>
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
                <return/>
            </if> 
            <!-- 生成客户编号-用户ID -->
            <set name="CUST_ID"     expr="STRCAT('000001',KeyVal)"/>  
            

            <!-- 生成客户支付账号-用户支付账号 用户注册时生成的初始支付账号 -->
            <set name="PAY_AC_NO"   expr="STRCAT(CUST_ID,'01')"/>   
            
            <!-- 客户状态 1 试用期 -->
            <set name="CUST_STATUS"      value="0"/>
            <!-- 客户证件类型  -->
            <set name="CUST_CRED_TYPE"   expr="IDTYPECOD"/>
            <!-- 客户证件号码  -->
            <set name="CUST_CRED_NO"     expr="USERNO"/>
            <!-- 客户名称  -->
            <set name="CUST_NAME"        expr="USERNAME"/>
            <!-- 客户类型  -->
            <set name="CUST_TYPE"        value="0"      /> 
            <set name="CUST_REG_DATE"    expr="NowDate" />
            <set name="CUST_REG_TIME"    expr="nowTime" />
            <set name="Nationality"      value="1"      /><!--互联网561263查询的where条件这个是必须，所以移动端默认是中国:1-->
            <set name="ZIP"              value=""       />
            <set name="TELNUM"           value=""       />
            <set name="USER_BEFORENAME"  value=""       />
            <set name="PWDSTRE"          value=""       />
            <set name="PAYSTRE"          value=""       />
            <set name="Proid"            value=""       />
            <set name="cityid"           value=""       />
            <set name="Areaid"           value=""       />
            

            <!--  检查证件是否为身份证  新版本注册时 不用校验  20150907 -->
             <set name="vailStatus"   value="1"/>
             <set name="vailCardUrl"  value="#"/>
             
             <!-- quote name="checkSpecialName"/>
             
             <if condition="AND(IS_EQUAL_STRING(IdTypeCod,'0'), IS_EQUAL_STRING(IS_SPECIAL,'0'))">
               <set name="RspMsg"        value="用户为身份证用户"/>
               <do func="validIdCard"    error="IGNORE">        
                 <para name="name"       expr="CUST_NAME"/>
                 <para name="idCardNo"   expr="CUST_CRED_NO"/>
               </do>
               <if condition="#RetCod==0"> 
                <set name="RspMsg"    value="身份认证成功"/>
                <set name="vailStatus"   expr="status"/>
                <if condition="IS_EQUAL_STRING(status,'1')">
                  <set name="vailCardUrl"  expr="picPath"/>
                </if>
               </if>
               <else>
                 <set name="vailStatus"   value="-1"/>
                 <set name="RspCod"    value="07565"/>
                 <set name="RspMsg"    value="姓名和身份证不符！"/>  
                 <return/>
               </else>  
             </if --> 
           
            <!-- 登记客户信息主表  -->
            <do func="InsertRecord" error="IGNORE">
                <para name="TblNam"  value="STPCUSINF"/>
            </do> 
            <if condition="#RetCod!=0"> 
                <set name="RspCod"    value="009999"/>
                <set name="RspMsg"    value="数据库操作错误"/>  
                <return/>
            </if>
            
            <set name="Proid"    value=""/>
            <set name="CityId"   value=""/>
            <set name="areaId"   value=""/>
            <set name="ADDRESS"  value=""/>
            <!-- 插入用户信息表 -->    
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="InsUsrInfo"/>
            </do>
            <if condition="#RetCod!=0"> 
                <!-- 回滚数据库 -->
                <do func="RollBackWork"/> 
                <set name="RspCod"        value="999999"/>
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </if>
            
            <!-- 机构号 --> <!--记账函数改为PubAcc后此处机构号修改为 000001 郭彦磊 20140103-->
            <set name="BR_NO" value="000001" />
            <!--预留标识，记账函数改为PubAcc后维护为大写欧，表示外部账户-->
            <set name="RESV_FLG" value="O"/>
            <set name="AC_TYPE"         value="01"  desc="账户类型 01-现金账户；02-红包账户；03-平台账户；04-担保账户；05-保证金账户"/>
            <set name="CCY"             value="CNY" desc="货币"/>
            <set name="AC_STATUS"       value="0"   desc="账户状态 0-正常；1-未激活；2-冻结；9-已销户 审核通过后激活"/>
            <set name="LIST_STS_FLG"    value="0"   desc="名单状态标志 0-一般；1-灰名单；2-黑名单；3-红名单"/>
            <set name="CASH_AC_BAL"     value="0"   desc="现金余额"/>
            <set name="MIN_STL_BALANCE" value="0"   desc="最低可结算金额"/>
            <set name="FROZ_BALANCE"    value="0"   desc="冻结金额"/> 
    
            <!-- 登记账户主档案表 -->
            <do func="InsertRecord" error="IGNORE">
                <para name="TblNam"  value="ARP_AC_PROFILE"/>
            </do> 
            <if condition="#RetCod!=0">
                <!-- 回滚数据库 -->
                <do func="RollBackWork"/>
                <set name="RspCod"    value="999999"/>
                <set name="RspMsg"    value="数据库操作错误"/>  
                <return/>
            </if>
            
            <set name="OPN_OPER_ID"   expr="CUST_ID"    desc="开户操作员"/>
            <set name="OPN_TX_DATE"   expr="nowDate"    desc="开户日期"  />
            <set name="OPN_TX_TIME"   expr="nowTime"    desc="开户时间"  /> 
            <set name="PASSWORD"      expr="PayPwd"     desc="支付密码"  /> 
           
            <!-- 登记商户与账号关联信息  -->
            <do func="InsertRecord" error="IGNORE">
                <para name="TblNam"  value="ARP_AC_CUST_REL"/>
            </do> 
            <if condition="#RetCod!=0">
                <!-- 回滚数据库 -->
                <do func="RollBackWork"/>
                <set name="RspCod"          value="999999"          />
                <set name="RspMsg"          value="数据库操作错误" /> 
                <return/>
            </if> 
            
            <!-- 生成用户登陆名 --> 
            <set name="First"    expr="SUBSTR(UsrMp,1,3)"/> 
            <set name="End"      expr="SUBSTR(UsrMp,8,SUB(STRLEN(UsrMp),7))"/>
            <set name="LOGNAM"   expr="STRCAT(First,'****',End)"/>
            <set name="USRID"    expr="CUST_ID"/>
           
            
            <!-- 注册成功发送短信 设置短信内容 -->
             <set name="SmsContent"      expr="STRCAT('【商物通】 尊敬的',UserName,'，恭喜您成功注册商物通账户（账户名：',USRMP,'），为避免影响您的正常使用，请及时完成身份认证。')"/>
           
            <!--  短信验证 -->
            <if condition="ISNULL(SERVICE_TYPE)"> 
                <set name="SERVICE_TYPE" value="00"/><!--验证码服务类型 00-注册短信验证 01-修改密码短信验证 02-找回密码短信验证 03-数字证书短信验证 04-帐号变更短信验证 05-消费支付短信验证 -->
            </if>
            <else>
                <set name="SERVICE_TYPE" expr="SERVICE_TYPE" />
            </else>
            <if condition="ISNUMBER(UsrMp)">  
              <set name="VER_TYPE" value="0"/><!--验证类型 0：短信验证 1：邮箱验证 -->
            </if>
            <else>
              <set name="TimeOut" expr="MUL(24,60)" />
              <set name="VER_TYPE" value="1"/><!--验证类型 0：短信验证 1：邮箱验证 -->
            </else>
            
            <!-- 插入短信信息 -->
            <set name="Msg_Dat"         expr="GETDATE()"/>
            <set name="Msg_Tim"         expr="GETDATETIME()"/>
            <set name="Cus_Nam"         value="注册用户成功"/>
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="InMsgSed"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"        value="01006"/>
                <set name="RspMsg"        value="登记短信发送表失败"/>
                <return/>
            </if>
            <do func="CommitWork"/>
            

            <!--取公共参数配置-->
            <set name="ConfigName"   value="SendSms"/>
            <quote name="ReadXmlCfg"/>
            <!-- 短信发送原子函数 -->
            <do func="sendMesSwt" error="IGNORE">
               <para name="sendUrl"              expr="sendUrl"/>
               <para name="softwareSerialNo"     expr="softwareSerialNo"/>
               <para name="smspassword"          expr="smspassword"/>
               <para name="MobNo"                expr="UsrMp"/>
               <para name="Context"              expr="SmsContent"/>
               <para name="SendId"               expr="SendId"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="RspCod"       value="08516"/>
               <set name="RspMsg"       value="短信发送失败"/>
               <return/>
            </if>
            <delete name="sendUrl"/>
            <delete name="softwareSerialNo"/>
            <delete name="smspassword"/>
            <delete name="SendId"/>
            
            <!-- 更新短信发送状态 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="UpdMsgSed" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"       value="08517"/>
                <set name="RspMsg"       value="修改发送状态失败"/>
                <return/>
            </if>
            
            <set name="RspCod"          value="000000"/>
            <set name="RspMsg"          value="注册成功"/>
            
            <do func="CommitWork"/>
            <do func="putresponse"/>
            
            <!-- 调用风控接口 -->
            <set name="dType"           value="1"               />
            <set name="USR_STATUS"      value="0"               />
            <set name="UFLAG"           value=""                />
            <set name="FTYPE"           value=""                />
            <set name="sthCode"         value="540504"          />
            <set name="UCODE"           expr="CUST_ID"          />
            <set name="UNAME"           expr="UserName"         />
            <set name="PAPERTYPE"       expr="CUST_CRED_TYPE"   />
            <set name="PCODE"           expr="UserNoTemp"     />
            <delete name="UserNoTemp"/>         
            <set name="USERAPPFLAG"     expr="USR_STATUS"       /><!--0 未认证-->
            <set name="ISTYPE"          value="1"               /><!--1 试用期-->
            <set name="DATE"            expr="GETDATE()"        />
            <set name="TIME"            expr="GETDATETIME()"    />
            <set name="EMAIL"           expr="EMAIL"            /><!--邮箱-->   
            <set name="RspCod"      value="00000"/>
            <quote name="rcsMaro"/>
            <delete name="PCODE"/>         

        </process>
    </transaction>
    
    <transaction code="800003" desc="用户信息查询">
        <sql name="QueryUsrInfo">
            SELECT usr.CUST_ID USRID,cus.CUST_NAME USERNAME,cus.CUST_CRED_TYPE IDTYPECOD,cus.CUST_CRED_NO USERNO,
                   usr.USR_EMAIL EMAIL,usr.USR_STATUS,usr.EMAIL_STATUS,usr.USR_MOBILE,'images/userhead/'||usr.REV_FLAG as userhead
            FROM STPUSRINF usr,STPCUSINF cus 
            WHERE usr.CUST_ID = cus.CUST_ID AND (usr.CUST_LOGIN = #{USRMP} OR usr.USR_MOBILE = #{USRMP})
        </sql>
        <sql name="QueryUsrBankCardNums"><!-- 查询绑定的银行卡数量 -->
            select count(*) as BankCardNums 
            from STPBANKTB a,STPUSRINF b,ARP_AC_CUST_REL c 
            where a.cust_id = c.CUST_ID 
            and c.cust_id = b.CUST_ID 
            and b.cust_login = #{USRMP}
            and (a.CARD_TYPE='00' or a.CARD_TYPE='01')
        </sql>
        <sql name="QryPPCardNum"> <!-- 查询绑定的预付卡数量 -->
            SELECT count(*) as PPNum from STPBANKTB WHERE CUST_ID like #{USRID} and CARD_TYPE='04'
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value=""/>
            <quote name="ParseRequestParamsNoCheckStatus"/>
            
            <if condition="ISNULL(USRMP)">
                <set name="RspCod"        value="002008"        />
                <set name="RspMsg"        value="用户手机号为空"/>
                <return/>
            </if>
            <!--  查询用户信息  -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QueryUsrInfo" />
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod"        value="999999"/>
                <set name="RspMsg"        value="数据库错误！"/>
                <return/>
            </if>
            <if condition="#RetCod!=0">
                <set name="RspCod"        value="002008"/>
                <set name="RspMsg"        value="用户信息不存在"/>
                <return/>
            </if>
            
            <!--查询出身份证 转成明文-->
            <set name="USERNO"         expr="DES_DECRYPT(USERNO)"/>             <!-- 身份证号 -->
            
            <!--  查询用户绑定银行卡张数 add by gyl IOS个性需求  -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QueryUsrBankCardNums" />
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod"        value="999999"/>
                <set name="RspMsg"        value="数据库错误！"/>
                <return/>
            </if>
            <if condition="#RetCod!=0">
                <set name="RspCod"        value="002008"/>
                <set name="RspMsg"        value="绑定信息不存在"/>
                <return/>
            </if>
            <!--  查询用户绑定银行卡张数 add by gyl IOS个性需求  -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QryPPCardNum" />
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod"        value="999999"/>
                <set name="RspMsg"        value="数据库错误！"/>
                <return/>
            </if>
            <if condition="#RetCod!=0">
                <set name="RspCod"        value="002008"/>
                <set name="RspMsg"        value="绑定信息不存在"/>
                <return/>
            </if>
            <set name="RspCod"        value="000000"          />
            <set name="RspMsg"        value="用户信息查询成功"/>
        </process>
    </transaction>
    
    <transaction code="800004" desc="用户信息修改">
        <sql name="QueryUsrInfoOld">
            SELECT usr.CUST_ID oUSRID,cus.CUST_NAME oUSERNAME,cus.CUST_CRED_TYPE oIDTYPECOD,
                   cus.CUST_CRED_NO oUSERNO,usr.USR_EMAIL oEMAIL,usr.USR_STATUS oUSR_STATUS,
                   usr.EMAIL_STATUS oEMAIL_STATUS 
            FROM STPUSRINF usr,STPCUSINF cus 
            WHERE usr.CUST_ID = cus.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="QryUsrIdInf"><!--  查询用户注册信息  -->
            SELECT usr.CUST_LOGIN,usr.USR_EMAIL AS OEMAIL,usr.EMAIL_STATUS,cus.cust_name as oldCustName,usr.CUST_ID as USRID
            FROM   STPUSRINF usr,STPCUSINF cus
            WHERE usr.CUST_ID = cus.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="UpdUsrInf"> <!--  修改用户信息  -->
            CUST_ID = #{oUSRID}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value=""/>
            <quote name="ParseRequestParams"/>
            
            <!--  检测用户名是否为空  -->
            <if condition="ISNULL(USRMP)"> 
                <set name="RspCod"        value="002035"        />
                <set name="RspMsg"        value="手机号不能为空"/>
                <return/>
            </if>
            
            <!--  检测用户是否存在  -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QueryUsrInfoOld" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"        value="002008"        />
                <set name="RspMsg"        value="用户信息不存在"/>
                <return/>
            </if>
            
            <do expr="@tangdi.engine.context.Msg@dump()"/>
            
            <!--  检查真实姓名是否为空  -->
            <if condition="ISNULL(UserName)">
                <set name="RspCod"        value="002042"      />
                <set name="RspMsg"        value="用户姓名为空"/>
                <return/>
            </if>
            
            <!--  检查证件类型是否为空  -->
            <if condition="ISNULL(IdTypeCod)">
                <set name="RspCod"        value="002044"          />
                <set name="RspMsg"        value="用户证件类型为空"/>
                <return/>
            </if>
            
            <!--  检查证件号码是否为空  -->
            <if condition="ISNULL(UserNo)">
                <set name="RspCod"      value="002045"/>
                <set name="RspMsg"      value="用户证件号码为空"/>
                <return/>
            </if>
            
            <if condition="IS_NOEQUAL_STRING(oEMAIL,Email)">
                <if condition="IS_EQUAL_STRING(EMAIL_STATUS,'1')">
                    <set name="RspCod"        value="002008"/>
                    <set name="RspMsg"        value="您的邮箱已经验证,不能修改！"/>
                    <return/>
                 </if>
            </if>
            
            <if condition="OR(IS_NOEQUAL_STRING(UserName,oUSERNAME),IS_NOEQUAL_STRING(IDTYPECOD,oIDTYPECOD),IS_NOEQUAL_STRING(USERNO,oUSERNO))">
                <set name="CUST_NAME"         expr="UserName"   />
                <set name="CUST_CRED_TYPE"    expr="IDTYPECOD"  />
                <set name="CUST_CRED_NO"      expr="USERNO"     />
                
                <do func="UpdateRecord" error="IGNORE">
                    <para name="TblNam"        value="StpCusInf"/>
                    <para name="CndSts"        sql="UpdUsrInf"  />
                </do>
                <if condition="#RetCod!=0">
                    <set name="RspCod"        value="099999"/>
                    <set name="RspMsg"        value="数据库操作错误"/>
                    <return/>
                </if>  
            </if>
            
            <if condition="IS_NOEQUAL_STRING(oEMAIL,Email)">
                <if condition="IS_NOEQUAL_STRING(EMAIL_STATUS,'1')">
                    <set name="USR_EMAIL"         expr="EMAIL"          />   
                    <set name="EMAIL_STATUS"      expr="EMAIL_STATUS"   />
                    <!-- 修改用户信息 -->
                    <do func="UpdateRecord" error="IGNORE"> 
                        <para name="TblNam"        value="StpUsrInf"/>
                        <para name="CndSts"        sql="UpdUsrInf"  />
                    </do>
                    <if condition="#RetCod!=0">
                        <set name="RspCod"        value="099999"        />
                        <set name="RspMsg"        value="数据库操作错误"/>
                        <return/>
                    </if>
                </if>
            </if>
            
            <set name="RspCod"              value="000000"  />
            <set name="RspMsg"              value="修改成功"/>
        </process>
    </transaction>
    
    <transaction code="800005" desc="用户登录密码修改">
        <sql name="QueryUsrInfoPwd">
            SELECT a.CUST_ID as usrid ,a.CUST_PWD, r.password as PAYPWD FROM STPUSRINF a,arp_ac_cust_rel r WHERE a.CUST_LOGIN=#{USRMP} and a.cust_id = r.cust_id
        </sql>
        <sql name="UpdateUsrInfoPwd">
            UPDATE STPUSRINF SET CUST_PWD = #{nUsrpwd} WHERE CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random,TimeOut
            FROM STPVERIFY 
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
        <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
            SELECT 
            EXTRACT(MINUTE FROM (sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND ) as timeDifference,
            CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
            FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
            INSERT INTO STPLOGTMP
            (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
            VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
        </sql>
        <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
            LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
            WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="UsrPwd:G_RANDOM1,nUsrpwd:G_RANDOM2"/>
            <quote name="ParseRequestParams"/>
            
            <!--  检测用户名是否为空  -->
            <if condition="ISNULL(USRMP)"> 
                <set name="RspCod"        value="002035"        />
                <set name="RspMsg"        value="手机号不能为空"/>
                <return/>
            </if>
            
            <!--  检测输入原密码是否为空  -->
            <if condition="ISNULL(UsrPwd)"> 
                <set name="RspCod"        value="002035"          />
                <set name="RspMsg"        value="原登录密码不能为空"/>
                <return/>
            </if>
            <!--  检测输入新密码是否为空  -->
            <if condition="ISNULL(nUsrpwd)"> 
                <set name="RspCod"        value="002035"          />
                <set name="RspMsg"        value="新登录密码不能为空"/>
                <return/>
            </if>
            <!-- 查询用户原密码 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QueryUsrInfoPwd" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"        value="002008"        />
                <set name="RspMsg"        value="用户信息不存在"/>
                <return/>
            </if>
            
            <!-- 用户登录密码锁定次数判断 -->
             <set name="USER_ID" expr="DELBOTHSPACE(USRMP)" />
             <set name="CUSTTYPE"  value="0"/><!--0用户1 商户 2企业-->
             <set name="PWDTYPE"   value="0"/><!--0:登录密码 1:支付密码-->
             <set name="FailFlag"  value="0"/>
             <quote name="usrpwdlock"/>
             <!-- 用户登录密码锁定次数判断 -->
             
            <!-- 原密码错误 -->
            <if condition="IS_NOEQUAL_STRING(UsrPwd,CUST_PWD)"> 
                <set name="RspCod"        value="002036"    />
                <set name="RspMsg"        value="登录密码输入错误"  />
                <quote name="UpLoginInfo"/>
                <return/>
            </if>
            <else>
            </else>
            <!-- 新旧密码不能相同 -->
            <if condition="IS_EQUAL_STRING(UsrPwd,nUsrpwd)"> 
                <set name="RspCod"        value="002036"          />
                <set name="RspMsg"        value="新旧密码不能相同"/>
                <return/>
            </if>
            <!-- 检测与登录密码是否相同 20131121 郭彦磊修改新的登录密码不能和支付密码相同 -->
            <if condition="IS_EQUAL_STRING(nUsrpwd,PAYPWD)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02018" />
                <set name="RspMsg" value="新登录密码不能与支付密码相同" />
                <return />
            </if>
            <!-- 更新密码 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="UpdateUsrInfoPwd"/>
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod"        value="099999"/>
                <set name="RspMsg"        value="数据库操作错误"/>
            </if>
            <if condition="#RetCod!=0">
                <set name="RspCod"        value="020317"    />
                <set name="RspMsg"        value="更新错误"  />
                <return/>
            </if>
            
            <!-- 修改登记失败信息表 -->
            <do func="ExecSql" error="IGNORE">
               <para name="SqlCmd" sql="UpdUsrLogInfo"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="RSPCOD" value="02040"/>
               <set name="RSPMSG" value="更新登录信息失败!"/> 
               <return/>
            </if>
            
            <set name="RspCod"        value="000000"  />
            <set name="RspMsg"        value="更新成功"/>
            
            <set name="RCS_USER_CODE"       expr="usrid"        />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"     />
            <set name="RCS_PRD_NO"          value=""            />
            <set name="RCS_TCODE"           value=""            />
            <set name="RCS_STATUS"          value="1"           />
            
        </process>
    </transaction>
    
    <transaction code="800006" desc="用户登录密码找回">
        <sql name="QueryUsrInfo">
            SELECT a.CUST_ID,r.password as PAYPWD FROM STPUSRINF a,arp_ac_cust_rel r WHERE a.CUST_LOGIN=#{USRMP} and a.cust_id = r.cust_id
        </sql>
        <sql name="UpdateUsrInfoPwd">
            UPDATE STPUSRINF SET CUST_PWD = #{nUsrpwd} WHERE CUST_LOGIN = #{USRMP}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="nUsrpwd:G_RANDOM"/>
            <quote name="ParseRequestParamsNoCheckStatus"/>
            
            <!--  检测用户名是否为空  -->
            <if condition="ISNULL(USRMP)"> 
                <set name="RspCod"        value="002035"        />
                <set name="RspMsg"        value="手机号不能为空"/>
                <return/>
            </if>
            
            <set name="USRMP"    expr="USRMP"/>
            
            <!--  检测新密码是否为空  -->
            <if condition="ISNULL(nUsrpwd)"> 
                <set name="RspCod"        value="002035"          />
                <set name="RspMsg"        value="登录密码不能为空"/>
                <return/>
            </if>
            <!-- 查询用户是否存在 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QueryUsrInfo" />
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod"        value="999999"        />
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"        value="002008"    />
                <set name="RspMsg"        value="用户不存在"/>
                <return/>
            </elseif>
            
            <!-- 检查登录密码是否冻结 -->
            <set name="RCS_PWD_TYPE"        value="1"           />
            <set name="RCS_USER_CODE"       expr="CUST_ID"        />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"     />
            <set name="RCS_PRD_NO"          value=""            />
            <set name="RCS_TCODE"           value="1"           />
            <set name="RCS_STATUS"          value="0"           />
            <quote name="tranPwdLock"/>
            
            <!-- 检测与登录密码是否相同 20131121 郭彦磊修改新的登录密码不能和支付密码相同 -->
            <if condition="IS_EQUAL_STRING(nUsrpwd,PAYPWD)">
                    <set name="MsgTyp" value="E" />
                    <set name="RspCod" value="02018" />
                    <set name="RspMsg" value="新登录密码不能与支付密码相同" />
                    <return />
            </if>
            <!-- 更新密码 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="UpdateUsrInfoPwd"/>
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod"        value="099999"/>
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </if>
            <if condition="#RetCod!=0">
                <set name="RspCod"        value="020317"/>
                <set name="RspMsg"        value="更新错误"/>
                <return/>
            </if>
            <set name="RspCod"        value="000000"  />
            <set name="RspMsg"        value="更新成功"/>
        </process>
    </transaction>
    
    <transaction code="800007" desc="用户支付密码修改">
        <sql name="QueryUsrInfoPwd">
            SELECT arp.PASSWORD CUST_PWD,arp.CUST_ID,usr.CUST_PWD as LOGINPWD FROM ARP_AC_CUST_REL arp,STPUSRINF usr WHERE arp.CUST_ID = usr.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="UpdateUsrInfoPwd">
            UPDATE ARP_AC_CUST_REL SET PASSWORD = #{nUsrpwd} WHERE CUST_ID = #{CUST_ID}
        </sql>
        <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
            SELECT 
            EXTRACT(MINUTE FROM (sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND ) as timeDifference,
            CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
            FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
            INSERT INTO STPLOGTMP
            (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
            VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
        </sql>
        <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
            LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
            WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="UsrPwd:G_RANDOM1,nUsrpwd:G_RANDOM2"/>
            <quote name="ParseRequestParams"/>
            
            <!--  检测用户名是否为空  -->
            <if condition="ISNULL(USRMP)"> 
                <set name="RspCod"        value="002035"        />
                <set name="RspMsg"        value="手机号不能为空"/>
                <return/>
            </if>
            
            <!--  检测原支付密码是否为空  -->
            <if condition="ISNULL(UsrPwd)"> 
                <set name="RspCod"        value="002035"          />
                <set name="RspMsg"        value="原登录密码不能为空"/>
                <return/>
            </if>
            <!--  检测新支付密码是否为空  -->
            <if condition="ISNULL(nUsrpwd)"> 
                <set name="RspCod"        value="002035"          />
                <set name="RspMsg"        value="新登录密码不能为空"/>
                <return/>
            </if>
            <!-- 查询用户原支付密码 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QueryUsrInfoPwd" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"        value="002008"        />
                <set name="RspMsg"        value="用户信息不存在"/>
                <return/>
            </if>
            
            <!-- 用户登录密码锁定次数判断 -->
             <set name="USER_ID" expr="DELBOTHSPACE(USRMP)" />
             <set name="CUSTTYPE"  value="0"/><!--0用户1 商户 2企业-->
             <set name="PWDTYPE"   value="1"/><!--0:登录密码 1:支付密码-->
             <set name="FailFlag"  value="0"/>
             <quote name="usrpwdlock"/>
             <!-- 用户登录密码锁定次数判断 -->
             
            <!-- 原密码错误 -->
            <if condition="IS_NOEQUAL_STRING(UsrPwd,CUST_PWD)"> 
                <set name="RspCod"        value="002036"    />
                <set name="RspMsg"        value="原支付密码输入错误！"  />
                <quote name="UpLoginInfo"/>
                <return/>
            </if>
            <else>
            </else>
            <!-- 新旧密码不能相同 -->
            <if condition="IS_EQUAL_STRING(UsrPwd,nUsrpwd)"> 
                <set name="RspCod"        value="002036"          />
                <set name="RspMsg"        value="新旧密码不能相同"/>
                <return/>
            </if>
            <!-- 检测与登录密码是否相同 20131121 郭彦磊修改新支付密码不能与登陆密码相同 -->
            <if condition="IS_EQUAL_STRING(nUsrpwd,LOGINPWD)">
                    <set name="MsgTyp" value="E" />
                    <set name="RspCod" value="02018" />
                    <set name="RspMsg" value="新支付密码不能与登陆密码相同" />
                    <return />
            </if>
            <!-- 更新支付密码 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="UpdateUsrInfoPwd"/>
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod"        value="099999"/>
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </if>
            <if condition="#RetCod!=0">
                <set name="RspCod"        value="020317"/>
                <set name="RspMsg"        value="更新错误"/>
                <return/>
            </if>
            
            <!-- 修改登记失败信息表 -->
            <do func="ExecSql" error="IGNORE">
               <para name="SqlCmd" sql="UpdUsrLogInfo"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="RSPCOD" value="02040"/>
               <set name="RSPMSG" value="更新登录信息失败!"/> 
               <return/>
            </if>
            
            <set name="RspCod"        value="000000"  />
            <set name="RspMsg"        value="更新成功"/>
            
            <set name="RCS_USER_CODE"       expr="CUST_ID"        />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"     />
            <set name="RCS_PRD_NO"          value=""            />
            <set name="RCS_TCODE"           value=""            />
            <set name="RCS_STATUS"          value="0"           />
            
        </process>
    </transaction>
    
    <transaction code="800008" desc="用户支付密码找回">
        <sql name="QueryUsrInfo">
            SELECT CUST_ID,CUST_PWD as CUSTPWD FROM STPUSRINF WHERE CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="UpdateUsrInfoPwd">
            UPDATE ARP_AC_CUST_REL SET PASSWORD = #{nUsrpwd} WHERE CUST_ID = #{CUST_ID}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="nUsrpwd:G_RANDOM"/>
            <quote name="ParseRequestParams"/>
            
            <!--  检测用户名是否为空  -->
            <if condition="ISNULL(USRMP)"> 
                <set name="RspCod"        value="002035"        />
                <set name="RspMsg"        value="手机号不能为空"/>
                <return/>
            </if>

            <!--  检测新密码是否为空  -->
            <if condition="ISNULL(nUsrpwd)"> 
                <set name="RspCod"        value="002035"            />
                <set name="RspMsg"        value="支付密码不能为空"/>
                <return/>
            </if>
            <!-- 查询用户是否存在 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QueryUsrInfo" />
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod"        value="999999"        />
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"        value="002008"    />
                <set name="RspMsg"        value="用户不存在"/>
                <return/>
            </elseif>
            
            <!-- 检查支付密码是否冻结 -->
            <set name="RCS_PWD_TYPE"        value="3"           />
            <set name="RCS_USER_CODE"       expr="CUST_ID"        />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"     />
            <set name="RCS_PRD_NO"          value=""            />
            <set name="RCS_TCODE"           value="5"           />
            <set name="RCS_STATUS"          value="0"           />
            <quote name="tranPwdLock"/>
            
            <!-- 检测与登录密码是否相同 新支付密码不能与登陆密码相同 -->
            <if condition="IS_EQUAL_STRING(nUsrpwd,CUSTPWD)">
                    <set name="MsgTyp" value="E" />
                    <set name="RspCod" value="02018" />
                    <set name="RspMsg" value="新支付密码不能与登陆密码相同" />
                    <return />
            </if>
            <!-- 更新支付密码 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="UpdateUsrInfoPwd"/>
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod"        value="099999"/>
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </if>
            <if condition="#RetCod!=0">
                <set name="RspCod"        value="020317"/>
                <set name="RspMsg"        value="更新错误"/>
                <return/>
            </if>
            <set name="RspCod"        value="000000"  />
            <set name="RspMsg"        value="更新成功"/>
        </process>
    </transaction>
    
    <transaction code="800011" desc="用户登录">
        <sql name="QueryUsrThere">
            SELECT CUST_ID,CUST_ID as CUSTIDS,CUST_PWD  FROM STPUSRINF WHERE CUST_LOGIN = #{USRMP}
        </sql>
        <!--*****************增加用户手机在线状态判断 ***********-->
        <!--sql name="UpdateUsrStaus" --><!-- 登录成功之后状态改为在线，插入最后操作时间,更新用户密钥 -->
           <!-- UPDATE STPUSRINF SET IS_LOGIN_FLAG='1',LAST_OPER_TIME=#{OPERTIME},SIGNMD5KEY=#{SIGNKEY} WHERE CUST_LOGIN = #{USRMP}
        </sql -->
        <sql name="UpdateUsrStaus"><!-- 登录成功之后,更新用户密钥,登录状态 by20150901 -->
           UPDATE STPUSRINF SET IS_LOGIN_FLAG='1', SIGNMD5KEY=#{SIGNKEY} WHERE CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="UpdateUsrSucTime"><!-- 登录成功之后,更新最后成功登录时间 by20150901 -->
           UPDATE STPCUSLOG set PRE_LOG_SUC_TIM = #{OPERTIME} WHERE CUST_ID = #{CUSTIDS}
        </sql>
        <!--***************** 增加用户手机在线状态判断 ***********-->
        <sql name="QueryUsrInfos">
            SELECT usr.CUST_ID USRID,cus.CUST_NAME USERNAME,cus.CUST_CRED_TYPE IDTYPECOD,cus.CUST_CRED_NO USERNO,
                   usr.USR_EMAIL EMAIL,usr.USR_STATUS,usr.EMAIL_STATUS,usr.USR_MOBILE  
            FROM STPUSRINF usr,STPCUSINF cus 
            WHERE usr.CUST_ID = cus.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <!--校验手机验证码需要-->
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>   
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random,TimeOut
            FROM STPVERIFY 
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
        <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
            SELECT 
            EXTRACT(DAY FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*24*60 + EXTRACT(HOUR FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*60 +  EXTRACT(MINUTE FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND )) as timeDifference,
            CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
            FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
            INSERT INTO STPLOGTMP
            (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
            VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
        </sql>
        <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
            LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
            WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="USRPWD:G_RANDOM"/>
            <!-- 增加用户手机在线状态判断 -->
            <quote name="ParseRequestParamsNoCheckStatus"/>
            
            <!--  检测用户名是否为空  -->
            <if condition="ISNULL(USRMP)">
                <set name="RspCod"        value="002035"        />
                <set name="RspMsg"        value="手机号不能为空"/>
                <return/>
            </if>

            <!--  检测密码是否为空  -->
            <if condition="ISNULL(USRPWD)"> 
                <set name="RspCod"        value="002035"          />
                <set name="RspMsg"        value="登录密码不能为空"/>
                <return/>
            </if>
           
            <!--检查提供的用户名是否存在-->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QueryUsrThere" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"        value="999999"        />
                <set name="RspMsg"        value="提供的登录名不存在，不能用于登录"/>
                <return/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"        value="999999"        />
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </elseif>
            
            <!--校验手机验证码-->
            <!--quote name="chkRandom"/-->
            
            <!-- 用户登录密码锁定次数判断 -->
             <set name="USER_ID" expr="DELBOTHSPACE(USRMP)" />
             <set name="CUSTTYPE"  value="0"/><!--0用户1 商户 2企业-->
             <set name="PWDTYPE"   value="0"/><!--0:登录密码 1:支付密码-->
             <set name="FailFlag"  value="0"/>
             <quote name="usrpwdlock"/>
             <!-- 用户登录密码锁定次数判断 -->
             
            <!-- 查询用户密码是否正确 -->
            <if condition="IS_NOEQUAL_STRING(CUST_PWD,USRPWD)">
                <set name="RspCod"    value="08042"/>
                <set name="RspMsg"    value="登录密码不正确"/>
                <quote name="UpLoginInfo"/>
                <return/>
            </if>
            
            <!--  查询用户信息  -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QueryUsrInfos" />
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod"        value="999999"/>
                <set name="RspMsg"        value="数据库错误！"/>
                <return/>
            </if>
            <if condition="#RetCod!=0">
                <set name="RspCod"        value="002008"/>
                <set name="RspMsg"        value="用户信息不存在"/>
                <return/>
            </if>
            
            <!-- 修改登记失败信息表 -->
            <do func="ExecSql" error="IGNORE">
               <para name="SqlCmd" sql="UpdUsrLogInfo"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="RSPCOD" value="02040"/>
               <set name="RSPMSG" value="更新登录信息失败!"/> 
               <return/>
            </if>
            
            <set name="RspCod"        value="000000"  />
            <set name="RspMsg"        value="登录成功"/>
            
            <!-- 增加用户手机在线状态判断-->
            <quote name="InsOnlineTime"  desc="记住登录状态"/>
            
            <set name="RCS_USER_CODE"       expr="CUSTIDS"        />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"     />
            <set name="RCS_PRD_NO"          value=""            />
            <set name="RCS_TCODE"           value=""            />
            <set name="RCS_STATUS"          value="1"           />
            
        </process>
    </transaction>

    <transaction code="800012" desc="用户退出">
        <!--增加用户手机在线状态判断 -->
        <sql name="UpdateUsrStaus"><!-- 登录成功之后状态改为在线，插入最后操作时间 -->
            UPDATE STPUSRINF SET IS_LOGIN_FLAG='0',LAST_OPER_TIME=#{OPERTIME} WHERE CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="QueryUsrThere">
            SELECT CUST_ID as CUSTIDS FROM STPUSRINF WHERE CUST_LOGIN = #{USRMP}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value=""/>
            <!--增加用户手机在线状态判断 -->
            <quote name="ParseRequestParamsNoCheckStatus"/>
            <!--增加用户手机在线状态判断 -->
            
            <set name="RspCod"          value="000000"  />
            <set name="RspMsg"          value="交易成功"/>
            
            <!--检查提供的用户名是否存在-->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QueryUsrThere" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"        value="999999"        />
                <set name="RspMsg"        value="提供的登录名不存在"/>
                <return/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"        value="999999"        />
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </elseif>
            
            <!--***************** 增加用户手机在线状态判断 ***********-->
            <quote name="UpdOnlineTime"  desc="记住登录状态"/>
            <!--***************** 增加用户手机在线状态判断 ***********-->
            
            <set name="RCS_USER_CODE"       expr="CUSTIDS"        />
            <set name="RCS_PAY_TYPE"        expr="TRANDESC"     />
            <set name="RCS_PRD_NO"          value=""            />
            <set name="RCS_TCODE"           value=""            />
            <set name="RCS_STATUS"          value="1"           />
            <quote name="tranByRightTime"/>
        </process>
    </transaction>
    
    <transaction code="800013" desc="用户余额查询">
        <sql name="QryUsrInfPay">
            SELECT usr.CUST_ID USRID,arp.PAY_AC_NO PAYACNO 
            FROM STPUSRINF usr,STPCUSINF cus,ARP_AC_CUST_REL arp 
            WHERE usr.CUST_ID = cus.CUST_ID 
            AND usr.CUST_ID = arp.CUST_ID 
            AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="queBal">
            SELECT PAY_AC_NO as PAYACNO,
                    CASH_AC_BAL-FROZ_BALANCE as casfroz,
                    CASH_AC_BAL as CASHACBAL,  
                    FROZ_BALANCE as FROZBALANCE,  
                    TO_CHAR(to_number(CASH_AC_BAL)/100,'9999999999990.00') as CashAcBal1, 
                    TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'9999999999990.00') as usrBal,  
                    TO_CHAR(to_number(CASH_AC_BAL)/100,'9999999999990.00') as acBal, 
                    TO_CHAR(to_number(FROZ_BALANCE)/100,'9999999999990.00') as noUsrBal, 
                    TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'9999999999990.00') as getBal,  
                    TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'9999999999990.00') as payCBal 
            FROM ARP_AC_PROFILE 
            WHERE PAY_AC_NO = #{PAYACNO}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value=""/>
            <quote name="ParseRequestParams"/>

            <!-- 查询用户账号 -->
            <do func="ReadRecord"       error="IGNORE">
                <para name="SqlCmd"     sql="QryUsrInfPay"/>
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod"         value="099999"/>
                <set name="RspMsg"         value="系统忙，请稍后再试！"/>
                
                <set name="RCS_USER_CODE"       expr="USRID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="系统忙，请稍候"  />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"         value="023001"/>
                <set name="RspMsg"         value="用户不存在！"/>
                
                <set name="RCS_USER_CODE"       expr="USRID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="用户不存在！"    />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </elseif>
          
            <do func="ReadRecord"        error="IGNORE">
                <para name="SqlCmd"        sql="queBal"/>
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod"         value="099999"/>
                <set name="RspMsg"         value="系统忙，请稍后再试！"/>
                
                <set name="RCS_USER_CODE"       expr="USRID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="查余额系统忙！"  />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            <if condition="#RetCod!=0">
                <set name="RspCod"         value="099999"/>
                <set name="RspMsg"         value="未查到数据！"/>
                
                <set name="RCS_USER_CODE"       expr="USRID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="未查到账户信息！"/>
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            
            <if condition="ISNULL(FROZBALANCE)">
                <set name="FROZBALANCE"    value="0.00"/>
            </if>
            <set name="FROZBALANCE"      expr="noUsrBal"/>
            <set name="CASH"             expr="usrBal"/>
            <set name="USERAMT"          expr="acBal"/>
            
            <set name="RspCod"           value="000000"                             />
            <set name="RspMsg"           value="交易成功"                           />
            
            <set name="RCS_USER_CODE"       expr="USRID"            />
            <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
            <set name="RCS_PRD_NO"          value=""                />
            <set name="RCS_TCODE"           value=""                />
            <set name="RCS_STATUS"          value="1"               />
            <quote name="tranByRightTime"/>
        </process>
    </transaction>
    
    <transaction code="800014" desc="用户充值_快捷">
        <sql name="UpdPay"> <!-- 更新支付订单表 -->
            payOrdNo=#{payOrdNo}
        </sql>
        <sql name="UpdReg"> <!-- 更新充值订单表 -->
            prdordno=#{PrdOrdNo} and prdOrdType='1'
        </sql> 
        <sql name="QryRegInf"> <!-- 查询充值订单 -->
            select prdOrdNo from StpPrdInf where prdordno=#{prdordno} and prdOrdType='1'
        </sql>
        <sql name="QryCusInf"><!-- 查询客户信息-->
            SELECT CUST_STATUS FROM StpCusInf WHERE CUST_ID=#{USERID}
        </sql>
        <sql name="SelAccInf"><!-- 查询客户账户信息-->
            SELECT a.AC_STATUS,a.PAY_AC_NO as payacno FROM ARP_AC_PROFILE a,ARP_AC_CUST_REL b WHERE b.CUST_ID=#{USERID} AND a.PAY_AC_NO=b.PAY_AC_NO
        </sql>
        <sql name="QryUsrInf"><!-- 查询客户信息-->
            SELECT CUST_LOGIN,CUST_ID AS USRID,usr_mobile  FROM StpUsrInf WHERE CUST_LOGIN=#{USRMP}
        </sql>
        <sql name="QryPassInf"><!-- 查询客户支付密码信息-->
            SELECT PASSWORD,CUST_ID FROM ARP_AC_CUST_REL WHERE PAY_AC_NO=#{PAYACNO}
        </sql>
        <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
            SELECT CASH_AC_BAL,FROZ_BALANCE FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNO}
        </sql>
        
        <!--校验手机验证码需要-->
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>   
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random,TimeOut
            FROM STPVERIFY 
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="PAYPWD:G_RANDOM"/>
            <quote name="ParseRequestParams"/>

            <if condition="IS_EQUAL_STRING(UsrMp,'')">
                <set name="RspCod"       value="02035"      />
                <set name="RspMsg"       value="手机号为空" />
                <return/>
            </if>
            <if condition="IS_EQUAL_STRING(BANKCARDNO,'')">
                <set name="RspCod"       value="02035"          />
                <set name="RspMsg"       value="银行卡号为空"   />
                <return/>
            </if>
            
            <!-- 查询银行号缩写 -->
            <set name="bankCard"    expr="BANKCARDNO"/>
            <do func="GetCrdInfo" error="IGNORE">
                <para name="CrdNo"  expr="bankCard" />
            </do>
            <if condition="#RetCod!=0">
                <set name="bankcode"    value=""/>
            </if>
            <set name="BANKCODE"      expr="ISSNO" />
            <set name="BANKCARDNO"      expr="ISSNO" />
            <if condition="OR(IS_EQUAL_STRING(TXCHANNEL,''),IS_EQUAL_STRING(BANKCARDNO,''),IS_EQUAL_STRING(PAYPWD,''),IS_EQUAL_STRING(TXAMT,''),IS_EQUAL_STRING(bankcode,''))">
                <set name="RspCod"      value="02036"      />
                <set name="RspMsg"      value="传送参数不完整" />
                <return/>
            </if>
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"    value="09992"/>
                <set name="RspMsg"    value="用户信息不存在"/>
                
                <set name="RCS_USER_CODE"       expr="USRID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="用户信息不存在"  />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            <if condition="#RetCod!=0">
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                
                <set name="RCS_USER_CODE"       expr="USRID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="数据库操作"      />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            <set name="userId"     expr="USRID"/>
            
            <if condition="ISNUMBER(UsrMp)">
                <set name="RANDUSRMP"  expr="UsrMp"/>
            </if>
            <esle>
                <set name="RANDUSRMP"  expr="usr_mobile"/>
            </esle>
            <!--校验手机验证码-->
            <quote name="chkRandom"/>
            
            <!-- 检查支付密码是否冻结 -->
            <set name="RCS_PWD_TYPE"        value="3"           />
            <set name="RCS_USER_CODE"       expr="userId"        />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"     />
            <set name="RCS_PRD_NO"          value=""            />
            <set name="RCS_TCODE"           value="5"           />
            <set name="RCS_STATUS"          value="0"           />
            <quote name="tranPwdLock"/>
            
            <quote name="usrChk"/>
            <quote name="chkAcc"/>
            
            <set name="txnDat"     expr="TACCDT"/>
            <set name="orderNo"    value=""/>
            <set name="txnAmt"     expr="txAmt"/>
            <!--校验支付密码-->
            <set name="paypwd"     expr="paypwd"/>
            <quote name="chkPayPwd"/>
            
            <!--限额检查 start--> 
            <set name="TXCHANNEL"     expr="TXCHANNEL"/>
            <set name="payType"       expr="TXCHANNEL"/>
            <set name="CredNo"        expr="BANKCARDNO"/>
            <set name="Filed1"        expr="FILED"/>
            <set name="PAY_TYPE"      value="05"/>    <!--  限额检查接口，05为快捷支付-->
            <set name="txAmt"         expr="AMTPOWER(TXAMT,2)"/>    <!--交易金额-->
            <set name="Amt"           expr="txAmt"/>
            <set name="User_code"     expr="USRID"/>
            <set name="comp_code"     value=""/>
            <set name="cust_type"     value="1"/>  
            <set name="Time"          expr="GETDATETIME()"/>
            <set name="DATE"          expr="GETDATE()"/>
            <set name="TRAN_TYPE"     value="1"/>
            <set name="ServiceCode"   value="680518"/>
            <quote name="chkLimAmt"/>
            <!--限额检查   end--> 
            
            <!--  首次充值，要建立充值订单  -->
            <set name="ordstatus"    value="00"/>                 <!--  默认状态为待付款  -->
            <set name="custRptAcNo"  expr="PAYACNO"/>             <!--充值账号-->
            <set name="ordCcy"       value="CNY"/>
            <set name="ordAmt"       expr="txAmt"/>
            <set name="orderTime"    expr="GETDATETIME()"/>
            <set name="PrdOrdType"   value="1"/>                  <!--商品订单类型 1 充值-->
            <set name="bizType"      value="01"/>                 <!--业务类型 01 充值-->
            <set name="BANKCOD"      expr="BANKCODE"/> 
            <set name="CUST_ID"      expr="USERID"/>
            <set name="prdName"      value="充值"/>               <!-- 商品名称 --> 
            <set name="defPayWay"    value="3"/>                  <!--快捷支付-->
            <!-- 获取序号 -->
            <do func="GetSeqNo"  error="IGNORE">
                <para name="TblNam" value="stpseqrec"/>
                <para name="KeyNam" value="KeyNam"/>
                <para name="KeyVal" expr="STRCAT('StpPrdInf','SeqNo')"/>
                <para name="SeqNam" value="KeyVal"/>
                <para name="Len"    value="8"/>
                <para name="Circle" value="1"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09001"/>
                <set name="RspMsg"    value="获取序号错误"/>
                <return/>
            </if>
            <set name="SeqNo"        expr="STRCAT(SUBSTR(ActDat,2,7),KeyVal)"/>   <!--商品订单表序号-->
            
            <do func="GetSeqNo"  error="IGNORE">
                <para name="TblNam" value="stpseqrec"/>
                <para name="KeyNam" value="KeyNam"/>
                <para name="KeyVal" expr="STRCAT('StpPrdInf','PrdOrdNo')"/>
                <para name="SeqNam" value="KeyVal"/>
                <para name="Len"    value="8"/>
                <para name="Circle" value="1"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09001"/>
                <set name="RspMsg"    value="获取序号错误"/>
                <return/>
            </if>
            <set name="prdordno"    expr="STRCAT(ActDat,KeyVal)"/>    <!--商品订单号-->
            <set name="MERNO"       value=" "/>    <!--商品订单商户号为空-->
            <do func="InsertRecord" error="IGNORE">
                <para name="TblNam"  value="StpPrdInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                
                <set name="RCS_USER_CODE"       expr="USRID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
                <set name="RCS_PRD_NO"          expr="prdordno"         />
                <set name="RCS_TCODE"           value="数据库操作"      />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if> 
                    
            <!--获取序号 -->
            <do func="GetSeqNo"  error="IGNORE">
                <para name="TblNam" value="stpseqrec"/>
                <para name="KeyNam" value="KeyNam"/>
                <para name="KeyVal" expr="STRCAT('StpPayInf','PayOrdNo',GETDATE())"/>
                <para name="SeqNam" value="KeyVal"/>
                <para name="Len"    value="8"/>
                <para name="Circle" value="1"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09001"/>
                <set name="RspMsg"    value="获取序号错误"/>
                <return/>
            </if>
            <set name="payOrdNo"    expr="STRCAT('P',SUBSTR(ActDat,2,7),KeyVal)"/>
            
            <set name="txAmt"       expr="txAmt"/>  
            <set name="txCcy"       value="CNY"/> 
            <set name="ordstatus"   value="00"/>
            <set name="bankCod"     expr="BANKCODE"/> 
            <set name="PrdOrdNo"    expr="PrdOrdNo"/> <!-- 充值，支付订单中的商品订单号即为充值订单号  -->  
            <set name="ActDat"      expr="GETDATETIME()"/>
            <if condition="OR(ISNULL(PAYTYPE),IS_EQUAL_STRING(PAYTYPE,''))"> <!--PAYTYE 支付方式00 支付账户   01 网上银行    02 终端   03 快捷支付    04 混合支付    05 支票/汇款-->
              <set name="PAYTYPE"      value="03"/>   
            </if>
            <do func="InsertRecord" error="IGNORE">
                <para name="TblNam"  value="StpPayInf"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                <return/>
            </if>
            <!--begain 快捷支付送银行  测试-支付成功 -->
            <set name="PayRet"       value="00"/>
            <!--end    快捷支付送银行  测试-支付成功 -->
            <if condition="IS_NOEQUAL_STRING(PayRet,'00')">
                <quote name="UpdPay"/>
                <quote name="UpdReg"/>               <!--  更新充值订单  -->
                <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/> 
                <set name="acDate"  expr="GETDATE()"/>              <!--清算日期-->
                <set name="acTime"  expr="GETDATETIME('HHMISS')"/>  <!--清算时间-->  
                <return/>
            </if>
            <set name="ORDSTATUS"      value="01"/>
            <set name="payacno"        expr="PAYACNO"/> 

            <!--查询账户余额-->
            <quote name="selAccBal"/> 
            <set name="feeFlag" value="0"/>      <!--？？充值手续费收取标识   1 收取   0 不收   test ？？？  -->
            <if condition="IS_EQUAL_STRING(feeFlag,'1')">
                <set name="txnAmt_fee"    expr="txAmt"/>
                <!--计算银行手续费-->
                <!--quote name="SelBnkFee"/-->
                
                <if condition="#RetCod==0">
                    <!--quote name="FeeCount"/--> 
                    <set name="fee"            expr="DIV(AMTPOWER(FDIV(AMTPOWER(fee,2),'100','1'),1),10)"/>
                </if>
                <elseif condition="#RetCod==2">
                    <set name="fee"            value="0"/>
                </elseif>
            </if>
            <else>
                <set name="flag"           value="0"/> 
                <set name="fee"            value="0"/>   
                <set name="usrPar"         expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',txAmt,'/','Y','/')"/>  <!--用户记账参数-->
                <set name="PARAMS"         expr="usrPar"/>
            </else>
            <set name="netRecAmt"      expr="SUB(txAmt,fee)"/>                  <!--净额-->  
            
            <!--记账处理-->  
            <set name="TXN_TYP"        value="1"/>                              <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->      
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
                <set name="RspCod"    value="07005"/>
                <set name="RspMsg"    value="充值失败"/>
                
                <set name="RCS_USER_CODE"       expr="USRID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
                <set name="RCS_PRD_NO"          expr="prdordno"         />
                <set name="RCS_TCODE"           value="充值失败"        />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            
            <set name="TRANTYPE"       value="1"/>                  <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
            <set name="TRANWAY"        value="01"/>                 <!--交易方式 01网银、02终端、03消费卡、04虚拟账户、05快捷支付--> 
            <set name="TXCCY"          value="CNY"/>
            <set name="payType"        value="03"/>
            <set name="merNo"          value=" "/>
            
            <set name="acDate"         expr="GETDATE()"/>              <!--清算日期 zhxiugai -->
            <set name="acTime"         expr="GETDATETIME('HHMISS')"/>  <!--清算时间 zhxiugai -->  
            
            <quote name="UpdReg"/>               <!--  更新充值订单  --> 
            <quote name="UpdPay"/>               <!--  更新支付订单  --> 
            
            <set name="NXTPAG"         expr="succePage"/>     
            <set name="merRemark"      value="财运通"/> <!-- 商户信息 -->
            <set name="_REQUESTATTR.FORWARDURL"       expr="NXTPAG"/>    <!--异步通知页面-->
            
            <!--登记银行收款结算表-->
            <do func="GetSeqNo"  error="IGNORE">
                <para name="TblNam" value="stpseqrec"/>
                <para name="KeyNam" value="KeyNam"/>
                <para name="KeyVal" expr="STRCAT('ARP_BANK_REC_STL','SEQ_NO')"/>
                <para name="SeqNam" value="KeyVal"/>
                <para name="Len"    value="6"/>
                <para name="Circle" value="1"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09001"/>
                <set name="RspMsg"    value="获取序号错误"/>
                <return/>
            </if>
            <set name="SEQ_NO"           expr="STRCAT(SUBSTR(ActDat,1,4),KeyVal)"/>  
            <set name="BANK_CODE"        expr="bankcode"/>  
            <set name="BANK_AC_DATE"     expr="bankStlDate"/>  
            <set name="BANK_JRN_NO"      expr="bankJrnNo"/>  
            <set name="TX_CCY"           value="CNY"/>  
            <set name="TX_AMT"           expr="txAmt"/>  
            <set name="FEE"              expr="fee"/>      <!--计算手续费  ？？-->
            <set name="NET_REC_AMT"      expr="netRecAmt"/> 
            <set name="MER_NO"           expr="merNo"/> 
            <set name="PRD_ORD_NO"       expr="prdOrdNo"/> 
            <set name="PAY_CHANNEL"      expr="payType"/>  
            <set name="PAY_ORD_NO"       expr="payOrdNo"/> 
            <set name="PAY_ORD_DATE"     expr="GETDATE()"/> 
            <set name="PAY_BIZ_TYPE"     value="01"/>     <!--01 支付   02 充值-->
            <set name="REC_STL_STATUS"   value="0"/>      <!--0 正常记账   1 补记账-->
            <do func="InsertRecord" error="IGNORE">
                <para name="TblNam"  value="ARP_BANK_REC_STL" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                <set name="DWZ_STATUS_CODE"   value="300"/>
                <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
                <return/>
            </if>
            
            <set name="TXAMT"     expr="AMTADDDOT(TXAMT)"/>
            <set name="ACTDAT"    expr="FMTDATE(ActDat,0,4)"/>
            <set name="FLOR_TIME" expr="GETDATETIME()"/>
            <set name="OF_TITL"   expr="充值"/>
            <set name="OF_CONT"   expr="虚拟账户充值"/>
            <set name="MsgTyp"    value="N"/>
            <set name="RspCod"    value="000000"/>
            <set name="RspMsg"    value="交易成功"/>
            
            <!-- 将信息返回客户端 下面操作继续执行 -->
            <do func="CommitWork"/>
            <do func="putresponse"/>
            
            <!--通知风控系统登记订单信息-->
            <set name="ServiceCode" value="680517"/>
            <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
            <set name="TCODE"       expr="payOrdNo"/>           <!--平台流水号 支付订单号-->
            <set name="CTYPE"       value="1"/>                 <!--客户类型-->
            <set name="CLIENTCODE"  expr="USRID"/>     <!--客户编号-->
            <set name="CLIENTNAME"  expr="USRNAME"/>
            <set name="MOBILEPHONE" expr="USRMP"/>
            <set name="TAMT"        expr="AMTPOWER(TXNAMT,2)"/>
            <set name="REGDTTIME"   expr="STRCAT(acDate,acTime)"/>
            <set name="Time"        expr="acDate"/>
            <quote name="noticRcs"/>
            
            <set name="RCS_USER_CODE"       expr="USRID"            />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
            <set name="RCS_PRD_NO"          expr="prdordno"         />
            <set name="RCS_TCODE"           value=""                />
            <set name="RCS_STATUS"          value="1"               />
            <quote name="tranByRightTime"/>
        </process>
    </transaction>
    
    <transaction code="800015" desc="用户提现">
        <sql name="QryCusInf"><!-- 查询客户信息-->
            SELECT CUST_STATUS FROM StpCusInf WHERE CUST_ID=#{USERID}
        </sql>
        <sql name="SelAccInf"><!-- 查询客户账户信息-->
            SELECT a.AC_STATUS,a.PAY_AC_NO as payacno FROM ARP_AC_PROFILE a,ARP_AC_CUST_REL b WHERE b.CUST_ID=#{USERID} AND a.PAY_AC_NO=b.PAY_AC_NO 
        </sql>
        <sql name="QryPassInf"><!-- 查询客户支付密码信息-->
            SELECT PASSWORD,CUST_ID FROM ARP_AC_CUST_REL WHERE PAY_AC_NO=#{PAYACNO}
        </sql>
        <sql name="UpdFrezInf"><!-- 更新冻结信息-->
            UPDATE ARP_AC_FORZZ_DETAILS SET STATUS='00',END_DATE=#{CRE_DATE}  WHERE FROZ_NO=#{FROZ_NO}
        </sql>
        <sql name="QryUsrInf"><!-- 查询客户信息-->
            SELECT cust_login,cust_ID AS USRID,usr_mobile FROM StpUsrInf WHERE cust_login=#{USRMP}
        </sql>
        <sql name="QryBankDecrypt"><!-- 查询客户信息-->
             select DECRYPT_DES(#{bankPayAcNo},'0123456789ABCDEF') Decrypt_Bank_Name  from dual
        </sql>
          
         <!--校验手机验证码需要-->
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>   
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random,TimeOut
            FROM STPVERIFY 
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
        <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
            SELECT 
            EXTRACT(MINUTE FROM (sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND ) as timeDifference,
            CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
            FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
            INSERT INTO STPLOGTMP
            (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
            VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
        </sql>
        <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
            LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
            WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="PAY_PW:G_RANDOM"/>
            <quote name="ParseRequestParams"/>
            
            <if condition="IS_EQUAL_STRING(UsrMp,'')">
                <set name="RspCod"       value="02035"      />
                <set name="RspMsg"       value="手机号为空" />
                <return/>
            </if>
            
            <!-- 查询银行号缩写 -->
            <set name="bankCard"    expr="bankPayAcNo"/>
            
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryBankDecrypt" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"    value="09992"/>
                <set name="RspMsg"    value="解密失败"/>
            </if>
            <do func="GetCrdInfo" error="IGNORE">
                <para name="CrdNo"  expr="Decrypt_Bank_Name" />
            </do>
            <if condition="#RetCod!=0">
                <set name="GetBankCode"    value="ANYTHING"/>
            </if>
            <set name="BANKCODE"      expr="ISSNO" />
            <set name="GetBankCode"    expr="BANKCODE"/>
            
            <if condition="OR(IS_EQUAL_STRING(PAY_PW,''),IS_EQUAL_STRING(bankPayUserNm,''),IS_EQUAL_STRING(GetBankCode,''),IS_EQUAL_STRING(bankPayAcNo,''),IS_EQUAL_STRING(txAmt,''))">
                <set name="RspCod"       value="02036"      />
                <set name="RspMsg"       value="传送参数不完整" />
                <return/>
            </if>
              
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"    value="09992"/>
                <set name="RspMsg"    value="用户信息不存在"/>
                <return/>
            </if>
            <if condition="#RetCod!=0">
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                <return/>
            </if>
            <set name="paypwd"      expr="PAY_PW"/> 
            <set name="userID"      expr="USRID"/>
            
            <if condition="ISNUMBER(UsrMp)">
                <set name="RANDUSRMP"  expr="UsrMp"/>
            </if>
            <esle>
                <set name="RANDUSRMP"  expr="usr_mobile"/>
            </esle>
            
            <quote name="usrChk"/>
            <quote name="chkAcc"/>
            <set name="payAcNo"    expr="payAcNo"   /> 
            <set name="txnDat"     expr="TACCDT"    />
            <set name="orderNo"    value=""         />
            <set name="txnAmt"     expr="txAmt"     />
            
            <!-- 用户支付密码锁定次数判断 -->
             <set name="USER_ID" expr="DELBOTHSPACE(USRMP)" />
             <set name="CUSTTYPE"  value="0"/><!--0用户1 商户 2企业-->
             <set name="PWDTYPE"   value="1"/><!--0:登录密码 1:支付密码-->
             <set name="FailFlag"  value="0"/>
             <quote name="usrpwdlock"/>
             <!-- 用户支付密码锁定次数判断 -->
             
            <!--校验支付密码-->
            <quote name="chklockPayPwd"/>
            
            <!--校验手机验证码-->
            <quote name="chkRandom"/>
            <if condition="NOT(ISNULL(txAmt))">
                <set name="txAmt" expr="AMTPOWER(txAmt,2)"/>
            </if>
            
            <set name="amount"      expr="AMTADDDOT(txAmt)"/>
            <set name="payAcNo"     expr="payAcNo"/>
            <set name="bankAcNo"    expr="bankPayAcNo"/><!-- 需要提现的银行卡账号-->
            <set name="password"    expr="paypwd"/> 
            
            <!--限额检查 start--> 
            <set name="TXCHANNEL"     expr="TXCHANNEL"/>
            <set name="payType"       expr="TXCHANNEL"/>
            <set name="CredNo"        expr="BANKCARDNO"/>
            <set name="Filed1"        expr="FILED"/>
            <set name="PAY_TYPE"      value="05"/>    <!--  限额检查接口，05为快捷支付-->
            <set name="txAmt"         expr="txAmt"/>    <!--交易金额-->
            <set name="Amt"           expr="txAmt"/>
            <set name="User_code"     expr="USRID"/>
            <set name="comp_code"     value=""/>
            <set name="cust_type"     value="1"/>  
            <set name="Time"          expr="GETDATETIME()"/>
            <set name="DATE"          expr="GETDATE()"/>
            <set name="TRAN_TYPE"     value="7"/>
            <set name="ServiceCode"   value="680518"/>
            <quote name="chkLimAmt"/>
            <!--限额检查   end--> 
            
            <!--获取序号 -->
            <do func="GetSeqNo"  error="IGNORE">
                <para name="TblNam" value="stpseqrec"/>
                <para name="KeyNam" value="KeyNam"/>
                <para name="KeyVal" expr="STRCAT('StpCasInf','CasOrdNo')"/>
                <para name="SeqNam" value="KeyVal"/>
                <para name="Len"    value="8"/>
                <para name="Circle" value="1"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09001"/>
                <set name="RspMsg"    value="获取序号错误"/>
                <return/>
            </if>
            <set name="bankCode"   expr="GetBankCode"/>
            <set name="bankCode"   expr="bankCode"/>
            <set name="CasOrdNo"   expr="STRCAT('C',SUBSTR(ActDat,2,7),KeyVal)"/> 
            <set name="ActDat"     expr="GETDATETIME()"/> 
            <set name="CUST_ID"    expr="USRID"/>
            <set name="bankPayUserNm" expr="bankPayUserNm"/>
            <set name="OrdStatus"  value="00"/> 
            
            <!--登记提现订单信息-->  
            <do func="InsertRecord" error="IGNORE">
                <para name="TblNam"  value="StpCasInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                
                <set name="RCS_USER_CODE"       expr="USRID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
                <set name="RCS_PRD_NO"          expr="CasOrdNo"         />
                <set name="RCS_TCODE"           value="数据库错误"      />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            
            <!--冻结用户提现金额 -->  
            <set name="RCS_PRD_NO"      expr="CasOrdNo"/><!--订单号，如果不涉及置空-->
            <set name="PAY_AC_NO"       expr="payacno"/>
            <quote name="frezzAmt"/>
            
            <!--登记冻结信息-->
            <set name="BIZ_CODE"        expr="CasOrdNo"/>
            <set name="FROZ_REASON"     value="提现"/>
            <quote name="InsFrozInf"/>

            <!-- 修改登记失败信息表 -->
            <do func="ExecSql" error="IGNORE">
               <para name="SqlCmd" sql="UpdUsrLogInfo"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="RSPCOD" value="02040"/>
               <set name="RSPMSG" value="更新登录信息失败!"/> 
               <return/>
            </if>
            
            <set name="payOrdNo"    expr="CasOrdNo"/>
            <set name="FLOR_TIME"   expr="GETDATETIME()"/>
            <set name="txAmt"       expr="AMTADDDOT(txAmt)"/>
            <set name="Filed"       expr="PAYACNO"/>
            <set name="OF_TITL"   expr="提现"/>
            <set name="OF_CONT"   expr="虚拟账户提现"/>
            <set name="MsgTyp"    value="N"/>
            <set name="RspCod"    value="000000"/>
            <set name="RspMsg"    value="交易成功"/>
            
            <set name="RCS_USER_CODE"       expr="USRID"            />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
            <set name="RCS_PRD_NO"          expr="CasOrdNo"         />
            <set name="RCS_TCODE"           value=""                />
            <set name="RCS_STATUS"          value="1"               />
            
        </process>
    </transaction>
    
    <transaction code="800016" desc="用户转账">
        <sql name="QryCusInf"><!-- 查询客户信息-->
            SELECT cus.CUST_STATUS,cus.CUST_ID as USERID,usr.USR_STATUS as USRSTATUS,usr.usr_mobile FROM STPUSRINF usr,STPCUSINF cus WHERE usr.CUST_ID = cus.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="SelAccInf"><!-- 查询客户账户信息:状态和余额-->
            select a.PAY_AC_NO as PAY_AC_NO,a.CASH_AC_BAL,a.AC_STATUS from ARP_AC_PROFILE a,STPUSRINF b where b.CUST_ID=#{USERID} and (b.CUST_ID =substr(a.PAY_AC_NO,0,14))
        </sql>
        <sql name="UpdSts"> <!-- 更新转账订单表 -->
            update StpTraInf set OrdStatus='01' where traOrdNo=#{ORDNO}
        </sql>
        <sql name="QryPassInf"><!-- 查询客户支付密码信息-->
            SELECT PASSWORD,CUST_ID FROM ARP_AC_CUST_REL WHERE PAY_AC_NO=#{PAYNO}
        </sql>
        <sql name="QryGetAccNo"><!-- 查询客户账户信息:帐号-->
            select a.CUST_ID as TGetAccNo,c.CUST_NAME as TGetAccNam from ARP_AC_CUST_REL a,STPUSRINF b,STPCUSINF c where b.CUST_LOGIN=#{TGetAccNo} and b.CUST_ID =a.CUST_ID and b.CUST_ID=c.CUST_ID
        </sql>
        <sql name="QryRepeatPrd"> <!-- 查询重复订单 -->
            SELECT TRAORDNO as TEMP_COUNT FROM StpTraInf WHERE CUST_ID = #{USERID} AND FILED2 = #{FILED2}
        </sql>
         <!--校验手机验证码需要-->
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>   
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random,TimeOut
            FROM STPVERIFY 
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
        <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
            SELECT 
            EXTRACT(MINUTE FROM (sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND ) as timeDifference,
            CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
            FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
            INSERT INTO STPLOGTMP
            (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
            VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
        </sql>
        <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
            LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
            WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="PAYPWD:G_RANDOM"/>
            <quote name="ParseRequestParams"/>

            <!-- 同账户不能转账 -->
            <if condition="IS_EQUAL_STRING(USRMP,TGETACCNO)">
                <set name="RspCod"    value="009992"            />
                <set name="RspMsg"    value="同账户不能转账！"  />
                <return/>
            </if>

            <set name="getCustNo"   expr="TGETACCNO"/>
            
            <quote name="usrChk"/>
            
            <if condition="ISNUMBER(UsrMp)">
                <set name="RANDUSRMP"  expr="UsrMp"/>
            </if>
            <esle>
                <set name="RANDUSRMP"  expr="usr_mobile"/>
            </esle>
            <!--校验手机验证码-->
            <quote name="chkRandom"/>
            
            <!-- 检查是否有人模拟请求，禁止重复转账请求 -->
            <set name="USERID"    expr="USERID"     desc="用户ID"    />
            <set name="FILED2"    expr="VerifyCode" desc="转账时间戳"/>
            <if condition="ISNULL(VerifyCode)">
                <set name="RspCod"    value="000001"              />
                <set name="RspMsg"    value="交易错误，不能转账！"/>
                <return/>
            </if>
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryRepeatPrd" />
            </do>
            <if condition="#RetCod==0">
                <set name="RspCod"    value="000001"              />
                <set name="RspMsg"    value="重复订单，不能转账！"/>
                <return/>
            </if>
            
            <quote name="chkAcc"/>
            <quote name="getPublicInfo"/>
            <!--验证用户认证状态-->
            <if condition="IS_NOEQUAL_STRING(USRSTATUS,'2')">
                <set name="RspCod"    value="20019"/>
                <set name="RspMsg"    value="您目前未进行身份认证,请提交认证资料通过后再进行转账！"/>
                <return/>
            </if>
            
            <set name="TXAMT"           expr="TXAMT"        />
            <set name="CASH_AC_BAL"     expr="CASH_AC_BAL"  />
            
            <!--验证可转金额是否大于转账金额-->
            <if condition="DOUBLECMP(AMTPOWER(TXAMT,2),6,CASH_AC_BAL)">
                <set name="RspCod"    value="20014"/>
                <set name="RspMsg"    value="转账金额大于账户余额！"/>
                <return/>
            </if>
            
            <!-- 用户支付密码锁定次数判断 -->
             <set name="USER_ID" expr="DELBOTHSPACE(USRMP)" />
             <set name="CUSTTYPE"  value="0"/><!--0用户1 商户 2企业-->
             <set name="PWDTYPE"   value="1"/><!--0:登录密码 1:支付密码-->
             <set name="FailFlag"  value="0"/>
             <quote name="usrpwdlock"/>
             <!-- 用户支付密码锁定次数判断 -->
             
            <!--校验支付密码-->
            <set name="PAYNO"      expr="PAY_AC_NO"/>
            <set name="paypwd"     expr="PAYPWD"/>
            <quote name="chklockPayPwd"/>
            
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryGetAccNo" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"    value="009992"            />
                <set name="RspMsg"    value="用户帐号信息不存在"/>
                <return/>
            </if>
            
            <!--建立转账订单表-->
            <!--获取序号 -->
            <do func="GetSeqNo"  error="IGNORE">
                <para name="TblNam" value="stpseqrec"/>
                <para name="KeyNam" value="KeyNam"/>
                <para name="KeyVal" expr="STRCAT('StpTraInf','TraOrdNo')"/>
                <para name="SeqNam" value="KeyVal"/>
                <para name="Len"    value="8"/>
                <para name="Circle" value="1"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09001"/>
                <set name="RspMsg"    value="获取序号错误"/>
                <return/>
            </if>
            <set name="ZZNO"        expr="STRCAT('T',SUBSTR(nowDate,2,7),KeyVal)"/>
            <set name="traOrdNo"    expr="ZZNO"/>
            <set name="batNo"       expr="ZZNO"/><!--批次号-->
            <set name="CUST_ID"     expr="USERID"/><!--Cust_id-->
            <set name="txAmt"       expr="AMTPOWER(TXAMT,2)"/><!--转账金额-->
            <set name="TOTAMT"      expr="TXAMT"/>   
            <set name="traTime"     expr="GETDATETIME()"/>
            <set name="CLEARDAT"    expr="nowDate"/>
            <set name="ordCcy"      value="CNY"/>
            <set name="txCcy"       expr="ordCcy"/>
            <set name="OrdStatus"   value="00"/>    <!--待付款-->
            <set name="filed1"      expr="FILED"/> <!--备注-->
            <set name="TGETACCNO"   expr="TGETACCNO"/><!--收款账号-->
            <do func="InsertRecord" error="IGNORE">
                <para name="TblNam"  value="StpTraInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                <return/>
            </if>
            
            <!--准备转账记账数据-->
            <set name="usrPar"      expr="STRCAT(CUST_ID,'/','01','/','-','/','CNY','/',AMT,'/','Y','/')"/>     <!--转出方记账参数-->
            <set name="usrParRev"   expr="STRCAT(TGetAccNo,'/','01','/','+','/','CNY','/',AMT,'/','Y','/')"/>   <!--转入方记账参数-->
            <set name="PARAMS"      expr="STRCAT(usrParRev,',',usrPar)"/>
            <!--记账处理-->
            <set name="TXN_TYP"      value="3"/>      <!--用途 3 转账-->
            <set name="prdordno"     expr="traordno"/>
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="08060"/>
               <set name="RspMsg"    value="转账失败"/>
               <return/>
            </if>
            
            <!--更新订单状态-->
            <set name="ORDNO"    expr="traOrdNo"/>
            <do func="ExecSql" error="IGNORE">
               <para name="SqlCmd" sql="UpdSts"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09999"/>
               <set name="RspMsg"    value="数据库操作错误"/>
               <return/>
            </if>
            
            <set name="payOrdNo"    expr="zzno"/>
            <set name="payCustNo"   expr="USRMP"/>
            <set name="FLOR_TIME"   expr="GETDATETIME()"/>
            <set name="txAmt"       expr="AMTFMT(txAmt)"/>
            <set name="Filed"       expr="FIELD"/> 
            
            <!-- 修改登记失败信息表 -->
            <do func="ExecSql" error="IGNORE">
               <para name="SqlCmd" sql="UpdUsrLogInfo"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="RSPCOD" value="02040"/>
               <set name="RSPMSG" value="更新登录信息失败!"/> 
               <return/>
            </if>
            
            <set name="RspCod"    value="000000"/>
            <set name="RspMsg"    value="交易成功"/>
            
            <!-- 将信息返回客户端 下面操作继续执行 -->
            <do func="CommitWork"/>
            <do func="putresponse"/>
            
            <!--通知风控系统登记订单信息-->
            <set name="ServiceCode" value="680517"/>
            <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
            <set name="TCODE"       expr="traOrdNo"/>           <!--平台流水号 转账订单号-->
            <set name="CTYPE"       value="1"/>                 <!--客户类型-->
            <set name="CLIENTCODE"  expr="USERID"/>     <!--客户编号-->
            <set name="CLIENTNAME"  expr="USERID"/>
            <set name="MOBILEPHONE" expr="USRMP"/>
            <set name="TRANTYPE"    value="6"/>                 <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
            <set name="TAMT"        expr="TXAMT"/>
            <set name="REGDTTIME"   expr="GETDATETIME()"/>
            <set name="Time"        expr="SUBSTR(REGDTTIME,1,8)"/>
            <quote name="noticRcs"/>
            
            <set name="RCS_USER_CODE"       expr="USERID"            />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
            <set name="RCS_PRD_NO"          expr="traOrdNo"         />
            <set name="RCS_TCODE"           value=""                />
            <set name="RCS_STATUS"          value="1"               />
            
        </process>
    </transaction>
    
    <transaction code="800017" desc="用户订单浏览">
        <sql name="queryAllInf"> <!--  查询用户收款交易记录  -->
            select * from(
            select  p.TRAORDNO as prdOrdNo1,p.TRAORDNO as prdOrdNo,To_Char(to_date(p.traTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')     as orderDate ,'' as Transort,
            '转出' as TransortName,TO_CHAR(to_number(p.TXAMT)/100,'FM9999999999990.00')    as ORDAMT,  ordstatus,decode(trim(ordstatus),'00','待付款','01','付款成功','02','付款失败','12','预付费','99','付款超时') as ordstatusName,1 as pageflags 
            from vw_StpTraInf p , stpusrinf a
            where  p.cust_id=a.cust_id ${USERID1} 
             ${prdOrdNo1} ${orderDate1}  
            union
            select  p.PRDORDNO as prdOrdNo1,p.PRDORDNO as prdOrdNo,
            To_Char(to_date(p.orderTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')  as orderDate 
            ,p.transort as transort,decode(p.prdordtype,'1','充值','消费') as TransortName,   
            TO_CHAR(to_number(p.ORDAMT)/100,'FM9999999999990.00') as ORDAMT, 
             p.ordstatus as ordstatus,ordstatusName,decode(p.prdordtype,'1',4,2) as pageflags 
            from vw_StpPrdInf p, stpusrinf a
            where  p.cust_id=a.cust_id ${USERID2} 
                  ${prdOrdNo2} ${orderDate2}   
             
            union
            select  p.casOrdNo as prdOrdNo1,p.casOrdNo as prdOrdNo,To_Char(to_date(p.actDat,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')  as orderDate    ,'' as Transort,'提现' as TransortName,TO_CHAR(to_number(p.txAmt)/100,'FM9999999999990.00')     as ORDAMT,    ordstatus,ordstatusName ,3 as pageflags 
            from vw_StpCasInf p, stpusrinf a
            where  p.cust_id=a.cust_id ${USERID3} 
                  ${prdOrdNo3} ${orderDate3}   
              
            union
            select  p.TRAORDNO as prdOrdNo1,p.TRAORDNO as prdOrdNo,To_Char(to_date(p.traTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as orderDate ,'' as Transort,'收款' as TransortName,   TO_CHAR(to_number(p.TXAMT)/100,'FM9999999999990.00')    as ORDAMT,  OrdStatus    ,decode(trim(ordstatus),'00','待付款','01','收款成功','02','收款失败','99','付款超时') as ordstatusName,5 as pageflags
            from vw_StpTraInf p,stpusrinf a ,ARP_AC_CUST_REL r
            where  p.TGetAccNo=r.pay_ac_no and a.cust_id=r.cust_id ${USERID5}    
                   ${prdOrdNo5} ${orderDate5}  
            ) zz
            order by zz.orderDate desc
        </sql>
        <process>
            
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value=""/>
            <quote name="ParseRequestParams"/>
            <if condition="ISNULL(PageNum)">
              <set name="PageNum"       value="1"/>
            </if>
            <if condition="ISNULL(G_NumPerPag)">
              <set name="G_NumPerPag"     value="10"/>
            </if>
            
            <set name="Condition"      value=""/>
            <set name="Fh"             value="'"/>
            
            <!-- 检测输入项 -->
            <if condition="IS_EQUAL_STRING(STARTDATE,'')">            <!--  如果没输入，就传送空值    -->
                <set name="startDate"      expr="CALCDATE(GETDATE(),'-','d',31)"/>
            </if>
            <else>
                <if condition="INTCMP(STRLEN(STARTDATE),4,8)">
                    <set name="startDate"     expr="FMTDATE(STARTDATE,4,0)" />         <!-- 开始时间 -->
                </if>
            </else>
            
            <if condition="IS_EQUAL_STRING(ENDDATE,'')">            <!--  如果没输入，就传送空值    -->
                <set name="endDate"        expr="GETDATETIME('YYYYMMDD')"/>
            </if>
            <else>
                <if condition="INTCMP(STRLEN(ENDDATE),4,8)">
                    <set name="endDate"     expr="FMTDATE(ENDDATE,4,0)" />         <!-- 结束时间 -->
                </if>
            </else>
            
            <set name="orderDate1"      expr="STRCAT(' and TRATIME      &gt;= ',Fh, STRCAT(STARTDATE,'000000'),Fh,' and  TRATIME      &lt;=',Fh,STRCAT(endDate,'235959'),Fh)"/>
            <set name="orderDate2"      expr="STRCAT(' and orderTime    &gt;= ',Fh, STRCAT(STARTDATE,'000000'),Fh,' and  orderTime   &lt;=',Fh,STRCAT(endDate,'235959'),Fh)"/>
            <set name="orderDate3"      expr="STRCAT(' and actDat       &gt;= ',Fh, STRCAT(STARTDATE,'000000'),Fh,' and  actDat      &lt;=',Fh,STRCAT(endDate,'235959'),Fh)"/>
            <set name="orderDate4"      expr="STRCAT(' and orderDate    &gt;= ',Fh, STARTDATE,Fh,' and  orderDate   &lt;=',Fh,endDate,Fh)"/>
            <set name="orderDate5"      expr="STRCAT(' and TRATIME      &gt;= ',Fh, STRCAT(STARTDATE,'000000'),Fh,' and  TRATIME      &lt;=',Fh,STRCAT(endDate,'235959'),Fh)"/>
            <set name="orderDate6"      expr="STRCAT(' and ORDERDATE    &gt;= ',Fh, STARTDATE,Fh,' and  ORDERDATE   &lt;=',Fh,endDate,Fh)"/>
            <if condition="INTCMP(STRLEN(STARTDATE),3,8)">
                <set name="startDate"     expr="FMTDATE(STARTDATE,0,4)" />
            </if>
            <if condition="INTCMP(STRLEN(ENDDATE),3,8)">
                <set name="ENDDATE"       expr="FMTDATE(ENDDATE,0,4)" /> 
            </if>
            
            <if condition="IS_NOEQUAL_STRING(prdOrdNo,'')">            
                <set name="prdOrdNo1"      expr="STRCAT(' and TRAORDNO  like ',Fh,'%',prdOrdNo,'%',Fh)"/>
                <set name="prdOrdNo2"      expr="STRCAT(' and PRDORDNO  like ',Fh,'%',prdOrdNo,'%',Fh)"/>  
                <set name="prdOrdNo3"      expr="STRCAT(' and casOrdNo  like ',Fh,'%',prdOrdNo,'%',Fh)"/>  
                <set name="prdOrdNo4"      expr="STRCAT(' and regOrdNo  like ',Fh,'%',prdOrdNo,'%',Fh)"/>
                <set name="prdOrdNo5"      expr="STRCAT(' and TRAORDNO  like ',Fh,'%',prdOrdNo,'%',Fh)"/>  
                <set name="prdOrdNo6"      expr="STRCAT(' and lodOrdNo  like ',Fh,'%',prdOrdNo,'%',Fh)"/>     
            </if>
            <else>
                <set name="prdOrdNo1"      value=""/>
                <set name="prdOrdNo2"      value=""/>  
                <set name="prdOrdNo3"      value=""/>  
                <set name="prdOrdNo4"      value=""/>
                <set name="prdOrdNo5"      value=""/>
                <set name="prdOrdNo6"      value=""/>  
            </else>
            
            <set name="USERID1"         value=" and cust_login = ' '" /> 
            <set name="USERID2"         value=" and cust_login = ' '" /> 
            <set name="USERID3"         value=" and cust_login = ' '" /> 
            <set name="USERID4"         value=" and cust_login = ' '" /> 
            <set name="USERID5"         value=" and cust_login = ' '"  /> 
            <set name="USERID6"         value=" and cust_login = ' '" /> 
            <if condition="ISNULL(BUSITYPE)">
                <set name="traType"   value=""/>
            </if>
            <else>
                <switch expr="BUSITYPE">
                    <case value="1">
                        <set name="traType"   value="5"/>
                      <break/>
                    </case>
                    <case value="2">
                        <set name="traType"   value="2"/>
                      <break/>
                    </case>
                    <case value="3">
                        <set name="traType"   value="3"/>
                      <break/>
                    </case>
                    <case value="4">
                        <set name="traType"   value="4"/>
                      <break/>
                    </case>
                    <case value="5">
                        <set name="traType"   value="6"/>
                      <break/>
                    </case>
                    <default>
                        <set name="traType"   value="1"/>
                    </default>
                </switch>
            </else>
            <switch expr="traType">
                <case value="1">
                    <set name="USERID1"      expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />
                    <set name="USERID2"      expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />
                    <set name="USERID3"      expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />
                    <set name="USERID4"      expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />
                    <set name="USERID5"      expr="STRCAT(' and cust_login = \'',USRMP,'\'')" /> 
                    <set name="USERID6"      expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />
                    <break/>
                </case> 
                <case value="2">
                    <set name="USERID1"      value=" and cust_login = ' '" />
                    <set name="USERID2"      expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />
                    <set name="USERID3"      value=" and cust_login = ' '" />
                    <set name="USERID4"      value=" and cust_login = ' '" />
                    <set name="USERID5"      value=" and cust_login = ' '" />
                    <set name="USERID6"      value=" and cust_login = ' '" />
                    <break/>
                </case>
                <case value="3"><!--充值-->   
                    <set name="USERID4"         expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />  
                    <set name="USERID1"         value=" and cust_login = ' '" />                     
                    <set name="USERID2"         expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />        <!-- 商品订单 StpPrdInf -->             
                    <set name="USERID3"         value=" and cust_login = ' '" />
                    <set name="USERID5"         value=" and cust_login = ' '" />    
                    <set name="USERID6"         value=" and cust_login = ' '" /> 
                    <break/>
                </case>
                <case value="4"><!-- 提现 -->    
                    <set name="USERID3"         expr="STRCAT(' and cust_login = \'',USRMP,'\'')" /> 
                    <set name="USERID1"         value=" and cust_login = ' '" />
                    <set name="USERID2"         value=" and cust_login = ' '" />
                    <set name="USERID4"         value=" and cust_login = ' '" />
                    <set name="USERID5"         value=" and cust_login = ' '" />   
                    <set name="USERID6"         value=" and cust_login = ' '" /> 
                    <break/>
                </case>
                <case value="5"><!-- 付款 -->    
                    <set name="USERID1"         expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />
                    <set name="USERID2"         value=" and cust_login = ' '" />
                    <set name="USERID3"         value=" and cust_login = ' '" />
                    <set name="USERID4"         value=" and cust_login = ' '" /> 
                    <set name="USERID5"         value=" and cust_login = ' '" />   
                    <set name="USERID6"         value=" and cust_login = ' '" /> 
                    <break/>
                </case>
                <case value="6"><!-- 收款 -->
                    <set name="USERID5"         expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />
                    <set name="USERID1"         value=" and cust_login = ' '" />
                    <set name="USERID2"         value=" and cust_login = ' '" />
                    <set name="USERID3"         value=" and cust_login = ' '" /> 
                    <set name="USERID4"         value=" and cust_login = ' '" />
                    <set name="USERID6"         value=" and cust_login = ' '" /> 
                    <break/>
                </case>
                <default>
                    <!--查询商品订单记录-->
                    <set name="USERID1"      expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />
                    <set name="USERID2"      expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />
                    <set name="USERID3"      expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />
                    <set name="USERID4"      expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />
                    <set name="USERID5"      expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />
                    <set name="USERID6"      expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />
                </default>
            </switch>
            <if condition="IS_EQUAL_STRING(USERID1,'')">
                <set name="USERID1"      value=" and cust_login = ' '" />
            </if>
            <if condition="IS_EQUAL_STRING(USERID2,'')">
                <set name="USERID2"      value=" and cust_login = ' '" />
            </if>
            <if condition="IS_EQUAL_STRING(USERID3,'')">
                <set name="USERID3"      value=" and cust_login = ' '" />
            </if>
            <if condition="IS_EQUAL_STRING(USERID4,'')">
                <set name="USERID4"      value=" and cust_login = ' '" />
            </if>
            <if condition="IS_EQUAL_STRING(USERID5,'')">
                <set name="USERID5"      value=" and cust_login = ' '" />
            </if>
            <if condition="IS_EQUAL_STRING(USERID6,'')">
                <set name="USERID6"      value=" and cust_login = ' '" />
            </if>
            
            <!-- 客户端传过来的PageNum从0开始 gyl 20131217 注释-->
            <!--set name="PageNum"         expr="ADD(PageNum,1)"/-->
            
            <do func="PagedQuery"       error="ignore">
                <para name="PageNum"      expr="PageNum"/>
                <para name="NumPerPag"    expr="G_NumPerPag"/>
                <para name="Sql"          sql="queryAllInf"/>
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp"          value="E"/>
                <set name="RspCod"          value="09999"/>
                <set name="RspMsg"          value="无交易记录"/>
                <set name="TOLCNT"          value="0"/>
                <set name="ALLPAGENUM"      value="0"/>
                <set name="RECNUM"          value="0"/>
                <set name="PAGENUM"         value="0"/>
                <return/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="009999"/>
                <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
                <return/>
            </elseif>
            
            <set name="ALLPAGENUM"      expr="DIV(TOLCNT,G_NumPerPag)"/>
            <set name="mob"             expr="MOD(TOLCNT,G_NumPerPag)"/>
            <if condition="IS_NOEQUAL_STRING(MOB,'0')">
                <set name="ALLPAGENUM"     expr="ADD(ALLPAGENUM,1)"/>
            </if>
            <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
                <!--set name="returnNames"     value="ALLPAGENUM"     desc="如果传入的页面大于实际页面，此次查询无效"/-->
            </if>
            <set name="MsgTyp"        value="N"/>
            <set name="RspCod"        value="000000"/>
            <set name="RspMsg"        value="交易成功"/>
        </process>
    </transaction>
    
    <transaction code="800018" desc="用户转出明细查询">
        <sql name="queryZCInf"> <!--  查询用户转出交易记录  -->
           select '转账-付款' as prdName,
                  To_Char(to_date(p.traTime, 'yyyymmddhh24miss'),
                          'yyyy-mm-dd hh24:mi:ss') as orderDate,
                  '付款' as TransortName,
                  ordstatus as ordstatus,
                  TO_CHAR(to_number(p.TXAMT) / 100, 'FM9999999999990.00') as ORDAMT,
                  decode(trim(p.ordstatus), '00', '等待付款', '01', '交易成功') as ordstatusName,
                  p.TRACUSNAM as ACCAMTFROM,
                  s2.cust_login as ACCAMTFROMNAME,
                  p.GETCUSNAM as ACCAMTTO,
                  s.cust_login as ACCAMTTONAME,
                  p.BATNO as batno
             from vw_StpTraInf p
             left join STPUSRINF s
               on (p.GETCUSID = s.cust_id)
             left join STPUSRINF s2
               on (p.TRACUSID = s2.cust_id)
           where 1=1 ${prdOrdNo1}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value=""/>
            <quote name="ParseRequestParams"/>
            
            <set name="Condition"      value=""/>
            <set name="Fh"             value="'"/>
            <if condition="NOT(ISNULL(prdOrdNo))">
                <set name="prdOrdNo1"      expr="STRCAT(' and TRAORDNO  like ',Fh,'%',prdOrdNo,'%',Fh)"/>
            </if>
            <else>
                <set name="RspCod"    value="00000"/>
                <set name="RspMsg"    value="订单号不能为空"/>
                <return/>
            </else>
            <if condition="NOT(ISNULL(prdOrdNo))">
                <set name="USERID1"      expr="STRCAT(' and a.cust_login = \'',USRMP,'\'')" />
            </if>
            <else>
                <set name="RspCod"    value="00000"/>
                <set name="RspMsg"    value="用户id不能为空"/>
                <return/>
            </else>
            
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="queryZCInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp"        value="N"/>
                <set name="RspCod"    value="00000"/>
                <set name="RspMsg"    value="未查到指定订单"/>
            </if>
            <elseif condition="#RetCod==0">
                <set name="MsgTyp"        value="N"/>
                <set name="RspCod"        value="000000"/>
                <set name="RspMsg"        value="查询成功"/>
                <return/>
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp"   value="E"/>
                <set name="RspCod"    value="00002"/>
                <set name="RspMsg"    value="查询数据库失败"/>
                <return/>
            </elseif>
        </process>
    </transaction>

    <transaction code="800019" desc="订单支付(虚拟/快捷)">
        <sql name="QryCusInf"><!-- 查询客户信息-->
            SELECT cus.CUST_STATUS,cus.CUST_ID as USERID,usr.USR_STATUS as USRSTATUS,usr.usr_mobile FROM STPUSRINF usr,STPCUSINF cus WHERE usr.CUST_ID = cus.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="SelAccInf"><!-- 查询客户账户信息:状态和余额-->
            select a.PAY_AC_NO as PAY_AC_NO,a.CASH_AC_BAL,a.AC_STATUS from ARP_AC_PROFILE a,STPUSRINF b where b.CUST_ID=#{USERID} and (b.CUST_ID =substr(a.PAY_AC_NO,0,14))
        </sql>
        <sql name="SelPrdInf"><!-- 查询要支付的订单信息-->
            select * from stpprdinf where PrdOrdNo=#{ORDERNUM}
        </sql>
        <sql name="QryPassInf"><!-- 查询客户支付密码信息-->
            SELECT PASSWORD,CUST_ID FROM ARP_AC_CUST_REL WHERE PAY_AC_NO=#{PAYNO}
        </sql>
        <sql name="UpdPrd"> <!-- 更新商品订单表 -->
            PrdOrdNo = #{ORDERNUM}
        </sql>
        <sql name="UpdPay"> <!-- 更新商品订单表 -->
            payOrdNo = #{payOrdNo}
        </sql>
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>   
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random,TimeOut
            FROM STPVERIFY 
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
        <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
            SELECT 
            EXTRACT(MINUTE FROM (sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND ) as timeDifference,
            CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
            FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
            INSERT INTO STPLOGTMP
            (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
            VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
        </sql>
        <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
            LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
            WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="USERPAYPWD:G_RANDOM"/>
            <quote name="ParseRequestParams"/>

            <!-- 客户端传入支付方式转换 虚拟：01至00 快捷02至03-->
            <if condition="IS_EQUAL_STRING(PAYTYPE,'01')">
                <set name="PAYTYPE"    value="00"/>
                <set name="defPayWay"  value="0"/>
            </if>
            <if condition="IS_EQUAL_STRING(PAYTYPE,'02')">
                <set name="PAYTYPE"    value="03"/>
                <set name="defPayWay"  value="3"/>
            </if>
            <if condition="IS_EQUAL_STRING(PAYTYPE,'04')">
                <set name="PAYTYPE"    value="04"/>
                <set name="defPayWay"  value="4"/>
                <set name="MulType"  expr="MulType"/>
                <set name="accAmt"   expr="AMTPOWER(accAmt,2)"/>
                <set name="mulAmt"   expr="AMTPOWER(mulAmt,2)"/>
            </if>

            <quote name="usrChk"/>
            <if condition="ISNUMBER(UsrMp)">
                <set name="RANDUSRMP"  expr="UsrMp"/>
            </if>
            <esle>
                <set name="RANDUSRMP"  expr="usr_mobile"/>
            </esle>
            <!--校验手机验证码-->
            <!--quote name="chkRandom"/-->
            
            <quote name="chkAcc"/>
            <quote name="getPublicInfo"/>
            <!-- 查询订单 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="SelPrdInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"        value="002008"        />
                <set name="RspMsg"        value="订单不存在"/>
                <return/>
            </if>
            <if condition="#RetCod==-1">
                <set name="RspCod"        value="002008"        />
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </if>
            <!--验证订单状态-->
            <if condition="IS_NOEQUAL_STRING(ORDSTATUS,'00')">
                <set name="RspCod"    value="20019"/>
                <set name="RspMsg"    value="当前订单状态不可支付！"/>
                <return/>
            </if>  
            <!--验证可用金额是否大于订单金额-->
            <if condition="IS_EQUAL_STRING(PAYTYPE,'00')"><!--虚拟账户支付-->
              <if condition="DOUBLECMP(ORDAMT,6,AMTPOWER(CASH_AC_BAL,2))">
                <set name="RspCod"    value="20014"/>
                <set name="RspMsg"    value="订单金额大于账户余额！"/>
                <return/>
              </if>
            </if>  
            
            <!-- 用户支付密码锁定次数判断 -->
             <set name="USER_ID" expr="DELBOTHSPACE(USRMP)" />
             <set name="CUSTTYPE"  value="0"/><!--0用户1 商户 2企业-->
             <set name="PWDTYPE"   value="1"/><!--0:登录密码 1:支付密码-->
             <set name="FailFlag"  value="0"/>
             <quote name="usrpwdlock"/>
             <!-- 用户支付密码锁定次数判断 -->
             
            <!--校验支付密码-->
            <set name="PAYNO"      expr="PAY_AC_NO"/>
            <set name="paypwd"     expr="USERPAYPWD"/>
            <quote name="chklockPayPwd"/>
            
            <!--限额检查  start --> 
            <set name="txAmt"         expr="AMTPOWER(OrderAmt,2)"/>    <!--交易金额-->
            <set name="Amt"           expr="txAmt"/>
            <set name="User_code"     expr="userID"/>
            <set name="comp_code"     expr="merNo"/>
            <set name="cust_type"     value="0"/>  
            <set name="Time"          expr="GETDATETIME()"/>
            <set name="DATE"          expr="GETDATE()"/>
            <set name="TRAN_TYPE"      value="2"/>
            <set name="ServiceCode"   value="680518"/>  
            <quote name="chkLimAmt"/>
            <!--限额检查   end--> 
            
            <!--建立支付订单 start -->
            <do func="GetSeqNo"  error="IGNORE">
                <para name="TblNam" value="stpseqrec"/>
                <para name="KeyNam" value="KeyNam"/>
                <para name="KeyVal" expr="STRCAT('StpPayInf','PayOrdNo',GETDATE())"/>
                <para name="SeqNam" value="KeyVal"/>
                <para name="Len"    value="8"/>
                <para name="Circle" value="1"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09001"/>
                <set name="RspMsg"    value="获取序号错误"/>
                <return/>
            </if>
            <set name="payOrdNo"    expr="STRCAT('P',SUBSTR(ActDat,2,7),KeyVal)"></set>
            
            <set name="payType"     expr="payType"/>
            <set name="txCcy"       value="CNY"/>
            <set name="SignMsg"     expr="signature"/>                    <!--签名信息-->
            <set name="ActDat"      expr="GETDATETIME()"/>                <!--支付时间-->
            <set name="OrdStatus"   value="00"/>                          <!--未支付-->
            <set name="cust_id"     expr="userID"/>
            <set name="BANKCOD"     expr="BANKCODE"/>  
            <set name="isProxy"     value="0"/>  
            <set name="accamt"      expr="accamt"/>  
            <set name="mulamt"      expr="mulamt"/>  
            
                 
            <do func="InsertRecord" error="IGNORE">
                <para name="TblNam"  value="StpPayInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                <return/>
            </if> 
            <!--建立支付订单 end --> 
            
            <!--记账所需数据-->
            <set name="ACC_TYP"    value="01"/>               <!--现金账户-->
            <set name="MER_ACC_TYP"    value="02"/>           <!-- 商户结算账户 -->
            <set name="DR_CR_FLAG" value="+"/>                <!--账户余额增减标识 + 增加 - 减少-->
            <set name="CCY"        value="CNY"/>              <!--货币类型-->
            <set name="AMT"        expr="TXAMT"/>             <!--金额-->
            <set name="IS_ACT"     value="Y"/>                <!--是否实时记账 Y 是 N 否-->
            <if condition="IS_EQUAL_STRING(PAYTYPE,'04')"><!--虚拟账户支付-->
                <set name="usrPar"     expr="STRCAT(CUST_ID,'/',ACC_TYP,'/','-','/',CCY,'/',accamt,'/',IS_ACT,'/')"/>  <!--用户记账参数-->
            </if>
            <else>
                <set name="usrPar"     expr="STRCAT(CUST_ID,'/',ACC_TYP,'/','-','/',CCY,'/',AMT,'/',IS_ACT,'/')"/>  <!--用户记账参数-->
            </else>
            <!--支付方式-->
            <if condition="IS_EQUAL_STRING(PAYTYPE,'00')"><!--虚拟账户支付-->
                <set name="payacno"     expr="PAY_AC_NO"/><!--支付账号--> 
                <if condition="IS_EQUAL_STRING(prdOrdType,'0')">     <!--一般消费-->
                   <set name="flag"          value="0"/>             <!--暂不收取手续费-->
                   <if condition="IS_EQUAL_STRING(flag,'1')">        <!--收取手续费标识  1 收取  0 不收取-->
                      <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                      <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                      <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar,',',feePar)"/>
                   </if>
                   <else>
                      <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',AMT,'/',IS_ACT,'/')"/>         <!--商户记账参数-->
                      <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar)"/>
                   </else> 
                </if>
                <elseif condition="IS_EQUAL_STRING(prdOrdType,'2')">    <!--担保消费-->
                   <set name="netRecAmt"          expr="ordAmt"/>       <!--订单金额-->
                   <set name="flag"               value="0"/>           <!--担保支付预付款不扣手续费 确认付款再扣取-->
                   <set name="netRecAmt"          expr="txAmt"/>
                
                   <set name="pltMidPar"  expr="STRCAT('99999900000001','/','04','/','+','/',CCY,'/',AMT,'/','N','/')"/>        <!--平台担保账户记账参数-->
                   <set name="PARAMS"     expr="STRCAT(usrPar,',',pltMidPar)"/>  
                </elseif>
                <!--记账处理-->
                <set name="TXN_TYP"      value="2"/>                                    <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->     
                <quote name="accProcess"/>
                <if condition="#RetCod!=0">
                    <set name="MsgTyp"    value="E"/>
                    <set name="RspCod"    value="08060"/>
                    <set name="RspMsg"    value="支付失败"/>
                    <set name="ClearDat"     expr="GETDATE()"/>    <!--清算日期-->
                    <quote name="UpdPay"/>
                    <set name="acDate"       expr="GETDATE()"/>    <!--清算日期-->  
                    <set name="acTime"       expr="GETDATETIME('HHMISS')"/>  <!--清算时间-->
                    <quote name="UpdPrd"/>
                    <return/>
                </if>
                 
                <set name="acDate"    expr="GETDATE()"/>
                <set name="acTime"    expr="GETDATETIME('HHMISS')"/>
                <set name="ClearDat"  expr="GETDATE()"/>
                <!--更新订单状态-->
                <set name="ORDNO"       expr="traOrdNo" />
                <if condition="IS_EQUAL_STRING(prdOrdType,'0')">  <!--一般消费-->
                  <set name="ORDSTATUS"   value="01"      />
                </if>
                <if condition="IS_EQUAL_STRING(prdOrdType,'2')">  <!--担保消费-->
                  <set name="ORDSTATUS"   value="12"      />
                </if>    
                <quote name="UpdPay"/>
                
                <set name="custPayAcNo"  expr="payacno"     desc="支付帐号"/>
                <!--更新商品订单信息-->
                <quote name="UpdPrd"/>
            </if>
            <elseif condition="IS_EQUAL_STRING(PAYTYPE,'03')"><!--快捷支付-->
                <!--begain 快捷支付送银行  测试-支付成功 -->
                <set name="PayRet"       value="00"/>
                <!--end    快捷支付送银行  测试-支付成功 -->
                <if condition="IS_NOEQUAL_STRING(PayRet,'00')">
                    <!--<quote name="UpdPay"/>
                    <quote name="UpdReg"/>    -->           <!--  更新充值订单  -->
                    <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/> 
                    <set name="acDate"  expr="GETDATE()"/>              <!--清算日期-->
                    <set name="acTime"  expr="GETDATETIME('HHMISS')"/>  <!--清算时间-->  
                    <return/>
                </if>
                
                <!-- 查询银行号缩写 -->
                <set name="bankCard"    expr="BANKNO"/>
                <do func="GetCrdInfo" error="IGNORE">
                    <para name="CrdNo"  expr="bankCard" />
                </do>
                <if condition="#RetCod!=0">
                    <set name="bankcode"  value=""/>
                </if>
                <set name="BANKCODE"      expr="ISSNO" />
                <set name="BANKCOD"  expr="BANKCODE"/>
                
                <set name="ORDSTATUS"      value="01"/>
                <set name="payacno"        expr="PAY_AC_NO"/> 
                
                <set name="Tran_type"   value="1"/>     <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合-->
                <set name="fee"         value="0"/>
                <set name="netRecAmt"   expr="SUB(ORDAMT,fee)"/>                  <!--净额-->  
                
                <if condition="IS_EQUAL_STRING(prdOrdType,'0')">     <!--一般消费-->
                   <set name="flag"          value="0"/>             <!--暂不收取手续费-->
                   <if condition="IS_EQUAL_STRING(flag,'1')">        <!--收取手续费标识  1 收取  0 不收取-->
                      <set name="merPar"     expr="STRCAT(MERNO,'/',ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                      <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                      <set name="PARAMS"     expr="STRCAT(merPar,',',feePar)"/>
                   </if>
                   <else>
                      <set name="merPar"     expr="STRCAT(MERNO,'/',ACC_TYP,'/','+','/',CCY,'/',AMT,'/',IS_ACT,'/')"/>         <!--商户记账参数-->
                      <set name="PARAMS"     expr="merPar"/>
                   </else> 
                </if>
                <elseif condition="IS_EQUAL_STRING(prdOrdType,'2')">    <!--担保消费-->
                   <set name="netRecAmt"          expr="ordAmt"/>       <!--订单金额-->
                   <set name="flag"               value="0"/>           <!--担保支付预付款不扣手续费 确认付款再扣取-->
                   <set name="netRecAmt"          expr="txAmt"/>
                
                   <set name="pltMidPar"  expr="STRCAT('99999900000001','/','04','/','+','/',CCY,'/',AMT,'/','N','/')"/>        <!--平台担保账户记账参数-->
                   <set name="PARAMS"     expr="pltMidPar"/>  
                </elseif>
                
                <!--记账处理-->
                <set name="TXN_TYP"      value="2"/>                                    <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->     
                <quote name="accProcess"/>
                <if condition="#RetCod!=0">
                    <set name="RspCod"    value="07005"/>
                    <set name="RspMsg"    value="支付失败"/>
                    <return/>
                </if>
                
                <set name="TRANTYPE"       value="2"/>                  <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
                <set name="TRANWAY"        value="01"/>                 <!--交易方式 01网银、02终端、03消费卡、04虚拟账户、05快捷支付--> 
                <set name="TXCCY"          value="CNY"/>
                
                <set name="acDate"    expr="GETDATE()"/>
                <set name="acTime"    expr="GETDATETIME('HHMISS')"/>
                <set name="ClearDat"  expr="GETDATE()"/>
                <!--更新订单状态-->
                <set name="ORDNO"    expr="traOrdNo"/>
                <if condition="IS_EQUAL_STRING(prdOrdType,'0')">  <!--一般消费-->
                  <set name="ORDSTATUS"   value="01"      />
                </if>
                <if condition="IS_EQUAL_STRING(prdOrdType,'2')">  <!--担保消费-->
                  <set name="ORDSTATUS"   value="12"      />
                </if>
                <quote name="UpdPay"/>
                
                <set name="custPayAcNo"  expr="payacno"     desc="支付帐号"/>
                <!--更新商品订单信息-->
                <quote name="UpdPrd"/>
                
                <set name="NXTPAG"         expr="succePage"/>     
                <set name="merRemark"      value="财运通"/> <!-- 商户信息 -->
                <set name="_REQUESTATTR.FORWARDURL"       expr="NXTPAG"/>    <!--异步通知页面-->
                
                <!--登记银行收款结算表-->
                <do func="GetSeqNo"  error="IGNORE">
                    <para name="TblNam" value="stpseqrec"/>
                    <para name="KeyNam" value="KeyNam"/>
                    <para name="KeyVal" expr="STRCAT('ARP_BANK_REC_STL','SEQ_NO')"/>
                    <para name="SeqNam" value="KeyVal"/>
                    <para name="Len"    value="6"/>
                    <para name="Circle" value="1"/>
                </do>
                <if condition="#RetCod!=0">
                    <set name="MsgTyp"    value="E"/>
                    <set name="RspCod"    value="09001"/>
                    <set name="RspMsg"    value="获取序号错误"/>
                    <return/>
                </if>
                <set name="SEQ_NO"           expr="STRCAT(SUBSTR(ActDat,1,4),KeyVal)"/>  
                <set name="BANK_CODE"        expr="bankcode"/>  
                <set name="BANK_AC_DATE"     expr="bankStlDate"/>  
                <set name="BANK_JRN_NO"      expr="bankJrnNo"/>  
                <set name="TX_CCY"           value="CNY"/>  
                <set name="TX_AMT"           expr="txAmt"/>  
                <set name="FEE"              expr="fee"/>      <!--计算手续费  ？？-->
                <set name="NET_REC_AMT"      expr="netRecAmt"/> 
                <set name="MER_NO"           expr="merNo"/> 
                <set name="PRD_ORD_NO"       expr="prdOrdNo"/> 
                <set name="PAY_CHANNEL"      expr="payType"/>  
                <set name="PAY_ORD_NO"       expr="payOrdNo"/> 
                <set name="PAY_ORD_DATE"     expr="GETDATE()"/> 
                <set name="PAY_BIZ_TYPE"     value="01"/>     <!--01 支付   02 充值-->
                <set name="REC_STL_STATUS"   value="0"/>      <!--0 正常记账   1 补记账-->
                <do func="InsertRecord" error="IGNORE">
                    <para name="TblNam"  value="ARP_BANK_REC_STL" />
                </do>
                <if condition="#RetCod!=0">
                    <set name="MsgTyp"    value="E"/>
                    <set name="RspCod"    value="09999"/>
                    <set name="RspMsg"    value="数据库操作错误"/>
                    <set name="DWZ_STATUS_CODE"   value="300"/>
                    <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
                    <return/>
                </if>
                
                <set name="TXAMT"     expr="AMTADDDOT(TXAMT)"/>
                <set name="ACTDAT"    expr="FMTDATE(ActDat,0,4)"/>
                <set name="FLOR_TIME" expr="GETDATETIME()"/>
                <set name="OF_TITL"   expr="支付"/>
                <set name="OF_CONT"   expr="快捷订单支付"/>
            </elseif>
            <elseif condition="IS_EQUAL_STRING(PAYTYPE,'04')"><!--混合支付-->
                <!--模拟 快捷支付送银行  测试-支付成功 -->
                <set name="PayRet"       value="00"/>
                <if condition="IS_NOEQUAL_STRING(PayRet,'00')">
                    <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/> 
                    <set name="acDate"  expr="GETDATE()"/>              <!--清算日期-->
                    <set name="acTime"  expr="GETDATETIME('HHMISS')"/>  <!--清算时间-->  
                    <return/>
                </if>
                <!-- 查询银行号缩写 -->
                <set name="bankCard"    expr="BANKNO"/>
                <do func="GetCrdInfo" error="IGNORE">
                    <para name="CrdNo"  expr="bankCard" />
                </do>
                <if condition="#RetCod!=0">
                    <set name="bankcode"  value=""/>
                </if>
                <set name="BANKCODE"      expr="ISSNO" />
                <set name="BANKCOD"  expr="BANKCODE"/>
                
                <set name="ORDSTATUS"      value="01"/>
                <set name="payacno"        expr="PAY_AC_NO"/> 
                
                <set name="Tran_type"   value="1"/>     <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合-->
                <set name="fee"         value="0"/>
                <set name="netRecAmt"   expr="SUB(ORDAMT,fee)"/>                  <!--净额-->  
                
                <if condition="IS_EQUAL_STRING(prdOrdType,'0')">     <!--一般消费-->
                   <set name="flag"          value="0"/>             <!--暂不收取手续费-->
                   <if condition="IS_EQUAL_STRING(flag,'1')">        <!--收取手续费标识  1 收取  0 不收取-->
                      <set name="merPar"     expr="STRCAT(MERNO,'/',ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                      <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                      <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar,',',feePar)"/>
                   </if>
                   <else>
                      <set name="merPar"     expr="STRCAT(MERNO,'/',ACC_TYP,'/','+','/',CCY,'/',AMT,'/',IS_ACT,'/')"/>         <!--商户记账参数-->
                      <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar)"/>
                   </else> 
                </if>
                <elseif condition="IS_EQUAL_STRING(prdOrdType,'2')">    <!--担保消费-->
                   <set name="netRecAmt"          expr="ordAmt"/>       <!--订单金额-->
                   <set name="flag"               value="0"/>           <!--担保支付预付款不扣手续费 确认付款再扣取-->
                   <set name="netRecAmt"          expr="txAmt"/>
                
                   <set name="pltMidPar"  expr="STRCAT('99999900000001','/','04','/','+','/',CCY,'/',AMT,'/','N','/')"/>        <!--平台担保账户记账参数-->
                   <set name="PARAMS"     expr="STRCAT(usrPar,',',pltMidPar)"/>  
                </elseif>
                
                <!--记账处理-->
                <set name="TXN_TYP"      value="2"/>                                    <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->     
                <quote name="accProcess"/>
                <if condition="#RetCod!=0">
                    <set name="RspCod"    value="07005"/>
                    <set name="RspMsg"    value="支付失败"/>
                    <return/>
                </if>
                
                <set name="TRANTYPE"       value="2"/>                  <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
                <set name="TRANWAY"        value="05"/>                 <!--交易方式 01网银、02终端、03消费卡、04虚拟账户、05快捷支付--> 
                <set name="TXCCY"          value="CNY"/>
                
                <set name="acDate"    expr="GETDATE()"/>
                <set name="acTime"    expr="GETDATETIME('HHMISS')"/>
                <set name="ClearDat"  expr="GETDATE()"/>
                <!--更新订单状态-->
                <set name="ORDNO"    expr="traOrdNo"/>
                <if condition="IS_EQUAL_STRING(prdOrdType,'0')">  <!--一般消费-->
                  <set name="ORDSTATUS"   value="01"      />
                </if>
                <if condition="IS_EQUAL_STRING(prdOrdType,'2')">  <!--担保消费-->
                  <set name="ORDSTATUS"   value="12"      />
                </if>
                <quote name="UpdPay"/>
                
                <set name="custPayAcNo"  expr="payacno"     desc="支付帐号"/>
                <!--更新商品订单信息-->
                <quote name="UpdPrd"/>
            </elseif>
            <else>
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="06012"/>
                <set name="RspMsg"    value="无此支付方式"/>
            <return/>
            </else>
            
            <!-- 修改登记失败信息表 -->
            <do func="ExecSql" error="IGNORE">
               <para name="SqlCmd" sql="UpdUsrLogInfo"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="RSPCOD" value="02040"/>
               <set name="RSPMSG" value="更新登录信息失败!"/> 
               <return/>
            </if>
            
            <set name="RspCod"    value="000000"/>
            <set name="RspMsg"    value="支付成功"/>
            
            <!-- 将信息返回客户端 下面操作继续执行 -->
            <do func="CommitWork"/>
            <do func="putresponse"/>
            
            <!--增加通知物业系统逻辑判断 20150919-->
            <!--增加宏文件，处理物业缴费成功，通知第三方-->
            <if condition="IS_EQUAL_STRING(MERNO,'00000000000004')">       <!--  生产商户号为固定商户号 需要配置  -->
               <!-- 通过接口调用STP下交易，完成下单交易 --> 
               <set name="sthCode"    value="594106"/>
               
               <do func="CallThirdOther"     error="IGNORE">
                   <para name="channel"         value="STHDSTPU" />
                   <para name="code"            expr="sthCode"/>
               </do>
               <if condition="#RetCod!=0">
               <!-- 回滚数据库 -->
               <do func="RollBackWork"/>
                   <set name="RspCod"         value="009997"/>
                   <set name="RspMsg"         value="通讯错误"/>
                   <return/>
               </if>
            </if>            
            
            <!--通知风控系统登记订单信息-->
            <set name="ServiceCode" value="680517"/>
            <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
            <set name="TCODE"       expr="ORDERNUM"/>           <!--平台流水号 支付订单号-->
            <set name="CTYPE"       value="1"/>                 <!--客户类型-->
            <set name="CLIENTCODE"  expr="USERID"/>             <!--客户编号-->
            <set name="CLIENTNAME"  expr="USRNAME"/>
            <set name="MOBILEPHONE" expr="USRMP"/>
            <set name="TAMT"        expr="ORDAMT"/>
            <set name="REGDTTIME"   expr="STRCAT(nowDate,nowTime)"/>
            <set name="Time"        expr="nowDate"/>
            <set name="TRANTYPE"    value="2"/>
            <!--支付方式-->
            <if condition="IS_EQUAL_STRING(PAYTYPE,'00')"><!--虚拟账户支付-->
                <set name="TRANWAY"    value="04"/>
            </if>
            <if condition="IS_EQUAL_STRING(PAYTYPE,'03')"><!--快捷支付-->
                <set name="TRANWAY"    value="05"/>
            </if>
            <quote name="noticRcs"/>
            
            <set name="RCS_USER_CODE"       expr="USERID"            />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
            <set name="RCS_PRD_NO"          expr="prdOrdNo"         />
            <set name="RCS_TCODE"           value=""                />
            <set name="RCS_STATUS"          value="1"               />
            
        </process>
    </transaction>
    
    <transaction code="800020" desc="担保订单延期">
        <sql name="QryCustId"> <!--  根据手机号查询CUST_ID  -->
            SELECT CUST_ID
            FROM STPUSRINF 
            WHERE  CUST_LOGIN=#{UsrMp}
        </sql> 
        <sql name="queryPayinf"><!--查询商品订单信息-->
            select PrdOrdNo,merNo,OrdStatus,ordAmt,CUST_ID from stpprdinf where PrdOrdNo=#{PrdOrdNo} and CUST_ID=#{CUST_ID}
        </sql>
        <sql name="updatePrdinf"><!--修改商品订单状态-->
            update stpprdinf set OrdStatus='13' where PrdOrdNo=#{PrdOrdNo}
        </sql>
        <process> 
            <set name="sPwds"    value="nUsrpwd:G_RANDOM"/>
            <quote name="ParseRequestParams"/>
            
            <!-- 根据手机号查询CUST_ID -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QryCustId" />
            </do>
            
            <if condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="02008"/>
                <set name="RspMsg"        value="用户信息不存在"/>
                
                <set name="RCS_USER_CODE"       expr="CUST_ID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="用户不存在"      />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="queryPayinf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="商户订单不存在"/>
                
                <set name="RCS_USER_CODE"       expr="CUST_ID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="订单不存在"      />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            <if condition="IS_EQUAL_STRING(OrdStatus,'12')"><!--判断订单状态是否是预付款-->
                <do func="ExecSql"  error="IGNORE"><!--更新订单状态为延迟付款审核中-->
                   <para name="SqlCmd"     sql="updatePrdinf"/>
                </do>
                <if condition="#RetCod==2">
                    <set name="RspCod"    value="01003"/>
                    <set name="RspMsg"    value="无符合条件记录"/>
                    
                    <set name="RCS_USER_CODE"       expr="CUST_ID"            />
                    <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                    <set name="RCS_PRD_NO"          value=""                />
                    <set name="RCS_TCODE"           value="无符合记录"      />
                    <set name="RCS_STATUS"          value="0"               />
                    <quote name="tranByRightTime"/>
                    <return/>
                </if>
                <elseif condition="#RetCod!=0">
                    <set name="RspCod"    value="06003"/>
                    <set name="RspMsg"    value="更新订单信息错误"/>
                    
                    <set name="RCS_USER_CODE"       expr="CUST_ID"            />
                    <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                    <set name="RCS_PRD_NO"          value=""                />
                    <set name="RCS_TCODE"           value="更新信息错误"    />
                    <set name="RCS_STATUS"          value="0"               />
                    <quote name="tranByRightTime"/>
                    <return/>
                </elseif>
                <set name="RspCod"    value="000000"/>
                <set name="RspMsg"    value="交易成功"/>
               
                <set name="RCS_USER_CODE"       expr="CUST_ID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value=""                />
                <set name="RCS_STATUS"          value="1"               />
                <quote name="tranByRightTime"/>
            </if>
            <else>
                <set name="RspCod"    value="01003"/>
                <set name="RspMsg"    value="无符合条件记录"/>
            </else>
        </process>
    </transaction>
    
    <transaction code="800021" desc="用户订单撤销(取消)">
        <!--查询转账订单信息-->
        <sql name="SelOrdInf"><!-- 查询订单信息-->
            SELECT ordstatus,CUST_ID as usrid FROM StpPrdInf WHERE prdOrdNo=#{prdOrdNo}
        </sql>
        <sql name="UpdPrdInf"> <!-- 更新商品订单表 -->
            UPDATE STPPRDINF SET ORDSTATUS=#{ORDSTATUS} WHERE prdOrdNo=#{prdOrdNo} 
        </sql>
        <process> 
            <set name="sPwds"    value="nUsrpwd:G_RANDOM"/>
            <quote name="ParseRequestParams"/>
         
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="SelOrdInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"    value="009999"/>
                <set name="RspMsg"    value="订单不存在"/>
                
                <set name="RCS_USER_CODE"       expr="usrid"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="订单不存在"      />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            <if condition="IS_NOEQUAL_STRING(ordstatus,'00')">
                <set name="RspCod"    value="007019"/>
                <set name="RspMsg"    value="订单状态不正确"/>
                
                <set name="RCS_USER_CODE"       expr="usrid"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="订单状态错误"    />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            
            <set name="ORDSTATUS" value="11"/>          <!--订单作废-->
        
            <!--更新订单状态-->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="UpdPrdInf"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"          value="007018"/>
                <set name="RspMsg"          value="更新订单失败"/>
                
                <set name="RCS_USER_CODE"       expr="usrid"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="更新订单失败"    />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
        
            <set name="RspCod"      value="000000"  />
            <set name="RspMsg"      value="交易成功"/>
            
            <set name="RCS_USER_CODE"       expr="usrid"            />
            <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
            <set name="RCS_PRD_NO"          value=""                />
            <set name="RCS_TCODE"           value=""                />
            <set name="RCS_STATUS"          value="1"               />
            <quote name="tranByRightTime"/>
        </process>
    </transaction>
    
    <transaction code="800022" desc="单笔退款">
        <sql name="QryUsrIdInf"> <!--  查询用户注册信息  -->
            SELECT u.USR_STATUS as AUTSTAT,c.CUST_NAME as U_NAME,p.password,p.PAY_AC_NO
            FROM STPUSRINF u,STPCUSINF c,arp_ac_cust_rel p
            WHERE u.CUST_ID=#{CUST_ID} and u.CUST_ID=c.CUST_ID and u.CUST_ID=p.CUST_ID
        </sql> 
        <sql name="QryCustId"> <!--  根据手机号查询CUST_ID  -->
            SELECT CUST_ID 
            FROM STPUSRINF 
            WHERE  CUST_LOGIN=#{UsrMp}
        </sql> 
        <sql name="QryOrdInf">
            select prd.OrdStatus,prd.payOrdNo,prd.retUrl,prd.NotifyUrl,prd.MerNo,prd.stlBatno,prd.acJrnNo,prd.acDate,
                prd.CUST_ID,prd.OrdAmt as rfAmt,0 as fee,prd.OrdAmt as netRecAmt,pay.bankcod as BankCode
            from StpPrdInf prd,Stppayinf pay
            where prd.prdordno = pay.prdordno
            and prd.prdOrdNo=#{prdOrdNo}
        </sql>
        <sql name="QryRefInf">
            select refOrdNo from StpRefInf where oriPrdOrdNo=#{prdOrdNo} and OrdStatus='02'
        </sql>
        <sql name="QryRefTotAmt">
            select SUM(rfAmt) totRefAmt from StpRefInf where oriPrdOrdNo=#{prdOrdNo} and OrdStatus='02'
        </sql>
        <sql name="QryCusInf"><!-- 查询客户信息-->
            SELECT CUST_STATUS FROM StpCusInf WHERE CUST_ID=#{CUST_ID}
        </sql>
        <sql name="SelAccInf"><!-- 查询客户账户信息-->
            SELECT a.AC_STATUS FROM ARP_AC_PROFILE a,ARP_AC_CUST_REL b WHERE b.CUST_ID=#{CUST_ID} AND a.PAY_AC_NO=b.PAY_AC_NO
        </sql>
        <sql name="UpdStatus">
            UPDATE StpPrdInf set OrdStatus='03' where prdOrdNo=#{prdOrdNo}
        </sql>
        <process>
            <set name="sPwds"    value=""/>
            <quote name="ParseRequestParams"/>
            
            <!-- 根据手机号查询CUST_ID -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QryCustId" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="02008"/>
                <set name="RspMsg"        value="用户信息不存在"/>
                
                <set name="RCS_USER_CODE"       expr="CUST_ID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="用户不存在"      />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            
            <!-- 检查用户注册信息是否存在 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QryUsrIdInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="02008"/>
                <set name="RspMsg"        value="用户信息不存在"/>
                
                <set name="RCS_USER_CODE"       expr="CUST_ID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="用户不存在"      />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            
            <if condition="IS_NOEQUAL_STRING(AUTSTAT,'2')">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="02008"/>
                <set name="RspMsg"        value="用户认证未通过"/>
                
                <set name="RCS_USER_CODE"       expr="CUST_ID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="认证未通过"      />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            
            <set name="userId"     expr="SESSIONS.USRID"/> 
            <quote name="usrChk"/>
            <quote name="chkAcc"/>
            
            <!--查询商品订单信息-->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryOrdInf"/>
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"    value="01003"/>
                <set name="RspMsg"    value="无符合条件记录"/>
                
                <set name="RCS_USER_CODE"       expr="CUST_ID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="无记录"          />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                
                <set name="RCS_USER_CODE"       expr="CUST_ID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="数据库错误"      />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </elseif>
            <if condition="IS_EQUAL_STRING(OrdStatus,'00')">
                <set name="RspCod"    value="06007"/>
                <set name="RspMsg"    value="订单未支付"/>
                
                <set name="RCS_USER_CODE"       expr="CUST_ID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="订单未支付"      />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            <elseif condition="OR(IS_EQUAL_STRING(OrdStatus,'09'),IS_EQUAL_STRING(OrdStatus,'11'))">
                <set name="RspCod"    value="06007"/>
                <set name="RspMsg"    value="订单已撤销或已作废"/>
                
                <set name="RCS_USER_CODE"       expr="CUST_ID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="订单已撤销"      />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </elseif>
            <elseif condition="IS_EQUAL_STRING(OrdStatus,'03')">
                <set name="RspCod"    value="06007"/>
                <set name="RspMsg"    value="该订单已申请退款，正在审核,无需重复提交"/>
                
                <set name="RCS_USER_CODE"       expr="CUST_ID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="订单重复提交"    />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </elseif>
            <elseif condition="AND(IS_NOEQUAL_STRING(OrdStatus,'05'),IS_NOEQUAL_STRING(OrdStatus,'06'),IS_NOEQUAL_STRING(OrdStatus,'01'))">
                <if condition="OR(IS_EQUAL_STRING(OrdStatus,'12'),IS_EQUAL_STRING(OrdStatus,'13'),IS_EQUAL_STRING(OrdStatus,'14'),IS_EQUAL_STRING(OrdStatus,'15'),IS_EQUAL_STRING(OrdStatus,'03'),IS_EQUAL_STRING(OrdStatus,'04'))">
                    
                </if>
                <else>
                    <set name="RspCod"    value="06007"/>
                    <set name="RspMsg"    value="订单暂不能退款"/>
                    
                    <set name="RCS_USER_CODE"       expr="CUST_ID"            />
                    <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                    <set name="RCS_PRD_NO"          value=""                />
                    <set name="RCS_TCODE"           value="单暂不能退款"    />
                    <set name="RCS_STATUS"          value="0"               />
                    <quote name="tranByRightTime"/>
                    <return/>
                </else>
            </elseif>
            
            <!--查询退款订单信息-->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryRefInf"/>
            </do>
            <if condition="#RetCod==0">
                <do func="ReadRecord" error="IGNORE">
                    <para name="SqlCmd" sql="QryRefTotAmt"/>
                </do>
                <if condition="#RetCod!=0">
                    <set name="MsgTyp"    value="E"/>
                    <set name="RspCod"    value="09999"/>
                    <set name="RspMsg"    value="数据库操作错误"/>
                    <return/> 
                </if>
                <!--退款金额检查-->
                <!--if condition="AND(IS_EQUAL_STRING(OrdStatus,'05'),INTCMP(ordamt,1,ADD(totRefAmt,rfAmt)))">
                    <set name="RspCod"    value="08008"/>
                    <set name="RspMsg"    value="退款金额超限"/>
                    <return/>   
                </if-->
            </if>
            
            <!-- 修改订单状态 -->
            <do func="ExecSql" error="error">
                <para name="SqlCmd"  sql="UpdStatus" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"    value="01003"/>
                <set name="RspMsg"    value="无符合条件记录"/>
                <return/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"    value="06003"/>
                <set name="RspMsg"    value="更新订单信息错误" />
                <return/>
            </elseif>
            
            <set name="MsgTyp"    value="N"/>
            <set name="RspCod"    value="000000"/>
            <set name="RspMsg"    value="交易成功"/>
            
            <set name="RCS_USER_CODE"       expr="CUST_ID"          />
            <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
            <set name="RCS_PRD_NO"          value=""                />
            <set name="RCS_TCODE"           value=""                />
            <set name="RCS_STATUS"          value="1"               />
            <quote name="tranByRightTime"/>
        </process>
    </transaction>
    
    <transaction code="800023" desc="银行卡绑定">
        <sql name="QryUsrIdInf"> <!--  查询用户注册信息  -->
            SELECT u.USR_STATUS as AUTSTAT,
                   c.CUST_NAME as U_NAME,
                   c.CUST_CRED_TYPE,
                   c.CUST_CRED_NO,
                   p.password,
                   p.PAY_AC_NO
            FROM STPUSRINF u,STPCUSINF c,arp_ac_cust_rel p
            WHERE u.CUST_ID=#{CUST_ID} and u.CUST_ID=c.CUST_ID and u.CUST_ID=p.CUST_ID
        </sql> 
        <sql name="QryCustId"> <!--  根据手机号查询CUST_ID  -->
            SELECT CUST_ID,usr_mobile
            FROM STPUSRINF 
            WHERE  CUST_LOGIN=#{UsrMp}
        </sql> 
        <sql name="QueryUsrInfoPwd">
            SELECT arp.PASSWORD CUST_PWD,arp.CUST_ID FROM ARP_AC_CUST_REL arp,STPUSRINF usr WHERE arp.CUST_ID = usr.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="QryUserBank"><!--  检测用户是否绑定了该卡  -->
            SELECT * 
            FROM STPBANKTB 
            WHERE  CARD_NO=ENCRYPT_DES(#{BANKCARDNO},'0123456789ABCDEF') and CUST_ID=#{CUST_ID}
        </sql>
        <sql name="InsUserBankInf"><!--  插入用户绑定银行卡  -->
            INSERT INTO STPBANKTB (BAK_SEQ,CUST_ID,USER_ID,CARD_BANK,BANK_NAM,CARD_NO,CARD_TYPE,CARD_NAME,BANK_RES_PHONE)  
            VALUES(#{BAK_SEQ},#{CUST_ID},#{IDCARD},#{BANKCODE},#{BANK_NAME},ENCRYPT_DES(#{BANKCARDNO},'0123456789ABCDEF'),#{BANKCARDTYPE},#{CARD_NAME},#{BANK_RES_PHONE})
        </sql>
        <!--  查询银行枚举  -->
        <sql name="qry_enm_dat">
            select enm_dat_des as BANKCARDTYPES from lyxdicenm where sys_id='0001' and trim(enm_en_nam) like 'bankCardType'  and trim(enm_dat_opt)=#{DCFLAG})
        </sql>
        <!--校验手机验证码需要-->
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>   
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random,TimeOut
            FROM STPVERIFY 
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
        <sql name="InsBankDFInf"><!--插入绑卡代付表-->
          INSERT INTO BANKDFINF(
              BANKDFNO,CUST_ID,ACTDATE,ACTTIME,ORDSTATUS,TXCCY,TXAMT,FEE,NETRECAMT,BANKCODE,BANKSTLDATE,BANKJRNNO,    
              BANKPAYACNO,BANKPAYUSERNM,BANKPAYUSEID,BANKERROR,NOTIFYURL,PAYRET,BNKDAT,BNKJNL)  
            VALUES(#{BAK_SEQ},#{PAY_AC_NO},#{CardDate},#{CardTime},'1','CNY',#{paidAmt},'','','01010000','','',
              '',#{BANKCARDNO},#{certifId},'','','','','')
        </sql>
        <sql name="UpdBankDFInf"><!--更新绑卡代付表-->
          UPDATE BANKDFINF SET ORDSTATUS=#{DFORDSTATUS},FEE=#{DFFEE},NETRECAMT = #{DFNETRECAMT},BANKSTLDATE=#{DFBANKSTLDATE},BANKJRNNO=#{DFBANKJRNNO},
             BANKERROR=#{DFBANKERROR},PAYRET=#{DFPAYRET},BNKDAT=#{DFBNKDAT},BNKTIM=#{DFBNKTIM},BNKJNL=#{DFBNKJNL}
          WHERE BANKDFNO = #{BAK_SEQ} 
        </sql>
        <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
            SELECT 
            EXTRACT(MINUTE FROM (sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND ) as timeDifference,
            CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
            FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
            INSERT INTO STPLOGTMP
            (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
            VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
        </sql>
        <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
            LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
            WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <process>
            <set name="sPwds"    value="PAYPWD:G_RANDOM"/>
            <quote name="ParseRequestParams"/>
            
            <!-- 根据手机号查询CUST_ID -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QryCustId" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="002008"/>
                <set name="RspMsg"        value="用户信息不存在"/>
                <return/>
            </if>
            <if condition="ISNUMBER(UsrMp)">
                <set name="RANDUSRMP"  expr="UsrMp"/>
            </if>
            <esle>
                <set name="RANDUSRMP"  expr="usr_mobile"/>
            </esle>
           
            <!-- 检查用户注册信息是否存在 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QryUsrIdInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="02008"/>
                <set name="RspMsg"        value="用户信息不存在"/>
                <return/>
            </if>
            
            <if condition="IS_NOEQUAL_STRING(AUTSTAT,'2')">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="02008"/>
                <set name="RspMsg"        value="用户认证未通过"/>
                <return/>
            </if>
            <!--卡bin查询-->
            <if condition="IS_EQUAL_STRING(BANKCARDNO,'')">
                <set name="RspCod"          value="01002"/>
                <set name="RspMsg"          value="银行卡号不能为空"/>
            </if>
            
            <!-- 查询银行号缩写 -->
            <set name="bankCard"    expr="BANKCARDNO"/>
            <do func="GetCrdInfo" error="IGNORE">
                <para name="CrdNo"  expr="bankCard" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="02008"/>
                <set name="RspMsg"        value="请输入正确的银行卡号"/>
                <return/> 
            </if>
            
            <if condition="IS_EQUAL_STRING(DCFLAG,'01')">
                <set name="DCFLAG" value="00" />
            </if>
            <elseif condition="IS_EQUAL_STRING(DCFLAG,'02')">
            	  <set name="DCFLAG" value="01" />
            </elseif>
            <else>
                <set name="CPSCod" value="99" />
                <set name="RspMsg" value="获取卡bin类型错误" />
                <return />
            </else>
            
            <set name="BANKCODE"      expr="ISSNO" />
            <set name="GETBANKCODE"    expr="BANKCODE"/>
            <set name="ISSBANKNAME"    expr="ISSNAM"/>
            <!-- <set name="BANKCARDTYPE"    expr="DCFLAG"/> -->
            <if condition="IS_EQUAL_STRING(DCFLAG,'02')">
            	<set name="BANKCARDTYPE" value="01"/>
            </if>
            <elseif condition="IS_EQUAL_STRING(DCFLAG,'00')">
            	<set name="BANKCARDTYPE" value="00"/>
            </elseif>
            <else>
            	<set name="BANKCARDTYPE"    expr="DCFLAG"/>
            </else>
            <if condition="IS_EQUAL_STRING(GETBANKCODE,'')">
                <set name="RspCod"       value="02035"      />
                <set name="RspMsg"       value="银行卡号不能识别" />
                <return/>
             </if>
            <do fuct="qry_enm_dat" error="IGNORE">
                  <para name="DCFLAG" expr="DCFLAG"/>     
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="002008"/>
                <set name="RspMsg"        value="信息不存在"/>
                <return/>
            </if>
            
            <!--  检查支付密码是否为空  --> 
            <if condition="IS_EQUAL_STRING(PAYPWD,'')">
                <set name="RspCod"        value="002059"/>
                <set name="RspMsg"        value="用户支付密码为空"/>
              <return/>
            </if>

            <!-- 用户支付密码锁定次数判断 -->
             <set name="USER_ID" expr="DELBOTHSPACE(USRMP)" />
             <set name="CUSTTYPE"  value="0"/><!--0用户1 商户 2企业-->
             <set name="PWDTYPE"   value="1"/><!--0:登录密码 1:支付密码-->
             <set name="FailFlag"  value="0"/>
             <quote name="usrpwdlock"/>
             <!-- 用户支付密码锁定次数判断 -->
             
            <!-- 查询用户原支付密码 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QueryUsrInfoPwd" />
            </do>
            <if condition="IS_NOEQUAL_STRING(CUST_PWD,PAYPWD)">
                <set name="RspCod"        value="002050"/>
                <set name="RspMsg"        value="支付密码错误"/>
                <quote name="UpLoginInfo"/>
                <return/>
            </if>
            <else>
            </else>
             <!--校验手机验证码-->
            <quote name="chkRandom"/>
            <!--  查询用户是否绑定过该卡  -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QryUserBank" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspMsg"        value="无记录,用户可以绑定银行卡"/>
            </if>
            <elseif condition="#RetCod==-1">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="09999"/>
                <set name="RspMsg"        value="系统错误"/>
                <return/>
            </elseif>
            <elseif condition="#RetCod==0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="02085"/>
                <set name="RspMsg"        value="绑定失败，此银行卡已被绑定"/>
                <return/>
            </elseif>
            <else>
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="09998"/>
                <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
                <return/>
            </else>

            <!-- 获取序号 -->
            <do func="GetSeqNo"         error="IGNORE">
              <para name="TblNam"       value="stpseqrec"/>
              <para name="KeyNam"       value="KeyNam"/>
              <para name="KeyVal"       value="bank_id"/>
              <para name="SeqNam"       value="KeyVal"/>
              <para name="Len"          value="5"/>
              <para name="Circle"       value="1"/>
            </do>
            <if condition="#RetCod!=0">
              <set name="MsgTyp"        value="E"/>
              <set name="RspCod"        value="09001"/>
              <set name="RspMsg"        value="获取序号错误"/>
              <return/>
            </if>
            
            <!--20150728由于建设银行代付问题，暂时注释绑卡代付操作 START-->
        
                <!--注意这其中是添加银行卡代付的-->
         
            <!--20150728由于建设银行代付问题，暂时注释绑卡代付操作 START-->
            
            
            <if condition="ISNULL(BANKCODE)">
                <set name="BANKCODE"        value="NOTHING"     desc="没有银行缩写 默认设置为NOTHING"/>
            </if>
            <set name="CardDate"        expr="GETDATETIME('YYYYMMDD')"/>
            <set name="CardTime"        expr="GETDATETIME('HHSSMI')"/>
            <set name="BANK_NAME"             expr="ISSNAM"     desc="银行名称"/>
            <set name="CARD_NAME"             expr="U_NAME"     desc="客户名称"/>
            <set name="BANK_RES_PHONE"        expr="RANDUSRMP"     desc="客户银行预留手机号"/>
            <set name="BAK_SEQ"         expr="STRCAT(CardDate,KeyVal)"></set>

            <set name="idcard"         expr="DES_DECRYPT(cust_cred_no)"/> 
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="InsUserBankInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"       value="E"/>
                <set name="RspCod"       value="09999"/>
                <set name="RspMsg"       value="系统错误,请稍后再试或联系客服"/>
                <return/>
            </if>
            
            <!-- 修改登记失败信息表 -->
            <do func="ExecSql" error="IGNORE">
               <para name="SqlCmd" sql="UpdUsrLogInfo"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="RSPCOD" value="02040"/>
               <set name="RSPMSG" value="更新登录信息失败!"/> 
               <return/>
            </if>
            
            <set name="MsgTyp"          value="N"/>
            <set name="RspCod"          value="000000"/>
            <set name="RspMsg"          value="交易成功"/>
            
            <set name="RCS_USER_CODE"       expr="CUST_ID"            />
            <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
            <set name="RCS_PRD_NO"          value=""                />
            <set name="RCS_TCODE"           value=""                />
            <set name="RCS_STATUS"          value="1"               />
            <quote name="tranByRightTime"/>
        </process>
    </transaction>
    
    <transaction code="800024" desc="移动端银行卡解绑">
        <sql name="QryCusInf"><!-- 查询客户信息-->
            SELECT rel.password,cus.CUST_STATUS,cus.CUST_ID as USERID,usr.USR_STATUS as USRSTATUS,rel.pay_ac_no as payacnos 
            FROM STPUSRINF usr,STPCUSINF cus,ARP_AC_CUST_REL rel 
            WHERE usr.CUST_ID = cus.CUST_ID and usr.CUST_ID =rel.cust_id AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="select_bind"> 
            SELECT bak_seq  FROM STPBANKTB where cust_id = #{cust_id} and CARD_NO = #{CARD_NO}
        </sql>
        <sql name="set_unbinding"> 
            delete STPBANKTB where cust_id = #{cust_id} and CARD_NO = #{CARD_NO}
        </sql>
        <process>
            <set name="sPwds"      value=""/>
            <set name="cust_id"    expr="cust_id"/>
            <quote name="ParseRequestParams"/>
            
            <quote name="usrChk"/>
            
            <!--记录用户系统主要交易实时日志 -->
            <set name="RCS_USER_CODE" expr="USERID" /><!--用户ID -->
            <set name="RCS_PAY_TYPE" value="银行卡解绑" /><!--本次交易码，最好用desc -->
            <set name="RCS_PRD_NO"   value="" /><!--订单号，如果不涉及置空 -->
            
            <!-- 检查支付密码是否冻结 add by gyl 20140212-->
            <set name="RCS_PWD_TYPE"        value="3"           />
            <set name="RCS_USER_CODE"       expr="RCS_USER_CODE"/>
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"     />
            <set name="RCS_PRD_NO"          value=""            />
            <set name="RCS_TCODE"           value="5"           />
            <set name="RCS_STATUS"          value="0"           />
            <quote name="tranPwdLock"/> 
            
            <set name="CARD_NO" expr="BANKCARDNO" />
            
            <!-- 检查必输字段是否为空 -->
            <if condition="ISNULL(CUST_ID)">
                <set name="RspCod" value="01004" />
                <set name="RspMsg" value="账户号为空" />
                <set name="DWZ_STATUS_CODE" value="300" />
                <set name="DWZ_RSP_MSG" expr="RspMsg" />
                <return />
            </if>
            <if condition="ISNULL(CARD_NO)">
                <set name="RspCod" value="01004" />
                <set name="RspMsg" value="卡号为空" />
                <set name="DWZ_STATUS_CODE" value="300" />
                <set name="DWZ_RSP_MSG" expr="RspMsg" />
                <return />
            </if>

            <!-- 查询卡的当前绑定状态 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="select_bind" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="该用户无此绑定信息，或已经解绑，刷新后操作。" />
                <return />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="数据库操作错误" />
                <return />
            </elseif>
            <else>
                
                <set name="NowDay" expr="GETDATETIME('YYYYMMDD')" />
                
                <!-- 取系统时间、当前操作员 -->
                <set name="ADD_DATE" expr="GETDATE()" />
                <set name="ADD_TIME" expr="GETDATETIME('HHMISS')" />
                <set name="ADD_ADM" expr="SESSIONS.UID" />
                <!-- 更新记录 -->
                <if condition="ISNULL(BAK_CLOSE_NUM)">
                    <set name="BAK_CLOSE_NUM" value="0" />
                </if>
                
                <set name="BAK_CLOSE_NUM1" expr="ADD(BAK_CLOSE_NUM,'1')" />
                <do func="ExecSql" error="IGNORE">
                    <para name="SqlCmd" sql="set_unbinding" />
                </do>
                <if condition="#RetCod==2">
                    <set name="RspCod" value="01004" />
                    <set name="RspMsg" value="无信息" />
                    <return />
                </if>
                <elseif condition="#RetCod!=0">
                    <set name="RspCod" value="09999" />
                    <set name="RspMsg" value="数据库操作错误" />
                    <return />
                </elseif>
            </else>
            
            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="000000" />
            <set name="RspMsg" value="解绑申请成功!" />
            <!--记录日志 -->
            <set name="RCS_TCODE" expr="RspMsg" />
            <set name="RCS_STATUS" value="1" />
            <quote name="tranByRightTime" />
        </process>
    </transaction>
    
    <transaction code="800025" desc="银行卡绑定浏览">
        <sql name="QryUsrInf"> <!--  查询用户注册信息  -->
            SELECT u.USR_STATUS as AUTSTAT,c.CUST_NAME as U_NAME,p.password,p.PAY_AC_NO
            FROM STPUSRINF u,STPCUSINF c,arp_ac_cust_rel p
            WHERE u.CUST_ID=#{CUST_ID} and u.CUST_ID=c.CUST_ID and u.CUST_ID=p.CUST_ID
        </sql> 
        <sql name="QryCust_ID">
            SELECT CUST_ID
            FROM STPUSRINF 
            WHERE  CUST_LOGIN=#{UsrMp}
        </sql>
        <!--绑定时卡种枚举值根据卡BIN信息表来的，所以这里不应该根据绑定记录的枚举值来查，郭彦磊 20140113修改为01和02 ，原为01和00-->
        <sql name="QryStpBankCd"> <!--  查询用户绑定的银行卡  --> 
            SELECT B.BAK_SEQ,B.CUST_ID, B.CARD_NO BANKCARDNO,
                SUBSTR(DECRYPT_DES(B.CARD_NO,'0123456789ABCDEF'),(LENGTH(DECRYPT_DES(B.CARD_NO,'0123456789ABCDEF'))-3),4) AS CANO,
                DECRYPT_DES(B.CARD_NO,'0123456789ABCDEF') carnotmp,
                CARD_NAME BANKNAME,
                '' AS CARD_DATE,
                '' AS CARD_TIME,
                '' AS CARD_STATUS,(case when b.CARD_TYPE='00' then '01' when  b.CARD_TYPE='01' then '02' else '00' end )as BANKCARDTYPE,
                A.ISSNO bankcode,A.ISSNO BANKLOGO,
				(case when B.BANK_CONF IS NULL OR B.BANK_CONF='0' then '0' when  B.BANK_CONF='1' then '1' end ) as OPEN_STATUS
            FROM STPBANKTB B,unionfit A
            WHERE B.CUST_ID = #{CUST_ID} AND (CARD_TYPE='00' OR CARD_TYPE='01') AND
            substr(DECRYPT_DES(B.CARD_NO,'0123456789ABCDEF'),0,A.BINLEN)=trim(A.BINCTT) AND A.CRDLEN in('14','15','16','17','18','19') 
        </sql>
        <process>
            <set name="sPwds"    value="nUsrpwd:G_RANDOM"/>
            <quote name="ParseRequestParams"/>

            <if condition="ISNULL(PageNum)">
                <set name="PageNum"         value="1"/>
            </if>
            <if condition="ISNULL(G_NumPerPag)">
                <set name="G_NumPerPag"     value="10"/>
            </if>
            
            <!--  根据cust_login查询cust_id  -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QryCust_ID" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="02008"/>
                <set name="RspMsg"        value="用户信息不存在"/>
                <return/>
            </if>
            
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QryUsrInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="02008"/>
                <set name="RspMsg"        value="用户信息不存在"/>
                <return/>
            </if>
            
            <if condition="IS_NOEQUAL_STRING(AUTSTAT,'2')">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="02008"/>
                <set name="RspMsg"        value="用户认证未通过"/>
                <return/>
            </if>
            
            <do func="QueryInGroup" error="IGNORE">
                <para name="SqlCmd"      sql="QryStpBankCd" />
                <para name="RecordName"  value="GRP" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="02008"/>
                <set name="RspMsg"        value="请先添加银行卡信息！"/>
                <return/>
            </if>
            <elseif condition="#RetCod==-1">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="09999"/>
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="09998"/>
                <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
                <return/>
            </elseif>
            
            <!--do func="updateAddCrdBinInf" error="IGNORE">
                <para name="nodeName"       value="GRP"     />
                <para name="bankCardName"   value="BANKCARDNO" />
                <para name="mapping"        value="CRDNAM:BANKNAME,BANKCODE:BANKCODE,BANKCODE:BANKLOGO,DCFLAG:BANKNOTYPE"/>
            </do-->
            
            <set name="MsgTyp"          value="N"/>
            <set name="RspCod"          value="000000"/>
            <set name="RspMsg"          value="交易成功"/>
        </process>
    </transaction>
    
    <transaction code="800026" desc="用户消费订单明细查询">
        <sql name="queryOrdInf"><!--  查询商品订单表  -->
            select P.prdName as prdName,p.PRDORDNO as prdOrdNo1,p.PRDORDNO as prdOrdNo,(select cust_name from stpcusinf m where p.merno=m.cust_id) as merName,
            To_Char(to_date(p.orderTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')  as orderDate 
            ,'' as transort,TransortName,   TO_CHAR(to_number(p.ORDAMT)/100,'FM9999999999990.00') as ORDAMT, 
            p.ordstatus as ordstatus,ordstatusName,decode(p.prdordtype,'1',4,2) as pageflags 
            from vw_StpPrdInf p, stpusrinf a
            where p.cust_id=a.cust_id and p.prdordtype in (0,2,3) ${USERID1}  ${prdOrdNo1} 
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value=""/>
            <quote name="ParseRequestParams"/>
            
            <set name="Condition"      value=""/>
            <set name="Fh"             value="'"/>
            <if condition="NOT(ISNULL(prdOrdNo))">
                <set name="prdOrdNo1"      expr="STRCAT(' and PRDORDNO  like ',Fh,'%',prdOrdNo,'%',Fh)"/>
            </if>
            <else>
                <set name="RspCod"    value="00000"/>
                <set name="RspMsg"    value="订单号不能为空"/>
                <return/>
            </else>
            <if condition="NOT(ISNULL(USRMP))">
                <set name="USERID1"      expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />
            </if>
            <else>
                <set name="RspCod"    value="00000"/>
                <set name="RspMsg"    value="用户id不能为空"/>
                <return/>
            </else>
            
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="queryOrdInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"    value="00000"/>
                <set name="RspMsg"    value="未查到指定订单"/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"    value="00000"/>
                <set name="RspMsg"    value="查询数据库失败"/>
                <return/>
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="09999"/>
                <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
                <return/>
            </elseif>
            <set name="MsgTyp"        value="N"/>
            <set name="RspCod"        value="000000"/>
            <set name="RspMsg"        value="交易成功"/>
        </process>
    </transaction>
    
    <transaction code="800027" desc="用户提现订单明细查询">
        <sql name="queryCasInf"><!--  查询提现订单表  -->
            select  p.casOrdNo as prdOrdNo1,p.casOrdNo as prdOrdNo,To_Char(to_date(p.actDat,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')  as orderDate    ,'' as Transort,'提现'     as TransortName,   TO_CHAR(to_number(p.txAmt)/100,'FM9999999999990.00')     as CASHAMT,    ordstatus,ordstatusName ,3 as pageflags 
            ,p.BANKPAYACNO as BANKNO,(select enm_dat_des  from lyxdicenm t where trim(t.enm_en_nam)='bankNam'  and trim(t.enm_dat_opt)=trim(p.bankcode)) as  BANKNAME,p.fee as FEEAMT
            ,'${sBankLogo}'||p.bankCode||'.PNG' as banklogo,
            nvl(substr(p.bankPayAcNo,-4),' ') as bankPayAcNo
            from vw_StpCasInf p, stpusrinf a
            where  p.cust_id=a.cust_id ${USERID1}   ${prdOrdNo1} 
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value=""/>
            <quote name="ParseRequestParams"/>
            
            <set name="Condition"      value=""/>
            <set name="Fh"             value="'"/>
            <if condition="NOT(ISNULL(prdOrdNo))">
                <set name="prdOrdNo1"      expr="STRCAT(' and casOrdNo  like ',Fh,'%',prdOrdNo,'%',Fh)"/>  
            </if>
            <else>
                <set name="RspCod"    value="00000"/>
                <set name="RspMsg"    value="订单号不能为空"/>
                <return/>
            </else>
            <if condition="NOT(ISNULL(USRMP))">
                <set name="USERID1"      expr="STRCAT(' and cust_login = \'',USRMP,'\'')" />
            </if>
            <else>
                <set name="RspCod"    value="00000"/>
                <set name="RspMsg"    value="用户id不能为空"/>
                <return/>
            </else>
            
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="queryCasInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"    value="00000"/>
                <set name="RspMsg"    value="未查到指定订单"/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"    value="00000"/>
                <set name="RspMsg"    value="查询数据库失败"/>
                <return/>
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="09999"/>
                <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
                <return/>
            </elseif>
            <set name="MsgTyp"        value="N"/>
            <set name="RspCod"        value="000000"/>
            <set name="RspMsg"        value="交易成功"/>
        </process>
    </transaction>

    <transaction code="800029" desc="用户充值订单明细查询">
        <sql name="queryOrdInf"><!--  查询商品订单表  -->
            select  nvl(pay.payordno,' ') as payordno,p.PRDORDNO as prdOrdNo1,p.PRDORDNO as prdOrdNo,nvl(substr(pay.bankPayAcNo,-4),' ') as bankPayAcNo,enu.enm_dat_des as BANKNAME ,'${sBankLogo}'||Pay.bankCod||'.PNG' as banklogo,
            To_Char(to_date(p.orderTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')  as orderDate 
            ,'' as transort,TransortName,   TO_CHAR(to_number(p.ORDAMT)/100,'FM9999999999990.00') as ORDAMT, 
            p.ordstatus as ordstatus,ordstatusName,decode(p.prdordtype,'1',4,2) as pageflags 
            from vw_StpPrdInf p left join stpusrinf a on p.cust_id=a.cust_id 
            left join stppayinf pay on P.PAYORDNO=pay.payordno
            left join lyxdicenm enu on pay.bankcod=enu.ENM_DAT_OPT 
            where p.prdordtype in (1)  ${USERID1}  ${prdOrdNo1} 
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value=""/>
            <quote name="ParseRequestParams"/>
            
            <!-- 读取图片配置相对路径 -->
            <set name="ConfigName"   value="G_BANK_INF"/>
            <quote name="ReadXmlCfg"/>
            <set name="sBankLogo" expr="G_BANKLOGO_PATH"  /><!--配置在config文件中的图片路径-->
            
            <set name="Condition"      value=""/>
            <set name="Fh"             value="'"/>
            <if condition="NOT(ISNULL(prdOrdNo))">
                <set name="prdOrdNo1"      expr="STRCAT(' and p.PRDORDNO  like ',Fh,'%',prdOrdNo,'%',Fh)"/> 
            </if>
            <else>
                <set name="RspCod"    value="00000"/>
                <set name="RspMsg"    value="订单号不能为空"/>
                <return/>
            </else>
            <if condition="NOT(ISNULL(USRMP))">
                <set name="USERID1"      expr="STRCAT(' and a.cust_login = \'',USRMP,'\'')" />
            </if>
            <else>
                <set name="RspCod"    value="00000"/>
                <set name="RspMsg"    value="用户id不能为空"/>
                <return/>
            </else>
            
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="queryOrdInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"    value="000003"/>
                <set name="RspMsg"    value="未查到指定订单"/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"    value="000004"/>
                <set name="RspMsg"    value="查询数据库失败"/>
                <return/>
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="09999"/>
                <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
                <return/>
            </elseif>
            <set name="MsgTyp"        value="N"/>
            <set name="RspCod"        value="000000"/>
            <set name="RspMsg"        value="交易成功"/>
        </process>
    </transaction>
    
    <transaction code="800030" desc="用户转入订单明细查询">
        <sql name="queryZRInf"> <!--  查询用户收款交易记录  -->
        select '转账-收款' as prdName,
               p.TRAORDNO as prdOrdNo1,
               p.TRAORDNO as prdOrdNo,
               To_Char(to_date(p.traTime, 'yyyymmddhh24miss'),
                       'yyyy-mm-dd hh24:mi:ss') as orderDate,
               '' as Transort,
               '收款' as TransortName,
               TO_CHAR(to_number(p.TXAMT) / 100, 'FM9999999999990.00') as ORDAMT,
               OrdStatus,
               decode(trim(ordstatus),
                      '00',
                      '等待付款',
                      '01', '交易成功') as ordstatusName,
               5 as pageflags,
               s.cust_login as ACCTONO,
               s2.cust_login as ACCFROMNO,
               p.TRACUSNAM as PAYNAME
          from vw_StpTraInf p
          left join STPUSRINF s
            on (p.GETCUSID = s.cust_id)
          left join STPUSRINF s2
            on (p.TRACUSID = s2.cust_id)
          where 1=1 ${prdOrdNo1}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value=""/>
            <quote name="ParseRequestParams"/>
            
            <set name="Condition"      value=""/>
            <set name="Fh"             value="'"/>
            <if condition="NOT(ISNULL(prdOrdNo))">
                <set name="prdOrdNo1"      expr="STRCAT(' and TRAORDNO  like ',Fh,'%',prdOrdNo,'%',Fh)"/> 
            </if>
            <else>
                <set name="RspCod"    value="00000"/>
                <set name="RspMsg"    value="订单号不能为空"/>
                <return/>
            </else>
            <if condition="NOT(ISNULL(USRMP))">
                <set name="USERID1"      expr="STRCAT(' and a2.cust_login = \'',USRMP,'\'')" />
            </if>
            <else>
                <set name="RspCod"    value="00000"/>
                <set name="RspMsg"    value="用户id不能为空"/>
                <return/>
            </else>
            
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="queryZRInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp"        value="N"/>
                <set name="RspCod"    value="00000"/>
                <set name="RspMsg"    value="未查到指定订单"/>
            </if>
            <elseif condition="#RetCod==0">
                <set name="MsgTyp"        value="N"/>
                <set name="RspCod"    value="000000"/>
                <set name="RspMsg"    value="查询成功"/>
                <return/>
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="09999"/>
                <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
                <return/>
            </elseif>
        </process>
    </transaction>
    
    <transaction code="800031" desc="邮箱用户绑定手机">
        <sql name="UpdUsrLoginName"> <!--  登记手机信息  -->
            UPDATE STPUSRINF
               SET USR_MOBILE=#{NEWUSRMP}
             WHERE CUST_ID=#{CUST_ID}
        </sql>
        <sql name="QueryUsrInfoPwd">
            SELECT arp.PASSWORD CUST_PWD,arp.CUST_ID FROM ARP_AC_CUST_REL arp,STPUSRINF usr WHERE arp.CUST_ID = usr.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{CHECK_USRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>   
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) CHECK_timdif,InsTim as CHECK_InsTim,Random as CHECK_RANDOM,TimeOut as CHECK_TIMEOUT 
            FROM STPVERIFY 
            WHERE VER_ID=#{CHECK_USRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
        <process>
            <set name="sPwds"    value="PAYPWD:G_RANDOM"/>
            <quote name="ParseRequestParams"/>
            <!--绑定的手机号-->
            <set name="NEWUSRMP" expr="BINDMOBILE"/>
            
            <!-- 查询用户支付密码 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QueryUsrInfoPwd" />
            </do>
            <if condition="#RetCod==-1">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="09999"/>
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </if>
            <elseif condition="#RetCod==2">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="02009"/>
                <set name="RspMsg"        value="该用户不存在"/>
                <return/>
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="09997"/>
                <set name="RspMsg"        value="系统错误，请稍后再试"/>
                <return/>
            </elseif>
            
            <!-- 检查支付密码是否冻结 add by gyl 20140212-->
            <set name="RCS_PWD_TYPE"        value="3"           />
            <set name="RCS_USER_CODE"       expr="CUST_ID"        />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"     />
            <set name="RCS_PRD_NO"          value=""            />
            <set name="RCS_TCODE"           value="5"           />
            <set name="RCS_STATUS"          value="0"           />
            <quote name="tranPwdLock"/> 
            
            <if condition="IS_NOEQUAL_STRING(CUST_PWD,PAYPWD)">
                <set name="RspCod"        value="002050"/>
                <set name="RspMsg"        value="支付密码错误"/>
                <!--实时交易日志-->
                <!--set name="RCS_USER_CODE"       expr="CUST_ID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="5"               />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/-->
                <return/>
            </if>
            <else>
                <!--实时交易日志，密码正确后需要通知风控-->
                <!--set name="RCS_USER_CODE"       expr="CUST_ID"/>
                <set name="RCS_PAY_TYPE"        expr="TRANDESC"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="7"               />
                <set name="RCS_STATUS"          value="1"               />
                <quote name="tranByRightTime"/-->
                <if condition="ISNUMBER(NEWUSRMP)">
                    <!-- 校验验证码 -->
                    <set name="VER_TYPE" value="0"/><!--验证类型 0：短信验证 1：邮箱验证 -->
                    <!--手机验证   -->
                    <if condition="ISNULL(SERVICE_TYPE)">
                       <set name="SERVICE_TYPE" value="00"/><!--验证码服务类型 00-注册短信验证 01-修改密码短信验证 02-找回密码短信验证 03-数字证书短信验证 04-帐号变更短信验证 05-消费支付短信验证 -->
                    </if>
                    <else>
                       <set name="SERVICE_TYPE" expr="SERVICE_TYPE" />
                    </else>
                    <set name="CHECK_USRMP"      expr="NEWUSRMP"      />
                    <set name="CHECK_VERIFYNUM"  expr="VERIFYNUM"     />
                    <quote name="checkVerifyCode"/>
                    
                    <set name="USR_MOBILE" expr="NEWUSRMP"/>
                    <!-- 修改用户信息表 -->
                    <do func="ExecSql" error="IGNORE">
                        <para name="SqlCmd" sql="UpdUsrLoginName"/>
                    </do>
                    <if condition="#RetCod!=0">
                        <set name="MsgTyp"        value="E"/>
                        <set name="RspCod"        value="09999"/>
                        <set name="RspMsg"        value="数据库操作错误"/>
                        <return/>
                    </if>
                </if>
                <else>
                    <set name="MsgTyp"  value="E"/>
                    <set name="RspCod"  value="09999"/>
                    <set name="RspMsg"  value="用户不能绑定手机！"/>
                    <return/>
                </else>
            </else>
            <set name="signFlag"    value="0"/><!-- 0：成功 1：失败 -->
            <set name="RspCod"      value="000000"/>
            <set name="RspMsg"      value="交易成功"/>
        </process>
    </transaction>
   
    <transaction code="800032" desc="查询是否绑定手机">
        <sql name="QryCust">
            SELECT USR_MOBILE FROM STPUSRINF WHERE  CUST_LOGIN=#{UsrMp}
        </sql>
        <process>
            <set name="sPwds"    value=""/>
            <quote name="ParseRequestParamsNoCheckStatus"/>
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QryCust" />
            </do>
            <if condition="#RetCod==-1">
                <set name="MsgTyp"      value="E"/>
                <set name="RspCod"      value="09999"/>
                <set name="RspMsg"      value="数据库操作错误"/>
                <return/>
            </if>
            <elseif condition="#RetCod==2">
                <set name="MsgTyp"      value="E"/>
                <set name="RspCod"      value="02009"/>
                <set name="RspMsg"      value="该用户不存在"/>
                <return/>
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp"      value="E"/>
                <set name="RspCod"      value="09997"/>
                <set name="RspMsg"      value="系统错误，请稍后再试"/>
                <return/>
            </elseif>
            <if condition="ISNULL(USR_MOBILE)">
                <set name="RspCod"      value="345678"/>
                <set name="RspMsg"      value="未绑定"/>
            </if>
            <else>
                <set name="UsrMobile" expr="USR_MOBILE"/>
                <set name="RspCod"      value="000000"/>
                <set name="RspMsg"      value="已绑定"/>
            </else>
        </process>
    </transaction>
    
    <transaction code="800033" desc="查询卡BIN信息">
        <sql name="cardType">
            select enm_dat_des  as BANKCARDTYPES  from lyxdicenm where sys_id='0001' and trim(enm_en_nam) like 'bankCardType' and trim(enm_dat_opt)=#{DCFLAG}
        </sql>
        <process>
            <set name="sPwds"    value=""/>
            <quote name="ParseRequestParams"/>
            <!-- 查询银行号缩写 -->
            <set name="bankCard"    expr="BANKCARDNO"/>
            <do func="GetCrdInfo" error="IGNORE">
                <para name="CrdNo"  expr="bankCard" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"      value="E" />
                <set name="RspCod"      value="009979" />
                <set name="RspMsg"      value="此卡不能开通快捷支付，请使用其他卡！"/>
                <return/>
            </if>
            
            <set name="BANKCODE"      expr="ISSNO" />
            <if condition="ISNULL(ISSNAM)">
               <set name="MsgTyp"      value="E" />
                <set name="RspCod"      value="009978" />
                <set name="RspMsg"      value="此卡不能开通快捷支付，请使用其他卡！"/>
                <return/>
            </if><if condition="ISNULL(BANKCODE)">
               <set name="MsgTyp"      value="E" />
                <set name="RspCod"      value="009978" />
                <set name="RspMsg"      value="此卡不能开通快捷支付，请使用其他卡！"/>
                <return/>
            </if>      
            
            <set name="BANKNAME"    expr="ISSNAM"/>
            <set name="BANKCARDTYPE"    expr="DCFLAG"/>
            
            <!--查询卡bin信息-->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="cardType" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="信息不存在" />
                <return />
            </if>
            <set name="BANKCARDTYPES" expr="BANKCARDTYPES" />  <!--卡种 -->   
            
            <!-- 判断卡bin是否为贷记卡  贷记卡不允许绑定 -->
           <!--<if condition="IS_EQUAL_STRING(BANKCARDTYPES,'贷记卡')">
            	  <set name="RspCod"      value="009978"      />
                <set name="RspMsg"      value="信用卡不允许绑定"   />
                <return/>
            </if>-->         

            <!-- 读取图片配置相对路径 -->
            <set name="ConfigName"   value="G_BANK_INF"/>
            <quote name="ReadXmlCfg"/>
            
            <if condition="ISNULL(BANKCODE)">
                <set name="BANKLOGO"      value="DEFAULT.PNG"   />
            </if>
            <else>
                <set name="BANKLOGO"      expr="STRCAT(BANKCODE,'.PNG')"   />
            </else>
            
            <set name="BANKLOGO"      expr="STRCAT(G_BANKLOGO_PATH,BANKLOGO)"   />
            
            <set name="RspCod"      value="000000"      />
            <set name="RspMsg"      value="交易成功！"   />
        </process>
    </transaction>

    <transaction code="800034" desc="用户转账_批量">
        <sql name="QryCusInf"><!-- 查询客户信息-->
            SELECT cus.CUST_STATUS,cus.CUST_ID as USERID,cus.CUST_NAME AS traCusNam,usr.USR_STATUS as USRSTATUS,usr.usr_mobile FROM STPUSRINF usr,STPCUSINF cus WHERE usr.CUST_ID = cus.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="SelAccInf"><!-- 查询客户账户信息:状态和余额-->
            select a.PAY_AC_NO as PAY_AC_NO,a.CASH_AC_BAL,a.AC_STATUS from ARP_AC_PROFILE a,STPUSRINF b where b.CUST_ID=#{USERID} and (b.CUST_ID =substr(a.PAY_AC_NO,0,14))
        </sql>
        <sql name="QryTraInf"> <!--查询转账订单信息 -->
            SELECT a.OrdStatus,a.txCcy,a.txAmt,a.TraCusId AS cust_id,a.traOrdNo,a.traTime,a.GetCusId recieveNo FROM StpTraInf a,ARP_AC_CUST_REL b,STPUSRINF c WHERE batNo=#{BatNo} and c.CUST_ID=a.TraCusId and b.CUST_ID=c.CUST_ID
        </sql>
        <sql name="UpdSts"> <!-- 更新转账订单表 -->
            UPDATE StpTraInf set OrdStatus='01' WHERE batNo=#{BatNo} 
        </sql>
        <sql name="QryPassInf"><!-- 查询客户支付密码信息-->
            SELECT PASSWORD,CUST_ID FROM ARP_AC_CUST_REL WHERE PAY_AC_NO=#{PAYNO}
        </sql>
        <sql name="QryGetAccNo"><!-- 查询客户账户信息:帐号-->
            select a.PAY_AC_NO as TGetAccNo,c.CUST_NAME as TGetAccNam from ARP_AC_PROFILE a,STPUSRINF b,STPCUSINF c where b.CUST_LOGIN=#{TGetAccNo} and (b.CUST_ID =substr(a.PAY_AC_NO,0,14)) and b.CUST_ID=c.CUST_ID
        </sql>
        <sql name="QryRepeatPrd"> <!-- 查询重复订单 -->
            SELECT TRAORDNO as TEMP_COUNT FROM StpTraInf WHERE TraCusId = #{USERID} AND VerifyCode = #{VerifyCode}
        </sql>
        <sql name="QryGetAccNam"><!-- 查询客户账户信息:名称-->
            select c.CUST_NAME as TGetAccNam, c.CUST_ID as TGetCusId from ARP_AC_PROFILE a,STPUSRINF b,STPCUSINF c where b.CUST_LOGIN=#{TGetAccNo} and (b.CUST_ID =substr(a.PAY_AC_NO,0,14)) and b.CUST_ID=c.CUST_ID
        </sql>
        <!--校验手机验证码需要-->
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>   
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random,TimeOut
            FROM STPVERIFY 
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
        <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
            SELECT 
            EXTRACT(MINUTE FROM (sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND ) as timeDifference,
            CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
            FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
            INSERT INTO STPLOGTMP
            (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
            VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
        </sql>
        <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
            LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
            WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="PAYPWD:G_RANDOM"/>
            <quote name="ParseRequestParams"/>

            <set name="getCustNo"   expr="TGETACCNO"/><!--转入账户用作返回-->
            
            <quote name="usrChk"/>
            
            <if condition="ISNUMBER(UsrMp)">
                <set name="RANDUSRMP"  expr="UsrMp"/>
            </if>
            <esle>
                <set name="RANDUSRMP"  expr="usr_mobile"/>
            </esle>
            <!--校验手机验证码-->
            <!--quote name="chkRandom"/-->
            
            <!-- 检查是否有人模拟请求，禁止重复转账请求 -->
            <set name="USERID"    expr="USERID"     desc="用户ID"    />
            <set name="VerifyCode"    expr="VerifyCode" desc="转账时间戳"/>
            <if condition="ISNULL(VerifyCode)">
                <set name="RspCod"    value="000001"              />
                <set name="RspMsg"    value="交易错误，不能转账！"/>
                <return/>
            </if>
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryRepeatPrd" />
            </do>
            <if condition="#RetCod==0">
                <set name="RspCod"    value="000001"              />
                <set name="RspMsg"    value="重复订单，不能转账！"/>
                <return/>
            </if>
            
            
            <quote name="chkAcc"/>
            <quote name="getPublicInfo"/>
            <!--验证用户认证状态-->
            <if condition="IS_NOEQUAL_STRING(USRSTATUS,'2')">
                <set name="RspCod"    value="20019"/>
                <set name="RspMsg"    value="您目前未进行身份认证,请提交认证资料通过后再进行转账！"/>
                <return/>
            </if>
            
            <set name="CASH_AC_BAL"     expr="CASH_AC_BAL"  />
            <!--验证可转金额是否大于转账金额-->
            <if condition="DOUBLECMP(AMTPOWER(AddAmt,2),6,CASH_AC_BAL)">
                <set name="RspCod"    value="20014"/>
                <set name="RspMsg"    value="转账金额大于账户余额！"/>
                <return/>
            </if>
            
            <!-- 用户支付密码锁定次数判断 -->
             <set name="USER_ID" expr="DELBOTHSPACE(USRMP)" />
             <set name="CUSTTYPE"  value="0"/><!--0用户1 商户 2企业-->
             <set name="PWDTYPE"   value="1"/><!--0:登录密码 1:支付密码-->
             <set name="FailFlag"  value="0"/>
             <quote name="usrpwdlock"/>
             <!-- 用户支付密码锁定次数判断 -->
             
            <!--校验支付密码(放在建立订单前，支付密码错误怎不产生订单信息)-->
            <set name="PAYNO"      expr="PAY_AC_NO"/><!--上面执行了SelAccInf查询了PAY_AC_NO-->
            <set name="paypwd"     expr="PAYPWD"/>
            <quote name="chklockPayPwd"/>
            
            <!--限额检查  start -->
            <!--set name="txAmt"         expr="AMTPOWER(TXAMT,2)"/-->    <!--交易金额-->
            <set name="Amt"           expr="AMTPOWER(AddAmt,2)"     /><!--交易金额-->
            <set name="PAY_TYPE"      value="04"        /><!--支付方式 01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
            <set name="TRAN_TYPE"     value="6"         /><!--交易类型 0 其他 1 充值 2消费 3撤销 4预授权完成 5预授权完成撤销 6转账(虚拟帐号间) 7提现 8退款-->
            <set name="cust_type"     value="1"         /><!--效验客户类型(1用户 2 商户 0 两者)-->
            <set name="User_code"     expr="USERID"     /><!--用户编号-->
            <set name="Time"          expr="GETDATETIME()"/>
            <set name="DATE"          expr="GETDATE()"  />
            <set name="ServiceCode"   value="680518"    />
            <quote name="chkLimAmt"/>
            <!--限额检查   end-->
            
            <set name="i" value="0"/>
            <set name="AMTBY" value="0"/>
            <while condition="INTCMP(i,1,NUMS)"><!--循环检查账号-->
                <set name="i" expr="ADD(i,'1')"/> 
                <do func="GetValue"  error="IGNORE">
                    <para name="SourName" expr="STRCAT('TGetAccNo',i)"/>
                    <para name="DestName" value="TGetAccNo"/>
                </do>
                <do func="GetValue"  error="IGNORE">
                    <para name="SourName" expr="STRCAT('txAmt',i)"/>
                    <para name="DestName" value="txAmt"/>
                </do>
                <!-- 同账户不能转账 -->
                <if condition="IS_EQUAL_STRING(USRMP,TGETACCNO)">
                    <set name="RspCod"    value="009992"            />
                    <set name="RspMsg"    value="同账户不能转账！"  />
                    <return/>
                </if>
                <!--检查转入账号信息-->
                <do func="ReadRecord" error="IGNORE">
                    <para name="SqlCmd" sql="QryGetAccNo" />
                </do>
                <if condition="#RetCod==2">
                    <set name="RspCod"    value="009992"                />
                    <set name="RspMsg"    value="转入用户帐号信息不存在"/>
                    <return/>
                </if>
                <set name="AMTBY"     expr="ADDAMT(AMTPOWER(txAmt,'2'),AMTBY)"/><!--account每条记录的金额跟传递的总金额-->
            </while>
          
            <if condition="IS_EQUAL_STRING(AMTBY,ADDAMT)">
                <set name="RspCod"    value="20014"/>
                <set name="RspMsg"    value="总金额与每个订单金额之和不一致！"/>
                <return/>
            </if>
          
            <!--生成批次号-->
            <do func="GetSeqNo"  error="IGNORE">
                <para name="TblNam" value="stpseqrec"                   />
                <para name="KeyNam" value="KeyNam"                      />
                <para name="KeyVal" expr="STRCAT('StpTraInf','BatNo')"  />
                <para name="SeqNam" value="KeyVal"                      />
                <para name="Len"    value="8"                           />
                <para name="Circle" value="1"                           />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09001"/>
                <set name="RspMsg"    value="获取序号错误"/>
                <return/>
            </if>
            <set name="batNo"    expr="STRCAT(SUBSTR(ActDat,2,7),KeyVal)"/>   <!--批次号-->
           
            <set name="i" value="0"/>
            <set name="returnnames" value=""/>
            <while condition="INTCMP(i,1,NUMS)"><!--循环建立转账订单-->
                <set name="i" expr="ADD(i,'1')"/> 
                <do func="GetValue"  error="IGNORE">
                    <para name="SourName" expr="STRCAT('TGetAccNo',i)"/>
                    <para name="DestName" value="TGetAccNo"/>
                </do>
                <do func="GetValue"  error="IGNORE">
                    <para name="SourName" expr="STRCAT('txAmt',i)"/>
                    <para name="DestName" value="txAmt"/>
                </do>
                <!--查询转入账号名称-->
                <do func="ReadRecord" error="IGNORE">
                    <para name="SqlCmd" sql="QryGetAccNam" />
                </do>
                <!--建立转账订单表-->
                <do func="GetSeqNo"  error="IGNORE">            <!--获取序号 -->
                    <para name="TblNam" value="stpseqrec"/>
                    <para name="KeyNam" value="KeyNam"/>
                    <para name="KeyVal" expr="STRCAT('StpTraInf','TraOrdNo')"/>
                    <para name="SeqNam" value="KeyVal"/>
                    <para name="Len"    value="8"/>
                    <para name="Circle" value="1"/>
                </do>
                <if condition="#RetCod!=0">
                    <set name="MsgTyp"    value="E"/>
                    <set name="RspCod"    value="09001"/>
                    <set name="RspMsg"    value="获取序号错误"/>
                    <return/>
                </if>
                <set name="traOrdNo"    expr="STRCAT('T',SUBSTR(nowDate,2,7),KeyVal)"/><!--订单号-->
                <set name="batNo"       expr="batNo"/><!--批次号-->
                <set name="traCusId"     expr="USERID"/><!--Cust_id-->
                <set name="txAmt"       expr="AMTPOWER(TXAMT,2)"/><!--转账金额-->
                <set name="traTime"     expr="GETDATETIME()"/>
                <set name="ordCcy"      value="CNY"/>
                <set name="txCcy"       expr="ordCcy"/>
                <set name="OrdStatus"   value="00"/>    <!--待付款-->
                <set name="REMARK"      expr="FIELD"/> <!--备注-->
                <set name="getCusNam"   expr="TGetAccNam"/> <!-- 收款（转入）客户名称 -->
                <set name="getCusId"    expr="TGetCusId"/>  <!-- 收款（转入）客户编号 -->
                <do func="InsertRecord" error="IGNORE">
                    <para name="TblNam"  value="StpTraInf" />
                </do>
                <if condition="#RetCod!=0">
                    <set name="MsgTyp"    value="E"/>
                    <set name="RspCod"    value="09999"/>
                    <set name="RspMsg"    value="数据库操作错误"/>
                    
                    <set name="RCS_USER_CODE"       expr="USERID"           />
                    <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
                    <set name="RCS_PRD_NO"          expr="traOrdNo"         />
                    <set name="RCS_TCODE"           value=""                />
                    <set name="RCS_STATUS"          value="0"               />
                    <quote name="tranByRightTime"/>
                    <return/>
                </if>
                <!--组串用于返回信息-->
                <set name="returntralist" expr="STRCAT(returnnames,'traOrdNo=',traOrdNo,',txAmt=',AMTADDDOT(txAmt),',TGetAccNam=',TGetAccNam,',traTime=',traTime,',Type=4|')"/>
                
                <set name="txAmt1"      expr="AMTADDDOT(txAmt)"/><!--循环的上面是POWER了100倍，所以循环结尾还原-->
                <do func="GetValue"  error="IGNORE">
                    <para name="SourName" value="txAmt1"/>
                    <para name="DestName" expr="STRCAT('txAmt',i)"/>
                </do> 
                <do func="SetValue"  error="IGNORE">
                    <para name="FieldName"   expr="STRCAT('traOrdNo',i)"/>
                    <para name="FieldValue"  expr="traOrdNo"/>
                </do>
            </while>

            <!--转账-->
            <set name="payacno"     expr="PAY_AC_NO"/><!--转出账号-->
            <set name="BatNo"       expr="batNo"/><!--批次号-->
            <!--准备转账记账数据-->
            <set name="usrPar"      expr="STRCAT(CUST_ID,'/','01','/','-','/','CNY','/',AMTBY,'/','Y','/')"/>  <!--转出方记账参数-->
            <do func="QueryInGroup" error="IGNORE">
               <para name="SqlCmd"      sql="QryTraInf" />
               <para name="RecordName"  value="ACCINF" />
            </do>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="07001"/>
               <set name="RspMsg"    value="该订单信息不存在"/>
               <return/>
            </if>
            <set name="PARAMS"        expr="usrPar"/>
            <foreach name="ACCINF" iterator="#acc">                       
               <set name="recieveNo"  expr="#acc.recieveNo"/>
               <set name="Amt"        expr="#acc.txAmt"/>
               <set name="usrPar"     expr="STRCAT(recieveNo,'/','01','/','+','/','CNY','/',AMT,'/','Y','/')"/>  <!--转入方记账参数-->
               <set name="PARAMS"     expr="STRCAT(PARAMS,',',usrPar)"/>
            </foreach>   
            
            <!--记账处理-->
            <set name="TXN_TYP"      value="3"/>      <!--用途 3 转账-->
            <set name="prdordno"     expr="BatNo"/>
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="08060"/>
                <set name="RspMsg"    value="转账失败"/>
                <return/>
            </if>
            
            <!--更新订单状态-->
            <set name="BatNo"    expr="batNo"/>
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="UpdSts"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                <return/>
            </if>
            
            <!-- 修改登记失败信息表 -->
            <do func="ExecSql" error="IGNORE">
               <para name="SqlCmd" sql="UpdUsrLogInfo"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="RSPCOD" value="02040"/>
               <set name="RSPMSG" value="更新登录信息失败!"/> 
               <return/>
            </if>
            
            <!--循环通知风控，记录实时交易日志-->
            <set name="i" value="0"/>
            <while condition="INTCMP(i,1,NUMS)">
                <set name="i" expr="ADD(i,'1')"/> 
                <do func="GetValue"  error="IGNORE">
                 <para name="SourName" expr="STRCAT('txAmt',i)"/>
                 <para name="DestName" value="txAmt"/>
                </do>
                <do func="GetValue"  error="IGNORE">
                    <para name="SourName" expr="STRCAT('traOrdNo',i)"/>
                    <para name="DestName" value="traOrdNo"/>
                </do>
                <!--通知风控系统登记订单信息-->
                <set name="ServiceCode" value="680517"/>
                <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
                <set name="TCODE"       expr="traOrdNo"/>           <!--平台流水号 转账订单号-->
                <set name="CTYPE"       value="1"/>                 <!--客户类型-->
                <set name="CLIENTCODE"  expr="USERID"/>             <!--客户编号-->
                <set name="CLIENTNAME"  expr="USERID"/>
                <set name="MOBILEPHONE" expr="USRMP"/>
                <set name="TRANTYPE"    value="6"/>                 <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
                <set name="TAMT"        expr="AMTPOWER(TXAMT,2)"/>
                <set name="REGDTTIME"   expr="GETDATETIME()"/>
                <set name="Time"        expr="SUBSTR(REGDTTIME,1,8)"/>
                <quote name="noticRcs"/>
               
                <set name="RCS_USER_CODE"       expr="USERID"           />
                <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
                <set name="RCS_PRD_NO"          expr="traOrdNo"         />
                <set name="RCS_TCODE"           value=""                />
                <set name="RCS_STATUS"          value="1"               />
                
            </while>
            <set name="MsgTyp"          value="N"/>
            <set name="batNo"           expr="batNo"/>
            <set name="returntralist"   expr="returntralist" />
            <set name="RspCod"          value="000000"/>
            <set name="RspMsg"          value="交易成功"/>
        </process>
    </transaction>
    
    <transaction code="800035" desc="批量检查账号">
        <sql name="QryGetCUSTNAME"><!-- 查询客户信息-->
            select a.PAY_AC_NO as TGetAccNo,c.CUST_NAME as TGetAccNam from ARP_AC_PROFILE a,STPUSRINF b,STPCUSINF c where b.CUST_LOGIN=#{CUST_LOGIN} and (b.CUST_ID =substr(a.PAY_AC_NO,0,14)) and b.CUST_ID=c.CUST_ID
        </sql>
       <process>
           <!-- 对APP数据进行解密 -->
           <quote name="ParseRequestParams"/>
           
           <set name="returncustnames" value=""/>

           <set name="i" value="0"/>
           <while condition="INTCMP(i,1,NUMS)">
               <set name="i" expr="ADD(i,'1')"/> 
               <delete name="CUST_LOGIN"/><!--清空节点-->
               <do func="GetValue"  error="IGNORE">
                 <para name="SourName" expr="STRCAT('CUST_LOGIN',i)"/>
                 <para name="DestName" value="CUST_LOGIN"/>
               </do>
               <do func="ReadRecord" error="IGNORE">
                    <para name="SqlCmd" sql="QryGetCUSTNAME" />
               </do>
               <if condition="#RetCod==0">
                 <set name="returncustnames" expr="STRCAT(returncustnames,TGetAccNam,',')"/>
               </if>
               <else><!--不存在拼接null即可-->
                 <set name="returncustnames" expr="STRCAT(returncustnames,'null,')"/>
               </else>
           </while>    
           <set name="MsgTyp" value="N" />
           <set name="RspCod" value="000000" />
           <set name="RspMsg" value="交易成功" />
       </process>
    </transaction>
    
    <transaction code="800036" desc="按月份返回订单信息">
        <sql name="QryCustId"><!-- 查询客户ID -->
            SELECT CUST_ID AS USRID FROM STPUSRINF WHERE CUST_LOGIN = #{USRMP}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <quote name="ParseRequestParams"/>
            
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryCustId" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"    value="000001"       />
                <set name="RspMsg"    value="客户信息不存在"/>
                <return/>
            </if>
            <if condition="ISNULL(pageNum)">
                <set name="pageNum"    value="1000"/>
            </if>

            <set name="endDate"       expr="STRCAT(endDate,'235959')"/>
            <!--订单中有的订单时间维护的是年月日时分秒，所以这里结束日期追加为结束日的最后一秒,开始时间不追加默认为开始时间和000000，所以不需要修改-->
            <!-- 读取图片配置相对路径 -->
            <set name="ConfigName"   value="G_BANK_INF"/>
            <quote name="ReadXmlCfg"/>
            <do func="getRecordFormat" error="IGNORE">
                <para name="userId"         expr="USRID"    />
                <para name="startDate"      expr="startDate"/>
                <para name="endDate"        expr="endDate"  />
                <para name="pageNum"        expr="pageNum"  />
                <para name="bankLogo"       expr="G_BANKLOGO_PATH"  /><!--配置在config文件中的图片路径-->
                <para name="busType"        expr="busiType"  />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"  value="000002"   />
                <set name="RspMsg"  value="没有符合条件的数据！" />
                <return/>
            </if>
            <if condition="#RetCod!=0">
                <set name="RspCod"  value="000001"   />
                <set name="RspMsg"  value="交易失败" />
                <return/>
            </if>
            
            <set name="RspCod"  value="000000"  />
            <set name="RspMsg"  value="交易成功" />
       </process>
    </transaction>
    
    <transaction code="800037" desc="用户充值_银联(非快捷)">
        <sql name="QryCusInf"><!-- 查询客户信息-->
            SELECT CUST_STATUS FROM StpCusInf WHERE CUST_ID=#{USERID}
        </sql>
        <sql name="SelAccInf"><!-- 查询客户账户信息-->
            SELECT a.AC_STATUS,a.PAY_AC_NO as payacno FROM ARP_AC_PROFILE a,ARP_AC_CUST_REL b WHERE b.CUST_ID=#{USERID} AND a.PAY_AC_NO=b.PAY_AC_NO
        </sql>
        <sql name="QryUsrInf"><!-- 查询客户信息-->
            SELECT CUST_LOGIN,CUST_ID AS USRID,usr_mobile  FROM StpUsrInf WHERE CUST_LOGIN=#{USRMP}
        </sql>
        <sql name="QryPassInf"><!-- 查询客户支付密码信息-->
            SELECT PASSWORD FROM ARP_AC_CUST_REL WHERE PAY_AC_NO=#{PAYACNO}
        </sql>
        <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
            SELECT CASH_AC_BAL,FROZ_BALANCE FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNO}
        </sql>
        <sql name="UpdSts"> <!-- 更新商品订单表 -->
            update stpprdinf set payordno=#{payOrdNos} where PrdOrdNo=#{ORDERNUM}
        </sql>
        
        
        <!--校验手机验证码需要-->
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>   
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random,TimeOut
            FROM STPVERIFY 
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="PAYPWD:G_RANDOM"/>
            <quote name="ParseRequestParams"/>
            
            <if condition="IS_EQUAL_STRING(UsrMp,'')">
                <set name="RspCod"       value="02035"      />
                <set name="RspMsg"       value="手机号为空" />
                <return/>
            </if>
            
            <!--付款方式 01：网银支付(银联)-->
            <if condition="OR(IS_EQUAL_STRING(PRDORDTYPE,''),IS_EQUAL_STRING(TXCHANNEL,''),IS_EQUAL_STRING(TXAMT,''),IS_EQUAL_STRING(BANKCODE,''),IS_EQUAL_STRING(USRMP,''))">
                <set name="RspCod"      value="02036"      />
                <set name="RspMsg"      value="传送参数不完整" />
                <return/>
            </if>
            
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"    value="09992"/>
                <set name="RspMsg"    value="用户信息不存在"/>
                
                <set name="RCS_USER_CODE"       expr="USRID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="用户信息不存在"  />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            <if condition="#RetCod!=0">
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                
                <set name="RCS_USER_CODE"       expr="USRID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="数据库操作"      />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            <set name="userId"     expr="USRID"/>
            <quote name="usrChk"/>
            <quote name="chkAcc"/>
            
            <!--校验手机验证码-->
            <if condition="ISNUMBER(UsrMp)">
                <set name="RANDUSRMP"  expr="UsrMp"/>
            </if>
            <esle>
                <set name="RANDUSRMP"  expr="usr_mobile"/>
            </esle>
            <!--quote name="chkRandom"/-->
            
            <!--限额检查 start--> 
            <set name="TXCHANNEL"     expr="TXCHANNEL"/>  <!--APP传参 网银-->
            <set name="payType"       expr="TXCHANNEL"/>
            <set name="CredNo"        expr="BANKCARDNO"/>
            <set name="Filed1"        expr="FILED"/>
            <set name="PAY_TYPE"      value="01"/>        <!--限额检查接口，00虚拟账户01网银02终端05为快捷支付06混合-->
            <set name="txAmt"         expr="TXAMT"/>    <!--交易金额-->
            <set name="Amt"           expr="TXAMT"/>
            <set name="User_code"     expr="USRID"/>
            <set name="comp_code"     value=""/>
            <set name="cust_type"     value="1"/>  
            <set name="Time"          expr="GETDATETIME()"/>
            <set name="DATE"          expr="GETDATE()"/>
            <set name="TRAN_TYPE"     value="1"/>
            <set name="ServiceCode"   value="680518"/>
            <quote name="chkLimAmt"/>
            <!--限额检查   end--> 
            
            <!--  首次充值，要建立充值订单  -->
            <set name="ordstatus"    value="00"/>                 <!--  默认状态为待付款  -->
            <set name="custRptAcNo"  expr="PAYACNO"/>             <!--充值账号-->
            <set name="ordCcy"       value="CNY"/>
            <set name="ordAmt"       expr="TXAMT"/>               <!--app传参数 付款金额-->
            <set name="orderTime"    expr="GETDATETIME()"/>
            <set name="PrdOrdType"   expr="PRDORDTYPE"/>          <!--app传参数 商品订单类型 0-消费；1-充值  2-担保支付   3商户充值-->
            <set name="bizType"      value="01"/>                 <!--业务类型 01 充值-->
            <if condition="IS_EQUAL_STRING(BANKCODE,'UPOP')">
               <set name="BANKCODE"   value="01010000"/>
            </if>  
            <set name="BANKCOD"      expr="BANKCODE"/>            <!--app传参数 银行编码，目前只有银联UOOP-->
            <set name="CUST_ID"      expr="USERID"/> 
            <set name="prdName"      value="手机充值"/>
            <!-- 获取序号 -->
            <do func="GetSeqNo"  error="IGNORE">
                <para name="TblNam" value="stpseqrec"/>
                <para name="KeyNam" value="KeyNam"/>
                <para name="KeyVal" expr="STRCAT('StpPrdInf','SeqNo')"/>
                <para name="SeqNam" value="KeyVal"/>
                <para name="Len"    value="8"/>
                <para name="Circle" value="1"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09001"/>
                <set name="RspMsg"    value="获取序号错误"/>
                <return/>
            </if>
            <set name="SeqNo"        expr="STRCAT(SUBSTR(ActDat,2,7),KeyVal)"/>   <!--商品订单表序号-->
            
            <do func="GetSeqNo"  error="IGNORE">
                <para name="TblNam" value="stpseqrec"/>
                <para name="KeyNam" value="KeyNam"/>
                <para name="KeyVal" expr="STRCAT('StpPrdInf','PrdOrdNo')"/>
                <para name="SeqNam" value="KeyVal"/>
                <para name="Len"    value="8"/>
                <para name="Circle" value="1"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09001"/>
                <set name="RspMsg"    value="获取序号错误"/>
                <return/>
            </if>
            
            <set name="prdordno"    expr="STRCAT(ActDat,KeyVal)"/>    <!--商品订单号-->
            <set name="MERNO" value=" "/>    <!--商品订单商户号为空-->
            <do func="InsertRecord" error="IGNORE">
                <para name="TblNam"  value="StpPrdInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                
                <set name="RCS_USER_CODE"       expr="USRID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
                <set name="RCS_PRD_NO"          expr="prdordno"         />
                <set name="RCS_TCODE"           value="数据库操作"      />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if> 
                    
            <!--获取序号 -->
            <do func="GetSeqNo"  error="IGNORE">
                <para name="TblNam" value="stpseqrec"/>
                <para name="KeyNam" value="KeyNam"/>
                <para name="KeyVal" expr="STRCAT('StpPayInf','PayOrdNo',GETDATE())"/>
                <para name="SeqNam" value="KeyVal"/>
                <para name="Len"    value="8"/>
                <para name="Circle" value="1"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09001"/>
                <set name="RspMsg"    value="获取序号错误"/>
                <return/>
            </if>
            <set name="payOrdNo"    expr="STRCAT('P',SUBSTR(ActDat,2,7),KeyVal)"/>
            
            <set name="txAmt"       expr="txAmt"/>  
            <set name="txCcy"       value="CNY"/> 
            <set name="ordstatus"   value="00"/>
            <if condition="IS_EQUAL_STRING(BANKCODE,'UPOP')">
               <set name="BANKCODE"   value="01010000"/>
            </if>   
            <set name="bankCod"     expr="BANKCODE"/> 
            <set name="PrdOrdNo"    expr="PrdOrdNo"/> <!-- 充值，支付订单中的商品订单号即为充值订单号  -->  
            <set name="ActDat"      expr="GETDATETIME()"/>
            <set name="bankCod"     value="01010000"/>              <!-- bankCod -->
            <if condition="OR(ISNULL(PAYTYPE),IS_EQUAL_STRING(PAYTYPE,''))"> <!--PAYTYE 支付方式00 支付账户   01 网上银行    02 终端   03 快捷支付    04 混合支付    05 支票/汇款-->
              <set name="PAYTYPE"      value="01"/>   
            </if>
            
            <do func="InsertRecord" error="IGNORE">
                <para name="TblNam"  value="StpPayInf"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                <return/>
            </if>
            <!--将生成的支付订单号更新到商品订单表中-->
            <set name="ORDERNUM"  expr="prdordno"/>
            <set name="payOrdNos" expr="payOrdNo"/>
            <do func="ExecSql" error="IGNORE">
             <para name="SqlCmd" sql="UpdSts" />
            </do>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="08001"/>
               <set name="RspMsg"    value="商品订单更新失败！"/>
               <return/>
            </if>
            <!--建立支付订单 end -->
            
            
            <set name="orderId"      expr="payOrdNo"/>
            <set name="txnAmt"       expr="TXAMT"/>  
            <set name="txnTime"      expr="ActDat"/>
            <!--跳转银联支付-->
            <set name="ConfigName"   value="phoneTopupConfig"/>
	      <quote name="ReadXmlCfg"/>
	      <quote name="SendInb"/>
	      <!-- <quote name="SendSDK"/> -->
             
            
            <set name="UPOPWAPPAYURL" expr="UPOPWAPPAYURL"/>
            <set name="payOrdNo"  expr="payOrdNo"/>
            <set name="PrdOrdNo"  expr="PrdOrdNo"/>
            
            <set name="RspCod"    value="000000"/>
            <set name="RspMsg"    value="获取充值支付订单号成功"/>
        </process>
    </transaction>
    
    <transaction code="800038" desc="订单支付_银联(非快捷)">
        <sql name="QryCusInf"><!-- 查询客户信息-->
            SELECT cus.CUST_STATUS,cus.CUST_ID as USERID,usr.USR_STATUS as USRSTATUS,usr_mobile FROM STPUSRINF usr,STPCUSINF cus WHERE usr.CUST_ID = cus.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="SelAccInf"><!-- 查询客户账户信息:状态和余额-->
            select a.PAY_AC_NO as PAY_AC_NO,a.CASH_AC_BAL,a.AC_STATUS from ARP_AC_PROFILE a,STPUSRINF b where b.CUST_ID=#{USERID} and (b.CUST_ID =substr(a.PAY_AC_NO,0,14))
        </sql>
        <sql name="SelPrdInf"><!-- 查询要支付的订单信息-->
            select * from stpprdinf where PrdOrdNo=#{ORDERNUM}
        </sql>
        <sql name="QryPassInf"><!-- 查询客户支付密码信息-->
            SELECT PASSWORD FROM ARP_AC_CUST_REL WHERE PAY_AC_NO=#{PAYNO}
        </sql>
        <sql name="UpdSts"> <!-- 更新商品订单表 -->
            update stpprdinf set payordno=#{payordno} where PrdOrdNo=#{ORDERNUM}
        </sql>
        <sql name="QryPassInf"><!-- 查询客户支付密码信息-->
            SELECT PASSWORD,CUST_ID FROM ARP_AC_CUST_REL WHERE PAY_AC_NO=#{PAYNO}
        </sql>
        
        
        <!--校验手机验证码需要-->
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>   
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random,TimeOut
            FROM STPVERIFY 
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="USERPAYPWD:G_RANDOM"/>
            <quote name="ParseRequestParams"/>

            <if condition="IS_EQUAL_STRING(PAYTYPE,'01')"><!--银联-->
                <set name="PAYTYPE"     value="01"/>
                <set name="accAmt"      value=""/>
                <set name="mulAmt"      value=""/>
            </if>
            <elseif condition="IS_EQUAL_STRING(PAYTYPE,'04')"><!--混合支付-->
                <set name="PAYTYPE"     value="04"/>
                <!--提前登陆两种支付方式各支付多少钱-->
                <set name="accAmt"      expr="accAmt"/>           <!--虚拟账户金额-->
                <!--set name="mulAmt"   expr="AMTPOWER(mulAmt,2)"/-->           <!--混合支付金额-->
                <set name="mulAmt"      expr="mulAmt"/> 
            </elseif>
            <else>
                <set name="RspCod"    value="000000"/>
                <set name="RspMsg"    value="无此支付方式"/>
                <return/>
            </else>

            <quote name="usrChk"/>
            
            <if condition="ISNUMBER(UsrMp)">
                <set name="RANDUSRMP"  expr="UsrMp"/>
            </if>
            <esle>
                <set name="RANDUSRMP"  expr="usr_mobile"/>
            </esle>
            
            <!--校验手机验证码-->
            <!--quote name="chkRandom"/-->
            
            <!--混合支付检查支付密码是否冻结-->
            <if condition="IS_EQUAL_STRING(PAYTYPE,'04')">
             <set name="RCS_PWD_TYPE"        value="3"/>
             <set name="RCS_USER_CODE"       expr="USERID"/>
             <set name="RCS_PAY_TYPE"        expr="TRANCODE"/>
             <set name="RCS_PRD_NO"          value=""/>
             <set name="RCS_TCODE"           value="5"/>
             <set name="RCS_STATUS"          value="0"/>
             <quote name="tranPwdLock"/>
            </if>
            
            <quote name="chkAcc"/>
            <quote name="getPublicInfo"/>
            
            <!-- 查询订单详情 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="SelPrdInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"        value="002008"        />
                <set name="RspMsg"        value="订单不存在"/>
                <return/>
            </if>
            <if condition="#RetCod==-1">
                <set name="RspCod"        value="002008"        />
                <set name="RspMsg"        value="数据库操作错误"/>
                <return/>
            </if>
            <!--验证订单状态-->
            <if condition="IS_NOEQUAL_STRING(ORDSTATUS,'00')">
                <set name="RspCod"    value="20019"/>
                <set name="RspMsg"    value="当前订单状态不可支付！"/>
                
                <set name="RCS_USER_CODE"       expr="USERID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
                <set name="RCS_PRD_NO"          expr="prdOrdNo"         />
                <set name="RCS_TCODE"           value="订单不可支付"    />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            
            <if condition="IS_NOEQUAL_STRING(OrderAmt,ordAmt)">
              <set name="RspCod"    value="20020"/>
              <set name="RspMsg"    value="支付金额与订单金额不符"/>
              <return/>
            </if>  
            
            <!--校验支付密码-->
            <set name="PAYNO"      expr="PAY_AC_NO"/>
            <set name="paypwd"     expr="USERPAYPWD"/>
            <quote name="chkPayPwd"/>
            
            <!--限额检查  start --> 
            <set name="txAmt"         expr="OrderAmt"/><!--客户端传送 交易金额-->
            <set name="Amt"           expr="txAmt"/>
            <set name="User_code"     expr="userID"/>
            <set name="comp_code"     expr="merNo"/>
            <!-- set name="cust_type"     value="0"/ --> 
            <set name="cust_type"     value="1"/>
            <set name="Time"          expr="GETDATETIME()"/>
            <set name="DATE"          expr="GETDATE()"/>
            <set name="TRAN_TYPE"      value="2"/>
            <set name="ServiceCode"   value="680518"/>  
            <quote name="chkLimAmt"/>
            <!--限额检查   end--> 
            
            <!--建立支付订单 start -->
            <do func="GetSeqNo"  error="IGNORE">
                <para name="TblNam" value="stpseqrec"/>
                <para name="KeyNam" value="KeyNam"/>
                <para name="KeyVal" expr="STRCAT('StpPayInf','PayOrdNo',GETDATE())"/>
                <para name="SeqNam" value="KeyVal"/>
                <para name="Len"    value="8"/>
                <para name="Circle" value="1"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09001"/>
                <set name="RspMsg"    value="获取序号错误"/>
                <return/>
            </if>
            <set name="payOrdNo"    expr="STRCAT('P',SUBSTR(ActDat,2,7),KeyVal)"></set>
            
            <set name="ordCcy"       value="CNY"/>                        <!--货币类型-->
            <set name="payType"     expr="payType"/>
            <set name="txCcy"       value="CNY"/>
            <set name="SignMsg"     expr="signature"/>                    <!--签名信息-->
            <set name="ActDat"      expr="GETDATETIME()"/>                <!--支付时间-->
            <set name="OrdStatus"   value="00"/>                          <!--未支付-->
            <set name="cust_id"     expr="userID"/>
            <set name="PrdOrdNo"    expr="PrdOrdNo"/>
            
            <!--此处暂时考虑银联wap支付一种情况故银行编码设为UPOP-->
            <if condition="ISNULL(BANKCODE)">
              <set name="BANKCOD"   value="01010000"/>
              <set name="BANKCODE"   value="01010000"/>
            </if>
            <if condition="IS_EQUAL_STRING(BANKCODE,'UPOP')">
               <set name="BANKCODE"   value="01010000"/>
            </if>             
            <set name="bankCod"   value="01010000"/>
            <set name="isProxy"     value="0"/>
                 
            <do func="InsertRecord" error="IGNORE">
                <para name="TblNam"  value="StpPayInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                <return/>
            </if> 
            
            
            <if condition="IS_EQUAL_STRING(payType,'04')">   <!--混合支付--> 
            <!--set name="prdOrderNo"       expr="prdOrdNo"/>
            <set name="payAcNo"          expr="payAcNo"/>
            <set name="merNotmp"         expr="merno"/>
            <set name="ordertime"        expr="GETDATETIME()"/-->
               <!--根据混合支付方式，发送相应接口-->
               <if condition="IS_EQUAL_STRING(MulType,'01')">       <!--网银-->
                  <set name="orderId"      expr="payOrdNo"/>
                  <set name="txnAmt"       expr="mulAmt"/>  
                  <set name="txnTime"      expr="ActDat"/>
                  <!--取公共参数配置-->
                  <set name="ConfigName"   value="phonePayConfig"/>
                  <quote name="ReadXmlCfg"/>
      <quote name="SendInb" />
               </if>
               <else>
                  <set name="MsgTyp"    value="E"/>
                  <set name="RspCod"    value="00102"/>
                  <set name="RspMsg"    value="第二种支付方式不正确"/>
                  <return/>   
               </else>
            </if>
            <elseif condition="IS_EQUAL_STRING(payType,'01')">   <!--网银-->
               <set name="orderId"      expr="payOrdNo"/>
               <set name="txnAmt"       expr="OrderAmt"/>  
               <set name="txnTime"      expr="ActDat"/>
               <!--取公共参数配置-->
               <!--set name="ConfigName"   value="phonePayConfig"/-->
               <if condition="OR(IS_EQUAL_STRING(prdOrdType,'1'), IS_EQUAL_STRING(prdOrdType,'3'))">
              	  <!--银联参数配置支付-充值-->
                  <set name="ConfigName"   value="phoneTopupConfig"/>
               </if>
               <else>
              	  <!--银联参数配置支付-消费-->
                  <set name="ConfigName"   value="phonePayConfig"/>
               </else>
              
               <quote name="ReadXmlCfg"/>
               <quote name="SendInb"/>
            </elseif>
            <else>
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09999"/>
               <set name="RspMsg"    value="支付方式不正确"/>
               <return/>  
            </else>
            
            <set name="prdOrdNo"       expr="prdOrdNo"/>  <!--商品订单号-->
            <set name="payOrdNo"       expr="payOrdNo"/>  <!--支付订单号-->
            
            <!--根据客户端的 商品订单号OrderNum 将生成的支付订单号更新到商品订单表中-->
            <do func="ExecSql" error="IGNORE">
              <para name="SqlCmd" sql="UpdSts" />
            </do>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="08001"/>
               <set name="RspMsg"    value="商品订单更新失败！"/>
               <return/>
            </if>

             <set name="UPOPWAPPAYURL" expr="UPOPWAPPAYURL"/>
             <set name="PrdOrdNo"  expr="PrdOrdNo"/>
             <set name="payOrdNo"  expr="payOrdNo"/>
             <set name="RspCod"    value="000000"/>
             <set name="RspMsg"    value="获取支付订单号成功"/>
        </process>
    </transaction>
    
    <transaction code="800039" desc="移动端用户支付密码检查">
        <sql name="QueryUsrInfoPwd">
            SELECT arp.PASSWORD CUST_PWD,arp.CUST_ID,usr.CUST_PWD as LOGINPWD FROM ARP_AC_CUST_REL arp,STPUSRINF usr WHERE arp.CUST_ID = usr.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="USRPWD:G_RANDOM"/>
            <quote name="ParseRequestParams"/>

            <!--  检测用户名是否为空  -->
            <if condition="ISNULL(USRMP)"> 
                <set name="RspCod"        value="002035"        />
                <set name="RspMsg"        value="手机号不能为空"/>
                <return/>
            </if>
            <if condition="ISNULL(USRPWD)"> 
                <set name="RspCod"        value="002035"        />
                <set name="RspMsg"        value="支付密码不能为空"/>
                <return/>
            </if>

            <!-- 查询用户原支付密码 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QueryUsrInfoPwd" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"        value="002008"        />
                <set name="RspMsg"        value="用户信息不存在"/>
                <return/>
            </if>
            
            <!-- 检查支付密码是否冻结 -->
            <set name="RCS_PWD_TYPE"        value="3"           />
            <set name="RCS_USER_CODE"       expr="CUST_ID"        />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"     />
            <set name="RCS_PRD_NO"          value=""            />
            <set name="RCS_TCODE"           value="5"           />
            <set name="RCS_STATUS"          value="0"           />
            <quote name="tranPwdLock"/>
            
            <!-- 原密码错误 -->
            <if condition="IS_NOEQUAL_STRING(UsrPwd,CUST_PWD)"> 
                <set name="RspCod"        value="002036"    />
                <set name="RspMsg"        value="用户支付密码错误"  />
                
                <set name="RCS_USER_CODE"       expr="CUST_ID"        />
                <set name="RCS_PAY_TYPE"        expr="TRANCODE"     />
                <set name="RCS_PRD_NO"          value=""            />
                <set name="RCS_TCODE"           value="5"           />
                <set name="RCS_STATUS"          value="0"           />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            <else>
                <set name="RCS_USER_CODE"       expr="CUST_ID"        />
                <set name="RCS_PAY_TYPE"        expr="TRANCODE"     />
                <set name="RCS_PRD_NO"          value=""            />
                <set name="RCS_TCODE"           value="7"           />
                <set name="RCS_STATUS"          value="1"           />
                <quote name="tranByRightTime"/>
                
                <set name="RspCod"        value="000000"    />
                <set name="RspMsg"        value="用户支付密码检查通过"  />
            </else>
        </process>
    </transaction>
    
    <transaction code="800040" desc="移动端担保支付确定付款">
      <sql name="queryPayinf"><!--查询商品订单信息-->
        select ordAmt,nvl(rfTotalAmt,0) rfTotalAmt,OrdStatus,prdName,merNo,bizType,payOrdNo,MERREMARK,prdOrdType,NotifyUrl,CUST_ID from stpprdinf where PrdOrdNo=#{PrdOrdNo} 
      </sql> 
      <sql name="SelPayInf">
        select OrdStatus PayStatus,txAmt,CUST_ID,payType,FEE,payAcNo from stppayinf where PayOrdNo=#{PayOrdNo} 
      </sql>
      <sql name="queryCustNo"><!--查询商户账户信息-->
       select PAY_AC_NO,CUST_ID,AC_TYPE,PASSWORD from ARP_AC_CUST_REL where CUST_ID=#{CUST_ID}
      </sql>
      <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
         SELECT CASH_AC_BAL,FROZ_BALANCE FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNO}
      </sql>
      <sql name="UpdPay"> <!-- 更新支付订单表 -->
         payOrdNo=#{payOrdNo}
      </sql>
      <sql name="UpdPrd"> <!-- 更新商品订单表 -->
         prdOrdNo=#{prdOrdNo}
      </sql>
      <sql name="SelMerFee">
        select fee_code from ARP_CUST_FEE where pay_ac_no in (select pay_ac_no from arp_ac_cust_rel where CUST_ID=#{merNo}) and biz_type=#{bizType} and pay_type=#{payType}
      </sql>
      
       <!--校验手机验证码需要-->
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>   
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random,TimeOut
            FROM STPVERIFY 
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
      <process> 
          <!-- 对APP数据进行解密 -->
          <set name="sPwds"    value="PAYPWD:G_RANDOM"/>
          <quote name="ParseRequestParams"/>
          
          <if condition="ISNUMBER(UsrMp)">
              <set name="RANDUSRMP"  expr="UsrMp"/>
          </if>
          <else>
              <set name="RANDUSRMP"  expr="usr_mobile"/>
          </else>
          <!--校验手机验证码-->
          <quote name="chkRandom"/>

          <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="queryPayinf" />
          </do>
          <if condition="#RetCod!=0">
             <set name="RspCod"    value="09999"/>
             <set name="RspMsg"    value="商品订单不存在"/>
             <return/>
          </if>
          
          <if condition="OR(IS_EQUAL_STRING(OrdStatus,'09'),IS_EQUAL_STRING(OrdStatus,'11'))">
            <set name="RspCod"    value="06007"/>
            <set name="RspMsg"    value="订单已撤销或已作废"/>
            <return/>
          </if>
          <!--现在担保支付确认付款前做过部分退款后也可进行确认支付  此时已退款成功状态进入本交易的订单累计退款肯定小于订单金额，所以只限定一个05状态就可以了，因为在页面控制了按钮-->
          <elseif condition="AND(IS_NOEQUAL_STRING(OrdStatus,'00'),IS_NOEQUAL_STRING(OrdStatus,'12'),IS_NOEQUAL_STRING(OrdStatus,'05'))">
            <set name="RspCod"    value="06008"/>
            <set name="RspMsg"    value="该商品订单状态为不能支付"/>
            <return/>
          </elseif>
          
          <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="SelPayInf" />
          </do>
          <if condition="#RetCod!=0">
             <set name="RspCod"    value="09999"/>
             <set name="RspMsg"    value="支付订单不存在"/>
             <return/>
          </if>
          
          <if condition="AND(IS_NOEQUAL_STRING(PayStatus,'00'),IS_NOEQUAL_STRING(PayStatus,'12'))">
            <set name="RspCod"    value="06009"/>
            <set name="RspMsg"    value="该支付订单状态为不能支付"/>
            <return/>
          </if>
          
          <set name="ordAmtSub" expr="SUB(ordAmt,rfTotalAmt)" /><!--订单金额减去累计退款-->
          <set name="txAmtSub"  expr="SUB(txAmt,rfTotalAmt)" /><!--支付金额减去累计退款-->
          
          <set name="UsrPwd" expr="PASSWORD" />

          <!-- 检查支付密码是否为空 --> 
          <if condition="IS_EQUAL_STRING(PAYPWD,'')">
            <set name="RspCod"        value="02058"/>
            <set name="RspMsg"        value="支付密码为空"/>
            <return/>
          </if>
          
          <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="queryCustNo" />
          </do>
          <if condition="#RetCod!=0">
             <set name="RspCod"    value="09999"/>
             <set name="RspMsg"    value="商户账户不存在"/>
             <return/>
          </if>
          
          <set name="PASSWORD" expr="PASSWORD"/>
          
          <set name="RCS_USER_CODE"       expr="CUST_ID"        />
          <set name="RCS_PAY_TYPE"        expr="TRANCODE"     />
          <set name="RCS_PRD_NO"          value=""            />
          
          <!-- 检查支付密码是否冻结 -->
          <set name="RCS_PWD_TYPE"        value="3"           />
          <set name="RCS_TCODE"           value="5"           />
          <set name="RCS_STATUS"          value="0"           />
          <quote name="tranPwdLock"/>
          
          <if condition="IS_NOEQUAL_STRING(PAYPWD,PASSWORD)">
            <set name="RCS_TCODE"           value="5"           />
            <set name="RCS_STATUS"          value="0"           />
            <quote name="tranByRightTime"/>
            <set name="RspCod"        value="02058"/>
            <set name="RspMsg"        value="用户支付密码错误"/>
            <return/>
          </if>
          <else>
            <set name="RCS_TCODE"           value="7"           />
            <set name="RCS_STATUS"          value="1"           />
            <quote name="tranByRightTime"/>
          </else>
          <!--不收手续费-->
          <set name="txAmt" expr="txAmtSub"/>
          <!--计算商户手续费-->
          <quote name="CalMerFee"/>
          <set name="txnComAmt"      value="0"/>   <!--交易佣金-->  
         <!--扣除中间账户的金额-->
         <if condition="OR(IS_EQUAL_STRING(payType,'00'),IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(payType,'01'))"> 
            <!--进行虚拟账户扣款-->
            <set name="payacno"      expr="payAcNo"/>   
            <set name="pltMidPar"    expr="STRCAT('99999900000001','/','04','/','-','/','CNY','/',txAmtSub,'/','N','/')"/>   <!--平台担保账户记账参数-->
            <if condition="OR(IS_EQUAL_STRING(FEE,'0'),ISNULL(FEE))">       <!--无手续费--> 
              <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','+','/','CNY','/',txAmtSub,'/','Y','/')"/>         <!--商户记账参数-->
              <set name="PARAMS"     expr="STRCAT(pltMidPar,',',merPar)"/>
            </if>
            <else>                                                          <!--有手续费-->    
              <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','+','/','CNY','/',txAmtnet,'/','Y','/')"/>         <!--商户记账参数-->
              <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
              <set name="PARAMS"     expr="STRCAT(pltMidPar,',',merPar,',',feePar)"/>
            </else>
         
            <!--记账处理-->
            <set name="TXN_TYP"      value="2"/>              <!--用途  消费-->
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <set name="Status"       value="2"/>
               <set name="ClearDat"     expr="GETDATE()"/>    <!--清算日期-->
               <delete name="actdat"/>
               <quote name="UpdPay"/>
               <set name="acDate"       expr="GETDATE()"/>    <!--清算日期-->  
               <set name="acTime"       expr="GETDATETIME('HHMISS')"/>  <!--清算时间-->
               
               <quote name="UpdPrd"/>
              
               <set name="ThirdServer"  value="STHDSMK1"/>
               <!--通知商城付款失败--> 
               <!--quote name="TimeTouch2"/-->
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="07007"/>
               <set name="RspMsg"    value="支付失败"/>
               <set name="NXTPAG"    value="../result/bakfalse.jsp"/>
               <return/>
            </if>
            
            <set name="netRecAmt"      expr="SUB(TXAMT,FEE)"/>                                                
            <set name="txnComAmt"      expr="FEE"/>   
            <set name="acDate"         expr="GETDATE()"/>
            <set name="acTime"         expr="GETDATETIME('HHMISS')"/>
            <set name="ClearDat"       expr="GETDATE()"/>
            
            <quote name="UpdPrd"/>
            
            <!--更新支付订单表-->
            <set name="OrdStatus"    value="01"/>
            <quote name="UpdPay"/>
            
            <if condition="ISNULL(merRemark)">
               <set name="merRemark"         value="商物通支付"/>
            </if>

            <set name="ThirdServer" value="STHDSMK1"/>

            <set name="#url"      expr="NotifyUrl" />  
            <set name="ordStatus" value="01"/> 
            <set name="Status"    value="1"/> 
            <!--更新商品订单表--> 
            <quote name="UpdPrd"/>
            
            <set name="MsgTyp"    value="N"/>
            <set name="RspCod"    value="000000"/>
            <set name="RspMsg"    value="确定付款成功"/>
         </if>
         <else>
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="06012"/>
            <set name="RspMsg"    value="无此支付方式"/>
         </else>
      </process>
    </transaction>
    
    <transaction code="800041" desc="移动端_用户转账_继续付款(根据批次号)">
        <sql name="QryCusInf"><!-- 查询客户信息-->
            SELECT cus.CUST_STATUS,cus.CUST_ID as USERID,usr.USR_STATUS as USRSTATUS,usr.usr_mobile FROM STPUSRINF usr,STPCUSINF cus WHERE usr.CUST_ID = cus.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="SelAccInf"><!-- 查询客户账户信息:状态和余额-->
            select a.PAY_AC_NO as PAY_AC_NO,a.CASH_AC_BAL,a.AC_STATUS from ARP_AC_PROFILE a,STPUSRINF b where b.CUST_ID=#{USERID} and (b.CUST_ID =substr(a.PAY_AC_NO,0,14))
        </sql>
        <sql name="UpdSts"> <!-- 更新转账订单表 -->
            UPDATE StpTraInf set OrdStatus='01',ClearDat=#{ActDat} WHERE batNo=#{BatNo} 
        </sql>
        <sql name="QryPassInf"><!-- 查询客户支付密码信息-->
            SELECT PASSWORD,CUST_ID FROM ARP_AC_CUST_REL WHERE PAY_AC_NO=#{PAYNO}
        </sql>
        <sql name="QryGetAccNo"><!-- 查询客户账户信息:帐号-->
            select a.CUST_ID as TGetAccNo,c.CUST_NAME as TGetAccNam from ARP_AC_CUST_REL a,STPUSRINF b,STPCUSINF c where b.CUST_LOGIN=#{TGetAccNo} and b.CUST_ID =a.CUST_ID and b.CUST_ID=c.CUST_ID
        </sql>
        <sql name="QryTraInf"> <!--查询转账订单信息 -->
            SELECT a.OrdStatus,a.txCcy,a.txAmt,a.TGetAccNo,a.cust_id,a.totamt,a.traOrdNo,a.traTime,TGETACCNAM,b.cust_id recieveNo,a.Filed1 FROM StpTraInf a,ARP_AC_CUST_REL b,STPUSRINF c WHERE batNo=#{BatNo} and c.CUST_LOGIN=a.TGetAccNo and b.CUST_ID=c.CUST_ID
        </sql>
        <sql name="QryTraInfSta"> <!--检查批次订单状态 -->
            <!--SELECT c.CUST_LOGIN as LOGINNAME,a.OrdStatus,a.txCcy,a.txAmt,a.TGetAccNo,a.cust_id,a.totamt,a.traOrdNo,a.traTime,TGETACCNAM,b.PAY_AC_NO recieveNo,a.Filed1 FROM StpTraInf a,ARP_AC_CUST_REL b,STPUSRINF c WHERE batNo=#{BatNo} and (c.CUST_LOGIN)=(a.TGetAccNo) and (b.CUST_ID)=(c.CUST_ID) and a.OrdStatus !='00'-->
            select * from  StpTraInf where BATNO=#{BatNo} and OrdStatus !='00'
        </sql>
        <sql name="QryTraInfFk"> <!--查询出需要通知风控的订单 -->
            select * from  StpTraInf where BATNO=#{BatNo}
        </sql>
        
         <!--校验手机验证码需要-->
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>   
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random,TimeOut
            FROM STPVERIFY 
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="PAYPWD:G_RANDOM"/>
            <quote name="ParseRequestParams"/>

            <quote name="usrChk"/>
            
            
            <if condition="ISNUMBER(UsrMp)">
                <set name="RANDUSRMP"  expr="UsrMp"/>
            </if>
            <esle>
                <set name="RANDUSRMP"  expr="usr_mobile"/>
            </esle>
            <!--校验手机验证码-->
            <quote name="chkRandom"/>
            
            <!-- 检查支付密码是否冻结 -->
            <set name="RCS_PWD_TYPE"        value="3"           />
            <set name="RCS_USER_CODE"       expr="USERID"        />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"     />
            <set name="RCS_PRD_NO"          value=""            />
            <set name="RCS_TCODE"           value="5"           />
            <set name="RCS_STATUS"          value="0"           />
            <quote name="tranPwdLock"/>
            
            <quote name="chkAcc"/>
            <quote name="getPublicInfo"/>
            <!--验证用户认证状态-->
            <if condition="IS_NOEQUAL_STRING(USRSTATUS,'2')">
                <set name="RspCod"    value="20019"/>
                <set name="RspMsg"    value="您目前未进行身份认证,请提交认证资料通过后再进行转账！"/>
                <return/>
            </if>
            
            <!--这里需要循环检查订单-->
            <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd" sql="QryTraInf" />
            </do>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="07001"/>
               <set name="RspMsg"    value="该转账订单信息不存在"/>
               <return/>
            </if>
            <else>
               <do func="ReadRecord" error="IGNORE">
                 <para name="SqlCmd" sql="QryTraInfSta" />
               </do>
               <if condition="#RetCod==2">
                 <set name="PASS"    value="检查通过"/>
               </if>
               <else>
                 <set name="RspCod"    value="07001"/>
                 <set name="RspMsg"    value="本批次转账订单中存在非待付款状态订单"/>
                 <return/>
               </else>
            </else>
            
            <!--校验支付密码-->
            <set name="PAYNO"      expr="PAY_AC_NO"/><!--上面执行了SelAccInf查询了PAY_AC_NO-->
            <set name="paypwd"     expr="PAYPWD"/>
            <quote name="chkPayPwd"/>
               
            <!--限额检查  start --> 
            <set name="Amt"           expr="TXAMT"/> <!--交易金额-->
            <set name="PAY_TYPE"      value="04"/><!--支付方式 01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
            <set name="TRAN_TYPE"     value="6"/><!--交易类型 0 其他 1 充值 2消费 3撤销 4预授权完成 5预授权完成撤销 6转账(虚拟帐号间) 7提现 8退款-->
            <set name="cust_type"     value="1"/>  <!--效验客户类型(1用户 2 商户 0 两者)-->
            <set name="User_code"     expr="USERID"/><!--用户编号-->
            <set name="Time"          expr="GETDATETIME()"/>
            <set name="DATE"          expr="GETDATE()"/>
            <set name="ServiceCode"   value="680518"/>  
            <quote name="chkLimAmt"/>
            <!--限额检查   end-->
               
            <!--转账-->
            <set name="payacno"     expr="PAY_AC_NO"/><!--转出账号-->
            <set name="BatNo"       expr="batNo"/><!--批次号-->
            
            <!--准备转账记账数据-->
            <set name="usrPar"      expr="STRCAT(CUST_ID,'/','01','/','-','/','CNY','/',AMTPOWER(TOTAMT,2),'/','Y','/')"/>  <!--转出方记账参数-->
            <do func="QueryInGroup" error="IGNORE">
               <para name="SqlCmd"      sql="QryTraInf" />
               <para name="RecordName"  value="ACCINF" />
            </do>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="07001"/>
               <set name="RspMsg"    value="该订单信息不存在"/>
               <return/>
            </if>
            <set name="PARAMS"        expr="usrPar"/>
            <foreach name="ACCINF" iterator="#acc">                       
               <set name="recieveNo"  expr="#acc.recieveNo"/>
               <set name="Amt"        expr="#acc.txAmt"/>
               <set name="usrPar"     expr="STRCAT(recieveNo,'/','01','/','+','/','CNY','/',AMT,'/','Y','/')"/>  <!--转入方记账参数-->
               <set name="PARAMS"     expr="STRCAT(PARAMS,',',usrPar)"/>
            </foreach>   
            
            <!--记账处理-->
            <set name="TXN_TYP"      value="3"/>      <!--用途 3 转账-->
            <set name="prdordno"     expr="BatNo"/>
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="08060"/>
                <set name="RspMsg"    value="转账失败"/>
                <return/>
            </if>
            
            <!--更新订单状态-->
            <set name="BatNo"    expr="batNo"/>
            <do func="ExecSql" error="IGNORE">
               <para name="SqlCmd" sql="UpdSts"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09999"/>
               <set name="RspMsg"    value="数据库操作错误"/>
               <return/>
            </if>
                  
            <do func="QueryInGroup" error="IGNORE">
                <para name="SqlCmd"      sql="QryTraInfFk" />
                <para name="RecordName"  value="Lists" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"    value="07001"/>
                <set name="RspMsg"    value="该转账订单信息不存在"/>
                <return/>
            </if> 
            
            <foreach name="Lists" iterator="#GROUP">
             <!--通知风控系统登记订单信息-->
               <set name="ServiceCode" value="680517"/>
               <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
               <set name="TCODE"       expr="#GROUP.traOrdNo"/>           <!--平台流水号 转账订单号-->
               <set name="CTYPE"       value="1"/>                 <!--客户类型-->
               <set name="CLIENTCODE"  expr="#GROUP.CUST_ID"/>             <!--客户编号-->
               <set name="CLIENTNAME"  expr="#GROUP.CUST_ID"/>
               <set name="MOBILEPHONE" expr="USRMP"/>
               <set name="TRANTYPE"    value="6"/>                 <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
               <set name="TAMT"        expr="#GROUP.TXAMT"/>
               <set name="REGDTTIME"   expr="GETDATETIME()"/>
               <set name="Time"        expr="SUBSTR(REGDTTIME,1,8)"/>
               <quote name="noticRcs"/>
               
               <set name="RCS_USER_CODE"       expr="USERID"            />
               <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
               <set name="RCS_PRD_NO"          expr="#GROUP.traOrdNo"         />
               <set name="RCS_TCODE"           value=""                />
               <set name="RCS_STATUS"          value="1"               />
               <quote name="tranByRightTime"/>
            </foreach>

            <set name="MsgTyp"    value="N"/>
            <set name="batNo"     expr="batNo"/>
            <set name="returntralist"   expr="returntralist" />
            <set name="RspCod"    value="000000"/>
            <set name="RspMsg"    value="交易成功"/>
        </process>
    </transaction>
    
    <transaction code="800042" desc="移动端_用户转账_继续付款(根据订单号)">
        <sql name="QryCusInf"><!-- 查询客户信息-->
            SELECT cus.CUST_STATUS,cus.CUST_ID as USERID,usr.USR_STATUS as USRSTATUS,usr.usr_mobile FROM STPUSRINF usr,STPCUSINF cus WHERE usr.CUST_ID = cus.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="SelAccInf"><!-- 查询客户账户信息:状态和余额-->
            select a.PAY_AC_NO as PAY_AC_NO,a.CASH_AC_BAL,a.AC_STATUS from ARP_AC_PROFILE a,STPUSRINF b where b.CUST_ID=#{USERID} and (b.CUST_ID =substr(a.PAY_AC_NO,0,14))
        </sql>
        <sql name="UpdSts"> <!-- 更新转账订单表 -->
            UPDATE StpTraInf set OrdStatus='01',ClearDat=#{ActDat} WHERE batNo=#{BatNo} and traOrdNo=#{TraNo}
        </sql>
        <sql name="QryPassInf"><!-- 查询客户支付密码信息-->
            SELECT PASSWORD,CUST_ID FROM ARP_AC_CUST_REL WHERE PAY_AC_NO=#{PAYNO}
        </sql>
        <sql name="QryGetAccNo"><!-- 查询客户账户信息:帐号-->
            select a.CUST_ID as TGetAccNo,c.CUST_NAME as TGetAccNam from ARP_AC_CUST_REL a,STPUSRINF b,STPCUSINF c where b.CUST_LOGIN=#{TGetAccNo} and b.CUST_ID =a.CUST_ID and b.CUST_ID=c.CUST_ID
        </sql>
        <sql name="QryTraInf"> <!--查询转账订单信息 -->
            select TXAMT,OrdStatus as ORDSTA,CUST_ID as CUSTIDS from StpTraInf where BATNO=#{BatNo} and traOrdNo=#{TraNo}
        </sql>
        
        
        <!--校验手机验证码需要-->
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>   
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random,TimeOut
            FROM STPVERIFY 
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="PAYPWD:G_RANDOM"/>
            <quote name="ParseRequestParams"/>
            
            <quote name="usrChk"/>
            
            <if condition="ISNUMBER(UsrMp)">
                <set name="RANDUSRMP"  expr="UsrMp"/>
            </if>
            <esle>
                <set name="RANDUSRMP"  expr="usr_mobile"/>
            </esle>
            <!--校验手机验证码-->
            <quote name="chkRandom"/>
            
            <!-- 检查支付密码是否冻结 -->
            <set name="RCS_PWD_TYPE"        value="3"           />
            <set name="RCS_USER_CODE"       expr="USERID"        />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"     />
            <set name="RCS_PRD_NO"          value=""            />
            <set name="RCS_TCODE"           value="5"           />
            <set name="RCS_STATUS"          value="0"           />
            <quote name="tranPwdLock"/>
            
            <quote name="chkAcc"/>
            <quote name="getPublicInfo"/>
            <!--验证用户认证状态-->
            <if condition="IS_NOEQUAL_STRING(USRSTATUS,'2')">
                <set name="RspCod"    value="20019"/>
                <set name="RspMsg"    value="您目前未进行身份认证,请提交认证资料通过后再进行转账！"/>
                <return/>
            </if>
            
            <do func="ReadRecord" error="IGNORE"><!--这里需要检查订单-->
               <para name="SqlCmd" sql="QryTraInf" />
            </do>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="07001"/>
               <set name="RspMsg"    value="该转账订单信息不存在"/>
               <return/>
            </if>
            <else>
               <if condition="IS_NOEQUAL_STRING(ORDSTA,'00')">
                <set name="RspCod"    value="20014"/>
                <set name="RspMsg"    value="订单状态不可进行继续付款"/>
                <return/>
               </if>
            </else>
            
            <if condition="IS_NOEQUAL_STRING(CUSTIDS,USERID)">
              <set name="MsgTyp"    value="E"/>
              <set name="RspCod"    value="01002"/>
              <set name="RspMsg"    value="转账订单非当前登陆用户发起！非法调起失败"/>
              <return/>
            </if>
            
            <set name="CASH_AC_BAL"     expr="CASH_AC_BAL"  />
            <!--验证可转金额是否大于转账金额-->
            <if condition="DOUBLECMP(TXAMT,6,CASH_AC_BAL)">
                <set name="RspCod"    value="20014"/>
                <set name="RspMsg"    value="转账金额大于账户余额！"/>
                <return/>
            </if>
            
            <!--校验支付密码-->
            <set name="PAYNO"      expr="PAY_AC_NO"/><!--上面执行了SelAccInf查询了PAY_AC_NO-->
            <set name="paypwd"     expr="PAYPWD"/>
            <quote name="chkPayPwd"/>
               
            <!--限额检查  start --> 
            <set name="Amt"           expr="TXAMT"/> <!--交易金额-->
            <set name="PAY_TYPE"      value="04"/><!--支付方式 01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
            <set name="TRAN_TYPE"     value="6"/><!--交易类型 0 其他 1 充值 2消费 3撤销 4预授权完成 5预授权完成撤销 6转账(虚拟帐号间) 7提现 8退款-->
            <set name="cust_type"     value="1"/>  <!--效验客户类型(1用户 2 商户 0 两者)-->
            <set name="User_code"     expr="USERID"/><!--用户编号-->
            <set name="Time"          expr="GETDATETIME()"/>
            <set name="DATE"          expr="GETDATE()"/>
            <set name="ServiceCode"   value="680518"/>  
            <quote name="chkLimAmt"/>
            <!--限额检查   end-->
               
            <!--转账-->
            <set name="payacno"     expr="PAY_AC_NO"/><!--转出账号-->
            <set name="BatNo"       expr="batNo"/><!--批次号-->
            <!--检查转入账号信息-->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryGetAccNo" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"    value="009992"                />
                <set name="RspMsg"    value="转入用户帐号信息不存在"/>
                <return/>
            </if>
            
            <!--准备转账记账数据-->
            <set name="usrPar"      expr="STRCAT(CUST_ID,'/','01','/','-','/','CNY','/',AMT,'/','Y','/')"/>     <!--转出方记账参数-->
            <set name="usrParRev"   expr="STRCAT(TGetAccNo,'/','01','/','+','/','CNY','/',AMT,'/','Y','/')"/>   <!--转入方记账参数-->
            <set name="PARAMS"      expr="STRCAT(usrParRev,',',usrPar)"/>
            <!--记账处理-->
            <set name="TXN_TYP"      value="3"/>      <!--用途 3 转账-->
            <set name="prdordno"     expr="traordno"/>
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="08060"/>
               <set name="RspMsg"    value="转账失败"/>
               <return/>
            </if>
            
            <!--更新订单状态-->
            <set name="BatNo"    expr="batNo"/>
            <do func="ExecSql" error="IGNORE">
               <para name="SqlCmd" sql="UpdSts"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09999"/>
               <set name="RspMsg"    value="数据库操作错误"/>
               <return/>
            </if>
                  
            <!--通知风控系统登记订单信息-->
            <set name="ServiceCode" value="680517"/>
            <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
            <set name="TCODE"       expr="TraNo"/>           <!--平台流水号 转账订单号-->
            <set name="CTYPE"       value="1"/>                 <!--客户类型-->
            <set name="CLIENTCODE"  expr="USERID"/>     <!--客户编号-->
            <set name="CLIENTNAME"  expr="USERID"/>
            <set name="MOBILEPHONE" expr="USRMP"/>
            <set name="TRANTYPE"    value="6"/>                 <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
            <set name="TAMT"        expr="TXAMT"/>
            <set name="REGDTTIME"   expr="GETDATETIME()"/>
            <set name="Time"        expr="SUBSTR(REGDTTIME,1,8)"/>
            <quote name="noticRcs"/>
            
            <set name="RCS_USER_CODE"       expr="USERID"            />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
            <set name="RCS_PRD_NO"          expr="traOrdNo"         />
            <set name="RCS_TCODE"           value=""                />
            <set name="RCS_STATUS"          value="1"               />
            <quote name="tranByRightTime"/>

            <set name="MsgTyp"    value="N"/>
            <set name="batNo"     expr="batNo"/>
            <set name="RspCod"    value="000000"/>
            <set name="RspMsg"    value="交易成功"/>
        </process>
    </transaction>
    
    <transaction code="800048" desc="移动端自定义头像">
        <!--查询用户信息 -->
        <sql name="QryCusInf"><!-- 查询客户信息-->
            SELECT cus.CUST_STATUS,cus.CUST_ID as USERID,usr.USR_STATUS as USRSTATUS FROM STPUSRINF usr,STPCUSINF cus WHERE usr.CUST_ID = cus.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="UpdateUserById"> 
            UPDATE STPUSRINF SET REV_FLAG=#{CRED_PHOTO_FRONT} WHERE CUST_ID=#{CUST_ID}
        </sql>
        <process>
            <set name="sPwds"    value=""/>
            
            <!--用户手机号 非空 -->
            <if condition="OR(ISNULL(USRMP),IS_EQUAL_STRING(USRMP,''))">
                <set name="RspCod"    value="00029"/>
                <set name="RspMsg"    value="登录超时，请重新登录!"/>
                <return/>
            </if>
            <if condition="OR(ISNULL(HEAD),IS_EQUAL_STRING(HEAD,''))">
                <set name="RspCod" value="02100" />
                <set name="RspMsg" value="请上传证件图片!" />
                <return />
            </if>
            <quote name="usrChk"/> 
            
            <set name="CUST_ID"     expr="USERID"/>     <!-- 客户ID -->
            
            <set name="ConfigName"   value="uploadImgConfig"/>
            <quote name="ReadXmlCfg"/>
            
            <set name="phone"            expr="phone"/> <!-- 图片保存路径 -->
            <set name="CRED_PHOTO_FRONT"  expr="STRCAT(CUST_ID,'hd.png')"/>  <!-- 身份证正面 -->
               
            <!--上传头像-->
            <do func="Str2ImgSure" error="IGNORE">
                <para name="Base64String"   expr="HEAD"/>
                <para name="Path"           expr="phone" />
                <para name="fileName"       expr="CRED_PHOTO_FRONT" />
            </do>
            
            <!--更新用户信息表 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="UpdateUserById" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod" value="02100" />
                <set name="RspMsg" value="用户信息有误" />
                <return />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod" value="02100" />
                <set name="RspMsg" value="系统操作有误" />
                <return />
            </elseif>
            
            <set name="RspCod" value="000000" />
            <set name="RspMsg" value="上传成功" />
        </process>
    </transaction>

    <transaction code="800049" desc="移动端进行身份认证图片上传">
        <!--查询用户信息 -->
        <sql name="QryCusInf"><!-- 查询客户信息-->
            SELECT cus.CUST_STATUS,cus.CUST_ID as USERID,cus.CUST_CRED_NO,cus.CUST_NAME as usrname,USR_STATUS as USRSTATUS 
            FROM STPUSRINF usr,STPCUSINF cus 
            WHERE usr.CUST_ID = cus.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="updateUsrInf">  <!--更新用户信息表-->
            UPDATE STPUSRINF
            SET CRED_PHOTO_FRONT = #{image_front},CRED_PHOTO_BACK = #{image_back},SEND_TYPE = '1',USR_STATUS = '1',PUBLIC_PHOTO=#{PUBLIC_PHOTO} , PUBLIC_STATUS=#{vailStatus}
            WHERE CUST_ID = #{CUST_ID}
        </sql>
        <sql name="updateCusInf"> <!--更新客户主档案表-->
            UPDATE STPCUSINF 
            SET CUST_CRED_TYPE = #{CUST_CRED_TYPE},CUST_CRED_NO = #{CUST_CRED_NO}
            WHERE CUST_ID=#{CUST_ID}
        </sql>
        <process>
            <set name="sPwds"    value=""/>
            
            <!--
              传入参数：
                  客户id cust_id
                  手机号  UsrMp  
                  证件类型  IdTypeCod
                  证件号码  IDCARDNUM 
                  正面图片  fileupload1
                  背面图片  fileupload2
                  认证方式  sendType
            -->

            <!--用户手机号 非空 -->
            <if condition="OR(ISNULL(USRMP),IS_EQUAL_STRING(USRMP,''))">
                <set name="RspCod"    value="00029"/>
                <set name="RspMsg"    value="登录超时，请重新登录!"/>
                <return/>
            </if>
            <if condition="OR(ISNULL(IDTYPECOD),IS_EQUAL_STRING(IDTYPECOD,''))">
                <set name="RspCod" value="02100" />
                <set name="RspMsg" value="证件类型不能为空！" />
                <return />
            </if>
            <set name="CUST_CRED_TYPE" expr="IDTYPECOD"/>
            <if condition="OR(ISNULL(IDCARDNUM),IS_EQUAL_STRING(IDCARDNUM,''))">
                <set name="RspCod" value="02100" />
                <set name="RspMsg" value="证件号码不能为空" />
                <return />
            </if>
            <set name="CUST_CRED_NO" expr="IDCARDNUM"/>
            <if condition="OR(ISNULL(fileupload1),IS_EQUAL_STRING(fileupload1,''))">
                <set name="RspCod" value="02100" />
                <set name="RspMsg" value="请上传身份证正面图片!" />
                <return />
            </if>
            <if condition="OR(ISNULL(fileupload2),IS_EQUAL_STRING(fileupload2,''))">
                <set name="RspCod" value="02100" />
                <set name="RspMsg" value="请上传身份证背面图片!" />
                <return />
            </if>
            <set name="CUST_ID" expr="USRID"/>
            
            <!--查询客户是否存在-->
            <quote name="usrChk"/> 
            <!-- 校验手机端传输身份证号码，加密校对   addby20150902 -->
            <set name="IDCARDNUMDES"         expr="DES_ENCRYPT(IDCARDNUM)"  />
            
            <if condition="IS_NOEQUAL_STRING(CUST_CRED_NO,IDCARDNUMDES)">
               <set name="RspCod" value="02101" />
               <set name="RspMsg" value="请输入注册时证件号码" />
               <return/>
            </if>
          
            <set name="CUST_ID"     expr="USERID"/>     <!-- 客户ID -->
            
            <set name="ConfigName"   value="uploadIdImageConfig"/>
            <quote name="ReadXmlCfg"/>
            
            <set name="resinDir"            expr="resinDir"/> <!-- 图片保存路径 -->
            <set name="image_front"  expr="STRCAT(USERID,'_USER_FRONT_','front.jpg')"/>  <!-- 身份证正面 -->
            <set name="image_back"  expr="STRCAT(USERID,'_USER_FRONT_','back.jpg')"/>  <!-- 身份证正面 -->   
            <!--上传正面-->
            <do func="Str2ImageFile" error="IGNORE">
                <para name="imgStr"   expr="fileupload1"/>
                <para name="dir"           expr="resinDir" />
                <para name="fileName"       expr="image_front" />
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod" value="03100" />
                <set name="RspMsg" value="正面图片上传失败!" />
                <return />
            </if>
            <delete name="fileupload1"/>
            <!--上传背面-->
            <do func="Str2ImageFile" error="IGNORE">
                <para name="imgStr"   expr="fileupload2"/>
                <para name="dir"           expr="resinDir" />
                <para name="fileName"       expr="image_back" />
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod" value="03100" />
                <set name="RspMsg" value="图片背面上传失败!" />
                <return />
            </if>
            <delete name="fileupload2"/>
            
            
            
            <set name="USR_STATUS"       value="1"/><!-- 认证状态 0：未认证 1：审核中 2：已通过  3：未通过 -->  
            <set name="PUBLIC_PHOTO"     value="upload/defaultShow.jpg"/><!-- 公安返回照片 -->  
            
            <!-- 读取配置文件 到公安部身份验证核实 --> 
            <do func="ReadModuleCfg" error="IGNORE"> 
              <para name="cfgfil" value="etc/STP_BUSCFG.XML"/>  
              <para name="code" value="CHK"/> 
            </do>  
            <if condition="IS_EQUAL_STRING(#para.ChkType,'1')"> 
              <if condition="IS_EQUAL_STRING(IDTYPECOD,'0')"> 
                <set name="RspMsg"        value="用户为身份证用户"/>
                <do func="validIdCard"    error="IGNORE">
                  <para name="name"       expr="usrname"/>
                  <para name="idCardNo"   expr="IDCARDNUM"/>
                </do>
                <if condition="#RetCod==0">
                  <set name="RspMsg"    value="身份认证成功"/>
                  <set name="vailStatus"   expr="status"/>
                  <if condition="IS_EQUAL_STRING(status,'1')">
                    <set name="vailCardUrl"  expr="picPath"/>
                  </if>
                  <else>
                    <!--默认图片展示-->
                    <set name="vailCardUrl"  value="upload/defaultShow.jpg"/>
                  </else>
                </if>
                <else>
                  <set name="vailStatus"   value="-1"/>
                  <set name="RspCod"    value="07565"/>
                  <set name="RspMsg"    value="姓名和身份证不符！"/>
                  <set name="PUBLIC_PHOTO"     value="upload/defaultShow.jpg"/><!-- 公安返回照片 -->  
                </else>

                <set name="PUBLIC_PHOTO"     expr="vailCardUrl"/><!-- 公安返回照片 -->  
                
              </if> 
            </if>  
            
            
            <!--更新用户信息表 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="updateUsrInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod" value="02100" />
                <set name="RspMsg" value="用户信息有误" />
                <return />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod" value="02100" />
                <set name="RspMsg" value="更新用户信息系统操作有误" />
                <return />
            </elseif>
           <!--更新客户主档案表 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="updateCusInf" />
           </do>
            <if condition="#RetCod==2">
                <set name="RspCod" value="02100" />
                <set name="RspMsg" value="客户信息有误" />
                <return />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod" value="02100" />
                <set name="RspMsg" value="更新客户信息系统操作有误" />
                <return />
            </elseif>
            
            
            <set name="RspCod" value="000000" />
            <set name="RspMsg" value="上传成功" />
        </process>
    </transaction>
    
    <transaction code="800050" desc="获取公告信息">
      <!--查询银行列表 -->
        <sql name="Qurynotice">
          select  NOTICE_ID,NOTICE_TITLE,NOTICE_CONTENT,NOTICE_UPD_DATE  from NOTICE where   Notice_Status ='0'
        </sql> 
        <process>
            <!--类型 非空 -->
            <do func="QueryInGroup" error="IGNORE">
                    <para name="SqlCmd"      sql="Qurynotice" />
                   <para name="RecordName"   value="NODE"/>
                </do>
     
               <if condition="#RetCod==2">
                   <set name="RspCod" value="00002" />
                   <set name="RspMsg" value="无记录" />
                   <return />
               </if>
              <elseif condition="#RetCod!=0">
                   <set name="RspCod" value="02100" />
                   <set name="RspMsg" value="数据操作失败!" />
                   <return />
              </elseif>
                <set name="returnNames"    value="NODE"/>
              <set name="RspCod"     value="000000"/>
                <set name="RspMsg"     value="获取信息成功!" />
         </process>
    </transaction>
    
    <transaction code="800051" desc="版本自动更新"><!--add by gyl 20150407-->
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value=""/>
            <quote name="ParseRequestParams"/>
            <if condition="ISNULL(type)">
               <set name="RspCod"     value="000123"/>
              <set name="RspMsg"     value="参数类型为空!" />
              <return/>
            </if>
            
            <!--取公共参数配置-->
            <set name="ConfigName"   value="selfUpdateApi"/>
            <quote name="ReadXmlCfg"/>
                 
            <do func="SelfUpdate" error="IGNORE">
              <para name="url"         expr="updateApp_url"/>
              <para name="parameter"   expr="STRCAT('TYPE=',type)" />
            </do>
            <if condition="#RetCod==0">
               <set name="versionInfo"  expr="versionInfo"/><!--返回的版本信息-->
               <if condition="NOT(ISNULL(versionInfo))">
                 <set name="appId" expr="SUBSTR(versionInfo,'0',SUB(GETSTRPOS(versionInfo,','),1))"/>
                 <set name="appNo" expr="SUBSTR(versionInfo,ADD(GETSTRPOS(versionInfo,','),1),SUB(STRLEN(versionInfo),GETSTRPOS(versionInfo,',')))"/>
               </if>
               <if condition="IS_EQUAL_STRING(type,'ios')">
                   <set name="appNo" expr="SUBSTR(appNo,ADD(GETSTRPOS(appNo,'_V'),2),'4')"/>
                   <set name="appUpdateUrl" expr="STRCAT(updateApp_geturl_ios,'SWT_V',appNo,'Beta.plist')"/>
               </if>
               <elseif condition="IS_EQUAL_STRING(type,'android')">
                   <set name="appNo" expr="SUBSTR(appNo,ADD(GETSTRPOS(appNo,'_V'),2),'4')"/>
                   <set name="appUpdateUrl" expr="updateApp_geturl"/>
               </elseif>
               <else>
                  <set name="RspCod"     value="000123"/>
                 <set name="RspMsg"     value="参数类型错误!" />
                 <return/>
              </else>
            </if>
            <else>
              <set name="MsgTyp"        value="E"/>
              <set name="RspCod"        value="09999"/>
              <set name="RspMsg"        value="获取最新版本信息失败"/>
              <return/>
            </else>
           
            <set name="RspCod"     value="000000"/>
           <set name="RspMsg"     value="获取版本信息成功!" />
         </process>
    </transaction>
    
    <transaction code="800052" desc="用户充值">
        <sql name="UpdPay"> <!-- 更新支付订单表 -->
            payOrdNo=#{payOrdNo}
        </sql>
        <sql name="UpdReg"> <!-- 更新充值订单表 -->
            prdordno=#{PrdOrdNo} and prdOrdType='1'
        </sql> 
        <sql name="QryRegInf"> <!-- 查询充值订单 -->
            select prdOrdNo from StpPrdInf where prdordno=#{prdordno} and prdOrdType='1'
        </sql>
        <sql name="QryCusInf"><!-- 查询客户信息-->
            SELECT CUST_STATUS FROM StpCusInf WHERE CUST_ID=#{USERID}
        </sql>
        <sql name="SelAccInf"><!-- 查询客户账户信息-->
            SELECT a.AC_STATUS,a.PAY_AC_NO as payacno FROM ARP_AC_PROFILE a,ARP_AC_CUST_REL b WHERE b.CUST_ID=#{USERID} AND a.PAY_AC_NO=b.PAY_AC_NO
        </sql>
        <sql name="QryUsrInf"><!-- 查询客户信息-->
            SELECT CUST_LOGIN,CUST_ID AS USRID,usr_mobile  FROM StpUsrInf WHERE CUST_LOGIN=#{USRMP}
        </sql>
        <sql name="QryPassInf"><!-- 查询客户支付密码信息-->
            SELECT PASSWORD,CUST_ID FROM ARP_AC_CUST_REL WHERE PAY_AC_NO=#{PAYACNO}
        </sql>
        <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
            SELECT CASH_AC_BAL,FROZ_BALANCE FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNO}
        </sql>
        <!--校验手机验证码需要-->
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>   
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random,TimeOut
            FROM STPVERIFY 
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="PAYPWD:G_RANDOM"/>
            <quote name="ParseRequestParams"/>

            <if condition="IS_EQUAL_STRING(UsrMp,'')">
                <set name="RspCod"       value="02035"      />
                <set name="RspMsg"       value="手机号为空" />
                <return/>
            </if>
            <!--针对快捷支付的银行卡号-->
            <if condition="IS_EQUAL_STRING(BANKCARDNO,'')">      
                <set name="RspCod"       value="02035"          />
                <set name="RspMsg"       value="银行卡号为空"   />
                <!--return/-->
            </if>
            
            <!-- 查询银行号缩写 -->
            <set name="bankCard"    expr="BANKCARDNO"/>
            <do func="GetCrdInfo" error="IGNORE">
                <para name="CrdNo"  expr="bankCard" />
            </do>
            <if condition="#RetCod!=0">
                <set name="bankcode"    value=""/>
            </if>
            <set name="BANKCODE"      expr="ISSNO" />
            <if condition="OR(IS_EQUAL_STRING(TXCHANNEL,''),IS_EQUAL_STRING(PAYPWD,''),IS_EQUAL_STRING(TXAMT,''),IS_EQUAL_STRING(bankcode,''))">
                <set name="RspCod"      value="02036"      />
                <set name="RspMsg"      value="传送参数不完整" />
                <!--return/-->
            </if>
            
            <!--查询用户信息
                SELECT CUST_LOGIN,CUST_ID AS USRID,usr_mobile  FROM StpUsrInf WHERE CUST_LOGIN=#{USRMP}
            -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"    value="09992"/>
                <set name="RspMsg"    value="用户信息不存在"/>
                
                <set name="RCS_USER_CODE"       expr="USRID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="用户信息不存在"  />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            <if condition="#RetCod!=0">
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                
                <set name="RCS_USER_CODE"       expr="USRID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
                <set name="RCS_PRD_NO"          value=""                />
                <set name="RCS_TCODE"           value="数据库操作"      />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if>
            
            <set name="userId"     expr="USRID"/>   <!--用户ID-->
            
            
            <if condition="ISNUMBER(UsrMp)">
                <set name="RANDUSRMP"  expr="UsrMp"/>
            </if>
            <esle>
                <set name="RANDUSRMP"  expr="usr_mobile"/>
            </esle>
            <!--校验手机验证码-->
            <!--quote name="chkRandom"/-->
            
            <!-- 检查支付密码是否冻结 -->
            <set name="RCS_PWD_TYPE"        value="3"           />
            <set name="RCS_USER_CODE"       expr="userId"        />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"     />
            <set name="RCS_PRD_NO"          value=""            />
            <set name="RCS_TCODE"           value="5"           />
            <set name="RCS_STATUS"          value="0"           />
            <!--quote name="tranPwdLock"/-->
            
            <quote name="usrChk"/>
            <quote name="chkAcc"/>
            
            <set name="txnDat"     expr="TACCDT"/>
            <set name="orderNo"    value=""/>
            <set name="txnAmt"     expr="txAmt"/>
            <!--校验支付密码-->
            <set name="paypwd"     expr="paypwd"/>
            <!--quote name="chkPayPwd"/-->
            
            <!--限额检查 start--> 
            <set name="TXCHANNEL"     expr="TXCHANNEL"/>
            <set name="payType"       expr="TXCHANNEL"/>
            <set name="CredNo"        expr="BANKCARDNO"/>
            <set name="Filed1"        expr="FILED"/>
            <set name="PAY_TYPE"      value="05"/>    <!--  限额检查接口，05为快捷支付-->
            <set name="txAmt"         expr="AMTPOWER(TXAMT,2)"/>    <!--交易金额-->
            <set name="Amt"           expr="txAmt"/>
            <set name="User_code"     expr="USRID"/>
            <set name="comp_code"     value=""/>
            <set name="cust_type"     value="1"/>  
            <set name="Time"          expr="GETDATETIME()"/>
            <set name="DATE"          expr="GETDATE()"/>
            <set name="TRAN_TYPE"     value="1"/>
            <set name="ServiceCode"   value="680518"/>
            <!--quote name="chkLimAmt"/-->
            <!--限额检查   end--> 
            
            <!--  首次充值，要建立充值订单  -->
            <set name="ordstatus"    value="00"/>                 <!--  默认状态为待付款  -->
            <set name="custRptAcNo"  expr="PAYACNO"/>             <!--充值账号-->
            <set name="ordCcy"       value="CNY"/>
            <set name="ordAmt"       expr="txAmt"/>
            <set name="orderTime"    expr="GETDATETIME()"/>
            <set name="PrdOrdType"   value="1"/>                  <!--商品订单类型 1 充值-->
            <set name="bizType"      value="01"/>                 <!--业务类型 01 充值-->
            <set name="BANKCOD"      expr="BANKCODE"/> 
            <set name="CUST_ID"      expr="USERID"/>
            <set name="prdName"      value="充值"/>               <!-- 商品名称 --> 
            <set name="defPayWay"    value="3"/>                  <!--快捷支付-->
            <!-- 获取序号 -->
            <do func="GetSeqNo"  error="IGNORE">
                <para name="TblNam" value="stpseqrec"/>
                <para name="KeyNam" value="KeyNam"/>
                <para name="KeyVal" expr="STRCAT('StpPrdInf','SeqNo')"/>
                <para name="SeqNam" value="KeyVal"/>
                <para name="Len"    value="8"/>
                <para name="Circle" value="1"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09001"/>
                <set name="RspMsg"    value="获取序号错误"/>
                <return/>
            </if>
            <set name="SeqNo"        expr="STRCAT(SUBSTR(ActDat,2,7),KeyVal)"/>   <!--商品订单表序号-->
            
            <do func="GetSeqNo"  error="IGNORE">
                <para name="TblNam" value="stpseqrec"/>
                <para name="KeyNam" value="KeyNam"/>
                <para name="KeyVal" expr="STRCAT('StpPrdInf','PrdOrdNo')"/>
                <para name="SeqNam" value="KeyVal"/>
                <para name="Len"    value="8"/>
                <para name="Circle" value="1"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09001"/>
                <set name="RspMsg"    value="获取序号错误"/>
                <return/>
            </if>
            <set name="prdordno"    expr="STRCAT(ActDat,KeyVal)"/>    <!--商品订单号-->
            <set name="MERNO"       value=" "/>                       <!--商品订单商户号为空-->
            <do func="InsertRecord" error="IGNORE">
                <para name="TblNam"  value="StpPrdInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                
                <set name="RCS_USER_CODE"       expr="USRID"            />
                <set name="RCS_PAY_TYPE"        expr="TRANCODE"         />
                <set name="RCS_PRD_NO"          expr="prdordno"         />
                <set name="RCS_TCODE"           value="数据库操作"      />
                <set name="RCS_STATUS"          value="0"               />
                <quote name="tranByRightTime"/>
                <return/>
            </if> 
                    
            <!--获取序号 -->
            <do func="GetSeqNo"  error="IGNORE">
                <para name="TblNam" value="stpseqrec"/>
                <para name="KeyNam" value="KeyNam"/>
                <para name="KeyVal" expr="STRCAT('StpPayInf','PayOrdNo',GETDATE())"/>
                <para name="SeqNam" value="KeyVal"/>
                <para name="Len"    value="8"/>
                <para name="Circle" value="1"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09001"/>
                <set name="RspMsg"    value="获取序号错误"/>
                <return/>
            </if>
            <set name="payOrdNo"    expr="STRCAT('P',SUBSTR(ActDat,2,7),KeyVal)"/>
            
            <set name="txAmt"       expr="txAmt"/>  
            <set name="txCcy"       value="CNY"/> 
            <set name="ordstatus"   value="00"/>
            <!--此处暂时考虑银联wap支付一种情况故银行编码设为UPOP-->
            <if condition="ISNULL(BANKCODE)">
              <set name="BANKCOD"   value="01010000"/>
              <set name="BANKCODE"   value="01010000"/>
            </if> 
            <set name="PrdOrdNo"    expr="PrdOrdNo"/> <!-- 充值，支付订单中的商品订单号即为充值订单号  -->  
            <set name="ActDat"      expr="GETDATETIME()"/>
            
            <do func="InsertRecord" error="IGNORE">
                <para name="TblNam"  value="StpPayInf"/>
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="09999"/>
                <set name="RspMsg"    value="数据库操作错误"/>
                <return/>
            </if>
            
            <set name="orderId"      expr="payOrdNo"/>
            <set name="txnAmt"       expr="AMTADDDOT(ordAmt)"/>  
            <set name="txnTime"      expr="ActDat"/>
            
            <!--跳转银联支付-->
            <quote name="SendInb"/>
            
            <set name="UPOPWAPPAYURL" expr="UPOPWAPPAYURL"/> 
            
            <set name="RspCod"    value="000000"/>
            <set name="RspMsg"    value="创建订单成功"/>
        </process>
    </transaction>
    
    <transaction code="888889"   desc="支付成功后跳转">
      <sql name="queryPrdinf">
        select NotifyUrl from stpprdinf where prdordno=#{PRDORDNO} and merno=#{MERNO2}
      </sql>
      <sql name="qryPrdinfIcbc">
        select prdordno,MERREMARK,ordamt from stpprdinf where payordno=#{ORDERID}
      </sql>
      <sql name="queryPrdInfCmbc">
        select prdordno,MERREMARK,ordamt from stpprdinf where payordno=#{out_trade_no}
      </sql>
      <process>
         <!--do func="FrontRcvResponse"     error="IGNORE" />
         <if condition="#RetCod!=0">
           <set name="RspCod"    value="09002"/>
           <set name="RspMsg"    value="银联返回验证失败"/>
           <return/>
         </if-->
         <set name="PRDORDNO" expr="ORDERID"/>
         <set name="SUCDAT"       expr="TXNTIME"/>
         <set name="AMOUNT"       expr="AMTADDDOT(TXNAMT)"/>
         <if condition="ISNULL(MERREMARK)">
            <set name="MERREMARK"    value="商物通支付"/>
         </if>
         <set name="_REQUESTATTR.FORWARDURL"       value="/cashier/html/result/bankRetHtml.jsp"/>
      </process>
    </transaction>
    
    <!-- 第三方免登陆接口 -->
    <transaction code="800058" desc="第三方免登陆接口">
        <sql name="QueryUsrThere">
            SELECT CUST_ID,CUST_ID as CUSTIDS,CUST_PWD  FROM STPUSRINF WHERE CUST_LOGIN = #{USRMP}
        </sql>
        <!--*****************增加用户手机在线状态判断 ***********-->
        <!--sql name="UpdateUsrStaus" --><!-- 登录成功之后状态改为在线，插入最后操作时间,更新用户密钥 -->
           <!-- UPDATE STPUSRINF SET IS_LOGIN_FLAG='1',LAST_OPER_TIME=#{OPERTIME},SIGNMD5KEY=#{SIGNKEY} WHERE CUST_LOGIN = #{USRMP}
        </sql -->
        <sql name="UpdateUsrStaus"><!-- 登录成功之后,更新用户密钥,登录状态 by20150901 -->
           UPDATE STPUSRINF SET IS_LOGIN_FLAG='1', SIGNMD5KEY=#{SIGNKEY} WHERE CUST_LOGIN = #{USRMP}
        </sql>
        <sql name="UpdateUsrSucTime"><!-- 登录成功之后,更新最后成功登录时间 by20150901 -->
           UPDATE STPCUSLOG set PRE_LOG_SUC_TIM = #{OPERTIME} WHERE CUST_ID = #{CUSTIDS}
        </sql>
        <!--***************** 增加用户手机在线状态判断 ***********-->
        <sql name="QueryUsrInfos">
            SELECT usr.CUST_ID USRID,cus.CUST_NAME USERNAME,cus.CUST_CRED_TYPE IDTYPECOD,cus.CUST_CRED_NO USERNO,
                   usr.USR_EMAIL EMAIL,usr.USR_STATUS,usr.EMAIL_STATUS,usr.USR_MOBILE  
            FROM STPUSRINF usr,STPCUSINF cus 
            WHERE usr.CUST_ID = cus.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
        </sql>
        <!--校验手机验证码需要-->
        <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
            DELETE FROM STPVERIFY  
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>   
        <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,InsTim,Random,TimeOut
            FROM STPVERIFY 
            WHERE VER_ID=#{RANDUSRMP} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
        </sql>
        <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
            SELECT 
            EXTRACT(DAY FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*24*60 + EXTRACT(HOUR FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*60 +  EXTRACT(MINUTE FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND )) as timeDifference,
            CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
            FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
            INSERT INTO STPLOGTMP
            (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
            VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
        </sql>
        <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
            LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
            WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="QryBind"><!--查询绑定信息 -->
			SELECT A.CUST_LOGIN USRMP, A.PWD_KEY,B.CUST_ID CUSTIDS
			  FROM STPCHNBIND A, STPUSRINF B
			 WHERE A.CUST_LOGIN = B.CUST_LOGIN
			   AND A.BIND_STATUS = '0'
			   AND A.LOGIN_ID = #{custId}
			   AND A.CHN_TYP = #{chnTyp}
		</sql>
        <process>
            <!-- 对APP数据进行解密 -->
            <set name="sPwds"    value="USRPWD:G_RANDOM"/>
            <!-- 增加用户手机在线状态判断 -->
            <quote name="ParseRequestParamsNoCheckStatus"/>
            
            <set name="custId" expr="LOGIN_ID" />
			<set name="chnTyp" expr="CHN_TYP" />
			<set name="pwdKey" expr="PWD_KEY" />
			<if condition="ISNULL(custId)">
                <set name="RspCod"        value="002035"        />
                <set name="RspMsg"        value="第三方帐号（LOGIN_ID）不能为空"/>
                <return/>
            </if> 
            <if condition="ISNULL(chnTyp)">
                <set name="RspCod"        value="002035"        />
                <set name="RspMsg"        value="渠道号（CHN_TYP）不能为空"/>
                <return/>
            </if> 
            <if condition="ISNULL(pwdKey)">
                <set name="RspCod"        value="002035"        />
                <set name="RspMsg"        value="第三方密钥（PWD_KEY）不能为空"/>
                <return/>
            </if>
             <!-- 验签处理 -->
            <set name="signType"        value="CFCA"/>
	        <if condition="IS_EQUAL_STRING(signType,'CFCA')"> 
	            <set name="INSTR"  expr="STRCAT('LOGIN_ID=',custId,'&amp;PWD_KEY=',PWD_KEY)"/>
	            <!--CACA验签-->
	            <do func="CFCASignVer">
	               <para name="sourceData"        expr="INSTR" />
	               <para name="signData"          expr="SIGNATURE" />
	            </do>
	            <if condition="#RetCod!=0">
	               <set name="RspCod"    value="08039"/>
	               <set name="RspMsg"    value="验签失败"/>
	               <return/>
	            </if>
	         </if>
			<!-- 确认绑定关系 -->
			<do func="ReadRecord" error="IGNORE">
				<para name="SqlCmd" sql="QryBind" />
			</do>
			<if condition="#RetCod!=0">
				<set name="MsgTyp" value="E" />
				<set name="RspCod" value="02008" />
				<set name="RspMsg" value="用户绑定关系不存在！" />
				<return />
			</if>
			
			<!-- 判断密钥 -->
            <if condition="IS_NOEQUAL_STRING(DELBOTHSPACE(PWD_KEY),DELBOTHSPACE(pwdKey))">
                <set name="RspCod" value="002036" />
                <set name="RspMsg" value="密钥不正确!" />
                <return/>
            </if>
            
            <set name="sPwds"    expr="DELBOTHSPACE(USRMP)"/>
            
            <!-- 用户登录密码锁定次数判断 -->
             <set name="USER_ID" expr="DELBOTHSPACE(USRMP)" />
             <set name="CUSTTYPE"  value="0"/><!--0用户1 商户 2企业-->
             <set name="PWDTYPE"   value="0"/><!--0:登录密码 1:支付密码-->
             <set name="FailFlag"  value="0"/>
             <quote name="usrpwdlock"/>
             <!-- 用户登录密码锁定次数判断 -->
            
            <!--  查询用户信息  -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"   sql="QueryUsrInfos" />
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod"        value="999999"/>
                <set name="RspMsg"        value="数据库错误！"/>
                <return/>
            </if>
            <if condition="#RetCod!=0">
                <set name="RspCod"        value="002008"/>
                <set name="RspMsg"        value="用户信息不存在"/>
                <return/>
            </if>
            
            <!-- 修改登记失败信息表 -->
            <do func="ExecSql" error="IGNORE">
               <para name="SqlCmd" sql="UpdUsrLogInfo"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="RSPCOD" value="02040"/>
               <set name="RSPMSG" value="更新登录信息失败!"/> 
               <return/>
            </if>
            
            <set name="RspCod"        value="000000"  />
            <set name="RspMsg"        value="登录成功"/>
            
            <!-- 增加用户手机在线状态判断-->
            <quote name="InsOnlineTime"  desc="记住登录状态"/>
            
            <set name="RCS_USER_CODE"       expr="CUSTIDS"        />
            <set name="RCS_PAY_TYPE"        expr="TRANCODE"     />
            <set name="RCS_PRD_NO"          value=""            />
            <set name="RCS_TCODE"           value=""            />
            <set name="RCS_STATUS"          value="1"           />
            
        </process>
    </transaction>
    
    <!-- 开通银联代收 -->
    <transaction code="800060" desc="开通银联代收">
	<sql name="updateConfig">
		update stpbanktb set bank_conf='1',AUTH_CODE=#{bind_Id} where
		bak_seq=#{BAK_SEQ}
	</sql>
	<sql name="qrySamInfo">
		select BAK_SEQ as BANK_SEQ,CARD_NO,BANK_CONF from stpbanktb B,STPUSRINF u  where B.CUST_ID = U.CUST_ID AND U.CUST_LOGIN=#{userID}
		and card_no=#{qryCard}
	</sql>
	<process>
	
			<!-- 对APP数据进行解密 -->
	    <set name="sPwds"    value=""/>
	    <!-- 增加用户手机在线状态判断 -->
	    <!--<quote name="ParseRequestParamsNoCheckStatus"/>-->
		<quote name="ParseRequestParams"/>
        
        
		<!-- 检测用户登录状态 此交易必须是登录状态完成 -->
		<set name="userID" expr="USRMP" />
		
		<set name="cardno" expr="DES_DECRYPT(DELSPACE(CARDNO,'all'))" /><!-- 卡号 -->
		<set name="accNo" expr="cardno" />
		<set name="qryCard" expr="DES_ENCRYPT(accNo)" />

		<if condition="IS_EQUAL_STRING(cardno,'')">
			<set name="RspCod" value="01002" />
			<set name="RspMsg" value="请输入银行卡号" />
		</if>

		<do func="GetCrdInfo"><!-- 获取卡信息 -->
			<para name="CrdNo" expr="cardno" />
		</do>
		<if condition="#RetCod!=0">
			<set name="RspCod" value="01003" />
			<set name="RspMsg" value="系统不识别该卡，请换其他卡！" />
			<return />
		</if>
		<!-- 判断卡类型 -->
		<set name="BANKCARDTYPE" expr="SUBSTR(DCFLAG,2,1)" /><!-- 卡类型 01：借记卡  02：信用卡 -->
		<!-- 借记卡 -->
		<if condition="IS_EQUAL_STRING(BANKCARDTYPE,'1')">
			<set name="cardType" value="00" />
			<set name="cvn2" value="" />
			<set name="expired" value="" />
			<set name="customerNm" value="全渠道" />
		</if>
		<!-- 信用卡 -->
		<if condition="IS_EQUAL_STRING(BANKCARDTYPE,'2')">
			<set name="cardType" value="01" />
			<if condition="ISNULL(CVN2)">
				<set name="RspCod" value="01003" />
				<set name="RspMsg" value="CVN2不能为空！" />
				<return />
			</if>
			<if condition="ISNULL(EXPIRED)">
				<set name="RspCod" value="01003" />
				<set name="RspMsg" value="EXPIRED不能为空！" />
				<return />
			</if>
			<set name="cvn2" expr="CVN2" />
			<set name="expired" expr="EXPIRED" />
			<set name="customerNm" value="互联网" />
		</if>

		<set name="PHONENO" expr="DELSPACE(MOB,'all')" /><!-- 手机号 -->
		<set name="bind_mob" expr="PHONENO" />
		<if condition="INTCMP(STRLEN(PHONENO),4,11)">
			<set name="MsgTyp" value="E" />
			<set name="RspCod" value="01005" />
			<set name="RspMsg" value="预留手机号码格式不正确" />
			<return />
		</if>

		<set name="certifId" expr="idno" /><!-- 身份证号 -->
		<set name="CUSTOMERNM" expr="cust_name" /><!-- 姓名 -->
		<set name="CERTIFTP" value="01" /><!-- 证件类型 -->

		<!-- 查找绑定关系 -->
		<do func="ReadRecord" error="IGNORE">
			<para name="SqlCmd" sql="qrySamInfo" />
		</do>
		<if condition="#RetCod==0">
			<set name="BAK_SEQ" expr="BANK_SEQ" /><!-- 绑定编号 -->
			<!-- 判断是否已经开通快捷支付 -->
			<if condition="OR(IS_EQUAL_STRING(BANK_CONF,'0'),IS_EQUAL_STRING(BANK_CONF,''))">
				<!-- 获取绑定标识符序号 -->
				<do func="GetSeqNo" error="IGNORE">
					<para name="TblNam" value="stpseqrec" />
					<para name="KeyNam" value="KeyNam" />
					<para name="KeyVal" value="STPBANKTB_AUTH_CODE" />
					<para name="SeqNam" value="KeyVal" />
					<para name="Len" value="5" />
					<para name="Circle" value="1" />
				</do>
				<set name="bind_Id" expr="STRCAT(GETDATETIME(),KeyVal)" />
				<!-- 银联通道进行绑定 -->
				<do func="DaiShou_RealAuth_Back_BindId">
					<para name="merId" value="777290058110097" />       	   <!--商户号 -->
					<para name="orderId" expr="GETDATETIME('MMDDHHMISS')" />     	   <!--商户订单号 -->
					<para name="txnTime" expr="GETDATETIME()" />     	   <!--交易时间yyyyMMddHHmmss -->
					<para name="bindId" expr="bind_Id" />      	   <!--绑定标识号 -->
					<!-- 姓名、卡类型、证件号码、手机号、卡号、卡背面的cvn2三位数字、有效期年在前月在后 -->
					<!-- <para name="customerNm" expr="customerNm" />
					<para name="cardType" expr="cardType" />       	   
					<para name="certifId" expr="idno" />		
					<para name="phoneNo" expr="PHONENO" />     	   
					<para name="accNo" expr="cardno" />       	   
					<para name="cvn2" expr="cvn2" />        	   
					<para name="expired" expr="expired" /> -->     	   
					
					<para name="certifId" value="341126197709218366" />    	   
					<para name="phoneNo" value="13552535506" />
					<!-- 储蓄卡  -->
					<!-- <para name="customerNm" value="全渠道" /> -->
					<!-- <para name="accNo" value="6216261000000000018" /> 
					<para name="cvn2" value="" />        	  
					<para name="expired" value="" />
					<para name="cardType" value="00" /> -->
					<!-- 信用卡 -->
					<para name="customerNm" value="互联网" />  	   
					<para name="accNo" value="6221558812340000" /> 
					<para name="cvn2" value="123" />        	  
					<para name="expired" value="1711" />
					<para name="cardType" value="01" />
				</do>
				<if condition="#RetCod!=0">
					<set name="MsgTyp" value="E" />
					<set name="RspCod" value="10006" />
					<set name="RspMsg" expr="respMsg" />
					<return />
				</if>
				<else>
					<do func="ExecSql" error="IGNORE">
						<para name="SqlCmd" sql="updateConfig" />
					</do>
					<if condition="#RetCod!=0">
						<set name="MsgTyp" value="E" />
						<set name="RspCod" value="09999" />
						<set name="RspMsg" value="系统错误" />
						<return />
					</if>
					<do func="CommitWork" />
				</else>
			</if>
			<if condition="IS_EQUAL_STRING(BANK_CONF,'1')">
				<set name="MsgTyp" value="E" />
				<set name="RspCod" value="01111" />
				<set name="RspMsg" value="该银行卡已开通快捷支付!" />
				<return/>
			</if>
		</if>
		<elseif condition="#RetCod==2">
			<set name="MsgTyp" value="E" />
			<set name="RspCod" value="01111" />
			<set name="RspMsg" value="该银行卡没有绑定！" />
			<return/>
		</elseif>
		
		<set name="RspCod"        value="000000"  />
        <set name="RspMsg"        value="快捷支付开通成功"/>
	</process>
	</transaction>
	
	<!-- 关闭银联代收 -->
    <transaction code="800061" desc="关闭银联代收">
	<sql name="updateConfig">
		update stpbanktb set bank_conf='0', AUTH_CODE='' where bak_seq=#{BAK_SEQ}
	</sql>
	<sql name="qrySamInfo">
		select B.BAK_SEQ as BANK_SEQ,B.CARD_NO,B.BANK_CONF,B.AUTH_CODE AUTH_CODE from stpbanktb B,STPUSRINF u  where B.CUST_ID = U.CUST_ID AND U.CUST_LOGIN=#{userID}
		and card_no=#{qryCard}
	</sql>
	<sql name="QueryUsrPayPwd">
       SELECT arp.PASSWORD CUST_PWD,arp.CUST_ID FROM ARP_AC_CUST_REL arp,STPUSRINF usr WHERE arp.CUST_ID = usr.CUST_ID AND usr.CUST_LOGIN = #{USRMP}
   </sql>
	<process>
	
		<!-- 对APP数据进行解密 -->
	    <set name="sPwds"    value="USRPWD:G_RANDOM"/>
	    <!-- 增加用户手机在线状态判断 -->
	    <quote name="ParseRequestParamsNoCheckStatus"/>
        
        
		<!-- 检测用户登录状态 此交易必须是登录状态完成 -->
		<set name="userID" expr="USRMP" />
		<set name="UsrPwd" expr="USRPWD" />
		
		<set name="cardno" expr="DES_DECRYPT(DELSPACE(CARDNO,'all'))" /><!-- 卡号 -->
		<set name="accNo" expr="cardno" />
		<set name="qryCard" expr="DES_ENCRYPT(accNo)" />

		<if condition="IS_EQUAL_STRING(cardno,'')">
			<set name="RspCod" value="01002" />
			<set name="RspMsg" value="请输入银行卡号" />
		</if>

		<do func="GetCrdInfo"><!-- 获取卡信息 -->
			<para name="CrdNo" expr="cardno" />
		</do>
		<if condition="#RetCod!=0">
			<set name="RspCod" value="01003" />
			<set name="RspMsg" value="系统不识别该卡，请换其他卡！" />
			<return />
		</if>
		
		<!-- 支付密码校验 -->
		<do func="ReadRecord" error="IGNORE">
			<para name="SqlCmd" sql="QueryUsrPayPwd" />
		</do>
		<if condition="#RetCod!=0">
             <set name="RspCod"        value="002008"        />
             <set name="RspMsg"        value="用户信息不存在"/>
             <return/>
         </if>
         
         <!-- 密码错误 -->
         <if condition="IS_NOEQUAL_STRING(UsrPwd,CUST_PWD)"> 
             <set name="RspCod"        value="002036"    />
             <set name="RspMsg"        value="支付密码输入错误！"  />
             <return/>
         </if>

		<!-- 查找绑定关系 -->
		<do func="ReadRecord" error="IGNORE">
			<para name="SqlCmd" sql="qrySamInfo" />
		</do>
		<if condition="#RetCod==0">
			<set name="BAK_SEQ" expr="BANK_SEQ" /><!-- 绑定编号 -->
			<!-- 判断是否已经开通快捷支付 -->
			<if condition="IS_EQUAL_STRING(BANK_CONF,'0')">
				<set name="MsgTyp" value="E" />
				<set name="RspCod" value="01111" />
				<set name="RspMsg" value="该银行卡已解绑快捷支付!" />
				<return />
			</if>
			<elseif condition="IS_EQUAL_STRING(BANK_CONF,'1')">
				<!-- 获取绑定标识符序号 -->
				<set name="bind_Id" expr="AUTH_CODE" />
				<!-- 银联通道进行解绑 -->
				<do func="DaiShou_RemoveBind">
					<para name="merId" value="777290058110097" />       	   <!--商户号 -->
					<para name="orderId" expr="GETDATETIME('MMDDHHMISS')" />     	   <!--商户订单号 -->
					<para name="txnTime" expr="GETDATETIME()" />     	   <!--交易时间yyyyMMddHHmmss -->
					<para name="bindId" expr="bind_Id" />      	   <!--绑定标识号 -->
					<!-- <para name="accNo" expr="cardno" /> -->       	   <!--卡号 -->
					<!-- 储蓄卡 -->
					<!-- <para name="accNo" value="6216261000000000018" /> -->
					<!-- 信用卡 -->
					<para name="accNo" value="6221558812340000" />
				</do>
				<if condition="#RetCod!=0">
					<set name="MsgTyp" value="E" />
					<set name="RspCod" value="10006" />
					<set name="RspMsg" expr="respMsg" />
					<return />
				</if>
				<else>
					<do func="ExecSql" error="IGNORE">
						<para name="SqlCmd" sql="updateConfig" />
					</do>
					<if condition="#RetCod!=0">
						<set name="MsgTyp" value="E" />
						<set name="RspCod" value="09999" />
						<set name="RspMsg" value="系统错误" />
						<return />
					</if>
					<do func="CommitWork" />
				</else>
			</elseif>
		</if>
		<elseif condition="#RetCod==2">
			<set name="MsgTyp" value="E" />
			<set name="RspCod" value="01111" />
			<set name="RspMsg" value="该银行卡没有绑定！" />
			<return />
		</elseif>
		
		<set name="RspCod"        value="000000"  />
		<set name="RspMsg"        value="快捷支付解绑成功"/>
		
	</process>
	</transaction>
	
	<!--http://59.41.60.154:8090/RMobPay/orderPayment.tran?usrMp=13718570465&merNo=11111100000000&prdOrdNo=P20151223173416&payPwd=723ae093dbe2fd03&payType=04&txAmt=1000&mulAmt=37.32&MulType=01&accAmt=962.68-->
	<!--http://59.41.60.154:8090/RMobPay/orderPayment.tran?usrMp=13718570465&merNo=11111100000000&prdOrdNo=P20151223171001&payPwd=723ae093dbe2fd03&payType=00&txAmt=0.01-->
	<transaction code="orderPayment" desc="手机SDK商户对接统一支付接口">
      <sql name="SelPrd"> <!-- 查询商品订单表 -->
         SELECT ORDERTIME,ordAmt,OrdStatus,prdName,merNo,bizType,payOrdNo,prdOrdType,NotifyUrl,retUrl tradeCode 
           FROM stpPrdInf 
          WHERE prdOrdNo=#{prdOrdNo} and merNo=#{MerNo}
      </sql> 
      <sql name="UpdPay"> <!-- 更新支付订单表 -->
         payOrdNo=#{payOrdNo}
      </sql>
      <sql name="UpdPrd"> <!-- 更新商品订单表 -->
         prdOrdNo=#{prdOrdNo} and merNo=#{MerNo}
      </sql>
      <sql name="QryCusInf"><!-- 查询客户信息-->
         SELECT c.CUST_STATUS, c.CUST_NAME,u.cust_login,c.cust_id USERID FROM StpCusInf c,stpusrinf u WHERE c.cust_id=u.cust_id and u.CUST_LOGIN=#{USRMP} 
      </sql>
      <sql name="SelAccInf"><!-- 查询客户账户信息-->
         SELECT a.AC_STATUS,a.PAY_AC_NO PAYACNUM FROM ARP_AC_PROFILE a,ARP_AC_CUST_REL b WHERE b.CUST_ID=#{USERID} AND a.PAY_AC_NO=b.PAY_AC_NO
      </sql>
      <sql name="QryPassInf"><!-- 查询客户支付密码信息-->
         SELECT PASSWORD FROM ARP_AC_CUST_REL WHERE PAY_AC_NO=#{PAYACNUM}
      </sql>
      <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
         SELECT CASH_AC_BAL,FROZ_BALANCE FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNUM}
      </sql>
      <sql name="SelMerFee">
         SELECT fee_code FROM ARP_CUST_FEE WHERE pay_ac_no in (select pay_ac_no from arp_ac_cust_rel where CUST_ID=#{merNo}) and biz_type=#{bizType} and pay_type=#{payType}
      </sql>
      <!-- 快捷支付 查询绑定卡信息 -->
      <sql name="QryStpBankInf">
          SELECT (case when CARD_TYPE='00' then '1' when CARD_TYPE='01' then '2'   else '-1' end) as type_card,CARD_NO as cardno,CARD_NAME as cust_name,CARD_BANK_THREE as cvv2,VALIDITY_M as month,VALIDITY_Y as year,BANK_RES_PHONE as bind_mob,BANK_CONF,AUTH_CODE as bindId from STPBANKTB where BAK_SEQ=#{no_agree}
      </sql>
      <sql name="QryCertificate">
          select CUST_CRED_NO from stpcusinf where CUST_ID=#{USERID}
      </sql>
      <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
          SELECT 
          EXTRACT(DAY FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*24*60 + EXTRACT(HOUR FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*60 +  EXTRACT(MINUTE FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND )) as timeDifference,
          CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
          FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
      </sql>
      <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
          INSERT INTO STPLOGTMP
          (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
          VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
      </sql>
      <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
          UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
          LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
      </sql>
      <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
          UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
          WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
      </sql>  
      <sql name="UpdPayMer"><!-- 更新支付订单表中银行商户号 和 银行编码-->
        UPDATE STPPAYINF SET BnkMerNo=#{BnkMerNo},BANKCOD=#{BANKCODE} WHERE payOrdNo=#{payOrdNo}
      </sql>
      <process>
         <!-- 对APP数据进行解密 -->
         <set name="sPwds"    value="payPwd:G_RANDOM"/>
         <quote name="ParseRequestParams"/>
         
         <set name="usrMp"          expr="usrMp"/><!--登录名-->
         <set name="prdOrdNo"       expr="prdOrdNo"/><!--订单号-->
         <set name="MerNo"          expr="MerNo"/><!--商户号-->
         <set name="payPwd"         expr="payPwd"/><!--支付密码 payType00、04时必须-->
         <set name="payType"        expr="payType"/><!--支付方式 00:虚拟账户 01:WAP网关 03:快捷 04:混合-->
         <set name="mulType"        expr="mulType"/><!--混合方式 01:网银 03:快捷-->
         <set name="txAmt"          expr="txAmt"/><!--订单金额-->
         <set name="accAmt"         expr="accAmt"/><!--虚拟账户支付金额 payType04时必须-->
         <set name="mulAmt"         expr="mulAmt"/><!--第二种支付方式支付金额 payType04时必须-->
         <set name="no_agree"        expr="no_agree"/><!-- 绑定协议号-->
         
         <!--参数必传判断-->
         <if condition="OR(ISNULL(USRMP),ISNULL(prdOrdNo),ISNULL(MerNo),ISNULL(payType),ISNULL(txAmt))">
             <set name="RspCod"        value="002008"        />
             <set name="RspMsg"        value="必传参数为空"/>
             <return/>
         </if>
         <if condition="IS_EQUAL_STRING(payType,'04')">
            <if condition="OR(ISNULL(mulType),ISNULL(accAmt),ISNULL(mulAmt))">
             <set name="RspCod"        value="002008"        />
             <set name="RspMsg"        value="参数传递错误"/>
             <return/>
            </if>
         </if>
         <elseif condition="OR(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(payType,'00'))">
            <if condition="ISNULL(payPwd)">
             <set name="RspCod"        value="002008"        />
             <set name="RspMsg"        value="参数传递错误"/>
             <return/>
            </if>
         </elseif>
         
         <quote name="usrChk"/><!--根据手机号转译custid-->
         <quote name="chkAcc"/><!-- 账户信息查询-->
         
         <set name="custPayAcNo"   expr="PAYACNUM"/>
         <set name="cust_name"     expr="CUST_NAME"/>
         <set name="cust_name_fmt" expr="cust_name"/>

         <!--查询商品订单信息-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="SelPrd" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="08001"/>
            <set name="RspMsg"    value="该订单信息不存在"/>
            <return/>
         </if>
         <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="06001"/>
            <set name="RspMsg"    value="订单已付款成功，请刷新交易记录！"/>
            <return/>
         </if>
         <elseif condition="IS_NOEQUAL_STRING(OrdStatus,'00')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="06001"/>
            <set name="RspMsg"    value="该订单状态不能支付"/>
            <quote name="UpdPrd"/>
            <return/>
         </elseif>
         <else>
            <set name="RspMsg"       value="检查通过"/>
         </else>
         
         <if condition="ISNULL(PrdOrdType)">
            <set name="PrdOrdType"  value="0"/>            
         </if>
         
         <!--判断金额是否与建立商品订单中的金额一致-->
         <if condition="IS_NOEQUAL_STRING(ordAmt,AMTPOWER(TXAMT,2))">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="08016f"/>
            <set name="RspMsg"    value="订单金额与应支付金额不符"/>
            <return/>
         </if>
         
         <if condition="AND(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(accAmt,'0.00'))">
            <set name="payType"     expr="mulType"/>
            <set name="accAmt"      value=""/>
            <set name="mulAmt"      value=""/>
            <set name="mulType"     value=""/>
         </if>
         <elseif condition="IS_EQUAL_STRING(payType,'04')">
            <set name="MULAMT_FMT"     expr="mulAmt"/>
            <set name="accAmt"         expr="AMTPOWER(accAmt,2)"/>           <!--虚拟账户金额--> 
            <set name="mulAmt"         expr="AMTPOWER(mulAmt,2)"/>           <!--混合支付金额-->  
              <if condition="IS_NOEQUAL_STRING(ordAmt,ADD(accAmt,mulAmt))">
                <set name="RspCod"        value="002008"        />
                <set name="RspMsg"        value="参数传递错误"/>
                <return/>
              </if>
         </elseif>
         <else>
            <set name="RspMsg"       value="检查通过"/>
         </else>
         
         <!--支付密码检查 虚拟账户支付或混合支付检查 start-->
         <if condition="OR(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(payType,'00'),AND(OR(ISNULL(no_agree),IS_EQUAL_STRING(no_agree,'')),IS_EQUAL_STRING(payType,'03')))">
            <set name="PAYNO"      expr="PAYACNUM"/>
            <set name="paypwd"     expr="payPwd"/>
            <quote name="chkPayPwd"/>
         </if>
          
         <!--限额检查  start --> 
         <set name="txAmt_bak"     expr="TXAMT"/>
         <set name="txAmt"         expr="AMTPOWER(TXAMT,2)"/>    <!--交易金额-->
         <set name="Amt"           expr="txAmt"/>
         <set name="User_code"     expr="userID"/>
         <set name="comp_code"     expr="merNo"/>
         <set name="cust_type"     value="0"/>  
         <set name="Time"          expr="GETDATETIME()"/>
         <set name="DATE"          expr="GETDATE()"/>
         <set name="TRAN_TYPE"     value="2"/>
         <set name="ServiceCode"   value="680518"/>  
         <quote name="chkLimAmt"/>
         <!--限额检查   end--> 
         
         <!--获取序号 -->
         <do func="GetSeqNo"  error="IGNORE">
            <para name="TblNam" value="stpseqrec"/>
            <para name="KeyNam" value="KeyNam"/>
            <para name="KeyVal" expr="STRCAT('StpPayInf','PayOrdNo',GETDATE())"/>
            <para name="SeqNam" value="KeyVal"/>
            <para name="Len"    value="8"/>
            <para name="Circle" value="1"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09001"/>
            <set name="RspMsg"    value="获取序号错误"/>
            <return/>
         </if>
         <set name="payOrdNo"    expr="STRCAT('P',SUBSTR(ActDat,2,7),KeyVal)"></set>
         <set name="ordCcy"      value="CNY"/>
         <set name="payType"     expr="payType"/>
         <set name="txCcy"       value="CNY"/>
         <set name="SignMsg"     expr="signature"/>                    <!--签名信息-->
         <set name="ActDat"      expr="GETDATETIME()"/>                <!--支付时间-->
         <set name="OrdStatus"   value="00"/>                          <!--未支付-->
         <set name="cust_id"     expr="userID"/>
         <set name="BANKSTLDATE" expr="GETDATE()"/>
         <set name="ACCESSWAY"   value="0"/>
         <if condition="IS_NOEQUAL_STRING(payType,'00')">
            <set name="BANKCOD"       expr="BANKCODE"/>
            <if condition="OR(ISNULL(THIRDPARTY),IS_EQUAL_STRING(THIRDPARTY,''))">
             <set name="THIRDPARTY"   value="PLA"/>
            </if>
         </if>
         
         <do func="InsertRecord" error="IGNORE">
            <para name="TblNam"  value="StpPayInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if> 
         <do func="CommitWork"/>
         
         <!--查询账户余额-->
         <quote name="selAccBal"/>  
         
         <if condition="IS_EQUAL_STRING(payType,'00')">       <!--虚拟账户--> 
            <set name="TRANWAY"        value="04"/><!--交易方式 虚拟账户--> 
            <if condition="ISNULL(CASH_AC_BAL)">
              <set name="CASH_AC_BAL"  value="0"/>
            </if>
            <if condition="ISNULL(FROZ_BALANCE)">
              <set name="FROZ_BALANCE" value="0"/>
            </if>
            <set name="casBal"     expr="SUB(CASH_AC_BAL,FROZ_BALANCE)"/>  
            
            <if condition="DOUBLECMP(casBal,1,TXAMT)">           <!--判断金额是足够-->
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="06012"/>
                <set name="RspMsg"    value="账户可用余额不足，请重新选择付款方式！"/>   
                <return/>
            </if>
            
            <!--计算商户手续费-->
            <quote name="CalMerFee"/>
            <set name="netRecAmt"      expr="netRecAmt"/>     <!--净额-->
            <set name="txnComAmt"      expr="txnComAmt"/>     <!--收取商户的交易佣金-->  
            
            <!--记账所需数据-->
            <set name="ACC_TYP"        value="01"/>           <!--现金账户-->
            <set name="MER_ACC_TYP"    value="02"/>           <!-- 商户结算账户 -->
            <set name="DR_CR_FLAG"     value="+"/>            <!--账户余额增减标识 + 增加 - 减少-->
            <set name="CCY"            value="CNY"/>          <!--货币类型-->
            <set name="AMT"            expr="TXAMT"/>         <!--金额-->
            <set name="IS_ACT"         value="Y"/>            <!--是否实时记账 Y 是 N 否-->
            <set name="usrPar"         expr="STRCAT(CUST_ID,'/',ACC_TYP,'/','-','/',CCY,'/',AMT,'/',IS_ACT,'/')"/>  <!--用户记账参数-->
            
            <!--进行虚拟账户扣款-->    
            <if condition="IS_EQUAL_STRING(prdOrdType,'0')">     <!--消费--> 
               <if condition="IS_EQUAL_STRING(flag,'1')">        <!--收取手续费标识  1 收取  0 不收取-->
                  <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                  <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                  <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar,',',feePar)"/>
               </if>
               <else>
                  <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',AMT,'/',IS_ACT,'/')"/>         <!--商户记账参数-->
                  <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar)"/>
               </else>
            </if>
            <elseif condition="IS_EQUAL_STRING(prdOrdType,'2')">    <!--担保支付--> 
               <set name="flag"               value="0"/>           <!--担保支付预付款不扣手续费 确认付款再扣取-->
               <set name="netRecAmt"          expr="txAmt"/>
               <set name="pltMidPar"          expr="STRCAT('99999900000001','/','04','/','+','/',CCY,'/',AMT,'/','N','/')"/>        <!--平台担保账户记账参数-->
               <set name="PARAMS"             expr="STRCAT(usrPar,',',pltMidPar)"/>  
            </elseif>
         
            <!--记账处理-->
            <set name="TXN_TYP"      value="2"/>                                    <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->     
            <set name="PARAMS"       expr="PARAMS"/>
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <do func="RollBackWork"/>
               <set name="Status"       value="2"/>
               <set name="ClearDat"     expr="GETDATE()"/>    <!--支付日期-->
               <quote name="UpdPay"/>
               <set name="acDate"       expr="ClearDat"/>     <!--支付日期-->  
               <set name="acTime"       expr="GETDATETIME('HHMISS')"/>  <!--支付时间-->
               <quote name="UpdPrd"/>
               <set name="RspCod"      value="80001"/>
               <set name="RspMsg"      value="账户扣款失败，请稍后重试！"/>
               <return/>
            </if>
            
            <!--更新支付订单表-->
            <set name="OrdStatus"    value="01"/>
            <if condition="NOT(ISNULL(CREDNO))">
               <delete name="CREDNO"/>   
            </if> 
            <set name="ClearDat"     expr="acDate"/>
            <quote name="UpdPay"/>
            
            <if condition="ISNULL(merRemark)">
               <set name="merRemark"         value="商物通"/>
            </if>
        
            <set name="SmsContent"    expr="STRCAT('您好，您在',merRemark,'消费金额：',AMTADDDOT(txAmt),'元，通过商物通付款成功，如有疑问请联系',merRemark,'。')"></set>
            <quote name="sendSms"/>
            
            <!--如果处理的是物业订单，则需要回写物业系统-->
            <set name="ConfigName"   value="PropertyMerId"/>
            <quote name="ReadXmlCfg"/>
            <if condition="IS_EQUAL_STRING(MERNO,ProMerId)"> <!--物业商户走单独回写-->
               <set name="CUST_ID"   value="CUST_ID"/><!--物业商户ID-->
               <set name="PrdOrdNo"  value="PrdOrdNo"/><!--订单号-->
               <set name="sthCode"    value="594106"/><!-- 通过接口调用STP下交易，完成下单交易 --> 
               <do func="CallThirdOther"     error="IGNORE">
                   <para name="channel"         value="STHDSTPU" />
                   <para name="code"            expr="sthCode"/>
               </do>
               <if condition="#RetCod!=0">
                   <do func="RollBackWork"/>
                   <set name="RspCod"         value="009997"/>
                   <set name="RspMsg"         value="通讯错误"/>
                   <return/>
               </if>
            </if>

            <set name="#url"          expr="NotifyUrl" />  
            <if condition="IS_EQUAL_STRING(prdOrdType,'2')">
               <set name="OrdStatus"  value="12"/>  
            </if>
            <else>
               <set name="OrdStatus"  value="01"/>
            </else>
            <set name="Status"        value="1"/> 
            <!--更新商品订单表--> 
            <quote name="UpdPrd"/>
            
            <!--通知风控系统登记订单信息-->
            <set name="ServiceCode" value="680517"/>
            <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
            <set name="TCODE"       expr="payOrdNo"/>           <!--平台流水号-->
            <set name="CTYPE"       value="1"/>                 <!--客户类型-->
            <set name="CLIENTCODE"  expr="userID"/>
            <set name="CLIENTNAME"  expr="CUST_NAME"/>
            <set name="MOBILEPHONE" expr="SESSIONS.USRMP"/>
            <set name="CCODE"       expr="merNo"/>              <!--商户编号-->
            <set name="CNAME"       expr="MERREMARK"/>
            <set name="TRANTYPE"    value="2"/>                 <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
            <set name="TRANWAY"     value="04"/>                <!--交易方式 01网银、02终端、03消费卡、04虚拟积分等-->
            <set name="TAMT"        expr="ordAmt"/>
            <set name="REGDTTIME"   expr="STRCAT(acDate,acTime)"/>
            <set name="Time"        expr="acDate"/>
            <quote name="noticRcs"/>
            <set name="RspCod"      value="000000"/>
            <set name="RspMsg"      value="交易成功"/>

            <!--通知商城付款成功-->
            <if condition="IS_NOEQUAL_STRING(MERNO,ProMerId)"> <!--非物业商户走正常通知-->
              <set name="versionId"    value="5.0.0"/>
	          <set name="merchantId"   expr="MERNO"/>
	          <set name="orderId"      expr="orderId"/>
	          <set name="settleDate"   expr="settleDate"/>
	          <set name="completeDate" expr="completeDate"/>
	          <set name="status"       expr="status"/>
	          <set name="notifyTyp"    expr="notifyTyp"/>
	          <set name="payOrdNo"     expr="payOrdNo"/>
	          <set name="orderAmt"     expr="orderAmt"/>
	          <set name="notifyUrl"    expr="notifyUrl"/>
	          <set name="signType"     value="CFCA"/>
              <quote name="TimeTouch2"/> 
            </if>
         </if>
         <elseif condition="IS_EQUAL_STRING(payType,'04')">   <!--混合支付--> 
            <set name="prdOrderNo"       expr="prdOrdNo"/>
            <set name="payAcNo"          expr="PAYACNUM"/>
            <set name="merNotmp"         expr="merno"/>
            
            <!--根据混合支付方式，发送相应接口-->
            <if condition="IS_EQUAL_STRING(MulType,'01')">    <!--WAP-->
               <set name="orderId"      expr="payOrdNo"/>
               <set name="txnAmt"       expr="mulAmt"/>  
               <set name="txnTime"      expr="ActDat"/>
               <set name="BANKCODE"     value="01010000"/>
               <!--取公共参数配置-->
               <set name="ConfigName"   value="phonePayConfig"/><!--银联参数配置支付-消费-->
               <quote name="ReadXmlCfg"/>
               <!-- <quote name="SendInb"/> -->
               <quote name="SendSDK"/>
               <set name="UPOPWAPPAYURL" expr="UPOPWAPPAYURL"/>
               <delete name="BIZTYPE"/>
               <quote name="UpdPrd"/>
               <set name="BnkMerNo" expr="merId"/>
               <quote name="UpdPayMer"/>
            </if>
            <elseif condition="IS_EQUAL_STRING(MulType,'03')">   <!--快捷/代收-->
                <!--银联代收类似一个网关支付，同步响应只是一个受理，支付结果以异步通知为准-->
                <!--快捷回调，直接回到到PC的代收回调交易中-->
                <set name="BANKCODE"     value="01010200"/>
                <set name="txnAmt"       expr="mulAmt"/>
                <quote name="GetDaiShouInfPay"/>
            		<quote name="UpdPrd"/>
            		<quote name="UpdPayMer"/>
            </elseif>
         </elseif>
         <elseif condition="IS_EQUAL_STRING(payType,'01')">   <!--WAP-->
            <set name="orderId"      expr="payOrdNo"/>
            <set name="txnAmt"       expr="ordAmt"/>  
            <set name="txnTime"      expr="ActDat"/>
            <set name="BANKCODE"     value="01010000"/>
            <!--取公共参数配置-->
            <if condition="OR(IS_EQUAL_STRING(prdOrdType,'1'), IS_EQUAL_STRING(prdOrdType,'3'))">
               <set name="ConfigName"   value="phoneTopupConfig"/><!--银联参数配置支付-充值-->
            </if>
            <else>
               <set name="ConfigName"   value="phonePayConfig"/><!--银联参数配置支付-消费-->
            </else>
            <quote name="ReadXmlCfg"/>
            <!-- <quote name="SendInb"/> -->
            <quote name="SendSDK"/>
            <set name="UPOPWAPPAYURL" expr="UPOPWAPPAYURL"/>
            <delete name="BIZTYPE"/>
            <quote name="UpdPrd"/>
            <set name="BnkMerNo" expr="merId"/>
            <quote name="UpdPayMer"/>
         </elseif>
         <elseif condition="IS_EQUAL_STRING(payType,'03')">   <!--快捷/代付-->
            <!--银联代收类似一个网关支付，同步响应只是一个受理，支付结果以异步通知为准-->
            <!--快捷回调，直接回到到PC的代收回调交易中-->
            <set name="BANKCODE"     value="01010200"/>
            <set name="txnAmt"       expr="ordAmt"/>
            <quote name="GetDaiShouInfPay"/>
            <quote name="UpdPrd"/>
            <quote name="UpdPayMer"/>
         </elseif>
         <else>
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="06012"/>
            <set name="RspMsg"    value="无此支付方式"/>
            <return/>
         </else>
         
         <set name="MsgTyp"    value="N"/>
         <set name="RspCod"    value="000000"/>
         <set name="RspMsg"    value="交易成功"/>
      </process> 
    </transaction>
    
    <transaction code="buildOrder" desc="手机SDK商户对接--商品订单建立">
      <sql name="QryCusInf"><!-- 查询客户信息-->
         SELECT c.CUST_STATUS, c.CUST_NAME,u.cust_login,c.cust_id USERID FROM StpCusInf c,stpusrinf u WHERE c.cust_id=u.cust_id and u.CUST_LOGIN=#{USRMP} 
      </sql>
      <sql name="QryMerInf"><!-- 查询商户信息 添加一个a.MER_TYPE-->
         SELECT a.CUST_ID MerId,a.aut_sts,a.company_brief ,c.CUST_STATUS
           FROM StpMerInf a ,StpCusInf c
          WHERE a.cust_id=c.cust_id and  a.CUST_ID=#{merchantId}
      </sql>
      <sql name="QryMerSigInf"><!-- 查询签约信息-->
         SELECT m.prod_code FROM STPMERSIG m,stpproinf g 
         WHERE m.prod_code =g.prod_code and  g.prod_flag='0' and 
         MER_NO=#{merchantId} and m.prod_code=#{PRODCODE} 
      </sql>
      <sql name="QryOrdInf"><!-- 查询商品订单信息-->
         SELECT prdOrdNo FROM StpPrdInf WHERE prdOrdNo=#{prdOrdNo} AND merNo=#{merchantId}
      </sql> 	
      <process>
         <!-- 对APP数据进行解密 -->
         <set name="sPwds"    value=""/>
         <quote name="ParseRequestParams"/>
         
         <if condition="ISNULL(USRMP)">
             <set name="RspCod"        value="002008"        />
             <set name="RspMsg"        value="用户手机号为空"/>
             <return/>
         </if>  
         <quote name="usrChk"/><!--根据手机号转译custid-->      
         
         <set name="merchantId"  expr="merchantId"/>      <!-- 商户编号 -->
         <set name="CUST_ID"     expr="USERID"/>          <!-- 用户ID -->
         <set name="prdOrdNo"    expr="orderId"/>         <!-- 商品订单号 -->
         <set name="prdOrdType"  expr="prdOrdType"/>      <!--订单类型  0 消费   3商户充值 -->  
         <set name="ordAmt"      expr="orderAmount"/>     <!-- 订单金额 -->
         <set name="orderTime"   expr="orderDate"/>       <!-- 订单日期 -->
         <set name="signature"   expr="signature"/>       <!-- 签名信息 -->
         <set name="inMsg"       expr="inMsg"/>           <!-- 加密 原字符串 -->
         <set name="notifyUrl"   expr="retUrl"/>
         <set name="retUrl"      expr="returnUrl"/>
         <set name="bizType"     value="00"/>               <!-- 商户的业务类型 -->
         <set name="prdName"     expr="prdName"/>         <!-- 商品名称 -->
         <set name="prdDesc"     expr="prdDesc"/>         <!-- 商品描述 -->
         <set name="PRODCODE"    expr="PRODCODE"/>        <!-- 商户购买的产品编码-->
         
         <if condition="OR(IS_EQUAL_STRING(prdOrdType,'0'),IS_EQUAL_STRING(prdOrdType,'3'))">
            <set name="RspCod"    value="08224"/>
            <set name="RspMsg"    value="订单类型正确，可以做交易!"/>
         </if>
         <else>
            <set name="RspCod"    value="08124"/>
            <set name="RspMsg"    value="订单类型不正确，不能做交易!"/>
            <return/>
         </else>

         <!--检查金额格式-->
         <if condition="NOT(ISNULL(ordAmt))">
            <if condition="NOT(ISNUMBER(ordAmt))">
               <set name="RspCod"    value="08044"/>
               <set name="RspMsg"    value="金额格式错误"/>
               <return/>
            </if>
         </if>
         <else>
            <set name="RspCod"    value="08045"/>
            <set name="RspMsg"    value="订单金额不能为空！"/>
            <return/>
         </else>
         
         <if condition="NOT(ISNUMBER(orderDate))">
               <set name="RspCod"    value="08044"/>
               <set name="RspMsg"    value="日期格式错误"/>
               <return/>
         </if>
         
         <!-- 查询商户信息 -->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="QryMerInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="08039"/>
            <set name="RspMsg"    value="商户信息不存在"/>
            <return/>
         </if>
         <if condition="IS_NOEQUAL_STRING(CUST_STATUS,'0')">
            <set name="RspCod"    value="08040"/>
            <set name="RspMsg"    value="商户状态不正常"/>
            <return/>
         </if>
         
         <!-- 查询签约信息-->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="QryMerSigInf" />
         </do>
         <if condition="#RetCod==2">
            <set name="RspCod"    value="08039"/>
            <set name="RspMsg"    value="商户未签约该产品！"/>
            <return/>
         </if>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="08039"/>
            <set name="RspMsg"    value="商户未签约该产品！"/>
            <return/>
         </if>
         
         <if condition="IS_NOEQUAL_STRING(prod_code,'CP00000003')">
             <set name="RspCod"    value="08024"/>
             <set name="RspMsg"    value="不是网银支付不能做交易!"/>
             <return/>
          </if>
          
         <!-- 验签处理 -->
         <!--适用于CFCA及自建CA两种情况-->
         <if condition="IS_EQUAL_STRING(signType,'CFCA')">  <!--验签方式 CFCA -->
            <!--set name="INSTR"  expr="STRCAT('merchantId=',merchantId,'&amp;prodCode=',prodCode,'&amp;orderId=',orderId,'&amp;orderAmount=',orderAmount,'&amp;orderDate=',orderDate,'&amp;bizType=',bizType,'&amp;retUrl=',retUrl,'&amp;returnUrl=',returnUrl,'&amp;prdName=',TOUPPER(STR2HEX(prdName)),'&amp;prdDesc=',TOUPPER(STR2HEX(prdDesc)),'&amp;signType=',signType)"/-->
            <set name="INSTR"  expr="STRCAT('merchantId=',merchantId,'&amp;prodCode=',prodCode,'&amp;orderId=',orderId,'&amp;orderAmount=',orderAmount,'&amp;orderDate=',orderDate,'&amp;prdOrdType=',prdOrdType,'&amp;retUrl=',notifyUrl,'&amp;returnUrl=',returnUrl,'&amp;prdName=',prdName,'&amp;prdDesc=',prdDesc,'&amp;signType=',signType)"/>
            <!--CACA验签-->
            <do func="CFCASignVer">
               <para name="sourceData"        expr="INSTR" />
               <para name="signData"          expr="SIGNATURE" />
            </do>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="08039"/>
               <set name="RspMsg"    value="验签失败"/>
               <return/>
            </if>
         </if>
         <elseif condition="IS_EQUAL_STRING(signType,'ZJCA')">  <!--验签方式 自建CA  ZJCA-->
             <set name="CFCAPWD"         value="12345678"/>
             <!--自建CA验签-->
             <do func="HkCaVerifyn">
               <para name="sourceData"   expr="inMsg" />
               <para name="signData"     expr="REPALLSTR(signature,' ','+')" />
               <para name="pfxPath"      expr="STRCAT(GETCURAPPHOME(),'/key/',merchantId,'.pfx')" />
               <para name="pfxPwd"       expr="CFCAPWD" />
             </do>
             <if condition="#RetCod!=0">
                <set name="RspCod"    value="08039"/>
                <set name="RspMsg"    value="验签失败"/>
                <return/>
             </if>
             <delete name="CFCAPWD"/>
         </elseif>
         <else>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="无此验签方式！"/>
            <!-- <return/> -->
         </else>
         
         <delete name="SIGNATURE"/>
         <!--检查商品订单是否存在-->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="QryOrdInf" />
         </do>
         <if condition="#RetCod==2">       <!-- 商品订单不存在 初次支付-->
         </if>
         <elseif condition="#RetCod==0">   <!-- 商品订单存在 退出-->
            <set name="morePay"   value="1"/>
            <set name="RspCod"    value="08046"/>
            <set name="RspMsg"    value="订单号已存在"/>
            <return/>
         </elseif>
         <else>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </else>
         
         <set name="orderTime"    expr="orderTime"/>
         <set name="merNo"        expr="merchantId"/>
         <!-- <set name="cust_id"      value=""/> -->
         <set name="ordccy"       value="CNY"/>
         <set name="txncomamt"    value="0"/>
         <set name="OrdStatus"    value="00"/>
         <set name="ordsource"    value="1" />  <!--来源  0 PC端  1 手机端-->    
         
         <!--登记商品订单信息-->
         <do func="InsertRecord" error="IGNORE">
            <para name="TblNam"  value="StpPrdInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if>
         
         <!--取收银台参数配置-->
         <!--set name="ConfigName"       value="PayCfg"/>
         <quote name="ReadXmlCfg"/>
         <set name="payurl"      expr="STRCAT(payurl,'?orderId=',prdordno,'&amp;merNo=',merchantId)"/-->
         
         <set name="MsgTyp"    value="N"/>
         <set name="RspCod"    value="00000"/>
         <set name="RspMsg"    value="交易成功"/>
      </process>
       
   </transaction>
   
  <transaction code="qryBindCard" desc="手机SDK---收银台用户绑定卡查询">
     <sql name="QryStpBankInf"> <!--  查询用户绑定的银行卡(借记卡、信用卡)  --> 
     	select BAK_SEQ,CARD_BANK AS BANK_CODE,CARD_TYPE,CARD_NO,BANK_NAM
 							from STPBANKTB where cust_id=#{USERID} and bank_conf ='1' ${condition} order by card_type
     </sql>
     <sql name="QryCusInf"><!-- 查询客户信息-->
         SELECT c.CUST_STATUS, c.CUST_NAME,u.cust_login,c.cust_id USERID FROM StpCusInf c,stpusrinf u WHERE c.cust_id=u.cust_id and u.CUST_LOGIN=#{USRMP} 
     </sql>
     <process>
     		
     		<!-- 对APP数据进行解密 -->
        <set name="sPwds"    value=""/>
        <quote name="ParseRequestParams"/>
     	
       <set name="USRMP"          expr="USRMP"/><!--登录名-->
       <set name="QUERYSIGN"           expr="QUERYSIGN"/>  <!-- 0：查询借记卡(默认)  1：查询信用卡 2：查询(借记卡、信用卡)所有 -->
       
       <quote name="usrChk"/><!--根据手机号转译custid-->
       <if condition="OR(ISNULL(QUERYSIGN),IS_EQUAL_STRING(QUERYSIGN,''),IS_EQUAL_STRING(QUERYSIGN,'0'))">
           <set name="condition"   expr="STRCAT('and card_type =\'','00','\'')"/>
       </if>
       <elseif condition="IS_EQUAL_STRING(QUERYSIGN,'1')">
           <set name="condition"   expr="STRCAT('and card_type =\'','01','\'')"/>
       </elseif>
       <elseif condition="IS_EQUAL_STRING(QUERYSIGN,'2')">
           <set name="condition"   expr="STRCAT('and card_type in(','00,01',')')"/>
       </elseif>
       <else>
           <set name="condition"   value=""/>
       </else>
       
       
       <do func="QueryInGroup"    error="IGNORE">
           <para name="SqlCmd"      sql="QryStpBankInf" /> 
           <para name="RecordName"  value="BINDING_BANKS"/>
           <para name="RecNum"      value="PRONUM"/>
       </do>
       <if condition="#RetCod==2">
           <set name="RECORDNUM"    value="2"/>
           <set name="MsgTyp"       value="N"/>
           <set name="RspCod"       value="000001"/>
           <set name="RspMsg"       value="无银行卡信息"/>
           <return/>
       </if>
       <elseif condition="#RetCod==-1">
            <set name="RECORDNUM"    value="-1"/>
           <set name="MsgTyp"       value="E"/>
           <set name="RspCod"       value="09998"/>
           <set name="RspMsg"       value="网络繁忙，请稍后再试"/>
           <return/>
       </elseif>
       
       <foreach name="BINDING_BANKS" iterator="#grp">
         <set name="sDeData"         expr="#grp.CARD_NO"   />
         <if condition="NOT(ISNULL(DES_DECRYPT(sDeData)))">
            <set name="sDeData"      expr="DES_DECRYPT(sDeData)"   />
         </if>
         <set name="end"             expr="SUBSTR(sDeData,SUB(STRLEN(sDeData),3),STRLEN(sDeData))"/>
         <do func="loopSetEach">
            <para name="ele"   expr="#grp.CARD_NO"/> 
            <para name="value" expr="end"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"            value="09998"/>
            <set name="RspMsg"            value="系统错误"/>
            <return/>
         </if>
      </foreach>
       
       <set name="MsgTyp"          value="N"/>
       <set name="RspCod"          value="000000"/>
       <set name="RspMsg"          value="交易成功"/>
     </process>
   </transaction>
</application>
