<?xml version="1.0" encoding="UTF-8"?> 
<application name="STP" code="100" log_level="DEBUG">   
   <!-- 交易日志记录配置 -->     
   <include file="etc/public/STPCTL_TRC.XML"/>
   <!-- 公共宏文件引入 -->
   <include file="etc/public/Userp_MACRO.XML"/>

   
   <!-- 交易前处理 -->
   <before>
     <set name="MsgTyp"       value="N"/>
     <set name="RspCod"       value="00000"/>

     <!-- 取公共参数配置 -->
     <set name="ConfigName"   value="BeforeCfg"/>
     <quote name="ReadXmlCfg"/>
     
     <set name="TermCode"   expr="_REQUESTATTR.REQIP"/>
      
     <do expr="@tangdi.engine.context.Msg@dump()"/>
   </before>

   <!-- 交易后处理 -->
   <after>
      <if condition="IS_EQUAL_STRING(RspCod,'00000')">
         <set name="MsgTyp"       value="N"/>
      </if>
      <else>
         <set name="MsgTyp"       value="E"/>
      </else>
       
      <do expr="@tangdi.engine.context.Msg@dump()"/>
   </after>
   
   <!--发送短信验证码-->
   <macro name="SendSms" desc="发送短信验证码">
     <do func="sendMesSwt" error="IGNORE">
        <para name="sendUrl"              value="http://59.41.60.158:8914/TradeAppServer/user/sms.jf"/>
        <para name="softwareSerialNo"     value="linan-jufeng"/>
        <para name="smspassword"          value="linan-@jufeng"/>
        <para name="SendId"               value="12"/>
        <para name="MobNo"                expr="UsrMp"/>
        <para name="Context"              expr="SmsContent"/>
     </do>
     <if condition="#RetCod!=0">
       <set name="RspCod"               value="1003"/>
       <set name="RspMsg"               value="短信发送失败"/>
       <set name="DWZ_STATUS_CODE"      value="300"/>
       <set name="DWZ_RSP_MSG"          expr="RspMsg"/>
     </if>    
   </macro>

   <transaction code="sendCod" desc="用户使用手机注册,发送手机校验码,原561101">
        <sql name="QryUsrInf"> <!-- 查询用户注册数据 -->
            SELECT * FROM STPUSRINF WHERE CUST_LOGIN=#{UsrMp} and CUST_ID not in
            (#{newUsrId})
        </sql>
        <sql name="DelUsrIdInfo"> <!-- 删除验证表信息 -->
            DELETE FROM STPVERIFY WHERE VER_ID=#{UsrMp} and VER_TYPE=#{VER_TYPE} and  SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>
        <sql name="InsUsrrandom"> <!-- 插入用户验证信息 -->
            INSERT INTO STPVERIFY
            (VER_ID,VER_TYPE,InsTim,Random,TimeOut,SERVICE_TYPE,VER_TRAN_NO)
            VALUES (#{UsrMp},#{VER_TYPE}, sysdate
            ,#{Random},#{TimeOut},#{SERVICE_TYPE},#{TRANCODE})
        </sql>
        <sql name="InMsgSed"><!-- 登记短信信息 -->
            INSERT INTO STPMSGSED
            VALUES(#{USRMP},#{MSG_DAT},#{MSG_TIM},#{CUS_NAM},#{SMSCONTENT},'0')
        </sql>
        <sql name="UpdMsgSed"><!-- 更新短信发送状态 -->
            UPDATE STPMSGSED SET MSG_STS='1' WHERE PHONE=#{USRMP} AND
            MSG_TIM=#{MSG_TIM}
        </sql>
        <sql name="QryMsgSend">
            select count(*) CNT from stpverify where ver_id =
            #{UsrMp} and
            service_type='00' and (instim + numtodsinterval(1,
            'minute'))>sysdate
        </sql>
        <process>
            <set name="SESSIONS.RSPCOD" expr="RSPCOD" />
            <set name="reqip" expr="GetRequestAttr('REQIP')" />
            <!-- 检查用户登录平台是否正确 -->
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="RspCod"          value="01001" />
                <set name="SESSIONS.RSPCOD" expr="RSPCOD" />
                <set name="RspMsg"          value="用户登录平台不正确" />
                <return />
            </if>

            <!-- 检查手机号是否为空 -->
            <set name="UsrMp" expr="DELBOTHSPACE(phone)" />
            <if condition="IS_EQUAL_STRING(UsrMp,'')">
                <set name="RSPCOD" value="02035" />
                <set name="RspMsg" value="手机号为空" />
                <return />
            </if>
            <set name="phone" expr="DELBOTHSPACE(phone)" />
            <set name="newUsrId" expr="SESSIONS.USRID" />

            <!-- 检查手机号是否已注册 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrInf" />
            </do>
            <if condition="#RetCod==0">
                <set name="NOTE" value="N" />
                <set name="RspCod" value="02001" />
                <set name="RspMsg" value="该手机支付号已使用" />
                <return />
            </if>
            <elseif condition="#RetCod==-1">
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
            <elseif condition="#RetCod==2">
                <set name="RspMsg" value="该手机号可注册" />
            </elseif>
            <else>
                <set name="RspCod" value="09998" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </else>

            <!-- 验证验证码是否正确 -->
            <if condition="ISNULL(HRANDSTR)">
               <set name="MsgTyp" value="E" />
               <set name="RspCod" value="02981" />
               <set name="RspMsg" value="验证码不能为空" />
               <return />
            </if>
            <if condition="ISNULL(SESSIONS.SRA)">
               <set name="MsgTyp" value="E" />
               <set name="RspCod" value="02981" />
               <set name="RspMsg" value="验证码超时" />
               <return />
            </if>
            <set name="HRANDSTR" expr="TOUPPER(HRANDSTR)" />
            <set name="SRATMP" expr="TOUPPER(SESSIONS.SRA)" />
            <if condition="IS_NOEQUAL_STRING(HRANDSTR,SRATMP)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02980" />
                <set name="RspMsg" value="验证码错误" />
                <return />
            </if>

            <!--检查短信发送时效性 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryMsgSend" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </if>

            <if condition="IS_NOEQUAL_STRING(CNT,'0')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="请1分钟后再点击" />
                <return />
            </if>

            <!-- 随机字符串长度 -->
            <!-- 随机字符: ALL 字母和数字; NUM 数字; STR 字母 -->
            <!-- 大小写标识: MIX 混合; UPP 大写; LOW 小写; -->
            <do expr="@TdRandom@generateMixRandom(6, 'NUM', 'LOW')" />

            <if condition="IS_EQUAL_STRING(TimeOut,'')">
                <set name="TimeOut" value="10" />
            </if>

            <if condition="ISNUMBER(UsrMp)">
                <set name="VER_TYPE" value="0" /><!--验证类型 0：短信验证 1：邮箱验证 -->
            </if>
            <else>
                <set name="TimeOut" expr="MUL(24,60)" />
                <set name="VER_TYPE" value="1" /><!--验证类型 0：短信验证 1：邮箱验证 -->
            </else>
            <if condition="ISNULL(SERVICE_TYPE)">
                <set name="SERVICE_TYPE" value="00" /><!--验证码服务类型 00-注册短信验证 01-修改密码短信验证 
                    02-找回密码短信验证 03-数字证书短信验证 04-帐号变更短信验证 05-消费支付短信验证 -->
                
                   <if condition="IS_EQUAL_STRING(FLAG,'1')">      
                       <set name="SERVICE_TYPE" value="02" />             
                   </if>                                             
            </if>
            <else>
                <set name="SERVICE_TYPE" expr="SERVICE_TYPE" />
            </else>

            <!-- 删除用户验证码表中的记录 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="DelUsrIdInfo" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspMsg" value="该用户第一次申请验证码，无记录删除" />
            </if>
            <elseif condition="#RetCod==-1">
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
            <elseif condition="#RetCod==0">
                <set name="RspMsg" value="删除用户验证码信息成功" />
            </elseif>
            <else>
                <set name="RspCod" value="09998" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </else>

            <!-- 插入用户验证表 -->
            <set name="InsTim" expr="GETDATETIME()" />
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="InsUsrrandom" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </if>
            <do func="CommitWork" />
            <!-- 设置短信内容 -->
            <set name="SmsContent"
                expr="STRCAT('感谢注册商物通！验证码：',Random,'，请在10分钟内完成验证。')" />

           <if condition="IS_EQUAL_STRING(FLAG,'1')">      
               <set name="SmsContent"
                expr="STRCAT('欢迎使用商物通！您的验证码：',Random,'，请在10分钟内完成验证。')" />
           </if>
            <!-- 插入短信信息 -->
            <set name="Msg_Dat" expr="GETDATE()" />
            <set name="Msg_Tim" expr="GETDATETIME()" />
            <set name="Cus_Nam" value="注册用户验证" />
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="InMsgSed" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod" value="01006" />
                <set name="RspMsg" value="登记短信发送表失败" />
                <return />
            </if>
            <do func="CommitWork" />

            <!--取公共参数配置 -->
            <set name="ConfigName" value="SendSms" />
            <quote name="ReadXmlCfg" />
            <!-- 发送短信 -->
            <quote name="SendSms"/>
            
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="UpdMsgSed" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod" value="08517" />
                <set name="RspMsg" value="修改发送状态失败" />
                <return />
            </if>

            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
    </transaction>

   <transaction code="561110" desc="双因素认证,发送手机校验码.">
     <sql name="QryUsrInf"> <!--  查询用户注册数据  -->
       SELECT * FROM STPUSRINF WHERE CUST_LOGIN=#{UsrMp} 
     </sql>
     <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
       DELETE FROM STPVERIFY  WHERE VER_ID=#{UsrMp} and VER_TYPE=#{VER_TYPE}  and SERVICE_TYPE=#{SERVICE_TYPE}
     </sql>
     <sql name="InsUsrrandom"> <!--  插入用户验证信息  -->
       INSERT INTO  STPVERIFY (VER_ID,VER_TYPE,InsTim,Random,TimeOut,SERVICE_TYPE,VER_TRAN_NO) 
       VALUES (#{UsrMp},#{VER_TYPE}, sysdate ,#{Random},#{TimeOut},#{SERVICE_TYPE},#{TRANCODE})
     </sql>
     <sql name="InMsgSed"><!--  登记短信信息  -->
       INSERT INTO STPMSGSED VALUES(#{USRMP},#{MSG_DAT},#{MSG_TIM},#{CUS_NAM},#{SMSCONTENT},'0')
     </sql>
     <sql name="UpdMsgSed"><!--  更新短信发送状态  -->
       UPDATE STPMSGSED SET MSG_STS='1' WHERE PHONE=#{USRMP} AND MSG_TIM=#{MSG_TIM}
     </sql>   
     <sql name="QryMsgSend">
      select count(*) CNT from stpverify where ver_id = #{UsrMp} and service_type='00'  and (instim + numtodsinterval(1, 'minute'))>sysdate
     </sql>   
     
     <sql name="querylimuseinf">
       select * from limuseinf where account = #{ACCOUNT} and user_id = #{USER_ID}
     </sql>
     <sql name="queryMerchantInf">
       select biz_mob_no,BIZ_EMAIL from stpmerinf where cust_id = #{ACCOUNT}
     </sql>
     <process>
     <!-- 双因素 start -->
         <set name="ConfigName"   value="DFactors"/>
         <quote name="ReadXmlCfg"/>
         <if condition="IS_NOEQUAL_STRING(DFactors,'true')"><!-- 双因素开关 -->
              <set name="RspMsg"        value="不需要验证"/>
              <return/>
         </if>

       <if condition="IS_EQUAL_STRING(FLAG,'0')">
         <set name="UsrMp"   expr="USRMP"/>
       </if>
       <elseif condition="IS_EQUAL_STRING(FLAG,'3')">
         <!--  检测用户是否存在  -->
           <do func="ReadRecord" error="IGNORE">
              <para name="SqlCmd"   sql="querylimuseinf" />
           </do>
           <if condition="#RetCod==2">
             <set name="MsgTyp"        value="E"/>
             <set name="RspCod"        value="02008"/>
             <set name="RspMsg"        value="用户信息不存在"/>
             <return/>
          </if>
          <elseif condition="#RetCod==-1">
             <set name="MsgTyp"        value="E"/>
             <set name="RspCod"        value="09999"/>
             <set name="RspMsg"        value="系统错误"/>
             <return/>
          </elseif>
          <elseif condition="#RetCod!=0">
             <set name="MsgTyp"        value="E"/>
             <set name="RspCod"        value="09998"/>
             <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
             <return/>
          </elseif>
      </elseif>
      <elseif condition="IS_EQUAL_STRING(FLAG,'2')"><!--商户-->
         
            <do func="ReadRecord" error="IGNORE">
                   <para name="SqlCmd"   sql="queryMerchantInf" />
               </do>
               <if condition="#RetCod==2">
                  <set name="MsgTyp"        value="E"/>
                  <set name="RspCod"        value="02008"/>
                  <set name="RspMsg"        value="用户信息不存在"/>
                  <return/>
              </if>
              <elseif condition="#RetCod==-1">
                 <set name="MsgTyp"        value="E"/>
                 <set name="RspCod"        value="09999"/>
                 <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
                 <return/>
             </elseif>
             <elseif condition="#RetCod!=0">
                <set name="MsgTyp"        value="E"/>
                <set name="RspCod"        value="09998"/>
                <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
                <return/>
            </elseif>
        
      
     </elseif>
     <if condition="IS_EQUAL_STRING(FLAG,'3')">
        <set name="UsrMp"   expr="TEL"/>
     </if>
     <elseif condition="IS_EQUAL_STRING(FLAG,'2')" >
          <if condition="ISNULL(BIZ_MOB_NO)">
             <set name="UsrMp"   expr="BIZ_EMAIL"/>
         </if>
         <else>
             <set name="UsrMp"   expr="biz_mob_no"/>
         </else>
     </elseif>
     <elseif condition="IS_EQUAL_STRING(FLAG,'1')" >
        <set name="UsrMp"   expr="USRID"/>
     </elseif>
     
     
     <!-- 双因素 end -->
     
    
     
       <set name="reqip" expr="GetRequestAttr('REQIP')"/>
       <!-- 检查用户登录平台是否正确 -->
       <!-- if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if-->

       <!-- 检查手机号是否为空 -->
       <set name="UsrMp"          expr="DELBOTHSPACE(UsrMp)"/>
       <if condition="IS_EQUAL_STRING(UsrMp,'')">
         <set name="RspCod"       value="02035"/>
         <set name="RspMsg"       value="手机号为空"/>
         <return/>
       </if>

       <set name="newUsrId"       expr="SESSIONS.USRID"/>

     <if condition="IS_EQUAL_STRING(flag,'1')">
 
       <!-- 检查手机号是否已注册 -->
       <do func="ReadRecord"       error="IGNORE">
         <para name="SqlCmd"       sql="QryUsrInf" />
       </do>
       <if condition="#RetCod==0">
         <set name="NOTE"          value="N"/>
         <set name="RspCod"        value="02001"/>
         <set name="RspMsg"        value="该手机支付号已使用"/>
         
       </if> 
       <elseif condition="#RetCod==-1">
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </elseif>
       <elseif condition="#RetCod==2">
         <set name="RspMsg"        value="登录帐号不存在"/>
         <return/>
       </elseif>
       <else>
         <set name="RspCod"        value="09998"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </else>
     </if>
       <!-- 验证验证码是否正确 -->
       <set name="SRATMP"         expr="SESSIONS.SRA"/>
       <if condition="IS_NOEQUAL_STRING(TOUPPER(HRANDSTR),SRATMP)">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02980"/>
         <set name="RspMsg"        value="验证码错误"/>
         <return/>
       </if>
       
       <!--检查短信发送时效性-->
       <do func="ReadRecord"       error="IGNORE">
         <para name="SqlCmd"       sql="QryMsgSend" />
       </do>
       <if condition="#RetCod!=0">
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </if> 
       
       <if condition="IS_NOEQUAL_STRING(CNT,'0')">
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="请1分钟后再点击"/>
         <return/>
       </if>
       
       <!--  随机字符串长度  -->
       <!--  随机字符: ALL 字母和数字;  NUM 数字;   STR 字母  -->
       <!--  大小写标识: MIX 混合;   UPP 大写;   LOW 小写;  -->
       <do expr="@TdRandom@generateMixRandom(6, 'NUM', 'LOW')"/>
       
       <if condition="IS_EQUAL_STRING(TimeOut,'')">
         <set name="TimeOut"   value="10"/>
       </if>
       
       <if condition="ISNUMBER(UsrMp)">
         <set name="VER_TYPE" value="0"/><!--验证类型 0：短信验证 1：邮箱验证 -->
       </if>
       <else>
         <set name="TimeOut" expr="MUL(24,60)" />
         <set name="VER_TYPE" value="1"/><!--验证类型 0：短信验证 1：邮箱验证 -->
       </else>
       <if condition="ISNULL(SERVICE_TYPE)">
          <set name="SERVICE_TYPE" value="00"/><!--验证码服务类型 00-注册短信验证 01-修改密码短信验证 02-找回密码短信验证 03-数字证书短信验证 04-帐号变更短信验证 05-消费支付短信验证 -->
       </if>
       <else>
           <set name="SERVICE_TYPE" expr="SERVICE_TYPE" />
       </else>
       
       <!--  删除用户验证码表中的记录  -->
       <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="DelUsrIdInfo" />
       </do>
       <if condition="#RetCod==2">
         <set name="RspMsg"        value="该用户第一次申请验证码，无记录删除"/>
       </if>
       <elseif condition="#RetCod==-1">
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </elseif>
       <elseif condition="#RetCod==0">
         <set name="RspMsg"        value="删除用户验证码信息成功"/>
       </elseif>
       <else>
         <set name="RspCod"        value="09998"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </else>
       
       <!-- 插入用户验证表 -->
       <set name="InsTim"          expr="GETDATETIME()"/>
       <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="InsUsrrandom"/>
       </do>
       <if condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </if>
       <do func="CommitWork"/>
       <!-- 设置短信内容 -->
       <set name="SmsContent"      expr="STRCAT('登录验证码：',Random,'，请在10分钟内完成验证。')"/>
       
       <!-- 插入短信信息 -->
       <set name="Msg_Dat"         expr="GETDATE()"/>
       <set name="Msg_Tim"         expr="GETDATETIME()"/>
       <set name="Cus_Nam"         value="登录用户验证"/>
       <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="InMsgSed"/>
       </do>
       <if condition="#RetCod!=0">
         <set name="RspCod"        value="01006"/>
         <set name="RspMsg"        value="登记短信发送表失败"/>
         <return/>
       </if>
       <do func="CommitWork"/>
       
       <if condition="ISNUMBER(UsrMp)">
       
         <!--取公共参数配置-->
         <set name="ConfigName"   value="SendSms"/>
         <quote name="ReadXmlCfg"/>
         <!--发送短信-->
         <quote name="SendSms"/>
       
         <delete name="Random"/>
         <delete name="SmsContent"/>
         
       </if>
       <else>
         
            <set name="ConfigName"   value="CheckEmailNew"/>
            <quote name="ReadXmlCfg"/>
         
           <set name="Email"     expr="UsrMp"/>                                                                                                                                       
           <set name="EmResAddr" expr="SmsContent"/>
           <!--发送邮件-->
           <do func="TdMailSendNew" error="IGNORE">
              <para name="EmTo"       expr="Email" />
              <para name="EmTitle"    value="登录验证" />
              <para name="EmText"     expr="Random" />
              <para name="EmResAddr"  expr="EmResAddr" />
          </do>
          <if condition="#RetCod!=0">
             <set name="MsgTyp"        value="E"/>
             <set name="RspCod"        value="09999"/>
             <set name="RspMsg"        value="发送邮件失败"/>
             <return/>
         </if>
         <delete name="Random"/>
         <delete name="SmsContent"/>
         <delete name="EmResAddr"/>
         <delete name="G_EMPWD"/>
 
       </else>

       <!-- 更新短信发送状态 --> 
       <do func="ExecSql" error="IGNORE">
          <para name="SqlCmd" sql="UpdMsgSed" />
       </do>
       <if condition="#RetCod!=0">
          <set name="RspCod"       value="08517"/>
          <set name="RspMsg"       value="修改发送状态失败"/>
          <return/>
       </if>
       
       <set name="MsgTyp"          value="N"/>
       <set name="RspCod"          value="00000"/>
       <set name="RspMsg"          value="交易成功"/>
    </process>
   </transaction>
   

   <transaction code="checkPcod" desc="手机验证码验证">
     <sql name="DelUsrIdInfo"> <!-- 删除验证表信息 -->
            DELETE FROM STPVERIFY
            WHERE VER_ID=#{UsrMp} AND VER_TYPE=#{VER_TYPE}
            and
            SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>
        <sql name="QryUsrIdverifycode"> <!-- 查询用户注册验证码信息 -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60)
            timdif,timeout,InsTim,Random
            FROM STPVERIFY
            WHERE VER_ID=#{UsrMp} AND
            VER_TYPE=#{VER_TYPE} and
            SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim
            DESC
        </sql>
        <sql name="QryUsrInf"> <!-- 查询用户注册数据 -->
            SELECT CUST_ID
            FROM STPUSRINF
            WHERE CUST_LOGIN=#{UsrMp}
            and CUST_ID not
            in (#{newUsrId})
        </sql>
        <process>
            <!-- 下一步跳转页面 -->
            <if condition="IS_EQUAL_STRING(FLAG,'N')">
                <set name="RspCod" value="00000" />
                <set name="RspMsg" value="页面跳转成功" />
                <set name="USRMP" expr="USRMP" />
                <set name="PAGE" value="/register/filluserinfo.jsp" />
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, PAGE)" />
                <return />
            </if>
            <!-- 下一步跳转页面 复用-->
            <if condition="IS_EQUAL_STRING(FLAG,'M')">
                <set name="RspCod" value="00000" />
                <set name="RspMsg" value="页面跳转成功" />
                <set name="USRMP" expr="USRMP" />
                <set name="PAGE" value="/security/upPayPwd.jsp" />
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, PAGE)" />
                <return />
            </if>
            <!-- 检查用户登录平台是否正确 -->
            <if
                condition="AND(IS_NOEQUAL_STRING(SysCod,'0001'),IS_NOEQUAL_STRING(SysCod,'0004'))">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>
            <set name="UsrMp"      expr="phone"/>
            <!-- 检查手机号是否为空 -->
            <set name="UsrMp" expr="DELBOTHSPACE(UsrMp)" />
            <if condition="IS_EQUAL_STRING(UsrMp,'')">
                <set name="RspCod" value="02035" />
                <set name="RspMsg" value="手机号为空" />
                <return />
            </if>

            <if condition="IS_EQUAL_STRING(RandStr,'')">
                <set name="RspCod" value="02035" />
                <set name="RspMsg" value="请输入校验码" />
                <return />
            </if>
            <!-- 验证验证码是否正确 -->
            <if condition="ISNULL(HRANDSTR)">
               <set name="MsgTyp" value="E" />
               <set name="RspCod" value="02981" />
               <set name="RspMsg" value="验证码不能为空" />
               <return />
            </if>
            <if condition="ISNULL(SESSIONS.SRA)">
               <set name="MsgTyp" value="E" />
               <set name="RspCod" value="02981" />
               <set name="RspMsg" value="验证码超时" />
               <return />
            </if>
            <set name="HRANDSTR" expr="TOUPPER(HRANDSTR)" />
            <set name="SRATMP" expr="TOUPPER(SESSIONS.SRA)" />
            <if condition="IS_NOEQUAL_STRING(HRANDSTR,SRATMP)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02980" />
                <set name="RspMsg" value="验证码错误" />
                <return />
            </if>

            <set name="newUsrId" expr="SESSIONS.USRID" />

            <!-- 检查手机号是否已注册 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrInf" />
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </if>
            <elseif condition="#RetCod==2">
                <set name="RspMsg" value="该用户未注册" />
            </elseif>
            <elseif condition="#RetCod==0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02161" />
                <set name="RspMsg" value="该用户已注册" />
                <return />
            </elseif>
            <else>
                <set name="RspCod" value="09998" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </else>

            <if condition="ISNUMBER(UsrMp)">
                <set name="VER_TYPE" value="0" /><!--验证类型 0：短信验证 1：邮箱验证 -->
            </if>
            <else>
                <set name="VER_TYPE" value="1" /><!--验证类型 0：短信验证 1：邮箱验证 -->
            </else>

            <if condition="ISNULL(SERVICE_TYPE)">
                <set name="SERVICE_TYPE" value="00" /><!--验证码服务类型 00-注册短信验证 01-修改密码短信验证 
                    02-找回密码短信验证 03-数字证书短信验证 04-帐号变更短信验证 05-消费支付短信验证 -->
                <if condition="IS_EQUAL_STRING(FLAG,'1')">      
                       <set name="SERVICE_TYPE" value="02" />             
                   </if>
            </if>
            <else>
                <set name="SERVICE_TYPE" expr="SERVICE_TYPE" />
            </else>

            <!-- 查询验证码 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrIdverifycode" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02009" />
                <set name="RspMsg" value="该用户未申请校验码" />
                <return />
            </if>
            <elseif condition="#RetCod==-1">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09998" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
            <!--超时时间判断,timdif：为距离现在间隔多少分钟，timeout：超时时间 -->
            <if condition="INTCMP(timdif,6,timeout)">
                <set name="RspCod" value="02005" />
                <set name="RspMsg" value="校验码已失效,请重新获取校验码" />
                <return />
            </if>

            <!-- 比较验证码 -->
            <if condition="IS_NOEQUAL_STRING(RandStr,Random)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02006" />
                <set name="RspMsg" value="校验码错误，请重新输入。" />
                <return />
            </if>
            <delete name="Random" />
            <!-- 防止数据库保存验证码数据量过大，交易成功后即删除用户验证码信息 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="DelUsrIdInfo" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp" value="N" />
                <set name="RspCod" value="02009" />
                <set name="RspMsg" value="未找到验证码登记信息" />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
   </transaction>
   
   <transaction code="561118" desc="手机验证码验证通过跳转">
     <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
       DELETE FROM STPVERIFY  
       WHERE VER_ID=#{UsrMp} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
     </sql>   
     <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
       SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,timeout,InsTim,Random 
       FROM STPVERIFY 
       WHERE VER_ID=#{UsrMp} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
     </sql>
     <sql name="QryUsrInf"> <!--  查询用户注册数据  -->
       SELECT CUST_ID 
       FROM STPUSRINF 
       WHERE CUST_LOGIN=#{UsrMp}
       and CUST_ID not in (#{newUsrId})
     </sql>
     <process>
       <!-- 检查用户登录平台是否正确 -->
       <if condition="AND(IS_NOEQUAL_STRING(SysCod,'0001'),IS_NOEQUAL_STRING(SysCod,'0004'))">
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>

       <!-- 检查手机号是否为空 -->
       <set name="UsrMp"           expr="DELBOTHSPACE(UsrMp)"/>
       <if condition="IS_EQUAL_STRING(UsrMp,'')">
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="手机号为空"/>
         <return/>
       </if>
       
       <!--  if condition="IS_EQUAL_STRING(RandStr,'')">
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="请输入校验码"/>
         <return/>
       </if-->

       <set name="newUsrId"       expr="SESSIONS.USRID"/>

       <!-- 检查手机号是否已注册 -->
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd"   sql="QryUsrInf" />
       </do>
       <if condition="#RetCod==-1">
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </if>
       <elseif condition="#RetCod==2">
         <set name="RspMsg"        value="该用户未注册"/>
       </elseif>
       <elseif condition="#RetCod==0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02161"/>
         <set name="RspMsg"        value="该用户已注册"/>
         <return/>
       </elseif>
       <else>
         <set name="RspCod"        value="09998"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </else>
       
       
      
       
       <set name="MsgTyp"          value="N"/>
       <set name="RspCod"          value="00000"/>
       <set name="RspMsg"          value="交易成功"/>
       <set name="_REQUESTATTR.FORWARDURL"       value="html/registe/userregiste.jsp"/>
    </process>
   </transaction>
   
   <transaction code="PhoneReg" desc="手机用户注册" >
     <sql name="QryUsrIdInf"> <!--  查询用户注册信息  -->
       SELECT CUST_ID
       FROM STPUSRINF 
       WHERE  CUST_LOGIN=#{UsrMp}
     </sql>
     <sql name="InsUsrInfo"> <!--  插入用户注册信息  -->
       INSERT INTO STPUSRINF (CUST_ID, CUST_LOGIN, CUST_PWD, USR_MOBILE, NATIONALITY,PASSWORD_STRENGTH, PAYPWD_STRENGTH, USR_STATUS,LAST_UPPWD_TIME,PUBLIC_STATUS,
       PUBLIC_PHOTO) VALUES  (#{CUST_ID},#{UsrMp},#{UsrPwd}, #{UsrMp},'',#{PWDSTRE},#{PAYSTRE},'0',#{CUST_REG_DATE},#{PUBLIC_STATUS},#{PUBLIC_PHOTO})
     </sql>
      <sql name="UpdMsgSed"><!--  更新短信发送状态  -->
       UPDATE STPMSGSED SET MSG_STS='1' WHERE PHONE=#{USRMP} AND MSG_TIM=#{MSG_TIM}
     </sql>
     <sql name="InMsgSed"><!--  登记短信信息  -->
       INSERT INTO STPMSGSED
       VALUES(#{USRMP},#{MSG_DAT},#{MSG_TIM},#{CUS_NAM},#{SMSCONTENT},'0')
     </sql>
     <sql name="InsUsrrandom"> <!--  插入用户验证信息  --> 
       INSERT INTO  STPVERIFY (VER_ID,VER_TYPE,InsTim,Random,TimeOut,SERVICE_TYPE,VER_TRAN_NO) 
       VALUES (#{EMAIL},#{VER_TYPE}, sysdate ,#{Random},#{TimeOut},#{SERVICE_TYPE},#{TRANCODE}) 
     </sql> 
     <process>
        <if condition="IS_EQUAL_STRING(FLAG,'1')">
             <set name="LOGNAM" expr="LOGNAM" />
           <set name="PAGE"   value="/register/registesuccessed.jsp" />
           <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, PAGE)" />
           <return/>
       </if>
       <!-- 登录平台为0001：用户 -->
       <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
         <set name="RspCod"    value="01001"/>
         <set name="RspMsg"    value="用户登录平台不正确"/>
         <return/>
       </if>
       <!-- 检查用户名是否为空 -->
       <if condition="IS_EQUAL_STRING(UsrMp,'')">
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="手机号为空"/>
         <return/>
       </if>
       <do func="Lock">
          <para name="RecKey"     expr="UsrMp" />
          <para name="AutoUnLock" value="yes" />
       </do>
       <if condition="#RetCod!=0">
          <set name="RspCod"    value="08001"/>
          <set name="RspMsg"    value="该账户号正在注册，请稍后"/>
          <return/>
       </if>
       <!-- 检测用户是否存在,存在提示错误 -->
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd"  sql="QryUsrIdInf" />
       </do>
       <if condition="#RetCod==-1">
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </if>
       <elseif condition="#RetCod==0">
         <set name="RspCod"        value="02001"/>
         <set name="RspMsg"        value="该账户号已经被注册"/>
         <return/>
       </elseif>
       <elseif condition="#RetCod!=2">
         <set name="RspCod"        value="09998"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </elseif>
       
       <!--  检查真实姓名是否为空  -->
       <if condition="IS_EQUAL_STRING(UserName,'')">
         <set name="RspCod"        value="02042"/>
         <set name="RspMsg"        value="用户姓名为空"/>
         <return/>
       </if>
       <set name="IdTypeCod"    expr="IdTypeCod"/>
       <!--  证件类型:身份证  -->
       <if condition="IS_EQUAL_STRING(IdTypeCod,'')">
         <set name="IdTypeCod"    value="0"/>
       </if>
       
       <!--  检查证件号码是否为空  -->
       <if condition="IS_EQUAL_STRING(UserNo,'')">
         <set name="RspCod"       value="02045"/>
         <set name="RspMsg"        value="用户证件号码为空"/>
         <return/>
       </if>
       
       <set name="CARDVALDATE"      expr="FMTDATE(CALCDATE(GETDATE(),'-','d',7),0,4)"/>
       <set name="PUBLIC_PHOTO"     value="upload/defaultShow.jpg"/><!-- 公安返回照片 -->
       
       <!-- 读取配置文件 到公安部身份验证核实 -->
       <set name="ConfigName" value="FtpGetToPay" />
       <quote name="ReadXmlCfg" />
       <do func="ReadModuleCfg" error="IGNORE"> 
         <para name="cfgfil" value="etc/public/STP_BUSCFG.XML"/>
         <para name="code" value="CHK"/>
       </do>
       <if condition="IS_EQUAL_STRING(#para.ChkType,'1')">
         <if condition="IS_EQUAL_STRING(IdTypeCod,'0')"> 
           <set name="RspMsg"        value="用户为身份证用户"/>
           <do func="validIdCard"    error="IGNORE">
             <para name="name"       expr="UserName"/>
             <para name="idCardNo"   expr="UserNo"/>
           </do>
           <if condition="#RetCod==0">
             <set name="RspMsg"    value="身份认证成功"/>
             <set name="vailStatus"   value="1"/>
             <if condition="IS_EQUAL_STRING(status,'1')">
               <set name="vailCardUrl"  expr="picPath"/>
             </if>
             <else>
               <!--默认图片展示-->
               <set name="vailCardUrl"  value="upload/defaultShow.jpg"/>
             </else>
           </if>
           <else>
             <set name="vailStatus"   value="0"/>
             <set name="RspCod"    value="07565"/>
             <set name="RspMsg"    value="姓名和身份证不符！"/>
             <return/>
           </else>
           
           <set name="PUBLIC_STATUS" expr="vailStatus"/><!-- 公安部认证状态 -->
           <set name="PUBLIC_PHOTO"  expr="vailCardUrl"/><!-- 公安返回照片 -->
         </if>
       </if>
       
       <!-- 登录密码转加密 -->  
       <set name="pw"  expr="USRPWD"/>
       <quote name="getInputPwd"/>  
       <set name="UsrPwd"         expr="NewPwd"/>
       
       <!-- 检查登录密码是否为空 --> 
       <if condition="IS_EQUAL_STRING(UsrPwd,'')">
         <set name="RspCod"        value="02058"/>
         <set name="RspMsg"        value="用户登录密码为空"/>
         <return/>
       </if>
       
       <!-- 重复登录密码转加密 -->  
       <set name="pw"  expr="reUsrPwd"/>
       <quote name="getInputPwd"/>  
       <set name="reUsrPwd"         expr="NewPwd"/>  
       <if condition="IS_NOEQUAL_STRING(UsrPwd,reUsrPwd)">
        <set name="RspCod"        value="02058"/>
        <set name="RspMsg"        value="用户重复登录密码错误"/>
        <return/>
       </if>
         
       <!--  检查支付密码是否为空  --> 
       <if condition="IS_EQUAL_STRING(PayPwd,'')">
         <set name="RspCod"        value="02059"/>
         <set name="RspMsg"        value="用户支付密码为空"/>
         <return/>
       </if>
       
       <set name="pw"  expr="PayPwd"/>
       <quote name="getInputPwd"/>   
       <set name="PayPwd"          expr="NewPwd"/>
       <set name="AAAAAA"      value="新密码转加密成功"/>
       
       <set name="pw"  expr="rePayPwd"/>
       <quote name="getInputPwd"/>   
       <set name="rePayPwd"          expr="NewPwd"/>
       
       <if condition="IS_NOEQUAL_STRING(PayPwd,rePayPwd)">
        <set name="RspCod"        value="02058"/>
        <set name="RspMsg"        value="用户重复支付密码错误"/>
        <return/>
       </if>
       
       <if condition="IS_EQUAL_STRING(UsrPwd,PayPwd)">
         <set name="RspCod"        value="02058"/>
         <set name="RspMsg"        value="登录密码不能与支付密码相同"/>
         <return/>
       </if> 
        
       <!-- 获取公共信息 -->
       <quote name="getPublicInfo"/>
       
       <set name="UsrMp" expr="UsrMp"/>
       <set name="EMAIL" expr="EMAIL"/>
       
       <!-- 获取用户编号  --> 
       <do func="GetSeqNo"  error="IGNORE">
         <para name="TblNam" value="stpseqrec"/>
         <para name="KeyNam" value="KeyNam"/>
         <para name="KeyVal" value="STPCUSINF_CUSTID"/>
         <para name="SeqNam" value="KeyVal"/>
         <para name="Len"    value="8"/>
         <para name="Circle" value="1"/>
       </do>
       <if condition="#RetCod!=0">
         <set name="RspCod"    value="9001"/>
         <set name="RspMsg"    value="序号生成失败"/>
         <set name="DWZ_STATUS_CODE" value="300"/>
         <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
         <return/>
       </if> 
       <!-- 生成客户编号-用户ID -->
       <set name="CUST_ID"  expr="STRCAT('000001',KeyVal)"/>  
       
       <set name="Police"          value=""/>
         
       <!-- 客户状态0 正常 -->
       <set name="CUST_STATUS"      value="0"/>
       <!-- 客户证件类型  -->
       <set name="CUST_CRED_TYPE"   expr="IDTYPECOD"/>
       <!-- 客户证件号码  -->
       <set name="sEnData"          expr="DES_ENCRYPT(USERNO)"  />
       <set name="CUST_CRED_NO"     expr="sEnData"/>
       <!-- 客户名称  -->
       <set name="CUST_NAME"        expr="USERNAME"/>
       <!-- 客户类型  -->
       <set name="CUST_TYPE"         value="0"/>          <!--0 用户  1 商户-->
       <set name="CUST_REG_DATE"     expr="NowDate"/>
       <set name="CUST_REG_TIME"     expr="nowTime"/>
       
       <!-- 登记客户信息主表  -->
       <do func="InsertRecord" error="IGNORE">
          <para name="TblNam"  value="STPCUSINF"/>
       </do> 
       <if condition="#RetCod!=0"> 
          <set name="RspCod"    value="09999"/>
          <set name="RspMsg"    value="系统错误"/>  
          <return/>
       </if>
          
       <!-- 插入用户信息表 -->    
       <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="InsUsrInfo"/>
       </do>
       <if condition="#RetCod!=0"> 
          <!-- 回滚数据库 -->
          <do func="RollBackWork"/> 
          <set name="MsgTyp"        value="E"/>
          <set name="RspCod"        value="09999"/>
          <set name="RspMsg"        value="系统错误"/>
          <return/>
       </if>
       
       <!--添加客户账户信息 如果存在多账户，动态添加即可-->
       <!-- 账户类型 01-现金账户；02-红包账户；03-平台账户；04-担保账户；05-保证金账户 --> 
       <set name="AC_TYPE"           value="01"/>
       <quote name="InsAccInf"/>
       
       <!-- 生成用户登录名 --> 
       <set name="First"     expr="SUBSTR(UsrMp,1,3)"/> 
       <set name="End"       expr="SUBSTR(UsrMp,8,SUB(STRLEN(UsrMp),7))"/>
       <set name="LOGNAM"    expr="STRCAT(First,'****',End)"/>
       <set name="USRID"     expr="CUST_ID"/>
       
       <!-- 调用风控接口 -->
       <set name="dType"        value="1"/> 
       <set name="USR_STATUS"   value="0"/>
       <set name="UFLAG"        value=""/>
       <set name="FTYPE"        value=""/>
       <set name="sthCode"      value="540504"/>
       <set name="UCODE"        expr="CUST_ID"/>
       <set name="UNAME"        expr="UserName"/>
       <set name="PAPERTYPE"    expr="CUST_CRED_TYPE"/>
       <set name="PCODE"        expr="USERNO"/>
       <set name="USERAPPFLAG"  expr="USR_STATUS"/>     <!--0 未认证-->
       <set name="ISTYPE"       value="0"/>             <!--0 非试用期-->
       <set name="DATE"         expr="GETDATE()"/>   
       <set name="TIME"         expr="GETDATETIME()"/>
       <set name="EMAIL"        value=""/>          <!--邮箱-->   
       <quote name="rcsMaro"/>
        
       <if condition="ISNUMBER(UsrMp)">
          <!-- 注册成功发送短信 设置短信内容 -->
          <set name="SmsContent"      expr="STRCAT('尊敬的',UserName,'（账户号：',USRMP,'），恭喜您已成为商物通网站的注册用户，请及时完成身份认证。')"/>
           
           <!-- 插入短信信息 -->
           <set name="Msg_Dat"         expr="GETDATE()"/>
           <set name="Msg_Tim"         expr="GETDATETIME()"/>
           <set name="Cus_Nam"         value="注册用户成功"/>
           <do func="ExecSql" error="IGNORE">
             <para name="SqlCmd" sql="InMsgSed"/>
           </do>
           <if condition="#RetCod!=0">
             <set name="RspCod"        value="01006"/>
             <set name="RspMsg"        value="登记短信发送表失败"/>
             <return/>
           </if>
           <do func="CommitWork"/>
           
           <!--取公共参数配置-->
           <set name="ConfigName"   value="SendSms"/>
           <quote name="ReadXmlCfg"/>
           <set name="NEWMSGSTS"  value="0"/>
           
           <!-- 发送短信 -->
           <do func="sendMesSwt" error="IGNORE">
              <para name="sendUrl"              value="http://59.41.60.158:8914/TradeAppServer/user/sms.jf"/>
              <para name="softwareSerialNo"     value="linan-jufeng"/>
              <para name="smspassword"          value="linan-@jufeng"/>
              <para name="SendId"               value="12"/>
              <para name="MobNo"                expr="UsrMp"/>
              <para name="Context"              expr="SmsContent"/>
           </do>
           <if condition="#RetCod!=0">
             <set name="RspCod"               value="1003"/>
             <set name="RspMsg"               value="短信发送失败"/> 
             <set name="NEWMSGSTS"   value="2"/>
           </if>
           <else>
              <set name="NEWMSGSTS"  value="1"/>
           </else>
           
           <delete name="Random"/>
           <delete name="SmsContent"/>
           
           <!-- 更新短信发送状态 -->
           <do func="ExecSql" error="IGNORE">
              <para name="SqlCmd" sql="UpdMsgSed" />
           </do>
           <if condition="#RetCod!=0">
              <set name="RspCod"       value="08517"/>
              <set name="RspMsg"       value="修改发送状态失败"/>
              <!--Sreturn/-->
           </if>
       </if>
       
       <set name="SESSIONS.USRID"       expr="CUST_ID" />
       <set name="SESSIONS.USRNAME"     expr="CUST_NAME" />
       <set name="SESSIONS.USRMP"       expr="UsrMp" />

       <set name="SESSIONS.LOGIN_NAME1" expr="LOGNAM" />  <!-- 将中间的值换成* -->
       <set name="SESSIONS.PAYACNO"     expr="STRCAT(CUST_ID,'01')" />
       <set name="SESSIONS.CUSTNO"      expr="CUST_ID" />
       <set name="SESSIONS.LOGIN"       value="0" />
       <set name="SESSIONS.MARK"        value="" />
       <set name="MsgTyp"               value="N"/>
       <set name="PRE_LOG_SUC_TIM"      expr="LOG_SUC_TIME" />
       <set name="PRE_LOG_SUC_IP"       expr="LOG_SUC_IP" />
       <set name="LOG_SUC_NUM"          value="0" />
       <set name="LOG_SUC_TIME"         expr="GETDATETIME('YYYYMMDDHHMI')" />
       <set name="LOG_SUC_IP"           expr="reqip" />
       <do func="InsertRecord" error="IGNORE">
           <para name="TblNam" value="STPCUSLOG" />
       </do>
       <set name="RspCod"               value="00000"/>
       <set name="RspMsg"               value="交易成功"/>
     </process>
   </transaction>
       
   <transaction code="561103" desc="找回密码(短信),接收账号,产生校验码">
     <sql name="QryUsrInf"> <!--  查询用户注册数据  -->
       SELECT * FROM STPUSRINF WHERE CUST_LOGIN=#{UsrMp}
     </sql>
     <sql name="QryMsgSend">
      select count(*) CNT from stpverify where ver_id = #{UsrMp} and service_type='00'  and (instim + numtodsinterval(1, 'minute'))>sysdate
     </sql> 
     <sql name="DelUsrIdInfo"> <!--  删除用户验证信息  -->
       DELETE FROM STPVERIFY 
       WHERE VER_ID=#{UsrMp} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
     </sql>
     <sql name="InsUsrrandom"> <!--  插入用户验证信息  --> 
       INSERT INTO  STPVERIFY (VER_ID,VER_TYPE,InsTim,Random,TimeOut,SERVICE_TYPE,VER_TRAN_NO) 
       VALUES (#{UsrMp},${VER_TYPE}, sysdate ,#{Random},#{TimeOut},#{SERVICE_TYPE},#{TRANCODE})
     </sql>
     <sql name="InMsgSed"><!--  登记短信信息  -->
       INSERT INTO STPMSGSED 
       VALUES(#{USRMP},#{MSG_DAT},#{MSG_TIM},#{CUS_NAM},#{SMSCONTENT},'1')
     </sql>
     <sql name="UpdMsgSed">
       update StpMsgSed set Msg_Sts='1' where Phone=#{UsrMp} and Msg_Tim=#{Msg_Tim}
     </sql>
     <process>
       <if condition="AND(IS_NOEQUAL_STRING(SysCod,'0001'),IS_NOEQUAL_STRING(SysCod,'0004'))"><!-- 检查用户登录平台是否正确 -->
          <set name="RspCod"    value="01001"/>
          <set name="RspMsg"    value="用户登录平台不正确"/>
          <return/>
       </if>
       
       <!-- 检查输入信息是否为空 -->
       <set name="UsrMp"           expr="DELBOTHSPACE(UsrMp)"/>
       <if condition="IS_EQUAL_STRING(UsrMp,'')"><!-- 检查手机号是否为空 -->
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="输入手机号为空"/>
         <return/>
       </if>

       <!--  检测用户是否存在  -->
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd"   sql="QryUsrInf" />
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02008"/>
         <set name="RspMsg"        value="用户信息不存在,请先注册"/>
         <return/>
       </if>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09998"/>
         <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
         <return/>
       </elseif>
       <!-- 验证码验证 -->
       <set name="RA"  expr="SESSIONS.SRA"/>
       <if condition="IS_NOEQUAL_STRING(TOUPPER(TMPRAND),RA)">
         <set name="RspCod"        value="02006"/>
         <set name="RspMsg"        value="验证码输入错误"/>
         <return/>
       </if>
       
       <!--检查短信发送时效性-->
       <do func="ReadRecord"       error="IGNORE">
         <para name="SqlCmd"       sql="QryMsgSend" />
       </do>
       <if condition="#RetCod!=0">
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </if> 
       
       <if condition="IS_NOEQUAL_STRING(CNT,'0')">
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="请1分钟后再点击"/>
         <return/>
       </if>
       
       <!--  随机字符串长度  -->
       <!--  随机字符: ALL 字母和数字;  NUM 数字;   STR 字母  -->
       <!--  大小写标识: MIX 混合;   UPP 大写;   LOW 小写;  -->
       <do expr="@TdRandom@generateMixRandom(6, 'NUM', 'LOW')"/>
       
       <if condition="IS_EQUAL_STRING(TimeOut,'')">
          <set name="TimeOut"   value="10"/>
       </if>
       <if condition="ISNUMBER(UsrMp)">
         <set name="VER_TYPE" value="0"/><!--验证类型 0：短信验证 1：邮箱验证 -->
       </if>
       <else>
         <set name="TimeOut" expr="MUL(24,60)" />
         <set name="VER_TYPE" value="1"/><!--验证类型 0：短信验证 1：邮箱验证 -->
       </else>
       
       <if condition="ISNULL(SERVICE_TYPE)">
          <set name="SERVICE_TYPE" value="02"/><!--验证码服务类型 00-注册短信验证 01-修改密码短信验证 02-找回密码短信验证 03-数字证书短信验证 04-帐号变更短信验证 05-消费支付短信验证 -->
       </if>
       <else>
           <set name="SERVICE_TYPE" expr="SERVICE_TYPE" />
       </else>
       
       <!-- 删除用户申请的验证码记录 -->
       <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="DelUsrIdInfo" />
       </do>
       <if condition="#RetCod==2">
         <set name="RspMsg"        value="该用户第一次申请验证码，无记录删除"/>
       </if>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </elseif>

       <!-- 插入用户验证表 -->
       <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="InsUsrrandom"/>
       </do>
       <if condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </if>
       <do func="CommitWork"/>
       
       <set name="SmsContent"      expr="STRCAT('尊敬的商物通用户，您的商物通身份校验码是：',Random,'。请您在10分钟内完成校验，如非本人操作，请及时修改密码以防被盗。')"/>
       
       <!-- 插入短信信息 -->
       <set name="Msg_Dat"         expr="GETDATE()"/>
       <set name="Msg_Tim"         expr="GETDATETIME()"/>
       <set name="Cus_Nam"         value="注册用户验证"/>
       
       <do func="ExecSql"          error="IGNORE">
         <para name="SqlCmd" sql="InMsgSed"/>
       </do>
       <if condition="#RetCod!=0">
         <set name="RspCod"        value="01006"/>
         <set name="RspMsg"        value="登记短信发送表失败"/>
         <return/>
       </if>
       <do func="CommitWork"/>
       
       <!-- 发送短信 -->
       <if condition="ISNUMBER(UsrMp)">
         <!--取公共参数配置-->
         <set name="ConfigName"   value="SendSms"/>
         <quote name="ReadXmlCfg"/>
         <!-- 发送短信 -->
         <quote name="SendSms"/>
         
         <delete name="Random"/>
         <delete name="SmsContent"/>
       </if>
       <else>
         <set name="ConfigName"   value="CheckEmailNew"/>
         <quote name="ReadXmlCfg"/>
         
         <set name="Email"     expr="UsrMp"/>                                                                                                                                       
         <set name="EmResAddr" expr="SmsContent"/>
         <!--发送邮件-->
         <do func="TdMailSendNew" error="IGNORE">
           <para name="EmTo"       expr="Email" />
           <para name="EmTitle"    value="注册" />
           <para name="EmText"     expr="Random" />
           <para name="EmResAddr"  expr="G_EMCOMPHTTP" />
         </do>
         <if condition="#RetCod!=0">
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="09999"/>
           <set name="RspMsg"        value="发送邮件失败"/>
           <return/>
         </if>
         <delete name="Random"/>
         <delete name="SmsContent"/>
         <delete name="EmResAddr"/>
         <delete name="G_EMPWD"/>
       </else>
       
       <do func="ExecSql" error="IGNORE">
          <para name="SqlCmd" sql="UpdMsgSed" />
       </do>
       <if condition="#RetCod!=0">
         <set name="RspCod"    value="1003"/>
         <set name="RspMsg"    value="修改发送状态失败"/>
         <set name="DWZ_STATUS_CODE"   value="300"/>
         <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
         <return/>
       </if>
       
       <set name="MsgTyp"          value="N"/>
       <set name="RspCod"          value="00000"/>
       <set name="RspMsg"          value="交易成功"/>
    </process>
   </transaction>

   <transaction code="561104" desc="找设密码">
     <sql name="QryUsrIdInf"> <!--  查询用户注册数据  -->
       SELECT * 
       FROM STPUSRINF 
       WHERE CUST_LOGIN=#{UsrMp}
     </sql>
     <sql name="UpdCuInfoInf"> <!--  重置登录密码  -->
       UPDATE STPUSRINF 
       SET PASSWORD=#{NUsrPwd}  
       WHERE CUST_LOGIN=#{UsrMp}
     </sql>
     <process>
       <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>

       <!-- 检查手机号是否为空 -->
       <if condition="IS_EQUAL_STRING(UsrMp,'')">
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="手机号为空"/>
         <return/>
       </if>

       <!--  检测用户是否存在  -->
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd"  sql="QryUsrIdInf" />
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02008"/>
         <set name="RspMsg"        value="用户信息不存在,请先注册"/>
         <return/>
       </if>
       <elseif condition="#RetCod==-1">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </elseif>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09998"/>
         <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
         <return/>
       </elseif>
       
       <!-- 判断修改密码类型：0：登录密码；1：支付密码 -->
       <switch expr="PwdType">
         <case value="0">
           <set name="NUsrPwd"  expr="password21"/>
            
           <!-- 检查登录密码是否为空 -->
           <if condition="IS_EQUAL_STRING(NUsrPwd,'')">
              <set name="RspCod"   value="02058"/>
              <set name="RspMsg"   value="输入新登录密码为空"/>
              <return/>
           </if>
           
           <set name="pw"  expr="NUsrPwd"/>
           <quote name="getInputPwd"/>  
           <set name="NUsrPwd"         expr="inPwd"/>    
           <set name="AAAAAA"      value="新支付密码转加密成功"/>
           
           <!-- 重置登录密码 -->
           <do func="ExecSql" error="IGNORE">        
             <para name="SqlCmd" sql="UpdCuInfoInf"/>
           </do>
           <if condition="#RetCod==-1">
             <set name="MsgTyp"    value="E"/>
             <set name="RspCod"    value="09999"/>
             <set name="RspMsg"    value="系统错误"/>
             <return/>
           </if>
           <elseif condition="#RetCod!=0">
             <set name="MsgTyp"    value="E"/>
             <set name="RspCod"    value="02010"/>
             <set name="RspMsg"    value="重置登录密码失败"/>
             <return/>
           </elseif>
           
         </case>
         <case value="1">
           <set name="NPayPwd"    expr="password11"/>
            
           <!-- 检查支付密码是否为空 -->
           <if condition="IS_EQUAL_STRING(NPayPwd,'')">
             <set name="RspCod"    value="02058"/>
             <set name="RspMsg"    value="输入新支付密码为空"/>
             <return/>
           </if>
           
           <set name="pw"  expr="NPayPwd"/>
           <quote name="getInputPwd"/>  
           <set name="NPayPwd"         expr="inPwd"/>   
           
         </case>
       </switch>
       
       <set name="MsgTyp"          value="N"/>
       <set name="RspCod"          value="00000"/>
       <set name="RspMsg"          value="交易成功"/>
     </process>
   </transaction>
   
   <transaction code="561105" desc="找回密码 验证码验证">
     <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
       DELETE FROM STPVERIFY  WHERE VER_ID=#{UsrMp} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
     </sql>   
     <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
       SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60 ) timdif,TimeOut,InsTim,Random 
       FROM STPVERIFY 
       WHERE VER_ID=#{UsrMp} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
     </sql>
     <sql name="QryUsrInf"> <!--  查询用户注册数据  -->
       SELECT CUST_ID 
       FROM STPUSRINF 
       WHERE CUST_LOGIN=#{UsrMp}
     </sql>
     <process>
       <!-- 检查用户登录平台是否正确 -->
       <if condition="AND(IS_NOEQUAL_STRING(SysCod,'0001'),IS_NOEQUAL_STRING(SysCod,'0004'))">
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>

       <!-- 检查手机号是否为空 -->
       <set name="UsrMp"           expr="DELBOTHSPACE(UsrMp)"/>
       <if condition="IS_EQUAL_STRING(UsrMp,'')">
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="手机号为空"/>
         <return/>
       </if>
       
       <!-- 检查手机号是否已注册 -->
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd"   sql="QryUsrInf" />
       </do>
       <if condition="#RetCod==-1">
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </if>
       <elseif condition="#RetCod==2">
         <set name="RspCod"        value="02102"/>
         <set name="RspMsg"        value="该用户未注册"/>
         <return/>
       </elseif>
       <elseif condition="#RetCod==0">
         <set name="RspCod"        value="02001"/>
         <set name="RspMsg"        value="该用户已注册"/>
       </elseif>
       <else>
         <set name="RspCod"        value="09998"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </else>
       
       <if condition="ISNUMBER(UsrMp)">
         <set name="VER_TYPE" value="0"/><!--验证类型 0：短信验证 1：邮箱验证 -->
       </if>
       <else>
         <set name="VER_TYPE" value="1"/><!--验证类型 0：短信验证 1：邮箱验证 -->
       </else>
       
       <if condition="ISNULL(SERVICE_TYPE)">
          <set name="SERVICE_TYPE" value="02"/><!--验证码服务类型 00-注册短信验证 01-修改密码短信验证 02-找回密码短信验证 03-数字证书短信验证 04-帐号变更短信验证 05-消费支付短信验证 -->
       </if>
       <else>
          <set name="SERVICE_TYPE" expr="SERVICE_TYPE"/>
       </else>
       
       <!--  查询验证码  -->
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd" sql="QryUsrIdverifycode" />
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02009"/>
         <set name="RspMsg"        value="该用户未申请校验码"/>
         <return/>
       </if>
       <elseif condition="#RetCod==-1">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </elseif>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09998"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </elseif>
       
       <!--超时时间判断,timdif：为距离现在间隔多少分钟，timeout：超时时间-->
       <if condition="INTCMP(timdif,6,timeout)">
        <set name="RspCod" value="02005" />
        <set name="RspMsg" value="校验码已失效,请重新获取校验码" />
        <return />
       </if>
       <!-- 比较验证码 -->
       <if condition="IS_NOEQUAL_STRING(RandStr,Random)">
         <set name="checkFlag"     value="N"/>
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02006"/>
         <set name="RspMsg"        value="校验码输入错误"/>
         <return/>
       </if>
       <delete name="Random"/>
       <!--  防止数据库保存验证码数据量过大，交易成功后即删除用户验证码信息  
       <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd"  sql="DelUsrIdInfo" />
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="N"/>
         <set name="RspCod"        value="02009"/>
         <set name="RspMsg"        value="未找到校验码登记信息"/>
       </if>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </elseif>-->
       
       <set name="checkFlag"       value="Y"/>
       <set name="MsgTyp"          value="N"/>
       <set name="RspCod"          value="00000"/>
       <set name="RspMsg"          value="交易成功"/>
    </process>
   </transaction>
   
   <transaction code="561107" desc="找回密码 验证码验证- 验证跳转">
     <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
       DELETE FROM STPVERIFY  WHERE VER_ID=#{UsrMp} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE}
     </sql>   
     <sql name="QryUsrIdverifycode"> <!--  查询用户注册验证码信息  -->
       SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60 ) timdif,TimeOut,InsTim,Random 
       FROM STPVERIFY 
       WHERE VER_ID=#{UsrMp} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
     </sql>
     <sql name="QryUsrInf"> <!--  查询用户注册数据  -->
       SELECT CUST_ID 
       FROM STPUSRINF 
       WHERE CUST_LOGIN=#{UsrMp}
     </sql>
     <process>
       <!-- 检查用户登录平台是否正确 -->
       <if condition="AND(IS_NOEQUAL_STRING(SysCod,'0001'),IS_NOEQUAL_STRING(SysCod,'0004'))">
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>

       <!-- 检查手机号是否为空 -->
       <set name="UsrMp"           expr="DELBOTHSPACE(UsrMp)"/>
       <if condition="IS_EQUAL_STRING(UsrMp,'')">
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="手机号为空"/>
         <return/>
       </if>
       
       <!-- 检查手机号是否已注册 -->
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd"   sql="QryUsrInf" />
       </do>
       <if condition="#RetCod==-1">
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </if>
       <elseif condition="#RetCod==2">
         <set name="RspCod"        value="02102"/>
         <set name="RspMsg"        value="该用户未注册"/>
         <return/>
       </elseif>
       <elseif condition="#RetCod==0">
         <set name="RspCod"        value="02001"/>
         <set name="RspMsg"        value="该用户已注册"/>
       </elseif>
       <else>
         <set name="RspCod"        value="09998"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </else>
       
       <if condition="ISNUMBER(UsrMp)">
         <set name="VER_TYPE" value="0"/><!--验证类型 0：短信验证 1：邮箱验证 -->
       </if>
       <else>
         <set name="VER_TYPE" value="1"/><!--验证类型 0：短信验证 1：邮箱验证 -->
       </else>
       
       <if condition="ISNULL(SERVICE_TYPE)">
          <set name="SERVICE_TYPE" value="02"/><!--验证码服务类型 00-注册短信验证 01-修改密码短信验证 02-找回密码短信验证 03-数字证书短信验证 04-帐号变更短信验证 05-消费支付短信验证 -->
       </if>
       <else>
          <set name="SERVICE_TYPE" expr="SERVICE_TYPE"/>
       </else>
       
       <!--  查询验证码  -->
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd" sql="QryUsrIdverifycode" />
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02009"/>
         <set name="RspMsg"        value="该用户未申请校验码"/>
         <return/>
       </if>
       <elseif condition="#RetCod==-1">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </elseif>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09998"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </elseif>
       
       <!--超时时间判断,timdif：为距离现在间隔多少分钟，timeout：超时时间-->
       <if condition="INTCMP(timdif,6,timeout)">
        <set name="RspCod" value="02005" />
        <set name="RspMsg" value="校验码已失效,请重新获取校验码" />
        <return />
       </if>
       <!-- 比较验证码 -->
       <if condition="IS_NOEQUAL_STRING(RandStr,Random)">
         <set name="checkFlag"     value="N"/>
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02006"/>
         <set name="RspMsg"        value="校验码输入错误"/>
         <return/>
       </if>
       <delete name="Random"/>
       <!--  防止数据库保存验证码数据量过大，交易成功后即删除用户验证码信息  -->
       <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd"  sql="DelUsrIdInfo" />
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="N"/>
         <set name="RspCod"        value="02009"/>
         <set name="RspMsg"        value="未找到校验码登记信息"/>
       </if>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </elseif>
       
       <set name="checkFlag"       value="Y"/>
       <set name="MsgTyp"          value="N"/>
       <set name="RspCod"          value="00000"/>
       <set name="RspMsg"          value="交易成功"/>
       <set name="_REQUESTATTR.FORWARDURL"       value="html/login/findPwdNext.jsp"/>
    </process>
   </transaction>
   
   <transaction code="userlogin" desc="手机用户登录,登录失败5次,用户不可自助登录"><!-- 561109改为userlogin -->
        <sql name="QryUsrIdInf"> <!-- 查询用户注册信息 -->
            SELECT u.CUST_ID,u.CUST_LOGIN,u.CUST_PWD,g.pay_ac_no as
            PAYACNO,c.CUST_NAME,c.CUST_STATUS,email_status as emailstatus,c.cust_reg_date
            FROM
            STPUSRINF u,ARP_AC_CUST_REL g,STPCUSINF c
            WHERE u.CUST_LOGIN=#{UsrId}
            and g.cust_id = u.cust_id and u.cust_id =
            c.cust_id
        </sql>
        <sql name="QryBalInf">  <!-- 查询用户余额信息 -->
            SELECT DAY_NUM AS DAYNUM FROM STPBALINF
            WHERE CUST_ID=#{CUST_ID} AND
            PAY_AC_NO=#{PAYACNO}
        </sql>
        <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
            SELECT 
            EXTRACT(DAY FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*24*60 + EXTRACT(HOUR FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*60 +  EXTRACT(MINUTE FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND )) as timeDifference,
            CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
            FROM STPLOGTMP
            WHERE LOGIN_NAME = #{UsrId} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
            INSERT INTO STPLOGTMP
            (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
            VALUES (#{USRID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
        </sql>
        <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
            LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{UsrId}  AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
            WHERE LOGIN_NAME=#{UsrId} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="UpdUsrLoginCount"><!-- 修改登录信息 -->
            CUST_ID=#{CUST_ID}
        </sql>
        <sql name="selCusLog"><!-- 查询上次登录信息 -->
            select * from stpcuslog
            where cust_id = #{cust_id}
        </sql>
        <sql name="SelId"><!--用于数字证书查询 -->
            SELECT DN FROM CUST_CERTINF WHERE CUST_ID=#{USRID} ORDER BY VAL_DATE
            DESC
        </sql>
        <sql name="QrySysAuth"><!--查询系统权限 -->
            SELECT  OTHER_CUST_ID,CUST_LOG_ID,SYS_TYPE
               FROM STPUMREF WHERE  cust_id = #{CUST_ID}  ORDER BY SYS_TYPE DESC 
        </sql>
        <process>
            <!-- 用户登录平台为0001：用户 -->
            <if condition="IS_NOEQUAL_STRING(SYSCOD,'0001')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" expr="GETMSG(SESSIONS.LANGUAGE, 'COMMON_001')" /><!--用户登录平台不正确 -->
                <return />
            </if>

            <!-- 检查用户登录名是否为空 -->
            <if condition="IS_EQUAL_STRING(DELBOTHSPACE(UsrId),'')">
                <set name="RspCod" value="02058" />
                <set name="RspMsg" expr="GETMSG(SESSIONS.LANGUAGE, 'LOGIN_001')" /><!--用户名为空 -->
                <return />
            </if>
            <set name="UsrIdS" expr="UsrId" />
            
            <!-- 查询用户注册信息 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrIdInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="用户不存在！" />
                <return />
            </if>
            
            <!-- 用户登录密码锁定次数判断 -->
             <set name="UsrId" expr="DELBOTHSPACE(UsrId)" />
             <set name="CUSTTYPE"  value="0"/><!--0用户1 商户 2企业-->
             <set name="PWDTYPE"   value="0"/><!--0:登录密码 1:支付密码-->
             <set name="FailFlag"  value="0"/>
             <quote name="usrpwdlock"/>
             <!-- 用户登录密码锁定次数判断 -->
             
            <!-- 验证码后台验证 -->
            <set name="ra" expr="SESSIONS.SRA" />
            <set name="RAND" expr="TOUPPER(RAND)"/>
            <if condition="IS_NOEQUAL_STRING(RA,RAND)">
                <set name="RspCod" value="02006" />
                <set name="RspMsg" value="验证码输入错误" />
                <return />
            </if>
            
            <set name="USRID" expr="CUST_ID" />
            <!-- 账户禁用或已注销不能登录 -->
            <set name="CUST_STATUS"    expr="CUST_STATUS"/>
            <if condition="IS_EQUAL_STRING(CUST_STATUS,'9')">
              <set name="MsgTyp"        value="E"/>
              <set name="RspCod"        value="02890"/>
              <set name="RspMsg"        value="账户已注销,不能登录！"/>
              <return/>
            </if>
            
            <set name="USRID" expr="USRIDS" />
            <set name="pwd" expr="USRPWD" />
            <quote name="PwdAesToDes" />
            <set name="inPwd" expr="NewPwd" />
            <!-- 判断登陆密码是否正确 -->
            <if condition="IS_NOEQUAL_STRING(DELBOTHSPACE(CUST_PWD),DELBOTHSPACE(inPwd))">
                <set name="RspCod" value="002036" />
                <set name="RspMsg" value="用户名或密码错误" />
                <quote name="UpLoginInfo"/>
                <return/>
            </if>

            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="selCusLog" />
            </do>
            <set name="reqip" expr="GetRequestAttr('REQIP')" />
            <if condition="#RetCod==2">
                <!-- 登录次数+1 -->
                <set name="PRE_LOG_SUC_TIM"  expr="LOG_SUC_TIME" />
                <set name="PRE_LOG_SUC_IP"   expr="LOG_SUC_IP" />
                <set name="LOG_SUC_NUM"      value="0" />
                <set name="LOG_SUC_TIME"     expr="GETDATETIME('YYYYMMDDHHMI')" />
                <set name="LOG_SUC_IP"       expr="reqip" />
                <do func="InsertRecord" error="IGNORE">
                    <para name="TblNam" value="STPCUSLOG" />
                </do>
                <if condition="#RetCod!=0">
                    <set name="RspMsg" value="修改登录次数，失败" />
                </if>
            </if>
            <elseif condition="#RetCod==0">
                <!-- 登录次数+1 -->
                <set name="PRE_LOG_SUC_TIM" expr="LOG_SUC_TIME" />
                <set name="PRE_LOG_SUC_IP"  expr="LOG_SUC_IP" />
                <set name="LOG_SUC_NUM"     expr="ADD(LOG_SUC_NUM,1)" />
                <set name="LOG_SUC_TIME"    expr="GETDATETIME('YYYYMMDDHHMI')" />
                <set name="LOG_SUC_IP"      expr="reqip" />
                <do func="UpdateRecord" error="IGNORE">
                    <para name="TblNam" value="STPCUSLOG" />
                    <para name="CndSts" sql="UpdUsrLoginCount" />
                </do>
                <if condition="#RetCod!=0">
                    <set name="RspMsg" value="修改登录次数，失败" />
                </if>
            </elseif>

            <!-- 查询用户余额信息 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryBalInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspMsg" value="用户余额信息符合条件" />
            </if>
            <elseif condition="#RetCod==0">
                <if condition="INTCMP(DAYNUM,5,10)">
                    <set name="balFlag" value="1" />
                </if>
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误，请稍后再试或联系客服" />
            </elseif>
            
            <!-- 修改登记失败信息表 -->
            <do func="ExecSql" error="IGNORE">
               <para name="SqlCmd" sql="UpdUsrLogInfo"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="RSPCOD" value="02040"/>
               <set name="RSPMSG" value="更新登录信息失败!"/> 
               <return/>
            </if>
            
            <!-- 登录状态 -->
            <set name="MsgTyp"               value="N" />
            <set name="RspCod"               value="00000" />
            <set name="RspMsg"               value="交易成功" />
            <set name="SESSIONS.USRID"       expr="CUST_ID" />
            <set name="SESSIONS.USRNAME"     expr="CUST_NAME" />
            <set name="SESSIONS.USRMP"       expr="CUST_LOGIN" />
            <set name="First"                expr="SUBSTR(CUST_LOGIN,1,3)" />
            <set name="End"                  expr="SUBSTR(CUST_LOGIN,8,SUB(STRLEN(CUST_LOGIN),7))" />
            <set name="LOGNAM"               expr="STRCAT(First,'****',End)" />
            <set name="SESSIONS.LOGIN_NAME1" expr="LOGNAM" />  <!-- 将中间的值换成* -->
            <set name="SESSIONS.PAYACNO"     expr="PAYACNO" />
            <set name="SESSIONS.CUSTNO"      expr="CUST_ID" />
            <set name="LOGIN"                expr="SESSIONS.LOGIN" />
            <set name="SESSIONS.LOGIN"       value="0" />
            <set name="SESSIONS.MARK"        expr="mark" />
        </process>
    </transaction>
   
   <transaction code="userAccountInfo" desc="用户信息显示">
        <sql name="ChkUerInfo"><!--查询用户信息 -->
            select a.CUST_ID, a.CUST_LOGIN, a.usr_email as EMAIL,
            nvl(a.usr_fax,'
            ') as FAX,
            nvl(a.usr_address,' ') as ADDRESS, nvl(a.usr_zip,' ') as
            ZIP,
            nvl(a.usr_job,' ') as JOB, nvl(a.usr_telnum,' ') as TELNUM,
            nvl(a.cust_login,' ') as MOBILE, nvl(a.usr_befnam,' ') as
            USER_BEFORENAME,
            nvl(a.usr_birthday,' ') as BIRTHDAY,
            nvl(a.usr_gender,' ') as GENDER,
            a.email_status as EMAIL_STATE,
            nvl(PASSWORD_STRENGTH,' ') as PSSTRENGTH,nvl(PAYPWD_STRENGTH,' ') as
            PYSTRENGTH,
            To_Char(to_date(c.cust_reg_date||c.cust_reg_time,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as REGISTER_DATE,
            nvl(c.cust_name,' ') as USER_NAME,
            c.cust_cred_no as USER_NO, c.cust_cred_type as
            ID_TYPE_CODE,c.cust_status as STATE,
            l.log_suc_time,To_Char(to_date(l.PRE_LOG_SUC_TIM,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as LAST_LOGIN_TIME,a.USR_STATUS as U_AUTH_STATUS
            from
            stpusrinf a,stpcusinf c,stpcuslog l
            where a.CUST_ID='${CUST_NO}' and
            a.cust_id = c.cust_id and a.cust_id =
            l.cust_id
        </sql>
        <sql name="QryMainNum"><!-- 查询绑定银行卡的数量 -->
            SELECT count(*) MAINNUM FROM STPBANKTB WHERE CUST_ID=#{USRID} AND CARD_TYPE in ('0','00')
        </sql>
        <sql name="stpusraut"> <!-- 查询用户认证信息 -->
            SELECT a.USR_STATUS as U_AUTH_STATUS , c.cust_cred_type as
            u_card_type,
            c.cust_cred_no as u_card_no, m.enm_dat_des as cardType,
            n.enm_dat_des as authstatus
            FROM stpusrinf a, stpcusinf c ,lyxdicenm
            m, lyxdicenm n
            WHERE a.CUST_ID=${CUST_NO} and a.cust_id=c.cust_id and
            c.cust_cred_type=trim(m.Enm_Dat_Opt) and m.sys_id='0001'
            and
            trim(m.enm_en_nam) like 'cardType'
            and a.USR_STATUS =
            trim(n.Enm_Dat_Opt) and n.sys_id='0001' and
            trim(n.enm_en_nam) like
            'authStatus'
        </sql>
        <sql name="selLestTime">
            select to_char(to_date(PRE_LOG_SUC_TIM,'yyyy-mm-dd hh24:mi:ss'),'yyyy-mm-dd hh24:mi:ss') as PRE_TIM
            from stpcuslog
            where
            cust_id = #{cust_id}
        </sql>
        <sql name="QryUsrInfPay"> <!-- 查询用户认证信息 -->
            SELECT U.CUST_LOGIN AS LOGNAM,C.CUST_NAME AS userNam,c.CUST_STATUS,
            C.CUST_ID AS custno,C.CUST_CRED_NO AS
            U_CARD_NO,
            C.CUST_CRED_TYPE AS U_CARD_TYPE, U.PUBLIC_PHOTO AS
            U_PHOTO_MPS
            FROM STPUSRINF U,STPCUSINF C
            WHERE
            U.CUST_ID=#{USRID} AND C.CUST_ID = U.CUST_ID
        </sql>
        <sql name="queBal">
            select PAY_AC_NO as PAYACNO,AC_STATUS,
            CASH_AC_BAL-FROZ_BALANCE as casfroz,
            CASH_AC_BAL as CASHACBAL,
            FROZ_BALANCE as FROZBALANCE,
            TO_CHAR(to_number(CASH_AC_BAL)/100,'9999999999990.00') as CashAcBal1,
            TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'9999999999990.00')
            as usrBal,
            TO_CHAR(to_number(CASH_AC_BAL)/100,'9999999999990.00') as
            acBal,
            TO_CHAR(to_number(FROZ_BALANCE)/100,'9999999999990.00') as
            noUsrBal,
            TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'9999999999990.00')
            as getBal,
            TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'9999999999990.00')
            as payCBal
            from ARP_AC_PROFILE
            where PAY_AC_NO = #{payacno}
        </sql>
        <sql name="SelAccTypeInf"><!--查询用户理财账户金额 -->
            select p.PAY_AC_NO as PAYACNO,AC_STATUS,p.ac_type,
            nvl(CASH_AC_BAL,0) as CASHACBAL,
            nvl(FROZ_BALANCE,0) as FROZBALANCE,
            nvl(CASH_AC_BAL,0)-nvl(FROZ_BALANCE,0) as CASHBALFROZ,
            TO_CHAR(to_number(nvl(CASH_AC_BAL,0))/100,'9999999999990.00') as
            CASHBAL,
            TO_CHAR(to_number(nvl(FROZ_BALANCE,0))/100,'9999999999990.00') as
            FROZBAL,
            TO_CHAR(to_number(nvl(CASH_AC_BAL,0)-nvl(FROZ_BALANCE,0))/100,'9999999999990.00')
            as USRBAL
            from ARP_AC_PROFILE p,arp_ac_cust_rel c
            where p.pay_ac_no=c.pay_ac_no and c.cust_id = #{CUST_ID} and p.ac_type=#{ac_type}
        </sql>    
        <sql name="QryEarnings">
            SELECT a.ID as finaordNO,a.VERSIONID,CUST_ID,FINANAMT,TOTALPROFIT,
            TO_CHAR(to_number(nvl(TOTALPROFIT,0))/100,'9999999999990.00') as TOTALSPITAMTS
              FROM FINANCIAL_PRDINF  a left join  FINANCIAL_RATE_SET b on  a.versionid=b.versionid 
              WHERE  PRDSTATUS=#{PRDSTATUS}   and cust_id=#{USRID} 
              and INVESTTYPE=#{INVESTTYPE} and EFFECTTYPE=#{EFFECTTYPE}
        </sql>
        <sql name="SelectRegularTotalAmt"> <!--查询用户定期理财累计收益 -->
            select cust_id,TO_CHAR(to_number(sum(nvl(TOTALPROFIT,0)))/100,'9999999999990.00') as RegularTotalAmt
            FROM FINANCIAL_PRDINF  a left join  FINANCIAL_RATE_SET b on  a.versionid=b.versionid 
            WHERE  PRDSTATUS=#{PRDSTATUS}   and cust_id=#{USRID} 
              and INVESTTYPE=#{INVESTTYPE} and EFFECTTYPE=#{EFFECTTYPE}  group by cust_id 
        </sql>  
        <process>
            <!--检查用户登录平台是否正确 -->
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台错误" />
                <return />
            </if>
            <if condition="ISNULL(SESSIONS.USRMP)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="01002" />
                <set name="RspMsg" value="您还没有登录，请先登录！" />
                <set name="_REQUESTATTR.FORWARDURL" value="index.jsp" />
                <return />
            </if>
            <set name="USRID" expr="SESSIONS.USRID" />
            <set name="CUST_NO"      expr="SESSIONS.CUSTNO"/>
            <set name="PAYACNO"      expr="SESSIONS.PAYACNO"/>
            <!-- 查询用户信息 -->
            <quote name="selUserInfo" />
            <!-- 查询用户余额 -->
            <quote name="selUserBalance" />
            <set name="PAYCBALTEMP" expr="PAYCBAL"/>
             
             <!-- 理财活期帐号余额 -->
             <set name="ac_type" value="06"/>
             <quote name="chkacTypeAcc"/>
             
             <!-- 理财活期帐户余额重定义 -->
             <set name="investCASHACBAL"   expr="CASHACBAL"/>
             <set name="investFROZBALANCE" expr="FROZBALANCE"/>
             <set name="investCASHBALFROZ" expr="CASHBALFROZ"/>
             <set name="investCASHBAL"     expr="CASHBAL"/>
             <set name="investFROZBAL"     expr="FROZBAL"/>
             <set name="investUSRBAL"      expr="USRBAL"/>
             <!-- 理财活期帐户余额重定义 -->
             
             <set name="PRDSTATUS"  value="01"/><!--01 已支付-->
             <set name="INVESTTYPE" value="2"/><!--1:定期/2:活期-->
             <set name="EFFECTTYPE" value="0"/><!--0：启动1：禁用-->
             
             <!-- 查询用户理财总收益  信息 -->
             <!--do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd"   sql="QryEarnings" />
             </do>
             <if condition="#RetCod==2">
               <set name="MsgTyp"        value="E"/>
               <set name="RspCod"        value="02018"/>
               <set name="RspMsg"        value="该用户理财信息不存在"/>
               <set name="TATALAMT"          value="0"/>
               <set name="TOTALSPITAMT"      value="0"/>
               <set name="TATALAMTS"          value="0.00"/>
               <set name="TOTALSPITAMTS"      value="0.00"/>
             </if>
             <elseif condition="#RetCod!=0">
               <set name="MsgTyp"        value="E"/>
               <set name="RspCod"        value="02008"/>
               <set name="RspMsg"        value="数据库错误"/>
               <return/> 
             </elseif-->
             
             <set name="TATALAMT"           value="0"/>
             <set name="TOTALSPITAMT"       value="0"/>
             <set name="TATALAMTS"          value="0.00"/>
             <set name="TOTALSPITAMTS"      value="0.00"/>
             
             <!-- 查询用户定期理财金额-->
             <set name="ac_type" value="07"/>
             <quote name="chkacTypeAcc"/>
             <set name="RegulAmt"  expr="USRBAL"/>
             
             <set name="INVESTTYPE" value="1"/><!--1:定期/2:活期-->
             
             <!-- 查询用户定期理财总收益  信息 -->
             <!--do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd"   sql="SelectRegularTotalAmt" />
             </do>
             <if condition="#RetCod==2">
               <set name="MsgTyp"        value="E"/>
               <set name="RspCod"        value="02018"/>
               <set name="RspMsg"        value="该用户理财信息不存在"/>
               <set name="RegularTotalAmt"      value="0.00"/>
             </if>
             <elseif condition="#RetCod!=0">
               <set name="MsgTyp"        value="E"/>
               <set name="RspCod"        value="02008"/>
               <set name="RspMsg"        value="数据库错误"/>
               <return/> 
             </elseif-->
             <if condition="ISNULL(REGULARTOTALAMT)">
                 <set name="RegularTotalAmt" value="0.00"/>
             </if>
             
            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
            <set name="_REQUESTATTR.FORWARDURL"  expr="STRCAT('html/', SESSIONS.LANGUAGE, '/account/accounthome.jsp')" />
        </process>
    </transaction>
    
    <transaction code="selectTranInfoAll" desc="用户交易查询-充值、提现、转账、消费、退款  ">
        <sql name="queryAllInf"> <!-- 查询用户收款交易记录 -->
           select  '' AS RFTOTALAMT,'' RFTOTALAMT1,p.TXAMT ORDAMT1,p.TRAORDNO as prdOrdNo1,p.TRAORDNO as prdOrdNo, '转账 - 付款' prdName,
                   To_Char(to_date(p.traTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as orderDate ,
                   p.batno as Transort,'付款' as TransortName,   
                   TO_CHAR(to_number(p.TXAMT)/100,'FM9999,999,999,990.00') as ORDAMT, ordstatus, 
                   ordstatusName,'' sup_status,
                   1 as pageflags 
             from vw_StpTraInf p 
            where  ${USERID1}  ${prdOrdNo1} ${orderDate1}  ${OrdStatus1}
           
           union
           select  '' AS RFTOTALAMT,'' AS RFTOTALAMT1,p.txAmt ORDAMT1,p.TRAORDNO as prdOrdNo1,p.TRAORDNO as prdOrdNo, '转账 - 收款' prdName,
                  To_Char(to_date(p.traTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as orderDate ,'' as Transort,'收款' as TransortName,   
                  TO_CHAR(to_number(p.TXAMT)/100,'FM9999,999,999,990.00')    as ORDAMT,  OrdStatus    ,
                  ordstatusName,'' sup_status,5 as pageflags
             from vw_StpTraInf p
            where ordstatus = '01' and ${USERID5} ${prdOrdNo5} ${orderDate5} 
           
           union
           select  TO_CHAR(TO_NUMBER(nvl(P.RFTOTALAMT,0))/100,'FM9999,999,999,990.00') AS RFTOTALAMT,RFTOTALAMT RFTOTALAMT1,p.ORDAMT ORDAMT1,
                   p.PRDORDNO as prdOrdNo1,p.PRDORDNO as prdOrdNo,decode(p.prdordtype,'0','消费 - 即时支付','1','充值','2','消费 - 担保支付') as prdName ,
                   To_Char(to_date(p.orderTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')  as orderDate ,
                   '' as transort,TransortName,   TO_CHAR(to_number(p.ORDAMT)/100,'FM9999,999,999,990.00') as ORDAMT, 
                   p.ordstatus as ordstatus,ordstatusName, (case when nvl(RFTOTALAMT,0)>0 then '1' else '0' end) as sup_status,
                   decode(p.prdordtype,'1',4,2) as pageflags 
             from vw_StpPrdInf p
            where ${USERID2} 
                 ${prdOrdNo2} ${orderDate2}  ${OrdStatus2} ${transort2}
            
           union
           select  '' AS RFTOTALAMT,'' AS RFTOTALAMT1,p.txAmt ORDAMT1,p.casOrdNo as prdOrdNo1,p.casOrdNo as prdOrdNo, '提现' prdName,
                   To_Char(to_date(p.actDat,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')  as orderDate    ,'' as Transort,'提现' as TransortName,   
                   TO_CHAR(to_number(p.txAmt)/100,'FM9999,999,999,990.00')     as ORDAMT,    ordstatus,ordstatusName ,'' sup_status,3 as pageflags 
             from vw_StpCasInf p
            where ${USERID3} 
                 ${prdOrdNo3} ${orderDate3}  ${OrdStatus3}
           
           union
           
           select  '' AS RFTOTALAMT,'' AS RFTOTALAMT1,p.RFAMT ORDAMT1,p.REFORDNO as prdOrdNo1,p.REFORDNO as prdOrdNo, '退款' prdName,
                   To_Char(to_date(p.RFORDTIME,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')  as orderDate    ,'' as Transort,'退款' as TransortName,   
                   TO_CHAR(to_number(p.RFAMT)/100,'FM9999,999,999,990.00')     as ORDAMT,    ordstatus, 
                   (case when ORDSTATUS='00' then '等待处理' when ORDSTATUS='02' then '退款成功' when ORDSTATUS='03' then '退款失败'  else '未知' end) as ordstatusName ,'' sup_status,6 as pageflags 
             from stprefinf p
             where ${USERID6} 
                 ${prdOrdNo6} ${orderDate6}  ${OrdStatus6}
                 
           order by orderDate desc,prdOrdNo1 asc,transort asc
        </sql>
        <process>
            <!-- 检查用户登录平台是否正确 -->
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>

            <if condition="IS_NOEQUAL_STRING(tranFlag,'1')">
                <set name="_REQUESTATTR.FORWARDURL"
                    expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/tranrecord.jsp')" />
            </if>

            <!-- 检查手机号是否为空 -->
            <set name="USRID" expr="SESSIONS.USRID" />
            <if condition="IS_EQUAL_STRING(USRID,'')">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02035" />
                <set name="RspMsg" value="用户ID为空" />
                <set name="RspMsg" value="请重新登录" />
                <set name="_REQUESTATTR.FORWARDURL" value="html/zh-CN/login/login.jsp" />
                <return />
            </if>

            <if condition="ISNULL(PageNum)">
                <set name="PageNum" value="1" />
            </if>
            <if condition="ISNULL(NumPerPag)">
                <set name="NumPerPag" value="10" />
            </if>

            <set name="Condition" value="" />
            <set name="Fh" value="'" />

            <!-- 检测输入项 -->
            <switch expr="selD">
                <case value="1">
                    <set name="STARTDATE" expr="GETDATETIME('YYYYMMDD')" />
                    <set name="endDate" expr="STARTDATE" />
                    <break />
                </case>
                <case value="2">
                    <set name="endDate" expr="GETDATETIME('YYYYMMDD')" />
                    <set name="STARTDATE" expr="CALCDATE(GETDATE(),'-','d',6)" />
                    <break />
                </case>
                <case value="3">
                    <set name="endDate" expr="GETDATETIME('YYYYMMDD')" />
                    <set name="STARTDATE" expr="CALCDATE(GETDATE(),'-','d',30)" />
                    <break />
                </case>
                <default>
                    <if condition="IS_EQUAL_STRING(STARTDATE,'')">            <!-- 如果没输入，就传送空值 -->
                        <set name="startDate" expr="CALCDATE(GETDATE(),'-','d',30)" />
                    </if>
                    <else>
                        <if condition="INTCMP(STRLEN(STARTDATE),4,8)">
                            <set name="startDate" expr="FMTDATE(STARTDATE,4,0)" />         <!-- 开始时间 -->
                        </if>
                    </else>

                    <if condition="IS_EQUAL_STRING(ENDDATE,'')">            <!-- 如果没输入，就传送空值 -->
                        <set name="endDate" expr="GETDATETIME('YYYYMMDD')" />
                    </if>
                    <else>
                        <if condition="INTCMP(STRLEN(ENDDATE),4,8)">
                            <set name="endDate" expr="FMTDATE(ENDDATE,4,0)" />         <!-- 结束时间 -->
                        </if>
                    </else>
                </default>
            </switch>
            <if condition="INTCMP(endDate,1,startDate)">
                <set name="RspCod" value="08040" />
                <set name="RspMsg" value="结束日期小于开始日期" />
                <return />
            </if>

            <set name="orderDate1"
                expr="STRCAT(' and TRATIME      &gt;= ',Fh, STRCAT(STARTDATE,'000000'),Fh,' and  TRATIME      &lt;=',Fh,STRCAT(endDate,'235959'),Fh)" />
            <set name="orderDate2"
                expr="STRCAT(' and orderTime    &gt;= ',Fh, STRCAT(STARTDATE,'000000'),Fh,' and  orderTime   &lt;=',Fh,STRCAT(endDate,'235959'),Fh)" />
            <set name="orderDate3"
                expr="STRCAT(' and actDat       &gt;= ',Fh, STRCAT(STARTDATE,'000000'),Fh,' and  actDat      &lt;=',Fh,STRCAT(endDate,'235959'),Fh)" />
            <set name="orderDate4"
                expr="STRCAT(' and orderDate    &gt;= ',Fh, STARTDATE,Fh,' and  orderDate   &lt;=',Fh,endDate,Fh)" />
            <set name="orderDate5"
                expr="STRCAT(' and TRATIME      &gt;= ',Fh, STRCAT(STARTDATE,'000000'),Fh,' and  TRATIME      &lt;=',Fh,STRCAT(endDate,'235959'),Fh)" />
            <set name="orderDate6"
                expr="STRCAT(' and RFORDTIME    &gt;= ',Fh, STRCAT(STARTDATE,'000000'),Fh,' and  RFORDTIME    &lt;=',Fh,STRCAT(endDate,'235959'),Fh)" />
            <if condition="INTCMP(STRLEN(STARTDATE),3,8)">
                <set name="startDate" expr="FMTDATE(STARTDATE,0,4)" />
            </if>
            <if condition="INTCMP(STRLEN(ENDDATE),3,8)">
                <set name="ENDDATE" expr="FMTDATE(ENDDATE,0,4)" />
            </if>

            <if condition="IS_NOEQUAL_STRING(prdOrdNo,'')">
                <set name="prdOrdNo1" expr="STRCAT(' and TRAORDNO  = ',Fh,prdOrdNo,Fh)" />
                <set name="prdOrdNo2" expr="STRCAT(' and PRDORDNO  = ',Fh,prdOrdNo,Fh)" />
                <set name="prdOrdNo3" expr="STRCAT(' and casOrdNo  = ',Fh,prdOrdNo,Fh)" />
                <set name="prdOrdNo4" expr="STRCAT(' and regOrdNo  = ',Fh,prdOrdNo,Fh)" />
                <set name="prdOrdNo5" expr="STRCAT(' and TRAORDNO  = ',Fh,prdOrdNo,Fh)" />
                <set name="prdOrdNo6" expr="STRCAT(' and REFORDNO  = ',Fh,prdOrdNo,Fh)" />
            </if>
            <else>
                <set name="prdOrdNo1" value="" />
                <set name="prdOrdNo2" value="" />
                <set name="prdOrdNo3" value="" />
                <set name="prdOrdNo4" value="" />
                <set name="prdOrdNo5" value="" />
                <set name="prdOrdNo6" value="" />
            </else>

            <switch expr="OSTATUS">
                <case value="0">
                    <break />
                </case>
                <case value="1">
                    <set name="ordinput1" value="(' ')" />
                    <set name="ordinput2" value="('02','03','04','07')" />
                    <set name="ordinput3" value="('00','01')" />
                    <set name="ordinput4" value="(' ')" />
                    <set name="ordinput5" value="(' ')" />
                    <set name="ordinput6" value="('02')" />
                    <set name="OrdStatus1" expr="STRCAT(' and ORDSTATUS in ',ordinput1)" />
                    <set name="OrdStatus2" expr="STRCAT(' and ORDSTATUS in ',ordinput2)" />
                    <set name="OrdStatus3" expr="STRCAT(' and ORDSTATUS in ',ordinput3)" />
                    <set name="OrdStatus4" expr="STRCAT(' and ORDSTATUS in ',ordinput4)" />
                    <set name="OrdStatus5" expr="STRCAT(' and ORDSTATUS in ',ordinput5)" />
                    <set name="OrdStatus6" expr="STRCAT(' and ORDSTATUS in ',ordinput6)" />
                    <break />
                </case>
                <case value="2">
                    <set name="ordinput1" value="('00')" />
                    <set name="ordinput2" value="('00')" />
                    <set name="ordinput3" value="(' ')" />
                    <set name="ordinput4" value="('00')" />
                    <set name="ordinput5" value="('00')" />
                    <set name="ordinput6" value="('00')" />

                    <set name="OrdStatus1" expr="STRCAT(' and ORDSTATUS in ',ordinput1)" />
                    <set name="OrdStatus2" expr="STRCAT(' and ORDSTATUS in ',ordinput2)" />
                    <set name="OrdStatus3" expr="STRCAT(' and ORDSTATUS in ',ordinput3)" />
                    <set name="OrdStatus4" expr="STRCAT(' and ORDSTATUS in ',ordinput4)" />
                    <set name="OrdStatus5" expr="STRCAT(' and ORDSTATUS in ',ordinput5)" />
                    <set name="OrdStatus6" expr="STRCAT(' and ORDSTATUS in ',ordinput6)" />
                    <break />
                </case>
                <case value="3">
                    <set name="ordinput1" value="(' ')" />
                    <set name="ordinput2" value="('03','04','05','06')" />
                    <set name="ordinput3" value="(' ')" />
                    <set name="ordinput4" value="(' ')" />
                    <set name="ordinput5" value="(' ')" />
                    <set name="ordinput6" value="(' ')" />

                    <set name="OrdStatus1" expr="STRCAT(' and ORDSTATUS in ',ordinput1)" />
                    <set name="OrdStatus2" expr="STRCAT(' and ORDSTATUS in ',ordinput2)" />
                    <set name="OrdStatus3" expr="STRCAT(' and ORDSTATUS in ',ordinput3)" />
                    <set name="OrdStatus4" expr="STRCAT(' and ORDSTATUS in ',ordinput4)" />
                    <set name="OrdStatus5" expr="STRCAT(' and ORDSTATUS in ',ordinput5)" />
                    <set name="OrdStatus6" expr="STRCAT(' and ORDSTATUS in ',ordinput6)" />
                    <break />
                </case>
                <case value="4">
                    <set name="ordinput1" value="('01')" />
                    <set name="ordinput2" value="('01','05','08','09')" />
                    <set name="ordinput3" value="('02')" />
                    <set name="ordinput4" value="('01')" />
                    <set name="ordinput5" value="('01')" />
                    <set name="ordinput6" value="('21','01')" /><!--圈存成功 -->

                    <set name="OrdStatus1" expr="STRCAT(' and ORDSTATUS in ',ordinput1)" />
                    <set name="OrdStatus2" expr="STRCAT(' and ORDSTATUS in ',ordinput2)" />
                    <set name="OrdStatus3" expr="STRCAT(' and ORDSTATUS in ',ordinput3)" />
                    <set name="OrdStatus4" expr="STRCAT(' and ORDSTATUS in ',ordinput4)" />
                    <set name="OrdStatus5" expr="STRCAT(' and ORDSTATUS in ',ordinput5)" />
                    <set name="OrdStatus6" expr="STRCAT(' and ORDSTATUS in ',ordinput6)" />
                    <break />
                </case>
                <case value="5">
                    <set name="ordinput1" value="('11')" />
                    <set name="ordinput2" value="('11')" />
                    <set name="ordinput3" value="('11')" />
                    <set name="ordinput4" value="('11')" />
                    <set name="ordinput5" value="('11')" />
                    <set name="ordinput6" value="(' ')" />

                    <set name="OrdStatus1" expr="STRCAT(' and ORDSTATUS in ',ordinput1)" />
                    <set name="OrdStatus2" expr="STRCAT(' and ORDSTATUS in ',ordinput2)" />
                    <set name="OrdStatus3" expr="STRCAT(' and ORDSTATUS in ',ordinput3)" />
                    <set name="OrdStatus4" expr="STRCAT(' and ORDSTATUS in ',ordinput4)" />
                    <set name="OrdStatus5" expr="STRCAT(' and ORDSTATUS in ',ordinput5)" />
                    <set name="OrdStatus6" expr="STRCAT(' and ORDSTATUS in ',ordinput6)" />
                    <break />
                </case>
                <case value="6">
                    <set name="ordinput1" value="('02')" />
                    <set name="ordinput2" value="('06','10','11')" />
                    <set name="ordinput3" value="('02')" />
                    <set name="ordinput4" value="('02','11')" />
                    <set name="ordinput5" value="('02')" />
                    <set name="ordinput6" value="('22')" />
                    <set name="OrdStatus1" expr="STRCAT(' and ORDSTATUS in ',ordinput1)" />
                    <set name="OrdStatus2" expr="STRCAT(' and ORDSTATUS in ',ordinput2)" />
                    <set name="OrdStatus3" expr="STRCAT(' and ORDSTATUS in ',ordinput3)" />
                    <set name="OrdStatus4" expr="STRCAT(' and ORDSTATUS in ',ordinput4)" />
                    <set name="OrdStatus5" expr="STRCAT(' and ORDSTATUS in ',ordinput5)" />
                    <set name="OrdStatus6" expr="STRCAT(' and ORDSTATUS in ',ordinput6)" />
                    <break />
                </case>
            </switch>

            <if condition="ISNULL(OrdStatus1)">
                <set name="OrdStatus1" value="" />
            </if>
            <if condition="ISNULL(OrdStatus2)">
                <set name="OrdStatus2" value="" />
            </if>
            <if condition="ISNULL(OrdStatus3)">
                <set name="OrdStatus3" value="" />
            </if>
            <if condition="ISNULL(OrdStatus4)">
                <set name="OrdStatus4" value="" />
            </if>
            <if condition="ISNULL(OrdStatus5)">
                <set name="OrdStatus5" value="" />
            </if>
            <if condition="ISNULL(OrdStatus6)">
                <set name="OrdStatus6" value="" />
            </if>

            <set name="transort2" value="" />
            <set name="USERID1" value=" TRACUSID = ''" />
            <set name="USERID2" value=" cust_id = ''" />
            <set name="USERID3" value=" cust_id = ''" />
            <set name="USERID4" value=" cust_id = ''" />
            <set name="USERID5" value=" GETCUSID = ''" />
            <set name="USERID6" value=" cust_id = ''" />
            <switch expr="traType">
                <case value="1">
                    <!--查询商品订单记录 -->
                    <if condition="IS_NOEQUAL_STRING(transType1,'')">
                        <set name="tranT" value="(" />
                        <foreach name="transType1" iterator="#tmp">
                            <if
                                condition="OR(IS_EQUAL_STRING(#tmp,'1'),IS_EQUAL_STRING(#tmp,'2'),IS_EQUAL_STRING(#tmp,'3'),IS_EQUAL_STRING(#tmp,'0014'))">
                            </if>
                            <else>
                                <set name="USERID2" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                                <set name="tranT" expr="STRCAT(tranT,fh,#tmp,Fh,',')" />
                            </else>
                            <if condition="IS_EQUAL_STRING(#tmp,'1')">
                                <set name="USERID4" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                                <set name="tranT12" value="1" />
                                <set name="USERID2" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                            </if>
                            <if condition="IS_EQUAL_STRING(#tmp,'2')">
                                <set name="USERID3" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                            </if>
                            <if condition="IS_EQUAL_STRING(#tmp,'3')">
                                <set name="USERID1" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                                <set name="USERID5" expr="STRCAT(' GETCUSID = \'',USRID,'\'')" />
                            </if>
                            <if condition="IS_EQUAL_STRING(#tmp,'0014')">
                                <set name="USERID6" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                            </if>
                        </foreach>
                        <set name="tranT" expr="STRCAT(tranT,fh,tranT12,fh,')')" />
                        <set name="transort2" expr="STRCAT(' and prdordtype in ',tranT)" />
                    </if>
                    <else>
                        <set name="USERID1" expr="STRCAT(' TRACUSID = \'',USRID,'\'')" />
                        <set name="USERID2" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                        <set name="USERID3" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                        <set name="USERID4" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                        <set name="USERID5" expr="STRCAT(' GETCUSID = \'',USRID,'\'')" />
                        <set name="USERID6" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                    </else>

                    <if condition="IS_EQUAL_STRING(transort2,'')">
                        <set name="transort2" value="" />
                    </if>
                    <break />
                </case>
                <case value="2">
                    <if condition="IS_NOEQUAL_STRING(transType2,'')">
                        <set name="tranT" value="(" />
                        <foreach name="transType2" iterator="#tmp">
                            <if
                                condition="OR(IS_EQUAL_STRING(#tmp,'1'),IS_EQUAL_STRING(#tmp,'2'),IS_EQUAL_STRING(#tmp,'3'),IS_EQUAL_STRING(#tmp,'0014'))">
                            </if>
                            <else>
                                <set name="USERID2" expr="STRCAT(' USERID = \'',USRID,'\'')" />
                                <set name="tranT" expr="STRCAT(tranT,fh,#tmp,Fh,',')" />
                            </else>
                        </foreach>
                        <set name="tranT" expr="STRCAT(tranT,fh,fh,')')" />
                        <set name="transort2" expr="STRCAT(' and transort in ',tranT)" />
                    </if>
                    <else>
                        <if condition="IS_EQUAL_STRING(transort2,'')">
                            <set name="transort2" value=" and prdordtype not in ('1')" />
                        </if>
                        <set name="USERID1" value=" TRACUSID = ' '" />
                        <set name="USERID2" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                        <set name="USERID3" value=" cust_id = ' '" />
                        <set name="USERID4" value=" cust_id = ' '" />
                        <set name="USERID5" value=" GETCUSID = ' '" />
                        <set name="USERID6" value=" cust_id = ' '" />
                    </else>
                    <break />
                </case>
                <case value="3"><!--充值 -->
                    <if condition="IS_NOEQUAL_STRING(transType3,'')">
                        <set name="tranT" value="(" />
                        <foreach name="transType3" iterator="#tmp">
                            <if condition="IS_EQUAL_STRING(#tmp,'1')">
                                <set name="USERID4" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                            </if>
                        </foreach>
                    </if>
                    <else>
                        <set name="USERID4" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                    </else>
                    <set name="transort2" value=" and prdordtype ='1'" />
                    <set name="USERID1" value=" TRACUSID = ' '" />
                    <set name="USERID2" expr="STRCAT(' cust_id = \'',USRID,'\'')" />        <!-- 商品订单 StpPrdInf -->
                    <set name="USERID3" value=" cust_id = ' '" />
                    <set name="USERID5" value=" GETCUSID = ' '" />
                    <set name="USERID6" value=" cust_id = ' '" />
                    <break />
                </case>
                <case value="4"><!-- 提现 -->
                    <if condition="IS_NOEQUAL_STRING(transType4,'')">
                        <set name="tranT" value="(" />
                        <foreach name="transType4" iterator="#tmp">
                            <if condition="IS_EQUAL_STRING(#tmp,'2')">
                                <set name="USERID3" expr="STRCAT(' USERID = \'',USRID,'\'')" />
                            </if>
                        </foreach>
                    </if>
                    <else>
                        <set name="USERID3" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                    </else>
                    <set name="USERID1" value=" TRACUSID = ''" />
                    <set name="USERID2" value=" cust_id = ''" />
                    <set name="USERID4" value=" cust_id = ''" />
                    <set name="USERID5" value=" GETCUSID = ''" />
                    <set name="USERID6" value=" cust_id = ''" />
                    <break />
                </case>
                <case value="5"><!-- 付款 -->
                    <if condition="IS_NOEQUAL_STRING(transType5,'')">
                        <set name="tranT" value="(" />
                        <foreach name="transType5" iterator="#tmp">
                            <if condition="IS_EQUAL_STRING(#tmp,'3')">
                                <set name="USERID1" expr="STRCAT(' TRACUSID = \'',USRID,'\'')" />
                            </if>
                        </foreach>
                    </if>
                    <else>
                        <set name="USERID1" expr="STRCAT(' TRACUSID = \'',USRID,'\'')" />
                    </else>
                    <set name="USERID2" value=" cust_id = ''" />
                    <set name="USERID3" value=" cust_id = ''" />
                    <set name="USERID4" value=" cust_id = ''" />
                    <set name="USERID5" value=" GETCUSID = ''" />
                    <set name="USERID6" value=" cust_id = ''" />
                    <break />
                </case>
                <case value="6"><!-- 收款 -->
                    <if condition="IS_NOEQUAL_STRING(transType6,'')">
                        <set name="tranT" value="(" />
                        <foreach name="transType6" iterator="#tmp">
                            <if condition="IS_EQUAL_STRING(#tmp,'3')">
                                <set name="USERID5" expr="STRCAT(' GETCUSID = \'',USRID,'\'')" />
                            </if>
                        </foreach>
                    </if>
                    <else>
                        <set name="USERID5" expr="STRCAT(' GETCUSID = \'',USRID,'\'')" />
                    </else>
                    <set name="USERID1" value=" TRACUSID = ''" />
                    <set name="USERID2" value=" cust_id = ''" />
                    <set name="USERID3" value=" cust_id = ''" />
                    <set name="USERID4" value=" cust_id = ''" />
                    <set name="USERID6" value=" cust_id = ''" />
                    <break />
                </case>
                <case value="7"><!-- 转账：包括付款和收款 -->
                    <set name="USERID1" expr="STRCAT(' TRACUSID = \'',USRID,'\'')" />
                    <set name="USERID5" expr="STRCAT(' GETCUSID = \'',USRID,'\'')" />
                    <set name="USERID2" value=" cust_id = ''" />
                    <set name="USERID3" value=" cust_id = ''" />
                    <set name="USERID4" value=" cust_id = ''" />
                    <set name="USERID6" value=" cust_id = ''" />
                    <break />
                </case>
                <case value="8"><!--消费 -->
                    <if condition="IS_NOEQUAL_STRING(transType3,'')">
                        <set name="tranT" value="(" />
                        <foreach name="transType3" iterator="#tmp">
                            <if condition="IS_EQUAL_STRING(#tmp,'1')">
                                <set name="USERID4" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                            </if>
                        </foreach>
                    </if>
                    <else>
                        <set name="USERID4" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                    </else>
                    <set name="transort2" value=" and (prdordtype ='0' or prdordtype ='2')" />
                    <set name="USERID1" value=" TRACUSID = ''" />
                    <set name="USERID2" expr="STRCAT(' cust_id = \'',USRID,'\'')" />        <!-- 商品订单 StpPrdInf -->
                    <set name="USERID3" value=" cust_id = ''" />
                    <set name="USERID5" value=" GETCUSID = ''" />
                    <set name="USERID6" value=" cust_id = ''" />
                    <break />
                </case>
                <case value="9"><!--退款 -->
                    <if condition="IS_NOEQUAL_STRING(transType4,'')">
                        <set name="tranT" value="(" />
                        <foreach name="transType4" iterator="#tmp">
                            <if condition="IS_EQUAL_STRING(#tmp,'2')">
                                <set name="USERID3" expr="STRCAT(' USERID = \'',USRID,'\'')" />
                            </if>
                        </foreach>
                    </if>
                    <else>
                        <set name="USERID6" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                    </else>
                    <set name="USERID1" value=" TRACUSID = ''" />
                    <set name="USERID2" value=" cust_id = ''" />
                    <set name="USERID4" value=" cust_id = ''" />
                    <set name="USERID5" value=" GETCUSID = ''" />
                    <set name="USERID3" value=" cust_id = ''" />
                    <break />
                </case>
                <default>
                    <!--查询商品订单记录 -->
                    <set name="USERID1" expr="STRCAT(' TRACUSID = \'',USRID,'\'')" />
                    <set name="USERID2" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                    <set name="USERID3" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                    <set name="USERID4" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                    <set name="USERID5" expr="STRCAT(' GETCUSID = \'',USRID,'\'')" />
                    <set name="USERID6" expr="STRCAT(' cust_id = \'',USRID,'\'')" />
                </default>
            </switch>
            <if condition="IS_EQUAL_STRING(USERID1,'')">
                <set name="USERID1" value=" TRACUSID = ''" />
            </if>
            <if condition="IS_EQUAL_STRING(USERID2,'')">
                <set name="USERID2" value=" cust_id = ''" />
            </if>
            <if condition="IS_EQUAL_STRING(USERID3,'')">
                <set name="USERID3" value=" cust_id = ''" />
            </if>
            <if condition="IS_EQUAL_STRING(USERID4,'')">
                <set name="USERID4" value=" cust_id = ''" />
            </if>
            <if condition="IS_EQUAL_STRING(USERID5,'')">
                <set name="USERID5" value=" GETCUSID = ''" />
            </if>
            <if condition="IS_EQUAL_STRING(USERID6,'')">
                <set name="USERID6" value=" cust_id = ''" />
            </if>
            <do func="PagedQuery" error="ignore">
                <para name="PageNum" expr="PageNum" />
                <para name="NumPerPag" expr="NumPerPag" />
                <para name="Sql" sql="queryAllInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="无交易记录" />
                <set name="TOLCNT" value="0" />
                <set name="ALLPAGENUM" value="0" />
                <set name="RECNUM" value="0" />
                <set name="PAGENUM" value="0" />
                <return />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误,请稍后再试或联系客服" />
                <return />
            </elseif>

            <set name="ALLPAGENUM" expr="DIV(TOLCNT,NUMPERPAG)" />
            <set name="mob" expr="MOD(TOLCNT,NUMPERPAG)" />
            <if condition="IS_NOEQUAL_STRING(MOB,'0')">
                <set name="ALLPAGENUM" expr="ADD(ALLPAGENUM,1)" />
            </if>
            <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
                <set name="PageNum" expr="ALLPAGENUM" />
            </if>
            <if condition="INTCMP(ALLPAGENUM,6,'0')">
                <if condition="INTCMP(PageNum,3,'0')">
                    <set name="PageNum" value="1" />
                </if>
            </if>
            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
    </transaction>
   
    <!--银行卡bin查询 -->
    <transaction code="crdBinChk" desc="银行卡bin查询">
        <!--查询卡种 -->
        <sql name="cardType">
            select enm_dat_des as BANKCARDTYPES from lyxdicenm
            where sys_id='0001' and trim(enm_en_nam) like 'bankCardType' and trim(enm_dat_opt)=#{DCFLAG}
        </sql>
        <process>
            <!--卡bin查询 -->
            <if condition="IS_EQUAL_STRING(BNKACNO,'')">
                <set name="RspCod" value="01002" />
                <set name="RspMsg" value="银行卡号不能为空" />
            </if>

            <do func="GetCrdInfo">
                <para name="CrdNo" expr="BNKACNO" />
            </do>
            <if condition="#RetCod!=0">
                <set name="CPSCod" value="99" />
                <set name="RspMsg" value="获取卡bin信息失败" />
                <return />
            </if>

            <set name="ISSBANKNAME"  expr="ISSNAM" />
            <set name="BANKCODE"     expr="ISSNO" />
            <set name="BANKCARDTYPE" expr="DCFLAG" />

            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="cardType" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="数据库错误" />
                <return />
            </if>
            <set name="BANKCARDTYPES" expr="BANKCARDTYPES" />  <!--卡种 -->

            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
    </transaction>
   
   <transaction code="bnkBind" desc="银行卡绑定">
        <!-- 查询用户注册信息 -->
        <sql name="QryUsrIdInf">
            SELECT u.USR_STATUS as AUTSTAT,c.CUST_NAME as U_NAME,c.cust_status,c.cust_cred_no
              FROM STPUSRINF u,STPCUSINF c
             WHERE u.CUST_ID=#{USRID} and u.CUST_ID=c.CUST_ID 
        </sql>
        <!-- 检测用户是否绑定了该卡 -->
        <sql name="QryUserBank">
             SELECT CUST_ID FROM STPBANKTB WHERE CUST_ID=#{USRID} and CARD_NO=#{BnkAcNo} 
        </sql>
        <!--查询联行号 -->
        <sql name="selBankNoCode">
            select  enm_rmk as enmbnkno from lyxdicenm
            where sys_id='0001' and ENM_EN_NAM like '%bankNam%'  
            and  trim(enm_dat_opt)=#{bankCode}
        </sql>
        <sql name="updateConfig">
      	    update stpbanktb set bank_conf='1' where bak_seq=#{BAK_SEQ}
      	</sql>
        <process>
            <set name="USRID"     expr="SESSIONS.CUSTNO" />
            <set name="cust_name" expr="SESSIONS.USRNAME"/>
            <!-- 检查用户登录平台是否正确 0001：用户 -->
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>

            <!-- 检查用户注册信息是否存在 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrIdInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="用户信息不存在" />
                <return />
            </if>
            
            <if condition="IS_NOEQUAL_STRING(CUST_STATUS,'0')">
                <set name="RspCod" value="08040" />
                <set name="RspMsg" value="客户状态不正常" />
                <return />
            </if>

            <if condition="IS_NOEQUAL_STRING(AUTSTAT,'2')">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02009" />
                <set name="RspMsg" value="用户未进行身份认证" />
                <return />
            </if>
            
            <!--查询绑定银行卡的卡类型-->
            <do func="GetCrdInfo">
                <para name="CrdNo" expr="BNKACNO" />
            </do>
            <if condition="#RetCod!=0">
                <set name="CPSCod" value="99" />
                <set name="RspMsg" value="获取卡bin信息失败" />
                <return />
            </if>  
              
            <if condition="IS_EQUAL_STRING(DCFLAG,'01')">
                <set name="DCFLAG" value="00" />
            </if>
            <elseif condition="IS_EQUAL_STRING(DCFLAG,'02')">
            	  <set name="DCFLAG" value="01" />
            </elseif>
            <else>
                <set name="CPSCod" value="99" />
                <set name="RspMsg" value="获取卡bin类型错误" />
                <return />
            </else>

            <set name="ISSBANKNAME"  expr="ISSNAM" />
            <set name="BANKCODE"     expr="ISSNO" />
            <set name="CardType"     expr="DCFLAG" />

            <!-- 检查银行账号是否为空 -->
            <set name="BnkAcNo" expr="DELBOTHSPACE(BnkAcNo)" />
            <!--银行卡号加密 -->
            <set name="BnkAcNo" expr="DES_ENCRYPT(BnkAcNo)" />
            <if condition="IS_EQUAL_STRING(BnkAcNo,'')">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02049" />
                <set name="RspMsg" value="银行账号为空" />
                <return />
            </if>

            <!-- 查询用户是否绑定过该卡 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUserBank" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspMsg" value="用户可以绑定银行卡" />
            </if>
            <elseif condition="#RetCod==-1">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
            <elseif condition="#RetCod==0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02085" />
                <set name="RspMsg" value="绑定失败，此银行卡已被绑定" />
                <return />
            </elseif>
            <else>
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09998" />
                <set name="RspMsg" value="系统错误,请稍后再试或联系客服" />
                <return />
            </else>
            
            <!--查询绑定银行卡的联行号-->
            <!--do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="selBankNoCode" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="数据库错误" />
                <return />
            </if-->
            <!-- 获取序号 -->
            <do func="GetSeqNo" error="IGNORE">
                <para name="TblNam" value="stpseqrec" />
                <para name="KeyNam" value="KeyNam" />
                <para name="KeyVal" value="STPBANKTB_BAK_SEQ" />
                <para name="SeqNam" value="KeyVal" />
                <para name="Len"    value="5" />
                <para name="Circle" value="1" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09001" />
                <set name="RspMsg" value="获取序号错误" />
                <return />
            </if>

            <!-- 记录银行卡绑定信息 -->
            <set name="BAK_SEQ"       expr="STRCAT(GETDATE(),KeyVal)" />
            <set name="CUST_ID"       expr="USRID"/>
            <set name="CARD_NO"       expr="BnkAcNo"/>
            <set name="CARD_BANK"     expr="bankCode"/>
            <set name="BANK_NAM"      expr="ISSBANKNAME"/>
            <set name="BANK_REL_NO"   expr="BANK_REL_NO"/>
            <set name="CARD_TYPE"     expr="CardType"/> <!--00 储蓄卡  01 信用卡-->
            <set name="CARD_NAME"     expr="CARDNAME"/>
            <set name="BANK_CONF"     value="0"/>
            <set name="BANK_RES_PHONE" expr="BANKPHONE"/>
            <do func="InsertRecord" error="IGNORE">
                <para name="TblNam" value="STPBANKTB" />
            </do>
            <do func="CommitWork"></do>
            <if condition="#RetCod!=0">
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </if>
            <set name="PHONENO"     expr="BANKPHONE"/>
	        <set name="certifId"    expr="DES_DECRYPT(cust_cred_no)"/><!-- 身份证号 -->
	        <set name="CUSTOMERNM"  expr="cust_name"/><!-- 姓名 -->
	        <set name="CERTIFTP"    value="01"/><!-- 证件类型 -->
	       
            <do func="WuTZOpen">
                <para name="channelType" value="07" />
                <para name="orderId"     expr="STRCAT(USRMP,txnTime)" />
                <para name="accType"     value="01" />
                <para name="encryptcertid" value=""/>
            </do>
             <!-- <if condition="#RetCod!=0">
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="10005"/>
	            <set name="RspMsg"    value="快捷支付开通失败！"/>
	            <return/>
            </if> -->
             <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="updateConfig" />
            </do>
            <do func="CommitWork"></do>
            <!-- 获取编号 -->
            <do func="GetSeqNo" error="IGNORE">
              <para name="TblNam" value="stpseqrec" />
              <para name="KeyNam" value="KeyNam" />
              <para name="KeyVal" value="STPBANKHIS" />
              <para name="SeqNam" value="KeyVal" />
              <para name="Len"    value="5" />
              <para name="Circle" value="1" />
            </do>
            <if condition="#RetCod!=0">
              <set name="RspCod"          value="09001" />
              <set name="RspMsg"          value="生成序列号失败" />
              <set name="DWZ_STATUS_CODE" value="300" />
              <set name="DWZ_RSP_MSG"     expr="RSPMSG" />
              <return />
            </if>
            <set name="BAK_SEQ"       expr="STRCAT(ADD_DATE,KeyVal)" />            
            <set name="OPE_TYPE"      value="0" />   <!--0 绑定  1 解绑-->
            <set name="BAK_CUST_ID"   expr="SESSIONS.USRMP" />
            <set name="BAK_UPD_DATE"  expr="GETDATE()" />
            <set name="BAK_UPD_TIME"  expr="GETDATETIME('HHMISS')" />
            
            <!-- 登记绑定历史记录 -->
            <do func="InsertRecord" >
               <para name="TblNam"  value="STPBANKHIS" />
            </do>
            <if condition="#RetCod!=0">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09999"/>
               <set name="RspMsg"    value="系统错误"/>
               <return/>
            </if>
            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="银行卡绑定成功！" />
        </process>
    </transaction>
   
   <transaction code="561128" desc="银行卡解绑">
      <sql name="select_bind">
        SELECT CUST_ID,CARD_BANK,BANK_NAM,CARD_TYPE,CARD_NAME,USER_ID ,AUTH_CODE as tokenPayData FROM STPBANKTB where cust_id = #{USRID} and CARD_NO = #{CARD_NO} and bank_conf='1'
      </sql>
      <sql name="set_unbinding">
        delete STPBANKTB where cust_id = #{USRID} and CARD_NO = #{CARD_NO}
      </sql>
      <sql name="chkPayPwd">
          select c.password as oldPayPwd,u.CUST_LOGIN CUSTLOGIN from arp_ac_cust_rel c,STPUSRINF u where c.cust_id=u.cust_id and 
          c.cust_id=#{USRID}
      </sql>
      <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
          SELECT 
          EXTRACT(DAY FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*24*60 + EXTRACT(HOUR FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*60 +  EXTRACT(MINUTE FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND )) as timeDifference,
          CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
          FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
      </sql>
      <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
          INSERT INTO STPLOGTMP
          (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
          VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
      </sql>
      <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
          UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
          LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
      </sql>
      <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
          UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
          WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
      </sql>
    <process>
      
      <set name="USRID"   expr="SESSIONS.USRID"/>
      <!-- 查询卡的当前绑定状态 -->
      <do func="ReadRecord" error="IGNORE">
        <para name="SqlCmd" sql="select_bind" />
      </do>
      <!--原子函数 2 数据库没有找到信息 -1 数据库错误 0 查询成功 -->
      <if condition="#RetCod==2">
        <set name="RspCod"          value="09999" />
        <set name="RspMsg"          value="无此绑定信息，或已经解绑。" />
        <return />
      </if>
      <elseif condition="#RetCod!=0">
        <set name="RspCod"          value="09999" />
        <set name="RspMsg"          value="系统错误" />
        <return />
      </elseif>
      
      <!-- 查询用户信息 -->
      <do func="ReadRecord" error="IGNORE">
        <para name="SqlCmd" sql="chkPayPwd" />
      </do>
      <if condition="#RetCod==2">
        <set name="RspCod"          value="01004" />
        <set name="RspMsg"          value="无此用户信息！" />
        <return />
      </if>
      <elseif condition="#RetCod!=0">
        <set name="RspCod"          value="09999" />
        <set name="RspMsg"          value="系统错误" />
        <return />
      </elseif>
      <set name="CUST_LOGIN"  expr="CUSTLOGIN"/>
      <!-- 用户修改登录密码锁定次数判断 -->
       <set name="USER_ID"   expr="DELBOTHSPACE(CUST_LOGIN)" />
       <set name="CUSTTYPE"  value="0"/><!--0用户 1 商户 2企业-->
       <set name="PWDTYPE"   value="1"/><!--0:登录密码 1:支付密码-->
       <set name="FailFlag"  value="0"/>
       <quote name="usrpwdlock"/>
       <!-- 用户修改登录密码锁定次数判断 -->
        
      <!-- 检查当前密码是否为空 -->
      <if condition="IS_EQUAL_STRING(USRPAYPWD,'')">
          <set name="RspCod" value="02058" />
          <set name="RspMsg" value="支付密码不能为空" />
          <return />
      </if>
      
      <set name="pw" expr="USRPAYPWD" />
      <quote name="getInputPwd" />
      <set name="UsrPwd" expr="NewPwd" />
      <if condition="IS_NOEQUAL_STRING(oldPayPwd,UsrPwd)">
          <set name="MsgTyp" value="E" />
          <set name="RspCod" value="02017" />
          <set name="RspMsg" value="输入的支付密码不正确！" />
          <quote name="UpLoginInfo"/>
          <return />
      </if>
      <!-- 调用接口解除标记 -->
      <!-- <do func="WuTZUnBind">
          <para name="channelType" value="07"/>
          <para name="orderId"     expr="GETDATETIME()"/>
      </do>
      <if condition="#RetCod!=0">
          <return/>
      </if>	 -->
      
      <!-- 解绑 -->
      <do func="ExecSql" error="IGNORE">
        <para name="SqlCmd" sql="set_unbinding" />
      </do>
      <if condition="#RetCod==2">
        <set name="RspCod"          value="01004" />
        <set name="RspMsg"          value="无此绑定信息，或已经解绑，请刷新后操作。" />
        <return />
      </if>
      <elseif condition="#RetCod!=0">
        <set name="RspCod"          value="09999" />
        <set name="RspMsg"          value="系统错误" />
        <return />
      </elseif>
      
      <!-- 获取编号 -->
      <do func="GetSeqNo" error="IGNORE">
        <para name="TblNam" value="stpseqrec" />
        <para name="KeyNam" value="KeyNam" />
        <para name="KeyVal" value="STPBANKHIS" />
        <para name="SeqNam" value="KeyVal" />
        <para name="Len"    value="5" />
        <para name="Circle" value="1" />
      </do>
      <if condition="#RetCod!=0">
        <set name="RspCod"          value="09001" />
        <set name="RspMsg"          value="生成序列号失败" />
        <return />
      </if>
      <set name="BAK_SEQ"       expr="STRCAT(ADD_DATE,KeyVal)" />
      <set name="OPE_TYPE"      value="1" />   <!--解绑-->
      <set name="CARD_STA_RES"  expr="CARD_STA_RES" />
      <set name="BAK_CUST_ID"   expr="SESSIONS.UID" />
      <set name="BAK_UPD_DATE"  expr="GETDATE()" />
      <set name="BAK_UPD_TIME"  expr="GETDATETIME('HHMISS')" />
      
      <!-- 登记解绑历史记录 -->
      <do func="InsertRecord" >
         <para name="TblNam"  value="STPBANKHIS" />
      </do>
      <if condition="#RetCod!=0">
         <set name="MsgTyp"    value="E"/>
         <set name="RspCod"    value="09999"/>
         <set name="RspMsg"    value="系统错误"/>
         <continue/>
      </if>
      
      <!-- 修改登记失败信息表 -->
      <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="UpdUsrLogInfo"/>
      </do>
      <if condition="#RetCod!=0">
         <set name="RSPCOD" value="02040"/>
         <set name="RSPMSG" value="更新登录信息失败!"/> 
         <return/>
      </if>
      
      <set name="RspCod"            value="00000" />
      <set name="RspMsg"            value="交易成功" />
    </process>
  </transaction>
   
   <transaction code="561117" desc="银行卡列表查询">
     <sql name="QryUsrInf"> <!--  查询用户注册信息  -->
       SELECT CUST_LOGIN,USR_STATUS AS u_auth_status
         FROM STPUSRINF 
        WHERE CUST_ID=#{USRID}
     </sql> 
     <sql name="QryStpBankCd"> <!--  查询用户绑定的银行卡  --> 
       SELECT b.BAK_SEQ,b.CUST_ID,b.CARD_NO,
             (select enm_dat_des from lyxdicenm n where sys_id='0001' and trim(enm_en_nam) like '%bankNam%'  and b.CARD_BANK=trim(n.enm_dat_opt))
             as bank_no,substr(b.CARD_NO,(length(b.CARD_NO)-3),4) as CANO,
             To_Char(to_date(b.BAK_OPEN_DATE,'yyyymmdd'),'yyyy-mm-dd') as CARD_DATE,
             To_Char(to_date(b.BAK_OPEN_TIME,'hh24miss'),'hh24:mi:ss') as CARD_TIME,
             b.CARD_STATUS,
             (select enm_dat_des from lyxdicenm m where sys_id='0001' and trim(enm_en_nam) like '%bankCardType%' and b.card_type=trim(m.Enm_Dat_Opt))
              as banknotype
        FROM STPBANKTB b 
       WHERE b.CUST_ID like #{usrIds}  and (CARD_TYPE='02' or CARD_TYPE='01')
       ORDER BY BAK_OPEN_DATE DESC,BAK_OPEN_TIME DESC
     </sql>
     <sql name="QryPPCardNum"> <!--  查询绑定的预付卡数量 -->
       SELECT count(*) as PPNum from STPBANKTB
        WHERE CUST_ID like #{usrIds} and (CARD_TYPE='02' or CARD_TYPE='01')
     </sql> 
     <process>
       <!-- 检查用户登录平台是否正确    0001：用户 ；0009：操作员 -->
       <if condition="AND(IS_NOEQUAL_STRING(SysCod,'0009'),IS_NOEQUAL_STRING(SysCod,'0001'))">
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>
       <set name="USRID"           expr="SESSIONS.USRID"/>
       <!-- 检查手机号是否为空 -->
       <set name="UsrMp1"          expr="DELBOTHSPACE(USRID)"/>
       <if condition="IS_EQUAL_STRING(UsrMp1,'')">
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="手机号为空"/>
         <set name="_REQUESTATTR.FORWARDURL"       value="html/login/login.jsp"/>
         <return/>
       </if>

       <!-- 检查用户是否存在 -->
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd"   sql="QryUsrInf" />
       </do>
       <if condition="#RetCod!=0">
         <set name="RspCod"        value="02008"/>
         <set name="RspMsg"        value="用户信息不存在"/>
         <return/>
       </if>
       <if condition="OR(ISNULL(PageNum),IS_EQUAL_STRING(PageNum,'0'))">
         <set name="PageNum"       value="1"/>
       </if>
       <if condition="ISNULL(NumPerPag)">
         <set name="NumPerPag"     value="5"/>
       </if>
        
       <!--  转到用户银行卡信息展示页面    -->
       <if condition="IS_EQUAL_STRING(SIGN,'00')">
        <set name="_REQUESTATTR.FORWARDURL"         value="html/bank/userbankinf.jsp"/>
       </if>
       <else>
        <set name="_REQUESTATTR.FORWARDURL"         value="html/user/selectBank.jsp"/>
       </else>          
       
       <set name="usrIds"         expr="STRCAT(USRID,'%')"/>
       <do func="PagedQuery"       error="ignore">
         <para name="PageNum"      expr="PageNum"/>
         <para name="NumPerPag"    expr="NumPerPag"/>
         <para name="Sql"          sql="QryStpBankCd"/>
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="N"/>
         <set name="RspCod"        value="00000"/>
         <set name="RspMsg"        value="用户绑定信息不存在"/>
         <set name="nums"          value="0"/>
         <set name="TOLCNT"        value="0"/>
         <set name="ALLPAGENUM"    value="0"/>
         <set name="RECNUM"        value="0"/>
         <set name="PAGENUM"       value="0"/>
       </if>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
         <return/>
       </elseif>
       
       <set name="ALLPAGENUM"     expr="DIV(TOLCNT,NUMPERPAG)"/>
       <set name="mob"     expr="MOD(TOLCNT,NUMPERPAG)"/>
       <if condition="IS_NOEQUAL_STRING(MOB,'0')">
         <set name="ALLPAGENUM"     expr="ADD(ALLPAGENUM,1)"/>
       </if>
       <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
         <set name="PageNum"     expr="ALLPAGENUM"/>
       </if>
       <if condition="INTCMP(ALLPAGENUM,6,'0')">
          <if condition="INTCMP(PageNum,3,'0')">
           <set name="PageNum"     value="1"/>
         </if>
       </if>
       
       <foreach name="GRP" iterator="#grp">
         <set name="sDeData"         expr="#grp.CARD_NO"   />
         <if condition="NOT(ISNULL(DES_DECRYPT(sDeData)))">
            <set name="sDeData"      expr="DES_DECRYPT(sDeData)"   />
         </if>
         <set name="First"           expr="SUBSTR(sDeData,1,3)"/> 
         <set name="End"             expr="SUBSTR(sDeData,SUB(STRLEN(sDeData),3),STRLEN(sDeData))"/>
         <set name="descryptdata"    expr="STRCAT(First,'****',End)"/>
         <set name="descryptdata"    expr="End"/>
         <do func="loopSetEach">
            <para name="ele" expr="#grp.CANO"/> 
            <para name="value" expr="descryptdata"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"            value="09998"/>
            <set name="RspMsg"            value="系统错误"/>
            <set name="DWZ_STATUS_CODE"   value="300"/>
            <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
            <return/>
         </if>
      </foreach>
      
       <!--查询预付卡的绑定数量-->
       <do func="ReadRecord"     error="IGNORE">
          <para name="SqlCmd" sql="QryPPCardNum"/>
       </do>
       <if condition="#RetCod!=0">
          <set name="MsgTyp"        value="E"/>
          <set name="RspCod"        value="09999"/>
          <set name="RspMsg"        value="数据库错误"/>
          <return/>  
       </if>
       
       <set name="FLAG"            value="N"/>
       <set name="MsgTyp"          value="N"/>
       <set name="RspCod"          value="00000"/>
       <set name="RspMsg"          value="交易成功"/>
     </process>
   </transaction>
   
   <transaction code="chekCardBin" desc="自定义检测卡BIN信息">
     <process>
       <!-- 检查用户登录平台是否正确    0001：用户 ；0009：操作员 -->
       <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>
       <set name="cardno"           expr="cardno"/>       <!-- 卡号 -->
       <set name="type_card"        expr="type_card"/>  <!-- 卡类型 1：借记卡 2：信用卡 -->
       <set name="bank_code"        expr="bank_code"/>  <!-- 银行卡编码 -->

       <!--卡bin查询-->
       <if condition="IS_EQUAL_STRING(cardno,'')">
           <set name="RspCod"          value="01002"/>
           <set name="RspMsg"          value="请输入银行卡号"/>
       </if>
       <do func="GetCrdInfo">
           <para name="CrdNo" expr="cardno"/>
       </do>
       <if condition="#RetCod!=0">
           <set name="RspCod" value="01003" />
           <set name="RspMsg" value="系统不识别该卡，请换其他卡！" />
           <return />
       </if>
       
       <set name="ISSBANKNAME"        expr="ISSNAM"/>
       <set name="BANKCODE"           expr="ISSNO"/>
       <set name="BANKCARDTYPE"       expr="SUBSTR(DCFLAG,2,1)"/><!-- 卡类型 01：借记卡 02：信用卡 -->
        <if condition="OR(ISNULL(BANKCODE),IS_EQUAL_STRING(BANKCODE,''))">
           <set name="RspCod" value="01003" />
           <set name="RspMsg" value="系统不识别该卡，请换其他卡！" />
           <return/>
       </if>
       <!-- if condition="IS_EQUAL_STRING(bank_code,'01010000')">
           <if condition="IS_NOEQUAL_STRING(BANKCODE,bank_code)">
               <set name="RspCod" value="01004" />
	       <set name="RspMsg" value="卡类型错误" />
	       <return />
	   </if> 
       </if-->
       <set name="MsgTyp"          value="N"/>
       <set name="RspCod"          value="00000"/>
       <set name="RspMsg"          value="交易成功"/>
     </process>
   </transaction>
   
   <transaction code="561520" desc="用户交易查询 充值  ">
     <sql name="queryTakeCash"> <!--  查询用户充值交易记录  -->
         select  q.prdordno as PAYORDNO,q.OrdStatus,
                 To_Char(to_date(q.orderTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')  as ACTDAT,
                 (select enm_dat_des from lyxdicenm where sys_id='0001' and trim(enm_en_nam)='bankNam' and trim(enm_dat_opt)= CASE 
                 WHEN trim(p.bankcod) = 'B2CBCM'
                 THEN  ( case 
                     when substr( trim(p.BNKMERNO) , 7 ,  length( trim(p.BNKMERNO) )) is null then 'B2CBCM'
                     else substr( trim(p.BNKMERNO) , 7 ,  length( trim(p.BNKMERNO) ))
                     end
                   )
                 ELSE trim(p.bankcod)  END ) as BANKCODE,
                 substr(p.BANKPAYACNO,-4)as BANKPAYACNO,TO_CHAR(to_number(q.ordAmt)/100,'FM9999,999,999,990.00') TXAMT,TO_CHAR(to_number(p.fee)/100,'FM9999,999,999,990.00') FEE,
                 (select enm_dat_des from lyxdicenm where sys_id='0001' and trim(enm_en_nam)='payType' and trim(enm_dat_opt)=trim(p.paytype)) as paytype
           from StpPayInf p, stpprdinf q
          where q.payOrdNo=p.payordno  and q.prdordtype='1' and
                q.cust_id=${USRID} and q.orderTime &gt;= #{startDate} and q.orderTime &lt;= #{endDate}  
          order by q.orderTime DESC ,q.orderTime DESC,q.prdordno
     </sql>
     <process>
       <set name="USRID"    expr="SESSIONS.USRID"/>
       <set name="_REQUESTATTR.FORWARDURL"       value="/html/incash/userincash.jsp"/> 
       <!-- 检查用户登录平台是否正确 -->
       <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>

       <!-- 检查手机号是否为空 -->
       <set name="bankPayAcNo"           expr="SESSIONS.PAYACNO"/>
       <if condition="IS_EQUAL_STRING(bankPayAcNo,'')">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="支付账号为空"/>
         <set name="_REQUESTATTR.FORWARDURL"       value="html/login/login.jsp"/>
         <return/>
       </if>
       
       <!-- 设置页数和每页数量 -->
       <if condition="AND(IsExistNode(PageNum),NOT(ISNULL(PageNum)))">
         <set name="PageNum"       expr="PageNum"/>
       </if> 
       <else>
         <set name="PageNum"       value="1"/>
       </else>
       <if condition="AND(IsExistNode(NumPerPag),NOT(ISNULL(NumPerPag)))">
         <set name="NumPerPag"     expr="NumPerPag"/>
       </if> 
       <else>
         <set name="NumPerPag"     value="5"/>
       </else>
       
       <!--如果是继续支付 需要收集一下充值订单信息-->
       <set name="merNo"            expr="merNo"/>      <!--商户号-->
       <set name="OrdAmt"           expr="OrdAmt"/>     <!--订单金额-->
       <set name="regOrdNo"         expr="regOrdNo"/>   <!--充值订单号-->
       <!-- 默认查询近一个月的充值记录 -->
       <if condition="OR(NOT(IsExistNode(startDate)),ISNULL(startDate))">
         <set name="startDate"     expr="CALCDATE(GETDATE(),'-','d',30)"/>
       </if> 
       <set name="startDate"     expr="STRCAT(startDate,'000000')"/>
       <if condition="OR(NOT(IsExistNode(endDate)),ISNULL(endDate))">
         <set name="endDate"        expr="GETDATE()"/>
       </if>
       <set name="endDate"     expr="STRCAT(endDate,'240000')"/>
       
       <!--查询充值记录-->
       <do func="PagedQuery"       error="ignore">
         <para name="PageNum"      expr="PageNum"/>
         <para name="NumPerPag"    expr="NumPerPag"/>
         <para name="Sql"          sql="queryTakeCash"/>
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="00000"/>
         <set name="RspMsg"        value="用户绑定信息不存在"/>
         <set name="nums"          value="0"/>
         <set name="TOLCNT"        value="0"/>
         <set name="ALLPAGENUM"    value="0"/>
         <set name="RECNUM"        value="0"/>
         <set name="PAGENUM"       value="0"/>
       </if>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
         <return/>
       </elseif>
       
       <set name="ALLPAGENUM"     expr="DIV(TOLCNT,NUMPERPAG)"/>
       <set name="mob"            expr="MOD(TOLCNT,NUMPERPAG)"/>
       <if condition="IS_NOEQUAL_STRING(MOB,'0')">
         <set name="ALLPAGENUM"   expr="ADD(ALLPAGENUM,1)"/>
       </if>
       <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
         <set name="PageNum"     expr="ALLPAGENUM"/>
       </if>
       <if condition="INTCMP(ALLPAGENUM,6,'0')">
          <if condition="INTCMP(PageNum,3,'0')">
           <set name="PageNum"     value="1"/>
         </if>
       </if>
       <set name="MsgTyp"        value="N"/>
       <set name="RspCod"        value="00000"/>
       <set name="RspMsg"        value="交易成功"/>
     </process>
   </transaction>

   <transaction code="561521" desc="用户交易查询 付款  ">
     <sql name="queryPsyCash"> <!--  查询用户付款交易记录  -->
         select STPUSRINF.CUST_LOGIN, StpTraInf.TRAORDNO,StpTraInf.ordstatus,
                To_Char(to_date(traTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')     as ACTDAT,P.PAY_AC_NO,
                TRATYPE,substr(StpTraInf.TGETACCNO,1,3) || '****' || substr(StpTraInf.TGETACCNO,(length(StpTraInf.TGETACCNO)-3),5) as TGETACCNO,
                 StpTraInf.TGETACCNAM, TO_CHAR(to_number(TXAMT)/100,'FM9999,999,999,990.00') TXAMT1,StpTraInf.batno,StpTraInf.CUST_ID,TO_CHAR(to_number(nvl(FEE,'0'))/100,'FM9999,999,999,990.00') FEE1
         from StpTraInf,STPUSRINF,ARP_AC_CUST_REL P
         where StpTraInf.CUST_ID=STPUSRINF.CUST_ID and StpTraInf.CUST_ID=${USRID} and P.CUST_ID=STPUSRINF.CUST_ID and StpTraInf.tratime &gt;=#{startDate} and StpTraInf.tratime &lt;=#{endDate}
         order by traTime DESC,StpTraInf.FILED1 DESC,StpTraInf.TRAORDNO
     </sql>
     <sql name="QryAut">
         select a.CUST_LOGIN, a.USR_STATUS as AUTHSTAT ,b.PAY_AC_NO
         from stpusrinf a,ARP_AC_CUST_REL b 
         where a.cust_id=b.cust_id and b.ac_type='01' and a.CUST_ID=#{USRID}
     </sql>
     <sql name="QryTraHis">
         select a.CUST_ID AS CUSTIDHIS, a.TGETACCID AS TGETACCIDHIS,To_Char(to_date(a.TRATIME,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')     as TRATIMEHIS,
                b.CUST_NAME AS CUSTNAMEHIS,
                c.CUST_LOGIN AS CUSTLOGINHIS
         from STPTRAHISINF  a,STPCUSINF b,STPUSRINF c
         where a.CUST_ID=${USRID} and a.TGETACCID = b.CUST_ID and a.TGETACCID = c.CUST_ID and rownum &lt;  16
         order by a.TRATIME DESC 
     </sql>
     <process>
       <set name="USRID"    expr="SESSIONS.USRID"/>
       <set name="_REQUESTATTR.FORWARDURL"       value="/html/paycash/userpaycash.jsp"/> 
       <if condition="IS_NOEQUAL_STRING(SysCod,'0001')"><!-- 检查用户登录平台是否正确 -->
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>

       <set name="USRID"           expr="SESSIONS.USRID"/>
       <if condition="IS_EQUAL_STRING(USRID,'')">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="支付账号为空"/>
         <set name="_REQUESTATTR.FORWARDURL"       value="html/login/login.jsp"/>
         <return/>
       </if>
       
       <!--c查询用户状态-->
       <do func="ReadRecord"     error="IGNORE">
         <para name="SqlCmd"    sql="QryAut" />
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02009"/>
         <set name="RspMsg"        value="用户未登录"/>
         <return/>
       </if>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
         <return/>
       </elseif>
       
       <if condition="AND(IsExistNode(PageNum),NOT(ISNULL(PageNum)))">
         <set name="PageNum"       expr="PageNum"/>
       </if> 
       <else>
         <set name="PageNum"       value="1"/>
       </else>
       <if condition="AND(IsExistNode(NumPerPag),NOT(ISNULL(NumPerPag)))">
         <set name="NumPerPag"     expr="NumPerPag"/>
       </if> 
       <else>
         <set name="NumPerPag"     value="5"/>
       </else>
       
       <!-- 默认查询近一个月的付款记录 -->
       <if condition="OR(NOT(IsExistNode(startDate)),ISNULL(startDate))">
         <set name="startDate"     expr="CALCDATE(GETDATE(),'-','d',30)"/>
       </if> 
       <set name="startDate"     expr="STRCAT(startDate,'000000')"/>  
       
       <if condition="OR(NOT(IsExistNode(endDate)),ISNULL(endDate))">
         <set name="endDate"        expr="GETDATE()"/>
       </if> 
       <set name="endDate"     expr="STRCAT(endDate,'240000')"/>  
       
       <!--查询付款记录-->
       <do func="PagedQuery"       error="ignore">
         <para name="PageNum"      expr="PageNum"/>
         <para name="NumPerPag"    expr="NumPerPag"/>
         <para name="Sql"          sql="queryPsyCash"/>
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="00000"/>
         <set name="RspMsg"        value="用户绑定信息不存在"/>
         <set name="nums"          value="0"/>  
         <set name="TOLCNT"        value="0"/>
         <set name="ALLPAGENUM"    value="0"/>
         <set name="RECNUM"        value="0"/>
         <set name="PAGENUM"       value="0"/>
         <return/>
       </if>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
         <return/>
       </elseif>
       
       
       <set name="ALLPAGENUM"     expr="DIV(TOLCNT,NUMPERPAG)"/>
       <set name="mob"            expr="MOD(TOLCNT,NUMPERPAG)"/>
       <if condition="IS_NOEQUAL_STRING(MOB,'0')">
         <set name="ALLPAGENUM"   expr="ADD(ALLPAGENUM,1)"/>
       </if>
       <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
         <set name="PageNum"      expr="ALLPAGENUM"/>
       </if>
       <if condition="INTCMP(ALLPAGENUM,6,'0')">
          <if condition="INTCMP(PageNum,3,'0')">
           <set name="PageNum"     value="1"/>
         </if>
       </if>
       
       <do func="QueryInGroup"    error="IGNORE">
         <para name="SqlCmd"      sql="QryTraHis" /> 
         <para name="RecordName"  value="PROGRP"/>
         <para name="RecNum"      value="PRONUM"/>
       </do>
       <if condition="#RetCod==2">
           <set name="RECORDNUM"    value="2"/>
           <set name="MsgTyp"       value="E"/>
           <set name="RspCod"       value="02008"/>
           <set name="RspMsg"       value="该用户不存在转账记录"/>
       </if>
       <elseif condition="#RetCod==-1">
            <set name="RECORDNUM"    value="-1"/>
           <set name="MsgTyp"       value="E"/>
           <set name="RspCod"       value="09998"/>
           <set name="RspMsg"       value="网络繁忙，请稍后再试"/>
           <return/>
       </elseif>
       <set name="RECORDNUM"     value="0"/>
       <set name="MsgTyp"        value="N"/>
       <set name="RspCod"        value="00000"/>
       <set name="RspMsg"        value="交易成功"/>
     </process>
   </transaction>
   
   <transaction code="DelTraHis" desc="删除转账历史">
       <sql name="DelTraHis">
         delete STPTRAHISINF where cust_id = #{USRID} and TGETACCID = #{TGETACCID}
     </sql>
     <process>
       <set name="USRID"        expr="SESSIONS.USRID"/>
       <set name="TGETACCID"    expr="TGETACCIDHIS"/>
       <do func="ExecSql" error="IGNORE">
        <para name="SqlCmd" sql="DelTraHis"/>
      </do>
      <if condition="#RetCod==2">
          <set name="RspCod"           value="01004"/>
          <set name="RspMsg"           value="无此条记录"/>
      </if>
      <elseif condition="#RetCod!=0">
          <set name="RspCod"           value="09999"/>
          <set name="RspMsg"           value="系统繁忙，请稍后再试"/>
          <return/>
      </elseif>
      <set name="RspCod"           value="000000"/>
      <set name="RspMsg"           value="删除成功"/>
     </process>
   </transaction>

   <transaction code="561522" desc="用户交易查询 提现  ">
     <sql name="queryGetCash"> <!--  查询用户提现交易记录  -->
         select CASORDNO,ordstatus,To_Char(to_date(ACTDAT,'yyyymmddHH24miss'),'yyyy-mm-dd HH24:mi:ss') as ACTDAT,bankPayAcNo,substr(bankPayAcNo,-4)as bankPayAcNo_Tmp ,
               TO_CHAR(to_number(TXAMT)/100,'FM9999,999,999,990.00') TXAMT,TO_CHAR(to_number(FEE)/100,'FM9999,999,999,990.00') FEE,enm_dat_des as bankNam
           from StpCasInf, (select enm_dat_opt,enm_dat_des from lyxdicenm where sys_id='0001' and trim(enm_en_nam)='bankNam')
          where CUST_ID=#{USRID} and bankcode = trim(enm_dat_opt) 
          order by actDat DESC,CASORDNO
     </sql>
     <sql name="QryAut">
         select a.CUST_LOGIN, a.USR_STATUS as AUTHSTAT,b.PAY_AC_NO
         from stpusrinf a,ARP_AC_CUST_REL b
         where a.cust_id=b.cust_id and a.CUST_ID=${USRID} and b.ac_type='01'
     </sql>
      <sql name="SelAccInf"><!-- 查询客户账户信息-->
        SELECT a.AC_STATUS FROM ARP_AC_PROFILE a,ARP_AC_CUST_REL b WHERE b.CUST_ID=#{USRID} AND a.PAY_AC_NO=b.PAY_AC_NO
     </sql>
     <process>
       <set name="_REQUESTATTR.FORWARDURL"       value="/html/getcash/usergetcash.jsp"/> 
       <if condition="IS_NOEQUAL_STRING(SysCod,'0001')"><!-- 检查用户登录平台是否正确 -->
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>

       <!-- 检查手机号是否为空 -->
       <set name="USRID"           expr="SESSIONS.USRID"/>
       <if condition="IS_EQUAL_STRING(USRID,'')">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="支付账号为空"/>
         <set name="_REQUESTATTR.FORWARDURL"       value="html/login/login.jsp"/>
         <return/>
       </if>
       
        <!--c查询用户状态-->
       <do func="ReadRecord"     error="IGNORE">
         <para name="SqlCmd"    sql="QryAut" />
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02009"/>
         <set name="RspMsg"        value="用户未登录"/>
         <return/>
       </if>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
         <return/>
       </elseif>
       
       <if condition="AND(IsExistNode(PageNum),NOT(ISNULL(PageNum)))">
         <set name="PageNum"       expr="PageNum"/>
       </if> 
       <else>
         <set name="PageNum"       value="1"/>
       </else>
       <if condition="AND(IsExistNode(NumPerPag),NOT(ISNULL(NumPerPag)))">
         <set name="NumPerPag"     expr="NumPerPag"/>
       </if> 
       <else>
         <set name="NumPerPag"     value="5"/>
       </else>
       
       <!--查询提现记录-->
       <do func="PagedQuery"       error="ignore">
         <para name="PageNum"      expr="PageNum"/>
         <para name="NumPerPag"    expr="NumPerPag"/>
         <para name="Sql"          sql="queryGetCash"/>
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="N"/>
         <set name="RspCod"        value="00000"/>
         <set name="nums"          value="0"/>   
         <set name="TOLCNT"        value="0"/>
         <set name="ALLPAGENUM"    value="0"/>
         <set name="RECNUM"        value="0"/>
         <set name="PAGENUM"       value="0"/>
         <return/>
       </if>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
         <return/>
       </elseif>
       
       <set name="ALLPAGENUM"     expr="DIV(TOLCNT,NUMPERPAG)"/>
       <set name="mob"     expr="MOD(TOLCNT,NUMPERPAG)"/>
       <if condition="IS_NOEQUAL_STRING(MOB,'0')">
         <set name="ALLPAGENUM"     expr="ADD(ALLPAGENUM,1)"/>
       </if>
       <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
         <set name="PageNum"     expr="ALLPAGENUM"/>
       </if>
       <if condition="INTCMP(ALLPAGENUM,6,'0')">
          <if condition="INTCMP(PageNum,3,'0')">
           <set name="PageNum"     value="1"/>
         </if>
       </if>
       
       <quote name="chkAcc"/>
       
       <foreach name="GRP" iterator="#grp">
         <set name="sDeData"       expr="#grp.bankPayAcNo"   />  
         <if condition="NOT(ISNULL(DES_DECRYPT(sDeData)))">   
            <set name="sDeData"       expr="DES_DECRYPT(sDeData)"   />
         </if>
         <set name="First"         expr="SUBSTR(sDeData,1,3)"/> 
         <set name="End"           expr="SUBSTR(sDeData,SUB(STRLEN(sDeData),3),STRLEN(sDeData))"/>
         <set name="descryptdata"  expr="STRCAT(First,'****',End)"/>
         <set name="descryptdata"  expr="End"/>
         <do func="loopSetEach">
           <para name="ele" expr="#grp.bankPayAcNo"/> 
           <para name="value" expr="descryptdata"/>
         </do>
         <if condition="#RetCod!=0">
           <set name="RspCod"            value="09998"/>
           <set name="RspMsg"            value="系统错误"/>
           <set name="DWZ_STATUS_CODE"   value="300"/>
           <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
           <return/>
         </if>
      </foreach>
       
       
       <set name="ac_status"     expr="AC_STATUS"/>
       <set name="MsgTyp"        value="N"/>
       <set name="RspCod"        value="00000"/>
       <set name="RspMsg"        value="交易成功"/>
     </process>
   </transaction>
   
   <transaction code="561121" desc="用户交易查询 担保收款  ">
     <sql name="queryPsyCash"> <!--  查询用户担保收款交易记录  -->
         select STPUSRINF.CUST_LOGIN, StpTraInf.TRAORDNO,StpTraInf.ORDSTATUS,
                To_Char(to_date(traTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')     as ACTDAT
                ,StpTraInf.TGETACCNO,StpTraInf.TRATYPE,decode(trim(StpTraInf.ORDSTATUS),'00','待付款','01','付款成功','02','付款失败','03','预付款','99','付款超时') ORDSTATUSNAM,
                 StpTraInf.TGETACCNAM, TO_CHAR(to_number(TXAMT)/100,'FM9999,999,999,990.00') TXAMT1,StpTraInf.batno,StpTraInf.CUST_ID
         from StpTraInf,STPUSRINF,STPCUSINF P
         where StpTraInf.CUST_ID=STPUSRINF.CUST_ID and P.CUST_ID=STPUSRINF.CUST_ID and StpTraInf.tratime &gt;=#{startDate} and StpTraInf.tratime &lt;=#{endDate} and (StpTraInf.TRATYPE = '02' and StpTraInf.CUST_ID=${USRID})
         union
         select #{SESSIONS.USRMP} CUST_LOGIN, StpTraInf.TRAORDNO,StpTraInf.ORDSTATUS,
                 To_Char(to_date(traTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')     as ACTDAT
                 ,STPUSRINF.CUST_LOGIN TGETACCNO,StpTraInf.TRATYPE,decode(trim(StpTraInf.ORDSTATUS),'00','待付款','01','付款成功','02','付款失败','03','预付款','99','付款超时') ORDSTATUSNAM,
                 P.CUST_NAME TGETACCNAM, TO_CHAR(to_number(TXAMT)/100,'FM9999,999,999,990.00') TXAMT1,StpTraInf.batno,StpTraInf.CUST_ID
         from StpTraInf,STPUSRINF,STPCUSINF P
         where StpTraInf.CUST_ID=STPUSRINF.CUST_ID and P.CUST_ID=STPUSRINF.CUST_ID and StpTraInf.tratime &gt;=#{startDate} and StpTraInf.tratime &lt;=#{endDate} and (StpTraInf.TRATYPE = '03' and ${SESSIONS.USRMP}=StpTraInf.TGETACCNO)
         order by ACTDAT DESC
     </sql>
     <sql name="QryAut">
         select CUST_LOGIN, USR_STATUS as AUTHSTAT 
         from stpusrinf 
         where CUST_ID=${USRID}
     </sql>
     <process>
       <set name="USRID"    expr="SESSIONS.USRID"/>
       <set name="_REQUESTATTR.FORWARDURL"       value="/html/guarant/guarantpay.jsp"/> 
       <if condition="IS_NOEQUAL_STRING(SysCod,'0001')"><!-- 检查用户登录平台是否正确 -->
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>

       <set name="USRID"           expr="SESSIONS.USRID"/>
       <if condition="IS_EQUAL_STRING(USRID,'')">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="支付账号为空"/>
         <set name="_REQUESTATTR.FORWARDURL"       value="html/login/login.jsp"/>
         <return/>
       </if>
       
       <!--查询用户状态-->
       <do func="ReadRecord"     error="IGNORE">
         <para name="SqlCmd"    sql="QryAut" />
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02009"/>
         <set name="RspMsg"        value="用户未登录"/>
         <return/>
       </if>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
         <return/>
       </elseif>
       
       <if condition="AND(IsExistNode(PageNum),NOT(ISNULL(PageNum)))">
         <set name="PageNum"       expr="PageNum"/>
       </if> 
       <else>
         <set name="PageNum"       value="1"/>
       </else>
       <if condition="AND(IsExistNode(NumPerPag),NOT(ISNULL(NumPerPag)))">
         <set name="NumPerPag"     expr="NumPerPag"/>
       </if> 
       <else>
         <set name="NumPerPag"     value="5"/>
       </else>
       
       <!-- 默认查询近一个月的付款记录 -->
       <if condition="OR(NOT(IsExistNode(startDate)),ISNULL(startDate))">
         <set name="startDate"     expr="CALCDATE(GETDATE(),'-','d',30)"/>
       </if> 
       <set name="startDate"     expr="STRCAT(startDate,'000000')"/>  
       
       <if condition="OR(NOT(IsExistNode(endDate)),ISNULL(endDate))">
         <set name="endDate"        expr="GETDATE()"/>
       </if> 
       <set name="endDate"     expr="STRCAT(endDate,'240000')"/>  
       
       <!--查询付款记录-->
       <do func="PagedQuery"       error="ignore">
         <para name="PageNum"      expr="PageNum"/>
         <para name="NumPerPag"    expr="NumPerPag"/>
         <para name="Sql"          sql="queryPsyCash"/>
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="00000"/>
         <set name="RspMsg"        value="用户收款信息不存在"/>
         <set name="nums"          value="0"/>  
         <set name="TOLCNT"        value="0"/>
         <set name="ALLPAGENUM"    value="0"/>
         <set name="RECNUM"        value="0"/>
         <set name="PAGENUM"       value="0"/>
         <return/>
       </if>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
         <return/>
       </elseif>

       <set name="ALLPAGENUM"     expr="DIV(TOLCNT,NUMPERPAG)"/>
       <set name="mob"            expr="MOD(TOLCNT,NUMPERPAG)"/>
       <if condition="IS_NOEQUAL_STRING(MOB,'0')">
         <set name="ALLPAGENUM"   expr="ADD(ALLPAGENUM,1)"/>
       </if>
       <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
         <set name="PageNum"      expr="ALLPAGENUM"/>
       </if>
       <if condition="INTCMP(ALLPAGENUM,6,'0')">
         <if condition="INTCMP(PageNum,3,'0')">
           <set name="PageNum"     value="1"/>
         </if>
       </if>
       <set name="MsgTyp"        value="N"/>
       <set name="RspCod"        value="00000"/>
       <set name="RspMsg"        value="交易成功"/>
     </process>
   </transaction>
  
   <transaction code="561122" desc="用户交易查询 担保付款  ">
     <sql name="queryPsyCash"> <!--  查询用户担保收款交易记录  -->
         (select STPUSRINF.CUST_LOGIN, StpTraInf.TRAORDNO,StpTraInf.ORDSTATUS,
                 To_Char(to_date(traTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')     as ACTDAT
                 ,StpTraInf.TGETACCNO,decode(trim(StpTraInf.ORDSTATUS),'00','待付款','01','付款成功','02','付款失败','03','预付款','99','付款超时') ORDSTATUSNAM,
                 StpTraInf.TGETACCNAM, TO_CHAR(to_number(TXAMT)/100,'FM9999,999,999,990.00') TXAMT1,StpTraInf.batno,StpTraInf.CUST_ID
         from StpTraInf,STPUSRINF,ARP_AC_CUST_REL P
         where StpTraInf.CUST_ID=STPUSRINF.CUST_ID and P.CUST_ID=STPUSRINF.CUST_ID and StpTraInf.tratime &gt;=#{startDate} and StpTraInf.tratime &lt;=#{endDate} and (StpTraInf.TRATYPE = '03' and StpTraInf.CUST_ID=${USRID})
         )
         union
         (
          select #{SESSIONS.USRMP} CUST_LOGIN, StpTraInf.TRAORDNO,StpTraInf.ORDSTATUS,
                 To_Char(to_date(traTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')     as ACTDAT
                 ,StpUsrInf.CUST_LOGIN,decode(trim(StpTraInf.ORDSTATUS),'00','待付款','01','付款成功','02','付款失败','03','预付款','99','付款超时') ORDSTATUSNAM,
                 P.CUST_NAME TGETACCNAM, TO_CHAR(to_number(TXAMT)/100,'FM9999,999,999,990.00') TXAMT1,StpTraInf.batno,StpTraInf.CUST_ID
         from StpTraInf,STPUSRINF,STPCUSINF P
         where StpTraInf.CUST_ID=STPUSRINF.CUST_ID and P.CUST_ID=STPUSRINF.CUST_ID and StpTraInf.tratime &gt;=#{startDate} and StpTraInf.tratime &lt;=#{endDate} and  (StpTraInf.TRATYPE = '02' and ${SESSIONS.USRMP}=StpTraInf.TGETACCNO)
         )
         order by ACTDAT DESC
     </sql>
     <sql name="QryAut">
         select CUST_LOGIN, USR_STATUS as AUTHSTAT 
         from stpusrinf 
         where CUST_ID=${USRID}
     </sql>
     <process>
       <set name="USRID"    expr="SESSIONS.USRID"/>
       <set name="_REQUESTATTR.FORWARDURL"       value="/html/guarant/payguarant.jsp"/> 
       <if condition="IS_NOEQUAL_STRING(SysCod,'0001')"><!-- 检查用户登录平台是否正确 -->
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>

       <set name="USRID"           expr="SESSIONS.USRID"/>
       <if condition="IS_EQUAL_STRING(USRID,'')">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="支付账号为空"/>
         <set name="_REQUESTATTR.FORWARDURL"       value="html/login/login.jsp"/>
         <return/>
       </if>
       
       <!--查询用户状态-->
       <do func="ReadRecord"     error="IGNORE">
         <para name="SqlCmd"    sql="QryAut" />
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02009"/>
         <set name="RspMsg"        value="用户未登录"/>
         <return/>
       </if>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
         <return/>
       </elseif>
       
       <if condition="AND(IsExistNode(PageNum),NOT(ISNULL(PageNum)))">
         <set name="PageNum"       expr="PageNum"/>
       </if> 
       <else>
         <set name="PageNum"       value="1"/>
       </else>
       <if condition="AND(IsExistNode(NumPerPag),NOT(ISNULL(NumPerPag)))">
         <set name="NumPerPag"     expr="NumPerPag"/>
       </if> 
       <else>
         <set name="NumPerPag"     value="5"/>
       </else>
       
       <!-- 默认查询近一个月的付款记录 -->
       <if condition="OR(NOT(IsExistNode(startDate)),ISNULL(startDate))">
         <set name="startDate"     expr="CALCDATE(GETDATE(),'-','d',30)"/>
       </if> 
       <set name="startDate"     expr="STRCAT(startDate,'000000')"/>  
       
       <if condition="OR(NOT(IsExistNode(endDate)),ISNULL(endDate))">
         <set name="endDate"        expr="GETDATE()"/>
       </if> 
       <set name="endDate"     expr="STRCAT(endDate,'240000')"/>  
       
       <!--查询付款记录-->
       <do func="PagedQuery"       error="ignore">
         <para name="PageNum"      expr="PageNum"/>
         <para name="NumPerPag"    expr="NumPerPag"/>
         <para name="Sql"          sql="queryPsyCash"/>
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="00000"/>
         <set name="RspMsg"        value="用户付款信息不存在"/>
         <set name="nums"          value="0"/> 
         <set name="TOLCNT"        value="0"/>
         <set name="ALLPAGENUM"    value="0"/>
         <set name="RECNUM"        value="0"/>
         <set name="PAGENUM"       value="0"/>
         <return/>
       </if>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
         <return/>
       </elseif>
       
       <set name="ALLPAGENUM"     expr="DIV(TOLCNT,NUMPERPAG)"/>
       <set name="mob"            expr="MOD(TOLCNT,NUMPERPAG)"/>
       <if condition="IS_NOEQUAL_STRING(MOB,'0')">
         <set name="ALLPAGENUM"     expr="ADD(ALLPAGENUM,1)"/>
       </if>
       <if condition="INTCMP(PageNum,6,ALLPAGENUM)">
         <set name="PageNum"     expr="ALLPAGENUM"/>
       </if>
       <if condition="INTCMP(ALLPAGENUM,6,'0')">
          <if condition="INTCMP(PageNum,3,'0')">
           <set name="PageNum"     value="1"/>
         </if>
       </if>
       <set name="MsgTyp"        value="N"/>
       <set name="RspCod"        value="00000"/>
       <set name="RspMsg"        value="交易成功"/>
     </process>
   </transaction>
   
   <transaction code="565984" desc="担保明细查询">
     <sql name="selOrdInf"> 
          select STPUSRINF.CUST_LOGIN, StpTraInf.TRAORDNO,StpTraInf.ORDSTATUS,
                  To_Char(to_date(traTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')  as ACTDAT
                  ,P.PAY_AC_NO,StpTraInf.TGETACCNO,decode(trim(StpTraInf.ORDSTATUS),'00','待付款','01','付款成功','02','付款失败','03','预付款','99','付款超时') ORDSTATUSNAM,
                  StpTraInf.TGETACCNAM, TO_CHAR(to_number(TXAMT)/100,'FM9999,999,999,990.00') TXAMT,StpTraInf.batno,StpTraInf.CUST_ID
           from StpTraInf,STPUSRINF,ARP_AC_CUST_REL P
          where StpTraInf.traordno=#{traordno} and StpTraInf.CUST_ID=STPUSRINF.CUST_ID and P.CUST_ID=STPUSRINF.CUST_ID
     </sql>
     <process>
       <set name="USRID"    expr="SESSIONS.USRID"/>
       <if condition="IS_NOEQUAL_STRING(SysCod,'0001')"><!-- 检查用户登录平台是否正确 -->
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>

       <set name="USRID"           expr="SESSIONS.USRID"/>
       <if condition="IS_EQUAL_STRING(USRID,'')">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="支付账号为空"/>
         <set name="_REQUESTATTR.FORWARDURL"       value="html/login/login.jsp"/>
         <return/>
       </if> 
       
       <!--查询付款记录-->
       <do func="ReadRecord"       error="ignore">
         <para name="SqlCmd"          sql="selOrdInf"/>
       </do>
       <if condition="#RetCod==2">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="00000"/>
         <set name="RspMsg"        value="用户付款信息不存在"/>
         <return/>
       </if>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误,请稍后再试或联系客服"/>
         <return/>
       </elseif>
       
       <set name="MsgTyp"        value="N"/>
       <set name="RspCod"        value="00000"/>
       <set name="RspMsg"        value="交易成功"/>
     </process>
   </transaction>
   
   <transaction code="561263" desc="用户信息显示">
      <sql name="ChkUerInfo"><!--查询用户信息--> 
         select a.CUST_ID, a.CUST_LOGIN, a.usr_email as EMAIL, 
                nvl(a.usr_fax,' ') as FAX, 
                nvl(a.usr_address,' ') as ADDRESS, nvl(a.usr_zip,' ') as ZIP, 
                nvl(a.usr_job,' ') as JOB, nvl(a.usr_telnum,' ') as TELNUM, 
                nvl(a.cust_login,' ') as MOBILE,  nvl(a.usr_befnam,' ') as USER_BEFORENAME,
                nvl(a.usr_birthday,' ') as BIRTHDAY, nvl(a.usr_gender,' ') as GENDER, 
                enm_dat_des as NATIONALITY, a.email_status as EMAIL_STATE,
                nvl(PASSWORD_STRENGTH,' ') as PSSTRENGTH,nvl(PAYPWD_STRENGTH,' ') as PYSTRENGTH,
                To_Char(to_date(c.cust_reg_date||c.cust_reg_time,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as REGISTER_DATE,
                nvl(c.cust_name,' ') as USER_NAME,
                 c.cust_cred_no as USER_NO, c.cust_cred_type as ID_TYPE_CODE,c.cust_status as  STATE,
                l.log_suc_time,To_Char(to_date(l.PRE_LOG_SUC_TIM,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as LAST_LOGIN_TIME,a.USR_STATUS as U_AUTH_STATUS
          from stpusrinf a,(select  enm_dat_opt,enm_dat_des from lyxdicenm where sys_id='0001' and trim(enm_en_nam) like 'NATIONALITY'),stpcusinf c,stpcuslog l
          where a.CUST_ID='${CUST_NO}' and NATIONALITY = trim(enm_dat_opt) and a.cust_id = c.cust_id and a.cust_id = l.cust_id  
      </sql>     
      <sql name="QryMainNum"><!--  查询绑定银行卡的数量  -->
         SELECT count(*) MAINNUM  FROM STPBANKTB WHERE CUST_ID=#{CUST_NO} AND CARD_TYPE in ('0','01')
      </sql> 
      <sql name="QryPPCNum"><!--  查询绑定预付卡的数量  -->
         SELECT count(*) PPCNUM  FROM STPBANKTB WHERE CUST_ID=#{CUST_NO} AND CARD_TYPE in ('04')
      </sql> 
      <sql name="stpusraut"> <!--  查询用户认证信息  --> 
         SELECT a.USR_STATUS as   U_AUTH_STATUS , c.cust_cred_type as u_card_type,
                c.cust_cred_no as u_card_no, m.enm_dat_des as cardType, n.enm_dat_des as authstatus
           FROM stpusrinf a, stpcusinf c ,lyxdicenm m, lyxdicenm n
          WHERE a.CUST_ID=${CUST_NO} and a.cust_id=c.cust_id 
                and c.cust_cred_type=trim(m.Enm_Dat_Opt) and m.sys_id='0001' and trim(m.enm_en_nam) like 'cardType' 
                and a.USR_STATUS = trim(n.Enm_Dat_Opt) and n.sys_id='0001' and trim(n.enm_en_nam) like 'authStatus' 
      </sql>
      <sql name="stpusrjob"> <!--  查询用户信息  --> 
         SELECT m.enm_dat_des USR_JOB 
           FROM stpusrinf a, stpcusinf c ,lyxdicenm m
          WHERE a.CUST_ID=${CUST_NO} and a.cust_id=c.cust_id 
                and a.USR_JOB = trim(m.Enm_Dat_Opt) and m.sys_id='0001' and  trim(m.enm_en_nam) like 'USR_JOB' 
      </sql>
      <sql name="selLestTime">
       select to_char(to_date(PRE_LOG_SUC_TIM,'yyyy-mm-dd hh24:mi:ss'),'yyyy-mm-dd hh24:mi:ss') as PRE_TIM 
         from stpcuslog 
        where cust_id = #{cust_id}
      </sql>
      <process>
         <!--检查用户登录平台是否正确-->
         <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台错误"/>
            <return/>
         </if>
         <if condition="ISNULL(SESSIONS.USRMP)">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01002"/>
            <set name="RspMsg"    value="您还没有登录，请先登录！"/>
            <set name="_REQUESTATTR.FORWARDURL"       value="html/login/login.jsp"/>
            <return/>
         </if>
         <set name="CUST_NO"      expr="SESSIONS.CUSTNO"/>
         <set name="PAYACNO"      expr="SESSIONS.PAYACNO"/>
         <!-- 查询用户信息 --> 
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="ChkUerInfo"/>
         </do>
         <if condition="#RetCod==2">
           <set name="RspCod"    value="02004"/>
           <set name="RspMsg"    value="没有查到该用户信息"/>
           <return/>
         </if>
         <elseif condition="#RetCod!=0">
           <set name="RspCod"    value="09999"/>
           <set name="RspMsg"    value="系统错误"/>
           <return/>
         </elseif>
         <do func="ReadRecord"     error="IGNORE">
            <para name="SqlCmd"      sql="selLestTime"/>
           </do>
           <if condition="#RetCod==0">
           <set name="PRE_TIM" expr="PRE_TIM"/>
         </if>  
 
         <!-- 查询用户绑定银行卡的数量 -->
         <do func="ReadRecord"   error="IGNORE">
            <para name="SqlCmd"  sql="QryMainNum"/>
         </do>
         <if condition="#RetCod==2">
            <set name="RspCod"   value="02004"/>
            <set name="RspMsg"   value="没有记录"/>
            <return/>
         </if>
         <elseif condition="#RetCod!=0">
           <set name="RspCod"    value="09999"/>
           <set name="RspMsg"    value="系统错误"/>
           <return/>
         </elseif> 
         
         <!-- 查询用户绑定预付卡的数量 -->
         <do func="ReadRecord"   error="IGNORE">
            <para name="SqlCmd"  sql="QryPPCNum"/>
         </do>
         <if condition="#RetCod==2">
            <set name="RspCod"   value="02004"/>
            <set name="RspMsg"   value="没有记录"/>
            <return/>
         </if>
         <elseif condition="#RetCod!=0">
           <set name="RspCod"    value="09999"/>
           <set name="RspMsg"    value="系统错误"/>
           <return/>
         </elseif> 
         <!-- 查询用户认证信息 -->
         <do func="ReadRecord"     error="IGNORE">
            <para name="SqlCmd"    sql="stpusraut" />
         </do>
         <if condition="#RetCod==2">
            <set name="MsgTyp"     value="E"/>
            <set name="RspCod"     value="02008"/>
            <set name="RspMsg"     value="用户未认证"/>
            <return/>
         </if>
         <elseif condition="#RetCod==-1">
            <set name="MsgTyp"     value="E"/>
            <set name="RspCod"     value="09999"/>
            <set name="RspMsg"     value="系统错误"/>
            <set name="_REQUESTATTR.FORWARDURL"    value="/html/error.jsp"/>
            <return/>
         </elseif>
         <elseif condition="#RetCod!=0">
            <set name="MsgTyp"     value="E"/>
            <set name="RspCod"     value="09997"/>
            <set name="RspMsg"     value="系统操作异常,请稍后再试或联系客服"/>
            <set name="_REQUESTATTR.FORWARDURL"    value="/html/error.jsp"/>
            <return/>
         </elseif> 
         
         <!-- 查询用户工作信息 -->
         <do func="ReadRecord"     error="IGNORE">
            <para name="SqlCmd"    sql="stpusrjob" />
         </do>
         <if condition="#RetCod==2">
            <set name="MsgTyp"     value="E"/>
            <set name="RspCod"     value="02008"/>
            <set name="RspMsg"     value="用户未设置工作"/>
         </if>
         <elseif condition="#RetCod!=0">
            <set name="MsgTyp"     value="E"/>
            <set name="RspCod"     value="09997"/>
            <set name="RspMsg"     value="系统操作异常,请稍后再试或联系客服"/>
            <set name="_REQUESTATTR.FORWARDURL"    value="/html/error.jsp"/>
            <return/>
         </elseif> 
         <if condition="IS_EQUAL_STRING(FLAG,'0')">
            <set name="_REQUESTATTR.FORWARDURL" value="/html/user/myZhifutong1.jsp"/>
         </if> 
         <elseif condition="IS_EQUAL_STRING(FLAG,'1')">
            <set name="_REQUESTATTR.FORWARDURL" value="/html/user/showuserinfo.jsp"/>
         </elseif>
         <elseif condition="IS_EQUAL_STRING(FLAG,'2')">
            <set name="_REQUESTATTR.FORWARDURL" value="/html/user/usruptinf.jsp"/>
         </elseif>
         <elseif condition="IS_EQUAL_STRING(FLAG,'3')">
            <set name="_REQUESTATTR.FORWARDURL" value="/html/user/sureuser.jsp"/>
         </elseif>
         <elseif condition="IS_EQUAL_STRING(FLAG,'4')">
            <set name="_REQUESTATTR.FORWARDURL" value="/html/user/myaccountshow.jsp"/>
         </elseif>
         <elseif condition="IS_EQUAL_STRING(FLAG,'00')">
            <if condition="NOT(ISNULL(DES_DECRYPT(U_CARD_NO)))">
               <set name="U_CARD_NO"            expr="DES_DECRYPT(U_CARD_NO)"   />
            </if>  
            <set name="LEN"                     expr="STRLEN(U_CARD_NO)"/>              <!--  取得身份证号长度   -->
            <set name="STR2"                    expr="REVERSAL(SUBSTR(U_CARD_NO,SUB(LEN,3),4))"/>
            <set name="CUST_LOGIN1"             expr="REVERSAL(REPSTR(REVERSAL(U_CARD_NO),STR2,'****'))"/>
            <set name="USER_NO1"                expr="REVERSAL(REPSTR(REVERSAL(U_CARD_NO),STR2,'****'))"/> 
            <set name="_REQUESTATTR.FORWARDURL" value="/html/account/useraccountinf.jsp"/>
         </elseif>
         <elseif condition="IS_EQUAL_STRING(FLAG,'01')"> 
            <if condition="NOT(ISNULL(DES_DECRYPT(USER_NO)))">
               <set name="USER_NO"          expr="DES_DECRYPT(USER_NO)"   />
            </if>
            <set name="First"            expr="SUBSTR(CUST_LOGIN,1,3)"/> 
            <set name="End"              expr="SUBSTR(CUST_LOGIN,8,SUB(STRLEN(CUST_LOGIN),7))"/>
            <set name="CUST_LOGIN1"      expr="STRCAT(First,'****',End)"/>
            <set name="LEN"              expr="STRLEN(USER_NO)"/>              <!--  取得身份证号长度   -->
            <set name="STR2"             expr="REVERSAL(SUBSTR(USER_NO,SUB(LEN,3),4))"/>
            <set name="USER_NO1"         expr="REVERSAL(REPSTR(REVERSAL(USER_NO),STR2,'****'))"/>
            <set name="_REQUESTATTR.FORWARDURL" value="/html/account/useraccountinfo.jsp"/>
         </elseif>
         <else>
            <set name="MsgTyp"    value="N"/>
            <set name="RspCod"    value="00000"/>
            <set name="RspMsg"    value="交易成功"/>
         </else>
      </process>
   </transaction>
   
   <transaction code="userInformation" desc="用户信息显示"><!--把交易码561263改成了userInformation -->
        <sql name="ChkUerInfo"><!--查询用户信息 -->
            select a.CUST_ID, a.CUST_LOGIN, a.usr_email as EMAIL,
            nvl(a.usr_fax,'
            ') as FAX,
            nvl(a.usr_address,' ') as ADDRESS, nvl(a.usr_zip,' ') as
            ZIP,
            nvl(a.usr_job,' ') as JOB, nvl(a.usr_telnum,' ') as TELNUM,
            nvl(a.cust_login,' ') as MOBILE, nvl(a.usr_befnam,' ') as
            USER_BEFORENAME,
            nvl(a.usr_birthday,' ') as BIRTHDAY,
            nvl(a.usr_gender,' ') as GENDER,
            a.email_status as EMAIL_STATE,
            nvl(PASSWORD_STRENGTH,' ') as PSSTRENGTH,nvl(PAYPWD_STRENGTH,' ') as
            PYSTRENGTH,
            To_Char(to_date(c.cust_reg_date||c.cust_reg_time,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as REGISTER_DATE,
            nvl(c.cust_name,' ') as USER_NAME,
            c.cust_cred_no as USER_NO, c.cust_cred_type as
            ID_TYPE_CODE,c.cust_status as STATE,
            l.log_suc_time,To_Char(to_date(l.PRE_LOG_SUC_TIM,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as LAST_LOGIN_TIME,a.USR_STATUS as U_AUTH_STATUS
            from
            stpusrinf a,stpcusinf c,stpcuslog l
            where a.CUST_ID=#{CUST_NO} and
            a.cust_id = c.cust_id and a.cust_id =
            l.cust_id
        </sql>
        <sql name="QryMainNum"><!-- 查询绑定银行卡的数量 -->
            SELECT count(*) MAINNUM FROM STPBANKTB WHERE CUST_ID=#{USRID} AND
            CARD_TYPE in ('0','00')
        </sql>
        <sql name="stpusraut"> <!-- 查询用户认证信息 -->
            SELECT a.USR_STATUS as U_AUTH_STATUS , c.cust_cred_type as
            u_card_type,
            c.cust_cred_no as u_card_no, m.enm_dat_des as cardType,
            n.enm_dat_des as authstatus
            FROM stpusrinf a, stpcusinf c ,lyxdicenm
            m, lyxdicenm n
            WHERE a.CUST_ID=${CUST_NO} and a.cust_id=c.cust_id and
            c.cust_cred_type=trim(m.Enm_Dat_Opt) and m.sys_id='0001'
            and
            trim(m.enm_en_nam) like 'cardType'
            and a.USR_STATUS =
            trim(n.Enm_Dat_Opt) and n.sys_id='0001' and
            trim(n.enm_en_nam) = 
            'authStatus'
        </sql>
        <sql name="selLestTime">
            select to_char(to_date(PRE_LOG_SUC_TIM,'yyyy-mm-dd hh24:mi:ss'),'yyyy-mm-dd hh24:mi:ss') as PRE_TIM
            from stpcuslog
            where
            cust_id = #{cust_id}
        </sql>
        <sql name="SelectProInf"><!-- 查询密码保护问题 -->
            SELECT count(PAP_QUES) PAPCNUM FROM STPMERPAP WHERE
            PAP_BUS_ID=#{USRID}
        </sql>
        <sql name="QryStpBankCd"> <!-- 查询用户绑定的银行卡 -->
            SELECT b.BAK_SEQ,b.CUST_ID,b.CARD_NO,
            (select enm_dat_des from
            lyxdicenm n where sys_id='0001' and
            trim(enm_en_nam) like '%bankNam%' and b.CARD_BANK=trim(n.enm_dat_opt))
            as bank_no,substr(b.CARD_NO,(length(b.CARD_NO)-3),4) as CANO,
            (select enm_dat_des from lyxdicenm m where sys_id='0001' and trim(enm_en_nam) like '%bankCardType%' and b.card_type=trim(m.Enm_Dat_Opt)) as banknotype
            FROM STPBANKTB b
            WHERE b.CUST_ID = #{USRID} and (CARD_TYPE='00' or CARD_TYPE='01') and bank_conf='1'
        </sql>
        <sql name="QryCertInf"> <!-- 查询用户数字证书 -->
        		select t.DN from CUST_CERTINF t where t.cust_id = #{USRID}
        </sql>
        <process>
            <!--检查用户登录平台是否正确 -->
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台错误" />
                <return />
            </if>
            <if condition="ISNULL(SESSIONS.USRMP)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="01002" />
                <set name="RspMsg" value="您还没有登录，请先登录！" />
                <set name="_REQUESTATTR.FORWARDURL" value="index.jsp" />
                <return />
            </if>

            <set name="USRID" expr="SESSIONS.USRID" />
            <set name="CUST_NO" expr="SESSIONS.CUSTNO" />
            <set name="PAYACNO" expr="SESSIONS.PAYACNO" />
            <!-- 查询用户信息 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="ChkUerInfo" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod" value="02004" />
                <set name="RspMsg" value="没有查到该用户信息" />
                <return />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>

            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="selLestTime" />
            </do>
            <if condition="#RetCod==0">
                <set name="PRE_TIM" expr="PRE_TIM" />
            </if>

            <!-- 查询用户绑定银行卡 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="SelectProInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod" value="02004" />
                <set name="RspMsg" value="没有记录" />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>

            <!-- 查询用户绑定银行卡 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryStpBankCd" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod" value="02004" />
                <set name="RspMsg" value="没有记录" />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>

            <!-- 查询用户绑定银行卡的数量 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryMainNum" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod" value="02004" />
                <set name="RspMsg" value="没有记录" />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
            
            <!-- 查询用户数字证书信息 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryCertInf" />
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <set name="_REQUESTATTR.FORWARDURL" value="/html/error.jsp" />
                <return />
            </if>

            <!-- 查询用户认证信息 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="stpusraut" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="用户未认证" />
            </if>
            <elseif condition="#RetCod==-1">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <set name="_REQUESTATTR.FORWARDURL" value="/html/error.jsp" />
                <return />
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09997" />
                <set name="RspMsg" value="系统操作异常,请稍后再试或联系客服" />
                <set name="_REQUESTATTR.FORWARDURL" value="/html/error.jsp" />
                <return />
            </elseif>
            
            <if condition="IS_EQUAL_STRING(FLAG,'00')">
                <set name="LEN" expr="STRLEN(U_CARD_NO)" />              <!-- 取得身份证号长度 -->
                <set name="STR2" expr="REVERSAL(SUBSTR(U_CARD_NO,SUB(LEN,3),4))" />
                <set name="USER_NO1" expr="REVERSAL(REPSTR(REVERSAL(U_CARD_NO),STR2,'****'))" />
                <set name="_REQUESTATTR.FORWARDURL"
                    expr="STRCAT('html/', SESSIONS.LANGUAGE, '/account/accountset.jsp')" />
            </if>
            <elseif condition="IS_EQUAL_STRING(FLAG,'01')">
                <set name="First" expr="SUBSTR(CUST_LOGIN,1,3)" />
                <set name="End" expr="SUBSTR(CUST_LOGIN,8,SUB(STRLEN(CUST_LOGIN),7))" />
                <set name="CUST_LOGIN1" expr="STRCAT(First,'****',End)" />
                <set name="LEN" expr="STRLEN(USER_NO)" />              <!-- 取得身份证号长度 -->
                <set name="STR2" expr="REVERSAL(SUBSTR(USER_NO,SUB(LEN,3),4))" />
                <set name="USER_NO1" expr="REVERSAL(REPSTR(REVERSAL(USER_NO),STR2,'****'))" />
                <set name="_REQUESTATTR.FORWARDURL"
                    expr="STRCAT('html/', SESSIONS.LANGUAGE, '/account/accountset.jsp')" />
            </elseif>
            
            <if condition="IS_EQUAL_STRING(type,'3')">
                <set name="_REQUESTATTR.FORWARDURL"
                    expr="STRCAT('html/', SESSIONS.LANGUAGE, '/account/accountset.jsp')" />
            </if>
            <else>
                <set name="MsgTyp" value="N" />
                <set name="RspCod" value="00000" />
                <set name="RspMsg" value="交易成功" />
            </else>
        </process>
    </transaction>
   
   <transaction   code="561264"   desc="协议查询">
     <sql name="selPact">
       select seq_no,PACT_CONTENT2 as PACTCONTENT 
         from  CONTRACTINFO 
        where pact_type=#{pactType} and trim(pact_cust_type) = #{CUSTTYPE} 
              and pact_vers_no=(select MIN(pact_vers_no) 
                                  from CONTRACTINFO 
                                 where  trim(pact_status) = '0' and trim(pact_cust_type) = #{CUSTTYPE} and pact_type=#{pactType})
     </sql>
     <process> 
       <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
         <set name="RspCod"         value="01001"/>
         <set name="RspMsg"         value="用户登录平台不正确"/>
         <return/>
       </if>
       
       <set name="seqNo"    expr="STRCAT(pactType,pactVersNo)"/>
       <do func="ReadRecord"    error="IGNORE">
          <para name="SqlCmd"    sql="selPact"/>
       </do>
       
       <set name="MsgTyp"           value="N"/>
       <set name="RspCod"           value="00000"/>
       <set name="RspMsg"           value="交易成功"/>
     </process>
   </transaction>
  
   <transaction   code="561400"   desc="用户余额查询">
     <sql name="QryUsrInfPay"> <!--  查询用户认证信息  --> 
         SELECT U.CUST_LOGIN AS LOGNAM,C.CUST_NAME AS userNam,c.CUST_STATUS, C.CUST_ID AS custno, L.PAY_AC_NO AS payacno, C.CUST_CRED_NO AS U_CARD_NO,
                C.CUST_CRED_TYPE AS U_CARD_TYPE, U.PUBLIC_PHOTO AS U_PHOTO_MPS
         FROM STPUSRINF U,STPCUSINF C,ARP_AC_CUST_REL L 
         WHERE U.CUST_ID=#{USRID} AND C.CUST_ID = U.CUST_ID AND U.CUST_ID = L.CUST_ID
     </sql>
     <sql name="queBal">
       select PAY_AC_NO as PAYACNO,AC_STATUS,
              CASH_AC_BAL-FROZ_BALANCE as casfroz,
              CASH_AC_BAL as CASHACBAL,  
              FROZ_BALANCE as FROZBALANCE,  
              TO_CHAR(to_number(CASH_AC_BAL)/100,'9999999999990.00') as CashAcBal1, 
              TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'9999999999990.00') as usrBal,  
              TO_CHAR(to_number(CASH_AC_BAL)/100,'9999999999990.00') as acBal, 
              TO_CHAR(to_number(FROZ_BALANCE)/100,'9999999999990.00') as noUsrBal, 
              TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'9999999999990.00') as getBal,  
              TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'9999999999990.00') as payCBal 
        from ARP_AC_PROFILE 
       where PAY_AC_NO = #{payacno}
     </sql>
     <process>
       <set name="tellerId"         value="000001"/>
       <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
         <set name="RspCod"         value="01001"/>
         <set name="RspMsg"         value="用户登录平台不正确"/>
         <return/>
       </if>
       
       <set name="usrid"   expr="SESSIONS.USRID"/>
        
       <if condition="ISNULL(usrid)">
         <set name="MsgTyp"         value="E"/>
         <set name="RspCod"         value="02000"/>
         <set name="RspMsg"         value="您还没有登录，请先登录！"/>
         <set name="_REQUESTATTR.FORWARDURL"       value="html/login/login.jsp"/>
         <return/>
       </if>
       
       <!-- 查询用户账号 -->
       <do func="ReadRecord"        error="IGNORE">
         <para name="SqlCmd"        sql="QryUsrInfPay"/>
       </do>
       <if condition="#RetCod==-1">
         <set name="MsgTyp"         value="E"/>
         <set name="RspCod"         value="09999"/>
         <set name="RspMsg"         value="系统忙，请稍后再试！"/>
         <return/>
       </if>
       <set name="CUST_STATUS"      expr="CUST_STATUS"/>
       
       <do func="ReadRecord"        error="IGNORE">
         <para name="SqlCmd"        sql="queBal"/>
       </do>
       <if condition="#RetCod==-1">
         <set name="MsgTyp"         value="E"/>
         <set name="RspCod"         value="09999"/>
         <set name="RspMsg"         value="系统忙，请稍后再试！"/>
         <return/>
       </if>
       <set name="AC_STATUS"        expr="AC_STATUS"/>
       <if condition="ISNULL(FROZBALANCE)">
         <set name="FROZBALANCE"    value="0.00"/>
       </if>
       <set name="FROZBALANCE"      expr="FROZBALANCE"/>
       <set name="CASH"             expr="AMTFMT(SUB(CASHACBAL,FROZBALANCE))"/>
       <set name="CASHACBAL"        expr="AMTFMT(CASHACBAL)"/>
       <set name="FROZBALANCE"      expr="AMTFMT(FROZBALANCE)"/>
   
       <set name="MsgTyp"           value="N"/>
       <set name="RspCod"           value="00000"/>
       <set name="RspMsg"           value="交易成功"/>
     </process>
   </transaction> 
   
   <transaction code="userbalance" desc="用户余额查询">
        <sql name="QryUsrInfPay"> <!-- 查询用户认证信息 -->
            SELECT U.CUST_LOGIN AS LOGNAM,C.CUST_NAME AS userNam,c.CUST_STATUS,
            C.CUST_ID AS custno, L.PAY_AC_NO AS payacno, C.CUST_CRED_NO AS
            U_CARD_NO,
            C.CUST_CRED_TYPE AS U_CARD_TYPE, U.PUBLIC_PHOTO AS
            U_PHOTO_MPS, U.USR_STATUS
            FROM STPUSRINF U,STPCUSINF C,ARP_AC_CUST_REL
            L
            WHERE U.CUST_ID=#{USRID} AND C.CUST_ID = U.CUST_ID AND U.CUST_ID =
            L.CUST_ID
        </sql>
        <sql name="queBal">
            select PAY_AC_NO as PAYACNO,AC_STATUS,
            CASH_AC_BAL-FROZ_BALANCE as casfroz,
            CASH_AC_BAL as CASHACBAL,
            FROZ_BALANCE as FROZBALANCE,
            TO_CHAR(to_number(CASH_AC_BAL)/100,'9999999999990.00') as CashAcBal1,
            TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'9999999999990.00')
            as usrBal,
            TO_CHAR(to_number(CASH_AC_BAL)/100,'9999999999990.00') as
            acBal,
            TO_CHAR(to_number(FROZ_BALANCE)/100,'9999999999990.00') as
            noUsrBal,
            TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'9999999999990.00')
            as getBal,
            TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'9999999999990.00')
            as payCBal
            from ARP_AC_PROFILE
            where PAY_AC_NO = #{payacno}
        </sql>
        <sql name="QryStpBankCd"> <!-- 查询用户绑定的银行卡 -->
            SELECT b.BAK_SEQ,b.CUST_ID,substr(b.card_bank,1,4) card_bank,b.card_type,b.CARD_NO,b.CARD_NO as CARDNO,
                   substr(b.CARD_NO,(length(b.CARD_NO)-3),4) as CANO,CARD_TYPE banknotype,bank_nam BANK_NO,bank_conf
            FROM STPBANKTB b
            WHERE b.CUST_ID = #{usrid} and (CARD_TYPE='00' or CARD_TYPE='01') and bank_conf='1'
        </sql>  
        <sql name="QryCardNum"> <!--  查询绑定的银行卡数量 -->
           SELECT count(*) as CARDNUM from STPBANKTB WHERE CUST_ID = #{usrid} and (CARD_TYPE='00' or CARD_TYPE='01') and bank_conf='1'
        </sql>
        <process>
            <set name="tellerId" value="000001" />
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>

            <set name="usrid" expr="SESSIONS.USRID" />

            <if condition="ISNULL(usrid)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02000" />
                <set name="RspMsg" value="您还没有登录，请先登录！" />
                <set name="_REQUESTATTR.FORWARDURL" value="index.jsp" />
                <return />
            </if>

            <!-- 查询用户余额 -->
            <quote name="selUserBalance" />
            
            <!--查询已绑定的银行卡数量-->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryCardNum" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod" value="02100" />
                <set name="RspMsg" value="数据操作失败!" />
                <return />
            </if>
             
            <!-- 查询用户绑定的银行卡 列表 -->
            <do func="QueryInGroup" error="IGNORE">
               <para name="SqlCmd"     sql="QryStpBankCd"/>   
               <para name="RecordName" value="GRP" />       
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp" value="N" />
                <set name="RspCod" value="00000" />
                <set name="RspMsg" value="用户绑定信息不存在" />
                <set name="nums" value="0" />
                <set name="RECNUM" value="0" />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误,请稍后再试或联系客服" />
                <return />
            </elseif>

            <foreach name="GRP" iterator="#grp">
                <set name="sDeData" expr="#grp.CARD_NO" />
                <if condition="INTCMP(STRLEN(sDeData),1,32)">
                    <set name="First" expr="SUBSTR(sDeData,1,3)" />
                    <set name="End"
                        expr="SUBSTR(sDeData,SUB(STRLEN(sDeData),3),STRLEN(sDeData))" />
                    <set name="bankdata" expr="STRCAT(First,'****',End)" />
                    <set name="descryptdata" expr="End" />
                </if>
                <else>
                    <set name="sDeData" expr="DES_DECRYPT(sDeData)" />
                    <set name="First" expr="SUBSTR(sDeData,1,3)" />
                    <set name="End"
                        expr="SUBSTR(sDeData,SUB(STRLEN(sDeData),3),STRLEN(sDeData))" />
                    <set name="bankdata" expr="STRCAT(First,'****',End)" />
                    <set name="descryptdata" expr="End" />
                </else>
                <do func="loopSetEach">
                    <para name="ele" expr="#grp.CANO" />
                    <para name="value" expr="descryptdata" />
                </do>
                <do func="loopSetEach">
                    <para name="ele" expr="#grp.CARDNO" />
                    <para name="value" expr="bankdata" />
                </do>
                <if condition="#RetCod!=0">
                    <set name="RspCod" value="09998" />
                    <set name="RspMsg" value="系统错误" />
                    <set name="DWZ_STATUS_CODE" value="300" />
                    <set name="DWZ_RSP_MSG" expr="RspMsg" />
                    <return />
                </if>
            </foreach>

            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
            <set name="_REQUESTATTR.FORWARDURL"
                expr="STRCAT('/html/', SESSIONS.LANGUAGE, '/account/accountinfo.jsp')" />
        </process>
    </transaction>
  
   <transaction code="561301" desc="查询所有待审核身份认证的用户">
     <sql name="QryUsrAutInfo"> <!--  查询用户认证信息  -->
         SELECT CUST_ID,U_NAME,U_CARD_TYPE,U_CARD_NO,
                To_Char(to_date(u_auth_time,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as U_AUTH_TIME,U_CARD_INDATE,U_AUTH_STATUS
           FROM STPUSRAUT 
          WHERE U_AUTH_STATUS in ('1','3')
     </sql>
     <process>
       <!-- 用户登录平台判断：操作员-0009 -->
       <if condition="IS_NOEQUAL_STRING(SysCod,'0009')">
         <set name="RspCod"         value="01001"/>
         <set name="RspMsg"         value="用户登录平台不正确"/>
         <return/>
       </if>
       
       <!-- 查询需要审核的用户 -->
       <!--PageNum-页码；NumPerPag-每页显示的条数 (默认 20)；recordNum-查询出来的记录名(默认为GRP)；sql-SQL语句-->
       <if condition="AND(IsExistNode(PageNum),NOT(ISNULL(PageNum)))">
         <set name="PageNum"        expr="PageNum"/>
       </if> 
       <else>
         <set name="PageNum"        value="1"/>
       </else>
       <if condition="AND(IsExistNode(NumPerPag),NOT(ISNULL(NumPerPag)))">
         <set name="NumPerPag"     expr="NumPerPag"/>
       </if> 
       <else>
         <set name="NumPerPag"     value="19"/>
       </else>
       <do func="PagedQuery"        error="IGNORE">
         <para name="PageNum"       expr="PageNum"/>
         <para name="NumPerPag"     expr="NumPerPag"/>
         <para name="Sql"           sql="QryUsrAutInfo"/>
       </do>
       <if condition="#RetCod==-1">
         <set name="MsgTyp"         value="E"/>
         <set name="RspCod"         value="09999"/>
         <set name="RspMsg"         value="系统忙，请稍后再试！"/>
         <return/>
       </if>
       
       <set name="_REQUESTATTR.FORWARDURL"    value="/html/user/allidentityshow.jsp"/>
       <!--  转到用户终端信息展示页面    -->
       <if condition="#RetCod==2">
         <set name="MsgTyp"         value="E"/>
         <set name="FLAG"           value="E"/>
         <set name="RspCod"         value="02400"/>
         <set name="RspMsg"         value="没有待身份认证的用户！"/>
          <set name="TOLCNT"   value="0"/>
          <set name="ALLPAGENUM"   value="0"/>
          <set name="RECNUM"   value="0"/>
          <set name="PAGENUM"   value="0"/>      
         <return/>
       </if>
       <set name="FLAG"             value="N"/>
       <set name="MsgTyp"           value="N"/>
       <set name="RspCod"           value="00000"/>
       <set name="RspMsg"           value="交易成功"/>
     </process>
   </transaction>

   <transaction code="561302" desc="查询单个用户认证信息">
     <sql name="QryUsrAut"> <!--  查询用户认证信息  -->
         SELECT *
         FROM STPUSRAUT 
         WHERE CUST_ID=#{USRID}
     </sql>
     <process>
       <!-- 用户登录平台判断：操作员-0009 -->
       <if condition="IS_NOEQUAL_STRING(SysCod,'0009')">
         <set name="RspCod"         value="01001"/>
         <set name="RspMsg"         value="用户登录平台不正确"/>
         <return/>
       </if>
       
       <!-- 查询需要审核的用户 -->
       <do func="ReadRecord"        error="IGNORE">
         <para name="SqlCmd"        sql="QryUsrAut"/>
       </do>
       <if condition="#RetCod==-1">
         <set name="MsgTyp"         value="E"/>
         <set name="RspCod"         value="09999"/>
         <set name="RspMsg"         value="系统忙，请稍后再试！"/>
         <return/>
       </if>
       
       <set name="_REQUESTATTR.FORWARDURL"    value="/html/user/identityoneshow.jsp"/>
       <!--  转到用户终端信息展示页面    -->
       <if condition="#RetCod==2">
         <set name="RspMsg"         value="无用户认证信息"/>     
       </if>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"         value="E"/>
         <set name="RspCod"         value="09999"/>
         <set name="RspMsg"         value="系统错误，请稍后再试或类型客服"/>     
         <set name="_REQUESTATTR.FORWARDURL"    value="/html/error.jsp"/>     
         <return/>
       </elseif>
       <set name="U_AUTH_TIME"      expr="FMTDATE(U_AUTH_TIME,0,4)"/>
       <set name="U_CARD_INDATE"    expr="FMTDATE(U_CARD_INDATE,0,4)"/>
       
       <set name="MsgTyp"           value="N"/>
       <set name="RspCod"           value="00000"/>
       <set name="RspMsg"           expr="RspMsg"/>
     </process>
   </transaction>
  
   <transaction code="561303" desc="确认审核结果">
     <sql name="UpdUsrAut"> <!--  更新用户认证信息  -->
       CUST_ID=#{USRID}
     </sql>
     <sql name="QryUsrInf">
       SELECT * FROM STPUSRINF WHERE CUST_ID=#{USRID}
     </sql>
     <process>
       <!-- 用户登录平台判断：操作员-0009 -->
       <if condition="IS_NOEQUAL_STRING(SysCod,'0009')">
         <set name="RspCod"         value="01001"/>
         <set name="RspMsg"         value="用户登录平台不正确"/>
         <return/>
       </if>
       
       <!--  0：未认证；1：认证审核中；2：认证已通过；3：认证未通过 -->
       <if condition="IS_EQUAL_STRING(autResult,'0')">
         <set name="U_AUTH_STATUS"  value="2"/>
         <set name="realFlg"        value="Y"/>
       </if>
       <elseif condition="IS_EQUAL_STRING(autResult,'1')">
         <set name="U_AUTH_STATUS"     value="3"/>
         <set name="U_AUTH_FAIL_COUNT" expr="ADD(FailCount,1)"/>
         <set name="realFlg"           value="N"/>
       </elseif>
       
       <!-- 更新用户认证信息 -->
       <do func="UpdateRecord"      error="IGNORE">
         <para name="TblNam"        value="stpusraut"/>
         <para name="CndSts"        sql="UpdUsrAut"/>
       </do>
       <if condition="#RetCod==-1">
         <set name="MsgTyp"         value="E"/>
         <set name="RspCod"         value="09999"/>
         <set name="RspMsg"         value="系统忙，请稍后再试！"/>
         <return/>
       </if>
       <elseif condition="#RetCod==2">
         <set name="MsgTyp"         value="E"/>
         <set name="RspCod"         value="02009"/>
         <set name="RspMsg"         value="更新状态失败！"/>
         <return/>
       </elseif>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"         value="E"/>
         <set name="RspCod"         value="09997"/>
         <set name="RspMsg"         value="系统错误，请稍后再试或联系客服"/>
         <return/>
       </elseif>
       
       <!--  查询该用户的信息   -->
       <do func="ReadRecord"        error="IGNORE">
         <para name="SqlCmd"        sql="QryUsrInf"/>
       </do>
       <if condition="#RetCod==-1">
         <set name="MsgTyp"         value="E"/>
         <set name="RspCod"         value="09999"/>
         <set name="RspMsg"         value="系统错误"/>
         <return/>
       </if>
       <elseif condition="#RetCod==2">
         <set name="MsgTyp"         value="E"/>
         <set name="RspCod"         value="02800"/>
         <set name="RspMsg"         value="该用户不存在！"/>
         <return/>
       </elseif>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"         value="E"/>
         <set name="RspCod"         value="09998"/>
         <set name="RspMsg"         value="系统错误，请稍后再试或联系客服"/>
         <return/>
       </elseif>
       
       <set name="MsgTyp"           value="N"/>
       <set name="RspCod"           value="00000"/>
       <set name="RspMsg"           value="交易成功"/>
     </process>
   </transaction>
   
   <transaction code="561106" desc="重置登录密码">
      <sql name="UpdCuInfoInf"> <!--  重置登录密码  -->
           UPDATE STPUSRINF SET CUST_PWD=#{NUPW},PASSWORD_STRENGTH=#{PWDSTRE},LAST_UPPWD_TIME =#{NOWDATE}  WHERE CUST_ID=#{UsrId}
      </sql>
      <sql name="QryUsrIdInf"> <!--  查询用户注册信息  -->
           SELECT a.CUST_ID as usrid , r.password
           FROM STPUSRINF a,arp_ac_cust_rel r
           WHERE a.CUST_LOGIN=#{USRMP} and a.cust_id = r.cust_id 
      </sql>
      <process>
         <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台不正确"/>
            <return/>
         </if>
         
         <!--记录用户系统主要交易实时日志 -->
         <set name="RCS_USER_CODE"  expr="USRID" />   <!--用户ID -->
         <set name="RCS_PAY_TYPE"   value="800006" /> <!--本次交易码 用户重置登录密码 -->
         <set name="RCS_PRD_NO"     value="" />       <!--订单号，如果不涉及置空 -->
         <set name="NOWDATE"      expr="GETDATE()" />
         
         <!--  查询用户注册信息  -->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd"  sql="QryUsrIdInf" />
         </do>
         <if condition="#RetCod==2">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="02008"/>
            <set name="RspMsg"    value="用户信息不存在"/>
            <return/>
         </if>
         <elseif condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09998"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </elseif>
         
         <!-- 检查新密码是否为空 -->
         <if condition="IS_EQUAL_STRING(NUSRPWD,'')">
            <set name="RspCod"         value="02060"/>
            <set name="RspMsg"         value="用户新密码为空"/>
           <return/>
         </if>
         
         <!-- 检查确认新密码是否为空 -->
         <if condition="IS_EQUAL_STRING(FIRMPWD,'')">
            <set name="RspCod"         value="02061"/>
            <set name="RspMsg"         value="用户确认新密码为空"/>
           <return/>
         </if>
         
         <set name="pw"  expr="NUSRPWD"/>
         <quote name="getInputPwd"/>  
         <set name="NUPW"        expr="NewPwd"/>    
         <set name="AAAAAA"      value="新密码转加密成功"/>
             
         
         <set name="pw"  expr="FIRMPWD"/>
         <quote name="getInputPwd"/>  
         <set name="FUPW"         expr="NewPwd"/>     
         <set name="AAAAAA"      value="确认密码转加密成功"/>
         
         <!-- 新密码二次验证 -->
         <if condition="IS_NOEQUAL_STRING(NUSRPWD,FIRMPWD)">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="02017"/>
            <set name="RspMsg"    value="二次密码输入错误"/>
            
            <return/>
         </if>
         
         <!-- 重置登录密码 -->
         <do func="ExecSql" error="IGNORE">        
            <para name="SqlCmd" sql="UpdCuInfoInf"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="02010"/>
            <set name="RspMsg"    value="重置登录密码错误"/>
            
            <return/>
         </if>
         
         <set name="MsgTyp"    value="N"/>
         <set name="RspCod"    value="00000"/>
         <set name="RspMsg"    value="交易成功"/>
         
        
      </process>
   </transaction>
   
   <transaction code="561132" desc="找回支付密码">
      <sql name="QryUsrIdInf"> <!--  查询用户注册信息  -->
           SELECT u.cust_pwd as dlmm, r.PAY_AC_NO FROM STPUSRINF u,arp_ac_cust_rel r WHERE u.CUST_ID=#{UsrId} and u.CUST_ID=r.CUST_ID
      </sql>
      <sql name="UpdPayStre"> <!--  更新用户支付密码强度 -->
         UPDATE STPUSRINF   SET PAYPWD_STRENGTH=#{PAYSTRE} WHERE CUST_ID=#{UsrId}
      </sql>
      <sql name="UpdPayPwd"> <!--  更新用户支付密码 -->
         UPDATE arp_ac_cust_rel  SET password=#{NPayPwd} WHERE CUST_ID=#{UsrId}
      </sql>
      <process>
        
         <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台不正确"/>
            <return/>
         </if>
         
         <set name="UsrId"          expr="SESSIONS.USRID"/>
        
         
         <if condition="IS_EQUAL_STRING(UsrId,'')">
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户未登录或登录失效"/>
            <return/>
         </if>
         
         <!-- 转密新支付密码 -->
         <set name="pw"  expr="newPayPwdForFind"/>
         <quote name="getInputPwd"/>  
         <set name="NPayPwd"         expr="NewPwd"/>      
         <set name="AAAAAA"      value="新密码转加密成功"/>
         
         <!-- 转密新支付密码确认 -->
         <set name="pw"  expr="reNewPayPwdForFind"/>
         <quote name="getInputPwd"/>  
         <set name="firmpwd"         expr="NewPwd"/>      
         <set name="AAAAAA"      value="确认密码转加密成功"/>
         
         <!-- 新密码二次验证 -->
         <if condition="IS_NOEQUAL_STRING(NPayPwd,firmpwd)">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="02017"/>
            <set name="RspMsg"    value="二次密码输入错误"/>
            
            <return/>
         </if>
         
         <!-- 检测用户是否存在 -->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd"  sql="QryUsrIdInf" />
         </do>
         <if condition="#RetCod==-1">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09997"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if>
         <if condition="#RetCod==2">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="02008"/>
            <set name="RspMsg"    value="用户信息不存在"/>
          
            <return/>
         </if>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09998"/>
            <set name="RspMsg"    value="对不起，重置支付密码失败"/>
           
            <return/>
         </if>
         <!-- 检测与登录密码是否相同 -->
         <if condition="IS_EQUAL_STRING(NPayPwd,dlmm)">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="02018"/>
            <set name="RspMsg"    value="支付密码不能与登录密码相同"/>
           
            <return/>
         </if>
         
        <!--  修改支付密码  -->
        <do func="ExecSql" error="IGNORE">
          <para name="SqlCmd" sql="UpdPayPwd" />
        </do>
        <if condition="#RetCod==2">
          <set name="RspMsg"       value="无可修改记录"/>
        </if>
        <elseif condition="#RetCod!=0"> 
          <set name="MsgTyp"       value="E"/>
          <set name="RspCod"       value="09999"/>
          <set name="RspMsg"       value="系统错误"/>
          <return/>
        </elseif>
         
        <!-- 修改支付密码强度 -->
        <do func="ExecSql" error="IGNORE">
          <para name="SqlCmd" sql="UpdPayStre" />
        </do>
        <if condition="#RetCod==2">
          <set name="RspMsg"       value="无可修改记录"/>
        </if>
        <elseif condition="#RetCod!=0"> 
          <set name="MsgTyp"       value="E"/>
          <set name="RspCod"       value="09999"/>
          <set name="RspMsg"       value="系统错误"/>
          <return/>
        </elseif>
        
         <set name="MsgTyp"    value="N"/>
         <set name="RspCod"    value="00000"/>
         <set name="RspMsg"    value="交易成功"/>
         
       
      </process>
   </transaction>
   
   <transaction  code="561265" desc="省市区查询">
      <sql name="QryProvince">       <!--  查询所有的省份信息  -->
           SELECT * FROM  ${DES} 
      </sql>
      <process>
        <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台不正确"/>
            <return/>
        </if>
        
        <if  condition="IS_EQUAL_STRING(FLAG,'1')">
           <set name="DES"       value="stpprovin"/> 
        </if>
        <if  condition="IS_EQUAL_STRING(FLAG,'2')">
           <set name="STR"       value="stpcitytb where fatherid="/>
           <set name="DES"       expr="STRCAT(STR,PROID)"/>
        </if>
        <if  condition="IS_EQUAL_STRING(FLAG,'3')">
           <set name="STR"       value="stpareatb  where fatherid="/>
           <set name="DES"       expr="STRCAT(STR,CITYID)"/>
        </if>
        <do func="QueryInGroup" error="IGNORE">
          <para name="SqlCmd"  sql="QryProvince"/>          
        </do>
        <if condition="#RetCod==2">
            <set name="RecordNum"    value="2"/>
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="02008"/>
            <set name="RspMsg"    value="信息不存在"/>
            <return/>
        </if>
        <elseif condition="#RetCod!=0">
            <set name="RecordNum"    value="0"/>
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09998"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
        </elseif>
        <set name="MsgTyp"       value="N"/>
        <set name="RspCod"       value="00000"/>
        <set name="RspMsg"       value="交易成功"/>
      </process>
   </transaction>

   <transaction code="561304" desc="查询转账订单信息" >
      <sql name="QryTraInf"> <!--查询转账订单信息 -->
         SELECT substr(stpusrinf.CUST_LOGIN,1,3) || '****' || substr(stpusrinf.CUST_LOGIN,(length(stpusrinf.CUST_LOGIN)-3),5) AS CUST_LOGIN,
                substr(StpTraInf.TGETACCNO,1,3) || '****' || substr(StpTraInf.TGETACCNO,(length(StpTraInf.TGETACCNO)-3),5) AS TGetAccNo1,
                nvl(stptrainf.TGetAccNam,' ') AS TGetAccNam1, 
                To_Char(to_date(traTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as traTime,  
                TO_CHAR(to_number(txamt)/100,'FM9999,999,999,990.00') txamt1,nvl(traordno,' ') AS traordno, 
                TO_CHAR(to_number(nvl(fee,'0'))/100,'FM9999,999,999,990.00') fee1,tratype,
                TO_CHAR(to_number(totamt)/100,'FM9999,999,999,990.00')  totamt,stptrainf.CUST_ID,nvl(Filed1,' ') as remark
           FROM stptrainf,stpusrinf
          WHERE stptrainf.CUST_ID=stpusrinf.CUST_ID and BatNo=#{BatNo} and traordno like #{Traordno}
      </sql>
      <sql name="CountTraFee"> <!--计算总手续费 -->
        SELECT TO_CHAR(to_number(nvl(sum(fee),'0'))/100,'FM9999,999,999,990.00')  as TOTFEE
          FROM StpTraInf
         WHERE batNo=#{BatNo} and traordno like #{Traordno}
      </sql>
      <process>
         <!--检查用户登录平台是否正确-->
         <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台不正确"/>
            <return/>
         </if>
         
         <if condition="IS_NOEQUAL_STRING(flag,'0')"><!-- 查询单条还是批量 -->
           <set name="Traordno"  value="%%"/>
         </if>

         <!--查询转账记录-->
         <do func="PagedQuery"       error="ignore">
           <para name="PageNum"      expr="PageNum"/>
           <para name="NumPerPag"    expr="NumPerPag"/>
           <para name="Sql"          sql="QryTraInf"/>
         </do>
         <if condition="#RetCod==2">
           <set name="RspMsg"        value="无记录"/>
           <set name="TOLCNT"   value="0"/>
           <set name="ALLPAGENUM"   value="0"/>
           <set name="RECNUM"   value="0"/>
           <set name="PAGENUM"   value="0"/>      
         </if>
         <elseif condition="#RetCod!=0">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="09999"/>
           <set name="RspMsg"    value="系统错误，请稍后再试"/>
           <return/>
         </elseif>
         <!--查询转账订单手续费-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="CountTraFee" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="07001"/>
            <set name="RspMsg"    value="查询转账手续费错误"/>
            <return/>
         </if>
         <set name="MsgTyp"    value="N"/>
         <set name="RspCod"    value="00000"/>
         <set name="RspMsg"    value="交易成功"/>
      </process>
   </transaction>
   
   <transaction code="561525" desc="银行卡列表条件查询">
     <sql name="QryUsrInf"> <!--  查询用户注册信息  -->
       SELECT PAY_AC_NO AS PAYACNO FROM ARP_AC_CUST_REL WHERE CUST_ID IN (SELECT CUST_ID FROM STPUSRINF WHERE CUST_ID=#{USRID})
     </sql>
     <sql name="QryStpBankCd"> <!--  查询用户绑定的银行卡  -->
       SELECT b.BAK_SEQ,b.CUST_ID,b.CARD_BANK,  b.CARD_NO,  substr(b.CARD_NO,(length(b.CARD_NO)-3),4) as CANO,
              To_Char(to_date(b.bak_open_date,'yyyymmdd'),'yyyy-mm-dd') as CARD_DATE,
              To_Char(to_date(b.bak_open_time,'hh24miss'),'hh24:mi:ss') as CARD_TIME,
              b.CARD_STATUS,m.Enm_Dat_Des as banknotype
         FROM STPBANKTB b, lyxdicenm m
        WHERE b.CUST_ID=#{USRID} and trim(m.enm_en_nam) like 'bankCardType' and b.card_type=trim(m.Enm_Dat_Opt) 
              and b.CARD_BANK=#{bandcode} and b.card_type=#{cardtype} ORDER BY CANO 
     </sql>
     <process>
       
       <!-- 检查用户登录平台是否正确    0001：用户 ；0009：操作员 -->
       <if condition="AND(IS_NOEQUAL_STRING(SysCod,'0009'),IS_NOEQUAL_STRING(SysCod,'0001'))">
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>
       <set name="USRID"           expr="SESSIONS.USRID"/>
       <!-- 检查手机号是否为空 -->
       <set name="UsrMp1"          expr="DELBOTHSPACE(USRID)"/>
       <if condition="IS_EQUAL_STRING(UsrMp1,'')">
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="手机号为空"/>
         <set name="_REQUESTATTR.FORWARDURL"       value="html/login/login.jsp"/>
         <return/>
       </if>
     
       <!-- 检查用户是否存在 -->
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd"   sql="QryUsrInf" />
       </do>
       <if condition="#RetCod!=0">
         <set name="RspCod"        value="02008"/>
         <set name="RspMsg"        value="用户信息不存在"/>
         <return/>
       </if>
     
       <!--查询用户组信息-->
       <do func="QueryInGroup" error="IGNORE">
         <para name="SqlCmd"     sql="QryStpBankCd"/>
         <para name="RecordName" value="GRP"/>
         <para name="RecNum"     value="UsNum"/>
       </do>
       <if condition="#RetCod==-1">
         <set name="RspCod"    value="09999"/>
         <set name="RspMsg"    value="系统错误"/>
         <return/>
       </if>
       <if condition="#RetCod==-2">
         <set name="RspCod"    value="00000"/>
         <set name="RspMsg"    value="请先绑定银行卡"/>
         <return/>
       </if>
       
       <foreach name="GRP" iterator="#grp">
         <set name="sDeData"         expr="#grp.CARD_NO"   />
         <set name="sDeData"         expr="DES_DECRYPT(sDeData)"   />
         <set name="First"           expr="SUBSTR(sDeData,1,3)"/> 
         <set name="End"             expr="SUBSTR(sDeData,SUB(STRLEN(sDeData),3),STRLEN(sDeData))"/>
         <set name="descryptdata"    expr="STRCAT(First,'****',End)"/>
         <set name="descryptdata"    expr="End"/>
         <do func="loopSetEach">
           <para name="ele" expr="#grp.CANO"/> 
           <para name="value" expr="descryptdata"/>
         </do>
         <if condition="#RetCod!=0">
           <set name="RspCod"            value="09998"/>
           <set name="RspMsg"            value="系统错误"/>
           <set name="DWZ_STATUS_CODE"   value="300"/>
           <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
           <return/>
         </if>
       </foreach>
       
       <set name="MsgTyp"          value="N"/>
       <set name="RspCod"          value="00000"/>
       <set name="RspMsg"          value="交易成功"/>
     </process>
   </transaction>

   <transaction code="561526" desc="用户绑定相关银行查询">
     <sql name="QryUsrInf"> <!--  查询用户注册信息  -->
       SELECT PAY_AC_NO AS PAYACNO FROM ARP_AC_CUST_REL WHERE CUST_ID IN (SELECT CUST_ID FROM STPUSRINF WHERE CUST_ID=#{USRID})
     </sql>
     <sql name="QryStpBankCd"> <!--  查询用户绑定的银行卡  -->
       select  bank_no as bno, enm_dat_des  as chnam
         from (select card_bank as bank_no from stpbanktb where card_type='01' and CUST_ID=#{USRID} group by card_bank) ,
              (select enm_dat_opt,enm_dat_des from lyxdicenm where sys_id=#{SysCod} and trim(enm_en_nam) like 'bankNam')  
        where  bank_no=trim(enm_dat_opt) 
     </sql>
     <process>
       
       <!-- 检查用户登录平台是否正确    0001：用户 ；0009：操作员 -->
       <if condition="AND(IS_NOEQUAL_STRING(SysCod,'0009'),IS_NOEQUAL_STRING(SysCod,'0001'))">
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>
       <set name="USRID"           expr="SESSIONS.USRID"/>
       <!-- 检查手机号是否为空 -->
       <set name="UsrMp1"          expr="DELBOTHSPACE(USRID)"/>
       <if condition="IS_EQUAL_STRING(UsrMp1,'')">
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="手机号为空"/>
         <set name="_REQUESTATTR.FORWARDURL"       value="html/login/login.jsp"/>
         <return/>
       </if>
   
       <!-- 检查用户是否存在 -->
       <do func="ReadRecord" error="IGNORE">
         <para name="SqlCmd"   sql="QryUsrInf" />
       </do>
       <if condition="#RetCod!=0">
         <set name="RspCod"        value="02008"/>
         <set name="RspMsg"        value="用户信息不存在"/>
         <return/>
       </if>
   
       <!--查询用户组信息-->
       <do func="QueryInGroup" error="IGNORE">
         <para name="SqlCmd"     sql="QryStpBankCd"/>
         <para name="RecordName" value="BANKNAM"/>
         <para name="RecNum"     value="BankNum"/>
       </do>
       <if condition="#RetCod==-1">
         <set name="RspCod"    value="09999"/>
         <set name="RspMsg"    value="系统错误"/>
         <return/>
       </if>
       <elseif condition="#RetCod==2">
       </elseif>
       <elseif condition="#RetCod!=0">
         <set name="MsgTyp"          value="E"/>
         <set name="RspCod"    value="09999"/>
         <set name="RspMsg"    value="系统错误"/>
         <return/>
       </elseif>
       
       <set name="MsgTyp"          value="N"/>
       <set name="RspCod"          value="00000"/>
       <set name="RspMsg"          value="交易成功"/>
     </process>
   </transaction>

  <transaction code="561146" desc="用户证件列表查询"> 
     <sql name="QryUsrAut"> <!--  查询用户证件类型  -->
       select CUST_CRED_TYPE as cardtyp,CUST_CRED_NO as cardno 
         from stpcusinf 
        where CUST_ID=#{CUST_ID}
     </sql>
     <process>
        <set name="CUST_ID"  expr="SESSIONS.USRID"/>
        <if condition="ISNULL(SESSIONS.USRID)">
            <set name="MsgTyp" value="E" />
            <set name="RspCod" value="01002" />
            <set name="RspMsg" value="您还没有登录，请先登录！" />
            <set name="_REQUESTATTR.FORWARDURL" value="index.jsp" />
            <return />
        </if>
        <if condition="NOT(ISNULL(CUST_ID))">
           <!-- 查询用户注册信息 -->
           <do func="ReadRecord" error="IGNORE">
             <para name="SqlCmd"   sql="QryUsrAut" />
           </do>
           <if condition="#RetCod==2">
             <set  name="cardtyp"  value="0"/>
             <return/>
           </if>
           <elseif condition="#RetCod!=0">
             <set name="MsgTyp"        value="E"/>
             <set name="RspCod"        value="02008"/>
             <set name="RspMsg"        value="数据库错误"/>
             <return/> 
           </elseif>
        </if> 
        
        <set name="cardno"           expr="DES_DECRYPT(cardno)"/>
        <set name="MsgTyp"           value="N" />
        <set name="RspCod"           value="00000" />
        <set name="RspMsg"           value="交易成功" />
        <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('/html/', SESSIONS.LANGUAGE, '/identify/useridentify.jsp')" />
        <rerurn/>
     </process>
  </transaction>
  
  <transaction code="561147" desc="国籍查询">
     <sql name="QryDicEnm"> <!--  国籍查询  -->
       select enm_dat_opt as natno, enm_dat_des as natnam 
         from lyxdicenm 
        where trim(sys_id)=#{SYSCOD}  and trim(enm_en_nam) like 'NATIONALITY'
        order by natno
     </sql>
     <process>
        <do func="QueryInGroup" error="IGNORE">
          <para name="SqlCmd"  sql="QryDicEnm"/>          
        </do>
        <if condition="#RetCod==2">
          <set name="MsgTyp"    value="E"/>
          <set name="RspCod"    value="02008"/>
          <set name="RspMsg"    value="信息不存在"/>
          <return/>
        </if>
        <elseif condition="#RetCod!=0">
          <set name="MsgTyp"    value="E"/>
          <set name="RspCod"    value="09998"/>
          <set name="RspMsg"    value="系统错误"/>
          <return/>
        </elseif>
     </process>
  </transaction>
  
  <transaction code="checkAcc" desc="账号检测-原561527">
        <sql name="QryUsrPayno"> <!-- 账号检测 -->
            select u.CUST_ID,c.CUST_NAME as USER_NAME,c.CUST_STATUS
            from stpusrinf
            u,stpcusinf c where u.CUST_LOGIN=#{phone} and
            u.cust_id=c.cust_id
        </sql>
        <sql name="SelAccInf"><!-- 查询客户账户信息 -->
            SELECT a.AC_STATUS FROM ARP_AC_PROFILE a,ARP_AC_CUST_REL b WHERE
            b.CUST_ID=#{CUST_ID} AND a.PAY_AC_NO=b.PAY_AC_NO
        </sql>
        <process>
            <set name="loginNam" expr="SESSIONS.USRMP" />

            <if condition="IS_EQUAL_STRING(loginNam,phone)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02009" />
                <set name="RspMsg" value="收付款账户名不能相同" />
                <return />
            </if>

            <!-- 账号检测 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrPayno" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02009" />
                <set name="RspMsg" value="不存在该支付账户" />
                <return />
            </if>
            <elseif condition="#RetCod==-1">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09998" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>

            <if condition="IS_EQUAL_STRING(flag,'0')"> <!-- 用于注册时的账户检测 -->
                <return />
            </if>

            <!--检测客户状态 账户状态 start -->
            <if
                condition="AND(IS_NOEQUAL_STRING(CUST_STATUS,'0'),IS_NOEQUAL_STRING(CUST_STATUS,'1'))">
                <set name="RspCod" value="08040" />
                <set name="RspMsg" value="客户状态不正常" />
                <return />
            </if>

            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="SelAccInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="客户账户信息不存在" />
                <return />
            </if>
            <if condition="IS_NOEQUAL_STRING(AC_STATUS,'0')">
                <set name="RspCod" value="08040" />
                <set name="RspMsg" value="客户账户状态不正常" />
                <return />
            </if>

            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
  </transaction>
   
  <transaction code="561528" desc="充值详细查询">
     <sql name="QryUsrInf">  <!-- 检测用户是否存在 -->
       SELECT u.CUST_LOGIN,l.PAY_AC_NO as PAYACNO FROM STPUSRINF u,ARP_AC_CUST_REL l WHERE u.CUST_ID=#{USRID} AND u.CUST_ID=l.CUST_ID
     </sql>
     <sql name="QryIncaseDetail">       <!--  查询充值订单信息  -->
       select p.prdordno as prdOrdNo,To_Char(to_date(p.ordertime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')  as orderDate ,
              '虚拟账户充值' as transort, u.CUST_LOGIN as userAcNo,  TO_CHAR(to_number(p.ordAmt)/100,'FM9999,999,999,990.00') as ORDAMT,  
              n.enm_dat_des as ordstatus  ,4 as pageflags ,o.enm_dat_des as payType,nvl(b.bankPayAcNo,'') as bankPayAcNo
         from StpPrdInf p,StpPayInf b,
              (select enm_en_nam,enm_dat_opt,enm_dat_des from lyxdicenm where sys_id='0001') n ,
              (select enm_en_nam,enm_dat_opt,enm_dat_des from lyxdicenm where sys_id='0001') o ,
              stpusrinf u
        where p.cust_id = #{USRID} and p.prdordno=b.PrdOrdNo 
              and trim(n.enm_en_nam) like 'prdOrdStatus' and trim(n.enm_dat_opt)=p.OrdStatus
              and trim(o.enm_en_nam) like 'payType' and trim(o.enm_dat_opt)=b.payType
              and p.prdordno=#{PRDORDNO}  and u.cust_id=p.cust_id
     </sql>
     <process>
       <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/trandetail.jsp')"  />
       <!-- 检查用户登录平台是否正确 -->
       <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>
        
       <!-- 检查手机号是否为空 -->
       <set name="USRID"           expr="SESSIONS.USRID"/>
       <if condition="IS_EQUAL_STRING(USRID,'')">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="用户ID为空"/>
         <set name="RspMsg"        value="请重新登录"/>
         <set name="_REQUESTATTR.FORWARDURL"       value="html/login/login.jsp"/>
         <return/>
       </if>
       
       <!-- 判断用户是否存在 -->
       <do func="ReadRecord"       error="IGNORE">
         <para name="SqlCmd"       sql="QryUsrInf" />
       </do>
       <if condition="#RetCod==2">
         <set name="NOTE"          value="E"/>
         <set name="RspCod"        value="02001"/>
         <set name="RspMsg"        value="用户不存在"/>
         <return/>
       </if> 
       <elseif condition="#RetCod!=0">
         <set name="NOTE"          value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </elseif>
       
       <set name="LOGINNAME"                expr="CUST_LOGIN"/>
       <!-- 查询用户提现交易详细 -->
       <do func="ReadRecord"       error="IGNORE">
         <para name="SqlCmd"       sql="QryIncaseDetail" />
       </do>
       <if condition="#RetCod==2">
         <set name="NOTE"          value="E"/>
         <set name="RspCod"        value="02001"/>
         <set name="RspMsg"        value="无此记录"/>
         <return/>
       </if> 
       <elseif condition="#RetCod!=0">
         <set name="NOTE"          value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </elseif>
       
     </process>
  </transaction>
   
  <transaction code="561529" desc="提现详细信息查询">
        <sql name="QryUsrInf">  <!-- 检测用户是否存在 -->
            SELECT cust_id,CUST_LOGIN FROM STPUSRINF WHERE CUST_ID=#{USRID}
        </sql>
        <sql name="QryCasInf">  <!-- 查询用户提现详细信息 -->
            SELECT CASORDNO AS ORDERNO,
                   To_Char(to_date(actDat,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') AS ORDERDATE,'账户余额提现' AS ORDERTYPE, '13300000000' AS ZFTNAME,
                   (select  distinct trim(ISSNAM) from  unionfit where trim(ISSNO)=STPCASINF.Bankcode and ROWNUM='1') AS BANKNAME,'借记卡' AS BANKNOTYPE,
                   case when BANKPAYACNO is null then '' else substr(nvl(DECRYPT_DES(BANKPAYACNO,'0123456789ABCDEF'),''),1,3) || '****' ||
                   substr(nvl(DECRYPT_DES(BANKPAYACNO,'0123456789ABCDEF'),''),(length(nvl(DECRYPT_DES(BANKPAYACNO,'0123456789ABCDEF'),''))-3),4) end
                   BANKNO,ORDSTATUS, TO_CHAR(to_number(txAmt)/100,'FM9999,999,999,990.00') AS ORDERAMT,
                   (case when ORDSTATUS='00' then '等待处理' when ORDSTATUS='01' then '交易成功' when ORDSTATUS='02' then '交易失败'  else '未知' end) as ORDSTATUS_FMT,BANKERROR 
              FROM STPCASINF left join (select cust_login,cust_id as usrno from stpusrinf) on cust_id=usrno 
             WHERE CASORDNO=#{PRDORDNO}
        </sql>
        <process>
            <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/trandetail.jsp')"  />
            <!-- 检查用户登录平台是否正确 -->
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>

            <!-- 检查手机号是否为空 -->
            <set name="USRID" expr="SESSIONS.USRID" />
            <if condition="IS_EQUAL_STRING(USRID,'')">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02035" />
                <set name="RspMsg" value="用户ID为空" />
                <set name="RspMsg" value="请重新登录" />
                <set name="_REQUESTATTR.FORWARDURL" value="html/login/login.jsp" />
                <return />
            </if>

            <!-- 判断用户是否存在 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="NOTE" value="E" />
                <set name="RspCod" value="02001" />
                <set name="RspMsg" value="用户不存在" />
                <return />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="NOTE" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>

            <set name="LOGINNAME" expr="CUST_LOGIN" />
            <!-- 查询用户提现交易详细 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryCasInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="NOTE" value="E" />
                <set name="RspCod" value="02001" />
                <set name="RspMsg" value="无此记录" />
                <return />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="NOTE" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
        </process>
    </transaction>
  
  <transaction code="561530" desc="付款详细信息查询">
        <sql name="QryUsrInf">  <!-- 检测用户是否存在 -->
            SELECT CUST_ID FROM STPUSRINF WHERE CUST_ID=#{USRID}
        </sql>
        <sql name="QryTraToInf">  <!-- 查询用户付款详细信息 -->
            SELECT af.traordno AS ORDERNO,
            To_Char(to_date(af.tratime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as orderDate,
            '虚拟账户付款' AS ORDERTYPE,
            (case when ORDSTATUS='00' then '等待付款' when ORDSTATUS='01' then '交易成功'   else '未知' end) as ORDSTATUS_FMT,
            case when af.GETCUSNAM is  null then '' else
           '*' || substr(nvl(af.GETCUSNAM,''),2,(length(nvl(af.GETCUSNAM,''))-1)) end GETCUSNAM ,
            case when rf.CUST_LOGIN is  null then '' else
            substr(nvl(rf.CUST_LOGIN,''),1,3) || '****' || substr(nvl(rf.CUST_LOGIN,'')
            ,(length(nvl(rf.CUST_LOGIN,''))-3),4) end CUST_LOGIN ,
            TO_CHAR(to_number(TXAMT)/100,'FM9999,999,999,990.00') AS ORDERAMT,
            af.REMARK 
            FROM STPTRAINF af
            left join STPUSRINF rf
            on
            af.GETCUSID = rf.CUST_ID
            WHERE af.TRAORDNO=#{ORDPRDNO}
        </sql>
        <process>
            <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/trandetail.jsp')"  />
            <!-- 检查用户登录平台是否正确 -->
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>

            <!-- 检查手机号是否为空 -->
            <set name="USRID" expr="SESSIONS.USRID" />
            <if condition="IS_EQUAL_STRING(USRID,'')">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02035" />
                <set name="RspMsg" value="用户ID为空" />
                <set name="RspMsg" value="请重新登录" />
                <set name="_REQUESTATTR.FORWARDURL" value="html/login/login.jsp" />
                <return />
            </if>

            <!-- 判断用户是否存在 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="NOTE"   value="E" />
                <set name="RspCod" value="02001" />
                <set name="RspMsg" value="用户不存在" />
                <return />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="NOTE" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误用户不存在" />
                <return />
            </elseif>
            <set name="LOGINNAME" expr="CUST_LOGIN" />
            <!-- 查询用户付款交易详细 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryTraToInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="NOTE" value="E" />
                <set name="RspCod" value="02001" />
                <set name="RspMsg" value="无此记录" />
                <return />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="NOTE" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误没有信息" />
                <return />
            </elseif>
        </process>
    </transaction>
  
  <transaction code="561531" desc="收款详细信息查询">
        <sql name="QryUsrInf">  <!-- 检测用户是否存在 -->
            SELECT CUST_ID FROM STPUSRINF WHERE CUST_ID=#{USRID}
        </sql>
        <sql name="QryTraGetInf">  <!-- 查询用户收款详细信息 -->
            SELECT af.traordno AS ORDERNO,
            To_Char(to_date(af.tratime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as orderDate,
            '虚拟账户付款' AS ORDERTYPE,
            (case when ORDSTATUS='00' then '等待收款' when ORDSTATUS='01' then '交易成功'   else '未知' end) as ORDSTATUS_FMT,
             case when af.TRACUSNAM is  null then '' else
           '*' || substr(nvl(af.TRACUSNAM,''),2,(length(nvl(af.TRACUSNAM,''))-1)) end TRACUSNAM ,
            case when rf.CUST_LOGIN is  null then '' else
            substr(nvl(rf.CUST_LOGIN,''),1,3) || '****' || substr(nvl(rf.CUST_LOGIN,'')
            ,(length(nvl(rf.CUST_LOGIN,''))-3),4) end CUST_LOGIN ,
            TO_CHAR(to_number(TXAMT)/100,'FM9999,999,999,990.00') AS ORDERAMT,
            af.REMARK 
            FROM STPTRAINF af
            left join STPUSRINF rf
            on
            af.TRACUSID = rf.CUST_ID
            WHERE af.TRAORDNO=#{ORDPRDNO}
        </sql>
        <process>
            <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/trandetail.jsp')"  />
            <!-- 检查用户登录平台是否正确 -->
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>

            <!-- 检查手机号是否为空 -->
            <set name="USRID" expr="SESSIONS.USRID" />
            <if condition="IS_EQUAL_STRING(USRID,'')">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02035" />
                <set name="RspMsg" value="用户ID为空" />
                <set name="RspMsg" value="请重新登录" />
                <set name="_REQUESTATTR.FORWARDURL" value="html/login/login.jsp" />
                <return />
            </if>
            <!-- 判断用户是否存在 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="NOTE" value="E" />
                <set name="RspCod" value="02001" />
                <set name="RspMsg" value="用户不存在" />
                <return />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="NOTE" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
             <do func="ReadRecord" error="IGNORE">
                 <para name="SqlCmd" sql="QryTraGetInf" />
             </do>
             <if condition="#RetCod==2">
                 <set name="NOTE" value="E" />
                 <set name="RspCod" value="02001" />
                 <set name="RspMsg" value="无此记录" />
                 <return />
             </if>
             <elseif condition="#RetCod!=0">
                 <set name="NOTE" value="E" />
                 <set name="RspCod" value="09999" />
                 <set name="RspMsg" value="系统错误" />
                 <return />
             </elseif>
            
        </process>
    </transaction>
  
  <transaction code="561532" desc="消费详细信息查询">
     <sql name="QryUsrInf">  <!-- 检测用户是否存在 -->
       SELECT CUST_ID FROM  STPUSRINF WHERE CUST_ID=#{USRID}
     </sql>
     <sql name="QryUsrId">
       SELECT CUST_ID AS UFLAG FROM STPTRAINF  where TRAORDNO=#{ORDPRDNO}
     </sql>
     <sql name="QryPrdInf">  <!-- 查询用户消费详细信息-->
       SELECT a.prdordno AS PRDORDNO,a.payordno,a.PRDNAME,
              '消费' AS ORDERTYPE,TO_CHAR(TO_NUMBER(nvl( a.rfTotalAmt,0)) / 100, 'FM9999,999,999,990.00') AS  rfamt,
              TO_CHAR(to_number(a.ORDAMT)/100,'FM9999,999,999,990.00')  AS ORDERAMT, 
              (case when nvl(RFTOTALAMT,0)>0 then '1' else '0' end) as RET_STATUS,
              To_Char(to_date(a.orderTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') AS orderDate, 
              case a.ORDSTATUS when '00' then '未支付' when '01' then '交易成功' when '11' then '订单作废 ' when '12' then '支付成功'  end  as ORDSTATUS,
              case a.prdordtype when '0' then '消费' else '担保支付' end as transort
        FROM STPPRDINF a
       WHERE a.cust_id=#{USRID}   and a.PRDORDNO=#{PRDORDNO} 
     </sql>
     <sql name="selPayType">
        SELECT case paytype when '00' then '支付账户' when '01' then '网上银行' when '03' then '快捷支付' when '04' then '混合支付' else '' end as paytype 
          FROM STPPAYINF 
         WHERE payordno=#{payordno}
     </sql>
     <process>
       <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/trandetail.jsp')"  />
       <!-- 检查用户登录平台是否正确 -->
       <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>
       <!-- 检查手机号是否为空 -->
       <set name="USRID"           expr="SESSIONS.USRID"/>
       <if condition="IS_EQUAL_STRING(USRID,'')">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="请重新登录"/>
         <set name="_REQUESTATTR.FORWARDURL"       value="html/login/login.jsp"/>
         <return/>
       </if>
       <!-- 判断用户是否存在 -->
       <do func="ReadRecord"       error="IGNORE">
         <para name="SqlCmd"       sql="QryUsrInf" />
       </do>
       <if condition="#RetCod==2">
         <set name="NOTE"          value="E"/>
         <set name="RspCod"        value="02001"/>
         <set name="RspMsg"        value="用户不存在"/>
         <return/>
       </if> 
       <elseif condition="#RetCod!=0">
         <set name="NOTE"          value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </elseif>
       <set name="LOGINNAME"                expr="CUST_LOGIN"/>
        
       <!-- 查询用户消费交易详细  -->
       <do func="ReadRecord"       error="IGNORE">
         <para name="SqlCmd"       sql="QryPrdInf" />
       </do>
       <if condition="#RetCod==2">
         <set name="NOTE"          value="E"/>
         <set name="RspCod"        value="02001"/>
         <set name="RspMsg"        value="无此记录"/>
       </if> 
       <elseif condition="#RetCod!=0">
         <set name="NOTE"          value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
       </elseif>
       
       <if condition="NOT(ISNULL(payordno))">
          <do func="ReadRecord"       error="IGNORE">
            <para name="SqlCmd"       sql="selPayType" />
          </do> 
       </if>
       <else>
           <set name="paytype" value=""/>
       </else>
     </process>
  </transaction>
  
  <transaction code="561536" desc="退款详细信息查询">
        <sql name="QryUsrInf">  <!-- 检测用户是否存在 -->
            SELECT cust_id,CUST_LOGIN FROM STPUSRINF WHERE CUST_ID=#{USRID}
        </sql>
        <sql name="QryrefInf">  <!-- 查询用户退款详细信息 -->
            SELECT 
            case when t.rfOrdTime !=' ' then To_Char(to_date(t.rfOrdTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end ORDERDATE,
                   t.rfPayOrdNo,t.refordno AS ORDERNO, t.RFSAKE, t.BANKERROR,'退款' AS ORDERTYPE, 
                   (case when ORDSTATUS='00' then '等待处理' when ORDSTATUS='02' then '退款成功' when ORDSTATUS='03' then '退款失败'  else '未知' end) as ORDSTATUS_FMT,
                   case when t.rfreqdate != ' ' then TO_CHAR(to_date(t.rfreqdate,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end rfreqdate,
                   t.oriprdordno,t.bankcode,t.bankpayusernm,t.txccy,t.bankjrnno,
                   TO_CHAR(to_number(t.rfamt)/100,'FM9999,999,999,990.00') RFAMT,
                   TO_CHAR(to_number(t.fee)/100,'FM9999,999,999,990.00') fee,
                   TO_CHAR(to_number(t.netrecamt)/100,'FM9999,999,999,990.00') netrecamt,
                   t.ordstatus,t.merno,t.filed1 
                    FROM StpRefInf t 
            WHERE t.refOrdNo=#{PRDORDNO}
        </sql>
        <process>
            <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/tranman/trandetail.jsp')"  />
            <!-- 检查用户登录平台是否正确 -->
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>

            <!-- 检查手机号是否为空 -->
            <set name="USRID" expr="SESSIONS.USRID" />
            <if condition="IS_EQUAL_STRING(USRID,'')">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02035" />
                <set name="RspMsg" value="用户ID为空" />
                <set name="RspMsg" value="请重新登录" />
                <set name="_REQUESTATTR.FORWARDURL" value="html/login/login.jsp" />
                <return />
            </if>

            <!-- 判断用户是否存在 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="NOTE" value="E" />
                <set name="RspCod" value="02001" />
                <set name="RspMsg" value="用户不存在" />
                <return />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="NOTE" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>

            <set name="LOGINNAME" expr="CUST_LOGIN" />
            <!-- 查询用户退款交易详细 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryrefInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="NOTE" value="E" />
                <set name="RspCod" value="02001" />
                <set name="RspMsg" value="无此记录" />
                <return />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="NOTE" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
        </process>
    </transaction>
    
    <transaction code="checkCod" desc="验证码验证-原561149">
        <process>
            <!-- 验证验证码是否正确 -->
            <if condition="ISNULL(HRANDSTR)">
               <set name="MsgTyp" value="E" />
               <set name="RspCod" value="02981" />
               <set name="RspMsg" value="验证码不能为空" />
               <return />
            </if>
            <if condition="ISNULL(SESSIONS.SRA)">
               <set name="MsgTyp" value="E" />
               <set name="RspCod" value="02981" />
               <set name="RspMsg" value="验证码超时" />
               <return />
            </if>
            <set name="HRANDSTR" expr="TOUPPER(HRANDSTR)" />
            <set name="SRATMP" expr="TOUPPER(SESSIONS.SRA)" />
            <if condition="IS_NOEQUAL_STRING(HRANDSTR,SRATMP)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02980" />
                <set name="RspMsg" value="验证码错误，请重新输入。" />
                <return />
            </if>
        </process>
    </transaction>
  
   <transaction code="566120" desc="继续支付页面分配">
     <sql name="QryPrdInf">  <!--查询商品订单信息-->
        select r.merNo as MERNO, r.prdOrdNo as PRDORDNO,TO_CHAR(to_number(r.ordAmt)/100,'FM9999,999,999,990.00') as ORDAMT,r.retUrl as TRADECODE,
               r.Filed3 as ISPROXY  
          from StpPrdInf r 
         where r.PrdOrdNo=#{PrdOrdNo}  and r.userID=#{USRID} and r.OrdStatus=#{OrdStatus}
    </sql>
    
    <sql name="QryRegInf"> <!--查询充值订单信息-->
       select r.MerNo as MERNO, r.regOrdNo as regOrdNo,TO_CHAR(to_number(r.ordAmt)/100,'FM9999,999,999,990.00') as ORDAMT 
         from StpRegInf r  
        where r.regOrdNo=#{PrdOrdNo}  and r.userID=#{USRID} and r.OrdStatus=#{OrdStatus}
    </sql>
     <process>
       <!-- 检查用户登录平台是否正确 -->
       <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>
       
       <!-- 判断用户是否登录 -->
       <set name="CUST_ID"         expr="USRID"/>
       <if condition="IS_EQUAL_STRING(USRID,'')">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02035"/>
         <set name="RspMsg"        value="请重新登录"/>
         <set name="_REQUESTATTR.FORWARDURL"       value="html/login/login.jsp"/>
         <return/>
       </if>
       
       <!--设置一个标志-->
       <set name="sign" value="0"/>
       <!--查询商品订单表-->
       <do func="ReadRecord"       error="IGNORE">
         <para name="SqlCmd"       sql="QryPrdInf"/>
       </do> 

       <if condition="#RetCod==2">
         <set name="sign" value="0"/>
       </if>
       <elseif condition="#RetCod==0">
         <if condition="IS_NOEQUAL_STRING(ISPROXY,'1')">
           <set name="TRADECODE" value=""/>
         </if>
         <set name="MsgTyp"        value="N"/>
         <set name="sign"          value="1"/>
         <set name="RspCod"        value="00000"/>
         <set name="RspMsg"        value="成功查询到该笔未支付的商品支付订单"/>
         <return/>
       </elseif>
       <else>
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02084"/>
         <set name="RspMsg"        value="系统错误,请稍后再试!"/>
         <return/>
       </else>
       <!--查询充值订单表-->
       <do func="ReadRecord"       error="IGNORE">
         <para name="SqlCmd"       sql="QryRegInf"/>
       </do> 
       <if condition="#RetCod==2">
         <set name="sign" value="0"/>
       </if>
       <elseif condition="#RetCod==0">
         <set name="MsgTyp"        value="N"/>
         <set name="sign"          value="2"/>
         <set name="RspCod"        value="00000"/>
         <set name="RspMsg"        value="成功查询到该笔未支付的充值订单"/>
         <return/>
       </elseif>
       <else>
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02085"/>
         <set name="RspMsg"        value="系统错误,请稍后再试!"/>
         <return/>
       </else>
       <if condition="IS_EQUAL_STRING(sign,'0')">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="02086"/>
         <set name="RspMsg"        value="对不起,无符合条件记录!"/>
         <return/>
       </if>
     </process>
   </transaction>
   
   <transaction code="561533" desc="根据登录名查询用户ID">
    <sql name="QryUsrInf">  <!-- 检测用户是否存在 -->
      SELECT CUST_ID as userids FROM STPUSRINF WHERE CUST_LOGIN=#{CUST_ID}
    </sql>
    <process>
      <!-- 检查用户登录平台是否正确 -->
      <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
        <set name="MsgTyp" value="E" />
        <set name="RspCod" value="01001" />
        <set name="RspMsg" value="用户登录平台不正确" />
        <return />
      </if>
      <if condition="ISNULL(CUST_ID)">
        <set name="MsgTyp" value="E" />
        <set name="RspCod" value="01001" />
        <set name="RspMsg" value="登录名为空" />
        <return />
      </if>
      
      <!-- 判断用户是否存在 -->
      <do func="ReadRecord" error="IGNORE">
        <para name="SqlCmd" sql="QryUsrInf" />
      </do>
      <if condition="#RetCod==2">
        <set name="NOTE"   value="E" />
        <set name="RspCod" value="02001" />
        <set name="RspMsg" value="用户不存在" />
        <return />
      </if>
      <elseif condition="#RetCod!=0">
        <set name="NOTE"   value="E" />
        <set name="RspCod" value="09999" />
        <set name="RspMsg" value="数据库操作错误" />
        <return />
      </elseif>
      <set name="MsgTyp" value="N" />
      <set name="RspCod" value="00000" />
      <set name="RspMsg" value="交易成功" />
    </process>
   </transaction>
   
    <!--查询单条已绑定银行卡信息-->
    <transaction code="bnkCrdQry" desc="查询单条已绑定银行卡信息">
        <!--  查询用户注册信息  -->
        <sql name="QryUsrInf">
           SELECT u.USR_STATUS as AUTSTAT,c.CUST_NAME as U_NAME,c.cust_status,p.password,p.PAY_AC_NO AS PAYACNO
             FROM STPUSRINF u,STPCUSINF c,arp_ac_cust_rel p
            WHERE u.CUST_ID=#{USRID} and u.CUST_ID=c.CUST_ID and u.CUST_ID=p.CUST_ID
        </sql>
        <sql name="QryUserBank">
            SELECT BANK_NAM BANKNAME,card_bank bankCode,CARD_NO,CARD_BANK,CARD_TYPE
              FROM STPBANKTB
             WHERE CUST_ID=#{USRID} AND CARD_NO=#{BnkAcNo}
        </sql>
        <sql name="QryStpBankCd"> <!-- 查询用户绑定的银行卡 -->
            select bank_no as bno, enm_dat_des as chnam
            from (select card_bank as bank_no from stpbanktb where card_type='00' and CUST_ID=#{USRID}
            group by card_bank) ,
            (select enm_dat_opt,enm_dat_des from lyxdicenm
            where sys_id=#{SysCod} and
            trim(enm_en_nam) like 'bankNam')
            where bank_no=trim(enm_dat_opt)
        </sql>
        <process>
            
            <set name="USRID" expr="SESSIONS.CUSTNO" />
            <!-- 检查手机号是否为空 -->
            <set name="UsrMp1" expr="DELBOTHSPACE(USRID)" />
            <if condition="IS_EQUAL_STRING(UsrMp1,'')">
                <set name="RspCod" value="02035" />
                <set name="RspMsg" value="手机号为空" />
                <return />
            </if>

            <!-- 检查用户是否存在 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="用户信息不存在" />
                <return />
            </if>
                
           <if condition="IS_NOEQUAL_STRING(AUTSTAT,'2')">
             <set name="MsgTyp"        value="E"/>
             <set name="RspCod"        value="02008"/>
             <set name="RspMsg"        value="用户认证未通过"/>
             <set name="_REQUESTATTR.FORWARDURL"       expr="STRCAT('html/', SESSIONS.LANGUAGE, '/bankcard/unautherized.jsp?AUTSTAT=',AUTSTAT)"/>
             <return/>
           </if>
           
            <if condition="IS_EQUAL_STRING(bandflag,'1')">
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/bankcard/binding.jsp')" />
                <return />
            </if>
            <elseif condition="IS_EQUAL_STRING(bandflag,'2')">
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/bankcard/unbinding.jsp')" />
            </elseif>
            <elseif condition="IS_EQUAL_STRING(bandflag,'3')">
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', SESSIONS.LANGUAGE, '/bankcard/ljkt.jsp')"/>
            </elseif>

            <!-- 查询用户是否绑定过该卡 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUserBank" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspMsg" value="无绑定记录" />
                <set name="RspCod" value="02085" />
                <return />
            </if>

            <set name="CARD_NOTmp" expr="DELBOTHSPACE(CARD_NO)" />

            <!--银行卡号解密 -->
            <set name="sDeData" expr="DES_DECRYPT(CARD_NO)" />
            <set name="First"   expr="SUBSTR(sDeData,1,3)" />
            <set name="End"     expr="SUBSTR(sDeData,SUB(STRLEN(sDeData),3),STRLEN(sDeData))" />
            <set name="CARD_NO" expr="STRCAT(First,'****',End)" />

            <!--查询用户绑定的银行卡 -->
            <do func="QueryInGroup" error="IGNORE">
                <para name="SqlCmd"     sql="QryStpBankCd" />
                <para name="RecordName" value="BANKNAM" />
                <para name="RecNum"     value="BankNum" />
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </if>
            <elseif condition="#RetCod==2">
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
    </transaction>
    
    <transaction code="SelCardK" desc="用户证件列表查询"> 
       <sql name="QryUsrAut"> <!--  查询用户证件类型  -->
         select CUST_CRED_TYPE as cardtyp,CUST_CRED_NO as cardno 
         from stpcusinf 
         where CUST_ID=#{CUST_ID}
       </sql>
       <process>
          <set name="CUST_ID"  expr="SESSIONS.USRID"/>
          <if condition="NOT(ISNULL(CUST_ID))">
             <!-- 查询用户注册信息 -->
             <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd"   sql="QryUsrAut" />
             </do>
             <if condition="#RetCod==2">
               <set  name="cardtyp"  value="0"/>
               <return/>
             </if>
             <elseif condition="#RetCod!=0">
               <set name="MsgTyp"        value="E"/>
               <set name="RspCod"        value="02008"/>
               <set name="RspMsg"        value="数据库错误"/>
               <return/> 
             </elseif>
          </if> 
          
          <!-- 查询证件类型 --> 
          <do func="SelCredType" error="IGNORE"/>  
       </process>
    </transaction>

    <transaction code="userPhotoUpload" desc="图片上传"> 
        <sql name="QuStp"> <!--  检测用户是否存在  -->
           SELECT c.cust_name UserName, c.CUST_CRED_TYPE, c.CUST_CRED_NO, u.CUST_ID,usr_email,usr_status FROM STPUSRINF u,stpcusinf c
           WHERE u.cust_id=c.cust_id and c.CUST_ID=#{USRID}
        </sql>
        <sql name="UdStps"><!--更新用户认证信息表--> 
          update STPUSRINF set CRED_PHOTO_FRONT=#{CRED_PHOTO_FRONT},
          CRED_PHOTO_BACK=#{CRED_PHOTO_BACK},USR_STATUS=#{USR_STATUS}
          where  CUST_ID =#{USRID}
        </sql>
        <process>
            <set name="UsrId"          expr="SESSIONS.USRID"/>  
            <set name="FILESTATUS1"    expr="GETUPLOADFILESTATUS()"/>  
            <set name="UPLOADMESSAGE"  expr="FILESTATUS1"/>
            <set name="SEND_TYPE"      value="1"/>
            <set name="Police"         value=""/>
            
            <!--查询用户认证信息-->  
            <do func="ReadRecord" error="IGNORE"> 
              <para name="SqlCmd" sql="QuStp"/> 
            </do>  
            <if condition="#RetCod==2"> 
              <set name="RspCod" value="02100"/>  
              <set name="RspMsg" value="用户不存在！"/>  
              <set name="UPLOADMESSAGE" value="A"/>  
              <return/> 
            </if>  
            <elseif condition="#RetCod!=0"> 
              <set name="RspCod" value="02100"/>  
              <set name="RspMsg" value="数据操作失败!"/>  
              <set name="UPLOADMESSAGE" value="F"/>  
              <return/> 
            </elseif>  
            <!--if condition="OR(IS_EQUAL_STRING(usr_status,'1'),IS_EQUAL_STRING(usr_status,'2'))">
              <set name="MsgTyp" value="E"/>  
              <set name="RspCod" value="02106"/>  
              <set name="RspMsg" value="认证状态不正确，不能认证！"/>  
              <set name="UPLOADMESSAGE" value="F"/>  
              <return/>
            </if-->
           
            <if condition="IS_NOEQUAL_STRING(FILESTATUS1,'S')"> 
              <if condition="IS_EQUAL_STRING(_REQUESTATTR.UPLOADFILES.FILE_UPLOAD_STATUS,'T')">
                 <set name="RspCod"            value="10001"/>   
                 <set name="RspMsg"            value="文件格式不正确"/>   
              </if>
              <elseif condition="IS_EQUAL_STRING(_REQUESTATTR.UPLOADFILES.FILE_UPLOAD_STATUS,'C')">
                 <set name="RspCod"            value="10002"/>   
                 <set name="RspMsg"            value="超过单个文件大小限制"/>   
              </elseif>
              <elseif condition="IS_EQUAL_STRING(_REQUESTATTR.UPLOADFILES.FILE_UPLOAD_STATUS,'G')">
                 <set name="RspCod"            value="10003"/>   
                 <set name="RspMsg"            value="未达到单个文件最小文件大小要求"/>   
              </elseif>
              <elseif condition="IS_EQUAL_STRING(_REQUESTATTR.UPLOADFILES.FILE_UPLOAD_STATUS,'F')">
                 <set name="RspCod"            value="10004"/>   
                 <set name="RspMsg"            value="失败，出现异常"/>   
              </elseif>
              <set name="MsgTyp" value="E"/>  
              <set name="RspCod" value="02106"/>  
              <set name="RspMsg" expr="RspMsg"/>  
              <set name="_REQUESTATTR.FORWARDURL" value="/html/zh-CN/account/uploaderror.jsp"/>  
              <return/> 
            </if>  
            <set name="PAGEFLAG" expr="GETREQUESTATTR('PAGEFLAG')"/>  
            <set name="UPLOADMESSAGE" expr="STRCAT(UPLOADMESSAGE,',',PAGEFLAG)"/>  
            
            <!--得到图片-->  
            <set name="FILEPATH1" expr="GETUPLOADFILEPATH('FILEUPLOAD1')"/>  
            <set name="FILENAME1" expr="GETUPLOADFILENAME('FILEUPLOAD1')"/>  
            
            <!--得到图片-->  
            <set name="FILEPATH2" expr="GETUPLOADFILEPATH('FILEUPLOAD2')"/>  
            <set name="FILENAME2" expr="GETUPLOADFILENAME('FILEUPLOAD2')"/>  
            
            <set name="UPLOADMESSAGE" expr="STRCAT(UPLOADMESSAGE,',',FILENAME1,',',FILENAME2)"/>
            <set name="ConfigName" value="FtpGetToPay" />
            <quote name="ReadXmlCfg" />
            
            <!--将图片存到服务器上-->  
            <set name="PATH"  expr="GETREQUESTATTR('PATH')"/>  
            <do func="MoveFile">
              <para name="srcDir" expr="STRCAT(PATH,ObjDir)"/>  <!--目前对象路径-->
              <para name="srcFil" expr="STRCAT(FILENAME1,',',FILENAME2)"/>  
              <para name="tarDir" expr="STRCAT(WebPath,LclDir)"/>  <!--目标路径-->
            </do>
            <if condition="#RetCod!=0"> 
                <!--调用FtpGet方法将图片存到ftp服务器上-->  
                <set name="RspCod" value="01007"/>  
                <set name="RspMsg" value="移动文件失败!"/>  
                <set name="UPLOADMESSAGE" value="F"/>  
                <return/>
            </if>
            
            <set name="CRED_PHOTO_FRONT" expr="FILENAME1"/><!-- 正面 -->
            <set name="CRED_PHOTO_BACK"  expr="FILENAME2"/><!-- 反面 -->
            <set name="USR_STATUS"       value="1"/><!-- 认证状态 0：未认证 1：审核中 2：已通过  3：未通过 -->
            
            <!--更新用户认证信息表-->
            <do func="ExecSql">
              <para name="SqlCmd" sql="UdStps"/>
            </do>
            <if condition="#RetCod==3"> 
              <set name="RspCod" value="02101"/>  
              <set name="RspMsg" value="违反数据唯一性!"/>  
              <return/> 
            </if>  
            <elseif condition="#RetCod==2"> 
              <set name="RspCod" value="02100"/>  
              <set name="RspMsg" value="未找到符合的条件记录！"/>  
              <return/> 
            </elseif>  
            <elseif condition="#RetCod!=0"> 
              <set name="RspCod" value="09998"/>  
              <set name="RspMsg" value="系统错误!"/>  
              <return/> 
            </elseif>  
            
            <!-- 调用风控接口 -->  
            <set name="DTYPE"        value="2"/> 
            <set name="UCODE"        expr="USRID"/>
            <set name="UNAME"        expr="UserName"/>
            <set name="USERAPPFLAG"  expr="USR_STATUS"/>     <!--0 未认证 1审核中-->
            <set name="ISTYPE"       value="0"/>             <!--1：试用期，0：非试用期-->
            <set name="DATE"         expr="GETDATE()"/>   
            <set name="TIME"         expr="GETDATETIME()"/>  
            <set name="EMAIL"        expr="usr_email"/>     <!--邮箱-->  
            <set name="sthCode"      value="540504"/>
            <quote name="rcsMaro"/>
            
            <set name="First" expr="SUBSTR(LOGNAM,1,3)"/>  
            <set name="Middo" expr="SUBSTR(LOGNAM,4,4)"/>  
            <set name="End" expr="SUBSTR(LOGNAM,8,SUB(STRLEN(LOGNAM),7))"/>  
            <set name="LOGNAM" expr="STRCAT(First,'****',End)"/>  
            <set name="MsgTyp" value="N"/>  
            <set name="RspCod" value="00000"/>   
            <set name="RspMsg" value="交易成功"/>
            
        </process> 
    </transaction>
    
   <transaction code="561151" desc="身份认证修改信息">
     <sql name="QryUsrInf"> <!--  检测用户是否存在  -->
       SELECT c.cust_name UserName,u.CUST_ID,usr_email,usr_status FROM STPUSRINF u,stpcusinf c
       WHERE u.cust_id=c.cust_id and c.CUST_ID=#{USRID}
     </sql>
      <sql name="UdStps"><!--更新用户认证信息表--> 
        update STPUSRINF set CRED_PHOTO_FRONT=#{CRED_PHOTO_FRONT},
        CRED_PHOTO_BACK=#{CRED_PHOTO_BACK},PUBLIC_PHOTO=#{PUBLIC_PHOTO},USR_STATUS=#{USR_STATUS}
        where  CUST_ID =#{USRID}
      </sql>
     <process>
           <!-- 检查用户登录平台是否正确    0001：用户 ；0009：操作员 -->
           <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
             <set name="RspCod"        value="01001"/>
             <set name="RspMsg"        value="用户登录平台不正确"/>
             <return/>
           </if>
           
           <do func="ReadRecord"   error="IGNORE">
             <para name="SqlCmd" sql="QryUsrInf" />
           </do>
           <if condition="#RetCod==2">
             <set name="MsgTyp"    value="E"/>
             <set name="RspCod"    value="02009"/>
             <set name="RspMsg"    value="无此用户"/>
           </if>
           <elseif condition="#RetCod!=0">
             <set name="MsgTyp"    value="E"/>
             <set name="RspCod"    value="09999"/>
             <set name="RspMsg"    value="系统错误"/>
           </elseif>
           <if condition="OR(IS_EQUAL_STRING(usr_status,'1'),IS_EQUAL_STRING(usr_status,'2'))"> 
              <set name="MsgTyp" value="E"/>  
              <set name="RspCod" value="02106"/>  
              <set name="RspMsg" value="认证状态不正确，不能认证！"/>  
              <set name="UPLOADMESSAGE" value="F"/>  
              <return/>
           </if>
           
            <set name="CUST_CRED_TYPE" expr="IDTYPECOD"/>  
            <set name="CUST_CRED_NO"   expr="DES_ENCRYPT(USERNO)"  />
            <set name="SEND_TYPE"      value="1"/> 
            <set name="Police"          value=""/>
            
            <set name="CARDVALDATE"      expr="FMTDATE(CALCDATE(GETDATE(),'-','d',7),0,4)"/>  
            <set name="CRED_PHOTO_FRONT" expr="FILENAME1S"/><!-- 正面 -->  
            <set name="CRED_PHOTO_BACK"  expr="FILENAME2S"/><!-- 反面 -->  
            <set name="PUBLIC_PHOTO"     value="upload/defaultShow.jpg"/><!-- 公安返回照片 -->  
            <set name="USR_STATUS"       value="1"/><!-- 认证状态 0：未认证 1：审核中 2：已通过  3：未通过 -->  
            
            <!-- 读取配置文件 到公安部身份验证核实 --> 
            <set name="ConfigName" value="FtpGetToPay" />
            <quote name="ReadXmlCfg" />
            <do func="ReadModuleCfg" error="IGNORE"> 
              <para name="cfgfil" value="etc/public/STP_BUSCFG.XML"/>  
              <para name="code" value="CHK"/> 
            </do>
            <if condition="IS_EQUAL_STRING(#para.ChkType,'1')"> 
              <if condition="IS_EQUAL_STRING(IDTYPECOD,'0')"> 
                <set name="RspMsg"        value="用户为身份证用户"/>
                <do func="validIdCard"    error="IGNORE">
                  <para name="name"       expr="UserName"/>
                  <para name="idCardNo"   expr="USERNO"/>
                </do>
                <if condition="#RetCod==0">
                  <set name="RspMsg"    value="身份认证成功"/>
                  <set name="vailStatus"   value="1"/>
                  <if condition="IS_EQUAL_STRING(status,'1')">
                    <set name="vailCardUrl"  expr="picPath"/>
                  </if>
                  <else>
                    <!--默认图片展示-->
                    <set name="vailCardUrl"  value="upload/defaultShow.jpg"/>
                  </else>
                </if>
                <else>
                  <set name="vailStatus"   value="0"/>
                  <set name="RspCod"    value="07565"/>
                  <set name="RspMsg"    value="姓名和身份证不符！"/>
                  <set name="PUBLIC_PHOTO"     value="upload/defaultShow.jpg"/><!-- 公安返回照片 -->  
                </else>

                <set name="PUBLIC_PHOTO"     expr="vailCardUrl"/><!-- 公安返回照片 -->
              </if> 
            </if>  
            
            <!--更新用户认证信息表-->
            <do func="ExecSql">
              <para name="SqlCmd" sql="UdStps"/>
            </do>
            <if condition="#RetCod==3"> 
              <set name="RspCod" value="02101"/>  
              <set name="RspMsg" value="违反数据唯一性!"/>  
              <return/> 
            </if>  
            <elseif condition="#RetCod==2"> 
              <set name="RspCod" value="02100"/>  
              <set name="RspMsg" value="未找到符合的条件记录！"/>  
              <return/> 
            </elseif>  
            <elseif condition="#RetCod!=0"> 
              <set name="RspCod" value="09998"/>  
              <set name="RspMsg" value="系统错误!"/>  
              <return/> 
            </elseif>  
            
            <!-- 调用风控接口 -->  
            <set name="DTYPE"        value="2"/> 
            <set name="UCODE"        expr="USRID"/>
            <set name="UNAME"        expr="UserName"/>  
            <set name="PAPERTYPE"    expr="CUST_CRED_TYPE"/>
            <set name="PCODE"        expr="USERNO"/>
            <set name="USERAPPFLAG"  expr="USR_STATUS"/>     <!--0 未认证 1审核中-->
            <set name="ISTYPE"       value="0"/>             <!--1：试用期，0：非试用期-->
            <set name="DATE"         expr="GETDATE()"/>   
            <set name="TIME"         expr="GETDATETIME()"/>  
            <set name="EMAIL"        expr="usr_email"/>     <!--邮箱-->  
            <set name="sthCode"      value="540504"/>
            <quote name="rcsMaro"/>
            
            <set name="First"  expr="SUBSTR(LOGNAM,1,3)"/>  
            <set name="Middo"  expr="SUBSTR(LOGNAM,4,4)"/>  
            <set name="End"    expr="SUBSTR(LOGNAM,8,SUB(STRLEN(LOGNAM),7))"/>  
            <set name="LOGNAM" expr="STRCAT(First,'****',End)"/>  
            <set name="MsgTyp" value="N"/>  
            <set name="RspCod" value="00000"/>   
            <set name="RspMsg" value="交易成功"/>
            
     </process>
   </transaction>
   
    <transaction code="loginout" desc="用户退出登录">
        <process>

            <set name="SESSIONS.USRID" value="" />
            <set name="SESSIONS.USRNAME" value="" />
            <set name="SESSIONS.USRMP" value="" />
            <set name="SESSIONS.PAYACNO" value="" />
            <set name="SESSIONS.LOGIN" value="" />
            <set name="SESSIONS.MARK" value="" />
            <set name="_REQUESTATTR.FORWARDURL" value="login.jsp" />
        </process>
    </transaction>

    <transaction code="getNotLogMobile" desc="未登录时手机信息查询">
        <sql name="QryUsrMobile"> <!-- 查询用户手机号码 -->
            select
            case when t.usr_mobile is  null then '' else
            substr(nvl(t.usr_mobile,''),1,3) || '****' || substr(nvl(t.usr_mobile,'')
            ,(length(nvl(t.usr_mobile,''))-3),4) end UsrMobile 
            from STPUSRINF t  WHERE CUST_ID=(select CUST_ID from STPUSRINF WHERE cust_login=#{CUST_LOGIN})
        </sql>
        <process>
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>
            <set name="CUST_LOGIN" expr="USRMP" />
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrMobile" />
            </do>

            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
    </transaction>

    <transaction code="findPwd" desc="找回登录密码">    <!-- 原561104改为findPwd -->
        <sql name="QryUsrIdInf"> <!-- 查询用户注册数据 -->
            SELECT *
            FROM STPUSRINF
            WHERE CUST_LOGIN=#{UsrMp}
        </sql>
        <sql name="UpdCuInfoInf"> <!-- 重置登录密码 -->
            UPDATE STPUSRINF
            SET CUST_PWD=#{NUsrPwd}
            WHERE CUST_LOGIN=#{UsrMp}
        </sql>
        <process>
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>

            <!-- 检查手机号是否为空 -->
            <if condition="IS_EQUAL_STRING(UsrMp,'')">
                <set name="RspCod" value="02035" />
                <set name="RspMsg" value="手机号为空" />
                <return />
            </if>

            <!-- 检测用户是否存在 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrIdInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="用户信息不存在,请先注册" />
                <return />
            </if>
            <elseif condition="#RetCod==-1">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09998" />
                <set name="RspMsg" value="系统错误,请稍后再试或联系客服" />
                <return />
            </elseif>
            <set name="NUsrPwd"     expr="nUsrpwd"/>
            <!-- 判断修改密码类型：0：登录密码；1：支付密码 -->
            <switch expr="PwdType">
                <case value="0">
                    <set name="password21" expr="nUsrpwd" />
                    <set name="NUsrPwd" expr="password21" />

                    <!-- 检查登录密码是否为空 -->
                    <if condition="IS_EQUAL_STRING(NUsrPwd,'')">
                        <set name="RspCod" value="02058" />
                        <set name="RspMsg" value="输入新登录密码为空" />
                        <return />
                    </if>

                    <set name="pw" expr="NUsrPwd" />
                    <quote name="getInputPwd" />
                    <set name="NUsrPwd" expr="NewPwd" />
                    <set name="AAAAAA" value="新登录密码转加密成功" />

                    <!-- 重置登录密码 -->
                    <do func="ExecSql" error="IGNORE">
                        <para name="SqlCmd" sql="UpdCuInfoInf" />
                    </do>
                    <if condition="#RetCod==-1">
                        <set name="MsgTyp" value="E" />
                        <set name="RspCod" value="09999" />
                        <set name="RspMsg" value="系统错误" />
                        <return />
                    </if>
                    <elseif condition="#RetCod!=0">
                        <set name="MsgTyp" value="E" />
                        <set name="RspCod" value="02010" />
                        <set name="RspMsg" value="重置登录密码失败" />
                        <return />
                    </elseif>

                </case>
                <case value="1">
                    <set name="NPayPwd" expr="password11" />

                    <!-- 检查支付密码是否为空 -->
                    <if condition="IS_EQUAL_STRING(NPayPwd,'')">
                        <set name="RspCod" value="02058" />
                        <set name="RspMsg" value="输入新支付密码为空" />
                        <return />
                    </if>

                    <set name="pw" expr="NPayPwd" />
                    <quote name="getInputPwd" />
                    <set name="NPayPwd" expr="inPwd" />

                </case>
            </switch>
            <set name="First"   expr="SUBSTR(CUST_LOGIN,1,3)" />
            <set name="End"     expr="SUBSTR(CUST_LOGIN,8,SUB(STRLEN(CUST_LOGIN),7))" />
            <set name="LOGNAM"  expr="STRCAT(First,'****',End)" />
            <set name="USRMP"   expr="LOGNAM" />  <!-- 将中间的值换成* -->
            <set name="MsgTyp"  value="N" />
            <set name="RspCod"  value="00000" />
            <set name="RspMsg"  value="交易成功" />
        </process>
    </transaction>

    <transaction code="findPwdByMes" desc="找回密码(短信),接收账号,产生校验码">  <!-- 交易码561103改为findPwdByMes -->
        <sql name="QryUsrInf"> <!-- 查询用户注册数据 -->
            SELECT * FROM STPUSRINF WHERE CUST_LOGIN=#{UsrMp}
        </sql>
        <sql name="QryMsgSend">
            select count(*) CNT from stpverify where ver_id =
            #{UsrMp} and
            service_type='00' and (instim + numtodsinterval(1,
            'minute'))>sysdate
        </sql>
        <sql name="DelUsrIdInfo"> <!-- 删除用户验证信息 -->
            DELETE FROM STPVERIFY
            WHERE VER_ID=#{UsrMp} AND VER_TYPE=#{VER_TYPE}
            and
            SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>
        <sql name="InsUsrrandom"> <!-- 插入用户验证信息 -->
            INSERT INTO STPVERIFY
            (VER_ID,VER_TYPE,InsTim,Random,TimeOut,SERVICE_TYPE,VER_TRAN_NO)
            VALUES (#{UsrMp},${VER_TYPE}, sysdate
            ,#{Random},#{TimeOut},#{SERVICE_TYPE},'02')
        </sql>
        <sql name="InMsgSed"><!-- 登记短信信息 -->
            INSERT INTO STPMSGSED
            VALUES(#{USRMP},#{MSG_DAT},#{MSG_TIM},#{CUS_NAM},#{SMSCONTENT},'1')
        </sql>
        <sql name="UpdMsgSed">
            update StpMsgSed set Msg_Sts='1' where Phone=#{UsrMp}
            and
            Msg_Tim=#{Msg_Tim}
        </sql>
        <process>
            <if
                condition="AND(IS_NOEQUAL_STRING(SysCod,'0001'),IS_NOEQUAL_STRING(SysCod,'0004'))"><!-- 检查用户登录平台是否正确 -->
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>

            <!-- 检查输入信息是否为空 -->
            <set name="UsrMp" expr="DELBOTHSPACE(UsrMp)" />
            <if condition="IS_EQUAL_STRING(UsrMp,'')"><!-- 检查手机号是否为空 -->
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02035" />
                <set name="RspMsg" value="输入手机号为空" />
                <return />
            </if>

            <!-- 检测用户是否存在 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrInf" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="用户信息不存在,请先注册" />
                <return />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09998" />
                <set name="RspMsg" value="系统错误,请稍后再试或联系客服" />
                <return />
            </elseif>
            <!-- 验证码验证 
            <set name="RA" expr="SESSIONS.SRA" />
            <if condition="IS_NOEQUAL_STRING(TMPRAND,RA)">
                <set name="RspCod" value="02006" />
                <set name="RspMsg" value="验证码输入错误" />
                <return />
            </if>-->

            <!--检查短信发送时效性 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryMsgSend" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </if>

            <if condition="IS_NOEQUAL_STRING(CNT,'0')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="请1分钟后再点击" />
                <return />
            </if>

            <!-- 随机字符串长度 -->
            <!-- 随机字符: ALL 字母和数字; NUM 数字; STR 字母 -->
            <!-- 大小写标识: MIX 混合; UPP 大写; LOW 小写; -->
            <do expr="@TdRandom@generateMixRandom(6, 'NUM', 'LOW')" />

            <if condition="IS_EQUAL_STRING(TimeOut,'')">
                <set name="TimeOut" value="10" />
            </if>
            <if condition="ISNUMBER(UsrMp)">
                <set name="VER_TYPE" value="0" /><!--验证类型 0：短信验证 1：邮箱验证 -->
            </if>
            <else>
                <set name="TimeOut" expr="MUL(24,60)" />
                <set name="VER_TYPE" value="1" /><!--验证类型 0：短信验证 1：邮箱验证 -->
            </else>

            <if condition="ISNULL(SERVICE_TYPE)">
                <set name="SERVICE_TYPE" value="02" /><!--验证码服务类型 00-注册短信验证 01-修改密码短信验证 
                    02-找回密码短信验证 03-数字证书短信验证 04-帐号变更短信验证 05-消费支付短信验证 -->
            </if>
            <else>
                <set name="SERVICE_TYPE" expr="SERVICE_TYPE" />
            </else>

            <!-- 删除用户申请的验证码记录 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="DelUsrIdInfo" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspMsg" value="该用户第一次申请验证码，无记录删除" />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>

            <!-- 插入用户验证表 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="InsUsrrandom" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </if>
            <do func="CommitWork" />

            <set name="SmsContent" expr="STRCAT('尊敬的商物通用户，您的身份校验码是：',Random,'。请您在10分钟内完成校验，如非本人操作，请及时修改密码以防被盗。')" />

            <!-- 插入短信信息 -->
            <set name="Msg_Dat" expr="GETDATE()" />
            <set name="Msg_Tim" expr="GETDATETIME()" />
            <set name="Cus_Nam" value="注册用户验证" />

            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="InMsgSed" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod" value="01006" />
                <set name="RspMsg" value="登记短信发送表失败" />
                <return />
            </if>
            <do func="CommitWork" />

            <!-- 发送短信 -->
            <if condition="ISNUMBER(UsrMp)">
                <!--取公共参数配置 -->
                <set name="ConfigName" value="SendSms" />
                <quote name="ReadXmlCfg" />
                <!-- 发送短信 -->
                <quote name="SendSms"/>
                
                <delete name="Random"/> 
                <delete name="SmsContent"/>
            </if>
            <else>
                <set name="ConfigName" value="CheckEmailNew" />
                <quote name="ReadXmlCfg" />

                <set name="Email" expr="UsrMp" />
                <set name="EmResAddr" expr="SmsContent" />
                <!--发送邮件 -->
                <do func="TdMailSendNew" error="IGNORE">
                    <para name="EmTo" expr="Email" />
                    <para name="EmTitle" value="注册" />
                    <para name="EmText" expr="Random" />
                    <para name="EmResAddr" expr="G_EMCOMPHTTP" />
                </do>
                <if condition="#RetCod!=0">
                    <set name="MsgTyp" value="E" />
                    <set name="RspCod" value="09999" />
                    <set name="RspMsg" value="发送邮件失败" />
                    <return />
                </if>
                <delete name="Random" />
                <delete name="SmsContent" />
                <delete name="EmResAddr" />
                <delete name="G_EMPWD" />
            </else>

            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="UpdMsgSed" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod" value="1003" />
                <set name="RspMsg" value="修改发送状态失败" />
                <set name="DWZ_STATUS_CODE" value="300" />
                <set name="DWZ_RSP_MSG" expr="RspMsg" />
                <return />
            </if>

            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
    </transaction>
    
    <transaction code="checkLogincod" desc="手机验证码验证-原561127">
        <sql name="DelUsrIdInfo"> <!-- 删除验证表信息 -->
            DELETE FROM STPVERIFY
            WHERE VER_ID=#{UsrMp} AND VER_TYPE=#{VER_TYPE}
            and
            SERVICE_TYPE=#{SERVICE_TYPE}
        </sql>
        <sql name="QryUsrIdverifycode"> <!-- 查询用户注册验证码信息 -->
            SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60)
            timdif,timeout,InsTim,Random
            FROM STPVERIFY
            WHERE VER_ID=#{UsrMp} AND
            VER_TYPE=#{VER_TYPE} and
            SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim
            DESC
        </sql>
        <process>
            <!-- 检查用户登录平台是否正确 -->
            <if
                condition="AND(IS_NOEQUAL_STRING(SysCod,'0001'),IS_NOEQUAL_STRING(SysCod,'0004'))">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>
            <set name="newUsrId" expr="SESSIONS.USRID" />
            <if condition="ISNUMBER(UsrMp)">
                <set name="VER_TYPE" value="0" /><!--验证类型 0：短信验证 1：邮箱验证 -->
            </if>
            <else>
                <set name="VER_TYPE" value="1" /><!--验证类型 0：短信验证 1：邮箱验证 -->
            </else>
            
            <if condition="ISNULL(SERVICE_TYPE)">
                <set name="SERVICE_TYPE" value="02" /><!--验证码服务类型 00-注册短信验证 01-修改密码短信验证 
                    02-找回密码短信验证 03-数字证书短信验证 04-帐号变更短信验证 05-消费支付短信验证 -->
            </if>
            <else>
                <set name="SERVICE_TYPE" expr="SERVICE_TYPE" />
            </else>
            <!-- 查询验证码 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrIdverifycode" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02009" />
                <set name="RspMsg" value="该用户未申请校验码" />
                <return />
            </if>
            <elseif condition="#RetCod==-1">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09998" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
                <!--超时时间判断,timdif：为距离现在间隔多少分钟，timeout：超时时间 -->
            <if condition="INTCMP(timdif,6,timeout)">
                <set name="RspCod" value="02005" />
                <set name="RspMsg" value="校验码已失效,请重新获取校验码" />
                <return />
            </if>
    
                <!-- 比较验证码 -->
            <if condition="IS_NOEQUAL_STRING(RandStr,Random)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02006" />
                <set name="RspMsg" value="校验码错误，请重新输入。" />
                <return />
            </if>
            <delete name="Random" />
                <!-- 防止数据库保存验证码数据量过大，交易成功后即删除用户验证码信息 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="DelUsrIdInfo" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp" value="N" />
                <set name="RspCod" value="02009" />
                <set name="RspMsg" value="未找到验证码登记信息" />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
    </transaction>

    <transaction code="updLogPwd" desc="用户修改登录密码">  <!-- 交易码561111改成updLogPwd -->
        <sql name="UpdCuInfoInf"> <!-- 重置登录密码 -->
            UPDATE STPUSRINF SET CUST_PWD=#{NUSRPWD},PASSWORD_STRENGTH=#{PWDSTRE}
            WHERE CUST_ID=#{UsrId}
        </sql>
        <sql name="QryUsrIdInf"> <!-- 查询用户注册信息 -->
            SELECT CUST_LOGIN,CUST_PWD FROM STPUSRINF WHERE CUST_ID=#{UsrId}
        </sql>
        <sql name="checPayPwd">
            select password as oldPayPwd from arp_ac_cust_rel where
            cust_id=#{UsrId}
        </sql>
        <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
            SELECT 
            EXTRACT(DAY FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*24*60 + EXTRACT(HOUR FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*60 +  EXTRACT(MINUTE FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND )) as timeDifference,
            CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
            FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
            INSERT INTO STPLOGTMP
            (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
            VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
        </sql>
        <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET LAST_LOGIN_TIME=SYSDATE ,
            LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
            WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <process>
            <set name="USRID" expr="SESSIONS.USRID" />
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>
            <if condition="IS_EQUAL_STRING(Flag,'01')">
                <set name="RspCod" value="00000" />
                <set name="RspMsg" value="页面跳转成功" />
                <set name="_REQUESTATTR.FORWARDURL"
                    expr="STRCAT('html/', SESSIONS.LANGUAGE, '/security/modifypwdsuccess.jsp')" />
                <return />
            </if>
              
            <do func="ReadRecord" error="IGNORE"><!-- 查询用户注册信息 -->
                <para name="SqlCmd" sql="QryUsrIdInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="用户信息不存在" />
                <return />
            </if>
           
           <!-- 用户修改登录密码锁定次数判断 -->
           <set name="USER_ID"   expr="DELBOTHSPACE(CUST_LOGIN)" />
           <set name="CUSTTYPE"  value="0"/><!--0用户 1 商户 2企业-->
           <set name="PWDTYPE"   value="0"/><!--0:登录密码 1:支付密码-->
           <set name="FailFlag"  value="0"/>
           <quote name="usrpwdlock"/>
            <!-- 用户修改登录密码锁定次数判断 -->
            
            <!-- 登录密码转加密 -->  
            <set name="pw"  expr="USRPWD"/>
            <quote name="getInputPwd"/>  
            <set name="USRPWD" expr="NewPwd" />
            
            <!-- 检查当前密码是否为空 -->
            <if condition="IS_EQUAL_STRING(USRPWD,'')">
                <set name="RspCod" value="02058" />
                <set name="RspMsg" value="用户当前密码为空" />
                <return />
            </if>
            
            <!-- 验证旧密码 -->
            <if condition="IS_NOEQUAL_STRING(USRPWD,CUST_PWD)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02017" />
                <set name="RspMsg" value="原始密码输入错误！" />
                <quote name="UpLoginInfo"/>
                <return />
            </if>

            <!-- 新登录密码转加密 -->  
            <set name="pw"  expr="NUSRPWD"/>
            <quote name="getInputPwd"/>  
            <set name="NUSRPWD" expr="NewPwd" />
            <!-- 检查新密码是否为空 -->
            <if condition="IS_EQUAL_STRING(NUSRPWD,'')">
                <set name="RspCod" value="02060" />
                <set name="RspMsg" value="用户新密码为空" />
                <return />
            </if>
            
            <!-- 新登录密码确认转加密 -->  
            <set name="pw"  expr="FIRMPWD"/>
            <quote name="getInputPwd"/>  
            <set name="FIRMPWD" expr="NewPwd" />
            <!-- 检查确认新密码是否为空 -->
            <if condition="IS_EQUAL_STRING(FIRMPWD,'')">
                <set name="RspCod" value="02061" />
                <set name="RspMsg" value="用户确认新密码为空" />
                <return />
            </if>
            
            <!-- 新密码二次验证 -->
            <if condition="IS_NOEQUAL_STRING(NUSRPWD,FIRMPWD)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02018" />
                <set name="RspMsg" value="二次密码输入错误" />
                <return />
            </if>

            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="checPayPwd" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="用户无账户号" />
                <return />
            </if>

            <if condition="IS_EQUAL_STRING(oldPayPwd,NUSRPWD)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02018" />
                <set name="RspMsg" value="新密码不能和支付密码相同" />
                <return />
            </if>

            <do func="ExecSql" error="IGNORE">        <!-- 重置登录密码 -->
                <para name="SqlCmd" sql="UpdCuInfoInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod" value="02010" />
                <set name="RspMsg" value="重置登录密码错误" />
                <return />
            </if>

            <!-- 修改登记失败信息表 -->
            <do func="ExecSql" error="IGNORE">
               <para name="SqlCmd" sql="UpdUsrLogInfo"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="RSPCOD" value="02040"/>
               <set name="RSPMSG" value="更新登录信息失败!"/> 
               <return/>
            </if>
            
            <set name="Editflag" value="0" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
    </transaction>

    <transaction code="updPayPwd" desc="用户修改支付密码">  <!-- 交易码561131改成updPayPwd -->
        <sql name="QryUsrIdInf"> <!-- 查询用户注册信息 -->
            SELECT CUST_LOGIN,CUST_PWD FROM STPUSRINF WHERE CUST_ID=#{UsrId}
        </sql>
        <sql name="UpdPayStre"> <!-- 更新用户支付密码强度 -->
            UPDATE STPUSRINF SET PAYPWD_STRENGTH=#{PAYSTRE}
            WHERE CUST_ID=#{UsrId}
        </sql>
        <sql name="UpdPayPwd"> <!-- 更新用户支付密码强度 -->
            UPDATE ARP_AC_CUST_REL SET password=#{NUSRPWD}
            WHERE CUST_ID=#{UsrId}
        </sql>
        <sql name="chkPayPwd">
            select password as oldPayPwd from arp_ac_cust_rel where
            cust_id=#{UsrId}
        </sql>
        <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
            SELECT 
            EXTRACT(DAY FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*24*60 + EXTRACT(HOUR FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*60 +  EXTRACT(MINUTE FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND )) as timeDifference,
            CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
            FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
            INSERT INTO STPLOGTMP
            (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
            VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
        </sql>
        <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
            LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
            UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
            WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
        </sql>
        <process>
            <set name="USRID" expr="SESSIONS.USRID" />
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>
            <if condition="IS_EQUAL_STRING(Flag,'01')">
                <set name="RspCod" value="00000" />
                <set name="RspMsg" value="页面跳转成功" />
                <set name="_REQUESTATTR.FORWARDURL"
                    expr="STRCAT('html/', SESSIONS.LANGUAGE, '/security/paypwdsuccess.jsp')" />
                <return />
            </if>

            <!-- 查询用户注册信息 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrIdInf" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="用户信息不存在" />
                <return />
            </if>

           <!-- 用户修改登录密码锁定次数判断 -->
           <set name="USER_ID"   expr="DELBOTHSPACE(CUST_LOGIN)" />
           <set name="CUSTTYPE"  value="0"/><!--0用户 1 商户 2企业-->
           <set name="PWDTYPE"   value="1"/><!--0:登录密码 1:支付密码-->
           <set name="FailFlag"  value="0"/>
           <quote name="usrpwdlock"/>
            <!-- 用户修改登录密码锁定次数判断 -->
            
            <set name="UsrId" expr="SESSIONS.USRID" />
            <if condition="IS_EQUAL_STRING(UsrId,'')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户未登录或登录失效" />
                <return />
            </if>

            <set name="pw" expr="oldPayPwdForUpd" />
            <quote name="getInputPwd" />
            <set name="UsrPwd" expr="NewPwd" />

            <!-- 验证用户支付密码 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="chkPayPwd" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="用户无账户号" />
                <return />
            </if>

            <if condition="IS_NOEQUAL_STRING(oldPayPwd,UsrPwd)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02017" />
                <set name="RspMsg" value="输入的支付密码和原始密码不相同" />
                <quote name="UpLoginInfo"/>
                <return />
            </if>

            <!-- 检查当前密码是否为空 -->
            <if condition="IS_EQUAL_STRING(UsrPwd,'')">
                <set name="RspCod" value="02058" />
                <set name="RspMsg" value="用户当前密码为空" />
                <return />
            </if>

            <set name="pw" expr="newPayPwdForUpd" />
            <quote name="getInputPwd" />
            <set name="nUsrpwd" expr="NewPwd" />

            <!-- 检查新密码是否为空 -->
            <if condition="IS_EQUAL_STRING(nUsrpwd,'')">
                <set name="RspCod" value="02060" />
                <set name="RspMsg" value="用户新密码为空" />
                <return />
            </if>

            <set name="pw" expr="reNewPayPwdForUpd" />
            <quote name="getInputPwd" />
            <set name="firmpwd" expr="NewPwd" />

            <!-- 检查确认新密码是否为空 -->
            <if condition="IS_EQUAL_STRING(firmpwd,'')">
                <set name="RspCod" value="02061" />
                <set name="RspMsg" value="用户确认新密码为空" />
                <return />
            </if>

            <!-- 新密码二次验证 -->
            <if condition="IS_NOEQUAL_STRING(nUsrpwd,firmpwd)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02018" />
                <set name="RspMsg" value="两次密码输入错误" />
                <return />
            </if>

            <!-- 检测与登录密码是否相同 -->
            <if condition="IS_EQUAL_STRING(NUsrPwd,CUST_PWD)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02018" />
                <set name="RspMsg" value="支付密码不能与登录密码相同" />
                <return />
            </if>

            <!-- 修改支付密码 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="UpdPayPwd" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspMsg" value="无可修改记录" />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>

            <!-- 修改支付密码强度 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="UpdPayStre" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspMsg" value="无可修改记录" />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>

            <!-- 修改登记失败信息表 -->
            <do func="ExecSql" error="IGNORE">
               <para name="SqlCmd" sql="UpdUsrLogInfo"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="RSPCOD" value="02040"/>
               <set name="RSPMSG" value="更新登录信息失败!"/> 
               <return/>
            </if>
            
            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
    </transaction>
    
    <transaction code="getUsrMobile" desc="用户手机号码查询">
        <sql name="QryUsrMobile"> <!-- 查询用户手机号码 -->
            select
            case when t.usr_mobile is  null then '' else
            substr(nvl(t.usr_mobile,''),1,3) || '****' || substr(nvl(t.usr_mobile,'')
            ,(length(nvl(t.usr_mobile,''))-3),4) end UsrMobile 
            from STPUSRINF t  WHERE CUST_ID=#{USRID}
        </sql>
        <process>
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>
            <set name="USRID" expr="SESSIONS.USRID" />
            <do func="PagedQuery" error="ignore">
                <para name="PageNum" expr="PageNum" />
                <para name="NumPerPag" expr="NumPerPag" />
                <para name="Sql" sql="QryUsrMobile" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="用户信息不存在,请先注册" />
                <return />
            </if>
            <elseif condition="#RetCod==-1">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09998" />
                <set name="RspMsg" value="系统错误,请稍后再试或联系客服" />
                <return />
            </elseif>
            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
    </transaction>
    
    <transaction code="findPayPwd" desc="找回支付密码">
        <sql name="QryUsrIdInf"> <!-- 查询用户注册信息 -->
            SELECT u.cust_pwd as dlmm, r.PAY_AC_NO FROM STPUSRINF
            u,arp_ac_cust_rel r WHERE u.CUST_ID=#{UsrId} and u.CUST_ID=r.CUST_ID
        </sql>
        <sql name="UpdPayStre"> <!-- 更新用户支付密码强度 add by zh 6.18 -->
            UPDATE STPUSRINF SET PAYPWD_STRENGTH=#{PAYSTRE} WHERE
            CUST_ID=#{UsrId}
        </sql>
        <sql name="UpdPayPwd"> <!-- 更新用户支付密码 -->
            UPDATE arp_ac_cust_rel SET password=#{NPayPwd} WHERE CUST_ID=#{UsrId}
        </sql>
        <process>
            
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>
            <if condition="IS_EQUAL_STRING(Flag,'01')">
                <set name="RspCod" value="00000" />
                <set name="RspMsg" value="页面跳转成功" />
                <set name="_REQUESTATTR.FORWARDURL"
                    expr="STRCAT('html/', SESSIONS.LANGUAGE, '/security/findPayPwdSuccess.jsp')" />
                <return />
            </if>
            
            <set name="UsrId" expr="SESSIONS.USRID" />
            <if condition="IS_EQUAL_STRING(UsrId,'')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户未登录或登录失效" />
                <return />
            </if>
            
            <!-- 转密新支付密码 -->
            <set name="pw" expr="newPayPwdForFind" />
            <quote name="getInputPwd" />
            <set name="NPayPwd" expr="NewPwd" />
            <set name="AAAAAA" value="新密码转加密成功" />

            <!-- 转密新支付密码确认 -->
            <set name="pw" expr="reNewPayPwdForFind" />
            <quote name="getInputPwd" />
            <set name="firmpwd" expr="NewPwd" />
            <set name="AAAAAA" value="确认密码转加密成功" />

            <!-- 新密码二次验证 -->
            <if condition="IS_NOEQUAL_STRING(NPayPwd,firmpwd)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02017" />
                <set name="RspMsg" value="二次密码输入错误" />
                <return />
            </if>

            <!-- 检测用户是否存在 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrIdInf" />
            </do>
            <if condition="#RetCod==-1">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09997" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </if>
            <if condition="#RetCod==2">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="用户信息不存在" />
                <return />
            </if>
            <if condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09998" />
                <set name="RspMsg" value="对不起，重置支付密码失败" />
                <return />
            </if>
            <!-- 检测与登录密码是否相同 -->
            <if condition="IS_EQUAL_STRING(NPayPwd,dlmm)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02018" />
                <set name="RspMsg" value="支付密码不能与登录密码相同" />
                <return />
            </if>

            <!-- 修改支付密码 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="UpdPayPwd" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspMsg" value="无可修改记录" />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>

            <!-- 修改支付密码强度 -->
            <do func="ExecSql" error="IGNORE">
                <para name="SqlCmd" sql="UpdPayStre" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspMsg" value="无可修改记录" />
            </if>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>

            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
    </transaction>
    
    <transaction code="userStatus" desc="用户状态和余额查询"><!-- ajax调用 -->
    <sql name="queBal">
            select PAY_AC_NO as PAYACNO,AC_STATUS,
            CASH_AC_BAL-FROZ_BALANCE as casfroz,
            CASH_AC_BAL as CASHACBAL,
            FROZ_BALANCE as FROZBALANCE,
            TO_CHAR(to_number(CASH_AC_BAL)/100,'9999999999990.00') as CashAcBal1,
            TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'9999999999990.00')
            as usrBal,
            TO_CHAR(to_number(CASH_AC_BAL)/100,'9999999999990.00') as
            acBal,
            TO_CHAR(to_number(FROZ_BALANCE)/100,'9999999999990.00') as
            noUsrBal,
            TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'9999999999990.00')
            as getBal,
            TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'9999999999990.00')
            as payCBal
            from ARP_AC_PROFILE
            where PAY_AC_NO = #{payacno}
        </sql>
      <sql name="QryUsrInfPay"> <!-- 查询用户认证信息 -->
            SELECT c.CUST_STATUS,C.CUST_ID AS custno, L.PAY_AC_NO AS payacno, C.CUST_CRED_NO AS
            U_CARD_NO,
            C.CUST_CRED_TYPE AS U_CARD_TYPE, U.PUBLIC_PHOTO AS
            U_PHOTO_MPS, U.USR_STATUS
            FROM STPUSRINF U,STPCUSINF C,ARP_AC_CUST_REL L 
            WHERE U.CUST_ID=#{USRID} AND C.CUST_ID = U.CUST_ID AND U.CUST_ID =
            L.CUST_ID
        </sql>
        <process>
            <set name="tellerId" value="000001" />
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>

            <set name="usrid" expr="SESSIONS.USRID" />

            <if condition="ISNULL(usrid)">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02000" />
                <set name="RspMsg" value="您还没有登录，请先登录！" />
                <set name="_REQUESTATTR.FORWARDURL" value="index.jsp" />
                <return />
            </if>

            <quote name="selUserBalance" />
            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
    </transaction>
    
    <transaction code="getCardNo" desc="银行卡列表条件查询"><!-- 561525改为getCardNo 提现页面ajax加载时使用 -->
        
        <sql name="QryStpBankCd"> <!-- 查询用户绑定的银行卡 -->
            SELECT b.BAK_SEQ,b.CUST_ID,substr(b.CARD_BANK,1,4) CARD_BANK, DECRYPT_DES(b.CARD_NO,'0123456789ABCDEF') as CARD_NO,
            substr(DECRYPT_DES(b.CARD_NO,'0123456789ABCDEF'),(length(DECRYPT_DES(b.CARD_NO,'0123456789ABCDEF'))-3),4) as CANO,
            nvl(b.BANK_CONF,'0') as BANK_CONF,bank_nam as banknotype
            FROM STPBANKTB b
            WHERE b.CUST_ID=#{USRID} and b.CARD_TYPE='00' and BANK_CONF='1' ORDER BY CANO
        </sql>
        <process>
            <!-- 检查用户登录平台是否正确 0001：用户 ；0009：操作员 -->
            <if condition="AND(IS_NOEQUAL_STRING(SysCod,'0009'),IS_NOEQUAL_STRING(SysCod,'0001'))">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>
            <set name="USRID" expr="SESSIONS.USRID" />
            <!-- 检查手机号是否为空 -->
            <set name="UsrMp1" expr="DELBOTHSPACE(USRID)" />
            <if condition="IS_EQUAL_STRING(UsrMp1,'')">
                <set name="RspCod" value="02035" />
                <set name="RspMsg" value="手机号为空" />
                <set name="_REQUESTATTR.FORWARDURL" value="html/login/login.jsp" />
                <return />
            </if>
            <!--查询用户组信息 -->
            <do func="QueryInGroup" error="IGNORE">
                <para name="SqlCmd" sql="QryStpBankCd" />
                <para name="RecordName" value="GRP" />
                <para name="RecNum" value="UsNum" />
            </do>
            <if condition="#RetCod==-1">
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </if>
            <if condition="#RetCod==-2">
                <set name="RspCod" value="00000" />
                <set name="RspMsg" value="请先绑定银行卡" />
                <return />
            </if>
            <foreach name="GRP" iterator="#grp">
                <set name="sDeData"  expr="#grp.CARD_NO" />
                <set name="First"    expr="SUBSTR(sDeData,1,3)" />
                <set name="End"      expr="SUBSTR(sDeData,SUB(STRLEN(sDeData),3),STRLEN(sDeData))" />
                <set name="bankdata" expr="STRCAT(First,'****',End)" />
                <do func="loopSetEach">
                    <para name="ele" expr="#grp.CARDNO" />
                    <para name="value" expr="bankdata" />
                </do>
                <if condition="#RetCod!=0">
                    <set name="RspCod" value="09998" />
                    <set name="RspMsg" value="系统错误" />
                    <set name="DWZ_STATUS_CODE" value="300" />
                    <set name="DWZ_RSP_MSG" expr="RspMsg" />
                    <return />
                </if>
            </foreach>

            <!-- 下一个页面路径 -->
            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
    </transaction>
    
    <transaction code="getAtten" desc="查询联系人">
        <sql name="QryAttenNam"> <!-- 查询用户注册数据 -->
           SELECT  T.GETCUSID AS CUST_ID,T.GETCUSNAM AS CUST_NAME,U.CUST_LOGIN,substr(CUST_LOGIN,0,3)||'***'||substr(CUST_LOGIN,8,11) custmobile FROM StpTraInf T,STPUSRINF U WHERE T.getCusId=U.CUST_ID AND T.TRACUSID=#{CUST_ID} group by T.GETCUSID,T.GETCUSNAM,U.CUST_LOGIN
           union
           SELECT  T.TRACUSID AS CUST_ID,T.TRACUSNAM AS CUST_NAME,U.CUST_LOGIN,substr(CUST_LOGIN,0,3)||'***'||substr(CUST_LOGIN,8,11) custmobile FROM StpTraInf T,STPUSRINF U WHERE T.TRACUSID=U.CUST_ID AND T.GETCUSID=#{CUST_ID} group by T.TRACUSID,T.TRACUSNAM,U.CUST_LOGIN
        </sql>
        <process>
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>
            <set name="CUST_ID" expr="SESSIONS.USRID" />
            <do func="PagedQuery" error="ignore">
                <para name="PageNum"   expr="PageNum" />
                <para name="NumPerPag" expr="NumPerPag" />
                <para name="Sql"       sql="QryAttenNam" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="用户信息不存在,请先注册" />
                <return />
            </if>
            <elseif condition="#RetCod==-1">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09998" />
                <set name="RspMsg" value="系统错误,请稍后再试或联系客服" />
                <return />
            </elseif>
            <set name="MsgTyp" value="N" />
            <set name="RspCod" value="00000" />
            <set name="RspMsg" value="交易成功" />
        </process>
    </transaction>
    
    <transaction code="getUserNam" desc="查询用户名称">
        <sql name="QryUsrNam"> <!-- 查询用户注册数据 -->
            SELECT C.CUST_NAME,U.CUST_ID FROM STPUSRINF U,STPCUSINF C WHERE C.CUST_ID =
            U.CUST_ID AND CUST_LOGIN=#{UsrMp}
        </sql>
        <sql name="QryAcStatus">
            SELECT AC_STATUS FROM  ARP_AC_PROFILE WHERE PAY_AC_NO= #{CUST_ID}||'01'
        </sql>
        <process>
            <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
                <set name="RspCod" value="01001" />
                <set name="RspMsg" value="用户登录平台不正确" />
                <return />
            </if>
            <!-- 查询用户信息 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryUsrNam" />
            </do>
            <if condition="#RetCod==2">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02008" />
                <set name="RspMsg" value="该用户信息不存在!" />
                <return />
            </if>
            <elseif condition="#RetCod==-1">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09999" />
                <set name="RspMsg" value="系统错误" />
                <return />
            </elseif>
            <elseif condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="09998" />
                <set name="RspMsg" value="系统错误,请稍后再试或联系客服" />
                <return />
            </elseif>
            <set name="CUST_ID"    expr="CUST_ID"/>
            <set name="USRID" expr="SESSIONS.USRMP" />
            <!-- 查询账户状态 -->
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="QryAcStatus" />
            </do>
            <if condition="#RetCod!=0">
                <set name="MsgTyp" value="E" />
                <set name="RspCod" value="02009" />
                <set name="RspMsg" value="该用户状态异常！" />
                <return/>
            </if>
            <set name="AC_STATUS"  expr="AC_STATUS"/>
            <set name="MsgTyp"     value="N" />
            <set name="RspCod"     value="00000" />
            <set name="RspMsg"     value="交易成功" />
        </process>
    </transaction>
    
    <transaction code="openQuek" desc="开通快捷支付">
      	<sql name="updateConfig">
      	    update stpbanktb set bank_conf='1',AUTH_CODE=#{TOKENPAYDATA} where bak_seq=#{BAK_SEQ}
      	</sql>
      	<sql name="qryIdInfo">
      	    select cust_cred_no from stpcusinf where cust_id=#{userID}
      	</sql>
      	<sql name="qrySamInfo">
      	    select BAK_SEQ as BANK_SEQ,CARD_NO from stpbanktb where cust_id=#{userID} and 
      	    card_no=#{qryCard} and bank_conf='1'
      	</sql>
      	<sql name="bindAgain">
      	    update stpbanktb set BANK_RES_PHONE=#{PHONENO},AUTH_CODE=#{TOKENPAYDATA} where bak_seq=#{BAK_SEQ}
      	</sql>
	    <process>
	    	<!-- 检测用户登录状态 此交易必须是登录状态完成-->
		    <set name="userID"          expr="SESSIONS.USRID"/>
	        <if condition="ISNULL(userID)">
	            <set name="MsgTyp"        value="E"/>
	            <set name="RspCod"        value="02000"/>
	            <set name="RspMsg"        value="用户登录超时"/>
	            <return/>
	        </if>
	    	 <!--参数配置-->
            <set name="ConfigName"       value="NJPaymentInfo"/>
            <quote name="ReadXmlCfg"/>
	    	<set name="cardno"  expr="DELSPACE(cardno,'all')"/><!-- 卡号 -->
            <set name="accNo"   expr="cardno"/>
            <set name="qryCard" expr="DES_ENCRYPT(accNo)"/>
            
			<if condition="IS_EQUAL_STRING(cardno,'')">
				<set name="RspCod" value="01002" />
				<set name="RspMsg" value="请输入银行卡号" />
			</if>

			<do func="GetCrdInfo"><!-- 获取卡信息 -->
				<para name="CrdNo" expr="cardno" />
			</do>
			<if condition="#RetCod!=0">
				<set name="RspCod" value="01003" />
				<set name="RspMsg" value="系统不识别该卡，请换其他卡！" />
				<return />
			</if>
			<set name="BANKCARDTYPE" expr="SUBSTR(DCFLAG,2,1)" /><!-- 卡类型 01：借记卡 	02：信用卡 -->
			<if condition="IS_EQUAL_STRING(BANKCARDTYPE,'2')">
			    <set name="CARD_BANK_THREE" expr="DES_ENCRYPT(cvv2)" />
			    <set name="VALIDITY_M" expr="DES_ENCRYPT(month)" />
			    <if condition="NOT(ISNULL(year))">
				    <set name="expired" expr="SUBSTR(STRCAT(year,month),3,4)" />
				    <set name="VALIDITY_Y" expr="DES_ENCRYPT(SUBSTR(year,3,2))" />
			    </if>
			    <if condition="NOT(ISNULL(cvv2))">
				    <set name="cvn2" expr="cvv2" />
			    </if>
			</if>
			<set name="ISSBANKNAME" expr="ISSNAM" />
			<set name="BANKCODE" expr="ISSNO" />
			
			<if condition="IS_EQUAL_STRING(BANKCARDTYPE,'1')">
				<set name="accType" value="10" /><!--10-银行卡 30-信用卡 -->
				<set name="CARD_TYPE" value="00" />
			</if>
			<elseif condition="IS_EQUAL_STRING(BANKCARDTYPE,'2')">
				<set name="accType" value="30" /><!--10-银行卡 30-信用卡 -->
				<set name="CARD_TYPE" value="01" />
			</elseif>
			<else>
				<set name="MsgTyp" value="E" />
				<set name="RspCod" value="01003" />
				<set name="RspMsg" value="系统不识别该卡，请换其他卡！" />
				<return />
			</else>
			<set name="type_card" expr="BANKCARDTYPE" />

			<do func="ReadRecord" error="IGNORE">
				<para name="SqlCmd" sql="qryIdInfo" />
			</do>
			<if condition="NOT(ISNULL(DES_DECRYPT(cust_cred_no)))">
				<set name="idno" expr="DES_DECRYPT(cust_cred_no)" />
			</if>
			<set name="CUST_CRED_NO" expr="DES_ENCRYPT(cardno)" />
			<set name="PHONENO"      expr="DELSPACE(mob,'all')" /><!-- 手机号 -->
			<set name="bind_mob"     expr="PHONENO"/>
			<set name="cardno"       expr="cardno"/>
			<if condition="INTCMP(STRLEN(PHONENO),4,11)">
				<set name="MsgTyp" value="E" />
				<set name="RspCod" value="01111" />
				<return />
			</if>

			<set name="certifId" expr="idno" /><!-- 身份证号 -->
			<set name="CUSTOMERNM" expr="cust_name" /><!-- 姓名 -->
			<set name="CERTIFTP" value="01" /><!-- 证件类型 -->
			<!-- 获取序号 -->
			<do func="GetSeqNo" error="IGNORE">
				<para name="TblNam" value="stpseqrec" />
				<para name="KeyNam" value="KeyNam" />
				<para name="KeyVal" value="STPBANKTB_BAK_SEQ" />
				<para name="SeqNam" value="KeyVal" />
				<para name="Len" value="5" />
				<para name="Circle" value="1" />
			</do>

			<do func="ReadRecord" error="IGNORE">
				<para name="SqlCmd" sql="qrySamInfo" />
			</do>
			<if condition="#RetCod==0">
			    <set name="MsgTyp" value="E" />
				<set name="RspCod" value="01111" />
				<set name="RspMsg" value="已开通" />
			    <set name="PAGE" value="cashier/public/bankcardPay.jsp" />
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', PAGE)" />
			</if>			
			<if condition="#RetCod==2">
				<!-- 记录银行卡绑定信息 -->
				<set name="BAK_SEQ" expr="STRCAT(GETDATE(),KeyVal)" />
				<set name="CUST_ID" expr="userID" />
				<set name="CARD_BANK" expr="BANKCODE" />
				<set name="BANK_NAM" expr="ISSBANKNAME" />
				<set name="CARD_NO" expr="CUST_CRED_NO" />
				<set name="CARD_NAME" expr="cust_name" />
				<set name="BANK_RES_PHONE" expr="PHONENO" />
				<set name="BANK_CONF" value="0" />
				<do func="InsertRecord" error="IGNORE">
					<para name="TblNam" value="STPBANKTB" />
				</do>
				<do func="CommitWork" />

				<do func="WuTZOpen">
					<para name="channelType" value="07" />
					<para name="orderId" expr="GETDATETIME()" />
					<para name="accType" value="01" />
					<para name="encryptcertid" value="" />
				</do>
				<if condition="#RetCod!=0">
					<set name="MsgTyp" value="E" />
					<set name="RspCod" value="10005" />
					<set name="RspMsg" value="快捷支付开通失败！" />
					<!-- <return/> -->
				</if>
				<set name="no_agree" expr="BAK_SEQ" />
				<set name="MsgTyp" value="N" />
				<set name="RspCod" value="00000" />
				<set name="RspMsg" value="快捷支付开通成功！" />

				<do func="ExecSql" error="IGNORE">
					<para name="SqlCmd" sql="updateConfig" />
				</do>
				<if condition="#RetCod!=0">
					<set name="MsgTyp" value="E" />
					<set name="RspCod" value="09999" />
					<set name="RspMsg" value="系统错误" />
					<return />
				</if>
				<do func="CommitWork" />
			</if>
			
		    <!-- 手机号-部分内容星号隐藏 -->
           <set name="First"             expr="SUBSTR(bind_mob,1,3)"/> 
           <set name="End"               expr="SUBSTR(bind_mob,8,SUB(STRLEN(bind_mob),7))"/>
           <set name="BIND_MOB_FMT"      expr="STRCAT(First,'****',End)"/>
       
           <!-- 卡号解密-部分内容星号隐藏 -->
           <set name="First"             expr="SUBSTR(cardno,1,3)"/> 
           <set name="End"               expr="SUBSTR(cardno,SUB(STRLEN(cardno),3),STRLEN(cardno))"/>
           <set name="CARDNO_FMT"        expr="STRCAT(First,'****',End)"/>
		</process>
	</transaction>
	
	
<transaction code="openDaiShou" desc="开通银联代收">
	<sql name="updateConfig">
		update stpbanktb set bank_conf='1',AUTH_CODE=#{bind_Id} where
		bak_seq=#{BAK_SEQ}
	</sql>
	<sql name="qryIdInfo">
		select cust_cred_no from stpcusinf where cust_id=#{userID}
	</sql>
	<sql name="qrySamInfo">
		select BAK_SEQ as BANK_SEQ,CARD_NO from stpbanktb where cust_id=#{userID}
		and
		card_no=#{qryCard} and bank_conf='1'
	</sql>
	<sql name="bindAgain">
		update stpbanktb set BANK_RES_PHONE=#{PHONENO},AUTH_CODE=#{TOKENPAYDATA}
		where bak_seq=#{BAK_SEQ}
	</sql>
	<process>
		<!-- 检测用户登录状态 此交易必须是登录状态完成 -->
		<if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
			<set name="RspCod" value="01001" />
			<set name="RspMsg" value="用户登录平台不正确" />
			<return />
		</if>
		<set name="userID" expr="SESSIONS.USRID" />
		<if condition="ISNULL(userID)">
			<set name="MsgTyp" value="E" />
			<set name="RspCod" value="02000" />
			<set name="RspMsg" value="用户登录超时" />
			<return />
		</if>
		
		<set name="cardno" expr="DELSPACE(cardno,'all')" /><!-- 卡号 -->
		<set name="accNo" expr="cardno" />
		<set name="qryCard" expr="DES_ENCRYPT(accNo)" />

		<if condition="IS_EQUAL_STRING(cardno,'')">
			<set name="RspCod" value="01002" />
			<set name="RspMsg" value="请输入银行卡号" />
		</if>

		<do func="GetCrdInfo"><!-- 获取卡信息 -->
			<para name="CrdNo" expr="cardno" />
		</do>
		<if condition="#RetCod!=0">
			<set name="RspCod" value="01003" />
			<set name="RspMsg" value="系统不识别该卡，请换其他卡！" />
			<return />
		</if>
		<set name="BANKCARDTYPE" expr="SUBSTR(DCFLAG,2,1)" /><!-- 卡类型 01：借记卡 
			02：信用卡 -->
		<if condition="IS_EQUAL_STRING(BANKCARDTYPE,'2')">
			<set name="RspCod" value="01004" />
			<set name="RspMsg" value="该卡号为信用卡，请填写正确的储蓄卡号！" />
			<return />
		</if>

		<set name="ISSBANKNAME" expr="ISSNAM" />
		<set name="BANKCODE" expr="ISSNO" />

		<if condition="IS_EQUAL_STRING(BANKCARDTYPE,'1')">
			<set name="accType" value="10" /><!--10-银行卡 30-信用卡 -->
			<set name="CARD_TYPE" value="00" />
		</if>
		<else>
			<set name="MsgTyp" value="E" />
			<set name="RspCod" value="01003" />
			<set name="RspMsg" value="系统不识别该卡，请换其他卡！" />
			<return />
		</else>
		<set name="type_card" expr="BANKCARDTYPE" />

		<do func="ReadRecord" error="IGNORE">
			<para name="SqlCmd" sql="qryIdInfo" />
		</do>
		<if condition="NOT(ISNULL(DES_DECRYPT(cust_cred_no)))">
			<set name="idno" expr="DES_DECRYPT(cust_cred_no)" />
		</if>
		<set name="CUST_CRED_NO" expr="DES_ENCRYPT(cardno)" />
		<set name="PHONENO" expr="DELSPACE(mob,'all')" /><!-- 手机号 -->
		<set name="bind_mob" expr="PHONENO" />
		<set name="cardno" expr="cardno" />
		<if condition="INTCMP(STRLEN(PHONENO),4,11)">
			<set name="MsgTyp" value="E" />
			<set name="RspCod" value="01005" />
			<set name="RspMsg" value="预留手机号码格式不正确" />
			<return />
		</if>

		<set name="certifId" expr="idno" /><!-- 身份证号 -->
		<set name="CUSTOMERNM" expr="cust_name" /><!-- 姓名 -->
		<set name="CERTIFTP" value="01" /><!-- 证件类型 -->
		<!-- 获取序号 -->
		<do func="GetSeqNo" error="IGNORE">
			<para name="TblNam" value="stpseqrec" />
			<para name="KeyNam" value="KeyNam" />
			<para name="KeyVal" value="STPBANKTB_BAK_SEQ" />
			<para name="SeqNam" value="KeyVal" />
			<para name="Len" value="5" />
			<para name="Circle" value="1" />
		</do>


		<do func="ReadRecord" error="IGNORE">
			<para name="SqlCmd" sql="qrySamInfo" />
		</do>
		<if condition="#RetCod==0">
			<set name="MsgTyp" value="E" />
			<set name="RspCod" value="01111" />
			<set name="RspMsg" value="该银行卡已开通快捷支付" />
			<set name="PAGE" value="cashier/public/bankcardPay.jsp" />
			<set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('html/', PAGE)" />
		</if>
		<if condition="#RetCod==2">
			<!-- 记录银行卡绑定信息 -->
			<set name="BAK_SEQ" expr="STRCAT(GETDATE(),KeyVal)" />
			<set name="CUST_ID" expr="userID" />
			<set name="CARD_BANK" expr="BANKCODE" />
			<set name="BANK_NAM" expr="ISSBANKNAME" />
			<set name="CARD_NO" expr="CUST_CRED_NO" />
			<set name="CARD_NAME" expr="cust_name" />
			<set name="BANK_RES_PHONE" expr="PHONENO" />
			<set name="BANK_CONF" value="0" />
			<do func="InsertRecord" error="IGNORE">
				<para name="TblNam" value="STPBANKTB" />
			</do>
			<do func="CommitWork" />

			<!-- 获取绑定标识符序号 -->
			<do func="GetSeqNo" error="IGNORE">
				<para name="TblNam" value="stpseqrec" />
				<para name="KeyNam" value="KeyNam" />
				<para name="KeyVal" value="STPBANKTB_AUTH_CODE" />
				<para name="SeqNam" value="KeyVal" />
				<para name="Len" value="5" />
				<para name="Circle" value="1" />
			</do>
			<set name="bind_Id" expr="STRCAT(GETDATETIME(),KeyVal)" />
			<do func="DaiShou_RealAuth_Back_BindId">
				<para name="merId" value="777290058110097" />       	   <!--商户号 -->
				<para name="orderId" expr="BAK_SEQ" />     	   <!--商户订单号 -->
				<para name="txnTime" expr="GETDATETIME()" />     	   <!--交易时间yyyyMMddHHmmss -->
				<para name="bindId" expr="bind_Id" />      	   <!--绑定标识号 -->
				<para name="certifId" value="341126197709218366" />    	   <!--证件号码 -->
				<para name="customerNm" value="全渠道" />  	   <!--姓名 -->
				<para name="phoneNo" value="13552535506" />     	   <!--手机号 -->
				<para name="cvn2" value="" />        	   <!--卡背面的cvn2三位数字 -->
				<para name="expired" value="" />     	   <!--有效期年在前月在后 -->
				<para name="accNo" value="6216261000000000018" />       	   <!--卡号 -->
				<para name="cardType" value="01" />       	   <!--卡类型  -->
			</do>
			<if condition="#RetCod!=0">
				<set name="MsgTyp" value="E" />
				<set name="RspCod" value="10006" />
				<set name="RspMsg" expr="RspMsg" />
				<return />
			</if>
			<else>
				<do func="ExecSql" error="IGNORE">
					<para name="SqlCmd" sql="updateConfig" />
				</do>
				<if condition="#RetCod!=0">
					<set name="MsgTyp" value="E" />
					<set name="RspCod" value="09999" />
					<set name="RspMsg" value="系统错误" />
					<return />
				</if>
				<do func="CommitWork" />
			</else>
		</if>

		<!-- 手机号-部分内容星号隐藏 -->
		<set name="First" expr="SUBSTR(bind_mob,1,3)" />
		<set name="End" expr="SUBSTR(bind_mob,8,SUB(STRLEN(bind_mob),7))" />
		<set name="BIND_MOB_FMT" expr="STRCAT(First,'****',End)" />

		<!-- 卡号解密-部分内容星号隐藏 -->
		<set name="First" expr="SUBSTR(cardno,1,3)" />
		<set name="End" expr="SUBSTR(cardno,SUB(STRLEN(cardno),3),STRLEN(cardno))" />
		<set name="CARDNO_FMT" expr="STRCAT(First,'****',End)" />
	</process>
</transaction>
</application>
