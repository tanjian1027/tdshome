<?xml version='1.0' encoding='UTF-8'?>
<application name="STP" code="100" log_level="DEBUG">
   <!--交易日志记录配置-->
   <include file="etc/public/STPCTL_TRC.XML"/>
   
   <!-- 公共宏文件引入-->
   <include file="etc/public/Order_MACRO.XML"/>
   
   <!-- 交易前处理 -->
   <before>
      <do func="GetOwnButton"/> 
      <do func="DumpEtf"/>
      <set name="ACTDAT"   expr="GETDATE()"/>
      <!--翻页每页显示的条数-->
      <set name="NumPerPag"                    value="19"/>
   </before>
   
   <!-- 交易后处理 -->
   <after>
      <if condition="IS_EQUAL_STRING(RspCod,'00000')">
         <set name="MsgTyp"       value="N"/>
      </if>
      <else>
         <set name="MsgTyp"       value="E"/>
      </else>
      <do func="DumpEtf"/>
   </after>
    
    <transaction code="100000"   desc="测试数据字典工具类_初始化数据只内存">
        <process>
            <do func="InitDictInf" error="IGNORE"/>
        </process>
    </transaction>
    
   <transaction code="411060" desc="查看商品订单单条数据">
      <sql name="queryStat">
         SELECT t.prdordno,t.merno,t.versionid,t.prdordtype,t.biztype,t.ordertime,
                TO_CHAR(to_number(t.ordamt)/100,'FM9999,999,999,990.00') ordamt ,t.ordamt txnamt,t.ordstatus,t.ordccy,t.notifyurl,t.returl,t.signature,t.signtype,t.verifystring,
                t.prddisurl,t.prdname,t.prdshortname,t.prddesc,t.merremark,t.rpttype,t.prdunitprice,t.buycount,t.defpayway,t.cust_id,t.merpayacno,t.sellrptacno,
                t.payMode,t.custPayAcNo,t.custRptAcNo,t.TranSort,TO_CHAR(to_number(t.noncashAmt)/100,'FM9999,999,999,990.00') noncashAmt,t.acJrnNo,t.Actime,
                nvl(TO_CHAR(to_number(t.txnComAmt)/100,'FM9999,999,999,990.00'),0) txnComAmt,TO_CHAR(to_number(nvl(t.rfTotalAmt,0))/100,'FM9999,999,999,990.00') rfTotalAmt,
                TO_CHAR(to_number(nvl(t.rfComAmt,0))/100,'FM9999,999,999,990.00') rfComAmt,t.BankError,t.payError,t.stlsts,t.stlBatno,t.cpsflg,t.payOrdNo,to_char(to_date(t.cxTime,'yyyymmdd'),'yyyy-mm-dd') cxTime,
                t.filed1,t.filed2,t.filed3,t.filed4,t.filed5,nvl(t.rfTotalAmt,0) rftotamt 
           FROM stpprdinf t 
          WHERE t.prdordno=#{prdordno} and t.merno=#{merno}
      </sql>
      <process>
         <do func="ReadRecord"             error="IGNORE">
           <para name="SqlCmd"             sql="queryStat" />
         </do>
         <if condition="#RetCod!=0">
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         value="查询信息失败" />
            <return/>
         </if>
         <if condition="#RetCod==2">
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         value="没有符合条件的数据" />
            <return/>
         </if>
         <set name="rfamt" expr="AMTADDDOT(SUB(txnamt,rftotamt))"/>
         <set name="DWZ_STATUS_CODE"     value="200"/>
         <set name="DWZ_RSP_MSG"         value="查询成功"/>
         <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('WEB-INF/html/',operating)"/>
      </process>
   </transaction>
    
    <transaction code="411061" desc="商品订单列表查询">
        <sql name="queryPrdOrdInf"><!--查询商品订单信息表  -->
            SELECT t.ordertime at,t.prdordno,t.merno,t.prdordtype,t.ordstatus,
                   case when t.ordertime !=' ' then TO_CHAR(to_date(t.ordertime,'yyyymmddhh24miss'),'yyyy-mm-dd  hh24:mi:ss')end ordertime,
                   TO_CHAR(to_number(t.ordamt)/100,'FM9999,999,999,990.00') ordamt ,
                   t.cust_id, t.payOrdNo,t.ordamt sordamt,nvl(t.RFTOTALAMT,0) SRFTOTALAMT,
                   u.CUST_LOGIN,c.CUST_NAME,
                   t.prdordtype as PRDORDTYPE_CC_PRDORDTYPE,
                   t.ordstatus as ordstatus_CC_PRDORDSTATUS,
                    case when p.actdat !=' ' then TO_CHAR(to_date(p.actdat,'yyyymmddhh24miss'),'yyyy-mm-dd  hh24:mi:ss')end actdat 
              FROM vw_stpprdinf t left join stpusrinf u on t.cust_id = u.cust_id 
                   left join stpcusinf c on t.cust_id = c.cust_id 
                   left join stppayinf p on t.prdordno = p.prdordno and p.payordno = t.payordno
             WHERE t.prdOrdType in('0','2') 
               AND (t.prdordno = #{prdordno} or ' '= #{prdordno}||' ')
               AND (t.merNo = #{merNo} or ' '= #{merNo}||' ')
               AND (t.OrdStatus = #{OrdStatus} or ' '= #{OrdStatus}||' ')
               AND (t.payOrdNo = #{payOrdNo} or ' '= #{payOrdNo}||' ') 
               AND (u.CUST_LOGIN = #{CUST_LOGIN} or ' '= #{CUST_LOGIN}||' ') 
               AND t.ordAmt BETWEEN to_number(#{ordAmt1_temp}) AND to_number(#{ordAmt2_temp}) 
               AND t.orderTime BETWEEN #{begin_date_temp} AND #{end_date_temp}
               ${txnDate} 
          ORDER BY t.orderTime desc,t.prdordno,t.merNo
        </sql>
        <sql name="queryPrdOrdInfCount"><!--查询商品订单信息表  -->
            SELECT COUNT(*) as SUMCOT, TO_CHAR(to_number(SUM(t.ordamt))/100,'FM9999,999,999,990.00') SUMAMT 
              FROM vw_stpprdinf t left join stpusrinf u on t.cust_id = u.cust_id 
              		 left join stppayinf p on t.prdordno = p.prdordno and p.payordno = t.payordno
             WHERE t.prdOrdType in('0','2') 
               AND (t.prdordno = #{prdordno} or ' '= #{prdordno}||' ')
               AND (t.merNo = #{merNo} or ' '= #{merNo}||' ')
               AND (t.OrdStatus = #{OrdStatus} or ' '= #{OrdStatus}||' ')
               AND (t.payOrdNo = #{payOrdNo} or ' '= #{payOrdNo}||' ') 
               AND (u.CUST_LOGIN = #{CUST_LOGIN} or ' '= #{CUST_LOGIN}||' ') 
               AND t.ordAmt BETWEEN to_number(#{ordAmt1_temp}) AND to_number(#{ordAmt2_temp}) 
               AND t.orderTime BETWEEN #{begin_date_temp} AND #{end_date_temp}
               ${txnDate} 
          ORDER BY t.orderTime desc,t.prdordno,t.merNo
        </sql>
        <process>
            <set name="prdordno"        expr="DELBOTHSPACE(prdordno)"/>
            <set name="ordAmt"          expr="DELBOTHSPACE(ordAmt)"/>
            <set name="ordAmt1"         expr="DELBOTHSPACE(ordAmt1)"/>
            <set name="ordAmt2"         expr="DELBOTHSPACE(ordAmt2)"/>
            <set name="merNo"           expr="DELBOTHSPACE(merNo)"/>
            <set name="OrdStatus"       expr="DELBOTHSPACE(OrdStatus)"/>
            <set name="PRDSHORTNAME"    expr="DELBOTHSPACE(PRDSHORTNAME)"/>
            <set name="payOrdNo"        expr="DELBOTHSPACE(payOrdNo)"/>
            <set name="paytype"         expr="DELBOTHSPACE(paytype)"/>
            <set name="begin_date"      expr="DELBOTHSPACE(begin_date)"/>
            <set name="end_date"        expr="DELBOTHSPACE(end_date)"/>
            <set name="pay_begin_date"      expr="DELBOTHSPACE(pay_begin_date)"/>
            <set name="pay_end_date"        expr="DELBOTHSPACE(pay_end_date)"/>
            <set name="CUST_LOGIN"      expr="DELBOTHSPACE(CUST_LOGIN)"/>
            <set name="operating"       value="bankmessage/goods_list.jsp"/>
            <set name="fh" 							value="'" />
            
            <if condition="ISNULL(PageNum)">
                <set name="PageNum"     value="1"/>
            </if>
            <if condition="ISNULL(NumPerPag)">
                <set name="NumPerPag"   value="19"/>
            </if>
            
            <set name="begin_date_temp"     value="19700101" />
            <set name="end_date_temp"       value="20991231" />
            <set name="ordAmt1_temp"        value="0"        />
            <set name="ordAmt2_temp"        value="999999999999999"/>
            
            <if condition="NOT(ISNULL(begin_date))">
                <set name="begin_date_temp" expr="begin_date" />
            </if>
            <if condition="NOT(ISNULL(end_date))">
                <set name="end_date_temp"   expr="end_date" />
            </if>
            <if condition="NOT(ISNULL(ordAmt1))">
                <set name="ordAmt1_temp"    expr="AMTPOWER(ordAmt1,2)" />
            </if>
            <if condition="NOT(ISNULL(ordAmt2))">
                <set name="ordAmt2_temp"    expr="AMTPOWER(ordAmt2,2)" />
            </if>
            
            <set name="begin_date_temp" expr="STRCAT(begin_date_temp,'000000')" />
            <set name="end_date_temp"   expr="STRCAT(end_date_temp  ,'235959')" />
            
       
            <if condition="DOUBLECMP(ordAmt1_temp,6,ordAmt2_temp)">
                <set name="RsgCod"              value="01001"   />
                <set name="RsgMsg"              value="最小金额不能大于最大金额"/>
                <set name="DWZ_STATUS_CODE"     value="300"     />
                <set name="DWZ_RSP_MSG"         expr="RsgMsg"   />
                <return/>
            </if>
            
            <if condition="INTCMP(STRCMP(begin_date_temp,end_date_temp),6,0)">
                <set name="RsgMsg"          value="01002"   />
                <set name="RspMsg"          value="订单开始日期不能早于结束日期"/>
                <set name="DWZ_STATUS_CODE" value="300"     />
                <set name="DWZ_RSP_MSG"     expr="RspMsg"   />
                <return/>
            </if>
            
            <if condition="AND(NOT(ISNULL(pay_begin_date)),NOT(ISNULL(pay_end_date)))">
                <if condition="INTCMP(STRCMP(pay_begin_date,pay_end_date),6,0)">
                	<set name="RsgMsg"          value="01002"   />
                	<set name="RspMsg"          value="支付开始日期不能早于结束日期"/>
                	<set name="DWZ_STATUS_CODE" value="300"     />
                	<set name="DWZ_RSP_MSG"     expr="RspMsg"   />
                	<return/>
            		</if>
            		<set name="pay_begin_date_temp" expr="STRCAT(pay_begin_date,'000000')" />
            		<set name="pay_end_date_temp"   expr="STRCAT(pay_end_date  ,'235959')" />
            		<set name="txnDate" expr="STRCAT(' AND p.actdat BETWEEN  ',fh,pay_begin_date_temp,fh,' AND ',fh,pay_end_date_temp,fh)"/>
            </if>
            <elseif condition="AND(NOT(ISNULL(pay_begin_date)),ISNULL(pay_end_date))">
                <set name="pay_begin_date_temp" expr="STRCAT(pay_begin_date,'000000')" />
            		<set name="pay_end_date_temp"   value="20991231235959" />
            		<set name="txnDate" expr="STRCAT(' AND p.actdat BETWEEN  ',fh,pay_begin_date_temp,fh,' AND ',fh,pay_end_date_temp,fh)"/>
            </elseif>
            <elseif condition="AND(ISNULL(pay_begin_date),NOT(ISNULL(pay_end_date)))">
                <set name="pay_begin_date_temp" value="19700101000000" />
            		<set name="pay_end_date_temp"   expr="STRCAT(pay_end_date  ,'235959')" />
            		<set name="txnDate" expr="STRCAT(' AND p.actdat BETWEEN  ',fh,pay_begin_date_temp,fh,' AND ',fh,pay_end_date_temp,fh)"/>
            </elseif>
            <else>
            	<set name="txnDate" value=""/>
            </else>
            <!-- 设置下拉框 商品订单状态 -->
            <set name="DICTNAME_PRDORDSTATUS"  expr="STRCAT('PRDORDSTATUS:',OrdStatus)"/>
            <do func="CreateDictOption" error="IGNORE">
                <para name="DictCodes"    expr="DICTNAME_PRDORDSTATUS"/>
            </do>
            
            <do func="ReadRecord" error="ignore">
                <para name="SqlCmd" sql="queryPrdOrdInfCount" />
            </do>
            
            <do func="PagedQuery" error="ignore">
                <para name="PageNum"    expr="PageNum"      />
                <para name="NumPerPag"  expr="NumPerPag"    />
                <para name="Sql"        sql="queryPrdOrdInf"/>
            </do>
            
            <if condition="#RetCod==2">
                <set name="RspCod"          value="329999"/>
                <set name="RspMsg"          value="无信息" />
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG"     expr="RspMsg"/>
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('WEB-INF/html/',operating)"/>
                <return/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"  value="329999"/>
                <set name="RspMsg"  value="查询商品订单信息失败" />
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('WEB-INF/html/',operating)"/>
                <return/>
            </elseif>
            
            <do func="FormatDict2Etf" error="IGNORE"/>
            
            <set name="RspCod"  value="00000"/>
            <set name="RspMsg"  value="查询商品订单信息成功"/>
            <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('WEB-INF/html/',operating)"/>
        </process>
   </transaction>

    <transaction code="411065" desc="商品订单查看详情">
        <sql name="queryStatById">
            SELECT f.paytype,
                   inf.cust_login,
                   c.CUST_NAME,
                   t.prdordno,t.merno,t.versionid,t.prdordtype,t.biztype,t.payOrdNo,t.prdname,t.prddesc,t.cust_id,t.ordstatus,
                   TO_CHAR(to_date(t.ordertime,'yyyymmddhh24miss'),'yyyy-mm-dd  hh24:mi:ss') ordertime,
                   TO_CHAR(to_number(t.ordamt)/100,'FM9999,999,999,990.00') ordamt,
                   TO_CHAR(to_number(nvl(t.txnComAmt,0))/100,'FM9999,999,999,990.00') txnComAmt,
                   TO_CHAR(to_number(nvl(t.rfTotalAmt,0))/100,'FM9999,999,999,990.00') rfTotalAmt
             FROM stpprdinf t left join stpPayInf f on t.payordno=f.payordno 
                  left join stpcusinf c on t.cust_id = c.cust_id left join   stpusrinf inf on c.cust_id = inf.cust_id 
            WHERE  t.prdOrdType in('0','2','3','4') 
              AND t.prdordno = #{prdordno} 
              AND t.merno = #{merno}
        </sql>
        <process>
            <do func="ReadRecord"   error="IGNORE">
                <para name="SqlCmd" sql="queryStatById" />
            </do>
            <if condition="#RetCod==2">
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG"     value="没有符合条件的数据" />
                <return/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG"     value="查询信息失败" />
                <return/>
            </elseif>
            
            <!-- 获取数据字典中文 -->
            <set name="DICTNAME_STR"  expr="STRCAT('PRDORDSTATUS:',ORDSTATUS,',PAYTYPE:',PAYTYPE,',PRDORDTYPE:',prdordtype)"/>
            <do func="GetDictCh" error="IGNORE">
                <para name="DictCodes"    expr="DICTNAME_STR"/>
            </do>
            
            <set name="DWZ_STATUS_CODE" value="200"/>
            <set name="DWZ_RSP_MSG"     value="查询成功"/>
            <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('WEB-INF/html/',operating)"/>
        </process>
    </transaction>
    
    <transaction code="41106502" desc="商品订单对应支付订单信息列表">
        <sql name="queryPayListInf"><!-- 支付订单信息列表 -->   
            SELECT a.PAYORDNO,a.ORDSTATUS as ORDSTATUS_CC_ORDSTATUS,
                   a.PRDORDTYPE as PRDORDTYPE_CC_PRDORDTYPE,
                   a.PAYTYPE as PAYTYPE_CC_PAYTYPE,
                   (select bank_name from coopbank where bank_code = a.BANKCOD) as BANKCOD_CH,
                   TO_CHAR(TO_NUMBER(a.TXAMT)/100,'FM9999,999,999,990.00') TXAMT2,
                   TO_CHAR(TO_DATE(a.ACTDAT,'yyyyMMddHH24miss'),'yyyy-MM-dd HH24:mi:ss') as ACTDAT2
              FROM STPPAYINF a 
             WHERE a.PRDORDNO = #{prdordno} and MerNo = #{merno}
          ORDER BY a.ACTDAT ASC
        </sql> 
        <sql name="queryPrdOrdInf"><!-- 商品订单信息 -->   
            SELECT ORDSTATUS,PAYORDNO 
              FROM STPPRDINF  
             WHERE PRDORDNO = #{prdordno} and MerNo = #{merno}
        </sql>
        <process>
            <set name="PRDORDNO"    expr="DELBOTHSPACE(PRDORDNO)"           />
            <set name="operating"   value="bankmessage/goods_pay_list.jsp"  />
            <if condition="ISNULL(PageNum)">
                <set name="PageNum" value="1"/>
            </if>
            <if condition="ISNULL(NumPerPag)">
                <set name="NumPerPag"           value="19"/>
            </if>
            <do func="PagedQuery" error="ignore"> 
                <para name="PageNum"    expr="PageNum"       />
                <para name="NumPerPag"  expr="NumPerPag"     />
                <para name="Sql"        sql="queryPayListInf"/>
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"             value="329999"/>
                <set name="RspMsg"             value="无信息" />
                <set name="DWZ_STATUS_CODE"    value="300"/>
                <set name="DWZ_RSP_MSG"        value="无信息" />
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('WEB-INF/html/',operating)"/>
                <return/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"             value="329999"/>
                <set name="RspMsg"             value="查询支付信息表失败" />
                <set name="DWZ_STATUS_CODE"    value="400"/>
                <set name="DWZ_RSP_MSG"        value="查询支付信息表失败" />
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('WEB-INF/html/',operating)"/>
                <return/>
            </elseif>
            
            <do func="FormatDict2Etf" error="IGNORE"/>
            
            <do func="ReadRecord"   error="IGNORE">
                <para name="SqlCmd" sql="queryPrdOrdInf"/>
            </do>
            
            <set name="RspCod"             value="00000"/>
            <set name="RspMsg"             value="查询支付信息表成功"/>
            <set name="DWZ_STATUS_CODE"    value="200"/>
            <set name="DWZ_RSP_MSG"        expr="RspMsg" />
            <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('WEB-INF/html/',operating)"/>
        </process>
    </transaction>
    
    <transaction code="411066" desc="退款列表查询">
        <sql name="queryrefundInf">   <!--退款列表查询  -->   
            SELECT case when t.rfOrdTime !=' ' then To_Char(to_date(t.rfOrdTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end rfOrdTime,
                   t.rfPayOrdNo,t.bankjrnno,t.refordno,
                   case when t.rfreqdate != ' ' then TO_CHAR(to_date(t.rfreqdate,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end rfreqdate,
                   t.oriprdordno,t.oripayordno,t.bankcode,t.bankpayusernm,t.txccy,
                   TO_CHAR(to_number(t.rfamt)/100,'FM9999,999,999,990.00') rfamt,
                   TO_CHAR(to_number(t.fee)/100,'FM9999,999,999,990.00') fee,t.rfsake,
                   TO_CHAR(to_number(nvl(t.MULAMT,0))/100,'FM9999,999,999,990.00') MULAMT,
                   TO_CHAR(to_number(nvl(t.ACCAMT,0))/100,'FM9999,999,999,990.00') ACCAMT,
                   TO_CHAR(to_number(t.netrecamt)/100,'FM9999,999,999,990.00') netrecamt,
                   t.ordstatus,t.bankstldate,t.notifyurl,t.bankerror,t.merno,t.filed1,inf.cust_login,
                   (select CUST_LOGIN from stpusrinf where cust_id=t.CUST_ID) as CUST_ID
              FROM StpRefInf t left join stpusrinf inf on t.cust_id=inf.cust_id
             WHERE (t.CUST_ID = #{CUST_ID} or ' '= #{CUST_ID}||' ')
               AND (t.OrdStatus = #{OrdStatus} or ' '= #{OrdStatus}||' ')
               AND (t.refOrdNo = #{refOrdNo} or ' '= #{refOrdNo}||' ')
               AND (t.ORIPRDORDNO = #{ORIPRDORDNO} or ' '= #{ORIPRDORDNO}||' ') 
               AND t.rfOrdTime BETWEEN #{begin_date_temp} AND #{end_date_temp}  
               AND (inf.cust_login like '%'||#{cust_login}||'%' or ' '= #{cust_login}||' ') 
               AND t.rfAmt BETWEEN to_number(#{ordAmt1_temp}) AND to_number(#{ordAmt2_temp}) 
             ORDER BY t.rfOrdTime desc,t.rfreqdate desc,t.bankCode ,t.OrdStatus
        </sql>
        <sql name="QryReFundCount">
            SELECT nvl(count(*),0) sumcot1,nvl(sum(t.rfamt/100),0.00) sumamt1 
              FROM StpRefInf t,stpusrinf inf 
             WHERE t.cust_id=inf.cust_id 
               AND (t.CUST_ID = #{CUST_ID} or ' '= #{CUST_ID}||' ')
               AND (t.OrdStatus = #{OrdStatus} or ' '= #{OrdStatus}||' ')
               AND (t.refOrdNo = #{refOrdNo} or ' '= #{refOrdNo}||' ')
               AND (t.ORIPRDORDNO = #{ORIPRDORDNO} or ' '= #{ORIPRDORDNO}||' ') 
               AND t.rfOrdTime BETWEEN #{begin_date_temp} AND #{end_date_temp} 
               AND (inf.cust_login like '%'||#{cust_login}||'%' or ' '= #{cust_login}||' ') 
               AND t.rfAmt BETWEEN to_number(#{ordAmt1_temp}) AND to_number(#{ordAmt2_temp}) 
        </sql>
        <process>
            <set name="CUST_ID"     expr="DELBOTHSPACE(CUST_ID)"/>
            <set name="OrdStatus"   expr="DELBOTHSPACE(OrdStatus)"/>
            <set name="refOrdNo"    expr="DELBOTHSPACE(refOrdNo)"/>
            <set name="rfreqdate"   expr="DELBOTHSPACE(rfreqdate)"/>
            <set name="ORIPRDORDNO" expr="DELBOTHSPACE(ORIPRDORDNO)"/>
            <set name="CUST_LOGIN"  expr="DELBOTHSPACE(CUST_LOGIN)"/>
            <set name="operating"   value="bankmessage/refund_list.jsp"/>
          
            <if condition="ISNULL(PageNum)">
               <set name="PageNum"             value="1"/>
            </if>
            <if condition="ISNULL(NumPerPag)">
               <set name="NumPerPag"           value="19"/>
            </if>
            <set name="begin_date_temp"     value="19700101" />
            <set name="end_date_temp"       value="20991231" />
            <set name="ordAmt1_temp"        value="0"        />
            <set name="ordAmt2_temp"        value="999999999999999"/>
            
            <if condition="NOT(ISNULL(begin_date))">
                <set name="begin_date_temp" expr="begin_date" />
            </if>
            <if condition="NOT(ISNULL(end_date))">
                <set name="end_date_temp"   expr="end_date" />
            </if>
            <if condition="NOT(ISNULL(ordAmt1))">
                <set name="ordAmt1_temp"    expr="AMTPOWER(ordAmt1,2)" />
            </if>
            <if condition="NOT(ISNULL(ordAmt2))">
                <set name="ordAmt2_temp"    expr="AMTPOWER(ordAmt2,2)" />
            </if>
            
            <set name="begin_date_temp" expr="STRCAT(begin_date_temp,'000000')" />
            <set name="end_date_temp"   expr="STRCAT(end_date_temp  ,'235959')" />
            
            <do func="ReadRecord"   error="IGNORE">
                <para name="SqlCmd" sql="QryReFundCount" />
            </do>
            
            <do func="PagedQuery" error="ignore"> 
                <para name="PageNum"    expr="PageNum"/>
                <para name="NumPerPag"  expr="NumPerPag"/>
                <para name="Sql"        sql="queryrefundInf"/>
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"             value="329999"/>
                <set name="RspMsg"             value="无信息" />
                <set name="DWZ_STATUS_CODE"    value="300"/>
                <set name="DWZ_RSP_MSG"        value="无信息" />
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('WEB-INF/html/',operating)"/>
                <return/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"             value="329999"/>
                <set name="RspMsg"             value="查询退款表信息失败" />
                <set name="DWZ_STATUS_CODE"    value="400"/>
                <set name="DWZ_RSP_MSG"        value="查询退款表信息失败" />
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('WEB-INF/html/',operating)"/>
                <return/>
            </elseif>
        
            <set name="RspCod"             value="00000"/>
            <set name="RspMsg"             value="查询退款表信息成功"/>
            <set name="DWZ_STATUS_CODE"    value="200"/>
            <set name="DWZ_RSP_MSG"        expr="RspMsg" />
            <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('WEB-INF/html/',operating)"/>
            <return/>
        </process>
    </transaction>

   <transaction code="411067" desc="查询退款详情">
    <sql name="qryrefById">
      SELECT case when t.rfOrdTime !=' ' then To_Char(to_date(t.rfOrdTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end rfOrdTime,
                   t.rfPayOrdNo,t.refordno, t.rfSake,t.bankerror,
                   case when t.rfreqdate != ' ' then TO_CHAR(to_date(t.rfreqdate,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end rfreqdate,
                   t.oriprdordno,t.bankcode,t.bankpayusernm,t.txccy,t.bankjrnno,
                   TO_CHAR(to_number(t.rfamt)/100,'FM9999,999,999,990.00') rfamt,
                   TO_CHAR(to_number(t.fee)/100,'FM9999,999,999,990.00') fee,
                   TO_CHAR(to_number(t.netrecamt)/100,'FM9999,999,999,990.00') netrecamt,
                   t.ordstatus,t.merno,t.filed1,inf.cust_login,
                   (select CUST_LOGIN from stpusrinf where cust_id=t.CUST_ID) as CUST_ID
        FROM StpRefInf t left join stpusrinf inf on t.cust_id=inf.cust_id  
             WHERE   t.refOrdNo=#{refOrdNo}
     </sql>
    <process>
         <do func="ReadRecord"            error="IGNORE">
           <para name="SqlCmd"              sql="qryrefById" />
         </do>
         <if condition="#RetCod==2">
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         value="没有符合条件的数据" />
            <return/>
         </if>
         <elseif condition="#RetCod!=0">
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         value="查询信息失败" />
            <return/>
         </elseif>
         
         <set name="DWZ_STATUS_CODE"     value="200"/>
         <set name="DWZ_RSP_MSG"         value="查询成功"/>
         <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('WEB-INF/html/',operating)"/>
 
    </process>
   </transaction>   
    
   <transaction code="565119" desc="线上退款结果处理">
      <sql name="QryStpRefInf">
        select refOrdNo,merno,fee rfFee, oriPrdOrdNo prdOrdNo,OrdStatus,rfAmt,oriPayOrdNo payOrdNo,bankcode,bankPayAcNo,bankPayUserNm 
        from stprefinf where refOrdNo=#{refOrdNo}
      </sql>
      <sql name="SelMaStatus">  <!--查询客户账户状态 -->
        select a.AC_STATUS,nvl(cash_ac_bal,0)-nvl(FROZ_BALANCE,0) cashacbal,a.PAY_AC_NO merpayno 
        from ARP_AC_PROFILE a,ARP_AC_CUST_REL b 
        where a.PAY_AC_NO=b.PAY_AC_NO and b.cust_id =#{merno}
      </sql>
      <sql name="QryStpPayInf"><!-- 查询支付方式 -->
       select s.ORDSTATUS paystatus,payType,MulType,fee,nvl(accAmt,0) accAmt,nvl(mulAmt,0) mulAmt,t.bizType,t.ordamt,cust_id ruserid,
       bankcod,nvl(rfTotalAmt,0) rftotalamt,prodcode,netRecAmt,t.PrdOrdType,prdordsts,nvl(0,0) as prdRfComAmt 
       from stppayinf s,
       (select ordamt,bizType,rfTotalAmt,PrdOrdType,payordno,ORDSTATUS prdordsts,nvl(0,0) asrfComAmt,prodcode
        from stpprdinf where payordno = #{PayOrdNo}) t 
       where s.payordno=t.payordno and t.payOrdNo=#{PayOrdNo}
      </sql>
      <sql name="UpdStatus">
         update stprefinf set OrdStatus=#{ORDSTATUS},rfReqDate=#{rfReqDate},oper_id=#{operid}  where refOrdNo=#{refOrdNo}
      </sql>
      <sql name="chkMerStatus">
         select fee_code as feeCode, RF_COMM_FLG as rfCommFlg, RF_REC_FEE_FLG as rfRecFeeFlg,
         RF_REC_FEE_CODE as rfRecFeeCode from ARP_CUST_FEE 
         where pay_ac_no in (select pay_ac_no from arp_ac_cust_rel where CUST_ID=#{merNo}) 
         and pay_type=#{payType}
      </sql>
       <sql name="SelFrzInf">
         select PAY_AC_NO,FROZ_AMT,BIZ_CODE,STATUS,FROZ_NO from ARP_AC_FORZZ_DETAILS where BIZ_CODE=#{refOrdNo} and STATUS='01'
       </sql>
       <sql name="UpdFrezInf"><!-- 更新冻结信息-->
          UPDATE ARP_AC_FORZZ_DETAILS SET STATUS='00',LST_UPT_DATE=#{LST_UPT_DATE},LST_UPT_TIME=#{LST_UPT_TIME}  WHERE FROZ_NO=#{FROZ_NO}
       </sql>
      <process>
           
           <!--退款审核状态: 1同意2拒绝 -->
           <set name="result"   expr="DELBOTHSPACE(RESULT)"/>
           <set name="refOrdNo" expr="refOrdNo"/>
           <set name="operid"   expr="SESSIONS.UID"/><!--当前操作员id-->
           
           <!--查询退款订单-->
           <do func="ReadRecord" error="IGNORE">
              <para name="SqlCmd" sql="QryStpRefInf"/>
           </do>
           <if condition="#RetCod==2">
              <set name="RspCod"    value="01003"/>
              <set name="RspMsg"    value="无符合条件记录"/>
              <set name="DWZ_STATUS_CODE"     value="300"/>
              <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
              <return/>
           </if>
           <elseif condition="#RetCod!=0">
              <set name="RspCod"    value="09999"/>
              <set name="RspMsg"    value="系统错误"/>
              <set name="DWZ_STATUS_CODE"     value="300"/>
              <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
              <do func="RollBackWork"/>
              <return/>
           </elseif>
           <!-- 检测退款订单状态 -->
           <if condition="IS_NOEQUAL_STRING(OrdStatus,'00')">
              <set name="RspCod"    value="06007"/>
              <set name="RspMsg"    value="订单状态不正确，不能退款！"/>
              <set name="DWZ_STATUS_CODE"     value="300"/>
              <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
              <return/>
           </if>
       
          <!--验证商户账户号是否正常-->
          <do func="ReadRecord"       error="IGNORE">
              <para name="SqlCmd"       sql="SelMaStatus"/>
          </do>
          <if condition="IS_EQUAL_STRING(AC_STATUS,'2')">
              <set name="MsgTyp"    value="E"/>
              <set name="RspCod"    value="01003"/>
              <set name="RspMsg"    value="商户账户已经被冻结，不能申请退款！"/>
              <set name="DWZ_STATUS_CODE"     value="300"/>
              <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
              <return/>
           </if>
           <if condition="DOUBLECMP(cashacbal,1,rfAmt)">
              <set name="RspCod"    value="01003"/>
              <set name="RspMsg"    value="商户账户余额不足，不能申请退款！"/>
              <set name="DWZ_STATUS_CODE"     value="300"/>
              <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
              <return/>
           </if>
           
           <!--查询冻结信息-->
           <quote name="SelFrzInf"/>
           
           <if condition="IS_EQUAL_STRING(result,'1')">         <!--退款成功-->
               <set name="rfReqDate"      expr="GETDATETIME()"/>       <!--退款成功时间--> 
               <!--线上提现，则接入银行提现接口代码-->
               <set name="bankcode"      expr="bankcode"/><!--银行编码-->
               <set name="bankpayusernm" expr="bankpayusernm"/><!--收款人姓名-->
               <set name="bankpayacno"   expr="DES_DECRYPT(bankpayacno)"/><!--收款卡号-->
               
               <!--查询支付方式-->
               <do func="ReadRecord" >
                  <para name="SqlCmd" sql="QryStpPayInf"/>
               </do>
               <if condition="#RetCod==2">
                  <set name="RspCod"    value="01003"/>
                  <set name="RspMsg"    value="无符合条件记录"/>
                  <set name="DWZ_STATUS_CODE"     value="300"/>
                  <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
                  <do func="RollBackWork"/>
                  <return/>
               </if>
               <elseif condition="#RetCod!=0">
                  <set name="RspCod"    value="09999"/>
                  <set name="RspMsg"    value="系统错误"/>
                  <set name="DWZ_STATUS_CODE"     value="300"/>
                  <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
                  <do func="RollBackWork"/>
                  <return/>
               </elseif>
               <if condition="DOUBLECMP(ordamt,1,rfAmt)">
                  <set name="RspCod"    value="01003"/>
                  <set name="RspMsg"    value="退款金额大于订单金额！"/>
                  <set name="DWZ_STATUS_CODE"     value="300"/>
                  <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
                  <return/>
               </if>
               <!-- 检测商品订单状态 -->
               <if condition="IS_EQUAL_STRING(paystatus,'00')">
                  <set name="RspCod"    value="06007"/>
                  <set name="RspMsg"    value="订单未支付！"/>
                  <set name="DWZ_STATUS_CODE"     value="300"/>
                  <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
                  <return/>
               </if>
               
               <if condition="IS_EQUAL_STRING(paystatus,'01')">
                  <set name="rfAfterPay"   value="1"  />    <!--担保交易虚拟账号“是否确定付款”标识，此处代表确定付款-->
               </if>
               
               <if condition="NOT(ISNULL(ruserid))">
                  <!--限额检查  start --> 
                  <set name="Amt"           expr="rfAmt"/>      <!--交易金额-->
                  <set name="PAY_TYPE"      expr="payType"/>    <!--支付方式 01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
                  <set name="TRAN_TYPE"     value="8"/>         <!--交易类型 0 其他 1 充值 2消费 3撤销 4预授权完成 5预授权完成撤销 6转账(虚拟帐号间) 7提现 8退款-->
                  <set name="cust_type"     value="0"/>         <!--效验客户类型(1用户 2 商户 0 两者)-->
                  <set name="User_code"     expr="ruserid"/>    <!--用户编号-->
                  <set name="comp_code"     expr="merNo"/>      <!--商户编号-->
                  <set name="Time"          expr="GETDATETIME()"/>
                  <set name="DATE"          expr="GETDATE()"/>
                  <set name="ServiceCode"   value="680518"/>  
                  <quote name="chkLimAmt"/>
                  <!--限额检查   end--> 
               </if>
               
               <!-- 查询交易费率设置 -->
               <do func="ReadRecord" error="IGNORE">
                 <para name="SqlCmd"    sql="chkMerStatus"/>
               </do>
               <if condition="#RetCod==2">
                  <set name="MsgTyp"    value="E"/>
                  <set name="RspCod"    value="01002"/>
                  <set name="RspMsg"    value="该商户未设置费率"/>
               </if> 
               <elseif condition="#RetCod!=0">
                  <set name="MsgTyp"    value="E"/>
                  <set name="RspCod"    value="09999"/>
                  <set name="RspMsg"    value="系统错误"/>
                  <return/> 
               </elseif> 
               
               <!-- 检测是否收取手续费 -->
               <set name="netRecAmt"     expr="rfAmt"/>
               <if condition="OR(IS_EQUAL_STRING(fee,''),IS_EQUAL_STRING(fee,'0'))">    <!--原交易未收取手续费-->
                  <!-- 退货时是否退另外收取手续费 Y-是；N-否；  -->
                  <if condition="AND(IS_EQUAL_STRING(rfRecFeeFlg,'Y'),NOT(ISNULL(rfRecFeeCode)))">
                     <!-- 退款金额是交易金额+手续费 -->
                     <set name="txnAmt_fee"    expr="rfAmt"/>
                     <set name="FEE_CODE"      expr="rfRecFeeCode"/>
                     <quote name="FeeCount"/>
                     <set name="fee"           expr="fee"/>    <!--手续费-->
                     
                     <if condition="IS_EQUAL_STRING(payType,'00')">  <!-- 商户退款,有手续费,不退佣金 退回用户虚拟账户-->
                        <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',ADD(rfAmt,fee),'/','Y','/')"/>    <!--商户记账参数-->
                        <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',rfAmt,'/','Y','/')"/>           <!--用户记账参数-->
                        <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>    <!--平台账户（手续费）记账参数-->
                        <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',feePar)"/>
                     </if>
                     <else>   <!-- 商户退款,有手续费,不退佣金 网银-->
                        <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',ADD(rfAmt,fee),'/','Y','/')"/>    <!--商户记账参数-->
                        <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>    <!--平台账户（手续费）记账参数-->
                        <set name="PARAMS"     expr="STRCAT(merPar,',',feePar)"/>
                     </else>
                  </if>
                  <else>
                     <set name="fee"                 value="0"/>
                     <set name="rfRecFeeFlg"         value="N"/>
                  </else>
                  <set name="rfCommFlg"              value="N"/>
                  <set name="rfCommAmt"              value="0"/>
               </if>
               <else><!-- 原交易收取了交易手续费 , 检测商户退款是否退佣金  --> 
                  <!-- 退货时是否退原收取的佣金：Y-是；N-否；  -->
                  <if condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">
                     <!-- 退款佣金  --> 
                     <set name="rfCommAmt"        expr="DIV(MUL(fee,rfAmt),ordamt)"/>
                     <!-- 退款手续费 -->
                     <set name="txnAmt_fee"    expr="rfAmt"/>
                     <set name="FEE_CODE"      expr="rfRecFeeCode"/>
                     <quote name="FeeCount"/>
                  </if>
                  <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),OR(IS_EQUAL_STRING(rfRecFeeFlg,'N'),IS_EQUAL_STRING(rfRecFeeFlg,'')))">
                     <!-- 退款佣金  --> 
                     <set name="rfCommAmt"           expr="DIV(MUL(fee,rfAmt),ordamt)"/>
                     <!-- 退款手续费 -->
                     <set name="fee"                 value="0"/>
                     <set name="rfRecFeeFlg"         value="N"/>
                  </elseif>
                  <elseif condition="AND(OR(IS_EQUAL_STRING(rfCommFlg,'N'),IS_EQUAL_STRING(rfCommFlg,'')),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">
                     <!-- 退款手续费 -->
                     <set name="txnAmt_fee"          expr="rfAmt"/>
                     <set name="FEE_CODE"            expr="rfRecFeeCode"/>
                     <quote name="FeeCount"/>
                     <!-- 退款佣金  --> 
                     <set name="rfCommAmt"           value="0"/>
                     <set name="rfCommFlg"           value="N"/>
                  </elseif>
                  <else>
                     <set name="fee"                 value="0"/>
                     <set name="rfCommAmt"           value="0"/>
                     <set name="rfRecFeeFlg"         value="N"/>
                     <set name="rfCommFlg"           value="N"/>
                  </else> 
               </else>
               
               <if condition="ISNULL(rfComAmt)">
                  <set name="rfComAmt"   value="0"/>                            <!--已退佣金-->
               </if>
               <!-- 虚拟账户退款直接更新累计退佣金-->
               <set name="rfComAmt"      expr="rfComAmt"/> <!--库中的已退佣金,下面的虚拟账户退款需要累计本次退佣金-->
               <!--净额 rfCommAmt为本次退佣金-->
               <set name="netRecAmt"     expr="SUB(ADD(rfAmt,fee),rfCommAmt)"/> 
               <set name="accAmttmp"     expr="ACCAMT"/>     
               <!-- 退款退佣金金额 -->
               <set name="commAmtRef"   expr="rfComAmt"/>   
               
               <set name="refOrdStatus"    value="02"/>
               <set name="prdordstatus"    value="05"/>
               <set name="rfReqDate"     expr="GETDATETIME()"/> <!--退款成功时间-->
               
               <!--记账-->
               <set name="TXN_TYP"      value="7"/>      <!--用途 7 退款-->
               <if condition="IS_EQUAL_STRING(payType,'00')">         <!--虚拟账户退款直接退回-->
                  <set name="ACCAMT"        expr="rfAmt"/>            <!--虚拟账户退款金额-->
                  <set name="MULAMT"        value="0"/>               <!--网银退款金额-->
                  <if condition="AND(IS_EQUAL_STRING(PRDORDTYPE,'2'),IS_NOEQUAL_STRING(rfAfterPay,'1'))"><!--担保支付未确认付款前-->
                     <set name="rfRecFeeFlg" value="N"/>
                     <set name="rfCommFlg"   value="N"/>
                     <!--担保支付未确认付款前退款不收取手续费-->
                     <set name="netRecAmt"    expr="rfAmt"/>
                     <set name="fee"          value="0"/>
                     <set name="rfCommAmt"    value="0"/>
                     <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>          <!--商户记账参数-->
                     <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',rfAmt,'/','Y','/')"/>           <!--用户记账参数-->
                     <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar)"/>
                  </if>
                  <else>      <!--担保支付确认付款后 或者 直接支付成功-->
                     <!-- 记账 商户-  用户+  -->        
                     <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>          <!--商户记账参数-->
                     <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',rfAmt,'/','Y','/')"/>            <!--用户记账参数-->        
                     <if condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">      <!--退款，有手续费退佣金-->
                       <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>       <!--平台账户（手续费）记账参数-->
                       <set name="rfComPar"   expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',rfCommAmt,'/','N','/')"/> <!--平台账户（退款退佣金）记账参数-->
                       <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',feePar,',',rfComPar)"/>
                       <set name="filed1"        expr="commAmtRef"/>
                       <set name="updrfComAmt"   expr="STRCAT(',rfComAmt= \'',ADD(prdRfComAmt,commAmtRef),'\'')"/><!--查询出累计退佣金，退款成功的情况累计 -->
                     </if>
                     <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),IS_EQUAL_STRING(rfRecFeeFlg,'N'))">  <!--退款，无手续费退佣金-->
                       <set name="rfComPar"   expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',rfCommAmt,'/','N','/')"/> <!--平台账户（退款退佣金）记账参数-->
                       <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',rfComPar)"/>
                       <set name="filed1"        expr="commAmtRef"/>
                       <set name="updrfComAmt"   expr="STRCAT(',rfComAmt= \'',ADD(prdRfComAmt,commAmtRef),'\'')"/><!--查询出累计退佣金，退款成功的情况累计 -->
                     </elseif>
                     <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'N'),IS_EQUAL_STRING(rfRecFeeFlg,'N'))">  <!--退款，无手续费不退佣金-->
                       <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar)"/>
                     </elseif>
                     <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'N'),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">  <!--退款，有手续费不退佣金-->
                       <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>       <!--平台账户（手续费）记账参数-->
                       <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',feePar)"/>
                     </elseif>
                  </else>
                  <!-- 记账处理 -->
                  <set name="prdordnotmp"  expr="prdordno"/>
                  <set name="prdordno"     expr="refordno"/>
                  <quote name="accProcess"/> 
                  <if condition="#RetCod!=0"> 
                     <set name="RspCod"    value="07001"/>
                     <set name="RspMsg"    value="交易失败，请联系客服！"/>
                     <do func="RollBackWork"/>    <!--回滚提交数据-->
                     <return/>
                  </if>
                  <set name="prdordno"  expr="prdordnotmp"/>
               </if>
               <elseif condition="IS_EQUAL_STRING(payType,'04')">   <!-- 如果是混合支付，判断退款金额是否大于虚拟账户支付的金额   -->
                  <set name="accamt"      expr="accamt"/>
                  <set name="totrefamt"   expr="rftotalamt"/>
                  <if condition="DOUBLECMP(accamt,5,ADD(totRefAmt,rfAmt))">    <!--全部退回用户支付账户-->
                    <set name="ACCAMT"        expr="rfAmt"/>         <!--虚拟账户退款金额-->
                    <set name="MULAMT"        value="0"/>            <!--网银退款金额-->
                    <!-- 记账：虚拟账户支付部分，直接退回   商户-，用户+-->
                    <if condition="AND(IS_EQUAL_STRING(PRDORDTYPE,'2'),IS_NOEQUAL_STRING(rfAfterPay,'1'))"><!--担保支付未确认付款前-->
                        <set name="rfRecFeeFlg" value="N"/>
                        <set name="rfCommFlg"   value="N"/>
                        <!--担保支付未确认付款前退款不收取手续费-->
                        <set name="netRecAmt"    expr="rfAmt"/>
                        <set name="fee"          value="0"/>
                        <set name="rfCommAmt"    value="0"/>
                        <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>          <!--商户记账参数-->
                        <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',rfAmt,'/','Y','/')"/>           <!--用户记账参数-->
                        <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar)"/>
                    </if>
                    <else>      <!--担保支付确认付款后 或者 直接支付成功-->
                       <!-- 记账 商户-  用户+  -->        
                       <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>          <!--商户记账参数-->
                       <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',rfAmt,'/','Y','/')"/>            <!--用户记账参数-->        
                       <if condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">      <!--退款，有手续费退佣金-->
                         <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>       <!--平台账户（手续费）记账参数-->
                         <set name="rfComPar"   expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',rfCommAmt,'/','N','/')"/> <!--平台账户（退款退佣金）记账参数-->
                         <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',feePar,',',rfComPar)"/>
                         <set name="filed1"       expr="commAmtRef"/>
                         <set name="updrfComAmt"   expr="STRCAT(',rfComAmt= \'',ADD(prdRfComAmt,commAmtRef),'\'')"/><!--查询出累计退佣金，退款成功的情况累计 -->
                       </if>
                       <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),IS_EQUAL_STRING(rfRecFeeFlg,'N'))">  <!--退款，无手续费退佣金-->
                         <set name="rfComPar"   expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',rfCommAmt,'/','N','/')"/> <!--平台账户（退款退佣金）记账参数-->
                         <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',rfComPar)"/>
                         <set name="filed1"       expr="commAmtRef"/>
                         <set name="updrfComAmt"   expr="STRCAT(',rfComAmt= \'',ADD(prdRfComAmt,commAmtRef),'\'')"/><!--查询出累计退佣金，退款成功的情况累计 -->
                       </elseif>
                       <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'N'),IS_EQUAL_STRING(rfRecFeeFlg,'N'))">  <!--退款，无手续费不退佣金-->
                         <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar)"/>
                       </elseif>
                       <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'N'),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">  <!--退款，有手续费不退佣金-->
                         <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>       <!--平台账户（手续费）记账参数-->
                         <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',feePar)"/>
                       </elseif>
                    </else>
                    
                    <!-- 记账处理 -->
                    <set name="prdordnotmp"  expr="prdordno"/>
                    <set name="prdordno"     expr="refordno"/>
                    <quote name="accProcess"/> 
                    <if condition="#RetCod!=0"> 
                         <set name="RspCod"    value="07001"/>
                         <set name="RspMsg"    value="交易失败，请联系客服！"/>
                         <do func="RollBackWork"/>    <!--回滚提交数据-->
                         <return/>
                    </if>
                    <set name="prdordno"  expr="prdordnotmp"/>
                    
                  </if>
                  <else>
                    <set name="GetBankCode" expr="GETWORDDELIMITER(bankcod,'_',1)"/>
                    <!-- 记账：网银支付部分；借商户虚拟账号，贷银行应付款项；同时冻结部分虚拟账户支付金额 -->
                    <set name="netRecAmtTmp" expr="netRecAmt"/>
                    <set name="rfAmtTmp"     expr="rfAmt"/> 
                    <if condition="DOUBLECMP(totRefAmt,5,accamt)">    <!--全部退回网银-->
                       <set name="ACCAMT"        value="0"/>       <!--虚拟账户退款金额-->
                       <set name="MULAMT"        expr="rfAmt"/>    <!--网银退款金额-->
                    </if>
                    <else>    <!-- 部分退回网银  部分退回支付账户-->
                       <set name="accRefAmt"   expr="SUB(accamt,totRefAmt)"/>     <!--部分退款至虚拟账户-->
                       <set name="rfAmt"       expr="SUB(rfAmt,accRefAmt)"/>      <!--部分退款至网银-->
                       <!--set name="netRecAmt"   expr="SUB(netRecAmt,accRefAmt)"/-->
                       <set name="ACCAMT"        expr="accRefAmt"/>       <!--虚拟账户退款金额-->
                       <set name="MULAMT"        expr="rfAmt"/>           <!--网银退款金额-->
                    </else>
                    
                    <!--********银行接口接入********-->
                    
                    <!--********银行接口接入********-->
                    
                    
                    <if condition="AND(IS_EQUAL_STRING(PRDORDTYPE,'2'),IS_NOEQUAL_STRING(rfAfterPay,'1'))"><!--担保支付未确认付款前-->
                       <!--不收取手续费不退佣金-->
                       <set name="netRecAmt" expr="rfAmt"/>
                       <set name="fee"          value="0"/>
                       <set name="rfCommAmt"    value="0"/>
                       <set name="merPar"       expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>  <!--商户记账参数-->
                       <set name="PARAMS"       expr="merPar"/>
                    </if>
                    <else><!--担保支付确认付款后 或者直接支付成功-->
                        <!--将退款金额解冻、退回商户支付账号 -->
                        <set name="PAY_AC_NO"    expr="merpayno"/>
                        <set name="txAmt"        expr="STRCAT('-',FROZ_AMT)"/>
                        <quote name="frezzAmt"/>
                        <set name="txAmt"        expr="FROZ_AMT"/>
                        
                        <!--更新冻结状态-->
                        <quote name="UpdFrezz"/>
                        
                        <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>  <!--商户记账参数-->
                        <!-- rfFee为退款手续费，需要通过退款表的rffee来判断是否为退款收手续费，而不是订单表的fee-->
                        <if condition="AND(IS_NOEQUAL_STRING(rfFee,'0'),IS_NOEQUAL_STRING(commAmtRef,'0'))">  <!--有手续费退佣金-->
                          <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',rfFee,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="commPar"    expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',commAmtRef,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="PARAMS"     expr="STRCAT(merPar,',',commPar,',',feePar)"/>
                          <set name="filed1"       expr="commAmtRef"/>
                          <set name="updrfComAmt"   expr="STRCAT(',rfComAmt= \'',ADD(prdRfComAmt,commAmtRef),'\'')"/><!--查询出累计退佣金，退款成功的情况累计 -->
                        </if>
                        <elseif condition="AND(IS_EQUAL_STRING(rfFee,'0'),IS_NOEQUAL_STRING(commAmtRef,'0'))">  <!--无手续费退佣金-->
                          <set name="commPar"    expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',commAmtRef,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="PARAMS"     expr="STRCAT(merPar,',',commPar)"/> 
                          <set name="filed1"       expr="commAmtRef"/>
                          <set name="updrfComAmt"   expr="STRCAT(',rfComAmt= \'',ADD(prdRfComAmt,commAmtRef),'\'')"/><!--查询出累计退佣金，退款成功的情况累计 -->
                        </elseif>
                        <elseif condition="AND(IS_EQUAL_STRING(rfFee,'0'),IS_EQUAL_STRING(commAmtRef,'0'))">  <!--无手续费不退佣金-->
                          <set name="PARAMS"     expr="merPar"/> 
                        </elseif>
                        <elseif condition="AND(IS_NOEQUAL_STRING(rfFee,'0'),IS_EQUAL_STRING(commAmtRef,'0'))">  <!--有手续费不退佣金-->
                          <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',rfFee,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="PARAMS"     expr="STRCAT(merPar,',',feePar)"/>
                        </elseif>
                    </else>
                    
                    <if condition="IS_EQUAL_STRING(prodcode,'CP00000003')"><!--无账户网银支付-->
                        
                    </if>
                    <else> <!--有账号支付退给用户-->
                        <set name="usrPar"     expr="STRCAT(ruserid,'/','01','/','+','/','CNY','/',ACCAMT,'/','Y','/')"/>            <!--用户记账参数-->        
                        <set name="PARAMS"     expr="STRCAT(PARAMS,',',usrPar)"/>
                    </else>
                    
                    <!--记账处理-->
                    <set name="prdordnotmp"  expr="prdordno"/>
                    <set name="prdordno"     expr="refordno"/>
                    <quote name="accProcess"/> 
                    <if condition="#RetCod!=0"> 
                       <set name="RspCod"    value="07001"/>
                       <set name="RspMsg"    value="交易失败，请联系客服！"/>
                       <do func="RollBackWork"/>    <!--回滚提交数据-->
                       <return/>
                    </if>
                    <set name="prdordno"  expr="prdordnotmp"/>
                    
                  </else>
                  
               </elseif>
               <elseif condition="OR(IS_EQUAL_STRING(payType,'01'),IS_EQUAL_STRING(payType,'03'))">   <!-- 网银支付  -->
                    <set name="GetBankCode"   expr="bankcod"/>
                    <set name="ACCAMT"        value="0"/>             <!--虚拟账户退款金额-->
                    <set name="MULAMT"        expr="rfAmt"/>          <!--网银退款金额-->
                    
                    <!--********银行接口接入********-->
                    
                    <!--********银行接口接入********-->
                    
                    <if condition="AND(IS_EQUAL_STRING(PRDORDTYPE,'2'),IS_NOEQUAL_STRING(rfAfterPay,'1'))"><!--担保支付未确认付款前-->
                       <!--不收取手续费不退佣金-->
                       <set name="netRecAmt" expr="rfAmt"/>
                       <set name="fee"          value="0"/>
                       <set name="rfCommAmt"    value="0"/>
                       <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>  <!--商户记账参数-->
                       <set name="PARAMS"     expr="merPar"/>
                    </if>
                    <else><!--担保支付确认付款后 或者直接支付成功-->
                        <!--将退款金额解冻、退回商户支付账号 -->
                        <set name="PAY_AC_NO"    expr="merpayno"/>
                        <set name="txAmt"        expr="STRCAT('-',FROZ_AMT)"/>
                        <quote name="frezzAmt"/>
                        <set name="txAmt"        expr="FROZ_AMT"/>
                        
                        <!--更新冻结状态-->
                        <quote name="UpdFrezz"/>
                        
                        <set name="merPar"       expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>  <!--商户记账参数-->
                        <!-- rfFee为退款手续费，需要通过退款表的rffee来判断是否为退款收手续费，而不是订单表的fee-->
                        <if condition="AND(IS_NOEQUAL_STRING(rfFee,'0'),IS_NOEQUAL_STRING(commAmtRef,'0'))">  <!--有手续费退佣金-->
                          <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',rfFee,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="commPar"    expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',commAmtRef,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="PARAMS"     expr="STRCAT(merPar,',',commPar,',',feePar)"/>
                          <set name="filed1"       expr="commAmtRef"/>
                          <set name="updrfComAmt"   expr="STRCAT(',rfComAmt= \'',ADD(prdRfComAmt,commAmtRef),'\'')"/><!--查询出累计退佣金，退款成功的情况累计 -->
                        </if>
                        <elseif condition="AND(IS_EQUAL_STRING(rfFee,'0'),IS_NOEQUAL_STRING(commAmtRef,'0'))">  <!--无手续费退佣金-->
                          <set name="commPar"    expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',commAmtRef,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="PARAMS"     expr="STRCAT(merPar,',',commPar)"/> 
                          <set name="filed1"       expr="commAmtRef"/>
                          <set name="updrfComAmt"   expr="STRCAT(',rfComAmt= \'',ADD(prdRfComAmt,commAmtRef),'\'')"/><!--查询出累计退佣金，退款成功的情况累计 -->
                        </elseif>
                        <elseif condition="AND(IS_EQUAL_STRING(rfFee,'0'),IS_EQUAL_STRING(commAmtRef,'0'))">  <!--无手续费不退佣金-->
                          <set name="PARAMS"     expr="merPar"/> 
                        </elseif>
                        <elseif condition="AND(IS_NOEQUAL_STRING(rfFee,'0'),IS_EQUAL_STRING(commAmtRef,'0'))">  <!--有手续费不退佣金-->
                          <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',rfFee,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="PARAMS"     expr="STRCAT(merPar,',',feePar)"/>
                        </elseif>
                    </else>
                    
                    <!--记账处理-->
                    <set name="prdordnotmp"  expr="prdordno"/>
                    <set name="prdordno"     expr="refordno"/>
                    <quote name="accProcess"/> 
                    <if condition="#RetCod!=0"> 
                       <set name="RspCod"    value="07001"/>
                       <set name="RspMsg"    value="交易失败，请联系客服！"/>
                       <do func="RollBackWork"/>    <!--回滚提交数据-->
                       <return/>
                    </if>
                    <set name="prdordno"  expr="prdordnotmp"/>
                    
               </elseif>
               <else>
                  <set name="RspCod"      value="02069"/>
                  <set name="RspMsg"      value="无此订单类型，不能退款"/>
                  <set name="DWZ_STATUS_CODE"     value="300"/>
                  <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
                  <return/>
               </else>
               
           </if>
           <elseif condition="IS_EQUAL_STRING(result,'2')">     <!--退款拒绝-->
              <!--将退款金额解冻、退回商户支付账号 -->
              <set name="PAY_AC_NO"    expr="merpayno"/>
              <set name="txAmt"        expr="STRCAT('-',FROZ_AMT)"/>
              <quote name="frezzAmt"/>
              <set name="txAmt"        expr="FROZ_AMT"/>
              
              <!--更新冻结状态-->
              <quote name="UpdFrezz"/>
              <set name="refOrdStatus"    value="03"/><!--03退款失败-->
              <set name="rfReqDate"      value=""/>
              
           </elseif>
           <else>
              <set name="RspCod"      value="02069"/>
              <set name="RspMsg"      value="无此订单状态"/>
              <set name="DWZ_STATUS_CODE"     value="300"/>
              <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
              <return/>
           </else>
            
          <!--更新退款订单-->
          <set name="OrdStatus"      expr="refOrdStatus"/> 
          <do func="ExecSql" >  
             <para name="SqlCmd" sql="UpdStatus"/>
          </do>
          <if condition="#RetCod==2">
             <set name="RspCod"    value="01003"/>
             <set name="RspMsg"    value="无符合条件记录"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
             <do func="RollBackWork"/>
             <return/>
          </if>
          <elseif condition="#RetCod!=0">
             <set name="RspCod"    value="06003"/>
            <set name="RspMsg"    value="更新订单信息错误"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
             <do func="RollBackWork"/>
             <return/>
          </elseif> 
          
          <!--通知风控系统登记订单信息-->
          <set name="ServiceCode" value="680517"/>
          <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
          <set name="TCODE"       expr="payOrdNo"/>           <!--平台流水号-->
          <set name="CTYPE"       value="1"/>                 <!--客户类型-->
          <set name="CLIENTCODE"  expr="ruserid"/>            <!--客户编号-->
          <set name="CCODE"       expr="merNo"/>              <!--商户编号-->
          <set name="CNAME"       expr="MERREMARK"/>
          <set name="TRANTYPE"    value="8"/>                 <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
          <set name="Tran_type"   value="4"/>                 <!--交易方式 1网银、2终端、3消费卡、4虚拟积分等-->
          <set name="TAMT"        expr="Amt"/>
          <set name="REGDTTIME"   expr="STRCAT(acDate,acTime)"/>
          <set name="Time"        expr="acDate"/>
          <quote name="noticRcs"/>
          
          <set name="MsgTyp"    value="N"/>
          <set name="RspCod"    value="00000" />
          <set name="RspMsg"    value="交易成功!" />
          <set name="DWZ_STATUS_CODE"     value="200"/>
          <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
          
      </process>
   </transaction> 
   
   <transaction code="565804" desc="退款 商户发起 后台发起">
      <sql name="QryOrdInf"><!--查询商品订单表-->
        select OrdStatus,payOrdNo,prdOrdType,retUrl,NotifyUrl,MerNo,acJrnNo,acDate,CUST_ID,bizType,ordamt,CustPayAcNo,nvl(rfComAmt,0)rfComAmt from StpPrdInf where prdOrdNo=#{prdOrdNo} AND merNo=#{merNo}
      </sql>
      <sql name="QryPayTyp">
        select payType,accAmt,fee,merNo,payacno,txamt,bankcod,cust_id ruserid from StpPayInf where payOrdNo=#{payOrdNo}
      </sql>
      <sql name="QryRefInf00">
        select refOrdNo from StpRefInf where oriPrdOrdNo=#{prdOrdNo} and OrdStatus='00' 
      </sql>
      <sql name="QryRefInf">
        select refOrdNo from StpRefInf where oriPrdOrdNo=#{prdOrdNo} and (OrdStatus='01' or OrdStatus='02' or OrdStatus='05')
      </sql>
      <sql name="QryRefTotAmt">
        select SUM(rfAmt) totRefAmt from StpRefInf where oriPrdOrdNo=#{prdOrdNo} and (OrdStatus='01' or OrdStatus='02' or OrdStatus='05')
      </sql>
      <sql name="UpdStatus">
        refOrdNo=#{refOrdNo}
      </sql>
      <sql name="UpdRefInf">
        UPDATE STPREFINF SET  RFAMT=#{RFAMT}, RFSAKE=#{RFSAKE}, NETRECAMT=#{NETRECAMT},
         ORDSTATUS=#{ORDSTATUS},FEE=#{FEE}, TXCCY=#{TXCCY}, GETBANKCODE=#{GETBANKCODE}
       WHERE refOrdNo=#{refOrdNo}
      </sql>
      <sql name="UpdPrd">
         prdOrdNo=#{prdOrdNo}
      </sql> 
      <sql name="UpdPrd1">
         update stpprdinf set ordstatus=#{ordstatus},rfComAmt=#{rfComAmt},rfTotalAmt=(SELECT case when rfTotalAmt is null then 0+${rfAmt} else rfTotalAmt+${rfAmt} end rfTotalAmt FROM stpprdinf WHERE prdOrdNo=#{prdOrdNo} and MerNo=#{MerNo}) where prdOrdNo=#{prdOrdNo} and MerNo=#{MerNo}
      </sql>
      <sql name="chkMerStatus">
         select fee_code as feeCode, RF_COMM_FLG as rfCommFlg, RF_REC_FEE_FLG as rfRecFeeFlg,RF_REC_FEE_CODE as rfRecFeeCode from ARP_CUST_FEE where pay_ac_no in (select pay_ac_no from arp_ac_cust_rel where CUST_ID=#{merNo}) and biz_type=#{bizType} and pay_type=#{payType}
      </sql>
      <sql name="SelMaStatus">  <!--查询客户账户状态 -->
        select a.AC_STATUS,nvl(cash_ac_bal,0) cashacbal,a.PAY_AC_NO merpayno from ARP_AC_PROFILE a,ARP_AC_CUST_REL b where a.PAY_AC_NO=b.PAY_AC_NO and b.cust_id =#{merno}
      </sql>
      <sql name="refStatus"><!--退款失败更新订单状态-->
        update STPREFINF set ordstatus=#{ordstatus} where refordno=#{REFORDNO}
      </sql>
      <sql name="selFee"><!--查询支付订单表的FEE-->
        select FEE as payFEE from stppayinf where  payordno=#{payOrdNo}
      </sql>
      <sql name="busflag"> <!--检测企业用户-->
        select CUST_ID as busflag from stpcusinf where cust_id=#{ruserid} and CUST_TYPE='2'
      </sql>
      <process>
         <!--检查用户登录平台是否正确-->
         <if condition="AND(IS_NOEQUAL_STRING(SysCod,'2201'),IS_NOEQUAL_STRING(SysCod,'1120'))">
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台不正确"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </if>
         
         <if condition="IS_EQUAL_STRING(SysCod,'2201')"><!-- 商户系统登录时获取商户号 -->
            <set name="merNo"     expr="SESSIONS.CUSTNO"/>
         </if>
         
         <set name="merNo"         expr="merNo"/> 
         <set name="PRDORDNO"      expr="PRDORDNO"/> 
         <set name="rfAmt"         expr="rfAmt"/> 
         <set name="rfSake"        expr="rfSake"/>             <!--退款理由-->
         <set name="oper_id"       expr="SESSIONS.UID"/>       <!--操作员-->
         
         <if condition="NOT(ISNULL(rfAmt))">
            <set name="rfAmt" expr="AMTPOWER(rfAmt,2)"/>
         </if>
         <else>
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="退款金额不能为0！"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>   
         </else>
         
         <if condition="NOT(ISNULL(rfTotalAmt))">
            <set name="rfTotalAmt"    expr="AMTPOWER(RFTOTALAMT,2)"/>
         </if>
         
         <do func="ReadRecord"       error="IGNORE">
            <para name="SqlCmd"       sql="SelMaStatus"/>
         </do>
         <set name="AC_STATUS"       expr="AC_STATUS"/>
         
         <if condition="IS_EQUAL_STRING(AC_STATUS,'2')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="商户账户已经被冻结，不能申请退款！"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
             <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </if>
         
         <if condition="DOUBLECMP(cashacbal,1,rfAmt)">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="商户账户余额不足，不能申请退款！"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
             <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </if>
        
         <!--查询商品订单信息-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryOrdInf"/>
         </do>
         <if condition="#RetCod==2">
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="无符合条件记录"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </if>
         <elseif condition="#RetCod!=0">
            <set name="RspCod"    value="06003"/>
            <set name="RspMsg"    value="更新订单信息错误"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </elseif>
         
         <!-- 检测商品订单状态 -->
         <if condition="IS_EQUAL_STRING(OrdStatus,'00')">
            <set name="RspCod"    value="06007"/>
            <set name="RspMsg"    value="订单未支付"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </if>
         <elseif condition="OR(IS_EQUAL_STRING(OrdStatus,'09'),IS_EQUAL_STRING(OrdStatus,'11'))">
            <set name="RspCod"    value="06007"/>
            <set name="RspMsg"    value="订单已撤销或已作废"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </elseif>
         <elseif condition="AND(IS_NOEQUAL_STRING(OrdStatus,'05'),IS_NOEQUAL_STRING(OrdStatus,'06'),IS_NOEQUAL_STRING(OrdStatus,'01'))">
            <!--担保支付判断-->
            <if condition="OR(IS_EQUAL_STRING(OrdStatus,'12'),IS_EQUAL_STRING(OrdStatus,'13'),IS_EQUAL_STRING(OrdStatus,'15'),IS_EQUAL_STRING(OrdStatus,'16'),IS_EQUAL_STRING(OrdStatus,'03'),IS_EQUAL_STRING(OrdStatus,'04'),IS_EQUAL_STRING(OrdStatus,'17'))">
            </if>
            <else>
               <set name="RspCod"    value="06007"/>
               <set name="RspMsg"    value="订单暂不能退款"/>
               <set name="DWZ_STATUS_CODE"     value="300"/>
               <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
               <return/>
            </else>
         </elseif>
         
         <!--查询退款订单信息-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryRefInf"/>
         </do>
         <if condition="#RetCod==0">
            <!-- 已存在退款订单 查询已退款总金额 -->
            <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd" sql="QryRefTotAmt"/>
            </do>
            <if condition="#RetCod!=0">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09999"/>
               <set name="RspMsg"    value="系统错误"/>
               <set name="DWZ_STATUS_CODE"     value="300"/>
               <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
               <return/> 
            </if>
            <!--退款金额检查-->
            <if condition="DOUBLECMP(ordamt,1,ADD(totRefAmt,rfAmt))">
               <set name="RspCod"    value="08008"/>
               <set name="RspMsg"    value="退款金额超限"/>
               <set name="DWZ_STATUS_CODE"     value="300"/>
               <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
               <return/>   
            </if>
         </if>
         <elseif condition="#RetCod==2">
             <!-- 不存在退款订单 已退款总金额设置为0 -->
             <set name="totRefAmt"       value="0"/>
             <!--退款金额检查-->
             <if condition="DOUBLECMP(ordamt,1,rfAmt)">
               <set name="RspCod"    value="08008"/>
               <set name="RspMsg"    value="退款金额超限"/>
               <set name="DWZ_STATUS_CODE"     value="300"/>
               <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
               <return/>   
            </if>
         </elseif>
         
         <!--查询支付类型-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryPayTyp"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/> 
         </if>
         
         <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
            <set name="rfAfterPay"   value="1"  />    <!--担保交易虚拟账号“是否确定付款”标识，此处代表确定付款-->
         </if>
         
         <!--检查用户类型(企业会员不检查风控内容)-->
         <do func="ReadRecord">
            <para name="SqlCmd" sql="busflag"/>
         </do>
         <if condition="ISNULL(busflag)">
            <!--限额检查  start --> 
            <set name="Amt"           expr="rfAmt"/>      <!--交易金额-->
            <set name="PAY_TYPE"      expr="payType"/>    <!--支付方式 01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
            <set name="TRAN_TYPE"     value="8"/>         <!--交易类型 0 其他 1 充值 2消费 3撤销 4预授权完成 5预授权完成撤销 6转账(虚拟帐号间) 7提现 8退款-->
            <set name="cust_type"     value="0"/>         <!--效验客户类型(1用户 2 商户 0 两者)-->
            <set name="User_code"     expr="ruserid"/>    <!--用户编号-->
            <set name="comp_code"     expr="merNo"/>      <!--商户编号-->
            <set name="Time"          expr="GETDATETIME()"/>
            <set name="DATE"          expr="GETDATE()"/>
            <set name="ServiceCode"   value="680518"/>  
            <quote name="chkLimAmt"/>
            <!--限额检查   end--> 
         </if>
         
         <!-- 查询交易费率设置 -->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd"    sql="chkMerStatus"/>
         </do>
         <if condition="#RetCod==2">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01002"/>
            <set name="RspMsg"    value="该商户未设置费率"/>
         </if> 
         <elseif condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/> 
         </elseif> 
         
         <!-- 检测是否收取手续费 -->
         <set name="netRecAmt"     expr="rfAmt"/>
         <if condition="OR(IS_EQUAL_STRING(fee,''),IS_EQUAL_STRING(fee,'0'))">    <!--原交易未收取手续费-->
            <!-- 退货时是否退另外收取手续费 Y-是；N-否；  -->
            <if condition="AND(IS_EQUAL_STRING(rfRecFeeFlg,'Y'),NOT(ISNULL(rfRecFeeCode)))">
               <!-- 退款金额是交易金额+手续费 -->
               <set name="txnAmt_fee"    expr="rfAmt"/>
               <set name="FEE_CODE"      expr="rfRecFeeCode"/>
               <quote name="FeeCount"/>
               <set name="fee"           expr="fee"/>    <!--手续费-->
               
               <if condition="IS_EQUAL_STRING(payType,'00')">  <!-- 商户退款,有手续费,不退佣金 退回用户虚拟账户-->
                  <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',ADD(rfAmt,fee),'/','Y','/')"/>    <!--商户记账参数-->
                  <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',rfAmt,'/','Y','/')"/>           <!--用户记账参数-->
                  <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>    <!--平台账户（手续费）记账参数-->
                  <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',feePar)"/>
               </if>
               <else>   <!-- 商户退款,有手续费,不退佣金 网银-->
                  <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',ADD(rfAmt,fee),'/','Y','/')"/>    <!--商户记账参数-->
                  <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>    <!--平台账户（手续费）记账参数-->
                  <set name="PARAMS"     expr="STRCAT(merPar,',',feePar)"/>
               </else>
            </if>
            <else>
               <set name="fee"                 value="0"/>
               <set name="rfRecFeeFlg"         value="N"/>
            </else>
            <set name="rfCommFlg"              value="N"/>
            <set name="rfCommAmt"              value="0"/>
         </if>
         <else>    <!-- 原交易收取了交易手续费 , 检测商户退款是否退佣金  --> 
            <!-- 退货时是否退原收取的佣金：Y-是；N-否；  -->
            <if condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">
               <!-- 退款佣金  --> 
               <set name="rfCommAmt"        expr="DIV(MUL(fee,rfAmt),ordamt)"/>

               <!-- 退款手续费 -->
               <set name="txnAmt_fee"    expr="rfAmt"/>
               <set name="FEE_CODE"      expr="rfRecFeeCode"/>
               <quote name="FeeCount"/>

            </if>
            <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),OR(IS_EQUAL_STRING(rfRecFeeFlg,'N'),IS_EQUAL_STRING(rfRecFeeFlg,'')))">
               <!-- 退款佣金  --> 
               <set name="rfCommAmt"           expr="DIV(MUL(fee,rfAmt),ordamt)"/>
               <!-- 退款手续费 -->
               <set name="fee"                 value="0"/>
               <set name="rfRecFeeFlg"         value="N"/>
            </elseif>
            <elseif condition="AND(OR(IS_EQUAL_STRING(rfCommFlg,'N'),IS_EQUAL_STRING(rfCommFlg,'')),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">
               <!-- 退款手续费 -->
               <set name="txnAmt_fee"          expr="rfAmt"/>
               <set name="FEE_CODE"            expr="rfRecFeeCode"/>
               <quote name="FeeCount"/>
               <!-- 退款佣金  --> 
               <set name="rfCommAmt"           value="0"/>
               <set name="rfCommFlg"           value="N"/>
            </elseif>
            <else>
               <set name="fee"                 value="0"/>
               <set name="rfCommAmt"           value="0"/>
               <set name="rfRecFeeFlg"         value="N"/>
               <set name="rfCommFlg"           value="N"/>
            </else> 
         </else>
         
         <if condition="ISNULL(rfComAmt)">
            <set name="rfComAmt"   value="0"/>                            <!--已退佣金-->
         </if>
         <!-- 虚拟账户退款直接更新累计退佣金，需审核的要在412403更新 update 20150505 gyl-->
         <set name="rfComAmt"      expr="rfComAmt"/> <!--库中的已退佣金,下面的虚拟账户退款需要累计本次退佣金-->
         <set name="netRecAmt"     expr="SUB(ADD(rfAmt,fee),rfCommAmt)"/> <!--净额 rfCommAmt为本次退佣金-->

         <set name="accAmttmp"      expr="ACCAMT"/>     
          
         <!--获取序号 -->
         <do func="GetSeqNo"  error="IGNORE">
            <para name="TblNam" value="stpseqrec"/>
            <para name="KeyNam" value="KeyNam"/>
            <para name="KeyVal" expr="STRCAT('StpRefInf','RefOrdNo')"/>
            <para name="SeqNam" value="KeyVal"/>
            <para name="Len"    value="8"/>
            <para name="Circle" value="1"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09001"/>
            <set name="RspMsg"    value="获取序号错误"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </if>
         
         <set name="refOrdNo"     expr="STRCAT('R',SUBSTR(ACTDAT,2,7),KeyVal)"/>
         <set name="oriPrdOrdNo"  expr="PrdOrdNo"/> <!--原商品订单号-->
         <set name="oriPayOrdNo"  expr="payOrdNo"/> <!--原支付订单号-->
         <set name="rfReqDate"    value=" "/> 
         <set name="txCcy"        value="CNY"/>     
         <set name="NotifyUrl"    expr="NotifyUrl"/>
         <set name="RetUrl"       expr="RetUrl"/>
         <set name="bankPayAcNo"  expr="CustPayAcNo"/> <!--买家收款账号-->
         <set name="rfAmt"        expr="rfAmt"/>       <!--退款金额-->
         <set name="fee"          expr="fee"/>         <!--退款手续费-->
         <if condition="AND(IS_EQUAL_STRING(PRDORDTYPE,'2'),IS_NOEQUAL_STRING(rfAfterPay,'1'))"><!--担保支付未确认付款前退款，不收手续费，不退佣金-->
             <set name="filed1"       expr="rfCommAmt"/>   <!-- 退佣金 -->
         </if>
         <else>
             <set name="filed1"        value="0"/> 
         </else>
         <set name="SellRptAcNo"  expr="merPayAcNo"/>  <!--卖家支付账号-->
         <set name="merno"        expr="merNo"/>
         <set name="rfOrdTime"    expr="GETDATETIME()"/> <!-- 退款申请时间 -->
         <set name="bankCode"     expr="bankcod"/>
         <if condition="OR(IS_EQUAL_STRING(payType,'01'),IS_EQUAL_STRING(payType,'03'))">   <!-- 网银支付  快捷支付  -->
            <set name="OrdStatus"   value="00"/>
         </if>
         <else>
            <set name="OrdStatus"    value="01"/> 
         </else>
         <!--登记退款订单信息-->  
         <do func="InsertRecord" error="IGNORE">
            <para name="TblNam"  value="StpRefInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </if>
         
         <!--记账-->
         <set name="TXN_TYP"      value="7"/>      <!--用途 7 退款-->
         <if condition="IS_EQUAL_STRING(payType,'00')">         <!--虚拟账户退款直接退回-->
            <set name="OrdStatus"     value="02"/>              <!-- 退款订单-退款成功-->
            <set name="rfReqDate"     expr="GETDATETIME()"/>    <!--退款成功时间-->
            <set name="ACCAMT"        expr="rfAmt"/>            <!--虚拟账户退款金额-->
            <set name="MULAMT"        value="0"/>               <!--网银退款金额-->
            <if condition="AND(IS_EQUAL_STRING(PRDORDTYPE,'2'),IS_NOEQUAL_STRING(rfAfterPay,'1'))"><!--担保支付未确认付款前-->
               <set name="rfRecFeeFlg" value="N"/>
               <set name="rfCommFlg"   value="N"/>
               <!--担保支付未确认付款前退款不收取手续费-->
               <set name="netRecAmt"    expr="rfAmt"/>
               <set name="fee"          value="0"/>
               <set name="rfCommAmt"    value="0"/>
               
               <set name="pltMidPar"  expr="STRCAT('99999900000001','/','04','/','-','/','CNY','/',netRecAmt,'/','N','/')"/>  <!--平台担保账户记账参数-->
               <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',rfAmt,'/','Y','/')"/>           <!--用户记账参数-->
               <set name="PARAMS"     expr="STRCAT(pltMidPar,',',usrPar)"/>
            </if>
            <else>      <!--担保支付确认付款后 或者 直接支付成功-->
               <!-- 记账 商户-  用户+  -->        
               <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>          <!--商户记账参数-->
               <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',rfAmt,'/','Y','/')"/>            <!--用户记账参数-->        
               <if condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">      <!--退款，有手续费退佣金-->
                 <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>       <!--平台账户（手续费）记账参数-->
                 <set name="rfComPar"   expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',rfCommAmt,'/','N','/')"/> <!--平台账户（退款退佣金）记账参数-->
                 <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',feePar,',',rfComPar)"/>
               </if>
               <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),IS_EQUAL_STRING(rfRecFeeFlg,'N'))">  <!--退款，无手续费退佣金-->
                 <set name="rfComPar"   expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',rfCommAmt,'/','N','/')"/> <!--平台账户（退款退佣金）记账参数-->
                 <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',rfComPar)"/>
               </elseif>
               <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'N'),IS_EQUAL_STRING(rfRecFeeFlg,'N'))">  <!--退款，无手续费不退佣金-->
                 <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar)"/>
               </elseif>
               <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'N'),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">  <!--退款，有手续费不退佣金-->
                 <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>       <!--平台账户（手续费）记账参数-->
                 <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',feePar)"/>
               </elseif>
            </else>
            <!-- 记账处理 -->
            <set name="prdordnotmp"  expr="prdordno"/>
            <set name="prdordno"     expr="refordno"/>
            <quote name="accProcess"/> 
            <if condition="#RetCod!=0"> 
               <set name="ordstatus" value="03"/><!--退款失败更新订单状态-->
               <do func="ExecSql" error="IGNORE">
                 <para name="SqlCmd" sql="refStatus"/>
               </do>
               <set name="RspCod"    value="07001"/>
               <set name="RspMsg"    expr="STRCAT('交易失败！',RspMsg)"/>
               <set name="DWZ_STATUS_CODE"     value="300"/>
               <set name="DWZ_RSP_MSG"         expr="RspMsg"/> 
               <return/>
            </if>
            <set name="prdordno"  expr="prdordnotmp"/>
         </if>
         <elseif condition="IS_EQUAL_STRING(payType,'04')">   <!-- 如果是混合支付，判断退款金额是否大于虚拟账户支付的金额   -->
            <if condition="DOUBLECMP(accamt,5,ADD(totRefAmt,rfAmt))">    <!--全部退回用户支付账户-->
              <set name="OrdStatus"     value="02"/>
              <set name="rfReqDate"     expr="GETDATETIME()"/> <!--退款成功时间-->
              <set name="ACCAMT"        expr="rfAmt"/>         <!--虚拟账户退款金额-->
              <set name="MULAMT"        value="0"/>            <!--网银退款金额-->
              <!-- 记账：虚拟账户支付部分，直接退回   商户-，用户+-->
              <if condition="AND(IS_EQUAL_STRING(PRDORDTYPE,'2'),IS_NOEQUAL_STRING(rfAfterPay,'1'))"><!--担保支付未确认付款前-->
                  <set name="rfRecFeeFlg" value="N"/>
                  <set name="rfCommFlg"   value="N"/>
                  <!--担保支付未确认付款前退款不收取手续费-->
                  <set name="netRecAmt"    expr="rfAmt"/>
                  <set name="fee"          value="0"/>
                  <set name="rfCommAmt"    value="0"/>
               
                  <set name="pltMidPar"  expr="STRCAT('99999900000001','/','04','/','-','/','CNY','/',netRecAmt,'/','N','/')"/>  <!--平台担保账户记账参数-->
                  <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',rfAmt,'/','Y','/')"/>           <!--用户记账参数-->
                  <set name="PARAMS"     expr="STRCAT(pltMidPar,',',usrPar)"/>
              </if>
              <else>      <!--担保支付确认付款后 或者 直接支付成功-->
                 <!-- 记账 商户-  用户+  -->        
                 <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>          <!--商户记账参数-->
                 <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',rfAmt,'/','Y','/')"/>            <!--用户记账参数-->        
                 <if condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">      <!--退款，有手续费退佣金-->
                   <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>       <!--平台账户（手续费）记账参数-->
                   <set name="rfComPar"   expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',rfCommAmt,'/','N','/')"/> <!--平台账户（退款退佣金）记账参数-->
                   <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',feePar,',',rfComPar)"/>
                 </if>
                 <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),IS_EQUAL_STRING(rfRecFeeFlg,'N'))">  <!--退款，无手续费退佣金-->
                   <set name="rfComPar"   expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',rfCommAmt,'/','N','/')"/> <!--平台账户（退款退佣金）记账参数-->
                   <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',rfComPar)"/>
                 </elseif>
                 <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'N'),IS_EQUAL_STRING(rfRecFeeFlg,'N'))">  <!--退款，无手续费不退佣金-->
                   <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar)"/>
                 </elseif>
                 <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'N'),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">  <!--退款，有手续费不退佣金-->
                   <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>       <!--平台账户（手续费）记账参数-->
                   <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',feePar)"/>
                 </elseif>
              </else>
              <!-- 记账处理 -->
              <set name="prdordnotmp"  expr="prdordno"/>
              <set name="prdordno"     expr="refordno"/>
              <quote name="accProcess"/> 
              <if condition="#RetCod!=0"> 
                 <set name="ordstatus" value="03"/><!--退款失败更新订单状态-->
                 <do func="ExecSql" error="IGNORE">
                   <para name="SqlCmd" sql="refStatus"/>
                 </do>
                 <set name="RspCod"    value="07001"/>
                 <set name="RspMsg"    expr="STRCAT('交易失败！',RspMsg)"/>
                 <set name="DWZ_STATUS_CODE"     value="300"/>
                 <set name="DWZ_RSP_MSG"         expr="RspMsg"/> 
                 <return/>
              </if>
              <set name="prdordno"  expr="prdordnotmp"/>
            </if>
            <else> 
              <set name="OrdStatus"   value="00"/>  <!-- 设置退款订单状态为 00 未处理  -->
              <set name="GetBankCode" expr="GETWORDDELIMITER(bankcod,'_',1)"/>
              <!-- 记账：网银支付部分；借商户虚拟账号，贷银行应付款项；同时冻结部分虚拟账户支付金额 -->
              <set name="netRecAmtTmp" expr="netRecAmt"/>
              <set name="rfAmtTmp"     expr="rfAmt"/> 
              <if condition="DOUBLECMP(totRefAmt,5,accamt)">    <!--全部退回网银-->
                 <set name="ACCAMT"        value="0"/>       <!--虚拟账户退款金额-->
                 <set name="MULAMT"        expr="rfAmt"/>    <!--网银退款金额-->
              </if>
              <else>    <!-- 部分退回网银  部分退回支付账户-->
                 <set name="accRefAmt"   expr="SUB(accamt,totRefAmt)"/>     <!--部分退款至虚拟账户-->
                 <set name="rfAmt"       expr="SUB(rfAmt,accRefAmt)"/>      <!--部分退款至网银-->
                 <!--set name="netRecAmt"   expr="SUB(netRecAmt,accRefAmt)"/-->
                 <set name="ACCAMT"        expr="accRefAmt"/>       <!--虚拟账户退款金额-->
                 <set name="MULAMT"        expr="rfAmt"/>           <!--网银退款金额-->
              </else>
              
              <if condition="AND(IS_EQUAL_STRING(PRDORDTYPE,'2'),IS_NOEQUAL_STRING(rfAfterPay,'1'))"><!--担保支付未确认付款前-->
                 <!--不收取手续费不退佣金-->
                 <set name="netRecAmt" expr="rfAmt"/>
                 <set name="fee"          value="0"/>
                 <set name="rfCommAmt"    value="0"/>
              </if>   
              <else>      <!--担保支付确认付款后 或者直接支付成功-->
                 <!--冻结商户退款金额-->
                 <set name="PAY_AC_NO"     expr="merpayno"/>
                 <set name="txAmt"         expr="netRecAmt"/>
                 <quote name="frezzAmt"/>
                 
                 <!--登记冻结信息-->
                 <set name="BIZ_CODE"     expr="refOrdNo"/>
                 <set name="FROZ_REASON"  value="退款"/>
                 <quote name="InsFrozInf"/>
              </else>
              
              <set name="netRecAmt"    expr="netRecAmtTmp"/>
              <set name="rfAmt"        expr="rfAmtTmp"/>
            </else>  
         </elseif>
         <elseif condition="OR(IS_EQUAL_STRING(payType,'01'),IS_EQUAL_STRING(payType,'03'))">   <!-- 网银支付  -->
            <set name="OrdStatus"     value="00"/>            <!-- 设置退款订单状态为 00 未处理  -->
            <set name="GetBankCode"   expr="bankcod"/>
            <set name="ACCAMT"        value="0"/>             <!--虚拟账户退款金额-->
            <set name="MULAMT"        expr="rfAmt"/>          <!--网银退款金额-->
            <if condition="AND(IS_EQUAL_STRING(PRDORDTYPE,'2'),IS_NOEQUAL_STRING(rfAfterPay,'1'))"><!--担保支付未确认付款前-->
               <!--不收取手续费不退佣金-->
               <set name="netRecAmt" expr="rfAmt"/>
               <set name="fee"          value="0"/>
               <set name="rfCommAmt"    value="0"/>
            </if>   
            <else>      <!--担保支付确认付款后 或者直接支付成功-->
               <!--冻结商户退款金额-->
               <set name="PAY_AC_NO"     expr="merpayno"/>
               <set name="txAmt"       expr="netRecAmt"/>
               <quote name="frezzAmt"/>
               
               <!--登记冻结信息-->
               <set name="BIZ_CODE"     expr="refOrdNo"/>
               <set name="FROZ_REASON"  value="退款"/>
               <quote name="InsFrozInf"/>
            </else>
         </elseif>
         <else>
            <set name="OrdStatus"   value="01"/>    
         </else>
         
         <!--更新退款订单-->
         <set name="txCcy"       value="CNY"/> 
         <do func="UpdateRecord" error="IGNORE">
            <para name="TblNam" value="StpRefInf"/>
            <para name="CndSts" sql="UpdStatus"/>
         </do>
         <if condition="#RetCod==2">
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="无符合条件记录"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </if>
         <elseif condition="#RetCod!=0">
            <set name="RspCod"    value="06003"/>
            <set name="RspMsg"    value="更新订单信息错误"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </elseif>
         
         <delete name="ACCAMT"/>
         <set name="accAmt"      expr="ACCAMTtmp"/> 
         <if condition="NOT(ISNULL(RFTOTALAMT))">
            <set name="rfTotalAmt" expr="RFTOTALAMT"/>
         </if>
         <else>
            <set name="rfTotalAmt" value="0"/>
         </else>
         <!--更新商品订单-->
         <if condition="AND(OR(IS_EQUAL_STRING(payType,'00'),IS_EQUAL_STRING(payType,'04')),IS_EQUAL_STRING(OrdStatus,'02'))">      <!-- 虚拟账户退款直接退回 -->
            <set name="rfComAmt"      expr="ADD(rfComAmt,rfCommAmt)"/>       <!--虚拟账号的退款，直接累计退佣金和累计退款-->
            <set name="OrdStatus"   value="05"/>
            <do func="ExecSql" error="IGNORE">  
               <para name="SqlCmd" sql="UpdPrd1"/>
            </do>
            <if condition="#RetCod==2">
               <set name="RspCod"    value="01003"/>
               <set name="RspMsg"    value="无符合条件记录"/>
               <set name="DWZ_STATUS_CODE"     value="300"/>
               <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
               <return/>
            </if>
            <elseif condition="#RetCod!=0">
               <set name="RspCod"    value="06003"/>
               <set name="RspMsg"    value="更新订单信息错误"/>
               <set name="DWZ_STATUS_CODE"     value="300"/>
               <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
               <return/>
            </elseif> 
         </if>
         <elseif condition="IS_EQUAL_STRING(payType,'04')">  <!-- 混合支付-->
             <if condition="DOUBLECMP(accamt,5,ADD(totRefAmt,rfAmt))">
               <set name="OrdStatus"   value="05"/>
             </if>
             <else>
               <set name="OrdStatus"   value="04"/>
             </else> 
             <delete name="rfTotalAmt"/> <!--混合支付的不更新累计退款，在复核更新-->
             <quote name="UpdPrd"/>
         </elseif> 
         <else>
            <set name="OrdStatus"   value="04"/> 
            <delete name="rfTotalAmt"/> <!--网银支付的不更新累计退款，在复核更新-->
            <quote name="UpdPrd"/>   
         </else>
         <delete name="ordAmt"/> 
         
          <!--通知风控系统登记订单信息-->
          <set name="ServiceCode" value="680517"/>
          <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
          <set name="TCODE"       expr="payOrdNo"/>           <!--平台流水号-->
          <set name="CTYPE"       value="1"/>                 <!--客户类型-->
          <set name="CLIENTCODE"  expr="ruserid"/>            <!--客户编号-->
          <set name="CCODE"       expr="merNo"/>              <!--商户编号-->
          <set name="CNAME"       expr="MERREMARK"/>
          <set name="TRANTYPE"    value="8"/>                 <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
          <set name="Tran_type"   value="4"/>                 <!--交易方式 1网银、2终端、3消费卡、4虚拟积分等-->
          <set name="TAMT"        expr="Amt"/>
          <set name="REGDTTIME"   expr="STRCAT(acDate,acTime)"/>
          <set name="Time"        expr="acDate"/>
          <quote name="noticRcs"/>
          
         <set name="MsgTyp"    value="N"/>
         <set name="RspCod"    value="00000" />
         <set name="RspMsg"    value="交易成功!" />
         <set name="DWZ_STATUS_CODE"   value="200"/>
         <set name="DWZ_RSP_MSG"       expr="RSPMSG"/>
         <set name="DWZ_CALLBACK_TYPE" value="closeCurrent"/>
      </process>
   </transaction>  
   
   <transaction code="RefImportPage" desc="退款跳转到导入页面">
        <process>
            <set name="_REQUESTATTR.FORWARDURL"  value="/WEB-INF/html/bankmessage/refimport.jsp"/>
        </process>
   </transaction>
   
   <transaction code="ProRefFile" desc="退款结果文件处理">
       <sql name="SelRefInf">
         SELECT CUST_ID,MERNO,ORDSTATUS,NVL(rfAmt,0) AS TXAMT,NVL(ACCAMT,0) AS ACCAMT,oriPrdOrdNo,
         NVL(MULAMT,0) AS MULAMT,NVL(FEE,0) AS RFFEE,NVL(NETRECAMT,0) AS NETRECAMT, NVL(filed1,0) AS commAmtRef
         FROM STPREFINF WHERE refOrdNo=#{refOrdNo}
       </sql>
       <sql name="SelFrzInf">
         select PAY_AC_NO,FROZ_AMT,BIZ_CODE,STATUS,FROZ_NO from ARP_AC_FORZZ_DETAILS where BIZ_CODE=#{refOrdNo} and STATUS='01'
       </sql>
       <sql name="UpdFrezInf"><!-- 更新冻结信息-->
          UPDATE ARP_AC_FORZZ_DETAILS SET STATUS='00',LST_UPT_DATE=#{LST_UPT_DATE},LST_UPT_TIME=#{LST_UPT_TIME}  WHERE FROZ_NO=#{FROZ_NO}
       </sql>
       <sql name="UpdRefStatus">
          UPDATE STPREFINF SET rfReqDate=#{SucDat},ORDSTATUS=#{ORDSTATUS},oper_id=#{oper_id},bankerror=#{error} WHERE refOrdNo=#{refOrdNo}
       </sql>
       <sql name="UpdPrdtotal">
         update stpprdinf set rfTotalAmt=(SELECT case when rfTotalAmt is null then 0+${rfAmt} else rfTotalAmt+${rfAmt} end rfTotalAmt FROM stpprdinf WHERE prdOrdNo=#{prdOrdNo} ) 
         where prdOrdNo=#{oriPrdOrdNo} 
       </sql>
       <sql name="QryPayTyp">
        select OrdStatus,payType,prdordtype
        from StpPayInf where PrdOrdNo=#{oriPrdOrdNo}
       </sql>
       <process>
          <if condition="IS_NOEQUAL_STRING(_REQUESTATTR.UPLOADFILES.FILE_UPLOAD_STATUS,'S')">
             <if condition="IS_EQUAL_STRING(_REQUESTATTR.UPLOADFILES.FILE_UPLOAD_STATUS,'T')">
                <set name="RspCod"            value="10005"/>   
                <set name="RspMsg"            value="文件格式不正确"/>   
             </if>
             <elseif condition="IS_EQUAL_STRING(_REQUESTATTR.UPLOADFILES.FILE_UPLOAD_STATUS,'C')">
                <set name="RspCod"            value="10006"/>   
                <set name="RspMsg"            value="超过单个文件大小限制"/>   
             </elseif>
             <elseif condition="IS_EQUAL_STRING(_REQUESTATTR.UPLOADFILES.FILE_UPLOAD_STATUS,'G')">
                <set name="RspCod"            value="10007"/>   
                <set name="RspMsg"            value="未达到单个文件最小文件大小要求"/>   
             </elseif>
             <elseif condition="IS_EQUAL_STRING(_REQUESTATTR.UPLOADFILES.FILE_UPLOAD_STATUS,'F')">
                <set name="RspCod"            value="10008"/>   
                <set name="RspMsg"            value="失败，出现异常"/>   
             </elseif>    
             <return/>
          </if>
          <set name="oper_id"    expr="SESSIONS.UID"/>
          <set name="FILENAME"   expr="_REQUESTATTR.UPLOADFILES.FILE.FILENAME"/>
          <set name="LclFil"     expr="_REQUESTATTR.UPLOADFILES.FILE.FILEOLDNAME"/>   <!--wyy add 20130304-->
          <!--读取xml参数-->
          <set name="ConfigName"   value="FtpPutPay"/>
          <quote name="ReadXmlCfg"/>
          <!--调用移动方法将文件存到web服务器上-->
          <do func="MoveFile">
               <para name="srcDir" expr="ObjDir"    />
               <para name="srcFil" expr="FILENAME"  />
               <para name="tarDir" expr="LclDir"    />
          </do>
          <if condition="#RetCod!=0"> 
               <set name="RspCod" value="01007"/>  
               <set name="RspMsg" value="文件上传失败，请稍后重试！"/>  
               <return/>
          </if>
          <do func="IsValidFile" error="IGNORE">
            <para name="FilNam"  expr="STRCAT(LclDir,FILENAME)"/>
          </do>
          <if condition="#RetCod!=0">
            <set name="RspCod"            value="10002"/>
            <set name="DWZ_STATUS_CODE"   value="300" />
            <set name="DWZ_RSP_MSG"       value="校验文件完整性失败！"/>
            <return/>
          </if>
          
          <do func="TDPaserXLS">
            <para name="FileToPath"       expr="STRCAT(LclDir,'/',FILENAME)"/>
            <para name="SkipRow"          value="2"/>
            <para name="AbandonRow"       value="3"/>
          </do>
          <if condition="#RetCod!=0">
               <set name="RspCod"       value="10003"/>
               <set name="RspMsg"       value="打款文件解析失败"/>
               <set name="DWZ_STATUS_CODE"    value="300" />
               <set name="DWZ_RSP_MSG"        expr="RspMsg"/>
               <do func="RollBackWork"/>
               <return/>
          </if>
          
          <set name="DWZ_STATUS_CODE"         value="200" />
          <set name="DWZ_RSP_MSG"             value="文件已成功提交，系统正在处理中，请于1-2分钟后刷新提现订单记录。" />
          <do func="putresponse"/>
          
          <foreach name="VALUELIST"      iterator="#GRP">
             <set name="prdOrdNo"           expr="#GRP.FILED0"/>
             <set name="refOrdNo"           expr="#GRP.FILED1"/>   
             <set name="FILE_TXAMT"         expr="#GRP.FILED3"/>
             <set name="RESULT"             expr="#GRP.FILED9"/>    
             <set name="ERROR"              expr="#GRP.FILED10"/>
             <if condition="OR(ISNULL(refOrdNo),IS_EQUAL_STRING(refOrdNo,''),ISNULL(FILE_TXAMT),IS_EQUAL_STRING(FILE_TXAMT,''),ISNULL(RESULT),IS_EQUAL_STRING(RESULT,''))">
               <set name="RspMsg"       value="无效数据，默认跳过！"/>
               <continue/>
             </if>
             <!-- 校验订单信息 -->
             <do func="ReadRecord" >
               <para name="SqlCmd" sql="SelRefInf" />
             </do>
             <if condition="#RetCod==2">
               <set name="RspMsg"           value="该订单不存在，跳过！"/>
              <continue/>
             </if>
             <elseif condition="#RetCod!=0">
               <set name="RspMsg"           value="获取订单信息失败，跳过！"/>
               <continue/>
             </elseif>
             <set name="TXAMT1"             expr="AMTPOWER(REPALLSTR(FILE_TXAMT,',',''),2)"/>
             <set name="rfAmt"              expr="TXAMT1"/>
             <set name="TXAMT"              expr="TXAMT"/>
             <set name="ORDSTATUS"          expr="ORDSTATUS"/>
             <set name="CUST_ID"            expr="CUST_ID"/>
             
             <if condition="DOUBLECMP(TXAMT1,4,TXAMT)">
               <set name="RspMsg"         value="该订单金额被篡改，跳过！"/>
               <continue/>
             </if>
             <if condition="IS_EQUAL_STRING(ORDSTATUS,'02')">
               <set name="RspMsg"         value="该订单已退款成功，跳过！"/>
               <continue/>
             </if>
             <elseif condition="IS_EQUAL_STRING(ORDSTATUS,'03')">
               <set name="RspMsg"         value="订单状态已经是退款失败，不能进行更新。跳过！"/>
               <continue/>
             </elseif>
             <!-- 成功 -->
             <if condition="IS_EQUAL_STRING(RESULT,'0')">
                <do func="ReadRecord" >
                  <para name="SqlCmd" sql="QryPayTyp"/>
               </do>
               <if condition="#RetCod==2">
                  <set name="RspCod"    value="01003"/>
                  <set name="RspMsg"    value="无符合条件记录"/>
                  <set name="DWZ_STATUS_CODE"     value="300"/>
                  <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
                  <do func="RollBackWork"/>
                  <return/>
               </if>
               <elseif condition="#RetCod!=0">
                  <set name="RspCod"    value="09999"/>
                  <set name="RspMsg"    value="系统错误"/>
                  <set name="DWZ_STATUS_CODE"     value="300"/>
                  <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
                  <do func="RollBackWork"/>
                  <return/>
               </elseif>
               
               <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                  <set name="rfAfterPay"   value="1"  />    <!--担保交易虚拟账号“是否确定付款”标识，此处代表确定付款-->
               </if>
               
                <if condition="IS_EQUAL_STRING(payType,'04')">        <!-- 混合支付退款--> 
                   <set name="acPayAmtTmp"       expr="accAmt"/>
                   <if condition="ISNULL(rfTotalAmt)">
                      <set name="rfTotalAmt"     value="0"/>  
                   </if> 
                   
                   <!--准备记账参数-->
                   <if condition="DOUBLECMP(rfTotalAmt,5,accamt)">       <!--全部退回网银-->
                      <set name="otPayAmtTmp"    expr="rfAmt"/>
                      
                      <if condition="AND(IS_EQUAL_STRING(PRDORDTYPE,'2'),IS_NOEQUAL_STRING(rfAfterPay,'1'))"><!--担保支付未确认付款前 担保账户-  -->
                        <set name="pltMidPar"  expr="STRCAT('99999900000001','/','04','/','-','/','CNY','/',rfAmt,'/','N','/')"/>  <!--平台担保账户记账参数-->
                        <set name="PARAMS"     expr="pltMidPar"/>
                      </if>
                      <else>     <!--已经支付成功的订单退款 商户- -->
                        <!--查询冻结信息-->
                        <quote name="SelFrzInf"/>
                        
                        <!--账务处理 商户解冻 商户-  --> 
                        <set name="PAY_AC_NO"     expr="PAY_AC_NO"/>
                        <set name="txAmt"         expr="STRCAT('-',FROZ_AMT)"/>
                        <quote name="frezzAmt"/>
                        
                        <!--更新冻结状态-->
                        <quote name="UpdFrezz"/>
                        
                        <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',FROZ_AMT,'/','Y','/')"/>  <!--商户记账参数-->
                        <if condition="AND(IS_NOEQUAL_STRING(rfFee,'0'),IS_NOEQUAL_STRING(commAmtRef,'0'))">    <!--有手续费退佣金-->
                          <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',rfFee,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="commPar"    expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',commAmtRef,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="PARAMS"     expr="STRCAT(merPar,',',commPar,',',feePar)"/>
                        </if>
                        <elseif condition="AND(IS_EQUAL_STRING(rfFee,'0'),IS_NOEQUAL_STRING(commAmtRef,'0'))">  <!--无手续费退佣金-->
                          <set name="commPar"    expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',commAmtRef,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="PARAMS"     expr="STRCAT(merPar,',',commPar)"/> 
                        </elseif>
                        <elseif condition="AND(IS_EQUAL_STRING(rfFee,'0'),IS_EQUAL_STRING(commAmtRef,'0'))">    <!--无手续费不退佣金-->
                          <set name="PARAMS"     expr="merPar"/> 
                        </elseif>
                        <elseif condition="AND(IS_NOEQUAL_STRING(rfFee,'0'),IS_EQUAL_STRING(commAmtRef,'0'))">  <!--有手续费不退佣金-->
                          <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',rfFee,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="PARAMS"     expr="STRCAT(merPar,',',feePar)"/>
                        </elseif>
                      </else>
                   </if>
                   <else>    <!-- 部分退回网银  部分退回用户支付账户-->
                      <set name="acPayAmtTmp"    expr="SUB(accamt,rfTotalAmt)"/>    <!--部分退款至虚拟账户-->
                      <set name="otPayAmtTmp"    expr="SUB(rfAmt,acPayAmtTmp)"/>    <!--部分退款至网银-->
                      
                      <set name="usrPar"         expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',acPayAmtTmp,'/','Y','/')"/>  <!--用户记账参数-->
                      <if condition="AND(IS_EQUAL_STRING(PRDORDTYPE,'2'),IS_NOEQUAL_STRING(rfAfterPay,'1'))"><!--担保支付未确认付款前 担保账户-  -->
                        <set name="pltMidPar"    expr="STRCAT('99999900000001','/','04','/','-','/','CNY','/',rfAmt,'/','N','/')"/>  <!--平台担保账户记账参数-->
                        <set name="PARAMS"       expr="STRCAT(pltMidPar,',',usrPar)"/>
                      </if>
                      <else>     <!--已经支付成功的订单退款 商户- -->
                        <!--查询冻结信息-->
                        <quote name="SelFrzInf"/>
                        
                        <!--解冻金额 --> 
                        <set name="RCS_PRD_NO"    expr="refOrdNo"/><!--订单号，如果不涉及置空-->
                        <set name="PAY_AC_NO"     expr="PAY_AC_NO"/>
                        <set name="txAmt"         expr="STRCAT('-',FROZ_AMT)"/>
                        <quote name="frezzAmt"/>
                        <!--更新冻结状态-->
                        <quote name="UpdFrezz"/>
                        
                        <set name="merPar"       expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',FROZ_AMT,'/','Y','/')"/>  <!--商户记账参数-->
                        <if condition="AND(IS_NOEQUAL_STRING(rfFee,'0'),IS_NOEQUAL_STRING(commAmtRef,'0'))">    <!--有手续费退佣金-->
                          <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',rfFee,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="commPar"    expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',commAmtRef,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="PARAMS"     expr="STRCAT(merPar,',',commPar,',',feePar,',',usrPar)"/>
                        </if>
                        <elseif condition="AND(IS_EQUAL_STRING(rfFee,'0'),IS_NOEQUAL_STRING(commAmtRef,'0'))">  <!--无手续费退佣金-->
                          <set name="commPar"    expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',commAmtRef,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="PARAMS"     expr="STRCAT(merPar,',',commPar,',',usrPar)"/> 
                        </elseif>
                        <elseif condition="AND(IS_EQUAL_STRING(rfFee,'0'),IS_EQUAL_STRING(commAmtRef,'0'))">    <!--无手续费不退佣金-->
                          <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar)"/> 
                        </elseif>
                        <elseif condition="AND(IS_NOEQUAL_STRING(rfFee,'0'),IS_EQUAL_STRING(commAmtRef,'0'))">  <!--有手续费不退佣金-->
                          <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',rfFee,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="PARAMS"     expr="STRCAT(merPar,',',feePar,',',usrPar)"/>
                        </elseif>
                      </else>
                   </else>
                   
                </if>
                <else><!-- 网银支付 等 退款 --> 
                    <!--准备记账参数-->
                    <if condition="AND(IS_EQUAL_STRING(PRDORDTYPE,'2'),IS_NOEQUAL_STRING(rfAfterPay,'1'))"><!--担保支付未确认付款前 担保账户-  -->
                        <set name="pltMidPar"  expr="STRCAT('99999900000001','/','04','/','-','/','CNY','/',rfAmt,'/','N','/')"/>  <!--平台担保账户记账参数-->
                        <set name="PARAMS"     expr="pltMidPar"/>
                    </if>
                    <else>     <!--已经支付成功的订单退款 商户- -->
                        <quote name="SelFrzInf"/>
                        <!--将扣除的金额解冻 并从账户里扣除-->
                        <set name="RCS_PRD_NO"    expr="refOrdNo"/><!--订单号，如果不涉及置空-->
                        <set name="PAY_AC_NO"     expr="PAY_AC_NO"/>
                        <set name="txAmt"         expr="STRCAT('-',FROZ_AMT)"/>
                        <quote name="frezzAmt"/>
                        <set name="txAmt"         expr="FROZ_AMT"/>
                        <!--更新冻结状态-->
                        <quote name="UpdFrezz"/>
                        
                        <set name="merPar"       expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',FROZ_AMT,'/','Y','/')"/>  <!--商户记账参数-->
                        <if condition="AND(IS_NOEQUAL_STRING(rfFee,'0'),IS_NOEQUAL_STRING(commAmtRef,'0'))">  <!--有手续费退佣金-->
                          <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',rfFee,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="commPar"    expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',commAmtRef,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="PARAMS"     expr="STRCAT(merPar,',',commPar,',',feePar)"/>
                        </if>
                        <elseif condition="AND(IS_EQUAL_STRING(rfFee,'0'),IS_NOEQUAL_STRING(commAmtRef,'0'))">  <!--无手续费退佣金-->
                          <set name="commPar"    expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',commAmtRef,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="PARAMS"     expr="STRCAT(merPar,',',commPar)"/> 
                        </elseif>
                        <elseif condition="AND(IS_EQUAL_STRING(rfFee,'0'),IS_EQUAL_STRING(commAmtRef,'0'))">  <!--无手续费不退佣金-->
                          <set name="PARAMS"     expr="merPar"/> 
                        </elseif>
                        <elseif condition="AND(IS_NOEQUAL_STRING(rfFee,'0'),IS_EQUAL_STRING(commAmtRef,'0'))">  <!--有手续费不退佣金-->
                          <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',rfFee,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                          <set name="PARAMS"     expr="STRCAT(merPar,',',feePar)"/>
                        </elseif>
                    </else>
                </else>
                
                <!--记账处理-->
                <set name="TXN_TYP"      value="7"/>      <!--用途 7 退款-->
                <set name="prdordno"     expr="refOrdNo"/>
                <quote name="accProcess"/>
                <if condition="#RetCod!=0">
                   <set name="RspCod"    value="08042"/>
                   <set name="RspMsg"    value="提现失败"/>
                   <set name="DWZ_STATUS_CODE" value="300"/>
                   <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
                   <do func="RollBackWork"/> 
                   <continue/>
                </if>
                
                <set name="ORDSTATUS"     value="02"/>
                <set name="SucDat"        expr="GETDATETIME()"/>
                <!-- 更新退款订单 -->
                <do func="ExecSql" >  
                  <para name="SqlCmd" sql="UpdRefStatus"/>
                </do>
                <if condition="#RetCod==2">
                    <set name="RspMsg"    value="无符合条件记录"/>
                    <do func="RollBackWork"/>
                    <continue/>
                </if>
                <elseif condition="#RetCod!=0">
                    <set name="RspMsg"    value="更新订单信息错误"/>
                    <do func="RollBackWork"/>
                    <continue/>
                </elseif> 
                <!-- 更新商品订单 -->
                <do func="ExecSql" error="IGNORE">  
                   <para name="SqlCmd" sql="UpdPrdtotal"/>
                </do>
                <if condition="#RetCod==2">
                   <set name="RspCod"    value="01003"/>
                   <set name="RspMsg"    value="无符合条件记录"/>
                   <return/>
                </if>
                <elseif condition="#RetCod!=0">
                   <set name="RspCod"    value="06003"/>
                   <set name="RspMsg"    value="更新订单信息错误"/>
                   <return/>
                </elseif>
                <!--通知风控系统登记订单信息-->
                <set name="ServiceCode" value="680517"/>
                <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
                <set name="TCODE"       expr="refOrdNo"/>           <!--平台流水号 退款订单号-->
                <set name="CTYPE"       value="1"/>                 <!--客户类型-->
                <set name="CLIENTCODE"  expr="CUST_ID"/>            <!--客户编号-->
                <set name="CLIENTNAME"  value=" "/>
                <set name="MOBILEPHONE" value=" "/>
                <set name="TRANTYPE"    value="8"/>                 <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
                <set name="TAMT"        expr="rfAmt"/>
                <set name="REGDTTIME"   expr="GETDATETIME()"/>
                <set name="Time"        expr="SUBSTR(SucDat,1,8)"/>
                <quote name="noticRcs"/>
                
             </if>
             <elseif condition="IS_EQUAL_STRING(RESULT,'1')"> <!-- 失败 -->
                <set name="ORDSTATUS"   value="03"/>
                <set name="SucDat"      value=""/>
                <quote name="SelFrzInf"/>
                <!--将金额解冻、退回支付账号 -->
                <set name="RCS_PRD_NO"   expr="refOrdNo"/><!--订单号，如果不涉及置空-->
                <set name="PAY_AC_NO"    expr="PAY_AC_NO"/>
                <set name="txAmt"        expr="STRCAT('-',FROZ_AMT)"/>
                <quote name="frezzAmt"/>
                <set name="txAmt"        expr="FROZ_AMT"/>
                <!--更新冻结状态-->
                <quote name="UpdFrezz"/>
               <!-- 更新退款订单 -->
                <do func="ExecSql" >  
                    <para name="SqlCmd" sql="UpdRefStatus"/>
                </do>
                <if condition="#RetCod==2">
                    <set name="RspMsg"    value="无符合条件记录"/>
                    <do func="RollBackWork"/>
                    <continue/>
                </if>
                <elseif condition="#RetCod!=0">
                    <set name="RspMsg"    value="更新订单信息错误"/>
                    <do func="RollBackWork"/>
                    <continue/>
                </elseif>
             </elseif>
             <else>
                 <set name="RspMsg"       value="系统不识别该结果状态，跳过！"/>
                 <continue/>
             </else>
             <!-- 删除节点 -->
             <delete name="refOrdNo"/>
             <delete name="FILE_TXAMT"/>
             <delete name="RESULT"/>
             <delete name="ERROR"/>
             <delete name="ORDSTATUS"/>
             <delete name="CUST_ID"/>
             <delete name="TXAMT"/>
          </foreach>
          
          <set name="RspCod"          value="00000"/>
          <set name="RspMsg"          value="文件处理完成！"/>
          <set name="DWZ_STATUS_CODE"    value="200" />
          <set name="DWZ_RSP_MSG"        expr="RspMsg"/>
       </process>
   </transaction>
   
   <transaction code="411082" desc="退款导出">
        <!-- 查询用户信息 -->
        <sql name="UsOrLists">
            SELECT t.CUST_ID,t.refordno,t.oriprdordno,inf.cust_login, t.bankCode,t.bankPayUserNm,
                   case when t.bankCode is null then '' else (select  distinct trim(ISSNAM) from  unionfit where trim(ISSNO)=t.bankCode and ROWNUM='1') end BANKCODE_CH,
                   case when t.BANKPAYACNO !=' ' then DECRYPT_DES(t.BANKPAYACNO,'0123456789ABCDEF') end BANKPAYACNO,
                   TO_CHAR(to_number(t.rfamt)/100,'FM9999,999,999,990.00') rfamt,
                   TO_CHAR(to_number(nvl(t.ACCAMT,0))/100,'FM9999,999,999,990.00') ACCAMT,
                   TO_CHAR(to_number(nvl(t.MULAMT,0))/100,'FM9999,999,999,990.00') MULAMT,
                   CASE WHEN t.ORDSTATUS='00' THEN '等待处理' WHEN t.ORDSTATUS='02' THEN '退款成功' WHEN t.ORDSTATUS='03' THEN '退款失败' END ORDSTATUS_CH,
                   case when t.rfOrdTime !=' ' then To_Char(to_date(t.rfOrdTime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') end rfOrdTime 
              FROM StpRefInf t left join stpusrinf inf on t.cust_id=inf.cust_id
             WHERE  (t.CUST_ID = #{CUST_ID} or ' '= #{CUST_ID}||' ')
               AND (t.OrdStatus = #{OrdStatus} or ' '= #{OrdStatus}||' ')
               AND (t.refOrdNo = #{refOrdNo} or ' '= #{refOrdNo}||' ')
               AND (t.ORIPRDORDNO = #{ORIPRDORDNO} or ' '= #{ORIPRDORDNO}||' ') 
               AND t.rfOrdTime BETWEEN #{begin_date_temp} AND #{end_date_temp}  
               AND (inf.cust_login like '%'||#{cust_login}||'%' or ' '= #{cust_login}||' ') 
               AND t.rfAmt BETWEEN to_number(#{ordAmt1_temp}) AND to_number(#{ordAmt2_temp}) 
             ORDER BY t.rfOrdTime desc,t.rfreqdate desc,t.bankCode ,t.OrdStatus
        </sql>
        <process>
            <set name="CUST_ID"     expr="DELBOTHSPACE(CUST_ID)"    />
            <set name="OrdStatus"   expr="DELBOTHSPACE(OrdStatus)"  />
            <set name="refOrdNo"    expr="DELBOTHSPACE(refOrdNo)"   />
            <set name="rfreqdate"   expr="DELBOTHSPACE(rfreqdate)"  />
            <set name="ORIPRDORDNO" expr="DELBOTHSPACE(ORIPRDORDNO)"/>
            <set name="CUST_LOGIN"  expr="DELBOTHSPACE(CUST_LOGIN)" />
            <set name="operating"   value="bankmessage/refund_list.jsp"/>
          
            <if condition="ISNULL(PageNum)">
               <set name="PageNum"             value="1"/>
            </if>
            <if condition="ISNULL(NumPerPag)">
               <set name="NumPerPag"           value="19"/>
            </if>
            <set name="begin_date_temp"     value="19700101" />
            <set name="end_date_temp"       value="20991231" />
            <set name="ordAmt1_temp"        value="0"        />
            <set name="ordAmt2_temp"        value="999999999999999"/>
            
            <if condition="NOT(ISNULL(begin_date))">
                <set name="begin_date_temp" expr="begin_date" />
            </if>
            <if condition="NOT(ISNULL(end_date))">
                <set name="end_date_temp"   expr="end_date" />
            </if>
            <if condition="NOT(ISNULL(ordAmt1))">
                <set name="ordAmt1_temp"    expr="AMTPOWER(ordAmt1,2)" />
            </if>
            <if condition="NOT(ISNULL(ordAmt2))">
                <set name="ordAmt2_temp"    expr="AMTPOWER(ordAmt2,2)" />
            </if>
            
            <set name="begin_date_temp" expr="STRCAT(begin_date_temp,'000000')" />
            <set name="end_date_temp"   expr="STRCAT(end_date_temp  ,'235959')" />
            
            <do func="QueryInGroup">
                <para name="SqlCmd"     sql="UsOrLists" />
                <para name="RecordName" value="reportList" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"               value="02024"/>
                <set name="RspMsg"               value="无信息"/>
                <set name="DWZ_STATUS_CODE"      value="300"/>
                <set name="DWZ_RSP_MSG"          expr="RspMsg"/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"               value="09999"/>
                <set name="RspMsg"               value="系统错误" />
                <set name="DWZ_STATUS_CODE"      value="300"/>
                <set name="DWZ_RSP_MSG"          expr="RspMsg"/>
                <return/>
            </elseif>
            
            <!--查询成功-->
            <do func="ReportExport" error="IGNORE">
                <para name="Root"          value="reportList"/>
                <para name="FileDemo"      value="rufunds_orders"/> <!--导出模板名-->
                <para name="NameForUser"   value="rufunds_"/> <!--导出文件名-->
                <para name="FilePath"      value="rptdemo"/>       <!--导出模板路径-->
                <para name="FileToPath"    value="/dat/download"/> <!--导出目标地址-->
                <para name="WebPath"       expr="GETCURAPPHOME()"/>
                <para name="params"        value="ORIPRDORDNO/REFORDNO/ORDSTATUS_CH/RFAMT/BANKPAYUSERNM/CUST_LOGIN/BANKPAYACNO/BANKCODE_CH/RFORDTIME"/>
                <para name="collectParams" value=""/> <!--导出总条数，总金额如果没有传空-->
            </do>   
            <if condition="#RetCod!=0">
                <set name="RspCod"    value="02103"/>
                <set name="RspMsg"    value="导出出错!"/>
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG" expr="RSPMSG"/> 
                <return/>
            </if>
            <else>
                <set name="FILENAME"                 expr="#FILENAME"/>
                <set name="ConfigName"               value="FtpPutPay"/>
                <quote name="ReadXmlCfg"/>
                
                <!--调用移动方法将文件存到web服务器上-->  
                <do func="MoveFile">
                    <para name="srcDir" expr="LclDir"    />
                    <para name="srcFil" expr="FILENAME"  />
                    <para name="tarDir" expr="ObjDir"    />
                </do>
                <if condition="#RetCod!=0"> 
                    <set name="RspCod" value="01007"/>  
                    <set name="RspMsg" value="移动文件错误!"/>  
                    <return/> 
                </if>
                
                <set name="pos_webapps"     expr="GETSTRPOS(ObjDir,'/webapps/')"                                />
                <set name="ObjDir"          expr="RIGHTSTR(ObjDir,SUB(STRLEN(ObjDir),ADD(pos_webapps,8)))"      />
                
                <set name="_REQUESTATTR.REDIRECTURL"                         expr="STRCAT('/',ObjDir,'/',FILENAME)"/>
                <set name="RspCod"                   value="00000"/>
                <set name="RspMsg"                   value="导出成功"/>
                <set name="DWZ_STATUS_CODE"          value="200"/>
                <set name="DWZ_RSP_MSG"              expr="RspMsg"/>
            </else>
        </process>
   </transaction>
    
    <transaction code="411070" desc="充值订单查询">
        <sql name="userOredr">             
            SELECT B.PAYORDNO,B.PRDORDNO,B.PRDORDTYPE,B.ORDSTATUS,B.CUST_ID,
                   TO_CHAR(TO_DATE(B.ORDERTIME,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')AS ORDERTIME,
                   TO_CHAR(TO_NUMBER(B.ORDAMT)/100,'FM9999,999,999,990.00')AS ORDAMT,
                   TO_CHAR(TO_NUMBER(NVL(B.txnComAmt,0))/100,'FM9999,999,999,990.00') AS fee,
                   inf.cust_login,c.CUST_NAME,B.merno,
                   B.ORDSTATUS as ORDSTATUS_CC_PRDORDSTATUS,
                   case when p.actdat !=' ' then TO_CHAR(to_date(p.actdat,'yyyymmddhh24miss'),'yyyy-mm-dd  hh24:mi:ss')end actdat  
              FROM vw_STPPRDINF B left join stpusrinf inf on B.cust_id = inf.cust_id 
              		 left join stpcusinf c on  B.cust_id = c.cust_id 
              		left join stppayinf p on B.prdordno = p.prdordno and p.payordno = B.payordno
             WHERE  B.ORDERTIME BETWEEN #{begin_date_temp} AND #{end_date_temp}  
               AND  B.PRDORDTYPE='1'
               AND (inf.CUST_LOGIN = #{CUST_LOGIN} or ' '= #{CUST_LOGIN}||' ') 
               AND B.ordAmt BETWEEN to_number(#{ordAmt1_temp}) AND to_number(#{ordAmt2_temp}) 
               ${PRDORDNOL} 
               ${PAYORDNOL}  
               ${PAYTYPEL} 
               ${ORDSTATUSL} 
               ${TXNDATE}
          ORDER BY B.ORDERTIME desc          
        </sql>
        <sql name="ordamtS">
            SELECT TO_CHAR(to_number(SUM(B.ORDAMT))/100,'FM9999,999,999,990.00')AS ORDAMTS
              FROM vw_STPPRDINF B left join stpusrinf inf on B.cust_id = inf.cust_id 
              		 left join stppayinf p on B.prdordno = p.prdordno and p.payordno = B.payordno
             WHERE B.ORDERTIME BETWEEN #{begin_date_temp} AND #{end_date_temp} 
               AND B.PRDORDTYPE='1' 
               AND (inf.CUST_LOGIN = #{CUST_LOGIN} or ' '= #{CUST_LOGIN}||' ') 
               AND B.ordAmt BETWEEN to_number(#{ordAmt1_temp}) AND to_number(#{ordAmt2_temp}) 
             ${PRDORDNOL} 
             ${PAYORDNOL}  
             ${PAYTYPEL} 
             ${ORDSTATUSL}
             ${TXNDATE} 
        </sql>
        <process>
            <do func="GetOwnButton"/>
            <set name="_REQUESTATTR.FORWARDURL"  value="/WEB-INF/html/userOredr/userOredr.jsp"/>
            <!--检查用户登录平台是否正确-->
            <if condition="IS_NOEQUAL_STRING(SysCod,'1120')">
                <set name="RspCod"          value="01001"/>
                <set name="RspMsg"          value="用户登录平台不正确"/>
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG"     expr="RspMsg"/>
                <return/>
            </if>
            
            <set name="PageNum"         expr="DELBOTHSPACE(PageNum)"/>
            <set name="PRDORDNO"        expr="DELBOTHSPACE(PRDORDNO)"/>
            <set name="PAYORDNO"        expr="DELBOTHSPACE(PAYORDNO)"/>
            <set name="CUST_LOGIN"      expr="DELBOTHSPACE(CUST_LOGIN)"/>
            <set name="pay_begin_date"      expr="DELBOTHSPACE(pay_begin_date)"/>
            <set name="pay_end_date"        expr="DELBOTHSPACE(pay_end_date)"/>
            <set name="PRDORDNOL"       value=""/>
            <set name="PAYORDNOL"       value=""/>
            <set name="ORDSTATUSL"      value=""/>
            <set name="begin_date_temp" value="19700101" />
            <set name="end_date_temp"   value="20991231" />
            <set name="ordAmt1_temp"    value="0"        />
            <set name="ordAmt2_temp"    value="999999999999999"/>
            
            <if condition="ISNULL(PageNum)">
                <set name="PageNum"     value="1"/>
            </if>
            
            <if condition="NOT(ISNULL(PRDORDNO))">
                <!-- PRDORDNO 商品订单号 -->
                <set name="PRDORDNOL"   expr="STRCAT('AND B.PRDORDNO=\'',PRDORDNO,'\'')"/>
            </if>
            
            <if condition="NOT(ISNULL(PAYORDNO))">
                <!-- PAYORDNO 支付订单号 -->
                <set name="PAYORDNOL"   expr="STRCAT('AND B.PAYORDNO=\'',PAYORDNO,'\'')"/>
            </if>
            
            <if condition="NOT(ISNULL(ORDSTATUS))">
                <!-- ORDSTATUS 订单状态 -->
                <set name="ORDSTATUSL"           expr="STRCAT('AND B.ORDSTATUS=\'',ORDSTATUS,'\'')"/>
            </if>
            
            <if condition="NOT(ISNULL(begin_date))">
                <set name="begin_date_temp" expr="begin_date" />
            </if>
            <if condition="NOT(ISNULL(end_date))">
                <set name="end_date_temp"   expr="end_date" />
            </if>
            <if condition="NOT(ISNULL(ordAmt1))">
                <set name="ordAmt1_temp"    expr="AMTPOWER(ordAmt1,2)" />
            </if>
            <if condition="NOT(ISNULL(ordAmt2))">
                <set name="ordAmt2_temp"    expr="AMTPOWER(ordAmt2,2)" />
            </if>
            
            <set name="begin_date_temp" expr="STRCAT(begin_date_temp,'000000')" />
            <set name="end_date_temp"   expr="STRCAT(end_date_temp  ,'235959')" />

            <if condition="AND(NOT(ISNULL(pay_begin_date)),NOT(ISNULL(pay_end_date)))">
                <if condition="INTCMP(STRCMP(pay_begin_date,pay_end_date),6,0)">
                	<set name="RsgMsg"          value="01002"   />
                	<set name="RspMsg"          value="支付开始日期不能早于结束日期"/>
                	<set name="DWZ_STATUS_CODE" value="300"     />
                	<set name="DWZ_RSP_MSG"     expr="RspMsg"   />
                	<return/>
            		</if>
            		<set name="pay_begin_date_temp" expr="STRCAT(pay_begin_date,'000000')" />
            		<set name="pay_end_date_temp"   expr="STRCAT(pay_end_date  ,'235959')" />
            		<set name="TXNDATE" expr="STRCAT(' AND p.actdat BETWEEN  ',fh,pay_begin_date_temp,fh,' AND ',fh,pay_end_date_temp,fh)"/>
            </if>
            <elseif condition="AND(NOT(ISNULL(pay_begin_date)),ISNULL(pay_end_date))">
                <set name="pay_begin_date_temp" expr="STRCAT(pay_begin_date,'000000')" />
            		<set name="pay_end_date_temp"   value="20991231235959" />
            		<set name="TXNDATE" expr="STRCAT(' AND p.actdat BETWEEN  ',fh,pay_begin_date_temp,fh,' AND ',fh,pay_end_date_temp,fh)"/>
            </elseif>
            <elseif condition="AND(ISNULL(pay_begin_date),NOT(ISNULL(pay_end_date)))">
                <set name="pay_begin_date_temp" value="19700101000000" />
            		<set name="pay_end_date_temp"   expr="STRCAT(pay_end_date  ,'235959')" />
            		<set name="TXNDATE" expr="STRCAT(' AND p.actdat BETWEEN  ',fh,pay_begin_date_temp,fh,' AND ',fh,pay_end_date_temp,fh)"/>
            </elseif>
            <else>
            	<set name="TXNDATE" value=""/>
            </else>            
            
            <!-- 设置下拉框 商品订单状态 -->
            <set name="DICTNAME_PRDORDSTATUS"  expr="STRCAT('PRDORDSTATUS:',OrdStatus)"/>
            <do func="CreateDictOption" error="IGNORE">
                <para name="DictCodes"    expr="DICTNAME_PRDORDSTATUS"/>
            </do>
            
            <!-- 充值订单查询 -->
            <do func="PagedQuery" error="ignore">
                <para name="PageNum"    expr="PageNum"/>
                <para name="NumPerPag"  expr="NumPerPag"/>
                <para name="Sql"        sql="userOredr"/>
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"          value="02001"/>
                <set name="RspMsg"          value="无信息"/>
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG"     expr="RspMsg"/>
                <return/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"          value="09999"/>
                <set name="RspMsg"          value="系统错误"/>
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG"     expr="RspMsg"/>
                <return/>
            </elseif>
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="ordamtS" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"          value="09999"/>
                <set name="RspMsg"          value="系统错误"/>
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG"     expr="RspMsg"/>
                <return/>
            </if>
            
            <do func="FormatDict2Etf" error="IGNORE"/>
            
            <set name="RspCod"          value="00000"/>
            <set name="RspMsg"          value="交易成功"/>
            <set name="DWZ_STATUS_CODE" value="200"/>
            <set name="DWZ_RSP_MSG"     expr="RspMsg"/>
        </process>
   </transaction>
   
   <transaction code="411071" desc="充值订单详情">
       <sql name="userOredrs">
           SELECT To_Char(to_date(B.ORDERTIME,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') AS ORDERTIME,
                  To_Char(to_date(A.ACTDAT,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') AS ACTDAT,
                  TO_CHAR(to_number(B.ORDAMT)/100,'FM9999,999,999,990.00')AS ORDAMT,
                  TO_CHAR(to_number(nvl(B.txnComAmt,0))/100,'FM9999,999,999,990.00') AS fee, 
                  B.PAYORDNO,B.PRDORDNO,B.CUST_ID,B.PRDORDTYPE,B.ORDSTATUS,B.PRDNAME,
                  A.PAYTYPE,A.BANKCOD  
             FROM STPPAYINF A LEFT JOIN STPPRDINF B ON (TRIM(A.PAYORDNO)=TRIM(B.PAYORDNO)) 
            WHERE B.PRDORDNO=#{PRDORDNO} 
              AND B.PAYORDNO=#{PAYORDNO}
       </sql>
       <process>
           <set name="_REQUESTATTR.FORWARDURL"  value="/WEB-INF/html/userOredr/userOredrs.jsp"/>
           <!--检查用户登录平台是否正确-->
           <if condition="IS_NOEQUAL_STRING(SysCod,'1120')">
               <set name="RspCod"               value="01001"             />
               <set name="RspMsg"               value="用户登录平台不正确"/>
               <set name="DWZ_STATUS_CODE"      value="300"  />
               <set name="DWZ_RSP_MSG"          expr="RspMsg"/>
               <return/>
           </if>
           <if condition="ISNULL(PageNum)">
               <set name="PageNum"              value="1"/>
           </if>
           <!-- 充值订单详情411071 -->
           <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd" sql="userOredrs" />
           </do>
           <if condition="#RetCod==2">
               <set name="RspCod"               value="02001"/>
               <set name="RspMsg"               value="没有商户开户银行信息"/>
               <set name="DWZ_STATUS_CODE"      value="300"/>
               <set name="DWZ_RSP_MSG"          expr="RspMsg"/>
               <return/>
           </if>
           <elseif condition="#RetCod!=0">
               <set name="RspCod"               value="09999"/>
               <set name="RspMsg"               value="系统错误"/>
               <set name="DWZ_STATUS_CODE"      value="300"/>
               <set name="DWZ_RSP_MSG"          expr="RspMsg"/>
               <return/>
           </elseif>
           
           <!-- 获取数据字典中文 -->
            <set name="DICTNAME_STR"  expr="STRCAT('PRDORDSTATUS:',ORDSTATUS,',PAYTYPE:',PAYTYPE,',BANKNAM:',BANKCOD)"/>
            <do func="GetDictCh" error="IGNORE">
                <para name="DictCodes"    expr="DICTNAME_STR"/>
            </do>
           
           <set name="RspCod"                   value="00000"/>
           <set name="RspMsg"                   value="交易成功"/>
       </process>
   </transaction> 
   
    <transaction code="411077" desc="充值导出">
        <!-- 查询用户信息 -->
        <sql name="UsOrList">                                                                                                                                                                   
            SELECT B.PRDORDNO,
                   B.PAYORDNO,
                   inf.cust_login,
                   c.CUST_NAME,
                   TO_CHAR(TO_NUMBER(B.ORDAMT)/100,'FM9999,999,999,990.00')AS ORDAMT,
                   TO_CHAR(TO_NUMBER(NVL(B.txnComAmt,0))/100,'FM9999,999,999,990.00') AS fee,
                   B.PRDORDTYPE as PRDORDTYPE_CC_PRDORDTYPE,
                   B.ORDSTATUS as ORDSTATUS_CC_PRDORDSTATUS,
                   TO_CHAR(TO_DATE(B.ORDERTIME,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')AS ORDERTIME,
                   case when p.actdat !=' ' then TO_CHAR(to_date(p.actdat,'yyyymmddhh24miss'),'yyyy-mm-dd  hh24:mi:ss')end actdat
              FROM vw_STPPRDINF B left join stpusrinf inf on B.cust_id = inf.cust_id 
              		 left join stpcusinf c on  B.cust_id = c.cust_id 
              		left join stppayinf p on B.prdordno = p.prdordno and p.payordno = B.payordno
             WHERE B.ORDERTIME BETWEEN #{begin_date_temp} AND #{end_date_temp}
               AND B.PRDORDTYPE='1' 
               AND (inf.CUST_LOGIN = #{CUST_LOGIN} or ' '= #{CUST_LOGIN}||' ') 
               AND B.ordAmt BETWEEN to_number(#{ordAmt1_temp}) AND to_number(#{ordAmt2_temp}) 
               ${PRDORDNOL} 
               ${PAYORDNOL}  
               ${PAYTYPEL} 
               ${ORDSTATUSL} 
               ${TXNDATE}
          ORDER BY B.ORDERTIME desc
        </sql>
        <process>
            <set name="PRDORDNO"        expr="DELBOTHSPACE(PRDORDNO)"/>
            <set name="PAYORDNO"        expr="DELBOTHSPACE(PAYORDNO)"/>
            <set name="CUST_LOGIN"      expr="DELBOTHSPACE(CUST_LOGIN)"/>
            <set name="pay_begin_date"      expr="DELBOTHSPACE(pay_begin_date)"/>
            <set name="pay_end_date"        expr="DELBOTHSPACE(pay_end_date)"/>            
            <set name="PRDORDNOL"       value=""/>
            <set name="PAYORDNOL"       value=""/>
            <set name="ORDSTATUSL"      value=""/>
            <set name="begin_date_temp" value="19700101" />
            <set name="end_date_temp"   value="20991231" />
            <set name="ordAmt1_temp"    value="0"        />
            <set name="ordAmt2_temp"    value="999999999999999"/>
            
            <if condition="ISNULL(PageNum)">
                <set name="PageNum"     value="1"/>
            </if>
            
            <if condition="NOT(ISNULL(PRDORDNO))">
                <!-- PRDORDNO 商品订单号 -->
                <set name="PRDORDNOL"   expr="STRCAT('AND B.PRDORDNO=\'',PRDORDNO,'\'')"/>
            </if>
            
            <if condition="NOT(ISNULL(PAYORDNO))">
                <!-- PAYORDNO 支付订单号 -->
                <set name="PAYORDNOL"   expr="STRCAT('AND B.PAYORDNO=\'',PAYORDNO,'\'')"/>
            </if>
            
            <if condition="NOT(ISNULL(ORDSTATUS))">
                <!-- ORDSTATUS 订单状态 -->
                <set name="ORDSTATUSL"           expr="STRCAT('AND B.ORDSTATUS=\'',ORDSTATUS,'\'')"/>
            </if>
            
            <if condition="NOT(ISNULL(begin_date))">
                <set name="begin_date_temp" expr="begin_date" />
            </if>
            <if condition="NOT(ISNULL(end_date))">
                <set name="end_date_temp"   expr="end_date" />
            </if>
            <if condition="NOT(ISNULL(ordAmt1))">
                <set name="ordAmt1_temp"    expr="AMTPOWER(ordAmt1,2)" />
            </if>
            <if condition="NOT(ISNULL(ordAmt2))">
                <set name="ordAmt2_temp"    expr="AMTPOWER(ordAmt2,2)" />
            </if>
            
            <set name="begin_date_temp" expr="STRCAT(begin_date_temp,'000000')" />
            <set name="end_date_temp"   expr="STRCAT(end_date_temp  ,'235959')" />

            <if condition="AND(NOT(ISNULL(pay_begin_date)),NOT(ISNULL(pay_end_date)))">
                <if condition="INTCMP(STRCMP(pay_begin_date,pay_end_date),6,0)">
                	<set name="RsgMsg"          value="01002"   />
                	<set name="RspMsg"          value="支付开始日期不能早于结束日期"/>
                	<set name="DWZ_STATUS_CODE" value="300"     />
                	<set name="DWZ_RSP_MSG"     expr="RspMsg"   />
                	<return/>
            		</if>
            		<set name="pay_begin_date_temp" expr="STRCAT(pay_begin_date,'000000')" />
            		<set name="pay_end_date_temp"   expr="STRCAT(pay_end_date  ,'235959')" />
            		<set name="TXNDATE" expr="STRCAT(' AND p.actdat BETWEEN  ',fh,pay_begin_date_temp,fh,' AND ',fh,pay_end_date_temp,fh)"/>
            </if>
            <elseif condition="AND(NOT(ISNULL(pay_begin_date)),ISNULL(pay_end_date))">
                <set name="pay_begin_date_temp" expr="STRCAT(pay_begin_date,'000000')" />
            		<set name="pay_end_date_temp"   value="20991231235959" />
            		<set name="TXNDATE" expr="STRCAT(' AND p.actdat BETWEEN  ',fh,pay_begin_date_temp,fh,' AND ',fh,pay_end_date_temp,fh)"/>
            </elseif>
            <elseif condition="AND(ISNULL(pay_begin_date),NOT(ISNULL(pay_end_date)))">
                <set name="pay_begin_date_temp" value="19700101000000" />
            		<set name="pay_end_date_temp"   expr="STRCAT(pay_end_date  ,'235959')" />
            		<set name="TXNDATE" expr="STRCAT(' AND p.actdat BETWEEN  ',fh,pay_begin_date_temp,fh,' AND ',fh,pay_end_date_temp,fh)"/>
            </elseif>
            <else>
            	<set name="TXNDATE" value=""/>
            </else> 
                    
            <do func="QueryInGroup">
                <para name="SqlCmd"      sql="UsOrList" />
                <para name="RecordName"  value="reportList" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"           value="02001"/>
                <set name="RspMsg"           value="无信息"/>
                <set name="DWZ_STATUS_CODE"  value="300"/>
                <set name="DWZ_RSP_MSG"      expr="RspMsg"/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"           value="09999"/>
                <set name="RspMsg"           value="系统错误" />
                <set name="DWZ_STATUS_CODE"  value="300"/>
                <set name="DWZ_RSP_MSG"      expr="RspMsg"/>
                <return/>
            </elseif>
            
            <do func="FormatDict2Etf" error="IGNORE">
                <para name="RecNam" value="REPORTLIST" />
            </do>
            
            <!--查询成功-->
            <do func="ReportExport" error="IGNORE">
                 <para name="Root"          value="reportList"/>
                 <para name="FileDemo"      value="recharge"/> <!--导出模板名-->
                 <para name="NameForUser"   value="recharge"/> <!--导出文件名-->
                 <para name="FilePath"      value="rptdemo"/>       <!--导出模板路径-->
                 <para name="FileToPath"    value="/dat/download"/> <!--导出目标地址-->
                 <para name="WebPath"       expr="GETCURAPPHOME()"/> 
                 <para name="params"        value="PRDORDNO/PAYORDNO/CUST_LOGIN/CUST_NAME/ORDAMT/FEE/PRDORDTYPE_CH/ORDSTATUS_CH/ORDERTIME/ACTDAT"/>
                 <para name="collectParams" value=""/> <!--导出总条数，总金额如果没有传空-->
            </do>   
            <if condition="#RetCod!=0">
                <set name="RspCod"    value="02103"/>
                <set name="RspMsg"    value="导出出错!"/>
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG" expr="RSPMSG"/> 
                <return/>
            </if>
            
            <set name="FILENAME"    expr="#FILENAME"/>
            <set name="ConfigName"  value="FtpPutPay"/>
            <quote name="ReadXmlCfg"/>
            
            <!--调用移动方法将文件存到web服务器上-->  
            <do func="MoveFile">
                <para name="srcDir" expr="LclDir"    />
                <para name="srcFil" expr="FILENAME"  />
                <para name="tarDir" expr="ObjDir"    />
            </do>
            <if condition="#RetCod!=0"> 
                <set name="RspCod" value="01007"/>  
                <set name="RspMsg" value="移动文件错误!"/>  
                <return/> 
            </if>
            
            <set name="pos_webapps"     expr="GETSTRPOS(ObjDir,'/webapps/')"                                />
            <set name="ObjDir"          expr="RIGHTSTR(ObjDir,SUB(STRLEN(ObjDir),ADD(pos_webapps,8)))"      />
            
            <set name="_REQUESTATTR.REDIRECTURL"                         expr="STRCAT('/',ObjDir,'/',FILENAME)"/>
            <set name="RspCod"                   value="00000"/>
            <set name="RspMsg"                   value="导出成功"/>
            <set name="DWZ_STATUS_CODE"          value="200"/>
            <set name="DWZ_RSP_MSG"              expr="RspMsg"/>
        </process>
    </transaction>   
   
   <transaction code="411074" desc="冻结和解冻">        
       <sql name="ztsele">
           SELECT ORDSTATUS AS STATUS ,FILED3
             FROM STPPRDINF 
            WHERE PRDORDNO=#{PRDORDNO} AND MERNO=#{MERNO}     
       </sql>
       <process>
           <!--检查用户登录平台是否正确-->
           <if condition="IS_NOEQUAL_STRING(SysCod,'1120')">
               <set name="RspCod"               value="01001"/>
               <set name="RspMsg"               value="用户登录平台不正确"/>
               <set name="DWZ_STATUS_CODE"      value="300"/>
               <set name="DWZ_RSP_MSG"          expr="RspMsg"/>
               <return/>
           </if>
           <do func="GetOwnButton"/>
           <if condition="ISNULL(PageNum)">
               <set name="PageNum"              value="1"/>
           </if>
           <if condition="IS_EQUAL_STRING(PL,'000')">
               <set name="_REQUESTATTR.FORWARDURL"                      value="/WEB-INF/html/merchOrdStat/merchOrdStat.jsp"/>
               <return/>
           </if>
           <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd" sql="ztsele" />
           </do>
           <if condition="#RetCod==2">
               <set name="RspCod"               value="09999"/>
               <set name="RspMsg"               value="输入信息错误"/>
               <set name="DWZ_STATUS_CODE"      value="300"/>
               <set name="DWZ_RSP_MSG"          expr="RspMsg"/>
               <return/>
           </if>            
           <elseif condition="#RetCod!=0">
               <set name="RspCod"               value="09999"/>
               <set name="RspMsg"               value="系统错误"/>
               <set name="DWZ_STATUS_CODE"      value="300"/>
               <set name="DWZ_RSP_MSG"          expr="RspMsg"/>
               <return/>
           </elseif>
           <if condition="IS_EQUAL_STRING(ORDSTATUS,'14')">
               <if condition="IS_EQUAL_STRING(STATUS,'14')">
                   <set name="RspCod"           value="01001"/>
                   <set name="RspMsg"           value="订单已经冻结"/>
                   <set name="DWZ_STATUS_CODE"  value="300"/>
                   <set name="DWZ_RSP_MSG"      expr="RspMsg"/>
                   <return/>
               </if>
               <elseif condition="IS_EQUAL_STRING(STATUS,'00')">
                  <set name="FILED3"           expr="STATUS"/>
                   <do func="DataEntry" error="IGNORE">
                      <para name="TableName"           value="STPPRDINF"/>
                      <para name="Method"              value="UPDATE"/>
                      <para name="Columns"             value="ORDSTATUS/FILED3/"/>
                      <para name="keys"                value="PRDORDNO/MERNO/"/>
                   </do>           
                   <if condition="#RetCod!=0">
                      <set name="RspCod"               value="09999"/>
                      <set name="RspMsg"               value="系统错误"/>
                      <set name="DWZ_STATUS_CODE"      value="300"/>
                      <set name="DWZ_RSP_MSG"          expr="RspMsg"/>
                      <return/>
                  </if>
               </elseif>                    
               <elseif condition="IS_EQUAL_STRING(STATUS,'01')">
                 <set name="FILED3"           expr="STATUS"/>
                 <do func="DataEntry" error="IGNORE">
                      <para name="TableName"           value="STPPRDINF"/>
                      <para name="Method"              value="UPDATE"/>
                      <para name="Columns"             value="ORDSTATUS/FILED3/"/>
                      <para name="keys"                value="PRDORDNO/MERNO/"/>
                   </do>           
                   <if condition="#RetCod!=0">
                      <set name="RspCod"               value="09999"/>
                      <set name="RspMsg"               value="系统错误"/>
                      <set name="DWZ_STATUS_CODE"      value="300"/>
                      <set name="DWZ_RSP_MSG"          expr="RspMsg"/>
                      <return/>
                  </if>
               </elseif>             
               <elseif condition="AND(IS_NOEQUAL_STRING(STATUS,'01'),IS_NOEQUAL_STRING(STATUS,'00'))">
                  <set name="RspCod"               value="01001"/>
                  <set name="RspMsg"               value="订单非 未支付和支付成功 状态不可冻结" />
                  <set name="DWZ_STATUS_CODE"      value="300"/>
                  <set name="DWZ_RSP_MSG"          expr="RspMsg"/>
                  <return/>      
               </elseif>             
               <set name="RspCod"                   value="00000"/>
               <set name="RspMsg"                   value="操作成功"/>
               <set name="DWZ_STATUS_CODE"          value="200"/>
               <set name="DWZ_RSP_MSG"              expr="RspMsg"/>                                                                                             
               <return/> 
           </if>
           <if condition="IS_EQUAL_STRING(STATUS,'14')">
              <set name="ORDSTATUS"       expr="FILED3"/>
              <do func="DataEntry" error="IGNORE">                  
                  <para name="TableName"           value="STPPRDINF"/>
                  <para name="Method"              value="UPDATE"/>
                  <para name="Columns"             value="ORDSTATUS/"/>
                  <para name="keys"                value="PRDORDNO/MERNO/"/>
               </do>           
               <if condition="#RetCod!=0">
                  <set name="RspCod"               value="09999"/>
                  <set name="RspMsg"               value="系统错误"/>
                  <set name="DWZ_STATUS_CODE"      value="300"/>
                  <set name="DWZ_RSP_MSG"          expr="RspMsg"/>
                  <return/>
               </if>
           </if>  
           <else>
               <set name="RspCod"               value="01001"/>
               <set name="RspMsg"               value="该订单未被冻结"/>
               <set name="DWZ_STATUS_CODE"      value="300"/>
               <set name="DWZ_RSP_MSG"          expr="RspMsg"/>
               <return/>
           </else>                                  
           <set name="RspCod"                   value="00000"/>
           <set name="RspMsg"                   value="操作成功"/>
           <set name="DWZ_STATUS_CODE"          value="200"/>
           <set name="DWZ_RSP_MSG"              expr="RspMsg"/>
       </process>
   </transaction>
   
   <transaction code="411171" desc="预付卡订单信息">
     <sql name="QryPrdInf"> <!--查询商品订单信息 -->
         SELECT  nvl(s.ordAmt,' ') AS ordAmt,TO_CHAR(to_number(s.ORDAMT)/100,'FM9999,999,999,990.00')AS ORDAMTS,p.paytype,
                 nvl(s.prdordno,' ') AS prdordno,s.seqno,s.ordstatus,s.notifyurl,returl,s.filed4,
                 sellRptAmt,s.prdName,nvl(prdShortName,' ') as prdShortName,bizType,
                 ordamt*buyCount as  TOTALAMT,TO_CHAR(to_number(ordamt*buyCount)/100,'FM9999,999,999,990.00')AS TotalAMTS,
                 nvl(prdDesc,' ') as prdDesc,nvl(s.merRemark,' ') as merRemark,custRptAcNo,TranSort, s.PRDORDTYPE,
                 To_Char(to_date(ORDERTIME,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss')AS ORDERTIME,buyCount
           FROM stpprdinf s ,stppayinf  p WHERE s.prdordno=p.prdordno and s.merNo='999999' AND s.prdordtype='5'  
                ${PRDORDNOL} ${FILED4L}  ${NOTIFYURLL} ${PAYTYPEL}  ${ORDERTIMEL} ${ORDSTATUSL}
           ORDER BY ORDERTIME DESC
     </sql>
     <process>
        <set name="_REQUESTATTR.FORWARDURL"  value="/WEB-INF/html/userOredr/userbuycardorders.jsp"/>
        <!--检查用户登录平台是否正确-->
        <if condition="IS_NOEQUAL_STRING(SysCod,'1120')">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="11200"/>
           <set name="RspMsg"    value="用户登录平台不正确"/>
           <return/>
        </if>
        <if condition="ISNULL(PageNum)">
           <set name="PageNum"              value="1"/>
        </if>
        <if condition="ISNULL(PRDORDNO)">
           <!-- PRDORDNO 商品订单号 -->
           <set name="PRDORDNOL"            value=""/>
        </if>
        <else>
           <set name="PRDORDNOL"            expr="STRCAT('AND PRDORDNO=\'',PRDORDNO,'\'')"/>
        </else>
        <if condition="ISNULL(FILED4)">
           <!-- 联系人 -->
           <set name="FILED4L"            value=""/>
        </if>
        <else>
           <set name="FILED4L"            expr="STRCAT('AND FILED4=\'',FILED4,'\'')"/>
        </else>
        <if condition="ISNULL(NOTIFYURL)">
           <!-- 联系电话 -->
           <set name="NOTIFYURLL"            value=""/>
        </if>
        <else>
           <set name="NOTIFYURLL"            expr="STRCAT('AND NOTIFYURL=\'',NOTIFYURL,'\'')"/>
        </else>
        <if condition="ISNULL(PAYTYPE)">
           <!-- BIZTYPEL 支付方式 -->
           <set name="PAYTYPEL"             value=""/>
        </if>
        <else>
           <set name="PAYTYPEL"             expr="STRCAT('AND BIZTYPE=\'',BIZTYPE,'\'')"/>
        </else>
        <if condition="AND(ISNULL(begin_date),ISNULL(end_date))">
           <!-- ORDERTIME 开始时间和结束时间 -->
           <set name="ORDERTIMEL"           value=""/>
        </if>
        <elseif condition="ISNULL(end_date)">
           <set name="begin_date"           expr="FMTDATE(begin_date,4,0)"/>
           <set name="ORDERTIMEL"           expr="STRCAT('and B.ORDERTIME &gt;=\'',begin_date,'\'')"/>
           <set name="begin_date"           expr="FMTDATE(begin_date,0,4)"/>
        </elseif>
        <elseif condition="ISNULL(begin_date)">
           <set name="end_date"             expr="FMTDATE(end_date,4,0)"/>
           <set name="ORDERTIMEL"           expr="STRCAT('and B.ORDERTIME &lt;=\'',CALCDATE(end_date,'+','d','1'),'\'')"/>
           <set name="end_date"             expr="FMTDATE(end_date,0,4)"/>
        </elseif>
        <else>
           <set name="begin_date"           expr="FMTDATE(begin_date,4,0)"/>
           <set name="end_date"             expr="FMTDATE(end_date,4,0)"/>
           <set name="ORDERTIMEL"           expr="STRCAT('and B.ORDERTIME &gt;=\'',begin_date,'\' and B.ORDERTIME &lt;=\'',CALCDATE(end_date,'+','d','1'),'\'')"/>
           <set name="begin_date"           expr="FMTDATE(begin_date,0,4)"/>
           <set name="end_date"             expr="FMTDATE(end_date,0,4)"/>
        </else>
        <if condition="ISNULL(ORDSTATUS)">
           <!-- ORDSTATUS 订单状态 -->
           <set name="ORDSTATUSL"           value=""/>
        </if>
        <else>
           <set name="ORDSTATUSL"           expr="STRCAT('AND B.ORDSTATUS=\'',ORDSTATUS,'\'')"/>
        </else>
        <do func="PagedQuery" error="ignore">
           <para name="PageNum"             expr="PageNum"/>
           <para name="NumPerPag"           expr="NumPerPag"/>
           <para name="Sql" sql="QryPrdInf"/>
        </do>
        <if condition="#RetCod==2">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="01003"/>
           <set name="RspMsg"    value="无符合条件记录"/>
           <return/>
        </if>
        <elseif condition="#RetCod!=0">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="09998"/>
           <set name="RspMsg"    value="系统错误"/>
           <return/>
        </elseif>

        <set name="MsgTyp"    value="N"/>
        <set name="RspCod"    value="00000"/>
        <set name="RspMsg"    value="交易成功"/>
     </process>
   </transaction>
   
   <transaction code="411172" desc="预付卡订单详情信息">
     <sql name="QryPrdInf"> <!--查询商品订单信息 -->
        SELECT nvl(s.ordAmt,' ') AS ordAmt,nvl(s.prdordno,' ') AS prdordno,s.seqno,s.ordstatus,s.notifyurl,returl,s.filed4,
               TO_CHAR(to_number(s.ORDAMT)/100,'FM9999,999,999,990.00')AS ORDAMTS,
               TO_CHAR(to_number(ordamt*buyCount)/100,'FM9999,999,999,990.00')AS TotalAMTS,
               sellRptAmt,s.prdName,nvl(s.prdShortName,' ') as prdShortName,bizType,ordamt*buyCount as  TOTALAMT,
               nvl(prdDesc,' ') as prdDesc,nvl(s.merRemark,' ') as merRemark,custRptAcNo,TranSort,
               To_Char(to_date(ordertime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as ORDTIME ,buyCount
          FROM stpprdinf s ,stppayinf  p 
         WHERE s.merNo='999999' and s.prdordtype='5' and s.PRDORDNO=#{PRDORDNO}
     </sql>
     <process>
        <set name="_REQUESTATTR.FORWARDURL"  value="/WEB-INF/html/userOredr/usercardorder.jsp"/>
        <!--检查用户登录平台是否正确-->
        <if condition="IS_NOEQUAL_STRING(SysCod,'1120')">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="01001"/>
           <set name="RspMsg"    value="用户登录平台不正确"/>
           <return/>
        </if>
        <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="QryPrdInf"/>
        </do>
        <if condition="#RetCod==2">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="01003"/>
           <set name="RspMsg"    value="无符合条件记录"/>
           <return/>
        </if>
        <elseif condition="#RetCod!=0">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="09998"/>
           <set name="RspMsg"    value="系统错误"/>
           <return/>
        </elseif>

        <set name="MsgTyp"    value="N"/>
        <set name="RspCod"    value="00000"/>
        <set name="RspMsg"    value="交易成功"/>
     </process>
   </transaction>
   
   <transaction code="411173" desc="修改预付卡支付状态">
     <sql name="UpdatePrdInf"> <!--查询商品订单信息 -->
        update stpprdinf  set ORDSTATUS=#{ORDSTATUS} WHERE  merNo='999999' and prdordtype='5' and PRDORDNO=#{PRDORDNO}
     </sql>
      <sql name="UpdatePayInf"> <!--查询商品订单信息 -->
        update stppayinf  set ORDSTATUS=#{ORDSTATUS} WHERE  prdordtype='5' and PRDORDNO=#{PRDORDNO}
     </sql>
     <process>
        <!--检查用户登录平台是否正确-->
        <if condition="IS_NOEQUAL_STRING(SysCod,'1120')">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="01001"/>
           <set name="RspMsg"    value="用户登录平台不正确"/>
           <return/>
        </if>
        <!--修改货到付款的状态-->
        <set name="ORDSTATUS" value="01"/>
        <do func="ExecSql" error="IGNORE">
           <para name="SqlCmd" sql="UpdatePrdInf"/>
        </do>
        <if condition="#RetCod==2">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="01003"/>
           <set name="RspMsg"    value="无符合条件记录"/>
           <set name="DWZ_STATUS_CODE"     value="300"/>
           <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
           <return/>
        </if>
        <elseif condition="#RetCod!=0">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="09998"/>
           <set name="RspMsg"    value="系统错误"/>
           <set name="DWZ_STATUS_CODE"     value="300"/>
           <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
           <return/>
        </elseif>
        
        <!--修改货到付款的状态-->
        <set name="ORDSTATUS" value="01"/>
        <do func="ExecSql" error="IGNORE">
           <para name="SqlCmd" sql="UpdatePayInf"/>
        </do>
        <if condition="#RetCod==2">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="01003"/>
           <set name="RspMsg"    value="无符合条件记录"/>
           <set name="DWZ_STATUS_CODE"     value="300"/>
           <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
           <return/>
        </if>
        <elseif condition="#RetCod!=0">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="09998"/>
           <set name="RspMsg"    value="系统错误"/>
           <set name="DWZ_STATUS_CODE"     value="300"/>
           <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
           <return/>
        </elseif>
        
        <set name="MsgTyp"    value="N"/>
        <set name="RspCod"    value="00000"/>
        <set name="RspMsg"    value="交易成功"/>
        <set name="DWZ_STATUS_CODE"     value="200"/>
        <set name="DWZ_RSP_MSG"         expr="RspMsg"/>

     </process>
   </transaction>
   
    <transaction code="411075" desc="查询提现订单">
        <sql name="present">
            SELECT TO_CHAR(to_date(A.ACTDAT,'yyyymmddhh24miss'),'yyyy-mm-dd  hh24:mi:ss') ACTDAT,
                   TO_CHAR(to_number(A.TXAMT)/100,'FM9999999999990.00') STXAMTS,
                   TO_CHAR(to_number(A.TXAMT)/100,'FM9999,999,999,990.00') TXAMT,
                   TO_CHAR(to_number(nvl(A.FEE,0))/100,'FM9999,999,999,990.00') FEE,
                   DECRYPT_DES(A.BANKPAYACNO,'0123456789ABCDEF') AS BANKPAYACNO_FMT,
                   A.BANKPAYACNO,A.BANKPAYUSERNM,A.CASORDNO,A.ORDSTATUS,A.bankcode,A.CUST_ID,inf.cust_login,
                   A.bankcode as BANKCODE_CC_BANKNAM,
                   (select  distinct trim(ISSNAM) from  unionfit where trim(ISSNO)=A.Bankcode and ROWNUM='1') AS ENM_CN_NAM, 
                   A.ORDSTATUS as ORDSTATUS_CC_CASORDSTATUS 
              FROM VW_STPCASINF A,(select cust_id,cust_login from(select cust_id,cust_login from stpusrinf union select cust_id,login_name as cust_login from stpmerinf)) INF 
             WHERE a.cust_id=inf.cust_id 
               AND (BANKPAYACNO = ENCRYPT_DES(#{BANKPAYACNO},'0123456789ABCDEF') or ' '= #{BANKPAYACNO}||' ')  
               AND A.ACTDAT BETWEEN #{begin_date_temp} AND #{end_date_temp}
               AND (inf.CUST_LOGIN = #{CUST_LOGIN} or ' '= #{CUST_LOGIN}||' ') 
               AND A.txAmt BETWEEN to_number(#{ordAmt1_temp}) AND to_number(#{ordAmt2_temp}) 
               ${CASORDNO1} 
               ${ORDSTATUS1} 
               ${BANKPAYUSERNML} 
               ${CUST_IDL} 
          ORDER BY ACTDAT DESC
        </sql>
        <sql name="TXAMTS">
            SELECT TO_CHAR(to_number(SUM(A.TXAMT))/100,'FM9999,999,999,990.00')AS TXAMTS 
              FROM VW_STPCASINF A,STPUSRINF INF
             WHERE a.cust_id=inf.cust_id 
               AND (BANKPAYACNO = ENCRYPT_DES(#{BANKPAYACNO},'0123456789ABCDEF') or ' '= #{BANKPAYACNO}||' ')  
               AND A.ACTDAT BETWEEN #{begin_date_temp} AND #{end_date_temp}
               AND (inf.CUST_LOGIN = #{CUST_LOGIN} or ' '= #{CUST_LOGIN}||' ') 
               AND A.txAmt BETWEEN to_number(#{ordAmt1_temp}) AND to_number(#{ordAmt2_temp}) 
               ${CASORDNO1} 
               ${ORDSTATUS1} 
               ${BANKPAYUSERNML} 
               ${CUST_IDL} 
        </sql>
        <process>
            <!--获取按钮权限-->
            <do func="GetOwnButton"/>
            <set name="_REQUESTATTR.FORWARDURL"  value="/WEB-INF/html/present/present.jsp"/>
            <!--检查用户登录平台是否正确-->
            <if condition="IS_NOEQUAL_STRING(SysCod,'1120')">
                <set name="RspCod"  value="01001"/>
                <set name="RspMsg"  value="用户登录平台不正确"/>
                <return/>
            </if>
            <if condition="ISNULL(PageNum)">
                <set name="PageNum" value="1"/>
            </if>
            <set name="CUST_LOGIN"          expr="DELBOTHSPACE(CUST_LOGIN)"/>
            <set name="CASORDNO1"           value=""/>
            <set name="ORDSTATUS1"          value=""/>
            <set name="BANKPAYUSERNML"      value=""/>
            <set name="CUST_IDL"            value=""/>
            <set name="begin_date_temp"     value="19700101" />
            <set name="end_date_temp"       value="20991231" />
            <set name="ordAmt1_temp"        value="0"        />
            <set name="ordAmt2_temp"        value="999999999999999"/>
            
            <if condition="NOT(ISNULL(CASORDNO))">
                <set name="CASORDNO1"   expr="STRCAT('and A.CASORDNO=\'',CASORDNO,'\'')"/>
            </if>
            
            <if condition="NOT(ISNULL(ORDSTATUS))">
                <set name="ORDSTATUS1"           expr="STRCAT('and A.ORDSTATUS=\'',ORDSTATUS,'\'')"/>
            </if>

            <if condition="NOT(ISNULL(BANKPAYUSERNM))">
                <set name="BANKPAYUSERNML"       expr="STRCAT('and A.BANKPAYUSERNM like \'%',BANKPAYUSERNM,'%\'')"/>
            </if>
            
            <if condition="NOT(ISNULL(CUST_ID))">
                <set name="CUST_IDL"             expr="STRCAT('and A.CUST_ID=\'',CUST_ID,'\'')"/>
            </if>
            <if condition="ISNULL(BANKPAYACNO)">
                <set name="BANKPAYACNO"         value=""/>
            </if>
            
            <if condition="NOT(ISNULL(begin_date))">
                <set name="begin_date_temp" expr="begin_date" />
            </if>
            <if condition="NOT(ISNULL(end_date))">
                <set name="end_date_temp"   expr="end_date" />
            </if>
            <if condition="NOT(ISNULL(ordAmt1))">
                <set name="ordAmt1_temp"    expr="AMTPOWER(ordAmt1,2)" />
            </if>
            <if condition="NOT(ISNULL(ordAmt2))">
                <set name="ordAmt2_temp"    expr="AMTPOWER(ordAmt2,2)" />
            </if>
            
            <set name="begin_date_temp" expr="STRCAT(begin_date_temp,'000000')" />
            <set name="end_date_temp"   expr="STRCAT(end_date_temp  ,'235959')" />
            
            <!-- 设置下拉框 -->
            <set name="DICTNAME_STR"  expr="STRCAT('CASORDSTATUS:',OrdStatus)"/>
            <do func="CreateDictOption" error="IGNORE">
                <para name="DictCodes"    expr="DICTNAME_STR"/>
            </do>
            
            <!-- 查询商户提现信息 -->
            <do func="PagedQuery" error="ignore">
                <para name="PageNum"    expr="pagenum"/>
                <para name="NumPerPag"  expr="NUMPERPAG"/>
                <para name="Sql"        sql="present"/>
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"  value="02001"/>
                <set name="RspMsg"  value="无信息"/>
                <return/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"  value="09999"/>
                <set name="RspMsg"  value="系统错误"/>
                <return/>
            </elseif> 
            
            <do func="FormatDict2Etf" error="IGNORE"/>
            
            <foreach name="GRP" iterator="#grp">
                <set name="sDeData"           expr="#grp.BANKPAYACNO_FMT"   />
                <set name="First"             expr="SUBSTR(sDeData,1,3)"/> 
                <set name="End"               expr="SUBSTR(sDeData,SUB(STRLEN(sDeData),3),STRLEN(sDeData))"/>
                <set name="descryptdata"      expr="STRCAT(First,'****',End)"/>
                <do func="loopSetEach">
                    <para name="ele" expr="#grp.BANKPAYACNO"/> 
                    <para name="value" expr="descryptdata"/>
                </do>
                <if condition="#RetCod!=0">
                    <set name="RspCod"            value="09998"/>
                    <set name="RspMsg"            value="系统错误"/>
                    <set name="DWZ_STATUS_CODE"   value="300"/>
                    <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
                    <return/>
                </if>
            </foreach>
            
            <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="TXAMTS" />
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"          value="09999"/>
                <set name="RspMsg"          value="系统错误"/>
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG"     expr="RspMsg"/>
                <return/>
            </if>
            <set name="RspCod"                   value="00000"/>
            <set name="RspMsg"                   value="交易成功"/>
        </process>
    </transaction>
   
   <transaction code="411076" desc="提现订单详情">
       <sql name="presents">                                     
           SELECT DECRYPT_DES(BANKPAYACNO,'0123456789ABCDEF') BANKPAYACNO,
                  TO_CHAR(to_date(A.ACTDAT,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') ACTDAT,
                  TO_CHAR(to_date(A.SUCDAT,'yyyymmddhh24miss'),'yyyy-mm-dd  hh24:mi:ss') SUCDAT,
                  TO_CHAR(to_number(A.TXAMT)/100,'FM9999,999,999,990.00') TXAMT,
                  TO_CHAR(to_number(A.FEE)/100,'FM9999,999,999,990.00') FEE,
                  A.BANKPAYUSERNM,A.CASORDNO,A.ORDSTATUS,A.BANKCODE,A.CUST_ID,A.Bankpayusernm CUST_NAME,BANKERROR,
                  (select  distinct trim(ISSNAM) from  unionfit where trim(ISSNO)=A.Bankcode and ROWNUM='1') AS DICT_CH_BANKNAM
             FROM STPCASINF A 
            WHERE A.CASORDNO = #{CASORDNO}                                       
       </sql>
       <process>
           <set name="_REQUESTATTR.FORWARDURL"  value="/WEB-INF/html/present/presents.jsp"/>
           <!--检查用户登录平台是否正确-->
           <if condition="IS_NOEQUAL_STRING(SysCod,'1120')">
               <set name="RspCod"               value="01001"/>
               <set name="RspMsg"               value="用户登录平台不正确"/>
               <return/>
           </if>
           <if condition="ISNULL(PageNum)">
               <set name="PageNum"              value="1"/>
           </if>
           <!-- 提现订单详情 -->
           <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd" sql="presents" />
           </do>
           <if condition="#RetCod==2">
               <set name="RspCod"               value="01059"/>
               <set name="RspMsg"               value="无订单信息"/>
               <return/>
           </if>
           <elseif condition="#RetCod!=0">
               <set name="RspCod"               value="09999"/>
               <set name="RspMsg"               value="系统错误"/>
               <return/>
           </elseif>
           
           <!-- 获取数据字典中文 -->
            <set name="DICTNAME_STR"  expr="STRCAT('CASORDSTATUS:',ORDSTATUS)"/>
            <do func="GetDictCh" error="IGNORE">
                <para name="DictCodes"    expr="DICTNAME_STR"/>
            </do>
           
           <set name="RspCod"                   value="00000"/>
           <set name="RspMsg"                   value="交易成功"/>
       </process>
   </transaction>
   
    <transaction code="411078" desc="提现导出">
        <sql name="UsOrLists">
            SELECT A.CASORDNO,
                   TO_CHAR(to_date(A.ACTDAT,'yyyymmddhh24miss'),'yyyy-mm-dd  hh24:mi:ss') ACTDAT,
                   TO_CHAR(to_date(A.SUCDAT,'yyyymmddhh24miss'),'yyyy-mm-dd  hh24:mi:ss') SUCDAT,
                   A.ORDSTATUS as ORDSTATUS_CC_CASORDSTATUS,
                   TO_CHAR(to_number(A.TXAMT)/100,'FM9999,999,999,990.00') TXAMT,inf.cust_login,
                   (select  distinct trim(ISSNAM) from  unionfit where trim(ISSNO)=A.Bankcode and ROWNUM='1') AS ENM_CN_NAM, 
                   DECRYPT_DES(A.BANKPAYACNO,'0123456789ABCDEF') as BANKPAYACNO,A.BANKPAYUSERNM 
              FROM VW_STPCASINF A,FROM VW_STPCASINF A,(select cust_id,cust_login from(select cust_id,cust_login from stpusrinf union select cust_id,login_name as cust_login from stpmerinf)) INF
             WHERE a.cust_id=inf.cust_id 
               AND (BANKPAYACNO = ENCRYPT_DES(#{BANKPAYACNO},'0123456789ABCDEF') or ' '= #{BANKPAYACNO}||' ')  
               AND A.ACTDAT BETWEEN #{begin_date_temp} AND #{end_date_temp}
               AND (inf.CUST_LOGIN = #{CUST_LOGIN} or ' '= #{CUST_LOGIN}||' ') 
               AND A.txAmt BETWEEN to_number(#{ordAmt1_temp}) AND to_number(#{ordAmt2_temp}) 
               ${CASORDNO1} 
               ${ORDSTATUS1} 
               ${BANKPAYUSERNML}
               ${CUST_IDL} 
          ORDER BY ACTDAT DESC
        </sql>
        <process>
            <set name="CUST_LOGIN"          expr="DELBOTHSPACE(CUST_LOGIN)"/>
            <set name="CASORDNO1"           value=""/>
            <set name="ORDSTATUS1"          value=""/>
            <set name="BANKPAYUSERNML"      value=""/>
            <set name="CUST_IDL"            value=""/>
            <set name="begin_date_temp"     value="19700101" />
            <set name="end_date_temp"       value="20991231" />
            <set name="ordAmt1_temp"        value="0"        />
            <set name="ordAmt2_temp"        value="999999999999999"/>
            
            <if condition="NOT(ISNULL(CASORDNO))">
                <set name="CASORDNO1"   expr="STRCAT('and A.CASORDNO=\'',CASORDNO,'\'')"/>
            </if>
            
            <if condition="NOT(ISNULL(ORDSTATUS))">
                <set name="ORDSTATUS1"           expr="STRCAT('and A.ORDSTATUS=\'',ORDSTATUS,'\'')"/>
            </if>

            <if condition="NOT(ISNULL(BANKPAYUSERNM))">
                <set name="BANKPAYUSERNML"       expr="STRCAT('and A.BANKPAYUSERNM=\'',BANKPAYUSERNM,'\'')"/>
            </if>
            
            <if condition="NOT(ISNULL(CUST_ID))">
                <set name="CUST_IDL"             expr="STRCAT('and A.CUST_ID=\'',CUST_ID,'\'')"/>
            </if>
            <if condition="ISNULL(BANKPAYACNO)">
                <set name="BANKPAYACNO"         value=""/>
            </if>
            
            <if condition="NOT(ISNULL(begin_date))">
                <set name="begin_date_temp" expr="begin_date" />
            </if>
            <if condition="NOT(ISNULL(end_date))">
                <set name="end_date_temp"   expr="end_date" />
            </if>
            <if condition="NOT(ISNULL(ordAmt1))">
                <set name="ordAmt1_temp"    expr="AMTPOWER(ordAmt1,2)" />
            </if>
            <if condition="NOT(ISNULL(ordAmt2))">
                <set name="ordAmt2_temp"    expr="AMTPOWER(ordAmt2,2)" />
            </if>
            
            <set name="begin_date_temp" expr="STRCAT(begin_date_temp,'000000')" />
            <set name="end_date_temp"   expr="STRCAT(end_date_temp  ,'235959')" />
           
            <do func="QueryInGroup">
                <para name="SqlCmd"     sql="UsOrLists" />
                <para name="RecordName" value="reportList" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"          value="02024"/>
                <set name="RspMsg"          value="无信息"/>
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG"     expr="RspMsg"/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"          value="09999"/>
                <set name="RspMsg"          value="系统错误" />
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG"     expr="RspMsg"/>
                <return/>
            </elseif>
            
            <do func="FormatDict2Etf" error="IGNORE">
                <para name="RecNam" value="REPORTLIST" />
            </do>
            
            <!--查询成功-->
            <do func="ReportExport" error="IGNORE">
                <para name="Root"          value="reportList"/>
                <para name="FileDemo"      value="withdrawal"/> <!--导出模板名-->
                <para name="NameForUser"   value="withdrawal"/> <!--导出文件名-->
                <para name="FilePath"      value="rptdemo"/>       <!--导出模板路径-->
                <para name="FileToPath"    value="/dat/download"/> <!--导出目标地址-->
                <para name="WebPath"       expr="GETCURAPPHOME()"/>
                <para name="params"        value="CASORDNO/ACTDAT/SUCDAT/ORDSTATUS_CH/TXAMT/CUST_LOGIN/ENM_CN_NAM/BANKPAYACNO/BANKPAYUSERNM"/>
                <para name="collectParams" value=""/> <!--导出总条数，总金额如果没有传空-->
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"    value="02103"/>
                <set name="RspMsg"    value="导出出错!"/>
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG" expr="RSPMSG"/> 
                <return/>
            </if>
            <else>
                <set name="FILENAME"                 expr="#FILENAME"/>
                <set name="ConfigName"               value="FtpPutPay"/>
                <quote name="ReadXmlCfg"/>
                <!--调用移动方法将文件存到web服务器上-->
                <do func="MoveFile">
                    <para name="srcDir" expr="LclDir"    />
                    <para name="srcFil" expr="FILENAME"  />
                    <para name="tarDir" expr="ObjDir"    />
                </do>
                <if condition="#RetCod!=0"> 
                    <set name="RspCod" value="01007"/>  
                    <set name="RspMsg" value="移动文件错误!"/>  
                    <return/> 
                </if>
                
                <set name="pos_webapps"     expr="GETSTRPOS(ObjDir,'/webapps/')"                                />
                <set name="ObjDir"          expr="RIGHTSTR(ObjDir,SUB(STRLEN(ObjDir),ADD(pos_webapps,8)))"      />
                
                <set name="_REQUESTATTR.REDIRECTURL"                         expr="STRCAT('/',ObjDir,'/',FILENAME)"/>
                <set name="RspCod"                   value="00000"/>
                <set name="RspMsg"                   value="导出成功"/>
                <set name="DWZ_STATUS_CODE"          value="200"/>
                <set name="DWZ_RSP_MSG"              expr="RspMsg"/>
            </else>
        </process>
    </transaction>
    
    <transaction code="411073" desc="线上提现结果处理">
       <sql name="QryOrdInf">
         select casOrdNo,TXAMT,bankCode,cust_id,nvl(fee,0) fee,netrecamt,ordstatus,bankcode,bankpayacno,bankpayusernm from stpcasinf where CasOrdNo=#{CasOrdNo}
       </sql>
       <sql name="SelMerStatus">  <!--查询客户账户状态 -->
        select a.AC_STATUS,a.AC_TYPE,PASSWORD,nvl(froz_balance,0) froz_balance,
        to_number(nvl(cash_ac_bal,0)-nvl(froz_balance,0)) cashacbal,a.PAY_AC_NO PAY_AC_NO
        from ARP_AC_PROFILE a,ARP_AC_CUST_REL b where a.PAY_AC_NO=b.PAY_AC_NO 
        and b.cust_id =#{cust_id} and a.AC_TYPE='01'
       </sql>
       <sql name="SelFrzInf">
         select PAY_AC_NO,FROZ_AMT,BIZ_CODE,STATUS,FROZ_NO from ARP_AC_FORZZ_DETAILS where BIZ_CODE=#{CasOrdNo} and STATUS='01'
       </sql>
       <sql name="UpdFrezInf"><!-- 更新冻结信息-->
          UPDATE ARP_AC_FORZZ_DETAILS SET STATUS='00',LST_UPT_DATE=#{LST_UPT_DATE},LST_UPT_TIME=#{LST_UPT_TIME}  WHERE FROZ_NO=#{FROZ_NO}
       </sql>
       <sql name="UpdStatus">
        update stpcasinf set  ordstatus=#{ordstatus},SucDat=#{SucDat}  where  casOrdNo=#{casOrdNo}
       </sql>
     <process>
        <!--检查用户登录平台是否正确-->
        <if condition="IS_NOEQUAL_STRING(SysCod,'1120')">
           <set name="RspCod"    value="01001"/>
           <set name="RspMsg"    value="用户登录平台不正确"/>
           <set name="DWZ_STATUS_CODE" value="300"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/> 
           <return/>
        </if>
        
        <set name="casOrdNo"    expr="casOrdNo"/>
        <set name="resultflag"  expr="resultflag"/>
        <!-- 页面传送resultflag标识 1：提现成功 2：提现失败 -->
        
        <!--查询提现订单-->
        <do func="ReadRecord" >
           <para name="SqlCmd" sql="QryOrdInf"/>
        </do>
        <if condition="#RetCod==2">
           <set name="RspCod"    value="01003"/>
           <set name="RspMsg"    value="无符合条件记录"/>
           <set name="DWZ_STATUS_CODE" value="300"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/> 
           <do func="RollBackWork"/>
           <return/>
        </if>
        <!-- 查询商户帐号信息 -->
        <do func="ReadRecord"       error="IGNORE">
            <para name="SqlCmd"       sql="SelMerStatus"/>
        </do>
        <if condition="#RetCod!=0">
            <set name="RspCod"    value="02103"/>
            <set name="RspMsg"    value="商户信息不存在，不能提现!"/>
            <set name="DWZ_STATUS_CODE" value="300"/>
            <set name="DWZ_RSP_MSG" expr="RSPMSG"/> 
            <return/>
        </if>
         <set name="AC_STATUS"       expr="AC_STATUS"/>
         <if condition="IS_EQUAL_STRING(AC_STATUS,'2')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="商户账户已经被冻结，不能申请提现！"/>
            <return/>
         </if>
         <if condition="DOUBLECMP(cashacbal,1,TXAMT)">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="商户账户余额不足，不能申请提现！"/>
            <return/>
         </if>
         <!--查询冻结信息-->
         <quote name="SelFrzInf"/>
         
         <!-- 页面传送resultflag标识 1：提现成功 2：提现失败 -->
         <if condition="IS_EQUAL_STRING(resultflag,'1')">       <!--提现成功，则扣除商户帐户余额-->
            
            <!--线上提现，则接入银行提现接口代码-->
            <set name="bankcode"      expr="bankcode"/><!--银行编码-->
            <set name="bankpayusernm" expr="bankpayusernm"/><!--收款人姓名-->
            <set name="bankpayacno"   expr="DES_DECRYPT(bankpayacno)"/><!--收款卡号-->
            
            <!--线上提现，则接入银行提现接口代码-->
            
            <!--将扣除的提现金额解冻 并从账户里扣除-->
            <set name="PAY_AC_NO"    expr="PAY_AC_NO"/>
            <set name="txAmt"        expr="STRCAT('-',FROZ_AMT)"/>
            <quote name="frezzAmt"/>
            <set name="txAmt"        expr="FROZ_AMT"/>
            
            <!--更新冻结状态-->
            <quote name="UpdFrezz"/>
            
            <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','-','/','CNY','/',TXAMT,'/','Y','/')"/>  <!--用户记账参数-->  
            <set name="PARAMS"     expr="usrPar"/>
            <!--记账处理-->
            <set name="TXN_TYP"    value="4"/>      <!--用途 4 提现-->
            <set name="prdordno"   expr="casOrdNo"/>
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="08042"/>
               <set name="RspMsg"    value="提现失败"/>
               <set name="DWZ_STATUS_CODE" value="300"/>
               <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
               <do func="RollBackWork"/>
               <return/>
            </if>
            <set name="SucDat"       expr="GETDATETIME()"/>
            <set name="OrdStatus" value="01"/> <!--提现成功-->
         </if>
         <elseif condition="IS_EQUAL_STRING(resultflag,'2')">   <!--提现失败，则退回支付账户-->
            <!--将提现金额解冻、退回支付账号 -->
            <set name="PAY_AC_NO"    expr="PAY_AC_NO"/>
            <set name="txAmt"        expr="STRCAT('-',FROZ_AMT)"/>
            <quote name="frezzAmt"/>
            <set name="txAmt"        expr="FROZ_AMT"/>
            
            <!--更新冻结状态-->
            <quote name="UpdFrezz"/>
            <set name="SucDat"       value=""/>
            <set name="OrdStatus" value="02"/> 
         </elseif>
         <else>
            <set name="SucDat"       value=""/>
            <set name="OrdStatus" value="00"/> 
            <set name="RspCod"    value="02069"/>
            <set name="RspMsg"    value="该订单无法提现！"/>
            <set name="DWZ_STATUS_CODE" value="300"/>
            <set name="DWZ_RSP_MSG"     expr="RSPMSG"/> 
            <do func="RollBackWork"/>  
            <return/>
         </else>
        
        <!--更新提现订单-->
        <do func="ExecSql" error="error">
           <para name="SqlCmd"  sql="UpdStatus" />
        </do>
        <if condition="#RetCod==2">
           <set name="RspCod"    value="01003"/>
           <set name="RspMsg"    value="无符合条件记录"/>
           <set name="DWZ_STATUS_CODE" value="300"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
           <do func="RollBackWork"/>  
           <return/>
        </if>
        <elseif condition="#RetCod!=0">
           <set name="RspCod"    value="06003"/>
           <set name="RspMsg"    value="更新订单信息错误"/>
           <set name="DWZ_STATUS_CODE" value="300"/>
           <set name="DWZ_RSP_MSG"     expr="RSPMSG"/> 
           <do func="RollBackWork"/>  
           <return/>
        </elseif>
        
        <set name="MsgTyp"               value="N"/>
        <set name="RspCod"               value="00000"/>
        <set name="RspMsg"               value="操作交易成功！"/>
        <set name="DWZ_STATUS_CODE"      value="200"/>
        <set name="DWZ_RSP_MSG"          expr="RSPMSG"/>
     </process>
    </transaction>
    
    <transaction code="41108302" desc="转账导出">
        <!--转账列表查询  -->
        <sql name="QrysfeInf2">
            SELECT t.traordno,
                   u.cust_login,
                   t.tracusnam,
                   uto.cust_login TO_CUST_LOGIN,
                   t.GETCUSID,t.GETCUSNAM,
                   t.ORDSTATUS as ORDSTATUS_CC_TRAORDSTATUS,
                   t.txccy,TO_CHAR(to_number(t.txamt)/100,'FM9999,999,999,990.00') TXAMT,
                   TO_CHAR(to_number(nvl(t.fee,'0'))/100,'FM9999,999,999,990.00') FEE,
                   t.tracusid,TO_CHAR(to_date(t.tratime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') TRATIME 
           FROM vw_StpTraInf t,stpusrinf uto ,(select cust_id,cust_login from(select cust_id,cust_login from stpusrinf union select cust_id,login_name as cust_login from stpmerinf)) u
             WHERE t.TRACUSID = u.cust_id
               AND t.GETCUSID = uto.cust_id
               AND (t.traOrdNo like '%'||#{traOrdNo}||'%'  or ' '= #{traOrdNo}||' ') 
               AND (t.OrdStatus like '%'||#{OrdStatus}||'%'  or ' '= #{OrdStatus}||' ') 
               AND (t.GETCUSID like '%'||#{TGetAccNo}||'%'  or ' '= #{TGetAccNo}||' ') 
               AND (u.cust_login like '%'||#{cust_login}||'%' or ' '= #{cust_login}||' ') 
               AND t.traTime BETWEEN #{begin_date_temp} AND #{end_date_temp} 
               AND t.txAmt BETWEEN to_number(#{ordAmt1_temp}) AND to_number(#{ordAmt2_temp}) 
          ORDER BY tratime desc,traordno asc,ORDSTATUS_CC_TRAORDSTATUS asc
        </sql> 
        <process>
            <set name="traOrdNo"        expr="DELBOTHSPACE(traOrdNo)"/>
            <set name="OrdStatus"       expr="DELBOTHSPACE(OrdStatus)"/>
            <set name="traTime"         expr="DELBOTHSPACE(traTime)"/>
            <set name="TGetAccNo"       expr="DELBOTHSPACE(TGetAccNo)"/>
            <set name="cust_login"      expr="DELBOTHSPACE(cust_login)"/>
            <set name="to_cust_login"   expr="DELBOTHSPACE(to_cust_login)"/>
            <set name="end_date"        expr="DELBOTHSPACE(end_date)"/>
            <set name="begin_date"      expr="DELBOTHSPACE(begin_date)"/>
            <set name="operating"       value="bankmessage/rfs_list.jsp"/>
            <set name="begin_date_temp" value="19700101" />
            <set name="end_date_temp"   value="20991231" />
            <set name="ordAmt1_temp"    value="0"        />
            <set name="ordAmt2_temp"    value="999999999999999"/>
            <if condition="ISNULL(PageNum)">
                <set name="PageNum"     value="1"/>
            </if>
            <if condition="ISNULL(NumPerPag)">
                <set name="NumPerPag"   value="19"/>
            </if>
            
            <if condition="NOT(ISNULL(begin_date))">
                <set name="begin_date_temp" expr="begin_date" />
            </if>
            <if condition="NOT(ISNULL(end_date))">
                <set name="end_date_temp"   expr="end_date" />
            </if>
            <if condition="NOT(ISNULL(ordAmt1))">
                <set name="ordAmt1_temp"    expr="AMTPOWER(ordAmt1,2)" />
            </if>
            <if condition="NOT(ISNULL(ordAmt2))">
                <set name="ordAmt2_temp"    expr="AMTPOWER(ordAmt2,2)" />
            </if>
            
            <set name="begin_date_temp" expr="STRCAT(begin_date_temp,'000000')" />
            <set name="end_date_temp"   expr="STRCAT(end_date_temp  ,'235959')" />
        
            <do func="QueryInGroup">
                <para name="SqlCmd"     sql="QrysfeInf2" />
                <para name="RecordName" value="reportList" />
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"          value="02024"/>
                <set name="RspMsg"          value="无信息"/>
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG"     expr="RspMsg"/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="RspCod"          value="09999"/>
                <set name="RspMsg"          value="系统错误" />
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG"     expr="RspMsg"/>
                <return/>
            </elseif>
            
            <do func="FormatDict2Etf" error="IGNORE">
                <para name="RecNam" value="REPORTLIST" />
            </do>
            
            <!--查询成功-->
            <do func="ReportExport" error="IGNORE">
                <para name="Root"          value="reportList"/>
                <para name="FileDemo"      value="transfer_orders"/> <!--导出模板名-->
                <para name="NameForUser"   value="transfer_"/> <!--导出文件名-->
                <para name="FilePath"      value="rptdemo"/>       <!--导出模板路径-->
                <para name="FileToPath"    value="/dat/download"/> <!--导出目标地址-->
                <para name="WebPath"       expr="GETCURAPPHOME()"/>
                <para name="params"        value="TRAORDNO/CUST_LOGIN/TRACUSNAM/TO_CUST_LOGIN/GETCUSNAM/ORDSTATUS_CH/TXAMT/FEE/TRATIME"/>
                <para name="collectParams" value=""/> <!--导出总条数，总金额如果没有传空-->
            </do>   
            <if condition="#RetCod!=0">
                <set name="RspCod"    value="02103"/>
                <set name="RspMsg"    value="导出出错!"/>
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG" expr="RSPMSG"/> 
                <return/>
            </if>
            <else>
                <set name="FILENAME"                 expr="#FILENAME"/>
                <set name="ConfigName"               value="FtpPutPay"/>
                <quote name="ReadXmlCfg"/>
                
                <!--调用移动方法将文件存到web服务器上-->  
                <do func="MoveFile">
                    <para name="srcDir" expr="LclDir"    />
                    <para name="srcFil" expr="FILENAME"  />
                    <para name="tarDir" expr="ObjDir"    />
                </do>
                <if condition="#RetCod!=0"> 
                    <set name="RspCod" value="01007"/>  
                    <set name="RspMsg" value="移动文件错误!"/>  
                    <return/> 
                </if>
                
                <set name="pos_webapps"     expr="GETSTRPOS(ObjDir,'/webapps/')"                                />
                <set name="ObjDir"          expr="RIGHTSTR(ObjDir,SUB(STRLEN(ObjDir),ADD(pos_webapps,8)))"      />
                
                <set name="_REQUESTATTR.REDIRECTURL"                         expr="STRCAT('/',ObjDir,'/',FILENAME)"/>
                <set name="RspCod"                   value="00000"/>
                <set name="RspMsg"                   value="导出成功"/>
                <set name="DWZ_STATUS_CODE"          value="200"/>
                <set name="DWZ_RSP_MSG"              expr="RspMsg"/>
            </else>
        </process>
    </transaction>
    
    <transaction code="411080" desc="转账列表查询">
        <!--转账列表查询  -->
        <sql name="QrysfeInf">
            SELECT TO_CHAR(to_date(t.tratime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') tratime,
                   TO_CHAR(to_number(t.txamt)/100,'FM9999,999,999,990.00') txamt,
                   TO_CHAR(to_number(nvl(t.fee,'0'))/100,'FM9999,999,999,990.00') fee,
                   t.traordno,t.tracusid,t.tracusnam,u.cust_login,t.batno,t.REMARK,      
                   t.ordstatus,t.txccy,t.GETCUSID,t.GETCUSNAM,uto.cust_login TO_CUST_LOGIN,
                   t.ordstatus as ORDSTATUS_CC_TRAORDSTATUS 
          FROM vw_StpTraInf t,stpusrinf uto ,(select cust_id,cust_login from(select cust_id,cust_login from stpusrinf union select cust_id,login_name as cust_login from stpmerinf)) u
             WHERE t.TRACUSID = u.cust_id
               AND t.GETCUSID = uto.cust_id
               AND (t.traOrdNo =#{traOrdNo}   or ' '= #{traOrdNo}||' ') 
               AND (t.OrdStatus =#{OrdStatus}   or ' '= #{OrdStatus}||' ') 
               AND (t.GETCUSID =#{TGetAccNo}   or ' '= #{TGetAccNo}||' ') 
               AND (uto.cust_login =#{to_cust_login}   or ' '= #{to_cust_login}||' ') 
               AND (u.cust_login =#{cust_login} or ' '= #{cust_login}||' ') 
               AND t.traTime BETWEEN #{begin_date_temp} AND #{end_date_temp} 
               AND t.txAmt BETWEEN to_number(#{ordAmt1_temp}) AND to_number(#{ordAmt2_temp}) 
          ORDER BY tratime desc,traordno asc,ordstatus asc 
        </sql>
        <sql name="QrysfeCount">
            SELECT count(*) sumcot,nvl(sum(t.txamt/100),0.00) sumamt 
            FROM vw_StpTraInf t,stpusrinf uto ,(select cust_id,cust_login from(select cust_id,cust_login from stpusrinf union select cust_id,login_name as cust_login from stpmerinf)) u
             WHERE t.TRACUSID = u.cust_id
               AND t.GETCUSID = uto.cust_id
               AND (t.traOrdNo =#{traOrdNo}   or ' '= #{traOrdNo}||' ') 
               AND (t.OrdStatus =#{OrdStatus}   or ' '= #{OrdStatus}||' ') 
               AND (t.GETCUSID =#{TGetAccNo}   or ' '= #{TGetAccNo}||' ') 
               AND (uto.cust_login =#{to_cust_login}   or ' '= #{to_cust_login}||' ') 
               AND (u.cust_login =#{cust_login} or ' '= #{cust_login}||' ') 
               AND t.traTime BETWEEN #{begin_date_temp} AND #{end_date_temp} 
               AND t.txAmt BETWEEN to_number(#{ordAmt1_temp}) AND to_number(#{ordAmt2_temp})
        </sql>
        <process>
            <set name="traOrdNo"        expr="DELBOTHSPACE(traOrdNo)"/>
            <set name="OrdStatus"       expr="DELBOTHSPACE(OrdStatus)"/>
            <set name="traTime"         expr="DELBOTHSPACE(traTime)"/>
            <set name="TGetAccNo"       expr="DELBOTHSPACE(TGetAccNo)"/>
            <set name="cust_login"      expr="DELBOTHSPACE(cust_login)"/>
            <set name="to_cust_login"   expr="DELBOTHSPACE(to_cust_login)"/>
            <set name="end_date"        expr="DELBOTHSPACE(end_date)"/>
            <set name="begin_date"      expr="DELBOTHSPACE(begin_date)"/>
            <set name="operating"       value="bankmessage/rfs_list.jsp"/>
            <set name="begin_date_temp" value="19700101" />
            <set name="end_date_temp"   value="20991231" />
            <set name="ordAmt1_temp"    value="0"        />
            <set name="ordAmt2_temp"    value="999999999999999"/>
            <if condition="ISNULL(PageNum)">
                <set name="PageNum"     value="1"/>
            </if>
            <if condition="ISNULL(NumPerPag)">
                <set name="NumPerPag"   value="19"/>
            </if>
            
            <if condition="NOT(ISNULL(begin_date))">
                <set name="begin_date_temp" expr="begin_date" />
            </if>
            <if condition="NOT(ISNULL(end_date))">
                <set name="end_date_temp"   expr="end_date" />
            </if>
            <if condition="NOT(ISNULL(ordAmt1))">
                <set name="ordAmt1_temp"    expr="AMTPOWER(ordAmt1,2)" />
            </if>
            <if condition="NOT(ISNULL(ordAmt2))">
                <set name="ordAmt2_temp"    expr="AMTPOWER(ordAmt2,2)" />
            </if>
            
            <set name="begin_date_temp" expr="STRCAT(begin_date_temp,'000000')" />
            <set name="end_date_temp"   expr="STRCAT(end_date_temp  ,'235959')" />
            
            <!-- 设置下拉框 -->
            <set name="DICTNAME_STR"  expr="STRCAT('TRAORDSTATUS:',OrdStatus)"/>
            <do func="CreateDictOption" error="IGNORE">
                <para name="DictCodes"    expr="DICTNAME_STR"/>
            </do>
            
            <do func="ReadRecord"   error="IGNORE">
                <para name="SqlCmd" sql="QrysfeCount" />
            </do>
      
            <do func="PagedQuery" error="ignore">
                <para name="PageNum"          expr="PageNum"/>
                <para name="NumPerPag"        expr="NumPerPag"/>
                <para name="Sql"              sql="QrysfeInf"/>
            </do>
            <if condition="#RetCod==2">
                <set name="RspCod"             value="329999"/>
                <set name="RspMsg"             value="无信息" />
                <set name="DWZ_STATUS_CODE"    value="300"/>
                <set name="DWZ_RSP_MSG"        value="无信息" />
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('WEB-INF/html/',operating)"/>
                <return/>
            </if>
            <if condition="#RetCod!=0">
                <set name="RspCod"             value="329999"/>
                <set name="RspMsg"             value="查询退款表信息失败" />
                <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('WEB-INF/html/',operating)"/>
                <return/>
            </if>
            
            <do func="FormatDict2Etf" error="IGNORE"/>
            
            <set name="RspCod"             value="00000"/>
            <set name="RspMsg"             value="查询转账信息成功"/>
            <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('WEB-INF/html/',operating)"/>
        </process>
    </transaction>

    <transaction code="411081" desc="查看转账详情">
        <sql name="qryrfsById">
            SELECT TO_CHAR(to_date(t.tratime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') tratime,
                   TO_CHAR(to_number(t.txamt)/100,'FM9999,999,999,990.00') txamt,
                   TO_CHAR(to_number(nvl(t.fee,'0'))/100,'FM9999,999,999,990.00') fee,
                   t.traordno,t.tracusid,t.tracusnam,u.cust_login,t.ordstatus,t.txccy,
                   t.GETCUSID,t.GETCUSNAM,uto.cust_login TO_CUST_LOGIN,t.batno,t.REMARK 
              FROM vw_StpTraInf t,stpusrinf u,stpusrinf uto 
             WHERE t.TRACUSID = u.cust_id
               AND t.GETCUSID = uto.cust_id 
               AND t.traOrdNo=#{traOrdNo} 
            union
            SELECT TO_CHAR(to_date(t.tratime,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') tratime,
                   TO_CHAR(to_number(t.txamt)/100,'FM9999,999,999,990.00') txamt,
                   TO_CHAR(to_number(nvl(t.fee,'0'))/100,'FM9999,999,999,990.00') fee,
                   t.traordno,t.tracusid,t.tracusnam,u.login_name,t.ordstatus,t.txccy,
                   t.GETCUSID,t.GETCUSNAM,uto.cust_login TO_CUST_LOGIN,t.batno,t.REMARK 
              FROM vw_StpTraInf t,stpmerinf u,stpusrinf uto 
             WHERE t.TRACUSID = u.cust_id
               AND t.GETCUSID = uto.cust_id 
               AND t.traOrdNo=#{traOrdNo} 
        </sql>
        <process>
            <do func="ReadRecord"   error="IGNORE">
                <para name="SqlCmd" sql="qryrfsById" />
            </do>
            <if condition="#RetCod==2">
                <set name="DWZ_STATUS_CODE"     value="300"/>
                <set name="DWZ_RSP_MSG"         value="没有符合条件的数据" />
                <return/>
            </if>
            <elseif condition="#RetCod!=0">
                <set name="DWZ_STATUS_CODE"     value="300"/>
                <set name="DWZ_RSP_MSG"         value="查询信息失败" />
                <return/>
            </elseif>
            
            <!-- 获取数据字典中文 -->
            <set name="DICTNAME_STR"  expr="STRCAT('TRAORDSTATUS:',ORDSTATUS)"/>
            <do func="GetDictCh" error="IGNORE">
                <para name="DictCodes"    expr="DICTNAME_STR"/>
            </do>
            
            <set name="DWZ_STATUS_CODE"     value="200"/>
            <set name="DWZ_RSP_MSG"         value="查询成功"/>
            <set name="_REQUESTATTR.FORWARDURL" expr="STRCAT('WEB-INF/html/',operating)"/>
        </process>
    </transaction>
   
   <transaction code="565203" desc="银行订单查询">
      <sql name="QryMerNo"> <!--查询商户号及商品订单号 -->
        SELECT MerNo,OrdStatus,bankCod BANKCODE,prdOrdNo,bankJrnNo,bankPayAcNo,bankPayUserNm,ActDat FROM StpPayInf WHERE payOrdNo=#{payOrdNo}
      </sql>
      <sql name="updateMerNo"><!--更新订单状态-->
        update StpPayInf set OrdStatus=#{OrdStatus} WHERE payOrdNo=#{payOrdNo}
      </sql>
      <sql name="QryPayOrd"> <!--查询订单信息 -->
         select OrdStatus,txAmt,payType,accAmt,mulAmt,To_Char(to_date(ActDat,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') as ActDat,ActDat txnDat,bnkMerNo from StpPayInf where payOrdNo=#{payordno}
      </sql>
      <sql name="updateMerNo"><!--更新支付订单表订单状态-->
        update stpprdinf set OrdStatus=#{OrdStatus} WHERE Prdordno=#{Prdordno}
      </sql>
      <sql name="updatePayNo"><!--更新支付订单表订单状态-->
        update stppayinf set OrdStatus=#{OrdStatus} WHERE Prdordno=#{Prdordno}
      </sql>
      <sql name="QryMerInf">
        SELECT a.MD5_SECRET_CODE_ID as MD5Key,a.CODE_TYPE_ID as SignType FROM StpMerInf a,StpCusInf b WHERE a.CUST_ID = b.CUST_ID AND a.CUST_ID=#{merNo} 
      </sql>
      <process>
        <!--检查用户登录平台是否正确-->
        <if condition="IS_NOEQUAL_STRING(SysCod,'1120')">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="01001"/>
           <set name="RspMsg"    value="用户登录平台不正确"/>
           <return/>
        </if>
        <if condition="ISNULL(flag)">
           <if condition="ISNULL(PAYORDNO)">
              <set name="_REQUESTATTR.FORWARDURL"  value="/WEB-INF/html/order/OrderPay.jsp"/>
              <set name="showflag"   value="0"/>
              <return/>
           </if>
        </if>
        <else>
           <if condition="ISNULL(PAYORDNO)">
              <set name="RspCod"    value="06002"/>
              <set name="RspMsg"    value="支付订单号为空"/>
              <set name="DWZ_STATUS_CODE"   value="300"/>
              <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
              <return/>
           </if>
        </else>
        
        <!--查询订单是否存在-->
        <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="QryMerNo" />
        </do>
        <if condition="#RetCod!=0">
           <set name="MsgTyp"            value="E"/>
           <set name="RspCod"            value="08001"/>
           <set name="RspMsg"            value="该支付订单信息不存在"/>
           <set name="DWZ_STATUS_CODE"   value="300"/>
           <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
           <return/>
        </if>
        <!--判断银行编码是否是沃支付如果是去filed5中的值-->
        <if condition="OR(IS_EQUAL_STRING(BANKCODE,'01030000'),IS_EQUAL_STRING(BANKCODE,'03020000'),IS_EQUAL_STRING(BANKCODE,'03080000'),IS_EQUAL_STRING(BANKCODE,'01020000'),IS_EQUAL_STRING(BANKCODE,'01010100'),IS_EQUAL_STRING(BANKCODE,'01010000'),IS_EQUAL_STRING(BANKCODE,'01010200'))">
           <set name="BANKCODE"       expr="BANKCODE"/>
        </if> 
        <else>
           <set name="BANKCODE"       expr="filed5"/>
        </else>
        
        <!--去银行查询订单状态-->
        <quote name="QryBankSts"/>
  
        <set name="payResult"    expr="OrdStatus"/> 
              
        <do func="ReadRecord" error="IGNORE">           
           <para name="SqlCmd"   sql="QryPayOrd"/>
        </do>
        <if condition="#RetCod==2">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="08001"/>
           <set name="RspMsg"    value="该支付订单信息不存在"/>
           <set name="DWZ_STATUS_CODE"   value="300"/>
           <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
           <return/>
        </if>
        <elseif condition="#RetCod!=0">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="09998"/>
           <set name="RspMsg"    value="系统错误"/>
           <set name="DWZ_STATUS_CODE"   value="300"/>
           <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
           <return/>
        </elseif>
        <!--招商银行判断状态-->
        <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="08022"/>
           <set name="RspMsg"    value="该支付订单已付款成功"/>
           <set name="DWZ_STATUS_CODE"   value="300"/>
           <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
           <return/>
        </if>  
        
        <if condition="IS_EQUAL_STRING(payType,'04')">
           <set name="OrdAmt"    expr="AMTADDDOT(mulAmt)"/>   
        </if>
        <else>
           <set name="OrdAmt"    expr="AMTADDDOT(txamt)"/> 
        </else>
        <set name="_REQUESTATTR.FORWARDURL"  value="/WEB-INF/html/order/OrderPay.jsp"/>
        <set name="RspCod"    value="00000"/>
        <set name="RspMsg"    value="交易成功"/>
        
      </process>
   </transaction>
   
   <transaction code="565201" desc="提交手动补记账复核">
      <sql name="QryPayOrd"> <!--查询订单信息 -->
         select OrdStatus,prdordno from StpPayInf where payOrdNo=#{payordno}
      </sql>
      <process>
         <set name="SYSCOD" expr="SYSCOD"/>
         <!--检查用户登录平台是否正确-->
         <if condition="IS_NOEQUAL_STRING(SYSCOD,'1120')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台不正确"/>
            <set name="DWZ_STATUS_CODE"   value="300"/>
            <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
            <return/>
         </if>

         <do func="ReadRecord" error="IGNORE">      
            <para name="SqlCmd"   sql="QryPayOrd"/>
         </do>
         <if condition="#RetCod==2">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="08001"/>
            <set name="RspMsg"    value="该支付订单信息不存在"/>
            <set name="DWZ_STATUS_CODE"   value="300"/>
            <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
            <return/>
         </if>
         <elseif condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09998"/>
            <set name="RspMsg"    value="系统错误"/>
            <set name="DWZ_STATUS_CODE"   value="300"/>
            <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
            <return/>
         </elseif>
         <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="08022"/>
            <set name="RspMsg"    value="该支付订单已付款成功"/>
            <set name="DWZ_STATUS_CODE"   value="300"/>
            <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
            <return/>
         </if>
         
         <!--提交复核信息-->
         <set name="OrdStatus"          value="01"/>
         <set name="table"              value="STPPAYINF"/>
         <set name="Status"             value="OrdStatus/PayRet"/>
         <set name="Keys"               value="payordno"/>
         <set name="method"             value="UPDATE"/>
         <quote name="submitAudit"/>
         
         <set name="MsgTyp"    value="N"/>
         <set name="RspCod"    value="00000"/>
         <set name="RspMsg"    value="交易成功"/>
      </process>
   </transaction>
   
   <transaction code="411086" desc="查询银行信息">
      <sql name="qrybanById">
        SELECT t.bank_code,t.bank_name  FROM CoopBank  t 
      </sql>
      <process>
         <do func="QueryInGroup"           error="IGNORE">
            <para name="SqlCmd"               sql="qrybanById" />
            <para name="RecordName"           value="GRP" />
         </do>
         <if condition="#RetCod!=0">
            <set name="DWZ_STATUS_CODE"      value="300"/>
            <set name="DWZ_RSP_MSG"          value="查询信息失败" />
            <return/>
         </if>
         <if condition="#RetCod==2">
            <set name="DWZ_STATUS_CODE"      value="300"/>
            <set name="DWZ_RSP_MSG"          value="没有符合条件的数据" />
            <return/>
         </if>
         <set name="DWZ_STATUS_CODE"      value="200"/>
         <set name="DWZ_RSP_MSG"          value="查询成功"/>
 
    </process>
   </transaction>
   
    <transaction code="goodsOrderExport" desc="商品订单导出">
        <sql name="goodsOrderList">
            SELECT t.prdordno,t.merno,u.CUST_LOGIN,c.CUST_NAME,
                   TO_CHAR(to_number(t.ordamt)/100,'FM9999,999,999,990.00') ordamt,
                   CASE WHEN t.ordertime !=' ' THEN TO_CHAR(to_date(t.ordertime,'yyyymmddhh24miss'),'yyyy-mm-dd  hh24:mi:ss') end ordertime,
                   t.PRDORDTYPE as PRDORDTYPE_CC_PRDORDTYPE,
                   t.ORDSTATUS as ORDSTATUS_CC_PRDORDSTATUS,
                    case when p.actdat !=' ' then TO_CHAR(to_date(p.actdat,'yyyymmddhh24miss'),'yyyy-mm-dd  hh24:mi:ss')end actdat 
              FROM vw_stpprdinf t left join stpusrinf u on t.cust_id = u.cust_id 
                   left join stpcusinf c on t.cust_id = c.cust_id 
                   left join stppayinf p on t.prdordno = p.prdordno and p.payordno = t.payordno
             WHERE t.prdOrdType in('0','2') 
               AND (t.prdordno = #{prdordno} or ' '= #{prdordno}||' ')
               AND (t.merNo = #{merNo} or ' '= #{merNo}||' ')
               AND (t.OrdStatus = #{OrdStatus} or ' '= #{OrdStatus}||' ')
               AND (t.payOrdNo = #{payOrdNo} or ' '= #{payOrdNo}||' ') 
               AND (u.CUST_LOGIN = #{CUST_LOGIN} or ' '= #{CUST_LOGIN}||' ') 
               AND t.ordAmt BETWEEN to_number(#{ordAmt1_temp}) AND to_number(#{ordAmt2_temp}) 
               AND t.orderTime BETWEEN #{begin_date_temp} AND #{end_date_temp}
               ${txnDate}
          ORDER BY t.orderTime desc,t.prdordno,t.merNo
        </sql>
        <process>
            <set name="prdordno"        expr="DELBOTHSPACE(prdordno)"/>
            <set name="ordAmt"          expr="DELBOTHSPACE(ordAmt)"/>
            <set name="ordAmt1"         expr="DELBOTHSPACE(ordAmt1)"/>
            <set name="ordAmt2"         expr="DELBOTHSPACE(ordAmt2)"/>
            <set name="merNo"           expr="DELBOTHSPACE(merNo)"/>
            <set name="OrdStatus"       expr="DELBOTHSPACE(OrdStatus)"/>
            <set name="payOrdNo"        expr="DELBOTHSPACE(payOrdNo)"/>
            <set name="paytype"         expr="DELBOTHSPACE(paytype)"/>
            <set name="begin_date"      expr="DELBOTHSPACE(begin_date)"/>
            <set name="end_date"        expr="DELBOTHSPACE(end_date)"/>
            <set name="pay_begin_date"      expr="DELBOTHSPACE(pay_begin_date)"/>
            <set name="pay_end_date"        expr="DELBOTHSPACE(pay_end_date)"/>
            <set name="prdOrdType"      expr="DELBOTHSPACE(prdOrdType)"/>
            <set name="operating"       value="bankmessage/goods_list.jsp"/>
           
            <set name="begin_date_temp"     value="19700101" />
            <set name="end_date_temp"       value="20991231" />
            <set name="ordAmt1_temp"        value="0"        />
            <set name="ordAmt2_temp"        value="999999999999999"/>
            
            <if condition="NOT(ISNULL(begin_date))">
                <set name="begin_date_temp" expr="begin_date" />
            </if>
            <if condition="NOT(ISNULL(end_date))">
                <set name="end_date_temp"   expr="end_date" />
            </if>
            <if condition="NOT(ISNULL(ordAmt1))">
                <set name="ordAmt1_temp"    expr="AMTPOWER(ordAmt1,2)" />
            </if>
            <if condition="NOT(ISNULL(ordAmt2))">
                <set name="ordAmt2_temp"    expr="AMTPOWER(ordAmt2,2)" />
            </if>
            
            <set name="begin_date_temp" expr="STRCAT(begin_date_temp,'000000')" />
            <set name="end_date_temp"   expr="STRCAT(end_date_temp  ,'235959')" />
                       
            <if condition="AND(NOT(ISNULL(pay_begin_date)),NOT(ISNULL(pay_end_date)))">
                <if condition="INTCMP(STRCMP(pay_begin_date,pay_end_date),6,0)">
                	<set name="RsgMsg"          value="01002"   />
                	<set name="RspMsg"          value="支付开始日期不能早于结束日期"/>
                	<set name="DWZ_STATUS_CODE" value="300"     />
                	<set name="DWZ_RSP_MSG"     expr="RspMsg"   />
                	<return/>
            		</if>
            		<set name="pay_begin_date_temp" expr="STRCAT(pay_begin_date,'000000')" />
            		<set name="pay_end_date_temp"   expr="STRCAT(pay_end_date  ,'235959')" />
            		<set name="txnDate" expr="STRCAT(' AND p.actdat BETWEEN  ',fh,pay_begin_date_temp,fh,' AND ',fh,pay_end_date_temp,fh)"/>
            </if>
            <elseif condition="AND(NOT(ISNULL(pay_begin_date)),ISNULL(pay_end_date))">
                <set name="pay_begin_date_temp" expr="STRCAT(pay_begin_date,'000000')" />
            		<set name="pay_end_date_temp"   value="20991231235959" />
            		<set name="txnDate" expr="STRCAT(' AND p.actdat BETWEEN  ',fh,pay_begin_date_temp,fh,' AND ',fh,pay_end_date_temp,fh)"/>
            </elseif>
            <elseif condition="AND(ISNULL(pay_begin_date),NOT(ISNULL(pay_end_date)))">
                <set name="pay_begin_date_temp" value="19700101000000" />
            		<set name="pay_end_date_temp"   expr="STRCAT(pay_end_date  ,'235959')" />
            		<set name="txnDate" expr="STRCAT(' AND p.actdat BETWEEN  ',fh,pay_begin_date_temp,fh,' AND ',fh,pay_end_date_temp,fh)"/>
            </elseif>
            <else>
            	<set name="txnDate" value=""/>
            </else>
            <!--查询用户信息-->
            <do func="QueryInGroup">
                <para name="SqlCmd" sql="goodsOrderList" />
                <para name="RecordName" value="reportList" />
            </do>
            <if condition="#RetCod==-1">
                <set name="RSPCOD" value="02037"/>
                <set name="RSPMSG" value="操作数据库有误!"/>
                <set name="DWZ_STATUS_CODE" expr="DWZ_ERROR_CODE"/>
                <set name="DWZ_RSP_MSG" expr="RSPMSG"/>
                <return/>
            </if>
            
            <do func="FormatDict2Etf" error="IGNORE">
                <para name="RecNam" value="REPORTLIST" />
            </do>
            
            <!--进行导出-->
            <do func="ReportExport" error="IGNORE">
                <para name="Root"          value="reportList"/>
                <para name="FileDemo"      value="Goods_orders"/>  <!--导出模板名-->
                <para name="NameForUser"   value="Goods_orders"/>  <!--导出文件名-->
                <para name="FilePath"      value="rptdemo"/>       <!--导出模板路径-->
                <para name="FileToPath"    value="/dat/download"/> <!--导出目标地址-->
                <para name="WebPath"       expr="GETCURAPPHOME()"/> 
                <para name="params"        value="PRDORDNO/MERNO/CUST_LOGIN/CUST_NAME/ORDAMT/ORDERTIME/ACTDAT/PRDORDTYPE_CH/ORDSTATUS_CH"/>
                <para name="collectParams" value=""/> <!--导出总条数，总金额如果没有传空-->
            </do>
            <if condition="#RetCod!=0">
                <set name="RspCod"    value="02103"/>
                <set name="RspMsg"    value="导出出错!"/>
                <set name="DWZ_STATUS_CODE" value="300"/>
                <set name="DWZ_RSP_MSG" expr="RSPMSG"/>
                <return/>
            </if>
            <else>
                <set name="FILENAME"    expr="#FILENAME"/>
                <set name="ConfigName"  value="FtpPutPay"/>
                <quote name="ReadXmlCfg"/>
                <!--调用移动方法将文件存到web服务器上-->  
                <do func="MoveFile">
                    <para name="srcDir" expr="LclDir"    />
                    <para name="srcFil" expr="FILENAME"  />
                    <para name="tarDir" expr="ObjDir"    />
                </do>
                <if condition="#RetCod!=0"> 
                    <set name="RspCod" value="01007"/>  
                    <set name="RspMsg" value="移动文件错误!"/>  
                    <return/> 
                </if>
                
                <set name="pos_webapps"     expr="GETSTRPOS(ObjDir,'/webapps/')"                                />
                <set name="ObjDir"          expr="RIGHTSTR(ObjDir,SUB(STRLEN(ObjDir),ADD(pos_webapps,8)))"      />
                
                <set name="RspCod"            value="00000"/>
                <set name="RspMsg"            value="上传服务保存成功,导出成功"/>
                <set name="DWZ_STATUS_CODE"   value="DWZ_SUCCESS_CODE"/>
                <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
                <set name="URL"               expr="STRCAT('/',ObjDir,FILENAME)"/>
                <set name="_REQUESTATTR.REDIRECTURL" expr="URL"/>
           </else>
        </process>
    </transaction>
   
   <transaction code="ImportPage" desc="跳转到导入页面">
        <process>
            <set name="_REQUESTATTR.FORWARDURL"  value="/WEB-INF/html/present/import.jsp"/>
        </process>
   </transaction>
   
   <transaction code="ProwithdrawFile" desc="提现结果文件处理">
     <sql name="SelCasInf">
       SELECT CUST_ID,CUST_ID||'01' as PAY_AC_NO,ORDSTATUS,NVL(TXAMT,0) AS TXAMT,NVL(FEE,0) AS FEE,NVL(NETRECAMT,0) AS NETRECAMT FROM STPCASINF WHERE CASORDNO=#{CASORDNO}
     </sql>
     <sql name="SelFrzInf">
       select PAY_AC_NO,FROZ_AMT,BIZ_CODE,STATUS,FROZ_NO from ARP_AC_FORZZ_DETAILS where BIZ_CODE=#{CASORDNO} and STATUS='01'
     </sql>
     <sql name="UpdFrezInf"><!-- 更新冻结信息-->
        UPDATE ARP_AC_FORZZ_DETAILS SET STATUS='00',LST_UPT_DATE=#{LST_UPT_DATE},LST_UPT_TIME=#{LST_UPT_TIME}  WHERE FROZ_NO=#{FROZ_NO}
     </sql>
     <sql name="UpdCasStatus">
        UPDATE STPCASINF SET SUCDAT=#{SucDat},ORDSTATUS=#{ORDSTATUS},BANKERROR=#{ERROR} WHERE CASORDNO=#{CASORDNO}
     </sql>
     <process>
        <if condition="IS_NOEQUAL_STRING(_REQUESTATTR.UPLOADFILES.FILE_UPLOAD_STATUS,'S')">
           <if condition="IS_EQUAL_STRING(_REQUESTATTR.UPLOADFILES.FILE_UPLOAD_STATUS,'T')">
              <set name="RspCod"            value="10005"/>   
              <set name="RspMsg"            value="文件格式不正确"/>   
           </if>
           <elseif condition="IS_EQUAL_STRING(_REQUESTATTR.UPLOADFILES.FILE_UPLOAD_STATUS,'C')">
              <set name="RspCod"            value="10006"/>   
              <set name="RspMsg"            value="超过单个文件大小限制"/>   
           </elseif>
           <elseif condition="IS_EQUAL_STRING(_REQUESTATTR.UPLOADFILES.FILE_UPLOAD_STATUS,'G')">
              <set name="RspCod"            value="10007"/>   
              <set name="RspMsg"            value="未达到单个文件最小文件大小要求"/>   
           </elseif>
           <elseif condition="IS_EQUAL_STRING(_REQUESTATTR.UPLOADFILES.FILE_UPLOAD_STATUS,'F')">
              <set name="RspCod"            value="10008"/>   
              <set name="RspMsg"            value="失败，出现异常"/>   
           </elseif>    
           <return/>
        </if>
        <set name="FILENAME"   expr="_REQUESTATTR.UPLOADFILES.FILE.FILENAME"/>
        <set name="LclFil"   expr="_REQUESTATTR.UPLOADFILES.FILE.FILEOLDNAME"/>   <!--wyy add 20130304-->
        <!--读取xml参数-->
        <set name="ConfigName"   value="FtpPutPay"/>
        <quote name="ReadXmlCfg"/>
        
        <!--调用移动方法将文件存到web服务器上-->
        <do func="MoveFile">
             <para name="srcDir" expr="ObjDir"    />
             <para name="srcFil" expr="FILENAME"  />
             <para name="tarDir" expr="LclDir"    />
        </do>
        <if condition="#RetCod!=0"> 
             <set name="RspCod" value="01007"/>  
             <set name="RspMsg" value="文件上传失败，请稍后重试！"/>  
             <return/> 
        </if>
        <do func="IsValidFile" error="IGNORE">
          <para name="FilNam"  expr="STRCAT(LclDir,FILENAME)"/>
        </do>
        <if condition="#RetCod!=0">
          <set name="RspCod"            value="10002"/>
          <set name="DWZ_STATUS_CODE"   value="300" />
          <set name="DWZ_RSP_MSG"       value="校验文件完整性失败！"/>
          <return/>
        </if>
        <do func="TDPaserXLS">
          <para name="FileToPath"       expr="STRCAT(LclDir,'/',FILENAME)"/>
          <para name="SkipRow"          value="2"/>
          <para name="AbandonRow"       value="3"/>
        </do>
        <if condition="#RetCod!=0">
             <set name="RspCod"       value="10003"/>
             <set name="RspMsg"       value="提现打款文件解析失败"/>
             <set name="DWZ_STATUS_CODE"    value="300" />
             <set name="DWZ_RSP_MSG"        expr="RspMsg"/>
             <do func="RollBackWork"/>
             <return/>
        </if>
        <set name="ROW"               value="0"/>      <!-- 有效数据条数 -->
        <set name="TOTALNUM"          expr="TOTALNUM"/><!-- 解析execl有效行数 -->
        
        <if condition="OR(ISNULL(TOTALNUM),IS_EQUAL_STRING(TOTALNUM,''),IS_EQUAL_STRING(TOTALNUM,'0'))">
             <set name="RspCod"       value="10004"/>
             <set name="RspMsg"       value="无效文件或无有效数据！"/>
             <set name="DWZ_STATUS_CODE"    value="300" />
             <set name="DWZ_RSP_MSG"        expr="RspMsg"/>
             <do func="RollBackWork"/>
             <return/>
        </if>
        <set name="DWZ_STATUS_CODE"         value="200" />
        <set name="DWZ_RSP_MSG"             value="文件已成功提交，系统正在处理中，请于1-2分钟后刷新提现订单记录。" />
        <do func="putresponse"/>
        
        <foreach name="VALUELIST"      iterator="#GRP">
             <set name="CASORDNO"           expr="#GRP.FILED0"/>   
             <set name="FILE_TXAMT"         expr="#GRP.FILED3"/> 
             <set name="RESULT"             expr="#GRP.FILED9"/>    
             <set name="ERROR"              expr="#GRP.FILED10"/>
             <if condition="OR(ISNULL(CASORDNO),IS_EQUAL_STRING(CASORDNO,''),ISNULL(FILE_TXAMT),IS_EQUAL_STRING(FILE_TXAMT,''),ISNULL(RESULT),IS_EQUAL_STRING(RESULT,''))">
               <set name="RspMsg"       value="无效数据，默认跳过！"/>
               <continue/>
             </if>
             <!-- 校验订单信息 -->
           <do func="ReadRecord" >
             <para name="SqlCmd" sql="SelCasInf" />
           </do>
           <if condition="#RetCod==2">
             <set name="RspMsg"           value="该提现订单不存在，跳过！"/>
             <continue/>
           </if>
           <elseif condition="#RetCod!=0">
             <set name="RspMsg"           value="获取提现订单信息失败，跳过！"/>
             <continue/>
           </elseif>
           <set name="TXAMT1"             expr="AMTPOWER(REPALLSTR(FILE_TXAMT,',',''),2)"/>
           <set name="TXAMT"              expr="TXAMT"/>
           <set name="ORDSTATUS"          expr="ORDSTATUS"/>
           <set name="CUST_ID"            expr="CUST_ID"/>
           <if condition="DOUBLECMP(TXAMT1,4,TXAMT)">
             <set name="RspMsg"         value="该订单金额被篡改，跳过！"/>
             <continue/>
           </if>
           <if condition="IS_EQUAL_STRING(ORDSTATUS,'01')">
             <set name="RspMsg"         value="该订单已提现成功，跳过！"/>
             <continue/>
           </if>
           <elseif condition="IS_EQUAL_STRING(ORDSTATUS,'02')">
              <set name="RspMsg"        value="订单状态已经是提现失败，不能进行更新。跳过！"/>
              <continue/>
           </elseif>
           <!-- 提现成功 -->
           <if condition="IS_EQUAL_STRING(RESULT,'0')">
              <set name="ORDSTATUS"     value="01"/>
              <quote name="SelFrzInf"/>
              <set name="SucDat"        expr="GETDATETIME()"/>
              <!--将扣除的提现金额解冻 并从账户里扣除-->
              <set name="RCS_PRD_NO"    expr="CASORDNO"/><!--订单号，如果不涉及置空-->
              <set name="PAY_AC_NO"     expr="PAY_AC_NO"/>
              <set name="txAmt"         expr="STRCAT('-',FROZ_AMT)"/>
              <quote name="frezzAmt"/>
              <set name="txAmt"         expr="FROZ_AMT"/>
              <!--更新冻结状态-->
              <quote name="UpdFrezz"/>
              
              <set name="usrPar"       expr="STRCAT(CUST_ID,'/','01','/','-','/','CNY','/',TXAMT,'/','Y','/')"/>  <!--用户记账参数-->  
              <set name="PARAMS"       expr="usrPar"/>
              <!--记账处理-->
              <set name="TXN_TYP"      value="4"/>      <!--用途 4 提现-->
              <set name="prdordno"     expr="CASORDNO"/>
              <quote name="accProcess"/>
              <if condition="#RetCod!=0">
                 <set name="RspCod"    value="08042"/>
                 <set name="RspMsg"    value="提现失败"/>
                 <set name="DWZ_STATUS_CODE" value="300"/>
                 <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
                 <do func="RollBackWork"/> 
                 <continue/>
              </if>
              <set  name="ERROR"      vaue=""/>
              <!-- 更新提现订单 -->
              <do func="ExecSql" >  
                 <para name="SqlCmd" sql="UpdCasStatus"/>
              </do>
              <if condition="#RetCod==2">
                  <set name="RspMsg"    value="无符合条件记录"/>
                  <do func="RollBackWork"/>
                  <continue/>
              </if>
              <elseif condition="#RetCod!=0">
                  <set name="RspMsg"    value="更新订单信息错误"/>
                  <do func="RollBackWork"/>
                  <continue/>
              </elseif> 
           </if>
           <!-- 提现失败 -->
           <elseif condition="IS_EQUAL_STRING(RESULT,'1')">
              <set name="ORDSTATUS"   value="02"/>
              <set name="SucDat"      value=""/>
              <quote name="SelFrzInf"/>
              <!--将提现金额解冻、退回支付账号 -->
              <set name="RCS_PRD_NO"   expr="CASORDNO"/><!--订单号，如果不涉及置空-->
              <set name="PAY_AC_NO"    expr="PAY_AC_NO"/>
              <set name="txAmt"        expr="STRCAT('-',FROZ_AMT)"/>
              <quote name="frezzAmt"/>
              <set name="txAmt"        expr="FROZ_AMT"/>
              <!--更新冻结状态-->
              <quote name="UpdFrezz"/>
              <!-- 更新提现订单 -->
              <do func="ExecSql" >  
                  <para name="SqlCmd" sql="UpdCasStatus"/>
              </do>
              <if condition="#RetCod==2">
                  <set name="RspMsg"    value="无符合条件记录"/>
                  <do func="RollBackWork"/>
                  <continue/>
              </if>
              <elseif condition="#RetCod!=0">
                  <set name="RspMsg"    value="更新订单信息错误"/>
                  <do func="RollBackWork"/>
                  <continue/>
              </elseif>
           </elseif>
           <else>
              <set name="RspMsg"       value="系统不识别该结果状态，跳过！"/>
              <continue/>
           </else>
           <!-- 删除节点 -->
           <delete name="CASORDNO"/>
           <delete name="FILE_TXAMT"/>
           <delete name="RESULT"/>
           <delete name="ERROR"/>
           <delete name="ORDSTATUS"/>
           <delete name="CUST_ID"/>
           <delete name="TXAMT"/>
           <set name="ROW"          expr="ADD(ROW,1)"/>
        </foreach>
        <if condition="IS_EQUAL_STRING(ROW,'0')">
             <set name="RspCod"       value="10004"/>
             <set name="RspMsg"       value="无效文件或无有效数据！"/>
             <set name="DWZ_STATUS_CODE"    value="300" />
             <set name="DWZ_RSP_MSG"        expr="RspMsg"/>
             <do func="RollBackWork"/>
             <return/>
        </if>
        <set name="RspCod"          value="00000"/>
        <set name="RspMsg"          value="文件处理完成！"/>
        <set name="DWZ_STATUS_CODE"    value="200" />
        <set name="DWZ_RSP_MSG"        expr="RspMsg"/>
     </process>
   </transaction>
   
   <transaction code="565117" desc="提交提现复核">
      <sql name="QryOrdInf">
        select casOrdNo,TXAMT,fee,cust_id from stpcasinf where CasOrdNo=#{CasOrdNo}
      </sql>
     <sql name="SelFrzInf">
       select PAY_AC_NO,FROZ_AMT,BIZ_CODE,STATUS,FROZ_NO from ARP_AC_FORZZ_DETAILS where BIZ_CODE=#{CasOrdNo} and STATUS='01'
     </sql>
     <sql name="UpdFrezInf"><!-- 更新冻结信息-->
        UPDATE ARP_AC_FORZZ_DETAILS SET STATUS='00',LST_UPT_DATE=#{LST_UPT_DATE},LST_UPT_TIME=#{LST_UPT_TIME}  WHERE FROZ_NO=#{FROZ_NO}
     </sql>
      <sql name="UpdStatus">
        casOrdNo=#{casOrdNo}
      </sql>
      <process>
         <!--检查用户登录平台是否正确-->
         <if condition="IS_NOEQUAL_STRING(SysCod,'1120')">
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台不正确"/>
            <set name="DWZ_STATUS_CODE" value="300"/>
            <set name="DWZ_RSP_MSG"     expr="RSPMSG"/> 
            <return/>
         </if>
         
         <!--查询提现订单-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryOrdInf"/>
         </do>
         <if condition="#RetCod==2">
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="无符合条件记录"/>
            <set name="DWZ_STATUS_CODE" value="300"/>
            <set name="DWZ_RSP_MSG"     expr="RSPMSG"/> 
            <return/>
         </if>
         <set name="castxamt" expr="TXAMT"/>
         <if condition="IS_EQUAL_STRING(result,'02')">       <!--同意-->   
              <!--查询冻结信息-->
              <quote name="SelFrzInf"/>
              
              <!--将扣除的提现金额解冻 并从账户里扣除-->
              <set name="RCS_PRD_NO"   expr="CasOrdNo"/><!--订单号，如果不涉及置空-->
              <set name="PAY_AC_NO"    expr="PAY_AC_NO"/>
              <set name="txAmt"        expr="STRCAT('-',FROZ_AMT)"/>
              <quote name="frezzAmt"/>
              <set name="txAmt"        expr="FROZ_AMT"/>
              
              <!--更新冻结状态-->
              <quote name="UpdFrezz"/>
              
              <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','-','/','CNY','/',TXAMT,'/','Y','/')"/>  <!--用户记账参数-->  
              <set name="PARAMS"     expr="usrPar"/>
              <!--记账处理-->
              <set name="TXN_TYP"    value="4"/>      <!--用途 4 提现-->
              <set name="prdordno"   expr="casOrdNo"/>
              <quote name="accProcess"/>
              <if condition="#RetCod!=0">
                 <set name="RspCod"    value="08042"/>
                 <set name="RspMsg"    value="提现失败"/>
                 <set name="DWZ_STATUS_CODE" value="300"/>
                 <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
                 <do func="RollBackWork"/> 
                 <return/>
              </if>
              <set name="OrdStatus"      value="02"/>
              
         </if>
         <elseif condition="IS_EQUAL_STRING(result,'03')"><!--拒绝付款-->
              <!--查询冻结信息-->
              <quote name="SelFrzInf"/>
              
              <!--将扣除的提现金额解冻 并从账户里扣除-->
              <set name="RCS_PRD_NO"   expr="CasOrdNo"/><!--订单号，如果不涉及置空-->
              <set name="PAY_AC_NO"    expr="PAY_AC_NO"/>
              <set name="txAmt"        expr="STRCAT('-',FROZ_AMT)"/>
              <quote name="frezzAmt"/>
              <set name="txAmt"        expr="FROZ_AMT"/>
              
              <!--更新冻结状态-->
              <quote name="UpdFrezz"/>
              
              <set name="OrdStatus"      value="03"/>
         </elseif>
         <else>
            <set name="OrdStatus"      value="01"/>
         </else>
         <set name="TXAMT" expr="casTXAMT"/>
         <set name="SucDat"   expr="GETDATETIME()"/>
         <!--更新提现订单-->   
         <delete name="actDat"/>
         <do func="UpdateRecord" error="IGNORE"> 
            <para name="TblNam" value="StpCasInf"/>
            <para name="CndSts" sql="UpdStatus"/>
         </do>
         <if condition="#RetCod==2">
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="无符合条件记录"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </if>
         <elseif condition="#RetCod!=0">
            <set name="RspCod"    value="06003"/>
            <set name="RspMsg"    value="更新订单信息错误"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </elseif> 
         
         <set name="RspCod"              value="00000"/>
         <set name="RspMsg"              value="操作成功"/>
         <set name="DWZ_STATUS_CODE"     value="200"/>
         <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
         
      </process>
   </transaction>
   
   <transaction code="565805" desc="担保支付订单 退款拒绝">
      <!--查询商品订单信息-->
      <sql name="QryOrdInf"><!--查询商品订单表-->
         select OrdStatus,payOrdNo,prdOrdType,retUrl,NotifyUrl,MerNo,stlBatno,acJrnNo,acDate,CUST_ID,bizType,ordamt,CustPayAcNo,rfComAmt from StpPrdInf where prdOrdNo=#{prdOrdNo} AND merNo=#{merNo}
       </sql>
      <sql name="UpdPrdInf"> <!-- 更新商品订单表 -->
         UPDATE STPPRDINF SET ORDSTATUS=#{ORDSTATUS} WHERE prdOrdNo=#{prdOrdNo} 
      </sql>
      <process> 
         <!--检查用户登录平台是否正确-->
         <if condition="IS_NOEQUAL_STRING(SysCod,'1120')">
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台不正确"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </if>
         <set name="merNo"         expr="merNo"/> 
         <set name="PRDORDNO"      expr="PRDORDNO"/>
          
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="QryOrdInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="订单不存在"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/> 
         </if>
         
         <if condition="IS_NOEQUAL_STRING(ordstatus,'03')">
            <set name="RspCod"    value="07019"/>
            <set name="RspMsg"    value="退款审核中订单才可以退款"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </if>
         
         <set name="ORDSTATUS" value="12"/>          <!--订单作废-->
       
         <!--更新订单状态-->
         <do func="ExecSql" error="IGNORE">
            <para name="SqlCmd" sql="UpdPrdInf"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"          value="E"/>
            <set name="RspCod"          value="07018"/>
            <set name="RspMsg"          value="更新订单失败"/>
            <set name="DWZ_STATUS_CODE" value="300"/>
            <set name="DWZ_RSP_MSG"     expr="RspMsg"/>
            <return/>
         </if>
         
         <set name="MsgTyp"             value="N"/>
         <set name="RspCod"             value="00000"/>
         <set name="RspMsg"             value="交易成功"/>
         <set name="DWZ_STATUS_CODE"    value="200"/>
         <set name="DWZ_RSP_MSG"        expr="RspMsg"/>
         <set name="DWZ_CALLBACK_TYPE"  value="closeCurrent"/>
      </process>
   </transaction>   
    
</application>
