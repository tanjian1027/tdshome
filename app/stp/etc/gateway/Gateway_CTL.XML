<?xml version='1.0' encoding='UTF-8'?>
<application name="STP" code="100" log_level="DEBUG">
   <!-- 交易日志记录配置 -->
   <include file="etc/public/STPCTL_TRC.XML"/>
   <!-- 公共宏文件引入-->
   <include file="etc/public/Order_MACRO.XML"/>
   
   <before> 
      <!--打印ETF树-->
      <do func="DumpEtf"/>
      <set name="MsgTyp"        value="N"/>
      <set name="RspCod"        value="00000"/>
      <set name="txCcy"         value="CNY"/>
      
      <!--取当前日期设置会计日期-->
      <set name="ActDat"        expr="GETDATE()"/>
      <set name="TermCode"      expr="_REQUESTATTR.REQIP"/>
   </before>

   <after>
      <if condition="IS_EQUAL_STRING(RspCod,'00000')">
         <set name="MsgTyp"       value="N"/>
      </if>
      <else>
         <set name="MsgTyp"       value="E"/>
      </else>
      <do func="DumpEtf"/>
   </after>

   <transaction code="564101" desc="建立商品订单">
      <sql name="QryMerInf"><!-- 查询商户信息 添加一个a.MER_TYPE-->
         SELECT a.CUST_ID MerId,a.aut_sts,a.company_brief ,c.CUST_STATUS
           FROM StpMerInf a ,StpCusInf c
          WHERE a.cust_id=c.cust_id and  a.CUST_ID=#{merchantId}
      </sql>
      <sql name="QryCusInf"><!-- 查询客户信息-->
         SELECT CUST_STATUS FROM StpCusInf WHERE CUST_ID=#{USERID}
      </sql>
      <sql name="QryMerSigInf"><!-- 查询签约信息-->
         SELECT m.prod_code FROM STPMERSIG m,stpproinf g 
         WHERE m.prod_code =g.prod_code and  g.prod_flag='0' and 
         MER_NO=#{merchantId} and m.prod_code=#{PRODCODE} 
      </sql>
      <sql name="QryOrdInf"><!-- 查询商品订单信息-->
         SELECT prdOrdNo FROM StpPrdInf WHERE prdOrdNo=#{prdOrdNo} AND merNo=#{merchantId}
      </sql>
      <process>
         <!--检查用户登录平台是否正确-->
         <if condition="AND(IS_NOEQUAL_STRING(SysCod,'0001'),IS_NOEQUAL_STRING(SysCod,'2201'),IS_NOEQUAL_STRING(SysCod,'1105'))">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台不正确"/>
            <return/>
         </if>
         <!--检查用户状态-->
          <if condition="ISNULL(USERID)">
             <set name="USERID" expr="SESSIONS.USRID"/>    
          </if>
          
          <set name="merchantId"  expr="merchantId"/>
          <set name="CUST_ID"     expr="USERID"/>
          <set name="prdOrdNo"    expr="orderId"/>
          <set name="ordAmt"      expr="orderAmount"/>
          <set name="orderTime"   expr="orderDate"/>
          <set name="signature"   expr="signature"/>
          <set name="inMsg"       expr="inMsg"/>
          <set name="notifyUrl"   expr="retUrl"/>
          <set name="retUrl"      expr="returnUrl"/>
          <set name="bizType"     expr="bizType"/>
          <set name="prdName"     expr="prdName"/>
          <set name="prdDesc"     expr="prdDesc"/>
          <set name="PRODCODE"    expr="PRODCODE"/><!--商户购买的产品编码-->
          
         <!--检查金额格式-->
         <if condition="NOT(ISNULL(ordAmt))">
            <if condition="NOT(ISNUMBER(ordAmt))">
               <set name="RspCod"    value="08044"/>
               <set name="RspMsg"    value="金额格式错误"/>
               <return/>
            </if>
         </if>
         <else>
            <set name="RspCod"    value="08045"/>
            <set name="RspMsg"    value="订单金额不能为空！"/>
            <return/>
         </else>
         
         <set name="retUrl"        expr="returnUrl"/>
         <if condition="ISNULL(prdDesc)">
           <set name="merRemark"    value="商城名称"/>
         </if>
         <if condition="ISNULL(PrdName)">
           <set name="PrdName"      value="商品"/>
         </if>
         
         <if condition="NOT(ISNUMBER(orderDate))">
            <set name="RspCod"    value="08044"/>
            <set name="RspMsg"    value="日期格式错误"/>
            <return/>
         </if>
         
          <!-- 查询商户信息 -->
          <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryMerInf" />
          </do>
          <if condition="#RetCod!=0">
             <set name="RspCod"    value="08039"/>
             <set name="RspMsg"    value="商户信息不存在"/>
             <return/>
          </if>
          <if condition="IS_NOEQUAL_STRING(CUST_STATUS,'0')">
             <set name="RspCod"    value="08040"/>
             <set name="RspMsg"    value="商户状态不正常"/>
             <return/>
          </if>
          
          <!-- 查询用户信息 -->
          <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryCusInf" />
          </do>
          <if condition="#RetCod!=0">
             <set name="RspCod"    value="08039"/>
             <set name="RspMsg"    value="用户信息不存在"/>
             <return/>
          </if>
          <if condition="IS_NOEQUAL_STRING(CUST_STATUS,'0')">
             <set name="RspCod"    value="08040"/>
             <set name="RspMsg"    value="用户状态不正常"/>
             <return/>
          </if>
          
          <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryMerSigInf" />
          </do>
          <if condition="#RetCod==2">
             <set name="RspCod"    value="08039"/>
             <set name="RspMsg"    value="商户未签约该产品！"/>
             <return/>
          </if>
          <if condition="#RetCod!=0">
             <set name="RspCod"    value="08039"/>
             <set name="RspMsg"    value="商户未签约该产品！"/>
             <return/>
          </if>
          
          <if condition="IS_EQUAL_STRING(prod_code,'CP00000002')">
             <set name="prdOrdType"   value="2"/>        <!--订单类型  0 消费  1 充值2 担保 3商户充值 -->    
          </if>
          <elseif condition="IS_EQUAL_STRING(prod_code,'CP00000007')">
            <set name="prdOrdType"   value="0"/>        <!--订单类型  0 消费  1 充值 2 担保 3商户充值-->    
          </elseif>
          <else>
             <set name="RspCod"    value="08039"/>
             <set name="RspMsg"    value="没有该产品不能支付！"/>
             <return/>
          </else>
          
         <!-- 验签处理 -->
         <!--适用于CFCA及自建CA两种情况-->
         <if condition="IS_EQUAL_STRING(signType,'CFCA')">  <!--验签方式 CFCA -->
             <set name="INSTR"  expr="STRCAT('merchantId=',merchantId,'&amp;prodCode=',prodCode,'&amp;orderId=',orderId,'&amp;orderAmount=',orderAmount,'&amp;orderDate=',orderDate,'&amp;bizType=',bizType,'&amp;retUrl=',notifyUrl,'&amp;returnUrl=',returnUrl,'&amp;prdName=',TOUPPER(STR2HEX(prdName)),'&amp;prdDesc=',TOUPPER(STR2HEX(prdDesc)),'&amp;signType=',signType)"/>
             <!--CACA验签-->
             <do func="CFCASignVer">
                <para name="sourceData"        expr="INSTR" />
                <para name="signData"          expr="SIGNATURE" />
             </do>
             <if condition="#RetCod!=0">
                <set name="RspCod"    value="08039"/>
                <set name="RspMsg"    value="验签失败"/>
                <return/>
             </if>
         </if>
         <elseif condition="IS_EQUAL_STRING(signType,'ZJCA')">  <!--验签方式 自建CA  ZJCA-->
             <set name="CFCAPWD"         value="12345678"/>
             <!--自建CA验签-->
             <do func="HkCaVerifyn">
               <para name="sourceData"   expr="inMsg" />
               <para name="signData"     expr="REPALLSTR(signature,' ','+')" />
               <para name="pfxPath"      expr="STRCAT(GETCURAPPHOME(),'/key/',merchantId,'.pfx')" />
               <para name="pfxPwd"       expr="CFCAPWD" />
             </do>
             <if condition="#RetCod!=0">
                <set name="RspCod"    value="08039"/>
                <set name="RspMsg"    value="验签失败"/>
                <return/>
             </if>
             <delete name="CFCAPWD"/>
         </elseif>
         <else>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="无此验签方式！"/>
            <return/>
         </else>
         
         <delete name="SIGNATURE"/>
         <!--检查商品订单是否存在-->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="QryOrdInf" />
         </do>
         <if condition="#RetCod==2">       <!-- 商品订单不存在 初次支付-->
         </if>
         <elseif condition="#RetCod==0">   <!-- 商品订单存在 退出-->
            <set name="morePay"   value="1"/>
            <set name="RspCod"    value="08046"/>
            <set name="RspMsg"    value="订单号已存在"/>
            <return/>
         </elseif>
         <else>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </else>
         
         <set name="orderTime"    expr="orderTime"/>
         <set name="merNo"        expr="merchantId"/>
         <set name="cust_id"      expr="USERID"/>
         <set name="ordccy"       value="CNY"/>
         <set name="txncomamt"    value="0"/>
         <set name="OrdStatus"    value="00"/>
         <set name="ordsource"    value="0" />  <!--来源  0 PC端  1 手机端-->    
         
         <!--登记商品订单信息-->
         <do func="InsertRecord" error="IGNORE">
            <para name="TblNam"  value="StpPrdInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if>
         
         <!--取收银台参数配置-->
         <set name="ConfigName"       value="PayCfg"/>
         <quote name="ReadXmlCfg"/>
         <set name="payurl"      expr="STRCAT(payurl,'?orderId=',prdordno,'&amp;merNo=',merchantId)"/>
         
         <set name="MsgTyp"    value="N"/>
         <set name="RspCod"    value="00000"/>
         <set name="RspMsg"    value="交易成功"/>
      </process>
   </transaction>
   
   <transaction code="564102" desc="退款发起">
      <sql name="QryMerInf"><!-- 查询商户信息 添加一个a.MER_TYPE-->
         SELECT a.CUST_ID MerId,a.aut_sts,a.company_brief ,c.CUST_STATUS
           FROM StpMerInf a ,StpCusInf c
          WHERE a.cust_id=c.cust_id and  a.CUST_ID=#{merchantId}
      </sql>
      <sql name="SelMaStatus">  <!--查询客户账户状态 -->
        select a.AC_STATUS,to_number(nvl(cash_ac_bal,0)-nvl(froz_balance,0)) cashacbal,a.PAY_AC_NO merpayno 
        from ARP_AC_PROFILE a,ARP_AC_CUST_REL b where a.PAY_AC_NO=b.PAY_AC_NO and b.cust_id =#{merno} and b.ac_type='01'
      </sql>
      <sql name="QryCusInf"><!-- 查询客户信息-->
         SELECT CUST_STATUS FROM StpCusInf WHERE CUST_ID=#{USERID}
      </sql>
     <sql name="QryOrdInf"><!--查询商品订单表-->
        select OrdStatus,payOrdNo,prdOrdType,CUST_ID,bizType,prdname,ordsource,prodcode,nvl(rfTotalAmt,0) rftotalamt,
        nvl(ordamt,0) ordamt,nvl(txncomamt,0) txncomamt, NVL(filed1,0) AS commAmtRef
         from StpPrdInf where prdOrdNo=#{prdOrdNo} AND merNo=#{merNo}
      </sql>
      <sql name="QryPayTyp">
        select OrdStatus,payType,nvl(accAmt,0) accAmt,nvl(mulAmt,0) mulAmt,fee,merNo,txamt,bankcod,cust_id ruserid,BANKCOD BANKCODE,BANKJRNNO 
        from StpPayInf where payOrdNo=#{payOrdNo}
      </sql>
      <sql name="QryRefInf">
        select refOrdNo,OrdStatus from StpRefInf where oriPrdOrdNo=#{prdOrdNo} and OrdStatus!='03'
      </sql>
      <sql name="QryRefTotAmt">
        select nvl(SUM(rfAmt),0) totRefAmt from StpRefInf where oriPrdOrdNo=#{prdOrdNo} and (OrdStatus='00' or OrdStatus='02' )
      </sql>
      <sql name="UpdRefInf">
        UPDATE STPREFINF SET  RFPAYORDNO=#{RFPAYORDNO},RFPAYDATE=#{RFPAYDATE}
       WHERE refOrdNo=#{refOrdNo}
      </sql>
      <sql name="UpdPrdtotal">
         update stpprdinf set rfTotalAmt=(SELECT case when rfTotalAmt is null then 0+${rfAmt} else rfTotalAmt+${rfAmt} end rfTotalAmt FROM stpprdinf WHERE prdOrdNo=#{prdOrdNo} and MerNo=#{MerNo}) 
         where prdOrdNo=#{prdOrdNo} and MerNo=#{MerNo}
      </sql>
      <sql name="refStatus"><!--退款失败更新订单状态-->
        update STPREFINF set ordstatus=#{ordstatus} where refordno=#{REFORDNO}
      </sql>
      <process>
           <!--检查用户状态-->
           <if condition="ISNULL(USERID)">
              <set name="USERID" expr="SESSIONS.USRID"/>    
           </if>
           
           <set name="merno"       expr="merchantId"/>
           <set name="CUST_ID"     expr="USERID"/>
           <set name="prdOrdNo"    expr="orderId"/>       <!-- 原商品订单号 -->
           <set name="rfAmt"       expr="rfAmt"/>         <!-- 退款金额 -->
           <set name="bankPayAcNo"   expr="bankPayAcNo"/>
           <set name="bankPayUserNm" expr="bankPayUserNm"/>
           <set name="rfSake"        expr="rfSake"/>      <!-- 退款理由 -->
           <set name="signature"     expr="signature"/>   <!-- 签名 -->
           <set name="notifyUrl"     expr="notifyUrl"/>
           
           <!--检查用户登录平台是否正确-->
           <quote name="ChkNoCusOpen"/>
           
           <if condition="ISNULL(prdOrdNo)">
              <set name="RspCod"    value="64103"/>
              <set name="RspMsg"    value="原商品订单号不能为空"/>
              <return/>
           </if>
           <if condition="ISNULL(merchantId)">
              <set name="RspCod"    value="64103"/>
              <set name="RspMsg"    value="商户编号不能为空"/>
              <return/>
           </if>
           
          <!--检查金额格式-->
          <if condition="NOT(ISNULL(rfAmt))">
             <if condition="NOT(ISNUMBER(rfAmt))">
                <set name="RspCod"    value="08044"/>
                <set name="RspMsg"    value="金额格式错误"/>
                <return/>
             </if>
          </if>
          <else>
             <set name="RspCod"    value="08045"/>
             <set name="RspMsg"    value="退款金额不能为空！"/>
             <return/>
          </else>
          
          <if condition="ISNULL(rfSake)">
            <set name="PrdName"      value="退款商品说明"/>
          </if>
         
         <!-- 验签处理 -->
         <!--适用于CFCA及自建CA两种情况-->
         <if condition="IS_EQUAL_STRING(signType,'CFCA')">  <!--验签方式 CFCA -->
            <!--set name="INSTR"  expr="STRCAT('merchantId=',merchantId,'&amp;prodCode=',prodCode,'&amp;orderId=',orderId,'&amp;orderAmount=',orderAmount,'&amp;orderDate=',orderDate,'&amp;bizType=',bizType,'&amp;retUrl=',retUrl,'&amp;returnUrl=',returnUrl,'&amp;prdName=',TOUPPER(STR2HEX(prdName)),'&amp;prdDesc=',TOUPPER(STR2HEX(prdDesc)),'&amp;signType=',signType)"/-->
            <set name="INSTR"  expr="STRCAT('merchantId=',merchantId,'&amp;orderId=',orderId,'&amp;rfAmt=',rfAmt,'&amp;bankPayAcNo=',bankPayAcNo,'&amp;bankPayUserNm=',TOUPPER(STR2HEX(bankPayUserNm)),'&amp;rfSake=',TOUPPER(STR2HEX(rfSake)),'&amp;notifyUrl=',notifyUrl,'&amp;signType=',signType)"/>
            <!--CACA验签-->
            <do func="CFCASignVer">
               <para name="sourceData"        expr="INSTR" />
               <para name="signData"          expr="SIGNATURE" />
            </do>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="08039"/>
               <set name="RspMsg"    value="验签失败"/>
               <return/>
            </if>
         </if>
         <elseif condition="IS_EQUAL_STRING(signType,'ZJCA')">  <!--验签方式 自建CA  ZJCA-->
             <set name="CFCAPWD"         value="12345678"/>
             <!--自建CA验签-->
             <do func="HkCaVerifyn">
               <para name="sourceData"   expr="inMsg" />
               <para name="signData"     expr="REPALLSTR(signature,' ','+')" />
               <para name="pfxPath"      expr="STRCAT(GETCURAPPHOME(),'/key/',merchantId,'.pfx')" />
               <para name="pfxPwd"       expr="CFCAPWD" />
             </do>
             <if condition="#RetCod!=0">
                <set name="RspCod"    value="08039"/>
                <set name="RspMsg"    value="验签失败"/>
                <return/>
             </if>
             <delete name="CFCAPWD"/>
         </elseif>
         <else>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="无此验签方式！"/>
            <return/>
         </else>
         <delete name="SIGNATURE"/>
         
         <!--银行卡号-->
         <!--do func="GetCrdInfo">
              <para name="CrdNo" expr="bankPayAcNo" />
          </do>
          <if condition="#RetCod!=0">
              <set name="CPSCod" value="99" />
              <set name="RspMsg" value="获取卡bin信息失败" />
              <return />
          </if>
          <set name="ISSBANKNAME"  expr="ISSNAM" /-->
          <!-- 卡类型 01：借记卡 02：信用卡 -->
          <!--set name="BANKCARDTYPE" expr="DCFLAG" />
          <set name="bankCode"     expr="ISSNO" />
          
          <if condition="IS_NOEQUAL_STRING(BANKCARDTYPE,'01')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="银行卡号不是借记卡，不能退款！"/>
            <return/>
         </if-->
         
         <!--收款卡号加密-->
         <!--set name="CARD_NO"      expr="DES_ENCRYPT(bankPayAcNo)"   /-->
         
         <!-- 查询商户信息 -->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="QryMerInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="08039"/>
            <set name="RspMsg"    value="商户信息不存在"/>
            <return/>
         </if>
         <if condition="IS_NOEQUAL_STRING(CUST_STATUS,'0')">
            <set name="RspCod"    value="08040"/>
            <set name="RspMsg"    value="商户状态不正常"/>
            <return/>
         </if>
         
         <do func="ReadRecord"       error="IGNORE">
            <para name="SqlCmd"       sql="SelMaStatus"/>
         </do>
         <set name="AC_STATUS"       expr="AC_STATUS"/>
         <if condition="IS_EQUAL_STRING(AC_STATUS,'2')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="商户账户已经被冻结，不能申请退款！"/>
            <return/>
         </if>
         <if condition="DOUBLECMP(cashacbal,1,rfAmt)">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="商户账户余额不足，不能申请退款！"/>
            <return/>
         </if>
         
         <!--查询商品订单信息-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryOrdInf"/>
         </do>
         <if condition="#RetCod==2">
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="无符合条件记录,不能退款！"/>
            <return/>
         </if>
         <elseif condition="#RetCod!=0">
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </elseif>
         
         <!-- 检测商品订单状态 -->
         <if condition="NOT(OR(IS_EQUAL_STRING(OrdStatus,'01'),IS_EQUAL_STRING(OrdStatus,'12')))">
            <set name="RspCod"    value="06007"/>
            <set name="RspMsg"    value="订单状态不正确或订单未支付!"/>
            <return/>
         </if>
         
         <!--订单类型不正确，不能退款-->
         <if condition="NOT(OR(IS_EQUAL_STRING(prdOrdType,'0'),IS_EQUAL_STRING(prdOrdType,'2')))">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01033"/>
            <set name="RspMsg"    value="该订单不是消费订单，不能申请退款！"/>
            <return/>
         </if>
         
         <!--查询退款订单信息-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryRefTotAmt"/>
         </do>
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryRefInf"/>
         </do>
         <if condition="#RetCod==0">
             <!-- 00:等待处理 02:退款成功 03:退款失败-->
             <if condition="IS_EQUAL_STRING(OrdStatus,'02')">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09999"/>
               <set name="RspMsg"    value="该订单已退款，不允许再次退款！"/>
               <return/>
             </if>
             <if condition="IS_EQUAL_STRING(OrdStatus,'00')">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09999"/>
               <set name="RspMsg"    value="该订单退款中，不允许再次退款！"/>
               <return/>
             </if>
         </if>
         <elseif condition="#RetCod==2">
             <!-- 不存在退款订单 已退款总金额设置为0 -->
             <set name="totRefAmt"       value="0"/>
         </elseif>
         <else>
             <set name="MsgTyp"    value="E"/>
             <set name="RspCod"    value="09999"/>
             <set name="RspMsg"    value="系统错误"/>
             <return/>
         </else>
        
        <!--退款金额检查-->
        <if condition="DOUBLECMP(ordamt,1,ADDAMT(totRefAmt,rfAmt))">
           <set name="RspCod"    value="08008"/>
           <set name="RspMsg"    value="退款金额超限"/>
           <return/>
        </if>
        
         <!--查询支付类型-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryPayTyp"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/> 
         </if>
         
         <!-- 检测商品订单状态 -->
         <if condition="IS_NOEQUAL_STRING(OrdStatus,'01')">
            <set name="RspCod"    value="06007"/>
            <set name="RspMsg"    value="订单支付不正确！"/>
            <return/>
         </if>
         
         <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
            <set name="rfAfterPay"   value="1"  />    <!--担保交易虚拟账号“是否确定付款”标识，此处代表确定付款-->
         </if> 
         
         <!-- 检测是否收取手续费 -->
         <set name="netRecAmt"     expr="rfAmt"/>
         <if condition="OR(IS_EQUAL_STRING(fee,''),IS_EQUAL_STRING(fee,'0'))">    <!--原交易未收取手续费-->
            <!-- 退货时是否另外收取手续费 Y-是；N-否；  -->
            <if condition="AND(IS_EQUAL_STRING(rfRecFeeFlg,'Y'),NOT(ISNULL(rfRecFeeCode)))">
               <!-- 退款金额是交易金额+手续费 -->
               <set name="txnAmt_fee"    expr="rfAmt"/>
               <set name="FEE_CODE"      expr="rfRecFeeCode"/>
               <quote name="FeeCount"/>
               <set name="fee"           expr="fee"/>    <!--手续费-->
               <if condition="IS_EQUAL_STRING(payType,'00')">  <!-- 商户退款,有手续费,不退佣金 退回用户虚拟账户-->
                  <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',ADD(rfAmt,fee),'/','Y','/')"/>    <!--商户记账参数-->
                  <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',rfAmt,'/','Y','/')"/>           <!--用户记账参数-->
                  <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>    <!--平台账户（手续费）记账参数-->
                  <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',feePar)"/>
               </if>
               <else>   <!-- 商户退款,有手续费,不退佣金 网银-->
                  <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',ADD(rfAmt,fee),'/','Y','/')"/>    <!--商户记账参数-->
                  <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>    <!--平台账户（手续费）记账参数-->
                  <set name="PARAMS"     expr="STRCAT(merPar,',',feePar)"/>
               </else>
            </if>
            <else>
               <set name="fee"                 value="0"/>
               <set name="rfRecFeeFlg"         value="N"/>
            </else>
            <set name="rfCommFlg"              value="N"/>
            <set name="rfCommAmt"              value="0"/>
         </if>
         <else><!-- 原交易收取了交易手续费 , 检测商户退款是否退佣金  --> 
            <!-- 退货时是否退原收取的佣金：Y-是；N-否；  -->
            <if condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">
               <!-- 退款佣金  --> 
               <set name="rfCommAmt"        expr="DIV(MUL(fee,rfAmt),ordamt)"/>
               <!-- 退款手续费 -->
               <set name="txnAmt_fee"    expr="rfAmt"/>
               <set name="FEE_CODE"      expr="rfRecFeeCode"/>
               <quote name="FeeCount"/>
               <set name="fee"           expr="fee"/>    <!--手续费-->
            </if>
            <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),OR(IS_EQUAL_STRING(rfRecFeeFlg,'N'),IS_EQUAL_STRING(rfRecFeeFlg,'')))">
               <!-- 退款佣金  --> 
               <set name="rfCommAmt"           expr="DIV(MUL(fee,rfAmt),ordamt)"/>
               <!-- 退款手续费 -->
               <set name="fee"                 value="0"/>
               <set name="rfRecFeeFlg"         value="N"/>
            </elseif>
            <elseif condition="AND(OR(IS_EQUAL_STRING(rfCommFlg,'N'),IS_EQUAL_STRING(rfCommFlg,'')),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">
               <!-- 退款手续费 -->
               <set name="txnAmt_fee"          expr="rfAmt"/>
               <set name="FEE_CODE"            expr="rfRecFeeCode"/>
               <quote name="FeeCount"/>
               <set name="fee"           expr="fee"/>    <!--手续费-->
               <!-- 退款佣金  --> 
               <set name="rfCommAmt"           value="0"/>
               <set name="rfCommFlg"           value="N"/>
            </elseif>
            <else>
               <set name="fee"                 value="0"/>
               <set name="rfCommAmt"           value="0"/>
               <set name="rfRecFeeFlg"         value="N"/>
               <set name="rfCommFlg"           value="N"/>
            </else> 
         </else>
         
         <if condition="ISNULL(rfComAmt)">
            <set name="rfComAmt"   value="0"/>                            <!--已退佣金-->
         </if>
         <!-- 虚拟账户退款直接更新累计退佣金-->
         <set name="rfComAmt"      expr="rfComAmt"/> <!--库中的已退佣金,下面的虚拟账户退款需要累计本次退佣金-->
         <set name="netRecAmt"     expr="SUB(ADD(rfAmt,fee),rfCommAmt)"/> <!--净额 rfCommAmt为本次退佣金-->
         <set name="accAmttmp"     expr="ACCAMT"/>     
                  
         <!--获取序号 -->
         <do func="GetSeqNo"  error="IGNORE">
            <para name="TblNam" value="stpseqrec"/>
            <para name="KeyNam" value="KeyNam"/>
            <para name="KeyVal" expr="STRCAT('StpRefInf','RefOrdNo')"/>
            <para name="SeqNam" value="KeyVal"/>
            <para name="Len"    value="8"/>
            <para name="Circle" value="1"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09001"/>
            <set name="RspMsg"    value="获取序号错误"/>
            <set name="DWZ_STATUS_CODE"     value="300"/>
            <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
            <return/>
         </if>
         <set name="MerNo"        expr="merchantId"/>
         <set name="rfOrdTime"    expr="GETDATETIME()"/> <!-- 退款申请时间 -->
         <set name="refOrdNo"     expr="STRCAT('R',SUBSTR(ACTDAT,2,7),KeyVal)"/>
         <set name="oriPrdOrdNo"  expr="PrdOrdNo"/> <!--原商品订单号-->
         <set name="oriPayOrdNo"  expr="payOrdNo"/> <!--原支付订单号-->
         <set name="OrdStatus"    value="00"/>
         <set name="txCcy"        value="CNY"/>
         <set name="NotifyUrl"    expr="NotifyUrl"/>
         <set name="rfAmt"        expr="rfAmt"/>       <!--退款金额-->
         <set name="rfSake"       expr="rfSake"/>
         <set name="fee"          expr="fee"/>         <!--退款手续费-->
         <set name="CUST_ID"      expr="CUST_ID"/>
         <set name="bankCode"     expr="bankCode"/>
         <set name="opkbnkNam"    expr="ISSBANKNAME"/>
         <set name="bankPayAcNo"   expr="CARD_NO"  />  <!--买家收款账号-->
         <set name="bankPayUserNm" expr="bankPayUserNm"/> <!--买家收款账号名-->
         <set name="rfReqDate"     value=""/>
         
         <if condition="AND(IS_EQUAL_STRING(PRDORDTYPE,'2'),IS_NOEQUAL_STRING(rfAfterPay,'1'))"><!--担保支付未确认付款前退款，不收手续费，不退佣金-->
             <set name="filed1"       expr="rfCommAmt"/>   <!-- 退佣金 -->
         </if>
         <else>
             <set name="filed1"        value="0"/> 
         </else>
         <set name="rfFee"         expr="fee"/>
         <!--登记退款订单信息-->  
         <do func="InsertRecord" error="IGNORE">
            <para name="TblNam"  value="StpRefInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if>
         
         <!--冻结用户提现金额 -->  
         <set name="PAY_AC_NO"       expr="merpayno"/>
         <quote name="frezzAmt"/>
         <set name="BIZ_CODE"        expr="refOrdNo"/>
         <set name="FROZ_REASON"     value="退款"/>
         <quote name="InsFrozInf"/>   
         <do func="CommitWork"/>
         
         <!--记账-->
         <set name="TXN_TYP"      value="7"/>      <!--用途 7 退款-->
         <set name="rfReqDate"    value=""/>
         <if condition="IS_EQUAL_STRING(payType,'00')">         <!--虚拟账户退款直接退回-->
            <set name="OrdStatus"     value="02"/>              <!-- 退款订单-退款成功-->
            <set name="rfReqDate"     expr="GETDATETIME()"/>    <!--退款成功时间-->
            <set name="ACCAMT"        expr="rfAmt"/>            <!--虚拟账户退款金额-->
            <set name="MULAMT"        value="0"/>               <!--网银退款金额-->
            <if condition="AND(IS_EQUAL_STRING(PRDORDTYPE,'2'),IS_NOEQUAL_STRING(rfAfterPay,'1'))"><!--担保支付未确认付款前-->
               <set name="rfRecFeeFlg" value="N"/>
               <set name="rfCommFlg"   value="N"/>
               <!--担保支付未确认付款前退款不收取手续费-->
               <set name="netRecAmt"    expr="rfAmt"/>
               <set name="fee"          value="0"/>
               <set name="rfCommAmt"    value="0"/>
               <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>          <!--商户记账参数-->
               <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',rfAmt,'/','Y','/')"/>           <!--用户记账参数-->
               <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar)"/>
            </if>
            <else>      <!--担保支付确认付款后 或者 直接支付成功-->
               <!-- 记账 商户-  用户+  -->        
               <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>          <!--商户记账参数-->
               <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',rfAmt,'/','Y','/')"/>            <!--用户记账参数-->        
               <if condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">      <!--退款，有手续费退佣金-->
                 <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>       <!--平台账户（手续费）记账参数-->
                 <set name="rfComPar"   expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',rfCommAmt,'/','N','/')"/> <!--平台账户（退款退佣金）记账参数-->
                 <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',feePar,',',rfComPar)"/>
               </if>
               <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),IS_EQUAL_STRING(rfRecFeeFlg,'N'))">  <!--退款，无手续费退佣金-->
                 <set name="rfComPar"   expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',rfCommAmt,'/','N','/')"/> <!--平台账户（退款退佣金）记账参数-->
                 <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',rfComPar)"/>
               </elseif>
               <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'N'),IS_EQUAL_STRING(rfRecFeeFlg,'N'))">  <!--退款，无手续费不退佣金-->
                 <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar)"/>
               </elseif>
               <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'N'),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">  <!--退款，有手续费不退佣金-->
                 <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>       <!--平台账户（手续费）记账参数-->
                 <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',feePar)"/>
               </elseif>
            </else>
            <!-- 记账处理 -->
            <set name="prdordnotmp"  expr="prdordno"/>
            <set name="prdordno"     expr="refordno"/>
            <quote name="accProcess"/> 
            <if condition="#RetCod!=0"> 
               <set name="ordstatus" value="03"/><!--退款失败更新订单状态-->
               <do func="ExecSql" error="IGNORE">
                 <para name="SqlCmd" sql="refStatus"/>
               </do>
               <set name="RspCod"    value="07001"/>
               <set name="RspMsg"    expr="STRCAT('交易失败！',RspMsg)"/>
               <set name="DWZ_STATUS_CODE"     value="300"/>
               <set name="DWZ_RSP_MSG"         expr="RspMsg"/> 
               <return/>
            </if>
            <set name="prdordno"  expr="prdordnotmp"/>
         </if>
         <elseif condition="IS_EQUAL_STRING(payType,'04')">   <!-- 如果是混合支付，判断退款金额是否大于虚拟账户支付的金额   -->
            <set name="accamt"      expr="accamt"/>
            <set name="totrefamt"   expr="rftotalamt"/>
            <if condition="DOUBLECMP(accamt,5,ADD(totRefAmt,rfAmt))">    <!--全部退回用户支付账户-->
              <set name="OrdStatus"     value="02"/>
              <set name="rfReqDate"     expr="GETDATETIME()"/> <!--退款成功时间-->
              <set name="ACCAMT"        expr="rfAmt"/>         <!--虚拟账户退款金额-->
              <set name="MULAMT"        value="0"/>            <!--网银退款金额-->
              <!-- 记账：虚拟账户支付部分，直接退回   商户-，用户+-->
              <if condition="AND(IS_EQUAL_STRING(PRDORDTYPE,'2'),IS_NOEQUAL_STRING(rfAfterPay,'1'))"><!--担保支付未确认付款前-->
                  <set name="rfRecFeeFlg" value="N"/>
                  <set name="rfCommFlg"   value="N"/>
                  <!--担保支付未确认付款前退款不收取手续费-->
                  <set name="netRecAmt"    expr="rfAmt"/>
                  <set name="fee"          value="0"/>
                  <set name="rfCommAmt"    value="0"/>
                  <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>          <!--商户记账参数-->
                  <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',rfAmt,'/','Y','/')"/>           <!--用户记账参数-->
                  <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar)"/>
              </if>
              <else>      <!--担保支付确认付款后 或者 直接支付成功-->
                 <!-- 记账 商户-  用户+  -->        
                 <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>          <!--商户记账参数-->
                 <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',rfAmt,'/','Y','/')"/>            <!--用户记账参数-->        
                 <if condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">      <!--退款，有手续费退佣金-->
                   <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>       <!--平台账户（手续费）记账参数-->
                   <set name="rfComPar"   expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',rfCommAmt,'/','N','/')"/> <!--平台账户（退款退佣金）记账参数-->
                   <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',feePar,',',rfComPar)"/>
                 </if>
                 <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'Y'),IS_EQUAL_STRING(rfRecFeeFlg,'N'))">  <!--退款，无手续费退佣金-->
                   <set name="rfComPar"   expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',rfCommAmt,'/','N','/')"/> <!--平台账户（退款退佣金）记账参数-->
                   <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',rfComPar)"/>
                 </elseif>
                 <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'N'),IS_EQUAL_STRING(rfRecFeeFlg,'N'))">  <!--退款，无手续费不退佣金-->
                   <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar)"/>
                 </elseif>
                 <elseif condition="AND(IS_EQUAL_STRING(rfCommFlg,'N'),IS_EQUAL_STRING(rfRecFeeFlg,'Y'))">  <!--退款，有手续费不退佣金-->
                   <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>       <!--平台账户（手续费）记账参数-->
                   <set name="PARAMS"     expr="STRCAT(merPar,',',usrPar,',',feePar)"/>
                 </elseif>
              </else>
              <!-- 记账处理 -->
              <set name="prdordnotmp"  expr="prdordno"/>
              <set name="prdordno"     expr="refordno"/>
              <quote name="accProcess"/> 
              <if condition="#RetCod!=0"> 
                 <set name="ordstatus" value="03"/><!--退款失败更新订单状态-->
                 <do func="ExecSql" error="IGNORE">
                   <para name="SqlCmd" sql="refStatus"/>
                 </do>
                 <set name="RspCod"    value="07001"/>
                 <set name="RspMsg"    expr="STRCAT('交易失败！',RspMsg)"/>
                 <set name="DWZ_STATUS_CODE"     value="300"/>
                 <set name="DWZ_RSP_MSG"         expr="RspMsg"/> 
                 <return/>
              </if>
              <set name="prdordno"  expr="prdordnotmp"/>
            </if>
            <else> 
                <set name="OrdStatus"   value="00"/>  <!-- 设置退款订单状态为 00 未处理  -->
                <!-- 记账：网银支付部分；借商户虚拟账号，贷银行应付款项；同时冻结部分虚拟账户支付金额 -->
                <set name="netRecAmtTmp" expr="netRecAmt"/>
                <set name="rfAmtTmp"     expr="rfAmt"/> 
                <if condition="DOUBLECMP(totRefAmt,5,accamt)">    <!--全部退回网银-->
                   <set name="ACCAMT"        value="0"/>       <!--虚拟账户退款金额-->
                   <set name="MULAMT"        expr="rfAmt"/>    <!--网银退款金额-->
                </if>
                <else>    <!-- 部分退回网银  部分退回支付账户-->
                   <set name="accRefAmt"   expr="SUB(accamt,totRefAmt)"/>     <!--部分退款至虚拟账户-->
                   <set name="rfAmt"       expr="SUB(rfAmt,accRefAmt)"/>      <!--部分退款至网银-->
                   <set name="ACCAMT"        expr="accRefAmt"/>       <!--虚拟账户退款金额-->
                   <set name="MULAMT"        expr="rfAmt"/>           <!--网银退款金额-->
                </else>
                
                <!--********银行接口接入********-->
                
                <!--********银行接口接入********-->
                
                <if condition="AND(IS_EQUAL_STRING(PRDORDTYPE,'2'),IS_NOEQUAL_STRING(rfAfterPay,'1'))"><!--担保支付未确认付款前-->
                   <!--不收取手续费不退佣金-->
                   <set name="netRecAmt" expr="rfAmt"/>
                   <set name="fee"          value="0"/>
                   <set name="rfCommAmt"    value="0"/>
                   <set name="merPar"       expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>  <!--商户记账参数-->
                   <set name="PARAMS"       expr="merPar"/>
                </if>   
                <else>      <!--担保支付确认付款后 或者直接支付成功-->
                   <!--********银行接口直接接入 不冻结********-->
                   <!--冻结商户退款金额-->
                   <!--set name="PAY_AC_NO"     expr="merpayno"/>
                   <set name="txAmt"         expr="netRecAmt"/>
                   <quote name="frezzAmt"/>
                   <set name="BIZ_CODE"     expr="refOrdNo"/>
                   <set name="FROZ_REASON"  value="退款"/>
                   <quote name="InsFrozInf"/-->
                   <!--********银行接口直接接入 不冻结********-->
                       
                    <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>  <!--商户记账参数-->
                    <!-- rfFee为退款手续费，需要通过退款表的rffee来判断是否为退款收手续费，而不是订单表的fee-->
                    <if condition="AND(IS_NOEQUAL_STRING(rfFee,'0'),IS_NOEQUAL_STRING(commAmtRef,'0'))">  <!--有手续费退佣金-->
                      <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',rfFee,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                      <set name="commPar"    expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',commAmtRef,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                      <set name="PARAMS"     expr="STRCAT(merPar,',',commPar,',',feePar)"/>
                      <set name="filed1"       expr="commAmtRef"/>
                      <set name="updrfComAmt"   expr="STRCAT(',rfComAmt= \'',ADD(prdRfComAmt,commAmtRef),'\'')"/><!--查询出累计退佣金，退款成功的情况累计 -->
                    </if>
                    <elseif condition="AND(IS_EQUAL_STRING(rfFee,'0'),IS_NOEQUAL_STRING(commAmtRef,'0'))">  <!--无手续费退佣金-->
                      <set name="commPar"    expr="STRCAT('99999900000001','/','03','/','-','/','CNY','/',commAmtRef,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                      <set name="PARAMS"     expr="STRCAT(merPar,',',commPar)"/> 
                      <set name="filed1"       expr="commAmtRef"/>
                      <set name="updrfComAmt"   expr="STRCAT(',rfComAmt= \'',ADD(prdRfComAmt,commAmtRef),'\'')"/><!--查询出累计退佣金，退款成功的情况累计 -->
                    </elseif>
                    <elseif condition="AND(IS_EQUAL_STRING(rfFee,'0'),IS_EQUAL_STRING(commAmtRef,'0'))">  <!--无手续费不退佣金-->
                      <set name="PARAMS"     expr="merPar"/> 
                    </elseif>
                    <elseif condition="AND(IS_NOEQUAL_STRING(rfFee,'0'),IS_EQUAL_STRING(commAmtRef,'0'))">  <!--有手续费不退佣金-->
                      <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',rfFee,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
                      <set name="PARAMS"     expr="STRCAT(merPar,',',feePar)"/>
                    </elseif>
                </else>
                
                <if condition="IS_EQUAL_STRING(prodcode,'CP00000003')"><!--无账户网银支付-->
                    
                </if>
                <else> <!--有账号支付退给用户-->
                    <set name="usrPar"     expr="STRCAT(ruserid,'/','01','/','+','/','CNY','/',ACCAMT,'/','Y','/')"/>            <!--用户记账参数-->        
                    <set name="PARAMS"     expr="STRCAT(PARAMS,',',usrPar)"/>
                </else>
                
                <!--记账处理-->
                <set name="prdordnotmp"  expr="prdordno"/>
                <set name="prdordno"     expr="refordno"/>
                <quote name="accProcess"/> 
                <if condition="#RetCod!=0"> 
                   <set name="ordstatus" value="03"/><!--退款失败更新订单状态-->
                   <do func="ExecSql" error="IGNORE">
                     <para name="SqlCmd" sql="refStatus"/>
                   </do>
                   <set name="RspCod"    value="07001"/>
                   <set name="RspMsg"    expr="STRCAT('交易失败！',RspMsg)"/>
                   <set name="DWZ_STATUS_CODE"     value="300"/>
                   <set name="DWZ_RSP_MSG"         expr="RspMsg"/> 
                   <set name="RspCod"    value="07001"/>
                   <set name="RspMsg"    value="交易失败，请联系客服！"/>
                   <do func="RollBackWork"/>    <!--回滚提交数据-->
                   <return/>
                </if>
                <set name="prdordno"  expr="prdordnotmp"/>
                
                <set name="OrdStatus"     value="02"/>              <!-- 退款订单-退款成功-->
                <set name="rfReqDate"     expr="GETDATETIME()"/>    <!--退款成功时间-->
                <set name="netRecAmt"    expr="netRecAmtTmp"/>
                <set name="rfAmt"        expr="rfAmtTmp"/>
            </else>
         </elseif>
         <elseif condition="OR(IS_EQUAL_STRING(payType,'01'),IS_EQUAL_STRING(payType,'03'))">   <!-- 网银支付  -->
            <set name="OrdStatus"     value="00"/>            <!-- 设置退款订单状态为 00 未处理  -->
            <set name="ACCAMT"        value="0"/>             <!--虚拟账户退款金额-->
            <set name="MULAMT"        expr="rfAmt"/>          <!--网银退款金额-->
            
            <!--********银行接口接入********-->
            <!-- 组退货接口 -->
            <set name="payAmt"        expr="rfAmt"/>
            <set name="upopMerNo"     expr="merno"/>
            <set name="ACTDAT"        expr="GETDATETIME()"/>
            <quote name="SendInC"/>
            
            <!--更新退款订单-->
            <set name="RFPAYDATE"     expr="GETDATE()"/>
            <set name="RFPAYORDNO"    expr="STRCAT('T',oriPayOrdNo,'1')"/>
            <do func="ExecSql" error="IGNORE">  
              <para name="SqlCmd" sql="UpdRefInf"/>
            </do>
            <!--********银行接口接入********-->
         </elseif>
         <else>
            <set name="OrdStatus"   value="01"/>    
         </else>
         
         <set name="MsgTyp"    value="N"/>
         <set name="RspCod"    value="00000" />
         <set name="RspMsg"    value="交易成功!" />
      </process>
   </transaction>
   
   <transaction code="564103" desc="担保支付确定付款">
       <sql name="QryMerInf"><!-- 查询商户信息 添加一个a.MER_TYPE-->
         SELECT a.CUST_ID MerId,a.aut_sts,a.company_brief ,b.CUST_STATUS
           FROM StpMerInf a,StpCusInf b 
          WHERE a.CUST_ID = b.CUST_ID AND a.CUST_ID=#{merchantId}
      </sql>
      <sql name="SelMaStatus">  <!--查询客户账户状态 -->
        select a.AC_STATUS,AC_TYPE,PASSWORD,nvl(froz_balance,0) froz_balance,
        to_number(nvl(cash_ac_bal,0)-nvl(froz_balance,0)) cashacbal,a.PAY_AC_NO merpayacno
        from ARP_AC_PROFILE a,ARP_AC_CUST_REL b where a.PAY_AC_NO=b.PAY_AC_NO and b.cust_id =#{merchantId}
      </sql>
      <sql name="QryCusInf"><!-- 查询客户信息-->
         SELECT CUST_STATUS,b.pay_ac_no USRPAYACNO FROM StpCusInf c,ARP_AC_CUST_REL b WHERE c.cust_id=b.cust_id and c.CUST_ID=#{USERID} 
      </sql>
      <!--查询商品订单信息-->
      <sql name="queryPayinf">
        select nvl(ordamt,0) ordamt,nvl(rfTotalAmt,0) rfTotalAmt,OrdStatus,prdName,merNo,
        prdname,ordsource,prodcode,bizType,payOrdNo,prdOrdType,NotifyUrl,CUST_ID USERID
        from stpprdinf where PrdOrdNo=#{PrdOrdNo}
      </sql>
      <sql name="SelPayInf">
        select OrdStatus,txAmt,accAmt,payType,nvl(fee,0) FEE from stppayinf
        where PrdOrdNo=#{PrdOrdNo}
      </sql>
      <sql name="UpdPay"> <!-- 更新支付订单表 -->
        update stppayinf set OrdStatus=#{OrdStatus},ActDat=#{ActDat},netRecAmt=#{netRecAmt} where payOrdNo=#{payOrdNo}
      </sql>
      <sql name="UpdPrd"> <!-- 更新商品订单表 -->
        update stpprdinf set OrdStatus=#{OrdStatus} where prdOrdNo=#{prdOrdNo}
      </sql>
      <process>
           <!--检查用户状态-->
           <if condition="ISNULL(USERID)">
              <set name="USERID" expr="SESSIONS.USRID"/>    
           </if>
           
           <set name="merno"       expr="merchantId"/>
           <set name="CUST_ID"     expr="USERID"/>
           <set name="prdOrdNo"    expr="orderId"/>
           <set name="orderAmount" expr="orderAmount"/>
           
           <!--检查金额格式-->
           <if condition="NOT(ISNULL(orderAmount))">
              <if condition="NOT(ISNUMBER(orderAmount))">
                 <set name="RspCod"    value="08044"/>
                 <set name="RspMsg"    value="金额格式错误"/>
                 <return/>
              </if>
           </if>
           <else>
              <set name="RspCod"    value="08045"/>
              <set name="RspMsg"    value="订单金额不能为空！"/>
              <return/>
           </else>
           
           <!-- 验签处理 -->
           <!--适用于CFCA及自建CA两种情况-->
           <if condition="IS_EQUAL_STRING(signType,'CFCA')">  <!--验签方式 CFCA -->
             <!--set name="INSTR"  expr="STRCAT('merchantId=',merchantId,'&amp;prodCode=',prodCode,'&amp;orderId=',orderId,'&amp;orderAmount=',orderAmount,'&amp;orderDate=',orderDate,'&amp;bizType=',bizType,'&amp;retUrl=',retUrl,'&amp;returnUrl=',returnUrl,'&amp;prdName=',TOUPPER(STR2HEX(prdName)),'&amp;prdDesc=',TOUPPER(STR2HEX(prdDesc)),'&amp;signType=',signType)"/-->
             <set name="INSTR"  expr="STRCAT('merchantId=',merchantId,'&amp;orderId=',orderId,'&amp;orderAmount=',orderAmount,'&amp;signType=',signType)"/>
             <!--CACA验签-->
             <do func="CFCASignVer">
                <para name="sourceData"        expr="INSTR" />
                <para name="signData"          expr="SIGNATURE" />
             </do>
             <if condition="#RetCod!=0">
                <set name="RspCod"    value="08039"/>
                <set name="RspMsg"    value="验签失败"/>
                <return/>
             </if>
           </if>
           <elseif condition="IS_EQUAL_STRING(signType,'ZJCA')">  <!--验签方式 自建CA  ZJCA-->
               <set name="CFCAPWD"         value="12345678"/>
               <!--自建CA验签-->
               <do func="HkCaVerifyn">
                 <para name="sourceData"   expr="inMsg" />
                 <para name="signData"     expr="REPALLSTR(signature,' ','+')" />
                 <para name="pfxPath"      expr="STRCAT(GETCURAPPHOME(),'/key/',merchantId,'.pfx')" />
                 <para name="pfxPwd"       expr="CFCAPWD" />
               </do>
               <if condition="#RetCod!=0">
                  <set name="RspCod"    value="08039"/>
                  <set name="RspMsg"    value="验签失败"/>
                  <return/>
               </if>
               <delete name="CFCAPWD"/>
           </elseif>
           <else>
              <set name="RspCod"    value="09999"/>
              <set name="RspMsg"    value="无此验签方式！"/>
              <return/>
           </else>
           <delete name="SIGNATURE"/>
           
            <!-- 查询商户信息 -->
            <do func="ReadRecord" error="IGNORE">
              <para name="SqlCmd" sql="QryMerInf" />
            </do>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="08039"/>
               <set name="RspMsg"    value="商户信息不存在"/>
               <return/>
            </if>
            <if condition="IS_NOEQUAL_STRING(CUST_STATUS,'0')">
               <set name="RspCod"    value="08040"/>
               <set name="RspMsg"    value="商户状态不正常"/>
               <return/>
            </if>
            
         <!--查询商品订单信息-->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="queryPayinf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="商户订单不存在"/>
            <return/>
         </if>
         
         <!-- 检测商品订单状态 -->
         <if condition="IS_NOEQUAL_STRING(OrdStatus,'12')">
            <set name="RspCod"    value="06007"/>
            <set name="RspMsg"    value="订单支付不正确！"/>
            <return/>
         </if>
         
         <!--订单类型不正确，不能确认-->
         <if condition="IS_NOEQUAL_STRING(prdOrdType,'2')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01033"/>
            <set name="RspMsg"    value="该订单不是消费订单，不能确认付款！"/>
            <return/>
         </if>
         
          <!-- 查询用户信息 -->
          <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryCusInf" />
          </do>
          <if condition="#RetCod!=0">
             <set name="RspCod"    value="08039"/>
             <set name="RspMsg"    value="用户信息不存在"/>
             <return/>
          </if>
          <if condition="IS_NOEQUAL_STRING(CUST_STATUS,'0')">
             <set name="RspCod"    value="08040"/>
             <set name="RspMsg"    value="用户状态不正常"/>
             <return/>
          </if>
          
         <!--查询支付订单信息-->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="SelPayInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="08001"/>
            <set name="RspMsg"    value="该支付订单信息不存在"/>
            <return/>
         </if>
         
         <!-- 检测支付订单状态 -->
         <if condition="IS_NOEQUAL_STRING(OrdStatus,'01')">
            <set name="RspCod"    value="06007"/>
            <set name="RspMsg"    value="订单支付不正确！"/>
            <return/>
         </if>
         
        <!--退款金额检查-->
        <if condition="DOUBLECMP(ordamt,4,orderAmount)">
           <set name="RspCod"    value="08008"/>
           <set name="RspMsg"    value="确认金额不一致！"/>
           <return/>
        </if>
        
         <set name="txAmtSub"     expr="txAmt" />  <!--支付金额--> 
         <set name="txAmtnet"     expr="SUB(txAmtSub,fee)" />
         <!--扣除中间账户的金额-->
         <if condition="OR(IS_EQUAL_STRING(payType,'00'),IS_EQUAL_STRING(payType,'03'),IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(payType,'01'))"> 
            <!--进行虚拟账户扣款-->
            <set name="MER_ACC_TYP"  value="02"/>           <!-- 商户结算账户 -->
            <set name="payacno"      expr="USRPAYACNO"/>
            <set name="pltMidPar"    expr="STRCAT('99999900000001','/','04','/','-','/','CNY','/',txAmtSub,'/','N','/')"/>   <!--平台担保账户记账参数-->
            <if condition="OR(IS_EQUAL_STRING(FEE,'0'),ISNULL(FEE))">       <!--无手续费--> 
              <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/','CNY','/',txAmtSub,'/','Y','/')"/>       <!--商户记账参数-->
              <set name="PARAMS"     expr="STRCAT(pltMidPar,',',merPar)"/>
            </if>
            <else>                                                          <!--有手续费-->    
              <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/','CNY','/',txAmtnet,'/','Y','/')"/>       <!--商户记账参数-->
              <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
              <set name="PARAMS"     expr="STRCAT(pltMidPar,',',merPar,',',feePar)"/>
            </else>
            
            <!--记账处理-->
            <set name="TXN_TYP"      value="2"/>              <!--用途  2消费-->
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="07007"/>
               <set name="RspMsg"    value="支付失败"/>
               <return/>
            </if>
            
            <set name="netRecAmt"      expr="SUB(TXAMT,FEE)"/>
            <set name="txnComAmt"      expr="FEE"/>
            <set name="ActDat"         expr="GETDATETIME()"/>
            <set name="OrdStatus"      value="01"/>
            
            <!--更新支付订单表-->
            <do func="ExecSql" error="IGNORE">  
               <para name="SqlCmd" sql="UpdPay"/>
            </do>
            <if condition="#RetCod==2">
               <set name="RspCod"    value="01003"/>
               <set name="RspMsg"    value="无符合条件记录"/>
               <return/>
            </if>
            <elseif condition="#RetCod!=0">
               <set name="RspCod"    value="06003"/>
               <set name="RspMsg"    value="更新订单信息错误"/>
               <return/>
            </elseif>
            <!--更新商品订单表--> 
            <do func="ExecSql" error="IGNORE">  
               <para name="SqlCmd" sql="UpdPrd"/>
            </do>
            <if condition="#RetCod==2">
               <set name="RspCod"    value="01003"/>
               <set name="RspMsg"    value="无符合条件记录"/>
               <return/>
            </if>
            <elseif condition="#RetCod!=0">
               <set name="RspCod"    value="06003"/>
               <set name="RspMsg"    value="更新订单信息错误"/>
               <return/>
            </elseif>
            
             <set name="RspCod"    value="00000"/>
             <set name="RspMsg"    value="交易成功！"/>
         </if>
         <else>
            <set name="RspCod"    value="06007"/>
            <set name="RspMsg"    value="无此支付方式！"/>
            <return/>
         </else>
         
      </process>
   </transaction>
   
   <transaction code="564104" desc="商品订单明细查询">
      <sql name="QryOrdInf"><!-- 查询商品订单信息-->
         SELECT prdOrdNo,ordsource,bizType,orderTime,OrdStatus,notifyUrl,PRDORDTYPE,
         prdordno,ordamt,prdName,prdDesc,cust_id  
         FROM StpPrdInf WHERE prdOrdNo=#{prdOrdNo} AND merNo=#{merchantId}
      </sql>
      <sql name="QryOrdMul"><!-- 查询商品订单列表信息-->
         SELECT prdOrdNo,prdOrdType,bizType,orderTime,OrdStatus,notifyUrl,prdName,
         prdDesc,ordamt,cust_id
         FROM StpPrdInf WHERE merNo=#{merchantId} ${OrdStatus1} ${Qry1} ${prdOrdNo1} 
      </sql>
      <sql name="QryPayOrd"> <!--查询支付订单信息 -->
        select * from stppayinf where PRDORDNO=#{prdOrdNo} and 
        ACTDAT = (select max(ACTDAT)  from stppayinf where PRDORDNO=#{prdOrdNo})
      </sql>
      <sql name="UpdPay"> <!-- 更新支付订单表 -->
        update stppayinf set OrdStatus=#{OrdStatus},netRecAmt=#{ordamt}
        ,CUST_ID=#{CUST_ID}
        ,BNKMERNO=#{upopMerNo}
        where payOrdNo=#{payOrdNo}
      </sql>
      <sql name="UpdPrd"> <!-- 更新商品订单表 -->
        update stpprdinf set OrdStatus=#{OrdStatus},CUST_ID=#{CUST_ID} where prdOrdNo=#{prdOrdNo}
      </sql>
      <process>
           <!--检查用户登录平台是否正确-->
           <if condition="AND(IS_NOEQUAL_STRING(SysCod,'0001'),IS_NOEQUAL_STRING(SysCod,'2201'))">
              <set name="MsgTyp"    value="E"/>
              <set name="RspCod"    value="01001"/>
              <set name="RspMsg"    value="用户登录平台不正确"/>
              <return/>
           </if>
           
           <set name="merNo"         expr="merchantId"/> 
           <set name="prdOrdNo"      expr="orderId"/> 
           <set name="signature"     expr="signature"/> 
           
           <set name="prdOrdNoTmp"      expr="SUBSTR(prdOrdNo,1,3)"/>
           <if condition="IS_EQUAL_STRING(prdOrdNoTmp,'SWT')">
           	  <set name="CUST_ID"    value="00000000000394"/>
           </if>
           
           <!--检查用户登录平台是否正确-->
           <quote name="ChkNoCusOpen"/>
          
           <!-- 验签处理 -->
           <!--适用于CFCA及自建CA两种情况-->
           <if condition="IS_EQUAL_STRING(signType,'CFCA')">  <!--验签方式 CFCA -->
              <!--set name="INSTR"  expr="STRCAT('merchantId=',merchantId,'&amp;prodCode=',prodCode,'&amp;orderId=',orderId,'&amp;orderAmount=',orderAmount,'&amp;orderDate=',orderDate,'&amp;bizType=',bizType,'&amp;retUrl=',retUrl,'&amp;returnUrl=',returnUrl,'&amp;prdName=',TOUPPER(STR2HEX(prdName)),'&amp;prdDesc=',TOUPPER(STR2HEX(prdDesc)),'&amp;signType=',signType)"/-->
              <set name="INSTR"  expr="STRCAT('merchantId=',merchantId,'&amp;queryType=',queryType,'&amp;orderId=',orderId,'&amp;signType=',signType)"/>
              <!--CACA验签-->
              <do func="CFCASignVer">
                 <para name="sourceData"        expr="INSTR" />
                 <para name="signData"          expr="SIGNATURE" />
              </do>
              <if condition="#RetCod!=0">
                 <set name="RspCod"    value="08039"/>
                 <set name="RspMsg"    value="验签失败"/>
                 <return/>
              </if>
           </if>
           <elseif condition="IS_EQUAL_STRING(signType,'ZJCA')">  <!--验签方式 自建CA  ZJCA-->
               <set name="CFCAPWD"         value="12345678"/>
               <!--自建CA验签-->
               <do func="HkCaVerifyn">
                 <para name="sourceData"   expr="inMsg" />
                 <para name="signData"     expr="REPALLSTR(signature,' ','+')" />
                 <para name="pfxPath"      expr="STRCAT(GETCURAPPHOME(),'/key/',merchantId,'.pfx')" />
                 <para name="pfxPwd"       expr="CFCAPWD" />
               </do>
               <if condition="#RetCod!=0">
                  <set name="RspCod"    value="08039"/>
                  <set name="RspMsg"    value="验签失败"/>
                  <return/>
               </if>
               <delete name="CFCAPWD"/>
           </elseif>
           <else>
              <set name="RspCod"    value="09999"/>
              <set name="RspMsg"    value="无此验签方式！"/>
              <return/>
           </else>
           <delete name="SIGNATURE"/>
           
           <set name="queryType"     value="1"/>
           <if condition="IS_EQUAL_STRING(queryType,'1')">  <!-- 单笔查询 -->
              <set name="PrdOrdNo"   expr="orderId"/>
              <do func="ReadRecord"       error="IGNORE">
                 <para name="SqlCmd"       sql="QryOrdInf" />
              </do>
              <if condition="#RetCod==2">
                 <set name="RspCod"    value="08047"/>
                 <set name="RspMsg"    value="无符合条件记录"/>
                 <return/>
              </if>
              <elseif condition="#RetCod!=0">
                 <set name="RspCod"    value="09999"/>
                 <set name="RspMsg"    value="系统错误"/>
                 <return/>
              </elseif>
              
              <if condition="IS_EQUAL_STRING(OrdStatus,'00')">
              	 <set name="BANKCODE"    value="01010000"/>
                 <do func="ReadRecord" error="IGNORE">
                    <para name="SqlCmd"   sql="QryPayOrd"/>
                 </do>
                 <if condition="#RetCod!=0">
                    <set name="MsgTyp"    value="E"/>
                    <set name="RspCod"    value="08001"/>
                    <set name="RspMsg"    value="该支付订单信息不存在"/>
                    <set name="DWZ_STATUS_CODE"   value="300"/>
                    <set name="DWZ_RSP_MSG"       expr="RspMsg"/>
                    <return/>
                 </if>
					       <!--取银联B2C产品_交易状态查询交易请求配置-->
					       
					       <set name="ConfigName"       value="UPOPB2cQueryOrdStatus"/>
					       <quote name="ReadXmlCfg"/>
					       <if condition="IS_EQUAL_STRING(PRDORDTYPE,'0')"><!-- 消费 -->
					          <if condition="IS_EQUAL_STRING(ordsource,'0')"><!-- 0 PC端  1 移动端 -->
                       <set name="ConfigName"       value="UpopCfgMerIdB2C"/>
                    </if>
                    <elseif condition="IS_EQUAL_STRING(ordsource,'1')">
                       <set name="ConfigName"       value="UpopCfgMerIdWap"/>
                    </elseif>
                 </if>
                 <elseif condition="IS_EQUAL_STRING(PRDORDTYPE,'3')"><!-- 充值 -->
					          <if condition="IS_EQUAL_STRING(ordsource,'0')">
                       <set name="ConfigName"       value="UpopCfgMerIdB2CTopUP"/>
                    </if>
                    <elseif condition="IS_EQUAL_STRING(ordsource,'1')">
                       <set name="ConfigName"       value="UpopCfgMerIdWapTopUP"/>
                    </elseif>
                 </elseif>
              
                 <quote name="ReadXmlCfg"/>
                 <!--银联个人网银订单查询-->
                 <do func="Form_6_5_Query" error="IGNORE">
                    <para name="version"      expr="B2cQuery_version"/>            <!--版本号-->          
					        	<para name="encoding"     expr="B2cQuery_encoding"/>            <!--编码方式-->        
					        	<para name="signMethod"   expr="B2cQuery_signMethod"/>            <!--签名方法01-->      
					        	<para name="txnType"      expr="B2cQuery_txnType"/>            <!--交易类型00-->      
					        	<para name="txnSubType"   expr="B2cQuery_txnSubType"/>            <!--交易子类00-->      
					        	<para name="bizType"      expr="B2cQuery_bizType"/>            <!--产品类型000201-->  
					        	<para name="accessType"   expr="B2cQuery_accessType"/>            <!--接入类型0-->       
					        	<para name="merId"        expr="upopMerNo"/>            <!--商户代码-->
					        	<para name="orderId"      expr="payOrdNo"/>										<!--支付订单号-->
                    <para name="txnTime"      expr="ACTDAT"/>                    <!--交易时间-->
                    <para name="queryId"      value=""/>
                 </do>
                 <if condition="#RetCod!=0">  
                 	  <set name="origRespCode" value="01"/>
                 </if>
                 <else>
                    <set name="origRespCode" value="00"/>
                 </else>
                 
                 <set name="origRespCode" expr="origRespCode"/><!--订单处理状态-->
                 <if condition="IS_EQUAL_STRING(origRespCode,'00')">
                    <set name="OrdStatus" value="01"/>   <!--成功-->
                                
                    <!--更新支付订单表-->
                    <do func="ExecSql" error="IGNORE">  
                       <para name="SqlCmd" sql="UpdPay"/>
                    </do>
                    <if condition="#RetCod!=0">
                       <set name="RspCod"    value="06003"/>
                       <set name="RspMsg"    value="更新订单信息错误"/>
                    </if>
                    <!--更新商品订单表--> 
                    <do func="ExecSql" error="IGNORE">  
                       <para name="SqlCmd" sql="UpdPrd"/>
                    </do>
                    <if condition="#RetCod!=0">
                       <set name="RspCod"    value="06003"/>
                       <set name="RspMsg"    value="更新订单信息错误"/>
                    </if>
                 </if>
                 <else>
                     <set name="OrdStatus" value="11"/>   <!--失败-->
                 </else>
              </if>
           </if>
           <else><!-- 订单浏览 -->
              <!--订单类型转换-->  
              <if condition="NOT(ISNULL(prdOrdStatus))">
                 <if condition="INTCMP(prdOrdStatus,3,0)">       <!--等待处理-->
                    <set name="OrdStatus"    value="00"/>
                 </if>
                 <elseif condition="INTCMP(prdOrdStatus,3,1)">   <!--处理成功-->
                    <set name="OrdStatus"    value="01"/>
                 </elseif>
                 <elseif condition="INTCMP(prdOrdStatus,3,2)">   <!--处理失败-->
                    <set name="OrdStatus"    value="02"/>
                 </elseif>
                 <elseif condition="INTCMP(prdOrdStatus,3,3)">   <!--等待退款-->
                    <set name="OrdStatus"    value="04"/>
                 </elseif>
                 <elseif condition="INTCMP(prdOrdStatus,3,4)">   <!--退款成功-->
                    <set name="OrdStatus"    value="05"/>
                 </elseif>
                 <elseif condition="INTCMP(prdOrdStatus,3,5)">   <!--退款失败-->
                    <set name="OrdStatus"    value="06"/>
                 </elseif>
                 <elseif condition="INTCMP(prdOrdStatus,3,7)">
                    <set name="OrdStatus"    value=""/>
                 </elseif>
                 <else>
                    <set name="MsgTyp"    value="E"/>
                    <set name="RspCod"    value="08048"/>
                    <set name="RspMsg"    value="无此订单状态"/>
                    <return/>
                 </else> 
              </if>
              
              <if condition="ISNULL(prdOrdNo)">
                 <set name="prdOrdNo1"    value=""/>
              </if>
              <else>
                 <set name="prdOrdNo1"    expr="STRCAT('and prdOrdNo=\'',prdOrdNo,'\'')"/> 
              </else>
              
              <if condition="ISNULL(OrdStatus)">
                 <set name="OrdStatus1"    value=""/>
              </if>
              <else>
                 <set name="OrdStatus1"    expr="STRCAT('and OrdStatus=\'',OrdStatus,'\'')"/> 
              </else>
              
              <if condition="AND(ISNULL(begin_date),ISNULL(end_date))">
                <set name="Qry1"    value=""/>
              </if>
              <elseif condition="OR(ISNULL(begin_date),ISNULL(end_date))">
                 <set name="RspCod"    value="08049"/>
                 <set name="RspMsg"    value="起止日期不能为空"/>
                 <return/>
              </elseif>
              <else>
                 <set name="begin_date" expr="FMTDATE(begin_date,4,0)"/>
                 <set name="end_date"   expr="FMTDATE(end_date,4,0)"/>
                 <set name="Qry1"       expr="STRCAT('and orderTime &gt;=\'',begin_date,'\' and orderTime &lt;=\'',end_date,'\'')"/> 
                 <set name="begin_date" expr="FMTDATE(begin_date,0,4)"/>
                 <set name="end_date"   expr="FMTDATE(end_date,0,4)"/>
              </else>
              <do func="QueryInGroup">
                <para name="SqlCmd"      sql="QryOrdMul" />
                <para name="RecordName"  value="PrdOrderInfoDto" />
              </do>
              <if condition="#RetCod==2">
                 <set name="RspCod"    value="08047"/>
                 <set name="RspMsg"    value="无符合条件记录"/>
                 <return/>
              </if>
              <elseif condition="#RetCod!=0">
                 <set name="RspCod"    value="09999"/>
                 <set name="RspMsg"    value="系统错误"/>
                 <return/>
              </elseif>
                 
           </else>
            
           <set name="MsgTyp"    value="N"/>
           <set name="RspCod"    value="00000"/>
           <set name="RspMsg"    value="交易成功"/> 
      </process>
   </transaction>
   
   <transaction code="564105" desc="提现接口">
      <sql name="QryMerInf"><!-- 查询商户信息 -->
         SELECT a.CUST_ID MerId, b.CUST_NAME,a.aut_sts,a.company_brief ,b.CUST_STATUS
           FROM StpMerInf a,StpCusInf b 
          WHERE a.CUST_ID = b.CUST_ID AND a.CUST_ID=#{merchantId}
      </sql>
      <sql name="SelMerStatus">  <!--查询客户账户状态 -->
        select a.AC_STATUS,a.AC_TYPE,PASSWORD,nvl(froz_balance,0) froz_balance,
        to_number(nvl(cash_ac_bal,0)-nvl(froz_balance,0)) cashacbal,a.PAY_AC_NO merpayacno
        from ARP_AC_PROFILE a,ARP_AC_CUST_REL b where a.PAY_AC_NO=b.PAY_AC_NO 
        and b.cust_id =#{merchantId} and a.AC_TYPE='01'
      </sql>
      <sql name="QryOrdInf"><!-- 查询提现订单信息-->
         SELECT CasOrdNo FROM StpcasInf WHERE CasOrdNo=#{CasOrdNo} 
      </sql>
       <sql name="UpdStatus">
        update stpcasinf set  ordstatus=#{ordstatus},SucDat=#{SucDat}  where  casOrdNo=#{casOrdNo}
       </sql>
       <sql name="UpdCasStatus">
         UPDATE STPCASINF SET SUCDAT=#{SucDat},ORDSTATUS=#{ORDSTATUS},BANKERROR=#{ERROR} WHERE CASORDNO=#{CASORDNO}
      </sql>
      <sql name="SelUBANKNO">
        SELECT UBANK_NO,BankNam FROM StpBnkCde WHERE BankCode=#{BankCode}
      </sql>
      <sql name="UpdBnkPay"><!--更新银行代付信息-->
         REQUEST_SN = #{REQUEST_SN}
      </sql>
      <sql name="SelCasInf">
        SELECT CUST_ID,CUST_ID||'01' as PAY_AC_NO,ORDSTATUS,NVL(TXAMT,0) AS TXAMT,NVL(FEE,0) AS FEE,NVL(NETRECAMT,0) AS NETRECAMT,
        BANKCODE, BANKPAYACNO as ACC_NO2, BANKPAYUSERNM as RECV_ACC_NAME, ActDat FROM STPCASINF WHERE CASORDNO=#{CASORDNO}
      </sql>
      <sql name="SelFrzInf">
        select PAY_AC_NO,FROZ_AMT,BIZ_CODE,STATUS,FROZ_NO from ARP_AC_FORZZ_DETAILS where BIZ_CODE=#{CASORDNO} and STATUS='01'
      </sql>
      <sql name="UpdFrezInf"><!-- 更新冻结信息-->
         UPDATE ARP_AC_FORZZ_DETAILS SET STATUS='00',LST_UPT_DATE=#{LST_UPT_DATE},LST_UPT_TIME=#{LST_UPT_TIME} WHERE FROZ_NO=#{FROZ_NO}
      </sql>
      <process>
         <!--检查用户登录平台是否正确-->
           <if condition="AND(IS_NOEQUAL_STRING(SysCod,'0001'),IS_NOEQUAL_STRING(SysCod,'2201'))">
              <set name="MsgTyp"    value="E"/>
              <set name="RspCod"    value="01001"/>
              <set name="RspMsg"    value="用户登录平台不正确"/>
              <return/>
           </if>
           
           <set name="merNo"         expr="merchantId"/> 
           <set name="CASORDNO"      expr="orderId"/>
           <set name="orderTime"     expr="orderDate"/>
           <set name="txAmt"         expr="orderAmount"/> 
           <set name="bankcardno"    expr="bankPayAcNo"/> <!--收款人银行卡号-->
           <set name="CARD_NAME"     expr="bankPayUserNm"/> <!--收款人户名-->
           <set name="signature"     expr="signature"/> 
           
           <!--检查用户登录平台是否正确-->
           <quote name="ChkNoCusOpen"/>
           <!--quote name="ChkNoCusMer"/-->
           <!-- 验签处理 -->
           <!--适用于CFCA及自建CA两种情况-->
           <if condition="IS_EQUAL_STRING(signType,'CFCA')">  <!--验签方式 CFCA -->
              <!--set name="INSTR"  expr="STRCAT('merchantId=',merchantId,'&amp;prodCode=',prodCode,'&amp;orderId=',orderId,'&amp;orderAmount=',orderAmount,'&amp;orderDate=',orderDate,'&amp;bizType=',bizType,'&amp;retUrl=',retUrl,'&amp;returnUrl=',returnUrl,'&amp;prdName=',TOUPPER(STR2HEX(prdName)),'&amp;prdDesc=',TOUPPER(STR2HEX(prdDesc)),'&amp;signType=',signType)"/-->
              <set name="INSTR"  expr="STRCAT('merchantId=',merchantId,'&amp;orderId=',orderId,'&amp;orderAmount=',orderAmount,'&amp;orderDate=',orderDate,'&amp;bankPayAcNo=',bankPayAcNo,'&amp;bankPayUserNm=',TOUPPER(STR2HEX(bankPayUserNm)),'&amp;signType=',signType)"/>
              <!--CACA验签-->
              <do func="CFCASignVer">
                 <para name="sourceData"        expr="INSTR" />
                 <para name="signData"          expr="SIGNATURE" />
              </do>
              <if condition="#RetCod!=0">
              	 <set name="MsgTyp"    value="E"/>
                 <set name="RspCod"    value="08039"/>
                 <set name="RspMsg"    value="验签失败"/>
                 <return/>
              </if>
           </if>
           <elseif condition="IS_EQUAL_STRING(signType,'ZJCA')">  <!--验签方式 自建CA  ZJCA-->
               <set name="CFCAPWD"         value="12345678"/>
               <!--自建CA验签-->
               <do func="HkCaVerifyn">
                 <para name="sourceData"   expr="inMsg" />
                 <para name="signData"     expr="REPALLSTR(signature,' ','+')" />
                 <para name="pfxPath"      expr="STRCAT(GETCURAPPHOME(),'/key/',merchantId,'.pfx')" />
                 <para name="pfxPwd"       expr="CFCAPWD" />
               </do>
               <if condition="#RetCod!=0">
               	  <set name="MsgTyp"    value="E"/>
                  <set name="RspCod"    value="08039"/>
                  <set name="RspMsg"    value="验签失败"/>
                  <return/>
               </if>
               <delete name="CFCAPWD"/>
           </elseif>
           <else>
           	  <set name="MsgTyp"    value="E"/>
              <set name="RspCod"    value="09999"/>
              <set name="RspMsg"    value="无此验签方式！"/>
              <return/>
           </else>
           <delete name="SIGNATURE"/>
           
          <!--检查金额格式-->
          <if condition="NOT(ISNULL(orderAmount))">
             <if condition="NOT(ISNUMBER(orderAmount))">
             	  <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="08044"/>
                <set name="RspMsg"    value="金额格式错误"/>
                <return/>
             </if>
          </if>
          <else>
          	 <set name="MsgTyp"    value="E"/>
             <set name="RspCod"    value="08045"/>
             <set name="RspMsg"    value="退款金额不能为空！"/>
             <return/>
          </else>
          
         <if condition="NOT(ISNUMBER(orderDate))">
         	   <set name="MsgTyp"    value="E"/>
             <set name="RspCod"    value="08044"/>
             <set name="RspMsg"    value="日期格式错误"/>
             <return/>
         </if>
         
         <!-- 查询商户信息 -->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="QryMerInf" />
         </do>
         <if condition="#RetCod!=0">
         	  <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="08039"/>
            <set name="RspMsg"    value="商户信息不存在"/>
            <return/>
         </if>
         <if condition="IS_NOEQUAL_STRING(CUST_STATUS,'0')">
         	  <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="08040"/>
            <set name="RspMsg"    value="商户状态不正常"/>
            <return/>
         </if>
         <!-- 查询商户帐号信息 -->
         <do func="ReadRecord"       error="IGNORE">
            <para name="SqlCmd"       sql="SelMerStatus"/>
         </do>
         <set name="AC_STATUS"       expr="AC_STATUS"/>
         <if condition="IS_EQUAL_STRING(AC_STATUS,'2')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="商户账户已经被冻结，不能申请提现！"/>
            <return/>
         </if>
         <if condition="DOUBLECMP(cashacbal,1,orderAmount)">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="商户账户余额不足，不能申请提现！"/>
            <return/>
         </if>
         
         <do func="Lock">
            <para name="RecKey"     expr="CasOrdNo" />
            <para name="AutoUnLock" value="yes" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"      value="08045"/>
            <set name="RspMsg"      value="正在处理中,请勿重复请求!"/><!-- 加锁失败的原因：请求频率过高 -->
            <return/>
         </if>
         
         <!--检查提现订单是否存在-->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="QryOrdInf" />
         </do>
         <if condition="#RetCod==2">       <!-- 提现订单不存在 初次支付-->
         </if>
         <elseif condition="#RetCod==0">   <!-- 提现订单存在 退出-->
         	  <set name="MsgTyp"    value="E"/>
            <set name="morePay"   value="1"/>
            <set name="RspCod"    value="08046"/>
            <set name="RspMsg"    value="订单号已存在"/>
            <return/>
         </elseif>
         <else>
         	  <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </else>
         
         <!--银行卡号-->
         <do func="GetCrdInfo">
             <para name="CrdNo" expr="bankcardno" />
         </do>
         <if condition="#RetCod!=0">
            <set name="CPSCod" value="99" />
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod" value="09999"/>
            <set name="RspMsg" value="获取卡bin信息失败" />
            <return />
         </if>
         <set name="ISSBANKNAME"  expr="ISSNAM" />
         <set name="BANKCARDTYPE" expr="DCFLAG" /><!-- 卡类型 01：借记卡 02：信用卡 -->
         <set name="CARD_BANK"    expr="ISSNO" />
          
         <if condition="IS_NOEQUAL_STRING(BANKCARDTYPE,'01')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="提现银行卡号不是借记卡，不能提现！"/>
            <return/>
         </if>
         
         <!--收款卡号加密-->
         <set name="CARD_NO"      expr="DES_ENCRYPT(bankcardno)"   />
         
         <!--限额检查  start --> 
         <!--set name="Amt"           expr="txAmt"/--> <!--交易金额-->
         <!--set name="PAY_TYPE"      value="04"/-->   <!--支付方式 01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
         <!--set name="TRAN_TYPE"     value="7"/-->    <!--交易类型 0 其他 1 充值 2消费 3撤销 4预授权完成 5预授权完成撤销 6转账(虚拟帐号间) 7提现 8退款-->
         <!--set name="cust_type"     value="1"/-->    <!--效验客户类型(1用户 2 商户 0 两者)-->
         <!--set name="User_code"     expr="merchantId"/--><!--用户编号-->
         <!--set name="Time"          expr="GETDATETIME()"/-->
         <!--set name="DATE"          expr="GETDATE()"/-->
         <!--set name="ServiceCode"   value="680518"/-->  
         <!--quote name="chkLimAmt"/-->
         <!--限额检查   end--> 
         
         <set name="bankCode"      expr="CARD_BANK"/>
         <set name="bankPayAcNo"   expr="CARD_NO"/>
         <set name="bankPayUserNm" expr="CARD_NAME"/>
         <set name="CUST_ID"       expr="merchantId"/>
         
         <set name="CasOrdNo"      expr="orderid"/> 
         <set name="ActDat"        expr="orderTime"/>
         <set name="OrdStatus"     value="00"/>
         <set name="txCcy"         value="CNY"/> 
         <set name="txAmt"         expr="txAmt"/>
         <!-- 后续计算提现手续费在此处添加 -->
         <set name="fee"           value="0"/>
         <set name="netRecAmt"     expr="txAmt"/>
         <set name="SucDat"        value=""/>
         <!--登记提现订单信息-->  
         <do func="InsertRecord" error="IGNORE">
            <para name="TblNam"  value="StpCasInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if>
         
         <!--冻结用户提现金额 -->  
         <set name="PAY_AC_NO"       expr="merpayacno"/>
         <quote name="frezzAmt"/>
         <set name="BIZ_CODE"        expr="CasOrdNo"/>
         <set name="FROZ_REASON"     value="提现"/>
         <quote name="InsFrozInf"/>
         
         <do func="CommitWork"/>
          
          <!--线上提现，则接入银行提现接口代码-->
          <set name="bankcode"      expr="bankcode"/><!--银行编码-->
          <set name="bankpayusernm" expr="bankpayusernm"/><!--收款人姓名-->
          <set name="bankpayacno"   expr="bankcardno"/><!--收款卡号-->
          
          <!--线上提现，则接入银行提现接口代码-->
          <!-- 查询订单信息 -->
         <do func="ReadRecord">
           <para name="SqlCmd" sql="SelCasInf" />
         </do>
         <if condition="#RetCod==2">
           <set name="RSPCOD" value="02040"/>
           <set name="RspMsg" value="该提现订单不存在"/>
           <return/>
         </if>
         <elseif condition="#RetCod!=0">
         	 <set name="MsgTyp"    value="E"/>
           <set name="RSPCOD" value="02040"/>
           <set name="RspMsg" value="获取提现订单信息失败"/>
           <return/>
         </elseif>
         
         <!--获取序号 -->
         <do func="GetSeqNo"  error="IGNORE">
            <para name="TblNam"   value="stpseqrec"/>
            <para name="KeyNam"   value="KeyNam"/>
            <para name="KeyVal"   expr="STRCAT('StpBnkPay','REQUEST_SN')"/>
            <para name="SeqNam"   value="KeyVal"/>
            <para name="Len"      value="8"/>
            <para name="Circle"   value="1"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09001"/>
            <set name="RspMsg"    value="获取序号错误"/>
            <return/>
         </if>
         <set name="REQUEST_SN"   expr="STRCAT(SUBSTR(ActDat,0,8),KeyVal)"/>
         
         <!--读取xml参数-->
         <set name="ConfigName"   value="StpBnkPayCfg"/>
         <quote name="ReadXmlCfg"/>
         <set name="USEOF"    value="商户代发"/>
          
         <set name="TXAMT"              expr="TXAMT"/>
         <set name="PayTyp"             value="00"/><!--代发类型 00-用户提现代发 01-商户结算代发-->
         <set name="PaySts"             value="00"/><!--00:等待处理 01:交易成功 02:交易失败-->
         
         <!--登记银行代付信息-->
         <do func="InsertRecord" error="IGNORE">
            <para name="TblNam"   value="StpBnkPay" />
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if>
         
         <set name="AMOUNT"     expr="AMTADDDOT(TXAMT)"/> <!--代发金额-->
         <if condition="IS_EQUAL_STRING(BANKCODE, '01050000')"><!--建行-->
            <set name="ThdCde"              value="6W8010"/>
            <set name="UBANK_NO"            value="56888"/>
            <set name="RECV_EXCHANGENO"     value="56888"/>
            <set name="RECV_OPENACC_DEPT"   value="广东省分行"/>
            <set name="RECV_COUNTERNO"      value="440000000"/>
         </if>
         <else>
            <set name="ThdCde"    value="6W8060"/>
            <do func="ReadRecord"><!--获取超级网银联行号-->
              <para name="SqlCmd" sql="SelUBANKNO" />
            </do>
            <if condition="#RetCod!=0">
              <set name="RSPCOD" value="02040"/>
              <set name="RspMsg" value="超级网银联行号不存在，请联系系统管理"/>
              <return/>
            </if>
            
            <set name="UBANK_NO"          expr="UBANK_NO"/><!--转入账户联行号-->
            <set name="RECV_OPENACC_DEPT" expr="BankNam"/><!--转入账户开户机构名称-->
         </else>
         
         <!--调用建行企业网银转账-->
         <!--do func="CallThird" error="IGNORE">
            <para name="channel"  value="STHDCCB1"/>
            <para name="code"     expr="ThdCde"/>
         </do-->
         <set name="#RetCod" value="0"/>
         <set name="RETURN_CODE" value="000000"/>
         <if condition="OR(#RetCod==1,#RetCod==10,#RetCod==-1)">
           <if condition="ISNULL(RETURN_CODE)"><!--超时需线下业务人工处理-->
             <set name="PaySts"       value="00"/><!--00:等待处理 01:交易成功 02:交易失败-->
           </if>
           <else>
             <if condition="IS_NOEQUAL_STRING(RETURN_CODE,'000000')">
               <set name="PaySts"     value="02"/><!--00:等待处理 01:交易成功 02:交易失败-->
             </if>
             <else>
               <set name="PaySts"     value="01"/><!--00:等待处理 01:交易成功 02:交易失败-->
             </else>
           </else>
           <set name="RETURN_CODE"  expr="RETURN_CODE"/>
           <set name="RETURN_MSG"   expr="RETURN_MSG"/>
         </if>
         <elseif condition="#RetCod==0">
           <if condition="IS_EQUAL_STRING(RETURN_CODE,'000000')">
             <set name="PaySts"       value="01"/><!--00:等待处理 01:交易成功 02:交易失败-->
           </if>
           <elseif condition="IS_EQUAL_STRING(RETURN_CODE,'WLPT_Err1001')"><!--银企直连客户端与建行通讯超时-->
             <set name="PaySts"       value="00"/><!--00:等待处理 01:交易成功 02:交易失败-->
           </elseif>
           <else>
             <set name="PaySts"       value="02"/><!--00:等待处理 01:交易成功 02:交易失败-->
           </else>
           <set name="RETURN_CODE"   expr="RETURN_CODE"/>
           <set name="RETURN_MSG"    expr="RETURN_MSG"/>
         </elseif>
         <else>
           <set name="PaySts"         value="02"/><!--00:等待处理 01:交易成功 02:交易失败-->
           <set name="RETURN_CODE"    expr="RETURN_CODE"/>
           <set name="RETURN_MSG"     expr="RETURN_MSG"/>
         </else>
         
         <!--更新银行代付信息-->
         <do func="UpdateRecord" error="IGNORE">
            <para name="TblNam"   value="StpBnkPay"/>
            <para name="CndSts"   sql="UpdBnkPay"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if>
         
         <do func="CommitWork"/>
         
         <!-- 提现成功 -->
         <if condition="IS_EQUAL_STRING(PaySts,'01')">
           <set name="SucDat"       expr="GETDATETIME()"/>
           <set name="ORDSTATUS"     value="01"/>
           <quote name="SelFrzInf"/>
           
           <!--将扣除的提现金额解冻 并从账户里扣除-->
           <set name="RCS_PRD_NO"    expr="CASORDNO"/><!--订单号，如果不涉及置空-->
           <set name="PAY_AC_NO"     expr="PAY_AC_NO"/>
           <set name="txAmt"         expr="STRCAT('-',FROZ_AMT)"/>
           <quote name="frezzAmt"/>
           <set name="txAmt"         expr="FROZ_AMT"/>
           <!--更新冻结状态-->
           <quote name="UpdFrezz"/>
           
           <set name="usrPar"       expr="STRCAT(CUST_ID,'/','01','/','-','/','CNY','/',TXAMT,'/','Y','/')"/>  <!--用户记账参数-->  
           <set name="PARAMS"       expr="usrPar"/>
           <!--记账处理-->
           <set name="TXN_TYP"      value="4"/>      <!--用途 4 提现-->
           <set name="prdordno"     expr="CASORDNO"/>
           <quote name="accProcess"/>
           <if condition="#RetCod!=0">
             <set name="RspCod"     value="08042"/>
             <set name="RspMsg"     value="提现失败"/>
             <set name="DWZ_STATUS_CODE" value="300"/>
             <set name="DWZ_RSP_MSG"  expr="RSPMSG"/>
             <do func="RollBackWork"/>
             <return/>
           </if>
           <set name="ERROR"  value=""/>
           <!-- 更新提现订单 -->
           <do func="ExecSql" >
             <para name="SqlCmd" sql="UpdCasStatus"/>
           </do>
           <if condition="#RetCod!=0">
             <set name="RspCod"     value="08042"/>
             <set name="RspMsg"     value="提现失败"/>
             <set name="DWZ_STATUS_CODE" value="300"/>
             <set name="DWZ_RSP_MSG"  expr="RSPMSG"/>
             <do func="RollBackWork"/>
             <return/>
           </if>
           <set name="retCode"   value="0001"/>
         </if>
         <elseif condition="IS_EQUAL_STRING(PaySts,'02')"><!--提现失败-->
           <set name="ORDSTATUS"    value="02"/>
           <set name="SucDat"       value=""/>
           
           <quote name="SelFrzInf"/>
           <!--将提现金额解冻、退回支付账号 -->
           <set name="RCS_PRD_NO"   expr="CASORDNO"/><!--订单号，如果不涉及置空-->
           <set name="PAY_AC_NO"    expr="PAY_AC_NO"/>
           <set name="txAmt"        expr="STRCAT('-',FROZ_AMT)"/>
           <quote name="frezzAmt"/>
           <set name="txAmt"        expr="FROZ_AMT"/>
           <!--更新冻结状态-->
           <quote name="UpdFrezz"/>
           
           <set name="ERROR"  expr="RETURN_MSG"/>
           <!-- 更新提现订单 -->
           <do func="ExecSql" >
             <para name="SqlCmd" sql="UpdCasStatus"/>
           </do>
           <if condition="#RetCod!=0">
             <set name="RspCod"    value="08042"/>
             <set name="RspMsg"    value="提现失败"/>
             <set name="DWZ_STATUS_CODE" value="300"/>
             <set name="DWZ_RSP_MSG"     expr="RSPMSG"/>
             <do func="RollBackWork"/>
             <return/>
           </if>
           <set name="retCode"   value="0002"/>
           <set name="RspMsg"    value="提现失败"/>
           <return/>
         </elseif>
         <else><!--提现超时状态不明，暂不做处理-->
            <set name="RspCod"    value="00000"/>
         	  <set name="retCode"  value="0003"/>
            <set name="RspMsg"   value="提现超时状态不明，请等待"/>
            <return/>
         </else>
          <!--线上提现，则接入银行提现接口代码-->          
           
          <set name="MsgTyp"    value="N"/>
          <set name="RspCod"    value="00000"/>
          <set name="RspMsg"    value="交易成功"/>
      </process>
   </transaction>
   
   <transaction code="564106" desc="建立充值或者消费订单">
      <sql name="QryMerInf"><!-- 查询商户信息 -->
         SELECT a.CUST_ID MerId,a.aut_sts,a.company_brief ,c.CUST_STATUS
           FROM StpMerInf a ,StpCusInf c
          WHERE a.cust_id=c.cust_id and  a.CUST_ID=#{merchantId}
      </sql>
      <sql name="QryMerSigInf"><!-- 查询签约信息-->
         SELECT m.prod_code FROM STPMERSIG m,stpproinf g 
         WHERE m.prod_code =g.prod_code and  g.prod_flag='0' and 
         MER_NO=#{merchantId} and m.prod_code=#{PRODCODE} 
      </sql>
      <sql name="QryOrdInf"><!-- 查询商品订单信息-->
         SELECT prdOrdNo FROM StpPrdInf WHERE prdOrdNo=#{prdOrdNo} AND merNo=#{merchantId}
      </sql>
      <process>
         <!--检查用户登录平台是否正确-->
         <if condition="AND(IS_NOEQUAL_STRING(SysCod,'0001'),IS_NOEQUAL_STRING(SysCod,'2201'),IS_NOEQUAL_STRING(SysCod,'1105'))">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台不正确"/>
            <return/>
         </if>
         
          <set name="merchantId"  expr="merchantId"/>
          <set name="prdOrdNo"    expr="orderId"/>
          <set name="prdOrdType"  expr="prdOrdType"/><!--订单类型  0 消费   3商户充值 -->    
          <set name="ordAmt"      expr="orderAmount"/>
          <set name="orderTime"   expr="orderDate"/>
          <set name="signature"   expr="signature"/>
          <set name="inMsg"       expr="inMsg"/>
          <set name="notifyUrl"   expr="retUrl"/>
          <set name="retUrl"      expr="returnUrl"/>
          <set name="BIZTYPE"     value=""/>
          
          
          <!--检查用户登录平台是否正确-->
          <quote name="ChkNoCusOpen"/>
          <if condition="IS_EQUAL_STRING(prdOrdType,'3')">
             <quote name="ChkNoCusMer"/>
          </if>
         
          <if condition="OR(IS_EQUAL_STRING(prdOrdType,'0'),IS_EQUAL_STRING(prdOrdType,'3'))">
             <set name="RspCod"    value="08224"/>
             <set name="RspMsg"    value="订单类型正确，可以做交易!"/>
          </if>
          <else>
             <set name="RspCod"    value="08124"/>
             <set name="RspMsg"    value="订单类型不正确，不能做交易!"/>
             <return/>
          </else>
          
         <!--检查金额格式-->
         <if condition="NOT(ISNULL(ordAmt))">
            <if condition="NOT(ISNUMBER(ordAmt))">
               <set name="RspCod"    value="08044"/>
               <set name="RspMsg"    value="金额格式错误"/>
               <return/>
            </if>
         </if>
         <else>
            <set name="RspCod"    value="08045"/>
            <set name="RspMsg"    value="订单金额不能为空！"/>
            <return/>
         </else>
         
         <if condition="NOT(ISNUMBER(orderDate))">
               <set name="RspCod"    value="08044"/>
               <set name="RspMsg"    value="日期格式错误"/>
               <return/>
         </if>
         
          <!-- 查询商户信息 -->
          <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryMerInf" />
          </do>
          <if condition="#RetCod!=0">
             <set name="RspCod"    value="08039"/>
             <set name="RspMsg"    value="商户信息不存在"/>
             <return/>
          </if>
          <if condition="IS_NOEQUAL_STRING(CUST_STATUS,'0')">
             <set name="RspCod"    value="08040"/>
             <set name="RspMsg"    value="商户状态不正常"/>
             <return/>
          </if>
          
          <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryMerSigInf" />
          </do>
          <if condition="#RetCod==2">
             <set name="RspCod"    value="08039"/>
             <set name="RspMsg"    value="商户未签约该产品！"/>
             <return/>
          </if>
          <if condition="#RetCod!=0">
             <set name="RspCod"    value="08039"/>
             <set name="RspMsg"    value="商户未签约该产品！"/>
             <return/>
          </if>
          
          <if condition="IS_NOEQUAL_STRING(prod_code,'CP00000003')">
             <set name="RspCod"    value="08024"/>
             <set name="RspMsg"    value="不是网银支付不能做交易!"/>
             <return/>
          </if>
          
         <!-- 验签处理 -->
         <!--适用于CFCA及自建CA两种情况-->
         <if condition="IS_EQUAL_STRING(signType,'CFCA')">  <!--验签方式 CFCA -->
            <!--set name="INSTR"  expr="STRCAT('merchantId=',merchantId,'&amp;prodCode=',prodCode,'&amp;orderId=',orderId,'&amp;orderAmount=',orderAmount,'&amp;orderDate=',orderDate,'&amp;bizType=',bizType,'&amp;retUrl=',retUrl,'&amp;returnUrl=',returnUrl,'&amp;prdName=',TOUPPER(STR2HEX(prdName)),'&amp;prdDesc=',TOUPPER(STR2HEX(prdDesc)),'&amp;signType=',signType)"/-->
            <set name="INSTR"  expr="STRCAT('merchantId=',merchantId,'&amp;prodCode=',prodCode,'&amp;orderId=',orderId,'&amp;orderAmount=',orderAmount,'&amp;orderDate=',orderDate,'&amp;prdOrdType=',prdOrdType,'&amp;retUrl=',notifyUrl,'&amp;returnUrl=',returnUrl,'&amp;prdName=',TOUPPER(STR2HEX(prdName)),'&amp;prdDesc=',TOUPPER(STR2HEX(prdDesc)),'&amp;signType=',signType)"/>
            <!--CACA验签-->
            <do func="CFCASignVer">
               <para name="sourceData"        expr="INSTR" />
               <para name="signData"          expr="SIGNATURE" />
            </do>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="08039"/>
               <set name="RspMsg"    value="验签失败"/>
               <return/>
            </if>
         </if>
         <elseif condition="IS_EQUAL_STRING(signType,'ZJCA')">  <!--验签方式 自建CA  ZJCA-->
             <set name="CFCAPWD"         value="12345678"/>
             <!--自建CA验签-->
             <do func="HkCaVerifyn">
               <para name="sourceData"   expr="inMsg" />
               <para name="signData"     expr="REPALLSTR(signature,' ','+')" />
               <para name="pfxPath"      expr="STRCAT(GETCURAPPHOME(),'/key/',merchantId,'.pfx')" />
               <para name="pfxPwd"       expr="CFCAPWD" />
             </do>
             <if condition="#RetCod!=0">
                <set name="RspCod"    value="08039"/>
                <set name="RspMsg"    value="验签失败"/>
                <return/>
             </if>
             <delete name="CFCAPWD"/>
         </elseif>
         <else>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="无此验签方式！"/>
            <return/>
         </else>
         
         <delete name="SIGNATURE"/>
         <!--检查商品订单是否存在-->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="QryOrdInf" />
         </do>
         <if condition="#RetCod==2">       <!-- 商品订单不存在 初次支付-->
         </if>
         <elseif condition="#RetCod==0">   <!-- 商品订单存在 退出-->
            <set name="morePay"   value="1"/>
            <set name="RspCod"    value="08046"/>
            <set name="RspMsg"    value="订单号已存在"/>
            <return/>
         </elseif>
         <else>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </else>
         
         <set name="orderTime"    expr="orderTime"/>
         <set name="merNo"        expr="merchantId"/>
         <set name="cust_id"      value=""/>
         <set name="ordccy"       value="CNY"/>
         <set name="txncomamt"    value="0"/>
         <set name="OrdStatus"    value="00"/>
         <set name="ordsource"    value="0" />  <!--来源  0 PC端  1 手机端-->    
         
         <!--登记商品订单信息-->
         <do func="InsertRecord" error="IGNORE">
            <para name="TblNam"  value="StpPrdInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if>
         
         <!--取收银台参数配置-->
         <set name="ConfigName"       value="PayCfg"/>
         <quote name="ReadXmlCfg"/>
         <set name="payurl"      expr="STRCAT(onlinepayUrl,'?orderId=',prdordno,'&amp;merNo=',merchantId)"/>
         
         <set name="MsgTyp"    value="N"/>
         <set name="RspCod"    value="00000"/>
         <set name="RspMsg"    value="交易成功"/>
      </process>
   </transaction>
   
   <transaction code="564107" desc="提现订单查询">
      <sql name="QryOrdInf"><!-- 查询提现订单信息-->
         SELECT DECRYPT_DES(BANKPAYACNO,'0123456789ABCDEF') BANKPAYACNO,
                  TO_CHAR(to_date(A.ACTDAT,'yyyymmddhh24miss'),'yyyy-mm-dd hh24:mi:ss') ACTDAT,
                  TO_CHAR(to_date(A.SUCDAT,'yyyymmddhh24miss'),'yyyy-mm-dd  hh24:mi:ss') SUCDAT,
                  TO_CHAR(to_number(A.TXAMT)/100,'FM9999,999,999,990.00') TXAMT,
                  TO_CHAR(to_number(A.FEE)/100,'FM9999,999,999,990.00') FEE,
                  A.BANKPAYUSERNM,A.CASORDNO,A.ORDSTATUS,A.BANKCODE,A.CUST_ID,A.Bankpayusernm CUST_NAME,BANKERROR
             FROM STPCASINF A 
            WHERE A.CASORDNO = #{CASORDNO}
      </sql>
      <process>
           <!--检查用户登录平台是否正确-->
           <if condition="AND(IS_NOEQUAL_STRING(SysCod,'0001'),IS_NOEQUAL_STRING(SysCod,'2201'))">
              <set name="MsgTyp"    value="E"/>
              <set name="RspCod"    value="01001"/>
              <set name="RspMsg"    value="用户登录平台不正确"/>
              <return/>
           </if>
           
           <set name="merNo"         expr="merchantId"/> 
           <set name="CASORDNO"      expr="orderId"/> 
           <set name="signature"     expr="signature"/> 
           
           <!--检查用户登录平台是否正确-->
           <quote name="ChkNoCusOpen"/>
           
           <!-- 验签处理 -->
           <!--适用于CFCA及自建CA两种情况-->
           <if condition="IS_EQUAL_STRING(signType,'CFCA')">  <!--验签方式 CFCA -->
              <!--set name="INSTR"  expr="STRCAT('merchantId=',merchantId,'&amp;prodCode=',prodCode,'&amp;orderId=',orderId,'&amp;orderAmount=',orderAmount,'&amp;orderDate=',orderDate,'&amp;bizType=',bizType,'&amp;retUrl=',retUrl,'&amp;returnUrl=',returnUrl,'&amp;prdName=',TOUPPER(STR2HEX(prdName)),'&amp;prdDesc=',TOUPPER(STR2HEX(prdDesc)),'&amp;signType=',signType)"/-->
              <set name="INSTR"  expr="STRCAT('merchantId=',merchantId,'&amp;orderId=',orderId,'&amp;signType=',signType)"/>
              <!--CACA验签-->
              <do func="CFCASignVer">
                 <para name="sourceData"        expr="INSTR" />
                 <para name="signData"          expr="SIGNATURE" />
              </do>
              <if condition="#RetCod!=0">
                 <set name="RspCod"    value="08039"/>
                 <set name="RspMsg"    value="验签失败"/>
                 <return/>
              </if>
           </if>
           <elseif condition="IS_EQUAL_STRING(signType,'ZJCA')">  <!--验签方式 自建CA  ZJCA-->
               <set name="CFCAPWD"         value="12345678"/>
               <!--自建CA验签-->
               <do func="HkCaVerifyn">
                 <para name="sourceData"   expr="inMsg" />
                 <para name="signData"     expr="REPALLSTR(signature,' ','+')" />
                 <para name="pfxPath"      expr="STRCAT(GETCURAPPHOME(),'/key/',merchantId,'.pfx')" />
                 <para name="pfxPwd"       expr="CFCAPWD" />
               </do>
               <if condition="#RetCod!=0">
                  <set name="RspCod"    value="08039"/>
                  <set name="RspMsg"    value="验签失败"/>
                  <return/>
               </if>
               <delete name="CFCAPWD"/>
           </elseif>
           <else>
              <set name="RspCod"    value="09999"/>
              <set name="RspMsg"    value="无此验签方式！"/>
              <return/>
           </else>
           <delete name="SIGNATURE"/>
           
           <set name="queryType"     value="1"/>
           <if condition="IS_EQUAL_STRING(queryType,'1')">  <!-- 单笔查询 -->
              <set name="CASORDNO"   expr="orderId"/>
              <do func="ReadRecord"       error="IGNORE">
                 <para name="SqlCmd"       sql="QryOrdInf" />
              </do>
              <if condition="#RetCod==2">
                 <set name="RspCod"    value="08047"/>
                 <set name="RspMsg"    value="无符合条件记录"/>
                 <return/>
              </if>
              <elseif condition="#RetCod!=0">
                 <set name="RspCod"    value="09999"/>
                 <set name="RspMsg"    value="系统错误"/>
                 <return/>
              </elseif>
           </if>
            
            <set name="MsgTyp"    value="N"/>
            <set name="RspCod"    value="00000"/>
            <set name="RspMsg"    value="交易成功"/>
            
      </process>
   </transaction>
   
   
   
   <transaction code="565110" desc="充值或者消费接口建立支付订单(无账户)">
      <sql name="SelPrd"> <!-- 查询商品订单表 -->
         SELECT ORDERTIME,ordAmt,OrdStatus,prdName,merNo,bizType,payOrdNo,prdOrdType,NotifyUrl,retUrl tradeCode 
           FROM stpPrdInf 
          WHERE prdOrdNo=#{prdOrdNo} and merNo=#{MerNo}
      </sql>
      <sql name="UpdPay"> <!-- 更新支付订单表 -->
         payOrdNo=#{payOrdNo}
      </sql>
      <sql name="UpdPrd"> <!-- 更新商品订单表 -->
         prdOrdNo=#{prdOrdNo} and merNo=#{MerNo}
      </sql>
      <sql name="SelMerFee">
         SELECT fee_code FROM ARP_CUST_FEE WHERE pay_ac_no in (select pay_ac_no from arp_ac_cust_rel where CUST_ID=#{merNo}) and biz_type=#{bizType} and pay_type=#{payType}
      </sql>
      <!-- 快捷支付 查询绑定卡信息 -->
      <sql name="QryStpbanktb">
          SELECT (case when CARD_TYPE='00' then '1' when CARD_TYPE='01' then '2'   else '-1' end) as type_card FROM  STPBANKTB WHERE BAK_SEQ=#{no_agree}
      </sql>
      <sql name="QryCertificate">
          select CUST_CRED_NO from stpcusinf where CUST_ID=#{USERID}
      </sql>
      <sql name="UpdPayMer"><!-- 更新支付订单表中银行商户号 -->
          UPDATE STPPAYINF SET BnkMerNo=#{BnkMerNo} WHERE payOrdNo=#{payOrdNo}
      </sql>
      <process>
         <!--检查用户登录平台是否正确-->
         <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台不正确"/>
            <return/>
         </if>
         
         <set name="userID"       expr="USRID"/>
         <set name="MerNo"        expr="MerNo"/>
         
         <!--验签 start-->
         <set name="txnDat"        expr="TACCDT"/>
         <set name="orderNo"       expr="PrdOrdNo"/>
         <set name="txnAmt"        expr="TXAMT"/>
         <set name="TXAMT_FMT"     expr="TXAMT"/>
         <quote name="chkSign"/>
         <!--验签 end-->
         <set name="custPayAcNo"   expr="PAYACNUM"/>
         
         
         <!--查询商品订单信息-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="SelPrd" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="08001"/>
            <set name="RspMsg"    value="该订单信息不存在"/>
            <return/>
         </if>
         <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="06001"/>
            <set name="RspMsg"    value="订单已付款成功，请刷新交易记录！"/>
            <return/>
         </if>
         <elseif condition="IS_NOEQUAL_STRING(OrdStatus,'00')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="06001"/>
            <set name="RspMsg"    value="该订单状态不能支付"/>
            <quote name="UpdPrd"/>
            <return/>
         </elseif>
         <else>
            <set name="RspMsg"       value="检查通过"/>
         </else>
         
         <if condition="ISNULL(PrdOrdType)">
            <set name="PrdOrdType"  value="0"/>            
         </if>
         
         <!--判断金额是否与建立商品订单中的金额一致-->
         <if condition="IS_NOEQUAL_STRING(ordAmt,AMTPOWER(TXAMT,2))">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="08016f"/>
            <set name="RspMsg"    value="订单金额与应支付金额不符"/>
            <return/>
         </if>
         <set name="txAmt"         expr="AMTPOWER(TXAMT,2)"/>
         <!--限额检查  start --> 
         <!--set name="txAmt_bak"     expr="TXAMT"/>
         <set name="txAmt"         expr="TXAMT"/>
         <set name="Amt"           expr="txAmt"/>
         <set name="User_code"     expr="userID"/>
         <set name="comp_code"     expr="merNo"/>
         <set name="cust_type"     value="0"/>  
         <set name="Time"          expr="GETDATETIME()"/>
         <set name="DATE"          expr="GETDATE()"/>
         <set name="TRAN_TYPE"     value="2"/>
         <set name="ServiceCode"   value="680518"/>  
         <quote name="chkLimAmt"/-->
         <!--限额检查   end--> 
         
         <!--获取序号 -->
         <do func="GetSeqNo"  error="IGNORE">
            <para name="TblNam" value="stpseqrec"/>
            <para name="KeyNam" value="KeyNam"/>
            <para name="KeyVal" expr="STRCAT('StpPayInf','PayOrdNo',GETDATE())"/>
            <para name="SeqNam" value="KeyVal"/>
            <para name="Len"    value="8"/>
            <para name="Circle" value="1"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09001"/>
            <set name="RspMsg"    value="获取序号错误"/>
            <return/>
         </if>
         <set name="payOrdNo"    expr="STRCAT('P',SUBSTR(ActDat,2,7),KeyVal)"></set>
         <set name="ordCcy"      value="CNY"/>
         <set name="payType"     expr="payType"/>
         <set name="txCcy"       value="CNY"/>
         <set name="SignMsg"     expr="signature"/>                    <!--签名信息-->
         <set name="ActDat"      expr="GETDATETIME()"/>                <!--支付时间-->
         <set name="OrdStatus"   value="00"/>                          <!--未支付-->
         <set name="cust_id"     expr="userID"/>
         <set name="BANKSTLDATE" expr="GETDATE()"/>
         <set name="ACCESSWAY"   value="0"/>
         
         <if condition="IS_NOEQUAL_STRING(payType,'00')">
            <set name="BANKCOD"       expr="BANKCODE"/>
            <if condition="OR(ISNULL(THIRDPARTY),IS_EQUAL_STRING(THIRDPARTY,''))">
             <set name="THIRDPARTY"   value="PLA"/>
            </if>
         </if>
         
         <do func="InsertRecord" error="IGNORE">
            <para name="TblNam"  value="StpPayInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if> 
         <do func="CommitWork"/>
         
         <if condition="IS_EQUAL_STRING(payType,'01')">   <!--网银-->
            <set name="payAmt"           expr="txamt"/>
            <quote name="SendInb"/>
            <quote name="UpdPrd"/>
            <quote name="UpdPayMer"/>
         </if>
         <elseif condition="IS_EQUAL_STRING(payType,'03')">   <!--快捷-->
            <quote name="GetQuickInf01"/>
            <quote name="UpdPrd"/>
         </elseif>
         <else>
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="06012"/>
            <set name="RspMsg"    value="无此支付方式"/>
            <return/>
         </else>
         <set name="MsgTyp"    value="N"/>
         <set name="RspCod"    value="00000"/>
         <set name="RspMsg"    value="交易成功"/>
      </process> 
   </transaction>

   <transaction code="565229"        desc="无账户查询商品订单信息">
      <sql name="QryPrdInf"> <!--查询商品订单信息 -->
         SELECT nvl(ordAmt,' ') AS ordAmt,nvl(prdordno,' ') AS prdordno,orderTime,prdName,nvl(prdDesc,' ') as prdDesc,prdOrdType,
         to_char(to_date(ORDERTIME,'yyyy-mm-dd hh24:mi:ss'),'yyyy-mm-dd hh24:mi:ss') as ORDERTIME,
         (select cust_name from stpcusinf where cust_id=#{merNo}) as MER_NAME FROM stpprdinf 
          WHERE prdOrdNo=#{prdOrdNo} and merNo=#{merNo} 
      </sql>
      <process>
         <!--检查用户登录平台是否正确-->
         <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台不正确"/>
            <return/>
         </if>
         
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryPrdInf"/>
         </do>
         <if condition="#RetCod==2">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="无符合条件记录"/>
            <return/>
         </if>
         <elseif condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </elseif>
         
         <set name="ordAmt"        expr="AMTADDDOT(ordAmt)"/>
         <set name="MsgTyp"        value="N"/>
         <set name="RspCod"        value="00000"/>
         <set name="RspMsg"        value="交易成功"/>
      </process>
   </transaction>
   
   
   <transaction code="565101" desc="建立支付订单">
      <sql name="SelPrd"> <!-- 查询商品订单表 -->
         SELECT ORDERTIME,ordAmt,OrdStatus,prdName,merNo,bizType,payOrdNo,prdOrdType,NotifyUrl,retUrl tradeCode 
           FROM stpPrdInf 
          WHERE prdOrdNo=#{prdOrdNo} and merNo=#{MerNo}
      </sql> 
      <sql name="UpdPay"> <!-- 更新支付订单表 -->
         payOrdNo=#{payOrdNo}
      </sql>
      <sql name="UpdPrd"> <!-- 更新商品订单表 -->
         prdOrdNo=#{prdOrdNo} and merNo=#{MerNo}
      </sql>
      <sql name="QryCusInf"><!-- 查询客户信息-->
         SELECT c.CUST_STATUS, c.CUST_NAME,u.cust_login FROM StpCusInf c,stpusrinf u WHERE c.cust_id=u.cust_id and c.CUST_ID=#{USERID} 
      </sql>
      <sql name="SelAccInf"><!-- 查询客户账户信息-->
         SELECT a.AC_STATUS,a.PAY_AC_NO PAYACNUM FROM ARP_AC_PROFILE a,ARP_AC_CUST_REL b WHERE b.CUST_ID=#{USERID} AND a.PAY_AC_NO=b.PAY_AC_NO
      </sql>
      <sql name="QryPassInf"><!-- 查询客户支付密码信息-->
         SELECT PASSWORD FROM ARP_AC_CUST_REL WHERE PAY_AC_NO=#{PAYACNUM}
      </sql>
      <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
         SELECT CASH_AC_BAL,FROZ_BALANCE FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNUM}
      </sql>
      <sql name="SelMerFee">
         SELECT fee_code FROM ARP_CUST_FEE WHERE pay_ac_no in (select pay_ac_no from arp_ac_cust_rel where CUST_ID=#{merNo}) and biz_type=#{bizType} and pay_type=#{payType}
      </sql>
      <!-- 快捷支付 查询绑定卡信息 -->
      <sql name="QryStpbanktb">
          SELECT (case when CARD_TYPE='00' then '1' when CARD_TYPE='01' then '2'   else '-1' end) as type_card FROM  STPBANKTB WHERE BAK_SEQ=#{no_agree}
      </sql>
      <sql name="QryCertificate">
          select CUST_CRED_NO from stpcusinf where CUST_ID=#{USERID}
      </sql>
      <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
          SELECT 
          EXTRACT(DAY FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*24*60 + EXTRACT(HOUR FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*60 +  EXTRACT(MINUTE FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND )) as timeDifference,
          CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
          FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
      </sql>
      <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
          INSERT INTO STPLOGTMP
          (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
          VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
      </sql>
      <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
          UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
          LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
      </sql>
      <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
          UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
          WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
      </sql>
        <!-- 物业缴费相关表 -->
   	    <sql name="QryUtilityBillPayInf"><!-- 查询账单支付信息表 -->
   	    	select * from UtilityBillPayInf where BillPay_PrdOrdNo=#{Bill_PrdOrdNo}
   	    </sql>   
   	  
   	    <sql name="updateUtilityBillInf"><!-- 更新客户物业缴费账单信息记录表 -->
           UPDATE UtilityBillInf SET Bill_Status = #{Status}  WHERE Bill_PrdOrdNo=#{Bill_PrdOrdNo}
        </sql>
        
        <sql name="updateUtilityBillPayInf"><!-- 更新客户物业缴费缴费信息表 -->
           UPDATE UtilityBillPayInf SET BillPay_Status = #{Status}  WHERE BillPay_PrdOrdNo=#{Bill_PrdOrdNo}
        </sql>  
            <sql name="UpdPayMer"><!-- 更新支付订单表中银行商户号 -->
          UPDATE STPPAYINF SET BnkMerNo=#{BnkMerNo} WHERE payOrdNo=#{payOrdNo}
      </sql>
      <sql name="QryBindInf">
          SELECT CARD_NO as card_no,BANK_RES_PHONE as bind_mob from STPBANKTB WHERE BAK_SEQ=#{no_agree}
      </sql>
      <process>
         <!--检查用户登录平台是否正确-->
         <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台不正确"/>
            <return/>
         </if>
         
         <set name="userID"        expr="SESSIONS.USRID"/>
         <set name="MerNo"         expr="MerNo"/>
         <set name="cust_name"     expr="SESSIONS.USRNAME"/>
         <set name="cust_name_fmt" expr="cust_name"/>
         
         <!-- 用户信息查询-->
         <quote name="usrChk"/>
         <quote name="chkAcc"/>
         
         <!--验签 start-->
         <set name="txnDat"        expr="TACCDT"/>
         <set name="orderNo"       expr="PrdOrdNo"/>
         <set name="txnAmt"        expr="TXAMT"/>
         <set name="TXAMT_FMT"     expr="TXAMT"/>
         <quote name="chkSign"/>
         <!--验签 end-->
         <set name="custPayAcNo"   expr="PAYACNUM"/>
   
         <!--查询商品订单信息-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="SelPrd" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="08001"/>
            <set name="RspMsg"    value="该订单信息不存在"/>
            <return/>
         </if>
         <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="06001"/>
            <set name="RspMsg"    value="订单已付款成功，请刷新交易记录！"/>
            <return/>
         </if>
         <elseif condition="IS_NOEQUAL_STRING(OrdStatus,'00')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="06001"/>
            <set name="RspMsg"    value="该订单状态不能支付"/>
            <quote name="UpdPrd"/>
            <return/>
         </elseif>
         <else>
            <set name="RspMsg"       value="检查通过"/>
         </else>
         
         <if condition="ISNULL(PrdOrdType)">
            <set name="PrdOrdType"  value="0"/>            
         </if>
         
         <!--判断金额是否与建立商品订单中的金额一致-->
         <if condition="IS_NOEQUAL_STRING(ordAmt,AMTPOWER(TXAMT,2))">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="08016f"/>
            <set name="RspMsg"    value="订单金额与应支付金额不符"/>
            <return/>
         </if>
         
         <if condition="AND(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(accAmt,'0.00'))">
            <set name="payType"     expr="mulType"/>
            <set name="accAmt"      value=""/>
            <set name="mulAmt"      value=""/>
            <set name="mulType"     value=""/>
         </if>
         <elseif condition="IS_EQUAL_STRING(payType,'04')">
            <set name="MULAMT_FMT"     expr="mulAmt"/>
            <set name="accAmt"         expr="AMTPOWER(accAmt,2)"/>           <!--虚拟账户金额--> 
            <set name="mulAmt"         expr="AMTPOWER(mulAmt,2)"/>           <!--混合支付金额-->    
         </elseif>
         <else>
            <set name="RspMsg"       value="检查通过"/>
         </else>
         
         <!-- 用户支付密码锁定次数判断 -->
         <set name="USER_ID"   expr="DELBOTHSPACE(CUST_LOGIN)" />
         <set name="CUSTTYPE"  value="0"/><!--0用户 1 商户 2企业-->
         <set name="PWDTYPE"   value="1"/><!--0:登录密码 1:支付密码-->
         <set name="FailFlag"  value="0"/>
         <quote name="usrpwdlock"/>
         <!-- 用户支付密码锁定次数判断 -->
         
         <!--支付密码检查 虚拟账户支付或混合支付检查 start-->
         <if condition="OR(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(payType,'00'))">
            <set name="PAYACNO"   expr="PAYACNUM"/>
            <quote name="chkUsrPayPwd"/>
         </if>
         <!--支付密码检查 end-->

          <!-- 修改登记失败信息表 -->
          <do func="ExecSql" error="IGNORE">
             <para name="SqlCmd" sql="UpdUsrLogInfo"/>
          </do>
          <if condition="#RetCod!=0">
             <set name="RSPCOD" value="02040"/>
             <set name="RSPMSG" value="更新登录信息失败!"/> 
             <return/>
          </if>
          
         <!--限额检查  start --> 
         <set name="txAmt_bak"     expr="TXAMT"/>
         <set name="txAmt"         expr="AMTPOWER(TXAMT,2)"/>    <!--交易金额-->
         <set name="Amt"           expr="txAmt"/>
         <set name="User_code"     expr="userID"/>
         <set name="comp_code"     expr="merNo"/>
         <set name="cust_type"     value="0"/>  
         <set name="Time"          expr="GETDATETIME()"/>
         <set name="DATE"          expr="GETDATE()"/>
         <set name="TRAN_TYPE"     value="2"/>
         <set name="ServiceCode"   value="680518"/>  
         <quote name="chkLimAmt"/>
         <!--限额检查   end--> 
         
         <!--获取序号 -->
         <do func="GetSeqNo"  error="IGNORE">
            <para name="TblNam" value="stpseqrec"/>
            <para name="KeyNam" value="KeyNam"/>
            <para name="KeyVal" expr="STRCAT('StpPayInf','PayOrdNo',GETDATE())"/>
            <para name="SeqNam" value="KeyVal"/>
            <para name="Len"    value="8"/>
            <para name="Circle" value="1"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09001"/>
            <set name="RspMsg"    value="获取序号错误"/>
            <return/>
         </if>
         <set name="payOrdNo"    expr="STRCAT('P',SUBSTR(ActDat,2,7),KeyVal)"></set>
         <set name="ordCcy"      value="CNY"/>
         <set name="payType"     expr="payType"/>
         <set name="txCcy"       value="CNY"/>
         <set name="SignMsg"     expr="signature"/>                    <!--签名信息-->
         <set name="ActDat"      expr="GETDATETIME()"/>                <!--支付时间-->
         <set name="OrdStatus"   value="00"/>                          <!--未支付-->
         <set name="cust_id"     expr="userID"/>
         <set name="BANKSTLDATE" expr="GETDATE()"/>
         <set name="ACCESSWAY"   value="0"/>
         
         <if condition="IS_NOEQUAL_STRING(payType,'00')">
            <set name="BANKCOD"       expr="BANKCODE"/>
            <if condition="OR(ISNULL(THIRDPARTY),IS_EQUAL_STRING(THIRDPARTY,''))">
             <set name="THIRDPARTY"   value="PLA"/>
            </if>
         </if>
         
         <do func="InsertRecord" error="IGNORE">
            <para name="TblNam"  value="StpPayInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if> 
         <do func="CommitWork"/>
         
         <!--查询账户余额-->
         <quote name="selAccBal"/>  
         
         <if condition="IS_EQUAL_STRING(payType,'00')">       <!--虚拟账户--> 
           
            <set name="TRANWAY"        value="04"/><!--交易方式 虚拟账户--> 
            <if condition="ISNULL(CASH_AC_BAL)">
              <set name="CASH_AC_BAL"  value="0"/>
            </if>
            <if condition="ISNULL(FROZ_BALANCE)">
              <set name="FROZ_BALANCE" value="0"/>
            </if>
            <set name="casBal"     expr="SUB(CASH_AC_BAL,FROZ_BALANCE)"/>  
            
            <if condition="DOUBLECMP(casBal,1,TXAMT)">           <!--判断金额是足够-->
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="06012"/>
                <set name="RspMsg"    value="账户可用余额不足，请重新选择付款方式！"/>   
                <return/>
            </if>
            
            <!--计算商户手续费-->
            <quote name="CalMerFee"/>
            <set name="netRecAmt"      expr="netRecAmt"/>     <!--净额-->
            <set name="txnComAmt"      expr="txnComAmt"/>     <!--收取商户的交易佣金-->  
            
            <!--记账所需数据-->
            <set name="ACC_TYP"        value="01"/>           <!--现金账户-->
            <set name="MER_ACC_TYP"    value="02"/>           <!-- 商户结算账户 -->
            <set name="DR_CR_FLAG"     value="+"/>            <!--账户余额增减标识 + 增加 - 减少-->
            <set name="CCY"            value="CNY"/>          <!--货币类型-->
            <set name="AMT"            expr="TXAMT"/>         <!--金额-->
            <set name="IS_ACT"         value="Y"/>            <!--是否实时记账 Y 是 N 否-->
            <set name="usrPar"         expr="STRCAT(CUST_ID,'/',ACC_TYP,'/','-','/',CCY,'/',AMT,'/',IS_ACT,'/')"/>  <!--用户记账参数-->
            
            <!--进行虚拟账户扣款-->    
            <if condition="IS_EQUAL_STRING(prdOrdType,'0')">     <!--消费--> 
               <if condition="IS_EQUAL_STRING(flag,'1')">        <!--收取手续费标识  1 收取  0 不收取-->
                  <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                  <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                  <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar,',',feePar)"/>
               </if>
               <else>
                  <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',AMT,'/',IS_ACT,'/')"/>         <!--商户记账参数-->
                  <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar)"/>
               </else>
            </if>
            <elseif condition="IS_EQUAL_STRING(prdOrdType,'2')">    <!--担保支付--> 
               <set name="flag"               value="0"/>           <!--担保支付预付款不扣手续费 确认付款再扣取-->
               <set name="netRecAmt"          expr="txAmt"/>
               <set name="pltMidPar"          expr="STRCAT('99999900000001','/','04','/','+','/',CCY,'/',AMT,'/','N','/')"/>        <!--平台担保账户记账参数-->
               <set name="PARAMS"             expr="STRCAT(usrPar,',',pltMidPar)"/>  
            </elseif>
         
            <!--记账处理-->
            <set name="TXN_TYP"      value="2"/>                                    <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->     
            <set name="PARAMS"       expr="PARAMS"/>
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <do func="RollBackWork"/>
               <set name="Status"       value="2"/>
               <set name="ClearDat"     expr="GETDATE()"/>    <!--支付日期-->
               <quote name="UpdPay"/>
               <set name="acDate"       expr="ClearDat"/>     <!--支付日期-->  
               <set name="acTime"       expr="GETDATETIME('HHMISS')"/>  <!--支付时间-->
               <quote name="UpdPrd"/>
               <set name="RspCod"      value="80001"/>
               <set name="RspMsg"      value="账户扣款失败，请稍后重试！"/>
               <return/>
            </if>
            
            <!--更新支付订单表-->
            <set name="OrdStatus"    value="01"/>
            <if condition="NOT(ISNULL(CREDNO))">
               <delete name="CREDNO"/>   
            </if> 
            <set name="ClearDat"     expr="acDate"/>
            <quote name="UpdPay"/>
            
            <if condition="ISNULL(merRemark)">
               <set name="merRemark"         value="商物通"/>
            </if>
        
            <set name="SmsContent"    expr="STRCAT('您好，您在',merRemark,'消费金额：',AMTADDDOT(txAmt),'元，通过商物通付款成功，如有疑问请联系',merRemark,'。')"></set>
            <quote name="sendSms"/>
            
            <!--增加宏文件，处理物业缴费成功，通知第三方-->
            <set name="ConfigName"   value="PropertyMerId"/>
            <quote name="ReadXmlCfg"/>
            <if condition="IS_EQUAL_STRING(MERNO,ProMerId)">       <!--  生产商户号为固定商户号 需要配置  -->
            	   <quote name="RetBill"/>
            </if>

            <set name="#url"          expr="NotifyUrl" />  
            <if condition="IS_EQUAL_STRING(prdOrdType,'2')">
               <set name="OrdStatus"  value="12"/>  
            </if>
            <else>
               <set name="OrdStatus"  value="01"/>
            </else>
            <set name="Status"        value="1"/> 
            <!--更新商品订单表--> 
            <quote name="UpdPrd"/>
            
            <!--通知风控系统登记订单信息-->
            <set name="ServiceCode" value="680517"/>
            <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
            <set name="TCODE"       expr="payOrdNo"/>           <!--平台流水号-->
            <set name="CTYPE"       value="1"/>                 <!--客户类型-->
            <set name="CLIENTCODE"  expr="userID"/>
            <set name="CLIENTNAME"  expr="CUST_NAME"/>
            <set name="MOBILEPHONE" expr="SESSIONS.USRMP"/>
            <set name="CCODE"       expr="merNo"/>              <!--商户编号-->
            <set name="CNAME"       expr="MERREMARK"/>
            <set name="TRANTYPE"    value="2"/>                 <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
            <set name="TRANWAY"     value="04"/>                <!--交易方式 01网银、02终端、03消费卡、04虚拟积分等-->
            <set name="TAMT"        expr="ordAmt"/>
            <set name="REGDTTIME"   expr="STRCAT(acDate,acTime)"/>
            <set name="Time"        expr="acDate"/>
            <quote name="noticRcs"/>
            <set name="RspCod"      value="00000"/>
            <set name="RspMsg"      value="交易成功"/>

            <set name="SUCDAT"   expr="FMTDATE(SUBSTR(actdat,1,8),0,4)"/>
            <set name="TXAMT"    expr="AMTADDDOT(ordAmt)"/>
            <set name="NxtPag"   expr="STRCAT('../result/bankret.jsp?TXAMT=',TXAMT,'&amp;SUCDAT=',SUCDAT,'&amp;prdOrdNo=',prdOrdNo)"/>

            <!--通知商城付款成功-->
            <set name="versionId"    value="5.0.0"/>
	          <set name="merchantId"   expr="MERNO"/>
	          <set name="orderId"      expr="orderId"/>
	          <set name="settleDate"   expr="settleDate"/>
	          <set name="completeDate"    expr="completeDate"/>
	          <set name="status"       expr="status"/>
	          <set name="notifyTyp"    expr="notifyTyp"/>
	          <set name="payOrdNo"     expr="payOrdNo"/>
	          <set name="orderAmt"     expr="orderAmt"/>
	          <set name="notifyUrl"    expr="notifyUrl"/>
	          <set name="signType"     value="CFCA"/>
            <quote name="TimeTouch2"/> 
         </if>
         <elseif condition="IS_EQUAL_STRING(payType,'04')">   <!--混合支付--> 
            <set name="prdOrderNo"       expr="prdOrdNo"/>
            <set name="payAcNo"          expr="PAYACNUM"/>
            <set name="merNotmp"         expr="merno"/>
            
            <!--根据混合支付方式，发送相应接口-->
            <if condition="IS_EQUAL_STRING(MulType,'01')">    <!--网银-->
               <set name="payAmt"        expr="AMTADDDOT(mulAmt)"/>
               <set name="TXAMT_BAK"     expr="payAmt"/>
               <quote name="SendInb"/>
               <quote name="UpdPrd"/>
               <quote name="UpdPayMer"/>
            </if>
            <elseif condition="IS_EQUAL_STRING(MulType,'03')">   <!--快捷-->
                <set name="payAmt"        expr="AMTADDDOT(mulAmt)"/>
                <quote name="GetQuickInf01"/>
                <quote name="UpdPrd"/>
            </elseif>
         </elseif>
         <elseif condition="IS_EQUAL_STRING(payType,'01')">   <!--网银-->
            <set name="payAmt"           expr="txamt"/>
            <quote name="SendInb"/>
            <quote name="UpdPrd"/>
            <quote name="UpdPayMer"/>
         </elseif>
         <elseif condition="IS_EQUAL_STRING(payType,'03')">   <!--快捷-->
            <quote name="GetQuickInf01"/>
            <quote name="UpdPrd"/>
            <if condition="AND(IS_NOEQUAL_STRING(NO_AGREE,''),NOT(ISNULL(NO_AGREE)))">
                <do func="ReadRecord" error="IGNORE">
                    <para name="SqlCmd" sql="QryBindInf" />
                </do>
                <set name="cardno"  expr="DES_DECRYPT(card_no)"/>
                 <!-- 手机号-部分内容星号隐藏 -->
                <set name="First"             expr="SUBSTR(bind_mob,1,3)"/> 
                <set name="End"               expr="SUBSTR(bind_mob,8,SUB(STRLEN(bind_mob),7))"/>
                <set name="BIND_MOB_FMT"      expr="STRCAT(First,'****',End)"/>
       
                <!-- 卡号解密-部分内容星号隐藏 -->
                <set name="First"             expr="SUBSTR(cardno,1,3)"/> 
                <set name="End"               expr="SUBSTR(cardno,SUB(STRLEN(cardno),3),STRLEN(cardno))"/>
                <set name="CARDNO_FMT"        expr="STRCAT(First,'****',End)"/>
            </if>
         </elseif>
         <else>
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="06012"/>
            <set name="RspMsg"    value="无此支付方式"/>
            <return/>
         </else>
         <set name="MsgTyp"    value="N"/>
         <set name="RspCod"    value="00000"/>
         <set name="RspMsg"    value="交易成功"/>
      </process> 
   </transaction>

   <transaction code="565102" desc="支付订单结果处理-银行回调">
      <sql name="QryURL"> <!--查询通知商城的URL 查询支付订单表-->
        SELECT b.NotifyUrl,b.retUrl,b.PRDNAME,a.PrdOrdNo,a.OrdStatus,a.PrdOrdType,a.payType,a.MulType,a.txamt,a.fee txnComAmt,b.prodcode,
               a.accAmt,a.mulAmt,a.merno,a.bankCod bnkCod,a.CUST_ID,a.ActDat,b.bizType,a.BnkMerNo
         FROM StpPayInf a,StpPrdInf b 
        WHERE a.payOrdNo=#{payOrdNo} and a.prdOrdNo=b.prdOrdNo
      </sql>
      <sql name="UpdPay"> <!-- 更新支付订单表 -->
         payOrdNo=#{payOrdNo}
      </sql>
      <sql name="UpdPrd"> <!-- 更新商品订单表 -->
         prdOrdNo=#{prdOrdNo} and merNo=#{merno} 
      </sql>
      <sql name="UpdReg"> <!-- 更新充值订单表 -->
         prdordno=#{PrdOrdNo} 
      </sql>  
      <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
         SELECT CASH_AC_BAL,FROZ_BALANCE,TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'FM9999,999,999,990.00') AC_BAL FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNO}
      </sql>
      <sql name="SelBnkFee"><!-- 查询银行费率信息-->
         SELECT FEE_CODE FROM CoopBank WHERE BANK_CODE=#{bnkCod}
      </sql> 
      <sql name="SelBnkMerFee"><!-- 查询银行商户费率信息-->
         SELECT FEE_CODE FROM COOPBANK_FEE WHERE BANK_CODE=#{bnkCod} and BANK_MERNO=#{BnkMerNo}
      </sql>   
      <sql name="SelMerFee">
         SELECT fee_code 
           FROM ARP_CUST_FEE 
          WHERE pay_ac_no in (select pay_ac_no from arp_ac_cust_rel where CUST_ID=#{merNo}) and biz_type=#{bizType} and pay_type=#{payType}
      </sql>
      <sql name="SelCusAcc">
         SELECT pay_ac_no FROM arp_ac_cust_rel  WHERE CUST_ID=#{CUST_ID}
      </sql>
      <sql name="QrySendInf1">
         SELECT merNo,prdordno,txamt as ordamt,OrdStatus,ActDat as paytime,'M' as signType FROM stppayinf WHERE payordno=#{orderNo}
      </sql>
      <sql name="QryMerMD5">
         SELECT a.MD5_SECRET_CODE_ID as MD5Key FROM StpMerInf a,StpCusInf b WHERE a.CUST_ID = b.CUST_ID AND a.CUST_ID=#{merNo}
      </sql>       
      
      <!-- 物业缴费相关表 -->
   	  <sql name="QryUtilityBillPayInf"><!-- 查询账单支付信息表 -->
   	  	select * from UtilityBillPayInf where BillPay_PrdOrdNo=#{Bill_PrdOrdNo}
   	  </sql>   
   	
   	  <sql name="updateUtilityBillInf"><!-- 更新客户物业缴费账单信息记录表 -->
         UPDATE UtilityBillInf SET Bill_Status = #{Status}  WHERE Bill_PrdOrdNo=#{Bill_PrdOrdNo}
      </sql>
      
      <sql name="updateUtilityBillPayInf"><!-- 更新客户物业缴费缴费信息表 -->
         UPDATE UtilityBillPayInf SET BillPay_Status = #{Status}  WHERE BillPay_PrdOrdNo=#{Bill_PrdOrdNo}
      </sql>      
           
      <process>
         <set name="ConfigName" value="SecCfg"/>
         <quote name="ReadXmlCfg"/>
         <set name="_REQUESTATTR.FORWARDURL"  expr="reqErrPage"/>    <!-- 请求错误页面 -->
         
         <if condition="NOT(ISNULL(SIGNRESMSG))">      <!--中信验签-->
            
           <set name="ConfigName"        value="CiticCfg"/>
           <quote name="ReadXmlCfg"/>
           <do func="CiticVerifySign"    error="IGNORE">
              <para name="SIGNRESMSG"    expr="SIGNRESMSG"/>
              <para name="tcrt"          expr="trustedcrt"/>
           </do>
           <if condition="#RetCod==1">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="07004"/>
               <set name="RspMsg"    value="中信网银支付结果验签失败"/>
               <return/>  
           </if>
           <set name="bankCode"     value="03020000"/>        
           <set name="payOrdNo"     expr="ORDERNO"/> 
           <set name="ordAmt1"      expr="AMTPOWER(ordAmt1,2)"/>
           <set name="bankStlDate"  expr="orderDate1"/>
           <set name="BNKDAT"       expr="orderDate1"/>
         </if>
         
         <if condition="NOT(ISNULL(merchantNo))">      <!--中行--> 
            <if condition="IS_EQUAL_STRING(merchantNo,merchantNoBoc)">   
               <set name="bankCode"    value="01040000"/>        
               <set name="payOrdNo"    expr="orderNo"/> 
               <set name="ordAmt1"     expr="AMTPOWER(payAmount,2)"/>
            </if>
         </if>
         
         <if condition="NOT(ISNULL(BRANCHID))">        <!--建行-->
            <set name="BRANCHIDCcb"    value="110000000"/>               <!--test-->
            <if condition="IS_EQUAL_STRING(BRANCHID,BRANCHIDCcb)">       
               <set name="payOrdNo"    expr="ORDERID"/> 
               <set name="bankCode"    value="CCB"/> 
               <set name="ordAmt1"     expr="AMTPOWER(payment,2)"/>            
            </if>
         </if> 
         
         <if condition="NOT(ISNULL(MERCHANTPARA))">    <!--招行-->
            <!--取招行参数配置-->
            <set name="ConfigName"   value="CmbCfg"/>
            <quote name="ReadXmlCfg"/> 
            
            <set name="baMessage" expr="STRCAT('Succeed=',SUCCEED,'&amp;CoNo=',CONO,'&amp;BillNo=',BILLNO,'&amp;Amount=',AMOUNT,'&amp;Date=',DATE,'&amp;MerchantPara=',MERCHANTPARA,'&amp;Msg=',MSG,'&amp;Signature=',SIGNATURE)"/><!--数字签名字符串-->
            <!--招行数字签名验证-->
            <!--模拟测试不需要， 接入时放开此段代码 -->
            <set name="SUCCEED"   value="Y"/>
            <set name="ordAmt1"   expr="AMTPOWER(Amount,2)"/>
            <set name="payOrdNo"  expr="GETWORDDELIMITER(MerchantPara,'|',2)"/>
            <if condition="OR(ISNULL(DATE),IS_EQUAL_STRING(DATE,''))">
                <set name="DATE"      expr="GETDATETIME('HHMISS')"/>
            </if>
            <else>
                <set name="DATE"      expr="FMTDATE(DATE,4,0)"/>
            </else>
              
            <!--do func="CMBAttestation"     error="IGNORE">
                <para name="baMessage"    expr="baMessage"/>
            </do>
            <set name="statuenum" expr="statuenum"/>
            <if condition="IS_NOEQUAL_STRING(statuenum,'0')">       
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="08416"/>
               <set name="RspMsg"    value="数字签名证书错误"/>
               <return/>
            </if-->
            
            <delete name="baMessage"/>
            
            <set name="MERPARA"  expr="MERPARA"/>
            <set name="CMBPARA"  expr="GETWORDDELIMITER(MERCHANTPARA,'|',1)"/>
            <!--if condition="IS_EQUAL_STRING(CMBPARA,MERPARA)">       
               <set name="payOrdNo" expr="GETWORDDELIMITER(MERCHANTPARA,'|',2)"/>
               <set name="bankCode"    value="03080000"/> 
               <set name="ordAmt1"     expr="AMTPOWER(AMOUNT,2)"/>       
            </if-->
         </if> 
         
         <if condition="NOT(ISNULL(merID))">           <!--工行-->
            <if condition="IS_EQUAL_STRING(interfaceName,'ICBC_PERBANK_B2C')"> <!--接收工行网银支付结果-->
               <!--取工行参数配置-->
               <set name="ConfigName"   value="IcbcCfg"/>
               <quote name="ReadXmlCfg"/>
               
               <set name="tranData"    expr="STRCAT('interfaceName=',interfaceName,'&amp;interfaceVersion=',interfaceVersion,'&amp;orderid=',orderid,'&amp;TranSerialNo=',TranSerialNo,'&amp;amount=',amount,'&amp;curType=',curType,'&amp;merID=',IcbcMerNo,'&amp;merAcct=',merAcct,'&amp;verifyJoinFlag=',verifyJoinFlag,'&amp;JoinFlag=',JoinFlag)"/>
               <set name="tranData"    expr="STRCAT(tranData,'&amp;UserNum=',UserNum,'&amp;resultType=',resultType,'&amp;orderDate=',orderDate,'&amp;notifyDate=',notifyDate,'&amp;tranStat=',tranStat,'&amp;comment=',comment,'&amp;remark1=',remark1,'&amp;remark2=',remark2)"/>
               <do func="IcbcWbVerifySign"     error="IGNORE">
                  <para name="tranData"    expr="tranData"/>
                  <para name="crtFile"     expr="STRCAT(GETCURAPPHOME(),PubCrtFile)"/>
                  <para name="signMsg"     expr="signMsg"/>
               </do>
               <if condition="#RetCod!=0">
                  <set name="RspCod"    value="09001"/>
                  <set name="RspMsg"    value="工行网银支付结果验签失败"/>
                  <return/>
               </if>
               <set name="ORDERDATE"   expr="SUBSTR(ORDERDATE,1,8)"/>
               <set name="payOrdNo"    expr="orderid"/>
               <set name="bankCode"    value="01020000"/>
               <set name="ordAmt1"     expr="amount"/>
               <delete name="PubCrtFile"/>
               <delete name="tranData"/>
               <delete name="signMsg"/>
            </if>
         </if>   

         <if condition="NOT(ISNULL(RESPCODE))">        <!-- 银联 -->
            <do func="FrontRcvResponse"     error="IGNORE" />
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="09002"/>
               <set name="RspMsg"    value="银联返回验证失败"/>
               <return/>
            </if>
            <set name="payOrdNo"    expr="ORDERID"/>
            <set name="orderNo"     expr="ORDERID" />
            <set name="bankJrnNo"   expr="queryId" />
            <set name="bankStlDate" expr="settleDate" />
            <set name="BnkMerNo"    expr="merId" />
            <set name="ordAmt1"     expr="TXNAMT"/>   <!--银联返回订单金额-->
            <set name="ORDERDATE"   expr="SUBSTR(TXNTIME,1,8)"/>
            <set name="bankCode"    value="01010000"/>
            <set name="bizType"     value="00"/>
         </if>
         
         <set name="notifyMsg"    expr="notifyMsg"/>   <!--交行-->
         <if condition="NOT(ISNULL(notifyMsg))">
           <do func="initBCMB2CMerchant" error="IGNORE">
              <para name="apiURL"                   expr="APIURL"/>         <!--API请求URL -->
              <para name="orderURL"                 expr="B2CBCMORDERURL"/> <!--订单支付请求和一键支付开通URL-->
              <para name="shortPayURL"              expr="SHORTPAYURL"/>    <!--一键支付API请求URL-->
              <para name="enableLog"                expr="ENABLELOG"/>      <!--日志开关（true:表示写日志,false: 表示不写日志）-->
              <para name="logPath"                  expr="STRCAT(GETCURAPPHOME(),LOGPATH)"/> <!--日志文件存放目录-->
              <para name="settlementFilePath"       expr="STRCAT(GETCURAPPHOME(),SETTLEMENTFILEPATH)"/> <!--下载结算明细文件存放目录-->
              <para name="merchantCertFile"         expr="STRCAT(GETCURAPPHOME(),MERCHANTCERTFILE)"/>   <!--商户证书文件（绝对路径）-->
              <para name="merchantCertPassword"     expr="MERCHANTCERTPASSWORD"/> <!--商户证书私钥加密密码-->
              <para name="rootCertFile"             expr="STRCAT(GETCURAPPHOME(),ROOTCERTFILE)"/> <!--交通银行生产根证书-->
            </do>   
            <if condition="#RetCod==1">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="07004"/>
               <set name="RspMsg"    value="初始化失败"/>
               <return/>  
            </if>
            <do func="BCMMerchantResult" error="IGNORE">
              <para name="notifyMsg" expr="notifyMsg" />
            </do>
            <if condition="#RetCod!=0">
              <set name="RspCod"    value="08002"/>
              <set name="RspMsg"    value="解析交行返回结果失败"/>
              <return/>
            </if>
            <if condition="#RetCod==0">
              <set name="OrdStatus"  value="01"/>
              <set name="PayRet"      value="00"/>
            </if>
            <set name="bankCode"    value="03010000"/>        
            <set name="payOrdNo"    expr="payOrdNo"/> 
            <set name="ordAmt1"     expr="AMTPOWER(ordAmt1,2)"/>
         </if>
         
         <if condition="IS_EQUAL_STRING(transRst,'1')">    <!--沃支付 验签-->
            <set name="retmsg" value="SUCCESS"/>
            <set name="XmlFlag" value="2"/>
            
            <set name="ConfigName" value="Ltpay"/>
            <quote name="ReadXmlCfg"/>
            <set name="Key"       expr="merchantSignKey"/>
            <set name="merno1"    expr="merno"/>
            <set name="_REQUESTATTR.FORWARDURL"   expr="succePage"/>
            
            <!--查询沃支付信息-->
            <do func="TdOrderPay"     error="IGNORE">
            </do>
            <if condition="#RetCod!=0">
               <set name="RspCod"         value="09997"/>
               <set name="RspMsg"         value="验签失败"/>   
               <return/>
            </if> 
            <set name="MsgTyp"    value="N"/>
            <set name="RspCod"    value="00000"/>
            <set name="RspMsg"    value="交易成功"/>
            
            <set name="payOrdNo"    expr="orderNo"/>
            <set name="ordAmt1"     expr="AMOUNT"/>
            <set name="ORDERDATE"   expr="SUBSTR(ORDERDATE,1,8)"/>
            <set name="bankCode"    value="LTW"/>
            
         </if>
         <set name="TraceTime"     expr="GETDATETIME()"/>  <!--支付成功时间-->
         <set name="merRemark"     value="商物通"/>
         
         <!-- 用户等待最长时间(该时间必须控制在页面超时前) -->
         <set name="max"           value="8"/>
         <set name="i"             value="1"/>
         <!--对同一个订单号进行加锁-->
         <do func="Lock">
            <para name="RecKey"     expr="payOrdNo" />
            <para name="AutoUnLock" value="yes" />
         </do>
         <if condition="#RetCod!=0">
            <while condition="INTCMP(i,2,max)">
                <do func="Lock">
                    <para name="RecKey"     expr="payOrdNo" />
                    <para name="AutoUnLock" value="yes" />
               </do>
               <if condition="#RetCod!=0">
                   <do func="Sleep">
                       <para name="SleepTime"     value="1" />
                   </do>
                   <set name="i"                  expr="ADD(i,1)"/>
               </if>
               <else>
                   <set name="i"                  value="0"/>
                   <return/>
               </else>
            </while>
         </if>
         <if condition="INTCMP(i,5,max)">
            <set name="RspCod"           value="08001"/>
            <set name="RspMsg"           value="系统交易加锁失败，请稍后重试！"/>
            <return/>
         </if>
         
         <!--查询URL-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryURL" />
         </do>
         <set name="RCS_USER_CODE"       expr="CUST_ID"/>  <!--用户ID-->
         <set name="RCS_PAY_TYPE"        value="800019"/>  <!--本次交易码，订单支付-->
         <set name="RCS_PRD_NO"          expr="prdOrdNo"/> <!--订单号，如果不涉及置空-->
         <if condition="#RetCod!=0">
            <set name="RspCod"           value="08001"/>
            <set name="RspMsg"           value="该支付订单信息不存在"/>
            <return/>
         </if>
         <set name="prodcode"  expr="prodcode"/>
         <if condition="IS_EQUAL_STRING(prodcode,'CP00000003')">
            <set name="merjoggle" value="CP3"/>
         </if>
         
         <!-- 校验用户和账户余额查询 逻辑处理提前 -->
         <set name="payacno"        expr="SESSIONS.PAYACNO"/>
         <if condition="AND(NOT(ISNULL(payacno)),NOT(ISNULL(CUST_ID)))">
            <!--查询客户账户-->
            <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd" sql="SelCusAcc"/>
            </do>
            <if condition="#RetCod==2">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="07016"/>
               <set name="RspMsg"    value="该用户账户信息不存在"/> 
               <return/> 
            </if> 
            <elseif condition="#RetCod!=0">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09999"/>
               <set name="RspMsg"    value="系统错误"/>
               <return/> 
            </elseif>
            <set name="payacno" expr="pay_ac_no"/>
            
            <!--查询账户余额-->
            <quote name="selAccBal"/>
            <set name="AC_BAL"      expr="AC_BAL"/>
            
         </if>
         
         <if condition="IS_EQUAL_STRING(PrdOrdType,'1')">
             <set name="_REQUESTATTR.FORWARDURL"  expr="PayErrPage"/>
         </if>
         <else>
             <set name="_REQUESTATTR.FORWARDURL"  expr="RegErrPage"/>
         </else>
         <if condition="IS_NOEQUAL_STRING(OrdStatus,'00')">
            <set name="PrdOrdType"               expr="PrdOrdType"/>
            <if condition="OR(IS_EQUAL_STRING(PrdOrdType,'1'),IS_EQUAL_STRING(PrdOrdType,'3'))">
              <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                <set name="sucDat"                   expr="FMTDATE(GETDATE(),0,4)"/> 
                <set name="SUCAMT"                   expr="AMTADDDOT(txAmt)"/>
                <set name="PRDNAME"                  value="充值卡"/>
                <set name="PRDNAME_SOTR"             value="充值卡"/>
                <if condition="IS_EQUAL_STRING(prodcode,'CP00000003')">
                   <set name="_REQUESTATTR.FORWARDURL"  expr="STRCAT(onlineRegSucPage,'?payordno=',payOrdNo)"/>
                </if>
                <else>
                  <set name="_REQUESTATTR.FORWARDURL"  expr="RegSucPage"/>
                </else>
                <return/>
              </if>
              <else>
                <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                   <set name="RspCod"    value="06001"/>
                   <set name="RspMsg"    value="该订单状态不能支付"/>
                   <return/>
                </if>
              </else>
            </if>
            <else>
              <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                <set name="_REQUESTATTR.FORWARDURL"  expr="STRCAT(payResult,'?payordno=',payOrdNo)"/>
                <return/>
              </if>
              <else>
                <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                   <set name="RspCod"    value="06001"/>
                   <set name="RspMsg"    value="该订单状态不能支付"/>
                   <return/>
                </if>
              </else>
            </else>
         </if>
           
         <set name="BANKCODE"   expr="bnkCod"/>
         
         <!--判断金额是否与支付订单中的金额一致-->
         <if condition="IS_EQUAL_STRING(payType,'04')">
            <if condition="IS_NOEQUAL_STRING(mulAmt,ordAmt1)">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="08016"/>
               <set name="RspMsg"    value="订单金额与应支付金额不符"/>
               <return/>
            </if>
         </if>
         <else>
            <if condition="ISNULL(txnComAmt)">
               <set name="txnComAmt" value="0"/>
            </if>
            <if condition="IS_NOEQUAL_STRING(txamt,ordAmt1)"><!--订单金额加佣金-->
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="08016"/>
               <set name="RspMsg"    value="订单金额与应支付金额不符"/>
               <return/>
            </if>
         </else>
         
         <set name="sucDat" expr="FMTDATE(SUBSTR(actdat,1,8),0,4)"/>
         <if condition="IS_EQUAL_STRING(BANKCODE,'01040000')">
            <quote name="BOCreturn"/>      <!--  中行返回结果  -->    
         </if>
         <elseif condition="IS_EQUAL_STRING(BANKCODE,'01050000')">
            <if condition="IS_EQUAL_STRING(SUCCESS,'Y')">
               <set name="PayRet"      value="00"/>
               <set name="OrdStatus"   value="01"/>
               <set name="BnkDat"      expr="ACCDATE"/>
               <set name="bankStlDate" expr="ACCDATE"/>   
            </if> 
         </elseif>
         <elseif condition="IS_EQUAL_STRING(BANKCODE,'03010000')">
            <set name="PayRet"         value="00"/>
            <set name="OrdStatus"      value="01"/>
            <set name="BnkDat"         expr="ACCDATE"/>
            <set name="bankStlDate"    expr="ACCDATE"/>  
         </elseif>
         <elseif condition="IS_EQUAL_STRING(BANKCODE,'03080000')">
            <if condition="IS_EQUAL_STRING(SUCCEED,'Y')">
               <set name="PayRet"      value="00"/>
               <set name="OrdStatus"   value="01"/>
               <set name="BnkDat"      expr="SUBSTR(DATE,1,8)"/>
               <set name="bankStlDate" expr="SUBSTR(DATE,1,8)"/>   
            </if> 
         </elseif>
         <elseif condition="IS_EQUAL_STRING(BANKCODE,'01020000')">
            <if condition="OR(IS_EQUAL_STRING(TRANSTAT,'1'),IS_EQUAL_STRING(TRANSTAT,'0'))">
               <set name="PayRet"      value="00"/>
               <set name="OrdStatus"   value="01"/>
               <set name="BnkDat"      expr="SUBSTR(ORDERDATE,1,8)"/>
               <set name="bankStlDate" expr="SUBSTR(ORDERDATE,1,8)"/>
               <set name="ReIcbcUrl"   expr="icbcret"/>   
            </if> 
         </elseif>
         <elseif condition="IS_EQUAL_STRING(BANKCODE,'01010000')"><!-- 银联 -->
            <if condition="IS_EQUAL_STRING(RESPCODE,'00')">
               <set name="PayRet"    value="00"/>
               <!--00:等待付款  01:付款成功  02:付款失败 03:退款申请 04:等待退款 05:退款成功
                   06:退款失败  07:同意撤销  08:拒绝撤销 09:撤销成功 10:撤销失败 12:预付款  
                   17:实付审核中18:实付审核通过 19:实付审核拒绝 99:超时-->
               <set name="OrdStatus" value="01"/>
               <set name="BnkDat"      expr="SUBSTR(DATE,1,8)"/>
               <set name="bankStlDate" expr="SUBSTR(DATE,1,8)"/>   
            </if>
            <else>
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09022"/>
               <set name="RspMsg"    value="银联支付失败"/>
               <set name="OrdStatus" value="02"/>  
            </else> 
         </elseif>
         
         <set name="NotifyTyp"    value="0"/>
         <set name="#url"         expr="NotifyUrl" />                    <!-- 同步返回 URL 通知商城地址 -->
         <delete name="signature"/>
         <if condition="IS_EQUAL_STRING(PrdOrdType,'0')">                   <!-- 消费-直接支付  -->      
            <if condition="IS_NOEQUAL_STRING(PayRet,'00')">
               <set name="RspCod"       expr="RspCod"/>
               <set name="Status"       value="2"></set>
               <quote name="UpdPay"/>
               <quote name="UpdPrd"/>
               <quote name="TimeTouch2Before"/>
               <quote name="TimeTouch2"/>
               <return/>
            </if>
            
            <set name="OrdStatus"    value="01"/>
            <set name="Status"       value="1"/>
            <set name="fee"          value="0"/>                               <!-- 批量作业时再去计算 -->
            
            <!--记账处理 start-->
            <set name="TXN_TYP"          value="2"/>                                <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->     
            <if condition="IS_EQUAL_STRING(payType,'01')">                          <!--网银支付-->
               <set name="txnAmt_fee"     expr="txAmt"/>
               <set name="BnkJnl"         expr="payOrdNo"/>
               <set name="bankJrnNo"      expr="payOrdNo"/>                           <!--银行返回订单号,银行流水号--> 
               <set name="Tran_type"      value="1"/>                                 <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合-->
               
               <!--记账所需数据-->
               <set name="ACC_TYP"        value="01"/>               <!--现金账户-->
               <set name="MER_ACC_TYP"    value="02"/>               <!-- 商户结算账户 -->
               <set name="DR_CR_FLAG"     value="+"/>                <!--账户余额增减标识 + 增加 - 减少-->
               <set name="CCY"            value="CNY"/>              <!--货币类型-->
               <set name="AMT"            expr="TXAMT"/>             <!--金额-->
               
               <set name="IS_ACT"         value="Y"/>                <!--是否实时记账 Y 是 N 否-->
               
               <if condition="IS_EQUAL_STRING(flag,'1')">        <!--有手续费-->
                  <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                  <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                  <set name="PARAMS"     expr="STRCAT(merPar,',',feePar)"/>
               </if>
               <else>                                            <!--无手续费-->
                  <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',AMT,'/',IS_ACT,'/')"/>        <!--商户记账参数-->
                  <set name="PARAMS"     expr="merPar"/>
               </else>
            </if>
            <elseif condition="AND(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(MulType,'01'))">    <!--混合支付-->
               <set name="txnAmt_fee"    expr="mulAmt"/>
               <set name="bankJrnNo"     expr="payOrdNo"/>                         <!--银行返回订单号--> 
               <set name="Tran_type"     value="5"/>                               <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合--> 
               
               <if condition="ISNULL(CASH_AC_BAL)">
                 <set name="CASH_AC_BAL" value="0"/>
               </if>
               <if condition="ISNULL(FROZ_BALANCE)">
                 <set name="FROZ_BALANCE" value="0"/>
               </if>
               <set name="casBal"     expr="SUB(CASH_AC_BAL,FROZ_BALANCE)"/>
               
               <!--记账所需数据-->
               <set name="ACC_TYP"        value="01"/>               <!--现金账户-->
               <set name="MER_ACC_TYP"    value="02"/>               <!-- 商户结算账户 -->
               <set name="CCY"        value="CNY"/>              <!--货币类型-->
               <set name="IS_ACT"     value="Y"/>                <!--是否实时记账 Y 是 N 否-->
               <set name="usrPar"     expr="STRCAT(CUST_ID,'/',ACC_TYP,'/','-','/',CCY,'/',ACCAMT,'/',IS_ACT,'/')"/>  <!--用户记账参数-->
               
               <if condition="DOUBLECMP(casBal,5,ACCAMT)">        <!--现金账户-->
                  <if condition="IS_EQUAL_STRING(flag,'1')">   <!--有手续费-->
                     <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                     <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                     <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar,',',feePar)"/>
                  </if>
                  <else>                                       <!--无手续费-->
                     <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',txAmt,'/',IS_ACT,'/')"/>      <!--商户记账参数-->
                     <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar)"/>
                  </else>
               </if>
            </elseif>
            
            <set name="TRANTYPE"     value="2"/>                                    <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->  
            <set name="TRANWAY"      value="01"/>                                   <!--01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
            <set name="CCODE"        expr="merNo"/>                                 <!--商户编号--> 
            
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="07005"/>
               <set name="RspMsg"    value="银行付款成功，系统入账失败。请等待系统自动调账处理货联系客服人员！"/>
               <return/>
            </if>
            <!--记账处理 end-->
            
            <!--计算银行手续费-->
            <quote name="CalBnkFee"/> 
            
            <quote name="UpdPay"/>         <!--更新支付订单表-->
            <quote name="UpdPrd"/>         <!--更新商品订单表-->

            <set name="SmsContent"    expr="STRCAT('您好，您在',merRemark,'消费金额：',AMTADDDOT(txAmt),'元，通过商物通付款成功，如有疑问请联系',merRemark,'。')"></set>
            <quote name="sendSms"/>

	             
            <!--增加宏文件，处理物业缴费成功，通知第三方-->
            <set name="ConfigName"   value="PropertyMerId"/>
            <quote name="ReadXmlCfg"/>
            <if condition="IS_EQUAL_STRING(MERNO,ProMerId)">       <!--  生产商户号为固定商户号 需要配置  -->
            	   <quote name="RetBill"/>
            </if>
	          <else>
	          	 <set name="Status"     value="1"></set>
               <quote name="TimeTouch2Before"/>
	             <quote name="TimeTouch2"/>    <!--通知商城--> 
	          </else>
            <set name="_REQUESTATTR.FORWARDURL"  expr="STRCAT(payResult,'?payordno=',payOrdNo)"/>
         </if>
         <elseif condition="IS_EQUAL_STRING(PrdOrdType,'2')">               <!-- 消费-担保支付  -->  
            <set name="NotifyTyp"    value="0"/>
            <set name="#url"         expr="NotifyUrl" />                    <!-- 同步返回 URL  -->
            
            <if condition="IS_NOEQUAL_STRING(PayRet,'00')">
               <set name="RspCod"       expr="RspCod"/>
               <set name="Status"       value="2"></set>
               <quote name="UpdPay"/>

               <quote name="UpdPrd"/>
               <quote name="TimeTouch2"/>
               <return/>
            </if>
            
            <set name="Status"       value="1"/>
   
            <!--记账处理 start-->
            <!--计算商户手续费--> 
            <quote name="CalMerFee"/>
            <set name="TXN_TYP"          value="2"/>                                <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->     
            <if condition="IS_EQUAL_STRING(payType,'01')">                          <!--网银支付-->
               <set name="txnAmt_fee"    expr="txAmt"/>
               <set name="BnkJnl"         expr="payOrdNo"/>
               <set name="bankJrnNo"      expr="payOrdNo"/>                         <!--银行返回订单号--> 
               <set name="Tran_type"      value="1"/>                               <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合-->
               
               <!--记账参数准备-->
               <set name="pltMidPar"      expr="STRCAT('99999900000001','/','04','/','+','/','CNY','/',txAmt,'/','N','/')"/>        <!--平台担保账户记账参数-->
               <set name="PARAMS"         expr="pltMidPar"/>
            </if>
            <elseif condition="AND(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(MulType,'01'))">    <!--混合支付-->
               <set name="txnAmt_fee"     expr="mulAmt"/>
               <set name="bankJrnNo"      expr="payOrdNo"/>                            <!--银行返回订单号--> 
               <set name="Tran_type"      value="5"/>                                  <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合--> 
               
               <if condition="ISNULL(CASH_AC_BAL)">
                 <set name="CASH_AC_BAL" value="0"/>
               </if>
               <if condition="ISNULL(FROZ_BALANCE)">
                 <set name="FROZ_BALANCE" value="0"/>
               </if>
               <set name="casBal"     expr="SUB(CASH_AC_BAL,FROZ_BALANCE)"/>
               
               <if condition="DOUBLECMP(casBal,5,ACCAMT)">          <!--现金账户-->
                  <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','-','/','CNY','/',ACCAMT,'/','Y','/')"/>            <!--用户记账参数-->
                  <set name="pltMidPar"  expr="STRCAT('99999900000001','/','04','/','+','/','CNY','/',txAmt,'/','N','/')"/>      <!--平台担保账户记账参数-->
                  <set name="PARAMS"     expr="STRCAT(usrPar,',',pltMidPar)"/> 
               </if>
            </elseif>

            <set name="TRANTYPE"     value="2"/>                                    <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->  
            <set name="TRANWAY"      value="01"/>                                   <!--01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
            <set name="CCODE"        expr="merNo"/>         

            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <do func="RollBackWork"/>
               <set name="RspCod"    value="07005"/>
               <set name="RspMsg"    value="支付失败"/>
               <set name="RspMsg"    value="银行付款成功，系统入账失败。请等待系统自动调账处理货联系客服人员！"/>
               <return/>
            </if>
            <!--记账处理 end-->
            
            <!--计算银行手续费-->
            <quote name="CalBnkFee"/>
            
            <set name="OrdStatus"     value="01"/>   <!--支付订单状态  交易成功-->
            <quote name="UpdPay"/>                   <!--更新支付订单表-->
            
            <set name="OrdStatus"     value="12"/>   <!--商品订单状态  支付成功-->
            <quote name="UpdPrd"/>

            <set name="SmsContent"    expr="STRCAT('您好，您在',merRemark,'消费金额：',AMTADDDOT(txAmt),'元，通过商物通付款成功，如有疑问请联系',merRemark,'。')"></set>
            <quote name="sendSms"/>

            <!--增加宏文件，处理物业缴费成功，通知第三方-->
            <set name="ConfigName"   value="PropertyMerId"/>
            <quote name="ReadXmlCfg"/>
            <if condition="IS_EQUAL_STRING(MERNO,ProMerId)">       <!--  生产商户号为固定商户号 需要配置  -->
            	   <quote name="RetBill"/>
            </if>
	    <else>
	           <quote name="TimeTouch2"/>    <!--通知商城--> 
	    </else>
            <set name="_REQUESTATTR.FORWARDURL"           expr="STRCAT(payResult,'?payordno=',payOrdNo)"/>    
         </elseif>
         <elseif condition="OR(IS_EQUAL_STRING(PrdOrdType,'1'),IS_EQUAL_STRING(PrdOrdType,'3'))">               <!-- 充值  商户充值-->
            <set name="_REQUESTATTR.FORWARDURL"  expr="RegErrPage"/>        <!-- 设定充值处理失败错误页面 -->
            <if condition="IS_NOEQUAL_STRING(PayRet,'00')">
               <set name="RspCod"       expr="RspCod"/>
               <set name="Status"       value="2"></set>
               <quote name="UpdPay"/>
               <quote name="UpdReg"/>               <!--  更新充值订单  -->
               
               <quote name="TimeTouch2Before"/>
               <quote name="TimeTouch2"/>    <!--通知商城--> 
               <return/>
            </if>
            
            <set name="acDate"  expr="GETDATE()"/>              <!--支付日期-->
            <set name="acTime"  expr="GETDATETIME('HHMISS')"/>  <!--支付时间-->   
            
            <if condition="ISNULL(txnComAmt)">
               <set name="txnComAmt" value="0"/>
            </if>
            <if condition="IS_EQUAL_STRING(prodcode,'CP00000003')">
               <set name="CUST_ID"        expr="MERNO"/><!--商户接口充值或者消费使用商户号-->
            </if>
            
            <if condition="DOUBLECMP(txnComAmt,'6','0')">
               
               <set name="fee"            expr="txnComAmt"/>
               <set name="netAmt"         expr="SUB(txAmt,txnComAmt)"/>
               <set name="usrPar"         expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',netAmt,'/','Y','/')"/>               <!--用户记账参数-->
               <set name="feePar"         expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',txnComAmt,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
               <set name="PARAMS"         expr="STRCAT(usrPar,',',feePar)"/>
            </if>
            <else>
               <set name="flag"           value="0"/> 
               <set name="fee"            value="0"/>   
               <set name="usrPar"         expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',txAmt,'/','Y','/')"/>  <!--用户记账参数-->
               <set name="PARAMS"         expr="usrPar"/>
            </else>
            <set name="netRecAmt"         expr="SUB(txAmt,txnComAmt)"/>   <!--净额-->  

            <!--记账处理--> 
            <set name="TXN_TYP"           value="1"/>                     <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->      
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <do func="RollBackWork"/> 
               <set name="RspCod"    value="07005"/>
               <set name="RspMsg"    value="充值失败"/>
               <return/>
            </if>
            
            <!--计算银行手续费-->
            <set name="txnAmt_fee"     expr="txAmt"/>
            <quote name="CalBnkFee"/>
            
            <set name="TRANTYPE"       value="1"/>             <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
            <set name="TRANWAY"        expr="payType"/>        <!--交易方式 01网银、02终端、03消费卡、04虚拟账户、05快捷支付--> 
            <set name="TXCCY"          value="CNY"/>
            <set name="payType"        expr="payType"/>
            <set name="OrdStatus"      value="01"/>   <!--支付订单状态  交易成功-->
            <if condition="OR(ISNULL(MerNo),IS_EQUAL_STRING(DELBOTHSPACE(MerNo),''))">
               <set name="MerNo"          value="00000000000000"/>    <!--商户号-->
            </if>
            <quote name="UpdPay"/>               <!--  更新支付订单  --> 
            <quote name="UpdReg"/>               <!--  更新充值订单  --> 
            <set name="merRemark"      value="账户充值"/> <!-- 商户信息 -->
            <set name="_REQUESTATTR.FORWARDURL"       expr="RegSucPage"/>    <!--异步通知页面-->
            
	          <set name="Status"     value="1"></set>
            <quote name="TimeTouch2Before"/>
            <quote name="TimeTouch2"/>    <!--通知商城--> 
         </elseif>
         <else>
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09001"/>
            <set name="RspMsg"    value="系统错误"/>
            <set name="_REQUESTATTR.FORWARDURL"       expr="reqErrPage"/> 
            <return/>   
         </else>
         
         <!--通知风控系统登记订单信息-->
         <set name="ServiceCode" value="680517"/>
         <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
         <set name="TCODE"       expr="payOrdNo"/>           <!--平台流水号 支付订单号-->
         <set name="CTYPE"       value="1"/>                 <!--客户类型-->
         <set name="CLIENTCODE"  expr="CUST_ID"/>            <!--客户编号-->
         <set name="CLIENTNAME"  expr="SESSIONS.USRNAME"/>
         <set name="MOBILEPHONE" expr="SESSIONS.USRMP"/>
         <set name="TAMT"        expr="txAmt"/>
         <set name="TRANWAY"     value="01"/>
         <set name="REGDTTIME"   expr="STRCAT(acDate,acTime)"/>
         <set name="Time"        expr="acDate"/>
         <quote name="noticRcs"/>

         <set name="sucAmt"         expr="AMTADDDOT(TXAMT)"/>
         <set name="RspCod"         value="00000"/>
         <set name="RspMsg"         value="支付成功"/>
        
      </process>
   </transaction>
   
   <transaction code="signpayVerify" desc="快捷支付回调">
      <sql name="UpdPay"> <!-- 更新支付订单表 -->
         payOrdNo=#{payOrdNo}
      </sql>
      <sql name="UpdPrd"> <!-- 更新商品订单表 -->
         prdOrdNo=#{prdOrdNo} and merNo=#{merno} 
      </sql> 
      <sql name="QryPrdInf"> <!-- 查询商品订单 -->
         SELECT bizType FROM StpPrdInf WHERE prdordno=#{prdordno} and merno=#{merno}
      </sql>
      <sql name="UpdReg"> <!-- 更新充值订单表 -->
         prdordno=#{PrdOrdNo} and prdOrdType='1'
      </sql>  
      <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
         SELECT CASH_AC_BAL,FROZ_BALANCE FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNO}
      </sql>
      <sql name="SelBnkFee"><!-- 查询银行费率信息-->
         SELECT FEE_CODE FROM CoopBank WHERE BANK_CODE=#{bnkCod}
      </sql> 
      <sql name="SelBnkMerFee"><!-- 查询银行商户费率信息-->
         SELECT FEE_CODE FROM COOPBANK_FEE WHERE BANK_CODE=#{bnkCod} and BANK_MERNO=#{BnkMerNo}
      </sql>
      <sql name="SelMerFee">
         SELECT fee_code 
           FROM ARP_CUST_FEE 
          WHERE pay_ac_no in (select pay_ac_no from arp_ac_cust_rel where CUST_ID=#{merNo}) and biz_type=#{bizType} and pay_type=#{payType}
      </sql>
      <sql name="SelCusAcc">
         SELECT pay_ac_no FROM arp_ac_cust_rel  WHERE CUST_ID=#{CUST_ID}
      </sql>
      <sql name="QrySendInf1">
         SELECT merNo,prdordno,txamt as ordamt,OrdStatus,ActDat as paytime,'M' as signType FROM stppayinf WHERE payordno=#{orderNo}
      </sql>
      <sql name="QrySendInf2">
         SELECT filed4 as Orddate,FILED5 as  respMode,retUrl as ReturnUrl,notifyUrl as notifyUrl FROM stpprdinf WHERE payordno=#{orderNo}
      </sql>  
      <sql name="QryMerMD5">
         SELECT a.MD5_SECRET_CODE_ID as MD5Key FROM StpMerInf a,StpCusInf b WHERE a.CUST_ID = b.CUST_ID AND a.CUST_ID=#{merNo}
      </sql>  
      <sql name="QryStpBankInf"> <!--  查询用户绑定的银行卡(借记卡、信用卡)  --> 
        SELECT (case when CARD_TYPE='00' then '1' when CARD_TYPE='01' then '2'   else '-1' end) as type_card,CARD_NO as cardno,CARD_NAME as cust_name,CARD_BANK_THREE as cvv2,VALIDITY_M as month,VALIDITY_Y as year,BANK_RES_PHONE as bind_mob,BANK_CONF,AUTH_CODE as tokenPayData from STPBANKTB where BAK_SEQ=#{no_agree}
      </sql>
      <sql name="QryUsrIdverifycode"> <!-- 查询用户注册验证码信息  -->
          SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,timeout,InsTim,Random 
          FROM STPVERIFY 
          WHERE VER_ID=#{UsrMp} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
      </sql>
      <sql name="QryUserBank"><!--  检测用户是否绑定了该卡  -->
          SELECT CUST_ID as BIND_CUST_ID,BAK_SEQ FROM STPBANKTB WHERE CARD_TYPE=#{CardType} AND CARD_NO=#{BnkAcNo} 
      </sql>
      <sql name="InsUserBankInf"><!--  绑定银行卡  -->
          INSERT INTO STPBANKTB (BAK_SEQ,CUST_ID,CARD_BANK,CARD_NO,CARD_TYPE,CARD_NAME,BANK_NAM,CARD_BANK_THREE,VALIDITY_M,VALIDITY_Y,BANK_CONF,BANK_RES_PHONE)  
          VALUES(#{BAK_SEQ},#{userID},#{bank_code},#{BNKACNO},#{CardType},#{CARD_NAME},#{BANK_NAME},#{cvv2},#{month},#{year},'1',#{bind_mob})
      </sql>
      <sql name="UpdBankInf"><!-- 更新卡信息 -->
          UPDATE STPBANKTB SET BANK_CONF=#{BANK_CONF},BANK_RES_PHONE=#{bind_mob}  WHERE BAK_SEQ=#{no_agree}
      </sql>
      <sql name="QryURL"> <!--查询订单基本信息-->
        SELECT b.NotifyUrl,a.PrdOrdNo,a.OrdStatus,b.PRDNAME,a.PrdOrdType,
               a.payType,a.MulType,a.txamt,NVL(a.fee,'0') txnComAmt,a.accAmt,a.mulAmt,a.merno,a.CUST_ID,a.ActDat,nvl(a.BnkMerNo,' ') BnkMerNo
          FROM StpPayInf a,StpPrdInf b 
         WHERE a.payOrdNo=#{payOrdNo} and a.payOrdNo=b.payOrdNo
      </sql>
      <!--查询身份证号  -->
      <sql name="QryCertificate">
     	  select CUST_CRED_NO as CERTIFID from stpcusinf where CUST_ID=#{USERID}
      </sql>
      <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
          SELECT 
          EXTRACT(DAY FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*24*60 + EXTRACT(HOUR FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*60 +  EXTRACT(MINUTE FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND )) as timeDifference,
          CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT 
          FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
      </sql>
      <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
          INSERT INTO STPLOGTMP 
          (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE) 
          VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
      </sql>
      <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
          UPDATE STPLOGTMP SET LAST_LOGIN_TIME=SYSDATE ,
          LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
      </sql>
      <sql name="QryPassInf"><!-- 查询客户支付密码信息-->
          SELECT PASSWORD FROM ARP_AC_CUST_REL WHERE PAY_AC_NO=#{PAYACNO}
      </sql>
      <sql name="bindAgain">
      	    update stpbanktb set BANK_RES_PHONE=#{PHONENO},AUTH_CODE=#{TOKENPAYDATA} where bak_seq=#{BAK_SEQ}
      </sql>
      <process>
        <!-- 检测用户登录状态 此交易必须是登录状态完成-->
        <set name="userID"          expr="SESSIONS.USRID"/>
        <if condition="ISNULL(userID)">
            <set name="MsgTyp"        value="E"/>
            <set name="RspCod"        value="02000"/>
            <set name="RspMsg"        value="用户登录超时"/>
            <return/>
        </if>
         <!--参数配置-->
          <set name="ConfigName"       value="NJPaymentInfo"/>
          <quote name="ReadXmlCfg"/>
        <!-- 订单信息 -->
        <set name="orderNo"       expr="payordno"/>    <!-- 支付订单编号 -->
        <set name="txnAmt"        expr="pay_amt"/>     <!-- 付款金额 单位：元 -->
        <set name="ordAmt1"       expr="AMTPOWER(txnAmt,2)"/>  <!--付款金额：分  -->
        <set name="txnDat"        expr="TACCDT"/>      <!-- 付款日期  YYYYMMDD -->
          
        <set name="no_agree"      expr="no_agree"/>    <!-- 协议编号 -->
        
        <set name="paypwd"      expr="PASSWORD"/>
        <set name="payAcNo"     expr="SESSIONS.PAYACNO"/>  
        <set name="userID"      expr="SESSIONS.USRID"/>
        
        <if condition="AND(NOT(ISNULL(no_agree)),IS_NOEQUAL_STRING(no_agree,''))">
           <!-- 查询绑定卡信息 -->
           <do func="ReadRecord"     error="IGNORE">
              <para name="SqlCmd" sql="QryStpBankInf"/>
           </do>
           <if condition="#RetCod==2">
              <set name="MsgTyp"        value="E"/>
              <set name="RspCod"        value="09999"/>
              <set name="RspMsg"        value="该卡信息已删除"/>
              <return/>  
           </if>
           <elseif condition="#RetCod!=0">
              <set name="MsgTyp"        value="E"/>
              <set name="RspCod"        value="02003"/>
              <set name="RspMsg"        value="获取卡信息失败，请重新选择！"/>
              <return/>  
           </elseif>
           <set name="BANK_CONF"       expr="BANK_CONF"/><!-- 开通无跳转支付状态 -->
           <set name="sDeData"         expr="cardno"   /><!-- 卡号 -->
           <if condition="NOT(ISNULL(DES_DECRYPT(sDeData)))"><!-- 卡加密转换 -->
              <set name="cardno"      expr="DES_DECRYPT(sDeData)"/>
           </if>
        </if>
        <else>
            <set name="MsgTyp"        value="E"/>
            <set name="RspCod"        value="09999"/>
            <set name="RspMsg"        value="系统出错"/>
            <return/>  
        </else>
        <!--判断开通的token支付是否已失效  如果失效则更新标记  -->
       <!--  <do func="DisaTokenData">
            <para name="tokenData" expr="tokenPayData"/>
        </do>
        <if condition="INTCMP(tokenEnd,6,GETDATETIME())">需要更新 
            <do func="WuTZChangeBind">
				<para name="channelType" value="07" />
				<para name="orderId" expr="GETDATETIME()" />
				<para name="encryptcertid" value="" />
			</do>
			
			<do func="ExecSql" error="IGNORE">
				<para name="SqlCmd" sql="bindAgain" />
			</do>
        </if> -->
        
        
        <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryCertificate"/>
        </do>
        <if condition="#RetCod!=0">
            <set name="MsgTyp"        value="E"/>
            <set name="RspCod"        value="02003"/>
            <set name="RspMsg"        value="没有进行实名认证"/>
            <return/>  
         </if>
         <if condition="NOT(ISNULL(DES_DECRYPT(CERTIFID)))"><!-- 身份证转换 -->
              <set name="certifid"      expr="DES_DECRYPT(CERTIFID)"/>
         </if>
        
        <!-- 用户支付密码锁定次数判断 -->
         <set name="USER_ID"   expr="userID" />
         <set name="CUSTTYPE"  value="0"/><!--0用户 1 商户 2企业-->
         <set name="PWDTYPE"   value="1"/><!--0:登录密码 1:支付密码-->
         <set name="FailFlag"  value="0"/>
         <quote name="usrpwdlock"/>
         <!-- 用户支付密码锁定次数判断 -->
         
         <!--校验支付密码 以及转加密-->
         <quote name="chkUsrPayPwd"/>
        
        <set name="cardno"        expr="cardno"/>      <!-- 卡号 -->
        <set name="bind_mob"      expr="bind_mob"/>    <!-- 预留银行绑定手机号 -->
        <set name="type_card"     expr="type_card"/>   <!-- 卡类型 1：借记卡 2：信用卡 -->
        <set name="bank_code"     expr="bank_code"/>   <!-- 银行编码  -->
        <set name="bank_name"     expr="bank_name"/>   <!-- 银行名称  -->
        <set name="cvv2"          expr="cvv2"/>        <!-- 卡背面后三位 -->
        <set name="month"         expr="month"/>       <!-- 有效期-月 -->
        <set name="year"          expr="year"/>        <!-- 有效期-年 -->
        <set name="CARD_NAME"     expr="SESSIONS.USRNAME"/>
        <!-- 检测基本卡信息 -->
        <if condition="OR(ISNULL(cardno),ISNULL(bind_mob),ISNULL(type_card),ISNULL(bank_code))">
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="02003"/>
           <set name="RspMsg"        value="卡信息不完整，请重填后再提交付款！"/>
           <return/> 
        </if>
        <if condition="IS_NOEQUAL_STRING(BANK_CONF,'1')">
            <set name="MsgTyp"        value="E"/>
            <set name="RspCod"        value="02003"/>
            <set name="RspMsg"        value="未开通快捷支付，请开通..."/>
            <return/>
        </if>
        <!-- 卡类型转换 -->
        <if condition="IS_EQUAL_STRING(type_card,'1')">
           <set name="CardType"       value="00"/>  <!-- 借记卡 -->
           <set name="cvv2"           value=""/>
           <set name="month"          value=""/>
           <set name="year"           value=""/>
        </if>
        <elseif condition="IS_EQUAL_STRING(type_card,'2')">
            <set name="CardType"       value="01"/>  <!-- 信用卡 -->
        </elseif>
        <else>
            <set name="MsgTyp"        value="E"/>
            <set name="RspCod"        value="02007"/>
            <set name="RspMsg"        value="不支持该卡种的消费，请选择其他卡付款！"/>
            <return/>
        </else>
        
        
        <!-- 调用银行的开通快捷支付的接口 -->
       <!-- 模拟银行快捷支付
            1.在此处调用银行快捷支付
            2.根据银行的付款结果处理后续流程
       -->
        <do func="WuTZpayment"    error="IGNORE">
           <para name="txnSubType"    value="01"/><!--交易子类  -->
           <para name="channelType"   value="07"/>
           <para name="backUrl"       value="signpaySback.tran"/>
           <para name="orderId"    	  expr="payOrdNo"/><!-- 商户订单号 -->
           <para name="txnTime"       expr="GETDATETIME()"/>
           <para name="accType"       value="01"/>
           <para name="accNo"         expr="cardno"/>
           <para name="txnAmt"        expr="AMTPOWER(txnAmt,2)"/>
           <para name="encryptCertId"        value=""/>
           <para name="tokenPayData"  expr="tokenPayData"/>
        </do>
       <if condition="#RetCod!=0">
           <set name="MsgTyp"      value="E"/>
           <set name="RspCod"      value="08001"/>
           <set name="RspMsg"      value="交易失败"/>
       </if>
       <set name="MsgTyp"      value="N"/>
       <set name="RspCod"      value="00000"/>
       <set name="RspMsg"      value="交易成功"/>
       <!-- 模拟银行 开始 -->
       <do expr="@TdRandom@generateMixRandom(16, 'NUM', 'LOW')"/>
       <set name="BANKJRNNO"    expr="Random"/>         <!-- 模拟银行返回流水流水号 -->
       <set name="PAYRET"       value="00"/>             <!-- 模拟银行付款状态 -->
       <set name="TraceTime"    expr="GETDATETIME()"/>  <!--支付成功时间-->
       <delete name="Random"/>
       <!-- 模拟银行 结束 -->
        
          <set name="payordno"       expr="payordno"/>
          <!--对同一个订单号进行加锁-->

          <do func="Lock">
             <para name="RecKey"     expr="payordno" />
             <para name="AutoUnLock" value="yes" />
          </do>
          <if condition="#RetCod!=0">
             <set name="RspCod"      value="08001"/>
             <set name="RspMsg"      value="正在处理中,请勿重复请求!"/><!-- 加锁失败的原因：请求频率过高 -->
             <return/>
          </if>
         
         <!--查询订单信息-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryURL" />
         </do>
         <set name="RCS_USER_CODE"       expr="CUST_ID"/>  <!--用户ID-->
         <set name="RCS_PAY_TYPE"        value="800019"/>  <!--本次交易码，订单支付-->
         <set name="RCS_PRD_NO"          expr="prdOrdNo"/> <!--订单号，如果不涉及置空-->
         <set name="payType"             expr="payType"/>  <!-- 支付方式 -->
         <set name="BANKCODE"            expr="BANKCOD"/>  <!-- 银行编码 -->
         <if condition="#RetCod!=0">
            <set name="RspCod"           value="08001"/>
            <set name="RspMsg"           value="系统繁忙，付款失败。请稍后重试！"/>
            <return/>
         </if>
         
         <!-- 判断订单是否已经付款成功 -->
         <if condition="IS_NOEQUAL_STRING(OrdStatus,'00')">
            <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
             <set name="RspCod"    value="00000"/>
             <set name="RspMsg"    value="已付款成功"/>
             <return/>
            </if>
            <else>
             <set name="RspCod"    value="06001"/>
             <set name="RspMsg"    value="该订单状态不能支付"/>
             <return/>
            </else>
         </if>
           
         <!--判断金额是否与支付订单中的金额一致-->
         <if condition="IS_EQUAL_STRING(payType,'04')">
            <if condition="IS_NOEQUAL_STRING(mulAmt,ordAmt1)"><!-- 第二种支付方式支付金额 -->
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="08016"/>
               <set name="RspMsg"    value="支付金额与订单金额不符，请检查订单！"/>
               <return/>
            </if>
         </if>
         <else>
            <if condition="IS_NOEQUAL_STRING(txamt,ordAmt1)"><!-- 订单金额 -->
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="08016"/>
               <set name="RspMsg"    value="支付金额与订单金额不符，请检查订单！"/>
               <return/>
            </if>
         </else>
         
         <set name="sucDat"      expr="FMTDATE(SUBSTR(TraceTime,1,8),0,4)"/>
         <set name="OrdStatus"   value="00"/>
         <set name="BnkDat"      expr="GETDATE()"/>
         <set name="bankStlDate" expr="GETDATE()"/>
         
         <set name="payacno"        expr="SESSIONS.PAYACNO"/>  
         <if condition="ISNULL(payacno)">
            <!--查询客户账户-->
            <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd" sql="SelCusAcc"/>
            </do>
            <if condition="#RetCod==2">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="02000"/>
               <set name="RspMsg"    value="登录超时，请登录后重试！"/> 
               <return/> 
            </if> 
            <elseif condition="#RetCod!=0">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09999"/>
               <set name="RspMsg"    value="系统繁忙，请稍后重试！"/>
               <return/> 
            </elseif>
            <set name="payacno" expr="pay_ac_no"/>
         </if>
         
         <!--查询账户余额-->
         <quote name="selAccBal"/>
         <set name="merRemark"         value="商物通"/>
         
         <do func="UpdateRecord" error="IGNORE">
            <para name="TblNam"  value="StpPayInf" />
            <para name="CndSts"  sql="UpdPay"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if> 
         <do func="CommitWork"/>
         
         <set name="i" value="1"/>
         <while condition="INTCMP(i,2,5)">
             <set name="i" expr="ADD(i,'1')"/>
             <do func="ReadRecord" error="IGNORE">
                 <para name="SqlCmd" sql="QryURL" />
             </do>
             <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                 <set name="OrdStatus" value="01"/>
                 <return/>
             </if>
             <do func="Sleep">
                 <para name="SleepTime" value="1"/>
             </do>
         </while>
         <!-- 记账为异步返回回调 -->
         <!-- 消费交易，异步通知商城 -->
         <if condition="IS_NOEQUAL_STRING(PrdOrdType,'1')">
             <set name="#url"               expr="NotifyUrl" />                    <!-- 同步返回 URL  -->
             <set name="sucAmt"             expr="AMTADDDOT(TXAMT)"/>
             <set name="sucDat"             expr="sucDat"/>
             <quote name="TimeTouch2"/>    <!--通知商城-->
         </if>
      </process>
   </transaction>
   
   <transaction code="queryPayord"   desc="查询订单付款结果">
      <sql name="QryURL"> <!--查询订单基本信息-->
          SELECT b.versionid,b.NotifyUrl,b.returl,a.PrdOrdNo,a.OrdStatus,(case when length(b.PRDNAME)>8 then substr(b.PRDNAME,0,7)||'...'  else b.PRDNAME end) as PRDNAME_SOTR,b.PRDNAME,a.PrdOrdType, to_char(to_date(a.ACTDAT,'YYYY-MM-DD HH24:MI:SS'),'YYYY-MM-DD HH24:MI:SS') as ACTDAT_FMT,
               a.payType,a.MulType,a.TXAMT,NVL(a.fee,'0') txnComAmt,a.accAmt,a.mulAmt,a.merno,a.BANKCOD,a.PAYRET,a.CUST_ID,a.ActDat
          FROM StpPayInf a,StpPrdInf b 
          WHERE a.payOrdNo=#{payOrdNo} and a.payOrdNo=b.payOrdNo ${custdesc}
      </sql>
      <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
          SELECT TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'FM9999,999,999,990.00') AC_BAL FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{CUST_ID}||'01'
      </sql>
      <process>
           <set name="ConfigName"    value="SecCfg"/>
           <quote name="ReadXmlCfg"/>
           <set name="_REQUESTATTR.FORWARDURL"  expr="reqErrPage"/>
           
           <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="01001"/>
               <set name="RspMsg"    value="非法请求，系统拒绝处理"/>
               <return/>
           </if>
           <set name="payOrdNo"    expr="payOrdNo"/>
           <if condition="OR(ISNULL(payOrdNo),IS_EQUAL_STRING(payOrdNo,''))">
               <set name="RspCod"        value="02000"/>
               <set name="RspMsg"        value="获取订单数据出现问题，请登录后重试！"/>
               <return/>
           </if>
           
           <set name="CustCODE"  expr="SESSIONS.USRID"/>     <!--客户编号-->
           <if condition="OR(ISNULL(CustCODE),IS_EQUAL_STRING(CustCODE,''))">
              <set name="custdesc" value=""/>
           </if>
           <else>
              <set name="custdesc"   expr="STRCAT('and b.cust_id =\'',CustCODE,'\'')"/>
           </else>
           <!--查询订单信息-->
           <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd" sql="QryURL" />
           </do>
           <if condition="#RetCod==2">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09000"/>
               <set name="RspMsg"    value="系统拉取订单信息失败，原因：请求错误或登录超时！"/> 
               <return/> 
           </if>
           <elseif condition="#RetCod!=0">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="02000"/>
               <set name="RspMsg"    value="获取订单数据出现问题，请登录后重试！"/>
               <return/> 
           </elseif>
           <set name="sucAmt"             expr="AMTADDDOT(TXAMT)"/>
           <set name="sucDat"             expr="FMTDATE(SUBSTR(ActDat,1,8),0,4)"/>
           <set name="CUST_ID"            expr="CUST_ID"/>
           <set name="OrdStatus"          expr="OrdStatus"/>
           <if condition="AND(IS_NOEQUAL_STRING(CUST_ID,''),NOT(ISNULL(CUST_ID)))">
               <!-- 查询用户可用余额 -->
               <do func="ReadRecord" error="IGNORE">
                   <para name="SqlCmd" sql="SelAccBal" />
               </do>
               <if condition="#RetCod!=0">
                   <set name="MsgTyp"    value="E"/>
                   <set name="RspCod"    value="09000"/>
                   <set name="RspMsg"    value="获取交易结果数据错误，请稍后再试！"/> 
                   <return/> 
               </if>
           </if>
           <set name="AC_BAL"        expr="AC_BAL"/>
           <set name="PrdOrdType"    expr="PrdOrdType"/>
           <set name="PrdOrdNo"      expr="PrdOrdNo"/>
           <set name="OrdStatus"     expr="OrdStatus"/>
           
           <!-- 付款成功 -->
           <if condition="OR(IS_EQUAL_STRING(OrdStatus,'01'),IS_EQUAL_STRING(OrdStatus,'12'))">
              <if condition="OR(IS_EQUAL_STRING(PrdOrdType,'1'),IS_EQUAL_STRING(PrdOrdType,'3'))">
                  <set name="POSTURL"  expr="RegSucPage"/>
                  <if condition="OR(ISNULL(CUST_ID),IS_EQUAL_STRING(CUST_ID,''))">
                      <set name="POSTURL"  expr="onlineRegSucPage"/>
                  </if>
              </if>
              <elseif condition="OR(IS_EQUAL_STRING(PrdOrdType,'0'),IS_EQUAL_STRING(PrdOrdType,'2'))">
                 <set name="STORE_NAME"    expr="STORE_NAME"/>
                 <set name="ACTDAT_FMT"    expr="ACTDAT_FMT"/>
                 <set name="POSTURL"       expr="PaySucPage"/>
                 <if condition="OR(ISNULL(CUST_ID),IS_EQUAL_STRING(CUST_ID,''))">
                    <set name="POSTURL"  expr="onlinePaySucPage"/>
                 </if>
              </elseif>
              
           </if>
           <!-- 付款失败 -->
           <else>
               <if condition="IS_EQUAL_STRING(PrdOrdType,'1')">
                   <set name="POSTURL"  expr="RegErrPage"/>
               </if>
               <else>
                   <set name="POSTURL"  expr="PayErrPage"/>
               </else>
               <!-- 获取错误信息 -->
               <set name="PAYRET"    expr="PAYRET"/>
               <if condition="IS_EQUAL_STRING(PAYRET,'00')">
                   <set name="RSPMSG"    value="该交易结果处理未知，请稍后使用交易管理查询交易结果!"/> 
               </if>
               <else>
                   <if condition="IS_EQUAL_STRING(OrdStatus,'00')">
                       <set name="RSPMSG"    value="该交易结果处理未知，请稍后使用交易管理查询交易结果!"/> 
                   </if>
                   <elseif condition="IS_EQUAL_STRING(OrdStatus,'05')">
                       <set name="RSPMSG"    value="该笔订单已退款"/> 
                   </elseif>
                    <elseif condition="IS_EQUAL_STRING(OrdStatus,'09')">
                       <set name="RSPMSG"    value="该笔订单已撤销"/> 
                   </elseif>
                   <else>
                       <set name="RSPMSG"    value="未知错误！"/>
                   </else>
               </else>
           </else>
           
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="00000"/>
           <set name="_REQUESTATTR.FORWARDURL"  expr="POSTURL"/>
           
           <set name="signType"        value="CFCA"/><!--系统不兼容两种，直接写死-->
           <if condition="IS_EQUAL_STRING(signType,'CFCA')">
               <set name="ConfigName"    value="CFCACertCfg"/>
               <quote name="ReadXmlCfg"/>
               
               <set name="NOTIFYTYP"    value="0"/>
               <set name="inStr"        expr="STRCAT('merchantId=',merNo,'&amp;orderId=',prdOrdNo,'&amp;settleDate=',actDat,
                   '&amp;ordStatus=',ordStatus,'&amp;notifyTyp=',notifyTyp,'&amp;payOrdNo=',payOrdNo,'&amp;orderAmt=',txAmt,'&amp;signType=',signType)"/>   
               <do func="CFCASign">
                  <para name="certPath"    expr="STRCAT(GETCURAPPHOME(),selfPublicKeyPath)"/>
                  <para name="password"     expr="selfPublicKeyPwd" />
                  <para name="sourceData" expr="inStr" />
               </do>
               <if condition="#RetCod!=0">
                  <set name="RspCod"    value="08038"/>
                   <set name="RspMsg"    value="签名失败！"/>
                   <return/>
                </if>
                <set name="signature"    expr="CFCASIGNATURE"/>   
           </if>
           <elseif condition="IS_EQUAL_STRING(signType,'ZJCA')">
               <set name="CFCAPWD"      value="12345678"/>
               <set name="NOTIFYTYP"    value="0"/>
               <set name="inStr"        expr="STRCAT('merchantId=',merNo,'&amp;orderId=',prdOrdNo,'&amp;settleDate=',actDat,
                   '&amp;ordStatus=',ordStatus,'&amp;notifyTyp=',notifyTyp,'&amp;payOrdNo=',payOrdNo,'&amp;orderAmt=',txAmt,'&amp;signType=',signType)"/>   
               <do func="CaSign">
                  <para name="sourceData" expr="inStr" />
                  <para name="pfxPath"    expr="STRCAT(GETCURAPPHOME(),'/key/',merNo,'.pfx')"/>
                  <para name="pfxPwd"     expr="CFCAPWD" />
               </do>
               <if condition="#RetCod!=0">
                  <set name="RspCod"    value="08038"/>
                   <set name="RspMsg"    value="签名失败！"/>
                   <return/>
                </if>
                <set name="signature"    expr="sign"/>   
           </elseif>
           
    </process>
   </transaction>
   
   <transaction code="565109"        desc="支付订单结果处理-农行回调">
      <sql name="QryURL"> <!--查询通知商城的URL -->
        SELECT a.NotifyUrl,a.PrdOrdNo,a.OrdStatus,a.PRDNAME,a.MERREMARK,a.PrdOrdType,a.payType,a.MulType,a.txamt,a.accAmt,a.mulAmt,a.merno,
               a.bankCod bnkCod,a.CUST_ID,a.ActDat,b.retUrl tradeCode 
          FROM StpPayInf a,StpPrdInf b 
         WHERE a.payOrdNo=#{payOrdNo} and a.payOrdNo=b.payOrdNo
      </sql>
      <sql name="UpdReg"> <!-- 更新充值订单表 -->
         prdordno=#{PrdOrdNo}
      </sql>  
      <sql name="UpdPay"> <!-- 更新支付订单表 -->
         payOrdNo=#{payOrdNo}
      </sql>
      <sql name="UpdPrd"> <!-- 更新商品订单表 -->
         prdOrdNo=#{prdOrdNo} and merNo=#{merno} 
      </sql> 
      <sql name="QryPrdInf"> <!-- 查询商品订单 -->
         SELECT bizType from StpPrdInf where prdordno=#{prdordno} and merno=#{merno}
      </sql>
      <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
         SELECT CASH_AC_BAL,FROZ_BALANCE FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNO}
      </sql>
      <sql name="SelBnkFee"><!-- 查询银行费率信息-->
         SELECT FEE_CODE FROM CoopBank WHERE BANK_CODE=#{bnkCod}
      </sql> 
      <sql name="SelBnkMerFee"><!-- 查询银行商户费率信息-->
         SELECT FEE_CODE FROM COOPBANK_FEE WHERE BANK_CODE=#{bnkCod} and BANK_MERNO=#{BnkMerNo}
      </sql>   
      <sql name="SelMerFee">
         SELECT fee_code from ARP_CUST_FEE where pay_ac_no in (select pay_ac_no from arp_ac_cust_rel where CUST_ID=#{merNo}) and biz_type=#{bizType} and pay_type=#{payType}
      </sql>
      <sql name="SelCusAcc">
         SELECT pay_ac_no from arp_ac_cust_rel  where CUST_ID=#{CUST_ID}
      </sql>
      <process>
         <!-- 农行返回结果 -->
         <do func="AbcReturn">                              
           <para name="msg"      expr="MSG"/>
         </do>
         <if condition="#RetCod!=0">
           <set name="RspCod"    value="09006"/>
           <set name="RspMsg"    value="获取农行支付返回信息有误!"/>
           <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/>
           <return/>
         </if>
         <if condition="ISNULL(payOrdNo)">
            <set name="payOrdNo"    expr="orderNo"/>        <!-- 取农行返回的订单号-->
         </if>  
         
         <!--对同一个订单号进行加锁-->
         <do func="Lock">
            <para name="RecKey"     expr="payOrdNo" />
            <para name="AutoUnLock" value="yes" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="08001"/>
            <set name="RspMsg"    value="银行处理中，请稍候！"/>
            <set name="_REQUESTATTR.FORWARDURL"  value="cashier/html/result/bakfals.jsp"/>
            <return/>
         </if> 
         
         <set name="ordAmt1"       expr="AMTPOWER(Amount,2)"/> <!--商品订单金额 更新商品订单表使用-->
         <set name="ordAmt"        expr="ordAmt1"/>
         <set name="TraceTime"     expr="GETDATETIME()"/>   <!-- 支付成功时间  -->
         <set name="orderTime"     expr="GETDATETIME()"/>
         <!--查询URL-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryURL" />             <!-- 根据订单号查询对应支付订单信息 -->
         </do>
         <if condition="#RetCod!=0">                        <!-- 订单查询失有误就直接退出-->
            <set name="RspCod"    value="08001"/>
            <set name="RspMsg"    value="该支付订单信息不存在"/>
            <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/>
            <return/>
         </if>
         <set name="sucDat"          expr="FMTDATE(SUBSTR(actdat,1,8),0,4)"/>
         <set name="sucAmt"          expr="ordAmt1"/>
         <set name="OrdTime"         expr="GETDATETIME()"/> 
        
         <if condition="OR(IS_EQUAL_STRING(OrdStatus,'01'),IS_EQUAL_STRING(OrdStatus,'12'))"> 
            <set name="RspCod"      value="00000"/>
            <set name="RspMsg"      value="交易成功"/>
            <set name="NXTPAG"      expr="succePage"/>   
            <set name="sucAmt"      expr="AMTADDDOT(TXAMT)"/>
            <set name="_REQUESTATTR.FORWARDURL"       expr="NXTPAG"/>    
            <return/>
         </if>
         <!--判断金额是否与支付订单中的金额一致-->
         <if condition="IS_EQUAL_STRING(payType,'04')">
            <if condition="IS_NOEQUAL_STRING(mulAmt,ordAmt1)">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="08016"/>
               <set name="RspMsg"    value="订单金额与应支付金额不符"/>
               <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/>
               <return/>
            </if>
         </if>
         <else>
            <if condition="IS_NOEQUAL_STRING(txamt,ordAmt1)">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="08016"/>
               <set name="RspMsg"    value="订单金额与应支付金额不符"/>
               <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/>
               <return/>
            </if>   
         </else>
         
         <set name="payacno"        expr="SESSIONS.PAYACNO"/>  
         <if condition="ISNULL(payacno)">
            <!--查询客户账户-->
            <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd" sql="SelCusAcc"/>
            </do>
            <if condition="#RetCod==2">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="07009"/>
               <set name="RspMsg"    value="该用户账户信息不存在"/> 
               <set name="DWZ_STATUS_CODE"     value="300"/>
               <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
               <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/>
               <return/> 
            </if> 
            <elseif condition="#RetCod!=0">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09999"/>
               <set name="RspMsg"    value="系统错误"/>
               <set name="DWZ_STATUS_CODE"     value="300"/>
               <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
               <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/>
               <return/> 
            </elseif>
            <set name="payacno" expr="pay_ac_no"/>
         </if>
         
         <quote name="ABCRetcl"/>                           <!-- 处理银行返回值 -->
         <!-- 农行信息处理完毕 -->
         
         <set name="BANKCODE" expr="bnkCod"/>
         <!--查询账户余额-->
         <quote name="selAccBal"/> 
         <if condition="IS_EQUAL_STRING(PrdOrdType,'0')">                   <!-- 消费-直接支付  -->  
            <set name="NotifyTyp"    value="0"/>
            <set name="#url"         expr="NotifyUrl" />                    <!-- 同步返回 URL  -->
            
            <if condition="IS_NOEQUAL_STRING(PayRet,'00')">
               <set name="RspCod"       expr="RspCod"/>
               <set name="Status"       value="2"></set>
               <quote name="UpdPay"/>

               <quote name="UpdPrd"/>

               <quote name="TimeTouch2"/>
               <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/>  
               <return/>
            </if>
            
            <if condition="ISNULL(merRemark)">
               <set name="merRemark"         value="商物通"/>
            </if>
            <set name="OrdStatus"    value="01"/>
            <set name="Status"       value="1"/>
            <set name="acDate"       expr="GETDATE()"/>                             <!--清算日期-->
            <set name="acTime"       expr="GETDATETIME('HHMISS')"/>                 <!--清算时间-->
            
            <!--计算商户手续费--> 
            <quote name="CalMerFee"/>
            
            <!--记账处理 start-->
            <if condition="IS_EQUAL_STRING(payType,'01')">                          <!--网银支付-->
               <set name="txnAmt_fee"    expr="txAmt"/>
               <set name="BnkJnl"         expr="payordnoliu"/>
               <set name="bankJrnNo"      expr="payordnoliu"/>                        <!--银行返回订单号,银行流水号--> 
               <set name="Tran_type"      value="1"/>                                 <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合-->
               
               <!--记账所需数据-->
               <set name="ACC_TYP"    value="01"/>               <!--现金账户-->
               <set name="DR_CR_FLAG" value="+"/>                <!--账户余额增减标识 + 增加 - 减少-->
               <set name="CCY"        value="CNY"/>              <!--货币类型-->
               <set name="AMT"        expr="TXAMT"/>             <!--金额-->
               <set name="IS_ACT"     value="Y"/>                <!--是否实时记账 Y 是 N 否-->
               
               <if condition="IS_EQUAL_STRING(flag,'1')">        <!--有手续费-->
                  <set name="merPar"     expr="STRCAT(MERNO,'/',ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                  <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                  <set name="PARAMS"     expr="STRCAT(merPar,',',feePar)"/>
               </if>
               <else>                                            <!--无手续费-->
                  <set name="merPar"     expr="STRCAT(MERNO,'/',ACC_TYP,'/','+','/',CCY,'/',AMT,'/',IS_ACT,'/')"/>        <!--商户记账参数-->
                  <set name="PARAMS"     expr="merPar"/>
               </else>
            </if>
            <elseif condition="AND(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(MulType,'01'))">    <!--混合支付-->
               <set name="txnAmt_fee"    expr="mulAmt"/>
               <set name="bankJrnNo"     expr="payOrdNo"/>                         <!--银行返回订单号--> 
               <set name="Tran_type"     value="5"/>                               <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合--> 
               
               <if condition="ISNULL(CASH_AC_BAL)">
                 <set name="CASH_AC_BAL" value="0"/>
               </if>
               <if condition="ISNULL(FROZ_BALANCE)">
                 <set name="FROZ_BALANCE" value="0"/>
               </if>
               <set name="casBal"     expr="SUB(CASH_AC_BAL,FROZ_BALANCE)"/>
               
               <!--记账所需数据-->
               <set name="ACC_TYP"    value="01"/>               <!--现金账户-->
               <set name="CCY"        value="CNY"/>              <!--货币类型-->
               <set name="IS_ACT"     value="Y"/>                <!--是否实时记账 Y 是 N 否-->
               <set name="usrPar"     expr="STRCAT(CUST_ID,'/',ACC_TYP,'/','-','/',CCY,'/',ACCAMT,'/',IS_ACT,'/')"/>  <!--用户记账参数-->
               
               <if condition="DOUBLECMP(casBal,5,ACCAMT)">        <!--现金账户-->
                  <if condition="IS_EQUAL_STRING(flag,'1')">   <!--有手续费-->
                     <set name="merPar"     expr="STRCAT(MERNO,'/',ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                     <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                     <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar,',',feePar)"/>
                  </if>
                  <else>                                       <!--无手续费-->
                     <set name="merPar"     expr="STRCAT(MERNO,'/',ACC_TYP,'/','+','/',CCY,'/',txAmt,'/',IS_ACT,'/')"/>      <!--商户记账参数-->
                     <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar)"/>
                  </else>
               </if>
            </elseif>

            <set name="TRANTYPE"     value="2"/>                                    <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->  
            <set name="TRANWAY"      value="01"/>                                   <!--01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
            <set name="CCODE"        expr="merNo"/>                                 <!--商户编号-->
            <set name="CNAME"        expr="MERREMARK"/>          
            
            <set name="TXN_TYP"      value="2"/>      <!--用途 消费-->  
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="07005"/>
               <set name="RspMsg"    value="支付失败"/>
              
               <set name="DWZ_STATUS_CODE"     value="300"/>
               <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
               <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/>
               <return/>
            </if>
            <!--记账处理 end-->
            
            <!--计算银行手续费-->
            <quote name="CalBnkFee"/>
            
            <quote name="UpdPrd"/>

            <set name="SmsContent"    expr="STRCAT('您好，您在',merRemark,'消费金额：',AMTADDDOT(txAmt),'元，通过商物通付款成功，如有疑问请联系',merRemark,'。')"></set>
            <quote name="sendSms"/>
            <quote name="UpdPay"/>        <!--更新支付订单表-->
            
            <quote name="TimeTouch2"/>    <!--通知商城--> 
            <set name="_REQUESTATTR.FORWARDURL"  expr="STRCAT(payResult,'?payordno=',payOrdNo)"/>
         </if>
         <elseif condition="IS_EQUAL_STRING(PrdOrdType,'2')">               <!-- 消费-担保支付  -->  
            <set name="NotifyTyp"    value="0"/>
            <set name="#url"         expr="NotifyUrl" />                    <!-- 同步返回 URL  -->
            
            <if condition="IS_NOEQUAL_STRING(PayRet,'00')">
               <set name="RspCod"       expr="RspCod"/>
               <set name="Status"       value="2"></set>
               <quote name="UpdPay"/>

               <quote name="UpdPrd"/>

               <quote name="TimeTouch2"/>
               <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/>  
               <return/>
            </if>
            
            <if condition="ISNULL(merRemark)">
               <set name="merRemark"         value="商物通"/>
            </if>
            <set name="OrdStatus"    value="12"/>
            <set name="Status"       value="1"/>
            <set name="acDate"       expr="GETDATE()"/>                             <!--清算日期-->
            <set name="acTime"       expr="GETDATETIME('HHMISS')"/>                 <!--清算时间-->

            <!--记账处理 start-->
     
            <!--计算商户手续费--> 
            <quote name="CalMerFee"/>
           
            <if condition="IS_EQUAL_STRING(payType,'01')">                          <!--网银支付-->
               <set name="txnAmt_fee"     expr="txAmt"/>               
               <set name="BnkJnl"         expr="payordnoliu"/>
               <set name="bankJrnNo"      expr="payordnoliu"/>                       <!--银行返回订单号--> 
               <set name="Tran_type"      value="1"/>                                <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合-->
               
               <!--记账参数准备-->
               <set name="pltMidPar"      expr="STRCAT('99999900000001','/','04','/','+','/','CNY','/',txAmt,'/','N','/')"/>        <!--平台担保账户记账参数-->
               <set name="PARAMS"         expr="pltMidPar"/>
            </if>
            <elseif condition="AND(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(MulType,'01'))">    <!--混合支付-->
               <set name="txnAmt_fee"    expr="mulAmt"/>
               <set name="bankJrnNo"     expr="payordnoliu"/>                         <!--银行返回订单号--> 
               <set name="Tran_type"     value="5"/>                                  <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合--> 
               
               <if condition="ISNULL(CASH_AC_BAL)">
                 <set name="CASH_AC_BAL" value="0"/>
               </if>
               <if condition="ISNULL(FROZ_BALANCE)">
                 <set name="FROZ_BALANCE" value="0"/>
               </if>
               <set name="casBal"     expr="SUB(CASH_AC_BAL,FROZ_BALANCE)"/>
               
               <if condition="DOUBLECMP(casBal,5,ACCAMT)">          <!--现金账户-->
                  <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','-','/','CNY','/',ACCAMT,'/','Y','/')"/>            <!--用户记账参数-->
                  <set name="pltMidPar"  expr="STRCAT('99999900000001','/','04','/','+','/',CCY,'/',txAmt,'/','N','/')"/>      <!--平台担保账户记账参数-->
                  <set name="PARAMS"     expr="STRCAT(usrPar,',',pltMidPar)"/> 
               </if>
            </elseif>

            <set name="TRANTYPE"     value="2"/>                                    <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->  
            <set name="TRANWAY"      value="01"/>                                   <!--01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
            <set name="CCODE"        expr="merNo"/>                                 <!--商户编号-->
            <set name="CNAME"        expr="MERREMARK"/>          
            
            <set name="TXN_TYP"      value="2"/>      <!--用途 消费-->  
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="07005"/>
               <set name="RspMsg"    value="支付失败"/>
               <set name="DWZ_STATUS_CODE"     value="300"/>
               <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
               <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/>
              
               <return/>
            </if>
            <!--记账处理 end-->
            
            <!--计算银行手续费-->
            <quote name="CalBnkFee"/>
            
            <quote name="UpdPrd"/>

            <set name="SmsContent"    expr="STRCAT('您好，您在',merRemark,'消费金额：',AMTADDDOT(txAmt),'元，通过商物通付款成功，如有疑问请联系',merRemark,'。')"></set>
            <quote name="sendSms"/>
   
            <quote name="UpdPay"/>        <!--更新支付订单表-->
            
            <quote name="TimeTouch2"/>    <!--通知商城--> 
            <set name="_REQUESTATTR.FORWARDURL"  expr="STRCAT(payResult,'?payordno=',payOrdNo)"/>
         </elseif>
         <elseif condition="IS_EQUAL_STRING(PrdOrdType,'1')">               <!-- 充值  -->
            <if condition="IS_NOEQUAL_STRING(PayRet,'00')">
               <set name="RspCod"       expr="RspCod"/>
               <set name="Status"       value="2"/>
               <quote name="UpdPay"/>
               <quote name="UpdReg"/>               <!--  更新充值订单  -->
               <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/>  
               <return/>
            </if>
            
            <set name="acDate"  expr="GETDATE()"/>              <!--清算日期-->
            <set name="acTime"  expr="GETDATETIME('HHMISS')"/>  <!--清算时间-->    
            
            <set name="feeFlag" value="0"/>      <!--充值手续费收取标识   1 收取   0 不收 -->
            <if condition="IS_EQUAL_STRING(feeFlag,'1')">
               <set name="txnAmt_fee"    expr="txAmt"/>
            </if>
            <else>
               <set name="flag"           value="0"/> 
               <set name="fee"            value="0"/>   
               <set name="usrPar"         expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',txAmt,'/','Y','/')"/>  <!--用户记账参数-->
               <set name="PARAMS"         expr="usrPar"/>
            </else>
            <set name="netRecAmt"      expr="SUB(txAmt,fee)"/>                  <!--净额-->  

            <!--记账处理-->  
            <set name="TXN_TYP"      value="1"/>      <!--用途 充值-->  
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="07005"/>
               <set name="RspMsg"    value="充值失败"/>
               <return/>
            </if>
            
            <!--计算银行手续费-->
            <quote name="CalBnkFee"/>
            
            <set name="TRANTYPE"       value="1"/>                  <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
            <set name="TRANWAY"        value="01"/>                 <!--交易方式 01网银、02终端、03消费卡、04虚拟账户、05快捷支付--> 
            <set name="TXCCY"          value="CNY"/>
            <set name="payType"        value="01"/>
            <quote name="UpdReg"/>               <!--  更新充值订单  --> 
            <quote name="UpdPay"/>               <!--  更新支付订单  --> 

            <set name="NXTPAG"         expr="succePage"/>     
            <set name="merRemark"      value="商物通"/> <!-- 商户信息 -->
            <set name="_REQUESTATTR.FORWARDURL"       expr="RegSucPage"/>    <!--异步通知页面-->
         </elseif>
         <else>
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09001"/>
            <set name="RspMsg"    value="系统错误"/>
            <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/>
            <return/>   
         </else>
         
         <!--通知风控系统登记订单信息-->
         <set name="ServiceCode" value="680517"/>
         <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
         <set name="TCODE"       expr="payOrdNo"/>           <!--平台流水号 支付订单号-->
         <set name="CTYPE"       value="1"/>                 <!--客户类型-->
         <set name="CLIENTCODE"  expr="SESSIONS.USRID"/>     <!--客户编号-->
         <set name="CLIENTNAME"  expr="SESSIONS.USRNAME"/>
         <set name="MOBILEPHONE" expr="SESSIONS.USRMP"/>
         <set name="TAMT"        expr="txAmt"/>
         <set name="REGDTTIME"   expr="STRCAT(acDate,acTime)"/>
         <set name="Time"        expr="acDate"/>
         <quote name="noticRcs"/>
         
         <set name="sucAmt"         expr="AMTADDDOT(TXAMT)"/>
         <set name="RspCod"         value="00000"/>
         <set name="RspMsg"         value="支付成功"/>
      </process>
   </transaction>
    
   <transaction code="565104"        desc="支付结果通知 沃支付回调">
      <sql name="QryMerNo"> <!--查询商品订单表是否有该订单 -->
        select * from stpprdinf where Payordno=#{orderNo}
      </sql>
      <sql name="QryPayOrd"> <!--查询支付订单信息 -->
        select * from stppayinf where Payordno=#{orderNo}
      </sql>
      <sql name="updatePayNo"><!--更新支付订单表订单状态-->
        update stppayinf set OrdStatus=#{OrdStatus},bankJrnNo=#{bankJrnNo},Filed5=#{Filed5},fee=#{fee},NETRECAMT=#{NETRECAMT} WHERE Payordno=#{orderNo}
      </sql>
      <sql name="updateMerNo"><!--更新支付订单表订单状态-->
        update stpprdinf set OrdStatus=#{OrdStatus},acdate=#{acdate},actime=#{actime},txnComAmt=#{fee}  WHERE Payordno=#{orderNo}
      </sql>
      <sql name="QryBnkSubject"> <!--查询合作银行表-->
        SELECT REC_SUB_CODE AS GL_CODE  FROM  CoopBank WHERE BANK_CODE='${BANKCODE}' and BANK_STATUS = '0'
      </sql>
      <sql name="QryCusInf"><!-- 查询客户信息-->
         SELECT CUST_STATUS,CUST_TYPE  FROM StpCusInf WHERE CUST_ID=#{USERID} 
      </sql>
      <sql name="QryPayInf"> <!--查询客户支付信息 直接支付 -->
        SELECT distinct #{seqno2} ACC_SEQ,'' ACC_SUBJECT,b.PAY_AC_NO PAY_AC_NO, #{netRecAmt} TXN_AMT,'' OPP_ACC_NO,'CNY' CCY,'C' DR_CR_FLAG,'I' OPP_ACC_SIGN FROM StpPayInf a,ARP_AC_CUST_REL b,ARP_AC_PROFILE c WHERE a.payordno=#{payordno} and trim(b.CUST_ID)=trim(a.MerNo) and trim(b.PAY_AC_NO)=trim(c.PAY_AC_NO) 
        union
        SELECT #{seqno1} AdCC_SEQ,#{ACC_SUBJECT} ACC_SUBJECT,'' PAY_AC_NO, a.txAmt TXN_AMT,'' OPP_ACC_NO,'CNY' CCY,'D' DR_CR_FLAG,'I' OPP_ACC_SIGN FROM StpPayInf a WHERE a.payordno=#{payordno}
        union
        SELECT #{seqno3} ACC_SEQ,#{ACC_SUBJECT1} ACC_SUBJECT,'' PAY_AC_NO, #{fee} TXN_AMT,'' OPP_ACC_NO,'CNY' CCY,'C' DR_CR_FLAG,'I' OPP_ACC_SIGN FROM dual a WHERE 1=${flag}
      </sql> 
      <sql name="QryPrdInf"> <!-- 查询商品订单 -->
        select bizType from StpPrdInf where prdordno=#{prdordno} and merno=#{merno}
      </sql>
      <sql name="SelMerFee">
        select fee_code from ARP_CUST_FEE where 
        pay_ac_no in 
        (select pay_ac_no from arp_ac_cust_rel 
        where CUST_ID=#{merNo}) and biz_type=#{bizType} and pay_type=#{payType}
      </sql>     
      <sql name="SelBnkFee"><!-- 查询银行费率信息-->
         SELECT FEE_CODE FROM CoopBank WHERE BANK_CODE=#{bnkCod}
      </sql> 
      <sql name="SelBnkMerFee"><!-- 查询银行商户费率信息-->
         SELECT FEE_CODE FROM COOPBANK_FEE WHERE BANK_CODE=#{bnkCod} and BANK_MERNO=#{BnkMerNo}
      </sql>
      <sql name="QrySendInf1">
        select merNo,prdordno,txamt as ordamt,OrdStatus,ActDat as paytime,'M' as signType from stppayinf where payordno=#{orderNo}
      </sql>
      <sql name="QrySendInf2">
        select filed4 as Orddate,FILED5 as  respMode,retUrl as ReturnUrl,notifyUrl as notifyUrl from stpprdinf where payordno=#{orderNo}
      </sql>  
       <sql name="QryMerMD5">
        SELECT a.MD5_SECRET_CODE_ID as MD5Key FROM StpMerInf a,StpCusInf b WHERE a.CUST_ID = b.CUST_ID AND a.CUST_ID=#{merNo}
      </sql>  
      <process>
        <set name="ConfigName" value="Ltpay"/>
        <quote name="ReadXmlCfg"/>
        <set name="Key"       expr="merchantSignKey"/>
        <set name="merno1"    expr="merno"/>
        <set name="_REQUESTATTR.FORWARDURL"   expr="errorPage"/>
        <!-- 测试    -->
        <set name="retmsg" value="SUCCESS"/>
        <set name="XmlFlag" value="2"/>
        <!-- 测试    -->
        <!--查询沃支付信息-->
        <do func="TdOrderPay"     error="IGNORE">
        </do>
        <if condition="#RetCod!=0">
           <set name="RspCod"         value="09997"/>
           <set name="RspMsg"         value="验签失败"/>   
           <return/>
        </if> 
        <set name="MsgTyp"    value="N"/>
        <set name="RspCod"    value="00000"/>
        <set name="RspMsg"    value="交易成功"/>
         
        <!--检查商户订单号是否为空-->      
        <if condition="IS_EQUAL_STRING(orderNo,'')">
           <set name="RspCod"    value="06021"/>
           <set name="RspMsg"    value="商品订单号不能为空!"/>
           <return/>
        </if>
             
        <!--查询商品订单是否存在-->
        <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="QryMerNo" />
        </do>
        <if condition="#RetCod!=0">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="08001"/>
           <set name="RspMsg"    value="该商品订单信息不存在"/>
           <return/>
        </if>
        
        <!--查询支付订单是否存在-->
        <do func="ReadRecord" error="IGNORE">           
           <para name="SqlCmd"   sql="QryPayOrd"/>
        </do>
        <if condition="#RetCod==2">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="08001"/>
           <set name="RspMsg"    value="该支付订单信息不存在"/>
           <return/>
        </if>
        <elseif condition="#RetCod!=0">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="09998"/>
           <set name="RspMsg"    value="系统错误"/>
           <return/>
        </elseif> 
        
        <!--记录用户系统主要交易实时日志-->
        <set name="RCS_USER_CODE"       expr="CUST_ID"/><!--用户ID-->
        <set name="RCS_PAY_TYPE"        value="800019"/><!--本次交易码，订单支付-->
        <set name="RCS_PRD_NO"          expr="prdOrdNo"/><!--订单号，如果不涉及置空-->
        
        <!--  判断订单金额是否一致 -->
        <if condition="IS_NOEQUAL_STRING(amount,ordAmt)">
           <set name="MsgTyp"    value="E"/>
           <set name="RspCod"    value="08016"/>
           <set name="RspMsg"    value="订单金额与应支付金额不符"/>
           
           <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/>
           <return/>
        </if>
        <!--  判断是否已经支付成功 -->
        <if condition="IS_EQUAL_STRING(ordstatus,'01')">
           <set name="MsgTyp"    value="N"/>
           <set name="RspCod"    value="00000"/>
           <set name="RspMsg"    value="订单已经付款成功"/>
           <set name="retmsg"    value="SUCCESS"/>
           <set name="XmlFlag"   value="2"/>
           <set name="_REQUESTATTR.FORWARDURL"  expr="succePage"/>
           <return/>
        </if>
        <set name="acDate"       expr="GETDATE()"/>                             <!--清算日期-->
        <set name="acTime"       expr="GETDATETIME('HHMISS')"/>                 <!--清算时间-->
        <set name="transRst"     expr="transRst"></set> 
         <!--比较订单状态是否相等-->
         <if condition="INTCMP(transRst,3,01)">
          
            <set name="ordstatus"      value="01"/>
            <!--查询银行相应科目-->
            <quote name="selBnkSubject"/>
            <set name="seqno1"      value="001"/>  
            <set name="seqno2"      value="002"/>  
            <set name="seqno3"      value="003"/>  
            <set name="seqno4"      value="004"/>
            <set name="seqno5"      value="005"/>
            <quote name="selMerTyp"/>
            <!--查询商户业务类型-->
            <quote name="SelMerBiz"/>
            <quote name="CalMerFee"/>
            <set name="txnAmt_fee"    expr="txAmt"/>
            <set name="merfee"        expr="fee"/>
            <!--计算第三方支付公司手续费-->
            <quote name="SelBnkFee"/>
            <if condition="#RetCod==0">
               <if condition="NOT(ISNULL(FEE_CODE))">
                  <set name="merfee"        expr="fee"/>
                  <quote name="FeeCount"/> 
                  <set name="feeBnk"        expr="fee"/>
               </if> 
            </if>
            <set name="fee"          expr="merfee"/>
            <!--记账处理 start-->
            <set name="ACC_SUBJECT" expr="gl_code"/>                                <!--科目-->
            <if condition="IS_EQUAL_STRING(flag,'1')">
               <set name="TXN_SUB_COD"      value="002"/>     <!--交易子码 有手续费--> 
               <set name="ACC_SUBJECT1"     value="6021010000"/>
            </if>
            <else>
               <set name="TXN_SUB_COD"      value="001"/>     <!--交易子码 无手续费-->
               <set name="ACC_SUBJECT1"     value=""/> 
            </else>
            <!--set name="TXN_SUB_COD"      value="001"/-->
            <do func="QueryInGroup" error="IGNORE">
               <para name="SqlCmd"      sql="QryPayInf" />
               <para name="RecordName"  value="ACC_GROUP" />
            </do>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="07001"/>
               <set name="RspMsg"    value="支付失败"/>
               <return/>
            </if>
            <set name="TRANTYPE"     value="2"/>                                    <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->  
            <set name="TRANWAY"      value="01"/>                                   <!--01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
            <set name="CCODE"        expr="merNo"/>                                 <!--商户编号-->
            <set name="CNAME"        expr="MERREMARK"/>          
            <set name="TXN_COD"      value="880101"/>                               <!--交易码 用户支付-->
            <set name="NOTENUM"      expr="RECNUM"/>                                <!--传票数-->
            <set name="TXN_TLR"      expr="merNo"/>                               <!--柜员号-->
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="07005"/>
               <set name="RspMsg"    value="支付失败"/>
               <set name="DWZ_STATUS_CODE"     value="300"/>
               <set name="DWZ_RSP_MSG"         expr="RspMsg"/>
               <set name="_REQUESTATTR.FORWARDURL"  expr="errorPage"/>
               <return/>
            </if>
            <!--记账处理 end-->
             
             <do func="ExecSql" error="error">
              <para name="SqlCmd"  sql="updateMerNo" />
             </do>
             <if condition="#RetCod!=0">
                <set name="RspCod"    value="09024"/>     
                <set name="RspMsg"    value="更新商品订单状态失败!"/>
                <return/>
             </if>
             <else>
                <set name="RspCod"    value="00000"/>     
                <set name="RspMsg"    value="更新商品订单状态成功!"/>
             </else>
           
             <!-- 联通沃返回的支付流水号 -->
             <set  name="bankJrnNo"     expr="payJnlno"/>
             <set  name="BnkJnl"        expr="payJnlno"/>
             <set  name="BnkDat"        expr="SUBSTR(payTime,1,8)"/>
             <set  name="Filed5"        expr="payBankCode"/>
             <do func="ExecSql" error="error">
              <para name="SqlCmd"  sql="updatePayNo" />
             </do>
             <if condition="#RetCod!=0">
                <set name="RspCod"    value="09024"/>     
                <set name="RspMsg"    value="更新商品订单状态失败!"/>
                <return/>
             </if>
             <else>
                <set name="RspCod"    value="00000"/>     
                <set name="RspMsg"    value="更新商品订单状态成功!"/>
             </else>
             <!--通知风控系统登记订单信息-->
             <set name="ServiceCode" value="680517"/>
             <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
             <set name="TCODE"       expr="payOrdNo"/>           <!--平台流水号 支付订单号-->
             <set name="CTYPE"       value="1"/>                 <!--客户类型-->
             <set name="CLIENTCODE"  expr="SESSIONS.USRID"/>     <!--客户编号-->
             <set name="CLIENTNAME"  expr="SESSIONS.USRNAME"/>
             <set name="MOBILEPHONE" expr="SESSIONS.USRMP"/>
             <set name="TAMT"        expr="txAmt"/>
             <set name="REGDTTIME"   expr="STRCAT(acDate,acTime)"/>
             <set name="Time"        expr="acDate"/>
             <quote name="noticRcs"/>
             
             <set name="retmsg" value="SUCCESS"/>
             <set name="XmlFlag" value="2"/>
             <!-- 通知商户 -->
             <!--查询通知商户时需要的信息-->
             <do func="ReadRecord" error="IGNORE">
                 <para name="SqlCmd" sql="QrySendInf1" />
              </do>
              <if condition="#RetCod!=0">
                 <set name="MsgTyp"    value="E"/>
                 <set name="RspCod"    value="08001"/>
                 <set name="RspMsg"    value="该支付订单信息不存在"/>
                 <return/>
              </if>
              <do func="ReadRecord" error="IGNORE">
                 <para name="SqlCmd" sql="QrySendInf2" />
              </do>
              <if condition="#RetCod!=0">
                 <set name="MsgTyp"    value="E"/>
                 <set name="RspCod"    value="08001"/>
                 <set name="RspMsg"    value="该商品订单信息不存在"/>
                 <return/>
              </if>
              <do func="ReadRecord" error="IGNORE">
                 <para name="SqlCmd" sql="QryMerMD5" />
              </do>
              <if condition="#RetCod!=0">
                 <set name="MsgTyp"    value="E"/>
                 <set name="RspCod"    value="08001"/>
                 <set name="RspMsg"    value="该商户信息不存在"/>
                 <return/>
              </if>
             <set name="RspCod"        value="00000"/>
             <set name="RspMsg"        value="交易成功"/>
             <set name="inMsg" expr="inMsg"/>
             <!--  签名原数据 -->
             <set name="inStr"        expr="STRCAT(merNo,'|',Prdordno,'|',Ordamt,'|',Orddate,'|',OrdStatus,'|',RspCod,'|',RspMsg,'|',payordno,'|',payTime,'|',signType,'|',respMode,'|',MD5Key)"/> 
             <do func="HKMD5">
               <para name="inStr"     expr="inStr" />
             </do>
             <if condition="#RetCod!=0">
                <set name="RspCod"    value="L90003"/>
                <set name="RspMsg"    value="加签失败"/>
                <return/>
             </if> 
             <set name="signMsg"       expr="outStr"/>
             <set name="ThirdServer"   value="STHDMER"/>
             <set name="#url"          expr="notifyUrl"/>
             <!--set name="#WaitRet"      value="0"/-->
             <!--  通知商户支付结果 -->
             <if condition="IS_NOEQUAL_STRING(notifyUrl,'')">
             <do func="CallThird" error="IGNORE">
                <para name="channel"       expr="ThirdServer"/>
                <para name="code"          value="MER001"/>
             </do>
             <if condition="OR(#RetCod==1,#RetCod==10,#RetCod==-1)">
                <set name="MsgTyp"     value="E"/>
                <set name="MRspCod"    value="09991"/>
                <set name="MRspMsg"    value="通知商户失败"/>
             </if>
             <else> 
                <if condition="IS_NOEQUAL_STRING(RetCod,'SUCCESS')">
                   <!-- 发送失败重新发送-->
                   <!--do func="TranBeginWork" error="IGNORE">
                         <para name="Code"      value="MER002" />
                         <para name="T1"        value="60" />
                         <para name="FirstTms"  value="1" />
                         <para name="T2"        value="120" />
                         <para name="SecondTms" value="1"/>
                    </do-->
                   <if condition="#RetCod==0">
                     <if condition="IS_NOEQUAL_STRING(RetCod,'SUCCESS')">
                       <set name="MRspCod"    expr="RspCod"/>
                       <set name="MRspMsg"    value="通知商户失败"/>
                     </if>
                  </if>
                  <else>
                    <set name="MRspCod"    value="09991"/>
                    <set name="MRspMsg"    value="通知商户失败"/>
                  </else>
                </if>
             </else>
            </if>
          </if>
          <set name="_REQUESTATTR.FORWARDURL" expr="MerReturnUrl"/>  
         
          <!--过滤以下参数之外的其余参数 -->  
          <do func="etfFilter" error="IGNORE"> 
            <para name="filterNames"     value="retmsg|merNo|Prdordno|Ordamt|Orddate|OrdStatus|RspCod|RspMsg|payordno|payTime|signType|respMode|signMsg|_REQUESTATTR.FORWARDURL"/>
          </do>
          
      </process>
   </transaction>

   <transaction code="565129"        desc="查询商品订单信息">
      <sql name="QryPrdInf"> <!--查询商品订单信息 -->
         SELECT nvl(ordAmt,' ') AS ordAmt,nvl(prdordno,' ') AS prdordno,orderTime,prdName,nvl(prdDesc,' ') as prdDesc,prdOrdType,
         to_char(to_date(ORDERTIME,'yyyy-mm-dd hh24:mi:ss'),'yyyy-mm-dd hh24:mi:ss') as ORDERTIME,
         (select cust_name from stpcusinf where cust_id=#{merNo}) as MER_NAME FROM stpprdinf 
          WHERE prdOrdNo=#{prdOrdNo} and merNo=#{merNo} 
      </sql>
      <process>
         <!--检查用户登录平台是否正确-->
         <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台不正确"/>
            <return/>
         </if>
         
         <quote name="chkUsr"/>
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryPrdInf"/>
         </do>
         <if condition="#RetCod==2">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="无符合条件记录"/>
            <return/>
         </if>
         <elseif condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </elseif>
         
         <set name="ordAmt"        expr="AMTADDDOT(ordAmt)"/>
         <set name="USERID"        expr="SESSIONS.USRID"/>
         <set name="USRMP"         expr="SESSIONS.USRMP"/>
         <set name="LOGIN_NAME"    expr="SESSIONS.LOGIN_NAME1"/>
         <set name="MsgTyp"        value="N"/>
         <set name="RspCod"        value="00000"/>
         <set name="RspMsg"        value="交易成功"/>
      </process>
   </transaction>
   
   <transaction code="bankOrdMaintain" desc="银行订单状态维护">
       <sql name="QryPrdinf">
        select PAYRET,ORDSTATUS from stppayinf where PAYORDNO=#{PAYORDNO}
      </sql>
      <sql name="UpdPrdPayret">
          UPDATE stppayinf set PAYRET = #{PAYRET}  where PAYORDNO=#{PAYORDNO}
      </sql>
      <process>
          <!--检查用户登录平台是否正确-->
         <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台不正确"/>
            <return/>
         </if>
         <!-- 0:查询  1：更新 -->
         <set name="F"          expr="F"/>
         <if condition="IS_EQUAL_STRING(F,'0')">
          <do func="ReadRecord" error="IGNORE">
             <para name="SqlCmd" sql="QryPrdinf"/>
          </do>
          <if condition="#RetCod==2">
             <set name="MsgTyp"    value="E"/>
             <set name="RspCod"    value="01003"/>
             <set name="RspMsg"    value="无符合条件记录"/>
             <return/>
          </if>
          <elseif condition="#RetCod!=0">
             <set name="MsgTyp"    value="E"/>
             <set name="RspCod"    value="09999"/>
             <set name="RspMsg"    value="系统错误"/>
             <return/>
          </elseif>
          <set name="PAYRET"        expr="PAYRET"/>
             <set name="ORDSTATUS"     expr="ORDSTATUS"/>
   </if>
   <else>
     <set name="PAYRET"         value="00"/>
     <do func="ExecSql"  error="IGNORE"><!--更新订单状态为延迟付款审核中-->
               <para name="SqlCmd"     sql="UpdPrdPayret"/>
            </do>
            <if condition="#RetCod==2">
               <set name="RspCod"    value="01003"/>
               <set name="RspMsg"    value="无符合条件记录"/>
               <return/>
            </if>
            <elseif condition="#RetCod!=0">
               <set name="RspCod"    value="06003"/>
               <set name="RspMsg"    value="更新订单信息错误"/>
               <return/>
            </elseif>
   </else>
         <set name="MsgTyp"        value="N"/>
         <set name="RspCod"        value="00000"/>
         <set name="RspMsg"        value="交易成功"/>
      </process>
   </transaction>

   <transaction code="888888"        desc="支付成功后跳转">
      <sql name="queryPrdinf">
        select NotifyUrl from stpprdinf where prdordno=#{PRDORDNO} and merno=#{MERNO2}
      </sql>
      <sql name="qryPrdinfIcbc">
        select prdordno,MERREMARK,ordamt from stpprdinf where payordno=#{ORDERID} 
      </sql>
      <process> 
          <set name="PRDORDNO" expr="PRDORDNO1"/>  
          <if condition="IS_EQUAL_STRING(isProxy2,'1')">
              <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="queryPrdinf"/>
              </do>
              <if condition="#RetCod!=0">
                 <set name="MsgTyp"    value="E"/>
                 <set name="RspCod"    value="09999"/>
                 <set name="RspMsg"    value="系统错误"/>
                 <return/>
              </if>
              <else>
                  <if condition="GETCHARPOSFROM(NotifyUrl,0,'?')!=-1">
                     <set name="NxtPag" expr="STRCAT(NotifyUrl,'&amp;orderId=',PRDORDNO)"/>     
                  </if>
                  <else>
                     <set name="NxtPag" expr="STRCAT(NotifyUrl,'?orderId=',PRDORDNO)"/>    
                  </else>
                  <set name="_REQUESTATTR.REDIRECTURL"       expr="NXTPAG"/>    <!--异步通知页面--> 
              </else>
          </if>
          <elseif condition="IS_EQUAL_STRING(INTERFACENAME,'ICBC_PERBANK_B2C')">  <!--工行跳转成功页面-->
              <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd" sql="qryPrdinfIcbc"/>
              </do>
              <if condition="#RetCod!=0">
                 <set name="MsgTyp"    value="E"/>
                 <set name="RspCod"    value="09999"/>
                 <set name="RspMsg"    value="系统错误"/>
                 <return/>
              </if>
              
              <set name="SUCDAT"       expr="FMTDATE(SUBSTR(ORDERDATE,1,8),0,4)"/>
              <set name="AMOUNT"       expr="AMTADDDOT(ordamt)"/>
              <if condition="ISNULL(MERREMARK)">
                 <set name="MERREMARK"    value="商物通"/>
              </if>
          </elseif>
          <else>
            <set name="_REQUESTATTR.FORWARDURL"       value="/cashier/html/result/bankret.jsp"/>
          </else>
 
      </process>
   </transaction> 
   
   <transaction code="999999"        desc="担保支付确定付款">
      <sql name="queryPayinf"><!--查询商品订单信息-->
        select ordAmt,nvl(rfTotalAmt,0) rfTotalAmt,OrdStatus,prdName,merNo,bizType,payOrdNo,MERREMARK,prdOrdType,NotifyUrl,CUST_ID from stpprdinf where PrdOrdNo=#{PrdOrdNo}
      </sql> 
      <sql name="SelPayInf">
        select OrdStatus,txAmt,CUST_ID,payType,FEE from stppayinf where PayOrdNo=#{PayOrdNo}
      </sql>
      <sql name="queryCustNo"><!--查询商户账户信息-->
        select PAY_AC_NO,CUST_ID,AC_TYPE,PASSWORD paywd from ARP_AC_CUST_REL where CUST_ID=#{CUST_ID}
      </sql>
      <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
         SELECT CASH_AC_BAL,FROZ_BALANCE FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNO}
      </sql>
      <sql name="UpdPay"> <!-- 更新支付订单表 -->
         payOrdNo=#{payOrdNo}
      </sql>
      <sql name="UpdPrd"> <!-- 更新商品订单表 -->
         prdOrdNo=#{prdOrdNo}
      </sql>
      <sql name="QryCusInf"><!-- 查询客户信息-->
         SELECT CUST_STATUS FROM StpCusInf WHERE CUST_ID=#{USERID} 
      </sql>
      <process> 
         <set name="userID"       expr="SESSIONS.USRID"/> 
         <!-- 用户信息查询-->
         <quote name="usrChk"/>
         
         <!--查询商品订单信息-->
         <set name="prdOrdNo_bak" expr="prdOrdNo"/>  
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="queryPayinf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="商户订单不存在"/>
            <return/>
         </if>
         
         <if condition="AND(IS_NOEQUAL_STRING(OrdStatus,'05'),IS_NOEQUAL_STRING(OrdStatus,'12'),IS_NOEQUAL_STRING(OrdStatus,'13'),IS_NOEQUAL_STRING(OrdStatus,'15'),IS_NOEQUAL_STRING(OrdStatus,'16'))">
            <set name="RspCod"    value="07008"/>
            <set name="RspMsg"    value="订单状态不正确"/>
            <return/>
         </if>
         
         <!--查询支付订单信息-->
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="SelPayInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="08001"/>
            <set name="RspMsg"    value="该支付订单信息不存在"/>
           
            <return/>
         </if>
         
         <set name="PASSWORD" expr="PASSWORD"/>
         <do func="TdPwdAesToDes"     error="IGNORE">
            <para name="AesKey"      expr="SESSIONS.MCRYPT_KEY"/> 
            <para name="AesPwd"      expr="PASSWORD"/> 
            <para name="Mark"        expr="0"/> 
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"         value="08032"/>
            <set name="RspMsg"         value="密码转加密失败"/>
           
            <return/>
         </if>
         
         <set name="pwd"       expr="NewPwd"/>
         <do func="ReadRecord" error="IGNORE">
           <para name="SqlCmd" sql="queryCustNo" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="07009"/>
            <set name="RspMsg"    value="该用户账户信息不存在"/>
            
            <return/>
         </if>
         <set name="pwd"        expr="pwd"/>
         <set name="PASSWORD"   expr="paywd"/>
         <if condition="IS_NOEQUAL_STRING(PASSWORD,pwd)">
            <set name="RspCod"    value="08033"/>
            <set name="RspMsg"    value="支付密码不正确"/>
           
            <return/>
         </if>
         <else>
           
         </else>
         <set name="inStr" expr="PASSWORD"/>
         <do func="HKMD5">
           <para name="inStr"     expr="inStr" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="08038"/>
            <set name="RspMsg"    value="加签失败"/>
            <return/>
         </if>
         <set name="MD5Val"       expr="pwd"/>
         
         <set name="txAmtSub"     expr="SUB(txAmt,rfTotalAmt)" />  <!--支付金额减去累计退款--> 
         <set name="txAmtnet"     expr="SUB(txAmtSub,fee)" />
         <!--扣除中间账户的金额-->
         <if condition="OR(IS_EQUAL_STRING(payType,'00'),IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(payType,'01'))"> 
            <!--进行虚拟账户扣款-->
            <set name="MER_ACC_TYP"  value="02"/>           <!-- 商户结算账户 -->
            <set name="payacno"      expr="SESSIONS.PAYACNO"/>   
            <set name="pltMidPar"    expr="STRCAT('99999900000001','/','04','/','-','/','CNY','/',txAmtSub,'/','N','/')"/>   <!--平台担保账户记账参数-->
            <if condition="OR(IS_EQUAL_STRING(FEE,'0'),ISNULL(FEE))">       <!--无手续费--> 
              <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/','CNY','/',txAmtSub,'/','Y','/')"/>       <!--商户记账参数-->
              <set name="PARAMS"     expr="STRCAT(pltMidPar,',',merPar)"/>
            </if>
            <else>                                                          <!--有手续费-->    
              <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/','CNY','/',txAmtnet,'/','Y','/')"/>       <!--商户记账参数-->
              <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',fee,'/','N','/')"/>        <!--平台账户（手续费）记账参数-->
              <set name="PARAMS"     expr="STRCAT(pltMidPar,',',merPar,',',feePar)"/>
            </else>
         
            <!--记账处理-->
            <set name="TXN_TYP"      value="2"/>              <!--用途  消费-->
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <set name="Status"       value="2"/>
               <set name="ClearDat"     expr="GETDATE()"/>    <!--清算日期-->
               <delete name="actdat"/>
               <quote name="UpdPay"/>
               <set name="acDate"       expr="GETDATE()"/>    <!--清算日期-->  
               <set name="acTime"       expr="GETDATETIME('HHMISS')"/>  <!--清算时间-->
               
               <quote name="UpdPrd"/>
              
               <set name="ThirdServer"  value="STHDSMK1"/>
               <!--通知商城付款失败--> 
               <quote name="TimeTouch2"/>
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="07007"/>
               <set name="RspMsg"    value="支付失败"/>
               <set name="NXTPAG"    value="../result/bakfalse.jsp"/>
            </if>
            
            <set name="netRecAmt"      expr="SUB(TXAMT,FEE)"/>                                                
            <set name="txnComAmt"      expr="FEE"/>   
            <set name="acDate"         expr="GETDATE()"/>
            <set name="acTime"         expr="GETDATETIME('HHMISS')"/>
            <set name="ClearDat"       expr="GETDATE()"/>
            
            <!--更新支付订单表-->
            <set name="OrdStatus"   value="01"/>
            <quote name="UpdPay"/>

            <set name="ordStatus"   value="01"/> 
            <set name="Status"      value="1"/> 
            <!--更新商品订单表--> 
            <quote name="UpdPrd"/>
            
            <set name="SUCDAT"      expr="FMTDATE(SUBSTR(actdat,1,8),0,4)"/>
            <set name="TXAMT"       expr="AMTADDDOT(ordAmt)"/>
            <set name="NxtPag"      expr="STRCAT('../result/bankret.jsp?TXAMT=',TXAMT,'&amp;SUCDAT=',SUCDAT,'&amp;prdOrdNo=',prdOrdNo)"/> 
         </if>
         <else>
            <set name="MsgTyp"      value="E"/>
            <set name="RspCod"      value="08009"/>
            <set name="RspMsg"      value="支付方式不正确"/>
         </else>
            
      </process>
   </transaction>
   
   <transaction code="565087"        desc="查询商品订单的商户号 用于继续支付">
      <sql name="SelOrdInf"><!-- 查询订单信息-->
         SELECT merno,prdOrdNo,ordstatus,PrdOrdType,ordamt FROM vw_StpPrdInf WHERE prdOrdNo=#{prdOrdNo}
      </sql>
      <process> 
          
          <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="SelOrdInf" />
          </do>
          <if condition="#RetCod!=0">
             <set name="RspCod"    value="09999"/>
             <set name="RspMsg"    value="订单不存在"/>
             <return/>
          </if>
          <if condition="IS_EQUAL_STRING(ordstatus,'01')">
             <set name="RspCod"    value="07019"/>
             <set name="RspMsg"    value="交易已成功，请刷新页面"/>
             <return/>
          </if>
          <elseif condition="IS_EQUAL_STRING(ordstatus,'11')">
             <set name="RspCod"    value="07019"/>
             <set name="RspMsg"    value="订单已作废，请刷新页面"/>
             <return/>
          </elseif>
          <elseif condition="IS_EQUAL_STRING(ordstatus,'12')">
             <set name="RspCod"    value="07019"/>
             <set name="RspMsg"    value="支付已成功，请刷新页面"/>
             <return/>
          </elseif>
          <set name="merno"                   expr="merno"/>
          <set name="ORDAMT"                  expr="AMTADDDOT(ordamt)"/>
          <set name="MsgTyp"                   value="N"/>
          <set name="RspCod"                   value="00000"/>
         
      </process>
   </transaction>
   
   <transaction code="checkUserFee"  desc="根据用户信息查询适用手续费">
      <sql name="selUsrFeeCode">
        select FEE_CODE from ARP_CUST_FEE 
        where (CUST_TYPE like '%'||#{CUST_TYPE}||'%'  or ' '= #{CUST_TYPE}||' ')and
              (PAY_AC_NO like '%'||#{PAY_AC_NO}||'%'  or ' '= #{PAY_AC_NO}||' ')and
              (BIZ_TYPE like '%'||#{BIZ_TYPE}||'%'  or ' '= #{BIZ_TYPE}||' ')and
              (SOURCE like '%'||#{SOURCE}||'%'  or ' '= #{SOURCE}||' ')and
              STATUS=0
      </sql>
      <process>
        <!--页面传值过来加S，以防止下面业务判断某些值固定后被覆盖-->
        <set name="CUST_TYPE" expr="DELBOTHSPACE(CUST_TYPES)"/><!--客户类型-->
        <set name="PAY_AC_NO" expr="DELBOTHSPACE(PAY_AC_NOS)"/><!--支付账号-->
        <set name="BIZ_TYPE"  expr="DELBOTHSPACE(BIZ_TYPES)"/> <!--业务类型-->
        <set name="SOURCE"    expr="DELBOTHSPACE(SOURCES)"/>   <!--交易来源-->
        <set name="ORDERAMT"  expr="DELBOTHSPACE(ORDERAMT)"/> <!--交易金额-->

        <if condition="ISNULL(CUST_TYPE)">
          <set name="CUST_TYPE"           value=""/>
        </if>
        <if condition="ISNULL(PAY_AC_NO)">
          <set name="PAY_AC_NO"           value=""/>
        </if>
        <if condition="ISNULL(BIZ_TYPE)">
          <set name="BIZ_TYPE"           value=""/>
        </if>
        <if condition="ISNULL(SOURCE)">
          <set name="SOURCE"           value=""/>
        </if>
        <!-- 四个条件精确查询 start-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd"  sql="selUsrFeeCode"/>
         </do>
         <if condition="#RetCod==0">
             <set name="FEE_CODE" expr="FEE_CODE"/>
         </if>
         <elseif condition="#RetCod==2">
            <set name="RspMsg" value="四个条件精确查询，未匹配到费率代码,执行指定用户指定业务下的全部来源"/>
            <set name="SOURCE" value="00"/><!-- 只固定SOURCE start-->
            <do func="ReadRecord" error="IGNORE">
              <para name="SqlCmd"  sql="selUsrFeeCode"/>
            </do>
            <if condition="#RetCod==0">
              <set name="FEE_CODE" expr="FEE_CODE"/>
            </if>
            <elseif condition="#RetCod==2">
              <set name="RspMsg"   value="全部来源，未匹配到费率代码，执行指定用户全部业务下的指定来源"/>
              <set name="BIZ_TYPE" value="0"/><!-- 只固定BIZ_TYPE-->
              <set name="SOURCE"   expr="DELBOTHSPACE(SOURCES)"/>
              <do func="ReadRecord" error="IGNORE">
                <para name="SqlCmd"  sql="selUsrFeeCode"/>
              </do>
              <if condition="#RetCod==0">
                <set name="FEE_CODE" expr="FEE_CODE"/>
              </if>
              <elseif condition="#RetCod==2">
                <set name="RspMsg"   value="全部业务,指定来源，未匹配到费率代码，执行指定用户全部业务下的全部来源"/>
                <set name="BIZ_TYPE" value="0"/><!-- BIZ_TYPE,SOURCE都固定-->
                <set name="SOURCE"   value="00"/>
                <do func="ReadRecord" error="IGNORE">
                  <para name="SqlCmd"  sql="selUsrFeeCode"/>
                </do>
                <if condition="#RetCod==0">
                  <set name="FEE_CODE" expr="FEE_CODE"/>
                </if>
                <elseif condition="#RetCod==2">
                  <set name="RspMsg"    value="全部业务,全部来源，未匹配到费率代码，执行全部用户下指定业务下的指定来源"/>
                  <set name="PAY_AC_NO" value="9999999999999999"/><!-- 只固定PAC_AC_NO-->
                  <set name="SOURCE"    expr="DELBOTHSPACE(SOURCES)"/>
                  <set name="BIZ_TYPE"  expr="DELBOTHSPACE(BIZ_TYPES)"/>
                  <do func="ReadRecord" error="IGNORE">
                    <para name="SqlCmd"  sql="selUsrFeeCode"/>
                  </do>
                  <if condition="#RetCod==0">
                    <set name="FEE_CODE" expr="FEE_CODE"/>
                  </if>
                  <elseif condition="#RetCod==2">
                    <set name="RspMsg"    value="全部用户,指定业务，指定来源，未匹配到费率代码，执行全部用户下指定业务下的全部来源"/>
                    <set name="PAY_AC_NO" value="9999999999999999"/><!-- 固定PAC_AC_NO和SOURCE-->
                    <set name="SOURCE"    value="00"/>
                    <set name="BIZ_TYPE"  expr="DELBOTHSPACE(BIZ_TYPES)"/>
                    <do func="ReadRecord" error="IGNORE">
                      <para name="SqlCmd"  sql="selUsrFeeCode"/>
                    </do>
                    <if condition="#RetCod==0">
                      <set name="FEE_CODE" expr="FEE_CODE"/>
                    </if>
                    <elseif condition="#RetCod==2">
                      <set name="RspMsg"    value="全部用户,指定业务，全部来源，未匹配到费率代码，执行全部用户下全部业务下的指定来源"/>
                      <set name="PAY_AC_NO" value="9999999999999999"/><!-- 固定PAC_AC_NO和BIZ_TYPE-->
                      <set name="BIZ_TYPE"  value="0"/>
                      <set name="SOURCE"    expr="DELBOTHSPACE(SOURCES)"/>
                      <do func="ReadRecord" error="IGNORE">
                        <para name="SqlCmd"  sql="selUsrFeeCode"/>
                      </do>
                      <if condition="#RetCod==0">
                        <set name="FEE_CODE" expr="FEE_CODE"/>
                      </if>
                      <elseif condition="#RetCod==2">
                        <set name="RspMsg"    value="全部用户,全部业务，指定来源，未匹配到费率代码，执行全部用户下全部业务下的全部来源"/>
                        <set name="PAY_AC_NO" value="9999999999999999"/><!-- 固定PAC_AC_NO和BIZ_TYPE和SOURCES-->
                        <set name="BIZ_TYPE"  value="0"/>
                        <set name="SOURCE"    value="00"/>
                        <do func="ReadRecord" error="IGNORE">
                          <para name="SqlCmd"  sql="selUsrFeeCode"/>
                        </do>
                        <if condition="#RetCod==0">
                          <set name="FEE_CODE" expr="FEE_CODE"/>
                        </if>
                        <elseif condition="#RetCod==2">
                          <set name="FEE_CODE"          value=""/>
                          <set name="RspCod"            value="01014"/>
                          <set name="RspMsg"            value="当前设置未检测到手续费"/>
                        </elseif>
                        <else>
                          <set name="RspCod"            value="01013"/>
                          <set name="RspMsg"            value="查询错误"/>
                          <return/>
                        </else>
                      </elseif>
                      <else>
                        <set name="RspCod"            value="01012"/>
                        <set name="RspMsg"            value="查询错误"/>
                        <return/>
                      </else>
                    </elseif>
                    <else>
                      <set name="RspCod"            value="01011"/>
                      <set name="RspMsg"            value="查询错误"/>
                      <return/>
                    </else>
                  </elseif>
                  <else>
                    <set name="RspCod"            value="01010"/>
                    <set name="RspMsg"            value="查询错误"/>
                    <return/>
                  </else>
                </elseif>
                <else>
                  <set name="RspCod"            value="01009"/>
                  <set name="RspMsg"            value="查询错误"/>
                  <return/>
                </else>
              </elseif>
              <else>
                <set name="RspCod"            value="01008"/>
                <set name="RspMsg"            value="查询错误"/>
                <return/>
              </else>
            </elseif>
            <else>
              <set name="RspCod"            value="01007"/>
              <set name="RspMsg"            value="查询错误"/>
              <return/>
            </else>
         </elseif>
         <else>
            <set name="RspCod"            value="01006"/>
            <set name="RspMsg"            value="查询错误"/>
            <return/>
         </else>
        <!-- 四个条件精确查询 end-->
        <if condition="ISNULL(FEE_CODE)">
            <set name="userTranFee"  value="0"/>
        </if>
        <else>
            <set name="txnAmt_fee"   expr="ORDERAMT"/>
            <quote name="FeeCount"/>
            <set name="userTranFee"  expr="AMTADDDOT(fee)" />
        </else>
        <set name="RspCod"             value="00000"/>
        <set name="RspMsg"             value="执行成功"/>
      </process>
   </transaction>
    
   <transaction code="signpayApply"  desc="快捷支付卡授权并短信通知">
     <sql name="QryStpBankInf"> <!--  查询用户绑定的银行卡(借记卡、信用卡)  --> 
        select upper(CARD_BANK) AS bank_code,(case when CARD_TYPE='01' then '1' when CARD_TYPE='02' then '2'   else '-1' end) as type_card,CARD_NO as cardno,CARD_NAME as cust_name,USER_ID as idno,CARD_BANK_THREE as cvv2,VALIDITY_M as month,VALIDITY_Y as year,BANK_RES_PHONE as bind_mob,NVL(BANK_CONF,0) AS BANK_CONF from STPBANKTB where BAK_SEQ=#{no_agree}
     </sql>
     <sql name="DelUsrIdInfo"> <!--  删除验证表信息  -->
       DELETE FROM STPVERIFY  WHERE VER_ID=#{UsrMp} and VER_TYPE=#{VER_TYPE}  and SERVICE_TYPE=#{SERVICE_TYPE}
     </sql>
     <sql name="InsUsrrandom"> <!--  插入用户验证信息  --> 
       INSERT INTO  STPVERIFY (VER_ID,VER_TYPE,InsTim,Random,TimeOut,SERVICE_TYPE,VER_TRAN_NO) 
       VALUES (#{UsrMp},#{VER_TYPE}, sysdate ,#{Random},#{TimeOut},#{SERVICE_TYPE},#{TRANCODE}) 
     </sql>
     <sql name="InMsgSed"><!--  登记短信信息  -->
       INSERT INTO STPMSGSED VALUES(#{USRMP},#{MSG_DAT},#{MSG_TIM},#{CUS_NAM},#{SMSCONTENT},'0')
     </sql>
     <sql name="UpdMsgSed"><!--  更新短信发送状态  -->
       UPDATE STPMSGSED SET MSG_STS='1' WHERE PHONE=#{USRMP} AND MSG_TIM=#{MSG_TIM}
     </sql>
     <process>
       <!-- 检查用户登录平台是否正确    0001：用户 ；0009：操作员 -->
       <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>
       <set name="USRID"           expr="SESSIONS.USRID"/>
       <!-- 检查手机号是否为空 -->
       <if condition="OR(ISNULL(USRID),IS_EQUAL_STRING(USRID,''))">
         <set name="RspCod"        value="02000"/>
         <set name="RspMsg"        value="用户未登录"/>
         <return/>
       </if>
       <!-- 检测卡序列号是否为空 -->
       <!-- 
         1.空
          a.检查该银行卡是否通过银行授权 若没有通过 则请求银行授权
          b.平台发送校验短信
         2.非空
          a.根据卡类型判断输入项是否完整
          b.请求银行授权
          c.平台发送短信
         注：短信通知时不保存用户卡信息
        -->
       <set name="no_agree"           expr="no_agree"/>
       <set name="pay_amt"            expr="pay_amt"/>
       
       <set name="empower_sign"       expr="empower_sign"/><!-- 0：申请授权  1：不申请(已授权) -->
       <if condition="OR(ISNULL(no_agree),IS_EQUAL_STRING(no_agree,''))">
           <!-- 公共信息 -->
           <set name="type_card"      expr="type_card"/>
           <set name="cardno"         expr="cardno"/>
           <set name="sDeData"        expr="DELSPACE(cardno,'all')"/>
           <set name="bind_mob"       expr="DELSPACE(bind_mob,'all')"/>
           <set name="bank_code"      expr="bank_code"/>
           
           <if condition="OR(ISNULL(type_card),ISNULL(cardno),ISNULL(bind_mob),ISNULL(bank_code))">
               <set name="RspCod"        value="02001"/>
               <set name="RspMsg"        value="卡信息不完整，请完善卡信息!"/>
               <return/>
           </if>
           <!-- 借记卡 -->
           <if condition="IS_EQUAL_STRING(type_card,'1')">
               <!-- 已校验 -->
           </if>
           <elseif condition="IS_EQUAL_STRING(type_card,'2')">
               <set name="cvv2"          expr="cvv2"/>
               <set name="month"         expr="month"/>
               <set name="year"          expr="year"/>
               <if condition="OR(ISNULL(cvv2),IS_EQUAL_STRING(cvv2,''),ISNULL(month),IS_EQUAL_STRING(month,''),ISNULL(year),IS_EQUAL_STRING(year,''))">
           <set name="RspCod"        value="02001"/>
           <set name="RspMsg"        value="卡信息不完整，请完善卡信息!"/>
           <return/>
         </if>
           </elseif>
           <else>
               <set name="RspCod"        value="02002"/>
               <set name="RspMsg"        value="不支持的卡类型，请重新选择卡!"/>
               <return/>
           </else>
       </if>
       <else>
           <!-- 查询绑定卡信息 -->
        <do func="ReadRecord"     error="IGNORE">
           <para name="SqlCmd" sql="QryStpBankInf"/>
        </do>
        <if condition="#RetCod==2">
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="09999"/>
           <set name="RspMsg"        value="该卡信息已删除"/>
           <return/>  
        </if>
        <elseif condition="#RetCod!=0">
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="02003"/>
           <set name="RspMsg"        value="获取卡信息失败，请重新选择！"/>
           <return/>  
        </elseif>
        <set name="BANK_CONF"    expr="BANK_CONF"/>
        <if condition="IS_EQUAL_STRING(BANK_CONF,'1')">
             <set name="empower_sign"       value="1"/>
        </if>
        <set name="sDeData"         expr="cardno"   />
           <if condition="NOT(ISNULL(DES_DECRYPT(sDeData)))">
               <set name="sDeData"      expr="DES_DECRYPT(sDeData)"/>
           </if>
       </else>
       <set name="cardno"      expr="sDeData"/>
       
       <!-- 申请向银行发起授权(待优化项：根据通道走不通授权渠道) -->
       <if condition="IS_EQUAL_STRING(empower_sign,'0')">
           <set name="ret_bank_code"    value="success"/>
           <set name="ret_bank_message" value="授权成功"/>
       </if>
       
       <!-- 卡号解密-部分内容星号隐藏 -->
       <set name="First"             expr="SUBSTR(sDeData,1,3)"/> 
       <set name="End"               expr="SUBSTR(sDeData,SUB(STRLEN(sDeData),3),STRLEN(sDeData))"/>
       <set name="CARDNO_FMT"            expr="STRCAT(First,'****',End)"/>
  
       
       
       <!-- 发送短信 -->
       <set name="UsrMp"             expr="DELBOTHSPACE(bind_mob)"/>
       <set name="VER_TYPE"          value="0"/>
       <set name="SERVICE_TYPE"      value="05"/><!--验证码服务类型 00-注册短信验证 01-修改密码短信验证 02-找回密码短信验证 03-数字证书短信验证 04-帐号变更短信验证 05-消费支付短信验证 -->
       
       <!--  删除用户验证码表中的记录  -->
       <do func="ExecSql" error="IGNORE">
           <para name="SqlCmd" sql="DelUsrIdInfo" />
       </do>
       <if condition="#RetCod==-1">
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </if>
       
       <do expr="@TdRandom@generateMixRandom(6, 'NUM', 'LOW')"/>
       <set name="SmsContent"      expr="STRCAT('验证码',Random,'，您正在使用卡号[尾号',End,']付款',pay_amt,'元.任何人向您索取均为欺骗，请勿泄露')"/>
       <set name="TimeOut"         expr="MUL(10,60)" />  <!-- 10分钟 -->
       <!-- 插入用户验证表 -->
       <set name="InsTim"          expr="GETDATETIME()"/>
       <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="InsUsrrandom"/>
       </do>
       <if condition="#RetCod!=0">
         <set name="MsgTyp"        value="E"/>
         <set name="RspCod"        value="09999"/>
         <set name="RspMsg"        value="系统错误"/>
         <return/>
       </if>
       <do func="CommitWork"/>
       
       
       <!-- 插入短信信息 -->
       <set name="Msg_Dat"         expr="GETDATE()"/>
       <set name="Msg_Tim"         expr="GETDATETIME()"/>
       <set name="Cus_Nam"         value="快捷支付获取短信验证码"/>
       <do func="ExecSql" error="IGNORE">
         <para name="SqlCmd" sql="InMsgSed"/>
       </do>
       <if condition="#RetCod!=0">
         <set name="RspCod"        value="02004"/>
         <set name="RspMsg"        value="登记短信发送表失败"/>
         <return/>
       </if>
       <do func="CommitWork"/>
       <!-- 设置短信内容 -->
       <!--取公共参数配置-->
       <set name="ConfigName"   value="SendSms"/>
       <quote name="ReadXmlCfg"/>
       <set name="endpoint"   expr="endpoint"/>
       <set name="account"    expr="account"/>
       <set name="pwd"        expr="pwd"/>
       
       <!-- 发送短信 -->
       <quote name="sendSms"/>
       <if condition="#RetCod!=0">
         <set name="RspCod"               value="1003"/>
         <set name="RspMsg"               value="短信发送失败"/>
         <set name="DWZ_STATUS_CODE"      value="300"/>
         <set name="DWZ_RSP_MSG"          expr="RspMsg"/>
       </if>
       <else>
       	 <!-- 更新短信发送状态 --> 
         <do func="ExecSql" error="IGNORE">
            <para name="SqlCmd" sql="UpdMsgSed" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"       value="02005"/>
            <set name="RspMsg"       value="修改发送状态失败"/>
         </if>
       	 
         <set name="MsgTyp"          value="N"/>
         <set name="RspCod"          value="00000"/>
         <set name="RspMsg"          value="交易成功"/>
       </else>
       
       <!-- 手机号-部分内容星号隐藏 -->
       <set name="First"                 expr="SUBSTR(bind_mob,1,3)"/> 
       <set name="End"                   expr="SUBSTR(bind_mob,8,SUB(STRLEN(bind_mob),7))"/>
       <set name="BIND_MOB_FMT"          expr="STRCAT(First,'****',End)"/>
       
       <delete name="Random"/>
       <delete name="SmsContent"/>
       <delete name="account"/>
       <delete name="endpoint"/>
       <delete name="pwd"/>
       <delete name="First"/>
       <delete name="End"/>
       
     </process>
   </transaction>
   
   <transaction code="561535" desc="收银台用户绑定卡查询">
     <sql name="QryStpBankInf"> <!--  查询用户绑定的银行卡(借记卡、信用卡)  --> 
       select BAK_SEQ,CARD_BANK AS BANK_CODE,CARD_TYPE,CARD_NO from STPBANKTB where cust_id=#{USRID} and bank_conf ='1' ${condition} order by card_type
     </sql>
     <process>
       <!-- 检查用户登录平台是否正确    0001：用户 ；0009：操作员 -->
       <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
         <set name="RspCod"        value="01001"/>
         <set name="RspMsg"        value="用户登录平台不正确"/>
         <return/>
       </if>
       <set name="USRID"           expr="SESSIONS.USRID"/>
       <!-- 检查手机号是否为空 -->
       <if condition="OR(ISNULL(USRID),IS_EQUAL_STRING(USRID,''))">
         <set name="RspCod"        value="02000"/>
         <set name="RspMsg"        value="用户未登录"/>
         <return/>
       </if>
       <set name="QUERYSIGN"           expr="QUERYSIGN"/>  <!-- 0：查询借记卡(默认)  1：查询信用卡 2：查询(借记卡、信用卡)所有 -->
       <if condition="OR(ISNULL(QUERYSIGN),IS_EQUAL_STRING(QUERYSIGN,''),IS_EQUAL_STRING(QUERYSIGN,'0'))">
           <set name="condition"   expr="STRCAT('and card_type =\'','00','\'')"/>
       </if>
       <elseif condition="IS_EQUAL_STRING(QUERYSIGN,'1')">
           <set name="condition"   expr="STRCAT('and card_type =\'','01','\'')"/>
       </elseif>
       <elseif condition="IS_EQUAL_STRING(QUERYSIGN,'2')">
           <set name="condition"   expr="STRCAT('and card_type in(','00,01',')')"/>
       </elseif>
       <else>
           <set name="condition"   value=""/>
       </else>
       
       
       <do func="QueryInGroup"    error="IGNORE">
           <para name="SqlCmd"      sql="QryStpBankInf" /> 
           <para name="RecordName"  value="BINDING_BANKS"/>
           <para name="RecNum"      value="PRONUM"/>
       </do>
       <if condition="#RetCod==2">
           <set name="RECORDNUM"    value="2"/>
           <set name="MsgTyp"       value="E"/>
           <set name="RspCod"       value="0002"/>
           <set name="RspMsg"       value="无记录"/>
       </if>
       <elseif condition="#RetCod==-1">
            <set name="RECORDNUM"    value="-1"/>
           <set name="MsgTyp"       value="E"/>
           <set name="RspCod"       value="09998"/>
           <set name="RspMsg"       value="网络繁忙，请稍后再试"/>
           <return/>
       </elseif>
       
       <foreach name="BINDING_BANKS" iterator="#grp">
         <set name="sDeData"         expr="#grp.CARD_NO"   />
         <if condition="NOT(ISNULL(DES_DECRYPT(sDeData)))">
            <set name="sDeData"      expr="DES_DECRYPT(sDeData)"   />
         </if>
         <set name="end"             expr="SUBSTR(sDeData,SUB(STRLEN(sDeData),3),STRLEN(sDeData))"/>
         <do func="loopSetEach">
            <para name="ele"   expr="#grp.CARD_NO"/> 
            <para name="value" expr="end"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"            value="09998"/>
            <set name="RspMsg"            value="系统错误"/>
            <return/>
         </if>
      </foreach>
       
       <set name="MsgTyp"          value="N"/>
       <set name="RspCod"          value="00000"/>
       <set name="RspMsg"          value="交易成功"/>
     </process>
   </transaction>
   
   <transaction code="565201" desc="建立支付订单">
      <sql name="SelPrd"> <!-- 查询商品订单表 -->
         SELECT ORDERTIME,ordAmt,OrdStatus,prdName,merNo,bizType,payOrdNo,prdOrdType,NotifyUrl,retUrl tradeCode 
           FROM stpPrdInf 
          WHERE prdOrdNo=#{prdOrdNo} and merNo=#{MerNo}
      </sql> 
      <sql name="UpdPay"> <!-- 更新支付订单表 -->
         payOrdNo=#{payOrdNo}
      </sql>
      <sql name="UpdPrd"> <!-- 更新商品订单表 -->
         prdOrdNo=#{prdOrdNo} and merNo=#{MerNo}
      </sql>
      <sql name="QryCusInf"><!-- 查询客户信息-->
         SELECT c.CUST_STATUS, c.CUST_NAME,u.cust_login FROM StpCusInf c,stpusrinf u WHERE c.cust_id=u.cust_id and c.CUST_ID=#{USERID} 
      </sql>
      <sql name="SelAccInf"><!-- 查询客户账户信息-->
         SELECT a.AC_STATUS,a.PAY_AC_NO PAYACNUM FROM ARP_AC_PROFILE a,ARP_AC_CUST_REL b WHERE b.CUST_ID=#{USERID} AND a.PAY_AC_NO=b.PAY_AC_NO
      </sql>
      <sql name="QryPassInf"><!-- 查询客户支付密码信息-->
         SELECT PASSWORD FROM ARP_AC_CUST_REL WHERE PAY_AC_NO=#{PAYACNUM}
      </sql>
      <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
         SELECT CASH_AC_BAL,FROZ_BALANCE FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNUM}
      </sql>
      <sql name="SelMerFee">
         SELECT fee_code FROM ARP_CUST_FEE WHERE pay_ac_no in (select pay_ac_no from arp_ac_cust_rel where CUST_ID=#{merNo}) and biz_type=#{bizType} and pay_type=#{payType}
      </sql>
      <!-- 快捷支付 查询绑定卡信息 -->
      <sql name="QryStpbanktb">
          SELECT (case when CARD_TYPE='00' then '1' when CARD_TYPE='01' then '2'   else '-1' end) as type_card FROM  STPBANKTB WHERE BAK_SEQ=#{no_agree}
      </sql>
      <sql name="QryCertificate">
          select CUST_CRED_NO from stpcusinf where CUST_ID=#{USERID}
      </sql>
      <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
          SELECT 
          EXTRACT(DAY FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*24*60 + EXTRACT(HOUR FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*60 +  EXTRACT(MINUTE FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND )) as timeDifference,
          CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT
          FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
      </sql>
      <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
          INSERT INTO STPLOGTMP
          (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE)
          VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
      </sql>
      <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
          UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,
          LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
      </sql>
      <sql name="UpdUsrLogInfo"><!-- 修改登录用户登录失败信息记录 -->
          UPDATE STPLOGTMP SET CURRENT_LOGIN_TIME=SYSDATE ,LAST_LOGIN_TIME=SYSDATE ,LOGIN_FAIL_COUNT='0'
          WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
      </sql>
        <!-- 物业缴费相关表 -->
   	    <sql name="QryUtilityBillPayInf"><!-- 查询账单支付信息表 -->
   	    	select * from UtilityBillPayInf where BillPay_PrdOrdNo=#{Bill_PrdOrdNo}
   	    </sql>   
   	  
   	    <sql name="updateUtilityBillInf"><!-- 更新客户物业缴费账单信息记录表 -->
           UPDATE UtilityBillInf SET Bill_Status = #{Status}  WHERE Bill_PrdOrdNo=#{Bill_PrdOrdNo}
        </sql>
        
        <sql name="updateUtilityBillPayInf"><!-- 更新客户物业缴费缴费信息表 -->
           UPDATE UtilityBillPayInf SET BillPay_Status = #{Status}  WHERE BillPay_PrdOrdNo=#{Bill_PrdOrdNo}
        </sql>  
            <sql name="UpdPayMer"><!-- 更新支付订单表中银行商户号 -->
          UPDATE STPPAYINF SET BnkMerNo=#{BnkMerNo} WHERE payOrdNo=#{payOrdNo}
      </sql>
      <process>
         <!--检查用户登录平台是否正确-->
         <if condition="IS_NOEQUAL_STRING(SysCod,'0001')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="01001"/>
            <set name="RspMsg"    value="用户登录平台不正确"/>
            <return/>
         </if>
         
         <set name="userID"       expr="SESSIONS.USRID"/>
         <set name="MerNo"        expr="MerNo"/>
         
         <!-- 用户信息查询-->
         <quote name="usrChk"/>
         <quote name="chkAcc"/>
         
         <!--验签 start-->
         <set name="txnDat"        expr="TACCDT"/>
         <set name="orderNo"       expr="PrdOrdNo"/>
         <set name="txnAmt"        expr="TXAMT"/>
         <set name="TXAMT_FMT"     expr="TXAMT"/>
         <quote name="chkSign"/>
         <!--验签 end-->
         <set name="custPayAcNo"   expr="PAYACNUM"/>
   
         <!--查询商品订单信息-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="SelPrd" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"    value="08001"/>
            <set name="RspMsg"    value="该订单信息不存在"/>
            <return/>
         </if>
         <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="06001"/>
            <set name="RspMsg"    value="订单已付款成功，请刷新交易记录！"/>
            <return/>
         </if>
         <elseif condition="IS_NOEQUAL_STRING(OrdStatus,'00')">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="06001"/>
            <set name="RspMsg"    value="该订单状态不能支付"/>
            <quote name="UpdPrd"/>
            <return/>
         </elseif>
         <else>
            <set name="RspMsg"       value="检查通过"/>
         </else>
         
         <if condition="ISNULL(PrdOrdType)">
            <set name="PrdOrdType"  value="0"/>            
         </if>
         
         <!--判断金额是否与建立商品订单中的金额一致-->
         <if condition="IS_NOEQUAL_STRING(ordAmt,AMTPOWER(TXAMT,2))">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="08016f"/>
            <set name="RspMsg"    value="订单金额与应支付金额不符"/>
            <return/>
         </if>
         
         <if condition="AND(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(accAmt,'0.00'))">
            <set name="payType"     expr="mulType"/>
            <set name="accAmt"      value=""/>
            <set name="mulAmt"      value=""/>
            <set name="mulType"     value=""/>
         </if>
         <elseif condition="IS_EQUAL_STRING(payType,'04')">
            <set name="MULAMT_FMT"     expr="mulAmt"/>
            <set name="accAmt"         expr="AMTPOWER(accAmt,2)"/>           <!--虚拟账户金额--> 
            <set name="mulAmt"         expr="AMTPOWER(mulAmt,2)"/>           <!--混合支付金额-->    
         </elseif>
         <else>
            <set name="RspMsg"       value="检查通过"/>
         </else>
         
         <!-- 用户支付密码锁定次数判断 -->
         <set name="USER_ID"   expr="DELBOTHSPACE(CUST_LOGIN)" />
         <set name="CUSTTYPE"  value="0"/><!--0用户 1 商户 2企业-->
         <set name="PWDTYPE"   value="1"/><!--0:登录密码 1:支付密码-->
         <set name="FailFlag"  value="0"/>
         <quote name="usrpwdlock"/>
         <!-- 用户支付密码锁定次数判断 -->
         
         <!--支付密码检查 虚拟账户支付或混合支付检查 start-->
         <if condition="OR(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(payType,'00'))">
            <set name="PAYACNO"   expr="PAYACNUM"/>
            <quote name="chkUsrPayPwd"/>
         </if>
         <!--支付密码检查 end-->

          <!-- 修改登记失败信息表 -->
          <do func="ExecSql" error="IGNORE">
             <para name="SqlCmd" sql="UpdUsrLogInfo"/>
          </do>
          <if condition="#RetCod!=0">
             <set name="RSPCOD" value="02040"/>
             <set name="RSPMSG" value="更新登录信息失败!"/> 
             <return/>
          </if>
          
         <!--限额检查  start --> 
         <set name="txAmt_bak"     expr="TXAMT"/>
         <set name="txAmt"         expr="AMTPOWER(TXAMT,2)"/>    <!--交易金额-->
         <set name="Amt"           expr="txAmt"/>
         <set name="User_code"     expr="userID"/>
         <set name="comp_code"     expr="merNo"/>
         <set name="cust_type"     value="0"/>  
         <set name="Time"          expr="GETDATETIME()"/>
         <set name="DATE"          expr="GETDATE()"/>
         <set name="TRAN_TYPE"     value="2"/>
         <set name="ServiceCode"   value="680518"/>  
         <quote name="chkLimAmt"/>
         <!--限额检查   end--> 
         
         <!--获取序号 -->
         <do func="GetSeqNo"  error="IGNORE">
            <para name="TblNam" value="stpseqrec"/>
            <para name="KeyNam" value="KeyNam"/>
            <para name="KeyVal" expr="STRCAT('StpPayInf','PayOrdNo',GETDATE())"/>
            <para name="SeqNam" value="KeyVal"/>
            <para name="Len"    value="8"/>
            <para name="Circle" value="1"/>
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09001"/>
            <set name="RspMsg"    value="获取序号错误"/>
            <return/>
         </if>
         <set name="payOrdNo"    expr="STRCAT('P',SUBSTR(ActDat,2,7),KeyVal)"></set>
         <set name="ordCcy"      value="CNY"/>
         <set name="payType"     expr="payType"/>
         <set name="txCcy"       value="CNY"/>
         <set name="SignMsg"     expr="signature"/>                    <!--签名信息-->
         <set name="ActDat"      expr="GETDATETIME()"/>                <!--支付时间-->
         <set name="OrdStatus"   value="00"/>                          <!--未支付-->
         <set name="cust_id"     expr="userID"/>
         <set name="BANKSTLDATE" expr="GETDATE()"/>
         <set name="ACCESSWAY"   value="0"/>
         
         <if condition="IS_NOEQUAL_STRING(payType,'00')">
            <set name="BANKCOD"       expr="BANKCODE"/>
            <if condition="OR(ISNULL(THIRDPARTY),IS_EQUAL_STRING(THIRDPARTY,''))">
             <set name="THIRDPARTY"   value="PLA"/>
            </if>
         </if>
         
         <if condition="ISNULL(isProxy)">
            <set name="isProxy" value="0"/>       
         </if>
         <do func="InsertRecord" error="IGNORE">
            <para name="TblNam"  value="StpPayInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09999"/>
            <set name="RspMsg"    value="系统错误"/>
            <return/>
         </if> 
         <do func="CommitWork"/>
         
         <!--查询账户余额-->
         <quote name="selAccBal"/>  
         
         <if condition="IS_EQUAL_STRING(payType,'00')">       <!--虚拟账户--> 
           
            <set name="TRANWAY"        value="04"/><!--交易方式 虚拟账户--> 
            <if condition="ISNULL(CASH_AC_BAL)">
              <set name="CASH_AC_BAL"  value="0"/>
            </if>
            <if condition="ISNULL(FROZ_BALANCE)">
              <set name="FROZ_BALANCE" value="0"/>
            </if>
            <set name="casBal"     expr="SUB(CASH_AC_BAL,FROZ_BALANCE)"/>  
            
            <if condition="DOUBLECMP(casBal,1,TXAMT)">           <!--判断金额是足够-->
                <set name="MsgTyp"    value="E"/>
                <set name="RspCod"    value="06012"/>
                <set name="RspMsg"    value="账户可用余额不足，请重新选择付款方式！"/>   
                <return/>
            </if>
            
            <!--计算商户手续费-->
            <quote name="CalMerFee"/>
            <set name="netRecAmt"      expr="netRecAmt"/>     <!--净额-->
            <set name="txnComAmt"      expr="txnComAmt"/>     <!--收取商户的交易佣金-->  
            
            <!--记账所需数据-->
            <set name="ACC_TYP"        value="01"/>           <!--现金账户-->
            <set name="MER_ACC_TYP"    value="02"/>           <!-- 商户结算账户 -->
            <set name="DR_CR_FLAG"     value="+"/>            <!--账户余额增减标识 + 增加 - 减少-->
            <set name="CCY"            value="CNY"/>          <!--货币类型-->
            <set name="AMT"            expr="TXAMT"/>         <!--金额-->
            <set name="IS_ACT"         value="Y"/>            <!--是否实时记账 Y 是 N 否-->
            <set name="usrPar"         expr="STRCAT(CUST_ID,'/',ACC_TYP,'/','-','/',CCY,'/',AMT,'/',IS_ACT,'/')"/>  <!--用户记账参数-->
            
            <!--进行虚拟账户扣款-->    
            <if condition="IS_EQUAL_STRING(prdOrdType,'0')">     <!--消费--> 
               <if condition="IS_EQUAL_STRING(flag,'1')">        <!--收取手续费标识  1 收取  0 不收取-->
                  <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                  <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                  <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar,',',feePar)"/>
               </if>
               <else>
                  <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',AMT,'/',IS_ACT,'/')"/>         <!--商户记账参数-->
                  <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar)"/>
               </else>
            </if>
            <elseif condition="IS_EQUAL_STRING(prdOrdType,'2')">    <!--担保支付--> 
               <set name="flag"               value="0"/>           <!--担保支付预付款不扣手续费 确认付款再扣取-->
               <set name="netRecAmt"          expr="txAmt"/>
               <set name="pltMidPar"          expr="STRCAT('99999900000001','/','04','/','+','/',CCY,'/',AMT,'/','N','/')"/>        <!--平台担保账户记账参数-->
               <set name="PARAMS"             expr="STRCAT(usrPar,',',pltMidPar)"/>  
            </elseif>
         
            <!--记账处理-->
            <set name="TXN_TYP"      value="2"/>                                    <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->     
            <set name="PARAMS"       expr="PARAMS"/>
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <do func="RollBackWork"/>
               <set name="Status"       value="2"/>
               <set name="ClearDat"     expr="GETDATE()"/>    <!--支付日期-->
               <quote name="UpdPay"/>
               <set name="acDate"       expr="ClearDat"/>     <!--支付日期-->  
               <set name="acTime"       expr="GETDATETIME('HHMISS')"/>  <!--支付时间-->
               <quote name="UpdPrd"/>
               <set name="RspCod"      value="80001"/>
               <set name="RspMsg"      value="账户扣款失败，请稍后重试！"/>
               <return/>
            </if>
            
            <!--更新支付订单表-->
            <set name="OrdStatus"    value="01"/>
            <if condition="NOT(ISNULL(CREDNO))">
               <delete name="CREDNO"/>   
            </if> 
            <set name="ClearDat"     expr="acDate"/>
            <quote name="UpdPay"/>
            
            <if condition="ISNULL(merRemark)">
               <set name="merRemark"         value="商物通"/>
            </if>
        
            <set name="SmsContent"    expr="STRCAT('您好，您在',merRemark,'消费金额：',AMTADDDOT(txAmt),'元，通过商物通付款成功，如有疑问请联系',merRemark,'。')"></set>
            <quote name="sendSms"/>
            
            <!--增加宏文件，处理物业缴费成功，通知第三方-->
            <set name="ConfigName"   value="PropertyMerId"/>
            <quote name="ReadXmlCfg"/>
            <if condition="IS_EQUAL_STRING(MERNO,ProMerId)">       <!--  生产商户号为固定商户号 需要配置  -->
            	   <quote name="RetBill"/>
            </if>

            <set name="#url"          expr="NotifyUrl" />  
            <if condition="IS_EQUAL_STRING(prdOrdType,'2')">
               <set name="OrdStatus"  value="12"/>  
            </if>
            <else>
               <set name="OrdStatus"  value="01"/>
            </else>
            <set name="Status"        value="1"/> 
            <!--更新商品订单表--> 
            <quote name="UpdPrd"/>
            
            <!--通知风控系统登记订单信息-->
            <set name="ServiceCode" value="680517"/>
            <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
            <set name="TCODE"       expr="payOrdNo"/>           <!--平台流水号-->
            <set name="CTYPE"       value="1"/>                 <!--客户类型-->
            <set name="CLIENTCODE"  expr="userID"/>
            <set name="CLIENTNAME"  expr="CUST_NAME"/>
            <set name="MOBILEPHONE" expr="SESSIONS.USRMP"/>
            <set name="CCODE"       expr="merNo"/>              <!--商户编号-->
            <set name="CNAME"       expr="MERREMARK"/>
            <set name="TRANTYPE"    value="2"/>                 <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
            <set name="TRANWAY"     value="04"/>                <!--交易方式 01网银、02终端、03消费卡、04虚拟积分等-->
            <set name="TAMT"        expr="ordAmt"/>
            <set name="REGDTTIME"   expr="STRCAT(acDate,acTime)"/>
            <set name="Time"        expr="acDate"/>
            <quote name="noticRcs"/>
            <set name="RspCod"      value="00000"/>
            <set name="RspMsg"      value="交易成功"/>
            
            <do func="putresponse"/>
            <if condition="IS_EQUAL_STRING(isProxy,'1')">
               <set name="retUrl" expr="NotifyUrl"/>  
               <if condition="GETCHARPOS(retUrl,'?',STRLEN(retUrl))!=-1">
                  <set name="NxtPag" expr="STRCAT(retUrl,'&amp;orderId=',PRDORDNO)"/>     
               </if>
               <else>
                  <set name="NxtPag" expr="STRCAT(retUrl,'?orderId=',PRDORDNO)"/>    
               </else>
            </if>
            <else>
               <set name="SUCDAT"   expr="FMTDATE(SUBSTR(actdat,1,8),0,4)"/>
               <set name="TXAMT"    expr="AMTADDDOT(ordAmt)"/>
               <set name="NxtPag"   expr="STRCAT('../result/bankret.jsp?TXAMT=',TXAMT,'&amp;SUCDAT=',SUCDAT,'&amp;prdOrdNo=',prdOrdNo)"/>
            </else>
            
            <if condition="IS_EQUAL_STRING(signType,'MD5')">
            <set name="signature" expr="MD5(STRCAT('versionId=3','&amp;merchantId=',merno,'&amp;orderId=',prdOrdNo,'&amp;settleDate=',actDat,
                   '&amp;completeDate=',actDat,'&amp;status=',Status,'&amp;notifyTyp=1','&amp;payOrdNo=',payOrdNo,'&amp;orderAmt=',txAmt,
                   '&amp;notifyUrl=',notifyUrl,'&amp;signType=',signType,merchantKey),'UTF-8','L')"/>
            </if> 
            <!--通知商城付款成功-->  
            <quote name="TimeTouch2"/> 
         </if>
         <elseif condition="IS_EQUAL_STRING(payType,'04')">   <!--混合支付--> 
            <set name="prdOrderNo"       expr="prdOrdNo"/>
            <set name="payAcNo"          expr="PAYACNUM"/>
            <set name="merNotmp"         expr="merno"/>
            
            <!--根据混合支付方式，发送相应接口-->
            <if condition="IS_EQUAL_STRING(MulType,'01')">    <!--网银-->
               <set name="payAmt"        expr="AMTADDDOT(mulAmt)"/>
               <set name="TXAMT_BAK"     expr="payAmt"/>
               <quote name="SendInb"/>
            </if>
            <elseif condition="IS_EQUAL_STRING(MulType,'03')">   <!--快捷-->
                <set name="payAmt"        expr="AMTADDDOT(mulAmt)"/>
                <quote name="GetQuickInf01"/>
                <quote name="UpdPrd"/>
            </elseif>
            <quote name="UpdPrd"/>
            <quote name="UpdPayMer"/>
         </elseif>
         <elseif condition="IS_EQUAL_STRING(payType,'01')">   <!--网银-->
            <set name="payAmt"           expr="txamt"/>
            <quote name="SendInb"/>
            <quote name="UpdPrd"/>
            <quote name="UpdPayMer"/>
         </elseif>
         <elseif condition="IS_EQUAL_STRING(payType,'03')">   <!--快捷-->
            <quote name="GetQuickInf01"/>
            <quote name="UpdPrd"/>
         </elseif>
         <else>
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="06012"/>
            <set name="RspMsg"    value="无此支付方式"/>
            <return/>
         </else>
         <set name="MsgTyp"    value="N"/>
         <set name="RspCod"    value="00000"/>
         <set name="RspMsg"    value="交易成功"/>
      </process> 
   </transaction>

   <transaction code="565202" desc="B2B支付订单结果处理-银行回调">
      <sql name="QryURL"> <!--查询通知商城的URL 查询支付订单表-->
        SELECT b.NotifyUrl,b.retUrl,b.PRDNAME,a.PrdOrdNo,a.OrdStatus,a.PrdOrdType,a.payType,a.MulType,a.txamt,a.fee txnComAmt,
               a.accAmt,a.mulAmt,a.merno,a.bankCod bnkCod,a.CUST_ID,a.ActDat,b.bizType,a.BnkMerNo
         FROM StpPayInf a,StpPrdInf b 
        WHERE a.payOrdNo=#{payOrdNo} and a.prdordno=b.prdordno
      </sql>
      <sql name="UpdPay"> <!-- 更新支付订单表 -->
         payOrdNo=#{payOrdNo}
      </sql>
      <sql name="UpdPrd"> <!-- 更新商品订单表 -->
         prdOrdNo=#{prdOrdNo} and merNo=#{merno} 
      </sql>
      <sql name="UpdReg"> <!-- 更新充值订单表 -->
         prdordno=#{PrdOrdNo} and prdOrdType='1'
      </sql>  
      <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
         SELECT CASH_AC_BAL,FROZ_BALANCE,TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'FM9999,999,999,990.00') AC_BAL FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNO}
      </sql>
      <sql name="SelBnkFee"><!-- 查询银行费率信息-->
         SELECT FEE_CODE FROM CoopBank WHERE BANK_CODE=#{bnkCod}
      </sql> 
      <sql name="SelBnkMerFee"><!-- 查询银行商户费率信息-->
         SELECT FEE_CODE FROM COOPBANK_FEE WHERE BANK_CODE=#{bnkCod} and BANK_MERNO=#{BnkMerNo}
      </sql>   
      <sql name="SelMerFee">
         SELECT fee_code 
           FROM ARP_CUST_FEE 
          WHERE pay_ac_no in (select pay_ac_no from arp_ac_cust_rel where CUST_ID=#{merNo}) and biz_type=#{bizType} and pay_type=#{payType}
      </sql>
      <sql name="SelCusAcc">
         SELECT pay_ac_no FROM arp_ac_cust_rel  WHERE CUST_ID=#{CUST_ID}
      </sql>
      <sql name="QrySendInf1">
         SELECT merNo,prdordno,txamt as ordamt,OrdStatus,ActDat as paytime,'M' as signType FROM stppayinf WHERE payordno=#{orderNo}
      </sql>
      <sql name="QryMerMD5">
         SELECT a.MD5_SECRET_CODE_ID as MD5Key FROM StpMerInf a,StpCusInf b WHERE a.CUST_ID = b.CUST_ID AND a.CUST_ID=#{merNo}
      </sql>       
      
      <!-- 物业缴费相关表 -->
   	  <sql name="QryUtilityBillPayInf"><!-- 查询账单支付信息表 -->
   	  	select * from UtilityBillPayInf where BillPay_PrdOrdNo=#{Bill_PrdOrdNo}
   	  </sql>   
   	
   	  <sql name="updateUtilityBillInf"><!-- 更新客户物业缴费账单信息记录表 -->
         UPDATE UtilityBillInf SET Bill_Status = #{Status}  WHERE Bill_PrdOrdNo=#{Bill_PrdOrdNo}
      </sql>
      
      <sql name="updateUtilityBillPayInf"><!-- 更新客户物业缴费缴费信息表 -->
         UPDATE UtilityBillPayInf SET BillPay_Status = #{Status}  WHERE BillPay_PrdOrdNo=#{Bill_PrdOrdNo}
      </sql>      
           
      <process>
         <set name="ConfigName" value="SecCfg"/>
         <quote name="ReadXmlCfg"/>
         <set name="_REQUESTATTR.FORWARDURL"  expr="reqErrPage"/>    <!-- 请求错误页面 -->
           
         <!-- 银联报文验签 -->
         <if condition="NOT(ISNULL(RESPCODE))">        <!-- 银联 -->
         		<!--打印ETF树-->
      			<do func="DumpEtf"/>
            <do func="B2bRcvResponse"     error="IGNORE" />
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="09002"/>
               <set name="RspMsg"    value="银联返回验证失败"/>
               <return/>
            </if>
            <set name="payOrdNo"    expr="ORDERID"/>
            <set name="orderNo"     expr="ORDERID" />
            <set name="bankJrnNo"   expr="queryId" />
            <set name="bankStlDate" expr="settleDate" />
            <set name="BnkMerNo"    expr="merId" />
            <set name="ordAmt1"     expr="TXNAMT"/>   <!--银联返回订单金额-->
            <set name="ORDERDATE"   expr="SUBSTR(TXNTIME,1,8)"/>
            <set name="bankCode"    value="01010100"/>
         </if>

         
         <set name="TraceTime"     expr="GETDATETIME()"/>  <!--支付成功时间-->
         <set name="merRemark"     value="商物通"/>
         
         <!-- 用户等待最长时间(该时间必须控制在页面超时前) -->
         <set name="max"           value="8"/>
         <set name="i"             value="1"/>
         <!--对同一个订单号进行加锁-->
         <do func="Lock">
            <para name="RecKey"     expr="payOrdNo" />
            <para name="AutoUnLock" value="yes" />
         </do>
         <if condition="#RetCod!=0">
            <while condition="INTCMP(i,2,max)">
                <do func="Lock">
                    <para name="RecKey"     expr="payOrdNo" />
                    <para name="AutoUnLock" value="yes" />
               </do>
               <if condition="#RetCod!=0">
                   <do func="Sleep">
                       <para name="SleepTime"     value="1" />
                   </do>
                   <set name="i"                  expr="ADD(i,1)"/>
               </if>
               <else>
                   <set name="i"                  value="0"/>
                   <return/>
               </else>
            </while>
         </if>
         
         <if condition="INTCMP(i,5,max)">
            <set name="RspCod"           value="08001"/>
            <set name="RspMsg"           value="系统交易加锁失败，请稍后重试！"/>
            <return/>
         </if>
         
         <!--查询URL-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryURL" />
         </do>
         <set name="RCS_USER_CODE"       expr="CUST_ID"/>  <!--用户ID-->
         <set name="RCS_PAY_TYPE"        value="800019"/>  <!--本次交易码，订单支付-->
         <set name="RCS_PRD_NO"          expr="prdOrdNo"/> <!--订单号，如果不涉及置空-->
         <if condition="#RetCod!=0">
            <set name="RspCod"           value="08001"/>
            <set name="RspMsg"           value="该支付订单信息不存在"/>
            <return/>
         </if>
         <!-- 校验用户和账户余额查询 逻辑处理提前 -->
         <set name="payacno"        expr="SESSIONS.PAYACNO"/>  
         <if condition="ISNULL(payacno)">
            <!--查询客户账户-->
            <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd" sql="SelCusAcc"/>
            </do>
            <if condition="#RetCod==2">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="07016"/>
               <set name="RspMsg"    value="该用户账户信息不存在"/> 
               <return/> 
            </if> 
            <elseif condition="#RetCod!=0">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09999"/>
               <set name="RspMsg"    value="系统错误"/>
               <return/> 
            </elseif>
            <set name="payacno" expr="pay_ac_no"/>
         </if>
         
         <!--查询账户余额-->
         <quote name="selAccBal"/>
         <set name="AC_BAL"      expr="AC_BAL"/>
         
         
         <if condition="IS_EQUAL_STRING(PrdOrdType,'1')">
             <set name="_REQUESTATTR.FORWARDURL"  expr="PayErrPage"/>
         </if>
         <else>
             <set name="_REQUESTATTR.FORWARDURL"  expr="RegErrPage"/>
         </else>
         <if condition="IS_NOEQUAL_STRING(OrdStatus,'00')">
            <set name="PrdOrdType"               expr="PrdOrdType"/>
            <if condition="IS_EQUAL_STRING(PrdOrdType,'1')">
              <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                <set name="sucDat"                   expr="FMTDATE(GETDATE(),0,4)"/> 
                <set name="SUCAMT"                   expr="AMTADDDOT(txAmt)"/>
                <set name="_REQUESTATTR.FORWARDURL"  expr="RegSucPage"/>
                <return/>
              </if>
              <else>
                <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                   <set name="RspCod"    value="06001"/>
                   <set name="RspMsg"    value="该订单状态不能支付"/>
                   <return/>
                </if>
              </else>
            </if>
            <else>
              <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                <set name="sucDat"                   expr="FMTDATE(GETDATE(),0,4)"/> 
                <set name="SUCAMT"                   expr="AMTADDDOT(txAmt)"/>
                <set name="_REQUESTATTR.FORWARDURL"  expr="STRCAT(payResult,'?payordno=',payOrdNo)"/>
                <return/>
              </if>
              <else>
                <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                   <set name="RspCod"    value="06001"/>
                   <set name="RspMsg"    value="该订单状态不能支付"/>
                   <return/>
                </if>
              </else>
            </else>
         </if>
           
         <set name="BANKCODE"   expr="bnkCod"/>
         
         <!--判断金额是否与支付订单中的金额一致-->
         <if condition="IS_EQUAL_STRING(payType,'04')">
            <if condition="IS_NOEQUAL_STRING(mulAmt,ordAmt1)">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="08016"/>
               <set name="RspMsg"    value="订单金额与应支付金额不符"/>
               <return/>
            </if>
         </if>
         <else>
            <if condition="ISNULL(txnComAmt)">
               <set name="txnComAmt" value="0"/>
            </if>
            <if condition="IS_NOEQUAL_STRING(txamt,ordAmt1)"><!--订单金额加佣金-->
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="08016"/>
               <set name="RspMsg"    value="订单金额与应支付金额不符"/>
               <return/>
            </if>
         </else>
         
         <set name="sucDat" expr="FMTDATE(SUBSTR(actdat,1,8),0,4)"/>
         <if condition="IS_EQUAL_STRING(BANKCODE,'01040000')">
            <quote name="BOCreturn"/>      <!--  中行返回结果  -->    
         </if>
         <elseif condition="IS_EQUAL_STRING(BANKCODE,'CCB')">
            <if condition="IS_EQUAL_STRING(SUCCESS,'Y')">
               <set name="PayRet"      value="00"/>
               <set name="OrdStatus"   value="01"/>
               <set name="BnkDat"      expr="ACCDATE"/>
               <set name="bankStlDate" expr="ACCDATE"/>   
            </if> 
         </elseif>
         <elseif condition="IS_EQUAL_STRING(BANKCODE,'03010000')">
            <set name="PayRet"         value="00"/>
            <set name="OrdStatus"      value="01"/>
            <set name="BnkDat"         expr="ACCDATE"/>
            <set name="bankStlDate"    expr="ACCDATE"/>  
         </elseif>
         <elseif condition="IS_EQUAL_STRING(BANKCODE,'03080000')">
            <if condition="IS_EQUAL_STRING(SUCCEED,'Y')">
               <set name="PayRet"      value="00"/>
               <set name="OrdStatus"   value="01"/>
               <set name="BnkDat"      expr="SUBSTR(DATE,1,8)"/>
               <set name="bankStlDate" expr="SUBSTR(DATE,1,8)"/>   
            </if> 
         </elseif>
         <elseif condition="IS_EQUAL_STRING(BANKCODE,'01020000')">
            <if condition="OR(IS_EQUAL_STRING(TRANSTAT,'1'),IS_EQUAL_STRING(TRANSTAT,'0'))">
               <set name="PayRet"      value="00"/>
               <set name="OrdStatus"   value="01"/>
               <set name="BnkDat"      expr="SUBSTR(ORDERDATE,1,8)"/>
               <set name="bankStlDate" expr="SUBSTR(ORDERDATE,1,8)"/>
               <set name="ReIcbcUrl"   expr="icbcret"/>   
            </if> 
         </elseif>
         <elseif condition="IS_EQUAL_STRING(BANKCODE,'01010000')"><!-- 银联 -->
            <if condition="IS_EQUAL_STRING(RESPCODE,'00')">
               <set name="PayRet"    value="00"/>
               <!--00:等待付款  01:付款成功  02:付款失败 03:退款申请 04:等待退款 05:退款成功
                   06:退款失败  07:同意撤销  08:拒绝撤销 09:撤销成功 10:撤销失败 12:预付款  
                   17:实付审核中18:实付审核通过 19:实付审核拒绝 99:超时-->
               <set name="OrdStatus" value="01"/>
               <set name="BnkDat"      expr="SUBSTR(DATE,1,8)"/>
               <set name="bankStlDate" expr="SUBSTR(DATE,1,8)"/>   
            </if>
            <else>
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09022"/>
               <set name="RspMsg"    value="银联支付失败"/>
               <set name="OrdStatus" value="02"/>  
            </else> 
         </elseif>
         <elseif condition="IS_EQUAL_STRING(BANKCODE,'01010100')"><!-- 银联B2B -->
            <if condition="IS_EQUAL_STRING(RESPCODE,'00')">
               <set name="PayRet"    value="00"/>
               <!--00:等待付款  01:付款成功  02:付款失败 03:退款申请 04:等待退款 05:退款成功
                   06:退款失败  07:同意撤销  08:拒绝撤销 09:撤销成功 10:撤销失败 12:预付款  
                   17:实付审核中18:实付审核通过 19:实付审核拒绝 99:超时-->
               <set name="OrdStatus" value="01"/>
               <set name="BnkDat"      expr="SUBSTR(DATE,1,8)"/>
               <set name="bankStlDate" expr="SUBSTR(DATE,1,8)"/>   
            </if>
            <else>
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09022"/>
               <set name="RspMsg"    value="银联B2B支付失败"/>
               <set name="OrdStatus" value="02"/>  
            </else> 
         </elseif>
         
         <if condition="IS_EQUAL_STRING(PrdOrdType,'0')">                   <!-- 消费-直接支付  -->  
            <set name="NotifyTyp"    value="0"/>
            <set name="#url"         expr="NotifyUrl" />                    <!-- 同步返回 URL 通知商城地址 -->
            
            <if condition="IS_NOEQUAL_STRING(PayRet,'00')">
               <set name="RspCod"       expr="RspCod"/>
               <set name="Status"       value="2"></set>
               <quote name="UpdPay"/>
               <quote name="UpdPrd"/>
               <quote name="TimeTouch2"/>
               <return/>
            </if>
            
            <set name="OrdStatus"    value="01"/>
            <set name="Status"       value="1"/>
           
            <set name="fee"              value="0"/>                               <!-- 批量作业时再去计算 -->
            
            <!--记账处理 start-->
            <set name="TXN_TYP"          value="2"/>                                <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->     
            <if condition="IS_EQUAL_STRING(payType,'01')">                          <!--网银支付-->
               <set name="txnAmt_fee"     expr="txAmt"/>
               <set name="BnkJnl"         expr="payOrdNo"/>
               <set name="bankJrnNo"      expr="payOrdNo"/>                           <!--银行返回订单号,银行流水号--> 
               <set name="Tran_type"      value="1"/>                                 <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合-->
               
               <!--记账所需数据-->
               <set name="ACC_TYP"        value="01"/>               <!--现金账户-->
               <set name="MER_ACC_TYP"    value="02"/>               <!-- 商户结算账户 -->
               <set name="DR_CR_FLAG"     value="+"/>                <!--账户余额增减标识 + 增加 - 减少-->
               <set name="CCY"            value="CNY"/>              <!--货币类型-->
               <set name="AMT"            expr="TXAMT"/>             <!--金额-->
               
               <set name="IS_ACT"         value="Y"/>                <!--是否实时记账 Y 是 N 否-->
               
               <if condition="IS_EQUAL_STRING(flag,'1')">        <!--有手续费-->
                  <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                  <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                  <set name="PARAMS"     expr="STRCAT(merPar,',',feePar)"/>
               </if>
               <else>                                            <!--无手续费-->
                  <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',AMT,'/',IS_ACT,'/')"/>        <!--商户记账参数-->
                  <set name="PARAMS"     expr="merPar"/>
               </else>
            </if>
            <elseif condition="AND(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(MulType,'01'))">    <!--混合支付-->
               <set name="txnAmt_fee"    expr="mulAmt"/>
               <set name="bankJrnNo"     expr="payOrdNo"/>                         <!--银行返回订单号--> 
               <set name="Tran_type"     value="5"/>                               <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合--> 
               
               <if condition="ISNULL(CASH_AC_BAL)">
                 <set name="CASH_AC_BAL" value="0"/>
               </if>
               <if condition="ISNULL(FROZ_BALANCE)">
                 <set name="FROZ_BALANCE" value="0"/>
               </if>
               <set name="casBal"     expr="SUB(CASH_AC_BAL,FROZ_BALANCE)"/>
               
               <!--记账所需数据-->
               <set name="ACC_TYP"    value="01"/>               <!--现金账户-->
               <set name="MER_ACC_TYP"    value="02"/>           <!-- 商户结算账户 -->
               <set name="CCY"        value="CNY"/>              <!--货币类型-->
               <set name="IS_ACT"     value="Y"/>                <!--是否实时记账 Y 是 N 否-->
               <set name="usrPar"     expr="STRCAT(CUST_ID,'/',ACC_TYP,'/','-','/',CCY,'/',ACCAMT,'/',IS_ACT,'/')"/>  <!--用户记账参数-->
               
               <if condition="DOUBLECMP(casBal,5,ACCAMT)">        <!--现金账户-->
                  <if condition="IS_EQUAL_STRING(flag,'1')">   <!--有手续费-->
                     <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                     <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                     <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar,',',feePar)"/>
                  </if>
                  <else>                                       <!--无手续费-->
                     <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',txAmt,'/',IS_ACT,'/')"/>      <!--商户记账参数-->
                     <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar)"/>
                  </else>
               </if>
            </elseif>

            <set name="TRANTYPE"     value="2"/>                                    <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->  
            <set name="TRANWAY"      value="01"/>                                   <!--01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
            <set name="CCODE"        expr="merNo"/>                                 <!--商户编号--> 
            
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="07005"/>
               <set name="RspMsg"    value="银行付款成功，系统入账失败。请等待系统自动调账处理货联系客服人员！"/>
               <return/>
            </if>
            <!--记账处理 end-->
            
            <!--计算银行手续费-->
            <quote name="CalBnkFee"/> 
            
            <quote name="UpdPay"/>         <!--更新支付订单表-->
            <quote name="UpdPrd"/>         <!--更新商品订单表-->

            <set name="SmsContent"    expr="STRCAT('您好，您在',merRemark,'消费金额：',AMTADDDOT(txAmt),'元，通过商物通付款成功，如有疑问请联系',merRemark,'。')"></set>
            <quote name="sendSms"/>
            
            <set name="sucAmt"             expr="AMTADDDOT(TXAMT)"/>
            <set name="sucDat"             expr="sucDat"/>
            <if condition="IS_EQUAL_STRING(isProxy,'1')">
               <if condition="GETCHARPOSFROM(NotifyUrl,0,'?')!=-1">
                  <set name="NxtPag" expr="STRCAT(NotifyUrl,'&amp;orderId=',PRDORDNO)"/>
               </if>
               <else>
                  <set name="NxtPag" expr="STRCAT(NotifyUrl,'?orderId=',PRDORDNO)"/> 
               </else>
               <set name="_REQUESTATTR.REDIRECTURL"       expr="NXTPAG"/>    <!--异步通知页面--> 
            </if>
            <else>
               <set name="NXTPAG"      expr="succePage"/>     
               <set name="_REQUESTATTR.FORWARDURL"        expr="NXTPAG"/>    <!--异步通知页面--> 
            </else>
	             
            <!--增加宏文件，处理物业缴费成功，通知第三方-->
            <set name="ConfigName"   value="PropertyMerId"/>
            <quote name="ReadXmlCfg"/>
            <if condition="IS_EQUAL_STRING(MERNO,ProMerId)">       <!--  生产商户号为固定商户号 需要配置  -->
            	   <quote name="RetBill"/>
            </if>
	    <else>
	           <quote name="TimeTouch2"/>    <!--通知商城--> 
	    </else>
            <set name="_REQUESTATTR.FORWARDURL"  expr="STRCAT(payResult,'?payordno=',payOrdNo)"/>
         </if>
         <elseif condition="IS_EQUAL_STRING(PrdOrdType,'2')">               <!-- 消费-担保支付  -->  
            <set name="NotifyTyp"    value="0"/>
            <set name="#url"         expr="NotifyUrl" />                    <!-- 同步返回 URL  -->
            
            <if condition="IS_NOEQUAL_STRING(PayRet,'00')">
               <set name="RspCod"       expr="RspCod"/>
               <set name="Status"       value="2"></set>
               <quote name="UpdPay"/>

               <quote name="UpdPrd"/>
               <quote name="TimeTouch2"/>
               <return/>
            </if>
            
            <set name="Status"       value="1"/>
   
            <!--记账处理 start-->
            <!--计算商户手续费--> 
            <quote name="CalMerFee"/>
            <set name="TXN_TYP"          value="2"/>                                <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->     
            <if condition="IS_EQUAL_STRING(payType,'01')">                          <!--网银支付-->
               <set name="txnAmt_fee"    expr="txAmt"/>
               <set name="BnkJnl"         expr="payOrdNo"/>
               <set name="bankJrnNo"      expr="payOrdNo"/>                         <!--银行返回订单号--> 
               <set name="Tran_type"      value="1"/>                               <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合-->
               
               <!--记账参数准备-->
               <set name="pltMidPar"      expr="STRCAT('99999900000001','/','04','/','+','/','CNY','/',txAmt,'/','N','/')"/>        <!--平台担保账户记账参数-->
               <set name="PARAMS"         expr="pltMidPar"/>
            </if>
            <elseif condition="AND(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(MulType,'01'))">    <!--混合支付-->
               <set name="txnAmt_fee"     expr="mulAmt"/>
               <set name="bankJrnNo"      expr="payOrdNo"/>                            <!--银行返回订单号--> 
               <set name="Tran_type"      value="5"/>                                  <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合--> 
               
               <if condition="ISNULL(CASH_AC_BAL)">
                 <set name="CASH_AC_BAL" value="0"/>
               </if>
               <if condition="ISNULL(FROZ_BALANCE)">
                 <set name="FROZ_BALANCE" value="0"/>
               </if>
               <set name="casBal"     expr="SUB(CASH_AC_BAL,FROZ_BALANCE)"/>
               
               <if condition="DOUBLECMP(casBal,5,ACCAMT)">          <!--现金账户-->
                  <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','-','/','CNY','/',ACCAMT,'/','Y','/')"/>            <!--用户记账参数-->
                  <set name="pltMidPar"  expr="STRCAT('99999900000001','/','04','/','+','/','CNY','/',txAmt,'/','N','/')"/>      <!--平台担保账户记账参数-->
                  <set name="PARAMS"     expr="STRCAT(usrPar,',',pltMidPar)"/> 
               </if>
            </elseif>

            <set name="TRANTYPE"     value="2"/>                                    <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->  
            <set name="TRANWAY"      value="01"/>                                   <!--01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
            <set name="CCODE"        expr="merNo"/>         

            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <do func="RollBackWork"/>
               <set name="RspCod"    value="07005"/>
               <set name="RspMsg"    value="支付失败"/>
               <set name="RspMsg"    value="银行付款成功，系统入账失败。请等待系统自动调账处理货联系客服人员！"/>
               <return/>
            </if>
            <!--记账处理 end-->
            
            <!--计算银行手续费-->
            <quote name="CalBnkFee"/>
            
            <set name="OrdStatus"     value="01"/>   <!--支付订单状态  交易成功-->
            <quote name="UpdPay"/>                   <!--更新支付订单表-->
            
            <set name="OrdStatus"     value="12"/>   <!--商品订单状态  支付成功-->
            <quote name="UpdPrd"/>

            <set name="SmsContent"    expr="STRCAT('您好，您在',merRemark,'消费金额：',AMTADDDOT(txAmt),'元，通过商物通付款成功，如有疑问请联系',merRemark,'。')"></set>
            <quote name="sendSms"/>
            
            
            <set name="sucAmt"         expr="AMTADDDOT(TXAMT)"/>
            <set name="sucDat"         expr="sucDat"/>
            <if condition="IS_EQUAL_STRING(isProxy,'1')">
               <if condition="GETCHARPOSFROM(NotifyUrl,0,'?')!=-1">
                  <set name="NxtPag" expr="STRCAT(NotifyUrl,'&amp;orderId=',PRDORDNO)"/>     
               </if>
               <else>
                  <set name="NxtPag" expr="STRCAT(NotifyUrl,'?orderId=',PRDORDNO)"/>    
               </else>
               <set name="_REQUESTATTR.REDIRECTURL"       expr="NXTPAG"/>    <!--异步通知页面--> 
            </if>
            <else>
               <set name="NXTPAG"                         expr="succePage"/>     
               <set name="_REQUESTATTR.FORWARDURL"        expr="NXTPAG"/>    <!--异步通知页面--> 
            </else>
            
            <!--增加宏文件，处理物业缴费成功，通知第三方-->
            <set name="ConfigName"   value="PropertyMerId"/>
            <quote name="ReadXmlCfg"/>
            <if condition="IS_EQUAL_STRING(MERNO,ProMerId)">       <!--  生产商户号为固定商户号 需要配置  -->
            	   <quote name="RetBill"/>
            </if>
	    <else>
	           <quote name="TimeTouch2"/>    <!--通知商城--> 
	    </else>
            <set name="_REQUESTATTR.FORWARDURL"           expr="STRCAT(payResult,'?payordno=',payOrdNo)"/>    
         </elseif>
         <elseif condition="IS_EQUAL_STRING(PrdOrdType,'1')">               <!-- 充值  -->
            <set name="_REQUESTATTR.FORWARDURL"  expr="RegErrPage"/>        <!-- 设定充值处理失败错误页面 -->
            <if condition="IS_NOEQUAL_STRING(PayRet,'00')">
               <set name="RspCod"       expr="RspCod"/>
               <set name="Status"       value="2"></set>
               <quote name="UpdPay"/>
               <quote name="UpdReg"/>               <!--  更新充值订单  -->
               <return/>
            </if>
            
            <set name="acDate"  expr="GETDATE()"/>              <!--支付日期-->
            <set name="acTime"  expr="GETDATETIME('HHMISS')"/>  <!--支付时间-->   
            
            <if condition="ISNULL(txnComAmt)">
               <set name="txnComAmt" value="0"/>
            </if>
            <if condition="DOUBLECMP(txnComAmt,'6','0')">
               
               <set name="fee"            expr="txnComAmt"/>
               <set name="netAmt"         expr="SUB(txAmt,txnComAmt)"/>
               <set name="usrPar"         expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',netAmt,'/','Y','/')"/>               <!--用户记账参数-->
               <set name="feePar"         expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',txnComAmt,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
               <set name="PARAMS"         expr="STRCAT(usrPar,',',feePar)"/>
            </if>
            <else>
               <set name="flag"           value="0"/> 
               <set name="fee"            value="0"/>   
               <set name="usrPar"         expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',txAmt,'/','Y','/')"/>  <!--用户记账参数-->
               <set name="PARAMS"         expr="usrPar"/>
            </else>
            <set name="netRecAmt"         expr="SUB(txAmt,txnComAmt)"/>   <!--净额-->  

            <!--记账处理--> 
            <set name="TXN_TYP"           value="1"/>                     <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->      
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <do func="RollBackWork"/> 
               <set name="RspCod"    value="07005"/>
               <set name="RspMsg"    value="充值失败"/>
               <return/>
            </if>
            
            <!--计算银行手续费-->
            <set name="txnAmt_fee"     expr="txAmt"/>
            <quote name="CalBnkFee"/>
            
            <set name="TRANTYPE"       value="1"/>             <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
            <set name="TRANWAY"        expr="payType"/>        <!--交易方式 01网银、02终端、03消费卡、04虚拟账户、05快捷支付--> 
            <set name="TXCCY"          value="CNY"/>
            <set name="payType"        expr="payType"/>
            <quote name="UpdPay"/>               <!--  更新支付订单  --> 
            <quote name="UpdReg"/>               <!--  更新充值订单  --> 
            <set name="merRemark"      value="账户充值"/> <!-- 商户信息 -->
            <set name="_REQUESTATTR.FORWARDURL"       expr="RegSucPage"/>    <!--异步通知页面-->
         </elseif>
         <else>
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09001"/>
            <set name="RspMsg"    value="系统错误"/>
            <set name="_REQUESTATTR.FORWARDURL"       expr="reqErrPage"/> 
            <return/>   
         </else>
         
         <!--通知风控系统登记订单信息-->
         <set name="ServiceCode" value="680517"/>
         <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
         <set name="TCODE"       expr="payOrdNo"/>           <!--平台流水号 支付订单号-->
         <set name="CTYPE"       value="1"/>                 <!--客户类型-->
         <set name="CLIENTCODE"  expr="CUST_ID"/>            <!--客户编号-->
         <set name="CLIENTNAME"  expr="SESSIONS.USRNAME"/>
         <set name="MOBILEPHONE" expr="SESSIONS.USRMP"/>
         <set name="TAMT"        expr="txAmt"/>
         <set name="TRANWAY"     value="01"/>
         <set name="REGDTTIME"   expr="STRCAT(acDate,acTime)"/>
         <set name="Time"        expr="acDate"/>
         <quote name="noticRcs"/>

         <set name="sucAmt"         expr="AMTADDDOT(TXAMT)"/>
         <set name="RspCod"         value="00000"/>
         <set name="RspMsg"         value="支付成功"/>
        
      </process>
   </transaction>

   <transaction code="565302" desc="商户接入-支付订单结果处理-银行回调">
      <sql name="QryURL"> <!--查询通知商城的URL 查询支付订单表-->
        SELECT b.NotifyUrl,b.retUrl,b.PRDNAME,a.PrdOrdNo,a.OrdStatus,a.PrdOrdType,a.payType,a.MulType,a.txamt,a.fee txnComAmt,b.prodcode,
               a.accAmt,a.mulAmt,a.merno,a.bankCod bnkCod,a.CUST_ID,a.ActDat,b.bizType,a.BnkMerNo,a.MERNO
         FROM StpPayInf a,StpPrdInf b 
        WHERE a.payOrdNo=#{payOrdNo} and a.prdOrdNo=b.prdOrdNo
      </sql>
      <sql name="UpdPay"> <!-- 更新支付订单表 -->
         payOrdNo=#{payOrdNo}
      </sql>
      <sql name="UpdPrd"> <!-- 更新商品订单表 -->
         prdOrdNo=#{prdOrdNo} and merNo=#{merno} 
      </sql>
      <sql name="UpdReg"> <!-- 更新充值订单表 -->
         prdordno=#{PrdOrdNo} 
      </sql>  
      <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
         SELECT CASH_AC_BAL,FROZ_BALANCE,TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'FM9999,999,999,990.00') AC_BAL FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNO}
      </sql>
      <sql name="SelBnkFee"><!-- 查询银行费率信息-->
         SELECT FEE_CODE FROM CoopBank WHERE BANK_CODE=#{bnkCod}
      </sql> 
      <sql name="SelBnkMerFee"><!-- 查询银行商户费率信息-->
         SELECT FEE_CODE FROM COOPBANK_FEE WHERE BANK_CODE=#{bnkCod} and BANK_MERNO=#{BnkMerNo}
      </sql>   
      <sql name="SelMerFee">
         SELECT fee_code 
           FROM ARP_CUST_FEE 
          WHERE pay_ac_no in (select pay_ac_no from arp_ac_cust_rel where CUST_ID=#{merNo}) and biz_type=#{bizType} and pay_type=#{payType}
      </sql>
      <sql name="SelCusAcc">
         SELECT pay_ac_no FROM arp_ac_cust_rel  WHERE CUST_ID=#{CUST_ID}
      </sql>
      <sql name="QrySendInf1">
         SELECT merNo,prdordno,txamt as ordamt,OrdStatus,ActDat as paytime,'M' as signType FROM stppayinf WHERE payordno=#{orderNo}
      </sql>
      <sql name="QryMerMD5">
         SELECT a.MD5_SECRET_CODE_ID as MD5Key FROM StpMerInf a,StpCusInf b WHERE a.CUST_ID = b.CUST_ID AND a.CUST_ID=#{merNo}
      </sql>       
      
      <!-- 物业缴费相关表 -->
   	  <sql name="QryUtilityBillPayInf"><!-- 查询账单支付信息表 -->
   	  	select * from UtilityBillPayInf where BillPay_PrdOrdNo=#{Bill_PrdOrdNo}
   	  </sql>   
   	
   	  <sql name="updateUtilityBillInf"><!-- 更新客户物业缴费账单信息记录表 -->
         UPDATE UtilityBillInf SET Bill_Status = #{Status}  WHERE Bill_PrdOrdNo=#{Bill_PrdOrdNo}
      </sql>
      
      <sql name="updateUtilityBillPayInf"><!-- 更新客户物业缴费缴费信息表 -->
         UPDATE UtilityBillPayInf SET BillPay_Status = #{Status}  WHERE BillPay_PrdOrdNo=#{Bill_PrdOrdNo}
      </sql>      
           
      <process>
         <set name="ConfigName" value="SecCfg"/>
         <quote name="ReadXmlCfg"/>
         <set name="_REQUESTATTR.FORWARDURL"  expr="reqErrPage"/>    <!-- 请求错误页面 -->
         
         <if condition="NOT(ISNULL(SIGNRESMSG))">      <!--中信验签-->     
           <set name="ConfigName"        value="CiticCfg"/>
           <quote name="ReadXmlCfg"/>
           <do func="CiticVerifySign"    error="IGNORE">
              <para name="SIGNRESMSG"    expr="SIGNRESMSG"/>
              <para name="tcrt"          expr="trustedcrt"/>
           </do>
           <if condition="#RetCod==1">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="07004"/>
               <set name="RspMsg"    value="中信网银支付结果验签失败"/>
               <return/>  
           </if>
           <set name="bankCode"     value="03020000"/>        
           <set name="payOrdNo"     expr="ORDERNO"/> 
           <set name="ordAmt1"      expr="AMTPOWER(ordAmt1,2)"/>
           <set name="bankStlDate"  expr="orderDate1"/>
           <set name="BNKDAT"       expr="orderDate1"/>
         </if>
         
         <if condition="NOT(ISNULL(merchantNo))">      <!--中行--> 
            <if condition="IS_EQUAL_STRING(merchantNo,merchantNoBoc)">   
               <set name="bankCode"    value="01040000"/>        
               <set name="payOrdNo"    expr="orderNo"/> 
               <set name="ordAmt1"     expr="AMTPOWER(payAmount,2)"/>
            </if>
         </if>
         
         <if condition="NOT(ISNULL(BRANCHID))">        <!--建行-->
            <set name="BRANCHIDCcb"    value="110000000"/>               <!--test-->
            <if condition="IS_EQUAL_STRING(BRANCHID,BRANCHIDCcb)">       
               <set name="payOrdNo"    expr="ORDERID"/> 
               <set name="bankCode"    value="CCB"/> 
               <set name="ordAmt1"     expr="AMTPOWER(payment,2)"/>            
            </if>
         </if> 
         
         <if condition="NOT(ISNULL(MERCHANTPARA))">    <!--招行-->
            <!--取招行参数配置-->
            <set name="ConfigName"   value="CmbCfg"/>
            <quote name="ReadXmlCfg"/> 
            
            <set name="baMessage" expr="STRCAT('Succeed=',SUCCEED,'&amp;CoNo=',CONO,'&amp;BillNo=',BILLNO,'&amp;Amount=',AMOUNT,'&amp;Date=',DATE,'&amp;MerchantPara=',MERCHANTPARA,'&amp;Msg=',MSG,'&amp;Signature=',SIGNATURE)"/><!--数字签名字符串-->
            <!--招行数字签名验证-->
            <!--模拟测试不需要， 接入时放开此段代码 -->
            <set name="SUCCEED"   value="Y"/>
            <set name="ordAmt1"   expr="AMTPOWER(Amount,2)"/>
            <set name="payOrdNo"  expr="GETWORDDELIMITER(MerchantPara,'|',2)"/>
            <if condition="OR(ISNULL(DATE),IS_EQUAL_STRING(DATE,''))">
                <set name="DATE"      expr="GETDATETIME('HHMISS')"/>
            </if>
            <else>
                <set name="DATE"      expr="FMTDATE(DATE,4,0)"/>
            </else>
              
            <!--do func="CMBAttestation"     error="IGNORE">
                <para name="baMessage"    expr="baMessage"/>
            </do>
            <set name="statuenum" expr="statuenum"/>
            <if condition="IS_NOEQUAL_STRING(statuenum,'0')">       
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="08416"/>
               <set name="RspMsg"    value="数字签名证书错误"/>
               <return/>
            </if-->
            
            <delete name="baMessage"/>
            
            <set name="MERPARA"  expr="MERPARA"/>
            <set name="CMBPARA"  expr="GETWORDDELIMITER(MERCHANTPARA,'|',1)"/>
            <!--if condition="IS_EQUAL_STRING(CMBPARA,MERPARA)">       
               <set name="payOrdNo" expr="GETWORDDELIMITER(MERCHANTPARA,'|',2)"/>
               <set name="bankCode"    value="03080000"/> 
               <set name="ordAmt1"     expr="AMTPOWER(AMOUNT,2)"/>       
            </if-->
         </if> 
         
         <if condition="NOT(ISNULL(merID))">           <!--工行-->
            <if condition="IS_EQUAL_STRING(interfaceName,'ICBC_PERBANK_B2C')"> <!--接收工行网银支付结果-->
               <!--取工行参数配置-->
               <set name="ConfigName"   value="IcbcCfg"/>
               <quote name="ReadXmlCfg"/>
               
               <set name="tranData"    expr="STRCAT('interfaceName=',interfaceName,'&amp;interfaceVersion=',interfaceVersion,'&amp;orderid=',orderid,'&amp;TranSerialNo=',TranSerialNo,'&amp;amount=',amount,'&amp;curType=',curType,'&amp;merID=',IcbcMerNo,'&amp;merAcct=',merAcct,'&amp;verifyJoinFlag=',verifyJoinFlag,'&amp;JoinFlag=',JoinFlag)"/>
               <set name="tranData"    expr="STRCAT(tranData,'&amp;UserNum=',UserNum,'&amp;resultType=',resultType,'&amp;orderDate=',orderDate,'&amp;notifyDate=',notifyDate,'&amp;tranStat=',tranStat,'&amp;comment=',comment,'&amp;remark1=',remark1,'&amp;remark2=',remark2)"/>
               <do func="IcbcWbVerifySign"     error="IGNORE">
                  <para name="tranData"    expr="tranData"/>
                  <para name="crtFile"     expr="STRCAT(GETCURAPPHOME(),PubCrtFile)"/>
                  <para name="signMsg"     expr="signMsg"/>
               </do>
               <if condition="#RetCod!=0">
                  <set name="RspCod"    value="09001"/>
                  <set name="RspMsg"    value="工行网银支付结果验签失败"/>
                  <return/>
               </if>
               <set name="ORDERDATE"   expr="SUBSTR(ORDERDATE,1,8)"/>
               <set name="payOrdNo"    expr="orderid"/>
               <set name="bankCode"    value="01020000"/>
               <set name="ordAmt1"     expr="amount"/>
               <delete name="PubCrtFile"/>
               <delete name="tranData"/>
               <delete name="signMsg"/>
            </if>
         </if>   

         <if condition="NOT(ISNULL(RESPCODE))">        <!-- 银联 -->
            <do func="FrontRcvResponse"     error="IGNORE" />
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="09002"/>
               <set name="RspMsg"    value="银联返回验证失败"/>
               <return/>
            </if>
            <set name="payOrdNo"    expr="ORDERID"/>
            <set name="orderNo"     expr="ORDERID" />
            <set name="bankJrnNo"   expr="queryId" />
            <set name="bankStlDate" expr="settleDate" />
            <set name="BnkMerNo"    expr="merId" />
            <set name="ordAmt1"     expr="TXNAMT"/>   <!--银联返回订单金额-->
            <set name="ORDERDATE"   expr="SUBSTR(TXNTIME,1,8)"/>
            <set name="bankCode"    value="01010000"/>
            <set name="bizType"     value="00"/>
         </if>
         
         <set name="notifyMsg"    expr="notifyMsg"/>   <!--交行-->
         <if condition="NOT(ISNULL(notifyMsg))">
           <do func="initBCMB2CMerchant" error="IGNORE">
              <para name="apiURL"                   expr="APIURL"/>         <!--API请求URL -->
              <para name="orderURL"                 expr="B2CBCMORDERURL"/> <!--订单支付请求和一键支付开通URL-->
              <para name="shortPayURL"              expr="SHORTPAYURL"/>    <!--一键支付API请求URL-->
              <para name="enableLog"                expr="ENABLELOG"/>      <!--日志开关（true:表示写日志,false: 表示不写日志）-->
              <para name="logPath"                  expr="STRCAT(GETCURAPPHOME(),LOGPATH)"/> <!--日志文件存放目录-->
              <para name="settlementFilePath"       expr="STRCAT(GETCURAPPHOME(),SETTLEMENTFILEPATH)"/> <!--下载结算明细文件存放目录-->
              <para name="merchantCertFile"         expr="STRCAT(GETCURAPPHOME(),MERCHANTCERTFILE)"/>   <!--商户证书文件（绝对路径）-->
              <para name="merchantCertPassword"     expr="MERCHANTCERTPASSWORD"/> <!--商户证书私钥加密密码-->
              <para name="rootCertFile"             expr="STRCAT(GETCURAPPHOME(),ROOTCERTFILE)"/> <!--交通银行生产根证书-->
            </do>   
            <if condition="#RetCod==1">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="07004"/>
               <set name="RspMsg"    value="初始化失败"/>
               <return/>  
            </if>
            <do func="BCMMerchantResult" error="IGNORE">
              <para name="notifyMsg" expr="notifyMsg" />
            </do>
            <if condition="#RetCod!=0">
              <set name="RspCod"    value="08002"/>
              <set name="RspMsg"    value="解析交行返回结果失败"/>
              <return/>
            </if>
            <if condition="#RetCod==0">
              <set name="OrdStatus"  value="01"/>
              <set name="PayRet"      value="00"/>
            </if>
            <set name="bankCode"    value="03010000"/>        
            <set name="payOrdNo"    expr="payOrdNo"/> 
            <set name="ordAmt1"     expr="AMTPOWER(ordAmt1,2)"/>
         </if>
         
         <if condition="IS_EQUAL_STRING(transRst,'1')">    <!--沃支付 验签-->
            <set name="retmsg" value="SUCCESS"/>
            <set name="XmlFlag" value="2"/>
            
            <set name="ConfigName" value="Ltpay"/>
            <quote name="ReadXmlCfg"/>
            <set name="Key"       expr="merchantSignKey"/>
            <set name="merno1"    expr="merno"/>
            <set name="_REQUESTATTR.FORWARDURL"   expr="succePage"/>
            
            <!--查询沃支付信息-->
            <do func="TdOrderPay"     error="IGNORE">
            </do>
            <if condition="#RetCod!=0">
               <set name="RspCod"         value="09997"/>
               <set name="RspMsg"         value="验签失败"/>   
               <return/>
            </if> 
            <set name="MsgTyp"    value="N"/>
            <set name="RspCod"    value="00000"/>
            <set name="RspMsg"    value="交易成功"/>
            
            <set name="payOrdNo"    expr="orderNo"/>
            <set name="ordAmt1"     expr="AMOUNT"/>
            <set name="ORDERDATE"   expr="SUBSTR(ORDERDATE,1,8)"/>
            <set name="bankCode"    value="LTW"/>
            
         </if>
         <set name="TraceTime"     expr="GETDATETIME()"/>  <!--支付成功时间-->
         <set name="merRemark"     value="商物通"/>
         
         <!-- 用户等待最长时间(该时间必须控制在页面超时前) -->
         <set name="max"           value="8"/>
         <set name="i"             value="1"/>
         <!--对同一个订单号进行加锁-->
         <do func="Lock">
            <para name="RecKey"     expr="payOrdNo" />
            <para name="AutoUnLock" value="yes" />
         </do>
         <if condition="#RetCod!=0">
            <while condition="INTCMP(i,2,max)">
                <do func="Lock">
                    <para name="RecKey"     expr="payOrdNo" />
                    <para name="AutoUnLock" value="yes" />
               </do>
               <if condition="#RetCod!=0">
                   <do func="Sleep">
                       <para name="SleepTime"     value="1" />
                   </do>
                   <set name="i"                  expr="ADD(i,1)"/>
               </if>
               <else>
                   <set name="i"                  value="0"/>
                   <return/>
               </else>
            </while>
         </if>
         
         <if condition="INTCMP(i,5,max)">
            <set name="RspCod"           value="08001"/>
            <set name="RspMsg"           value="系统交易加锁失败，请稍后重试！"/>
            <return/>
         </if>
         
         <!--查询URL-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryURL" />
         </do>
         <set name="RCS_USER_CODE"       expr="CUST_ID"/>  <!--用户ID-->
         <set name="RCS_PAY_TYPE"        value="800019"/>  <!--本次交易码，订单支付-->
         <set name="RCS_PRD_NO"          expr="prdOrdNo"/> <!--订单号，如果不涉及置空-->
         <if condition="#RetCod!=0">
            <set name="RspCod"           value="08001"/>
            <set name="RspMsg"           value="该支付订单信息不存在"/>
            <return/>
         </if>
         <set name="prodcode"  expr="prodcode"/>
         <if condition="IS_EQUAL_STRING(prodcode,'CP00000003')">
            <set name="merjoggle" value="CP3"/>
         </if>
         
         <!-- 校验用户和账户余额查询 逻辑处理提前 -->
         <set name="payacno"        expr="SESSIONS.PAYACNO"/>
         <if condition="AND(NOT(ISNULL(payacno)),NOT(ISNULL(CUST_ID)))">
            <!--查询客户账户-->
            <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd" sql="SelCusAcc"/>
            </do>
            <if condition="#RetCod==2">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="07016"/>
               <set name="RspMsg"    value="该用户账户信息不存在"/> 
               <return/> 
            </if> 
            <elseif condition="#RetCod!=0">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09999"/>
               <set name="RspMsg"    value="系统错误"/>
               <return/> 
            </elseif>
            <set name="payacno" expr="pay_ac_no"/>
            
            <!--查询账户余额-->
            <quote name="selAccBal"/>
            <set name="AC_BAL"      expr="AC_BAL"/>
            
         </if>
         
         <if condition="IS_EQUAL_STRING(PrdOrdType,'1')">
             <set name="_REQUESTATTR.FORWARDURL"  expr="PayErrPage"/>
         </if>
         <else>
             <set name="_REQUESTATTR.FORWARDURL"  expr="RegErrPage"/>
         </else>
         <if condition="IS_NOEQUAL_STRING(OrdStatus,'00')">
            <set name="PrdOrdType"               expr="PrdOrdType"/>
            <if condition="OR(IS_EQUAL_STRING(PrdOrdType,'1'),IS_EQUAL_STRING(PrdOrdType,'3'))">
              <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                <set name="sucDat"                   expr="FMTDATE(GETDATE(),0,4)"/> 
                <set name="SUCAMT"                   expr="AMTADDDOT(txAmt)"/>
                <set name="_REQUESTATTR.FORWARDURL"  expr="RegSucPage"/>
                <return/>
              </if>
              <else>
                <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                   <set name="RspCod"    value="06001"/>
                   <set name="RspMsg"    value="该订单状态不能支付"/>
                   <return/>
                </if>
              </else>
            </if>
            <else>
              <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                <set name="_REQUESTATTR.FORWARDURL"  expr="STRCAT(payResult,'?payordno=',payOrdNo)"/>
                <return/>
              </if>
              <else>
                <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                   <set name="RspCod"    value="06001"/>
                   <set name="RspMsg"    value="该订单状态不能支付"/>
                   <return/>
                </if>
              </else>
            </else>
         </if>
           
         <set name="BANKCODE"   expr="bnkCod"/>
         
         <!--判断金额是否与支付订单中的金额一致-->
         <if condition="IS_EQUAL_STRING(payType,'04')">
            <if condition="IS_NOEQUAL_STRING(mulAmt,ordAmt1)">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="08016"/>
               <set name="RspMsg"    value="订单金额与应支付金额不符"/>
               <return/>
            </if>
         </if>
         <else>
            <if condition="ISNULL(txnComAmt)">
               <set name="txnComAmt" value="0"/>
            </if>
            <if condition="IS_NOEQUAL_STRING(txamt,ordAmt1)"><!--订单金额加佣金-->
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="08016"/>
               <set name="RspMsg"    value="订单金额与应支付金额不符"/>
               <return/>
            </if>
         </else>
         
         <set name="sucDat" expr="FMTDATE(SUBSTR(actdat,1,8),0,4)"/>
         <if condition="IS_EQUAL_STRING(BANKCODE,'01040000')">
            <quote name="BOCreturn"/>      <!--  中行返回结果  -->    
         </if>
         <elseif condition="IS_EQUAL_STRING(BANKCODE,'CCB')">
            <if condition="IS_EQUAL_STRING(SUCCESS,'Y')">
               <set name="PayRet"      value="00"/>
               <set name="OrdStatus"   value="01"/>
               <set name="BnkDat"      expr="ACCDATE"/>
               <set name="bankStlDate" expr="ACCDATE"/>   
            </if> 
         </elseif>
         <elseif condition="IS_EQUAL_STRING(BANKCODE,'03010000')">
            <set name="PayRet"         value="00"/>
            <set name="OrdStatus"      value="01"/>
            <set name="BnkDat"         expr="ACCDATE"/>
            <set name="bankStlDate"    expr="ACCDATE"/>  
         </elseif>
         <elseif condition="IS_EQUAL_STRING(BANKCODE,'03080000')">
            <if condition="IS_EQUAL_STRING(SUCCEED,'Y')">
               <set name="PayRet"      value="00"/>
               <set name="OrdStatus"   value="01"/>
               <set name="BnkDat"      expr="SUBSTR(DATE,1,8)"/>
               <set name="bankStlDate" expr="SUBSTR(DATE,1,8)"/>   
            </if> 
         </elseif>
         <elseif condition="IS_EQUAL_STRING(BANKCODE,'01020000')">
            <if condition="OR(IS_EQUAL_STRING(TRANSTAT,'1'),IS_EQUAL_STRING(TRANSTAT,'0'))">
               <set name="PayRet"      value="00"/>
               <set name="OrdStatus"   value="01"/>
               <set name="BnkDat"      expr="SUBSTR(ORDERDATE,1,8)"/>
               <set name="bankStlDate" expr="SUBSTR(ORDERDATE,1,8)"/>
               <set name="ReIcbcUrl"   expr="icbcret"/>   
            </if> 
         </elseif>
         <elseif condition="IS_EQUAL_STRING(BANKCODE,'01010000')"><!-- 银联 -->
            <if condition="IS_EQUAL_STRING(RESPCODE,'00')">
               <set name="PayRet"    value="00"/>
               <!--00:等待付款  01:付款成功  02:付款失败 03:退款申请 04:等待退款 05:退款成功
                   06:退款失败  07:同意撤销  08:拒绝撤销 09:撤销成功 10:撤销失败 12:预付款  
                   17:实付审核中18:实付审核通过 19:实付审核拒绝 99:超时-->
               <set name="OrdStatus" value="01"/>
               <set name="BnkDat"      expr="SUBSTR(DATE,1,8)"/>
               <set name="bankStlDate" expr="SUBSTR(DATE,1,8)"/>   
            </if>
            <else>
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09022"/>
               <set name="RspMsg"    value="银联支付失败"/>
               <set name="OrdStatus" value="02"/>  
            </else> 
         </elseif>
         
         <set name="NotifyTyp"    value="0"/>
         <set name="#url"         expr="NotifyUrl" />                    <!-- 同步返回 URL 通知商城地址 -->
         <delete name="signature"/>
         <if condition="IS_EQUAL_STRING(PrdOrdType,'0')">                   <!-- 消费-直接支付  -->  
            
            <if condition="IS_NOEQUAL_STRING(PayRet,'00')">
               <set name="RspCod"       expr="RspCod"/>
               <set name="Status"       value="2"></set>
               <quote name="UpdPay"/>
               <quote name="UpdPrd"/>

               <quote name="TimeTouch2Before"/>
               <quote name="TimeTouch2"/>  <!-- 付款后通知商城 -->
               <return/>
            </if>
            
            <set name="OrdStatus"    value="01"/>
            <set name="Status"       value="1"/>
            <set name="fee"          value="0"/>                               <!-- 批量作业时再去计算 -->
            
            <!--记账处理 start-->
            <set name="TXN_TYP"          value="2"/>                                <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->     
            <if condition="IS_EQUAL_STRING(payType,'01')">                          <!--网银支付-->
               <set name="txnAmt_fee"     expr="txAmt"/>
               <set name="BnkJnl"         expr="payOrdNo"/>
               <set name="bankJrnNo"      expr="payOrdNo"/>                           <!--银行返回订单号,银行流水号--> 
               <set name="Tran_type"      value="1"/>                                 <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合-->
               
               <!--记账所需数据-->
               <set name="ACC_TYP"        value="01"/>               <!--现金账户-->
               <set name="MER_ACC_TYP"    value="02"/>               <!-- 商户结算账户 -->
               <set name="DR_CR_FLAG"     value="+"/>                <!--账户余额增减标识 + 增加 - 减少-->
               <set name="CCY"            value="CNY"/>              <!--货币类型-->
               <set name="AMT"            expr="TXAMT"/>             <!--金额-->
               
               <set name="IS_ACT"         value="Y"/>                <!--是否实时记账 Y 是 N 否-->
               
               <if condition="IS_EQUAL_STRING(flag,'1')">        <!--有手续费-->
                  <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                  <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                  <set name="PARAMS"     expr="STRCAT(merPar,',',feePar)"/>
               </if>
               <else>                                            <!--无手续费-->
                  <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',AMT,'/',IS_ACT,'/')"/>        <!--商户记账参数-->
                  <set name="PARAMS"     expr="merPar"/>
               </else>
            </if>
            <elseif condition="AND(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(MulType,'01'))">    <!--混合支付-->
               <set name="txnAmt_fee"    expr="mulAmt"/>
               <set name="bankJrnNo"     expr="payOrdNo"/>                         <!--银行返回订单号--> 
               <set name="Tran_type"     value="5"/>                               <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合--> 
               
               <if condition="ISNULL(CASH_AC_BAL)">
                 <set name="CASH_AC_BAL" value="0"/>
               </if>
               <if condition="ISNULL(FROZ_BALANCE)">
                 <set name="FROZ_BALANCE" value="0"/>
               </if>
               <set name="casBal"     expr="SUB(CASH_AC_BAL,FROZ_BALANCE)"/>
               
               <!--记账所需数据-->
               <set name="ACC_TYP"    value="01"/>               <!--现金账户-->
               <set name="MER_ACC_TYP"    value="02"/>           <!-- 商户结算账户 -->
               <set name="CCY"        value="CNY"/>              <!--货币类型-->
               <set name="IS_ACT"     value="Y"/>                <!--是否实时记账 Y 是 N 否-->
               <set name="usrPar"     expr="STRCAT(CUST_ID,'/',ACC_TYP,'/','-','/',CCY,'/',ACCAMT,'/',IS_ACT,'/')"/>  <!--用户记账参数-->
               
               <if condition="DOUBLECMP(casBal,5,ACCAMT)">        <!--现金账户-->
                  <if condition="IS_EQUAL_STRING(flag,'1')">   <!--有手续费-->
                     <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                     <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                     <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar,',',feePar)"/>
                  </if>
                  <else>                                       <!--无手续费-->
                     <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',txAmt,'/',IS_ACT,'/')"/>      <!--商户记账参数-->
                     <set name="PARAMS"     expr="STRCAT(usrPar,',',merPar)"/>
                  </else>
               </if>
            </elseif>

            <set name="TRANTYPE"     value="2"/>                     <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->  
            <set name="TRANWAY"      value="01"/>                    <!--01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
            <set name="CCODE"        expr="merNo"/>                  <!--商户编号--> 
            
            <quote name="accProcess"/>   <!-- 平台记账，更新余额，记账务流水 -->
            <if condition="#RetCod!=0">
               <set name="RspCod"    value="07005"/>
               <set name="RspMsg"    value="银行付款成功，系统入账失败。请等待系统自动调账处理货联系客服人员！"/>
               <return/>
            </if>
            <!--记账处理 end-->
            
            <!--计算银行手续费-->
            <quote name="CalBnkFee"/> 
            
            <quote name="UpdPay"/>         <!--更新支付订单表-->
            <quote name="UpdPrd"/>         <!--更新商品订单表-->

            <set name="SmsContent"    expr="STRCAT('您好，您在',merRemark,'消费金额：',AMTADDDOT(txAmt),'元，通过商物通付款成功，如有疑问请联系',merRemark,'。')"></set>
            <quote name="sendSms"/>

	             
           <!--增加宏文件，处理物业缴费成功，通知第三方-->
            <set name="ConfigName"   value="PropertyMerId"/>
            <quote name="ReadXmlCfg"/>
            <if condition="IS_EQUAL_STRING(MERNO,ProMerId)">       <!--  生产商户号为固定商户号 需要配置  -->
            	   <quote name="RetBill"/>
            </if>
	          <else>
	          	 <set name="Status"     value="1"></set>
               <quote name="TimeTouch2Before"/>
	             <quote name="TimeTouch2"/>    <!--通知商城--> 
	          </else>
            <set name="_REQUESTATTR.FORWARDURL"  expr="STRCAT(payResult,'?payordno=',payOrdNo)"/>
         </if>
         <elseif condition="IS_EQUAL_STRING(PrdOrdType,'2')">               <!-- 消费-担保支付  -->  
            <set name="NotifyTyp"    value="0"/>
            <set name="#url"         expr="NotifyUrl" />                    <!-- 同步返回 URL  -->
            
            <if condition="IS_NOEQUAL_STRING(PayRet,'00')">
               <set name="RspCod"       expr="RspCod"/>
               <set name="Status"       value="2"></set>
               <quote name="UpdPay"/>

               <quote name="UpdPrd"/>
               <quote name="TimeTouch2"/>
               <return/>
            </if>
            
            <set name="Status"       value="1"/>
   
            <!--记账处理 start-->
            <!--计算商户手续费--> 
            <quote name="CalMerFee"/>
            <set name="TXN_TYP"          value="2"/>                                <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->     
            <if condition="IS_EQUAL_STRING(payType,'01')">                          <!--网银支付-->
               <set name="txnAmt_fee"    expr="txAmt"/>
               <set name="BnkJnl"         expr="payOrdNo"/>
               <set name="bankJrnNo"      expr="payOrdNo"/>                         <!--银行返回订单号--> 
               <set name="Tran_type"      value="1"/>                               <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合-->
               
               <!--记账参数准备-->
               <set name="pltMidPar"      expr="STRCAT('99999900000001','/','04','/','+','/','CNY','/',txAmt,'/','N','/')"/>        <!--平台担保账户记账参数-->
               <set name="PARAMS"         expr="pltMidPar"/>
            </if>
            <elseif condition="AND(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(MulType,'01'))">    <!--混合支付-->
               <set name="txnAmt_fee"     expr="mulAmt"/>
               <set name="bankJrnNo"      expr="payOrdNo"/>                            <!--银行返回订单号--> 
               <set name="Tran_type"      value="5"/>                                  <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合--> 
               
               <if condition="ISNULL(CASH_AC_BAL)">
                 <set name="CASH_AC_BAL" value="0"/>
               </if>
               <if condition="ISNULL(FROZ_BALANCE)">
                 <set name="FROZ_BALANCE" value="0"/>
               </if>
               <set name="casBal"     expr="SUB(CASH_AC_BAL,FROZ_BALANCE)"/>
               
               <if condition="DOUBLECMP(casBal,5,ACCAMT)">          <!--现金账户-->
                  <set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','-','/','CNY','/',ACCAMT,'/','Y','/')"/>            <!--用户记账参数-->
                  <set name="pltMidPar"  expr="STRCAT('99999900000001','/','04','/','+','/','CNY','/',txAmt,'/','N','/')"/>      <!--平台担保账户记账参数-->
                  <set name="PARAMS"     expr="STRCAT(usrPar,',',pltMidPar)"/> 
               </if>
            </elseif>

            <set name="TRANTYPE"     value="2"/>                                    <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->  
            <set name="TRANWAY"      value="01"/>                                   <!--01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
            <set name="CCODE"        expr="merNo"/>         

            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <do func="RollBackWork"/>
               <set name="RspCod"    value="07005"/>
               <set name="RspMsg"    value="支付失败"/>
               <set name="RspMsg"    value="银行付款成功，系统入账失败。请等待系统自动调账处理货联系客服人员！"/>
               <return/>
            </if>
            <!--记账处理 end-->
            
            <!--计算银行手续费-->
            <quote name="CalBnkFee"/>
            
            <set name="OrdStatus"     value="01"/>   <!--支付订单状态  交易成功-->
            <quote name="UpdPay"/>                   <!--更新支付订单表-->
            
            <set name="OrdStatus"     value="12"/>   <!--商品订单状态  支付成功-->
            <quote name="UpdPrd"/>

            <set name="SmsContent"    expr="STRCAT('您好，您在',merRemark,'消费金额：',AMTADDDOT(txAmt),'元，通过商物通付款成功，如有疑问请联系',merRemark,'。')"></set>
            <quote name="sendSms"/>

            <!--增加宏文件，处理物业缴费成功，通知第三方-->
            <set name="ConfigName"   value="PropertyMerId"/>
            <quote name="ReadXmlCfg"/>
            <if condition="IS_EQUAL_STRING(MERNO,ProMerId)">       <!--  生产商户号为固定商户号 需要配置  -->
            	 <quote name="RetBill"/>
            </if>
	          <else>
	          	 <set name="versionId"    value="5.0.0"/>
	          	 <set name="merchantId"   expr="MERNO"/>
	          	 <set name="orderId"      expr="orderId"/>
	          	 <set name="settleDate"   expr="settleDate"/>
	          	 <set name="completeDate"    expr="completeDate"/>
	          	 <set name="status"       expr="status"/>
	          	 <set name="notifyTyp"    expr="notifyTyp"/>
	          	 <set name="payOrdNo"     expr="payOrdNo"/>
	          	 <set name="orderAmt"     expr="orderAmt"/>
	          	 <set name="notifyUrl"    expr="notifyUrl"/>
	          	 <set name="signType"     value="CFCA"/>
	             <quote name="TimeTouch2"/>    <!--通知商城--> 
	          </else>
            <set name="_REQUESTATTR.FORWARDURL"           expr="STRCAT(payResult,'?payordno=',payOrdNo)"/>    
         </elseif>
         <elseif condition="OR(IS_EQUAL_STRING(PrdOrdType,'1'),IS_EQUAL_STRING(PrdOrdType,'3'))">               <!-- 充值  商户充值-->
            <set name="_REQUESTATTR.FORWARDURL"  expr="RegErrPage"/>        <!-- 设定充值处理失败错误页面 -->
            <if condition="IS_NOEQUAL_STRING(PayRet,'00')">
               <set name="RspCod"       expr="RspCod"/>
               <set name="Status"       value="2"></set>
               <quote name="UpdPay"/>
               <quote name="UpdReg"/>               <!--  更新充值订单  -->
               
               <quote name="TimeTouch2Before"/>
               <quote name="TimeTouch2"/>  <!-- 付款后通知商城 -->
               <return/>
            </if>
            
            <set name="acDate"  expr="GETDATE()"/>              <!--支付日期-->
            <set name="acTime"  expr="GETDATETIME('HHMISS')"/>  <!--支付时间-->   
            
            <if condition="ISNULL(txnComAmt)">
               <set name="txnComAmt" value="0"/>
            </if>
            <if condition="IS_EQUAL_STRING(prodcode,'CP00000003')">
               <set name="CUST_ID"        expr="MERNO"/><!--商户接口充值或者消费使用商户号-->
            </if>
            
            <if condition="DOUBLECMP(txnComAmt,'6','0')">   
               <set name="fee"            expr="txnComAmt"/>
               <set name="netAmt"         expr="SUB(txAmt,txnComAmt)"/>
               <set name="usrPar"         expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',netAmt,'/','Y','/')"/>               <!--用户记账参数-->
               <set name="feePar"         expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',txnComAmt,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
               <set name="PARAMS"         expr="STRCAT(usrPar,',',feePar)"/>
            </if>
            <else>
               <set name="flag"           value="0"/> 
               <set name="fee"            value="0"/>   
               <set name="usrPar"         expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',txAmt,'/','Y','/')"/>  <!--用户记账参数-->
               <set name="PARAMS"         expr="usrPar"/>
            </else>
            <set name="netRecAmt"         expr="SUB(txAmt,txnComAmt)"/>   <!--净额-->  

            <!--记账处理--> 
            <set name="TXN_TYP"           value="1"/>                     <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->      
            <quote name="accProcess"/>
            <if condition="#RetCod!=0">
               <do func="RollBackWork"/> 
               <set name="RspCod"    value="07005"/>
               <set name="RspMsg"    value="充值失败"/>
               <return/>
            </if>
            
            <!--计算银行手续费-->
            <set name="txnAmt_fee"     expr="txAmt"/>
            <quote name="CalBnkFee"/>
            
            <set name="TRANTYPE"       value="1"/>             <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
            <set name="TRANWAY"        expr="payType"/>        <!--交易方式 01网银、02终端、03消费卡、04虚拟账户、05快捷支付--> 
            <set name="TXCCY"          value="CNY"/>
            <set name="payType"        expr="payType"/>
            <set name="OrdStatus"     value="01"/>   <!--支付订单状态  交易成功-->
            <quote name="UpdPay"/>               <!--  更新支付订单  --> 
            <quote name="UpdReg"/>               <!--  更新充值订单  --> 
            <set name="merRemark"      value="账户充值"/> <!-- 商户信息 -->
            <set name="_REQUESTATTR.FORWARDURL"       expr="RegSucPage"/>    <!--异步通知页面-->
            
            <!--增加宏文件，通知第三方-->
	          <set name="Status"     value="1"></set>
            <quote name="TimeTouch2Before"/>
	          <quote name="TimeTouch2"/>    <!--通知商城--> 

         </elseif>
         <else>
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="09001"/>
            <set name="RspMsg"    value="系统错误"/>
            <set name="_REQUESTATTR.FORWARDURL"       expr="reqErrPage"/> 
            <return/>   
         </else>
         
         <!--通知风控系统登记订单信息-->
         <set name="ServiceCode" value="680517"/>
         <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
         <set name="TCODE"       expr="payOrdNo"/>           <!--平台流水号 支付订单号-->
         <set name="CTYPE"       value="1"/>                 <!--客户类型-->
         <set name="CLIENTCODE"  expr="CUST_ID"/>            <!--客户编号-->
         <set name="CLIENTNAME"  expr="SESSIONS.USRNAME"/>
         <set name="MOBILEPHONE" expr="SESSIONS.USRMP"/>
         <set name="TAMT"        expr="txAmt"/>
         <set name="TRANWAY"     value="01"/>
         <set name="REGDTTIME"   expr="STRCAT(acDate,acTime)"/>
         <set name="Time"        expr="acDate"/>
         <quote name="noticRcs"/>

         <set name="sucAmt"         expr="AMTADDDOT(TXAMT)"/>
         <set name="RspCod"         value="00000"/>
         <set name="RspMsg"         value="支付成功"/>
        
      </process>
   </transaction>


   <transaction code="565103" desc="退货订单结果处理-银行回调">
      <sql name="QryQRefInf"> <!--查询通知商城的URL 查询支付订单表-->
        SELECT refOrdNo,rfOrdTime,MerNo,oriPrdOrdNo,oriPayOrdNo,rfPayOrdNo,rfPayDate,txCcy,rfAmt,ACCAMT,MULAMT,fee,netRecAmt,rfSake,CUST_ID,
        bankCode,bankPayAcNo,bankPayUserNm,opkbnkNam,OrdStatus,rfReqDate,bankStlDate,bankJrnNo,BankError,NotifyUrl,oper_id ,Filed1 
         FROM StpRefInf
        WHERE RFPAYORDNO=#{ORDERID}
      </sql>
      <sql name="QryOldTyp"> <!--查询通知商城的URL 查询支付订单表-->
        SELECT a.PRDORDTYPE,b.PAYTYPE
         FROM stpprdinf a,STPPAYINF b
        WHERE a.PAYORDNO=b.PAYORDNO and a.PAYORDNO=#{PayOrdNo}
      </sql>
      <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
         SELECT CASH_AC_BAL,FROZ_BALANCE,TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'FM9999,999,999,990.00') AC_BAL FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNO}
      </sql>
      <sql name="SelCusAcc">
         SELECT pay_ac_no FROM arp_ac_cust_rel  WHERE CUST_ID=#{CUST_ID}
      </sql>
      <sql name="UpdRefPrd">
        UPDATE STPREFINF SET  NETRECAMT=#{NETRECAMT},ORDSTATUS=#{ORDSTATUS},FEE=#{FEE},
          ACCAMT=#{ACCAMT},MULAMT=#{MULAMT},rfReqDate=#{rfReqDate},BANKSTLDATE=#{BANKSTLDATE},BANKJRNNO=#{BANKJRNNO}
       WHERE refOrdNo=#{refOrdNo}
      </sql>
      <sql name="UpdPrdtotal">
         update stpprdinf set rfTotalAmt=(SELECT case when rfTotalAmt is null then 0+${rfAmt} else rfTotalAmt+${rfAmt} end rfTotalAmt FROM stpprdinf WHERE prdOrdNo=#{prdOrdNo} and MerNo=#{MerNo}) 
         where prdOrdNo=#{prdOrdNo} and MerNo=#{MerNo}
      </sql>
      <sql name="refStatus"><!--退款失败更新订单状态-->
        update STPREFINF set ordstatus=#{ordstatus} where refordno=#{REFORDNO}
      </sql>
      <sql name="SelFrzInf">
        select PAY_AC_NO,FROZ_AMT,BIZ_CODE,STATUS,FROZ_NO from ARP_AC_FORZZ_DETAILS where BIZ_CODE=#{CASORDNO} and STATUS='01'
      </sql>
      <sql name="UpdFrezInf"><!-- 更新冻结信息-->
         UPDATE ARP_AC_FORZZ_DETAILS SET STATUS='00',LST_UPT_DATE=#{LST_UPT_DATE},LST_UPT_TIME=#{LST_UPT_TIME} WHERE FROZ_NO=#{FROZ_NO}
      </sql>
      <process>
         <set name="ConfigName" value="SecCfg"/>
         <quote name="ReadXmlCfg"/>
         <set name="_REQUESTATTR.FORWARDURL"  expr="reqErrPage"/>    <!-- 请求错误页面 -->   

         <if condition="NOT(ISNULL(RESPCODE))">        <!-- 银联 -->
            <do func="FrontRcvResponse"     error="IGNORE" />
            <!--if condition="#RetCod!=0">
               <set name="RspCod"    value="09002"/>
               <set name="RspMsg"    value="银联返回验证失败"/>
               <return/>
            </if-->

            <set name="RFPAYORDNO"  expr="ORDERID" />
            <set name="BANKJRNNO"   expr="QUERYID" />
            <set name="ordAmt1"     expr="TXNAMT"/>   <!--银联返回订单金额-->
            <set name="BANKCODE"    value="01010000"/>
            <set name="bizType"     value="00"/>
         </if>
         <set name="merRemark"     value="商物通"/>
         <set name="TraceTime"     expr="GETDATETIME()"/>  <!--支付成功时间-->
         <set name="RFREQDATE"     expr="TraceTime"/>  <!--支付成功时间-->
         <set name="BANKSTLDATE" expr="GETDATE()" />
         
         <!-- 用户等待最长时间(该时间必须控制在页面超时前) -->
         <set name="max"           value="8"/>
         <set name="i"             value="1"/>
         <!--对同一个订单号进行加锁-->
         <do func="Lock">
            <para name="RecKey"     expr="RFPAYORDNO" />
            <para name="AutoUnLock" value="yes" />
         </do>
         <if condition="#RetCod!=0">
            <while condition="INTCMP(i,2,max)">
                <do func="Lock">
                    <para name="RecKey"     expr="payOrdNo" />
                    <para name="AutoUnLock" value="yes" />
               </do>
               <if condition="#RetCod!=0">
                   <do func="Sleep">
                       <para name="SleepTime"     value="1" />
                   </do>
                   <set name="i"                  expr="ADD(i,1)"/>
               </if>
               <else>
                   <set name="i"                  value="0"/>
                   <return/>
               </else>
            </while>
         </if>
         <if condition="INTCMP(i,5,max)">
            <set name="RspCod"           value="08001"/>
            <set name="RspMsg"           value="系统交易加锁失败，请稍后重试！"/>
            <return/>
         </if>
         
         <!-- 查询员退货交易订单信息 -->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryQRefInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"           value="08001"/>
            <set name="RspMsg"           value="该支付订单信息不存在"/>
            <return/>
         </if>
         
         <set name="RCS_USER_CODE"       expr="CUST_ID"/>  <!--用户ID-->
         <set name="RCS_PAY_TYPE"        value="800019"/>  <!--本次交易码，订单支付-->
         <set name="RCS_PRD_NO"          expr="refOrdNo"/> <!--订单号，如果不涉及置空-->
         <set name="RFAMT"          expr="RFAMT"/>
         <set name="PrdOrdNo"       expr="oriPrdOrdNo"/>
         <set name="PayOrdNo"       expr="oriPayOrdNo"/>

         <!-- 校验用户和账户余额查询 逻辑处理提前 -->
         <!--set name="payacno"        expr="SESSIONS.PAYACNO"/>
         <if condition="AND(NOT(ISNULL(payacno)),NOT(ISNULL(CUST_ID)))">
            <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd" sql="SelCusAcc"/>
            </do>
            <if condition="#RetCod==2">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="07016"/>
               <set name="RspMsg"    value="该用户账户信息不存在"/> 
               <return/> 
            </if> 
            <elseif condition="#RetCod!=0">
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09999"/>
               <set name="RspMsg"    value="系统错误"/>
               <return/> 
            </elseif>
            <set name="payacno" expr="pay_ac_no"/>

            <quote name="selAccBal"/>
            <set name="AC_BAL"      expr="AC_BAL"/>  
         </if-->
         
         <if condition="IS_NOEQUAL_STRING(OrdStatus,'00')">
            <set name="PrdOrdType"               expr="PrdOrdType"/>
            <if condition="OR(IS_EQUAL_STRING(PrdOrdType,'1'),IS_EQUAL_STRING(PrdOrdType,'3'))">
              <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                <set name="sucDat"                   expr="FMTDATE(GETDATE(),0,4)"/> 
                <set name="SUCAMT"                   expr="AMTADDDOT(txAmt)"/>
                <set name="_REQUESTATTR.FORWARDURL"  expr="RegSucPage"/>
                <return/>
              </if>
              <else>
                <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                   <set name="RspCod"    value="06001"/>
                   <set name="RspMsg"    value="该订单状态不能支付"/>
                   <return/>
                </if>
              </else>
            </if>
            <else>
              <if condition="IS_EQUAL_STRING(OrdStatus,'03')">
                <set name="_REQUESTATTR.FORWARDURL"  expr="STRCAT(payResult,'?payordno=',payOrdNo)"/>
                <return/>
              </if>
              <else>
                <if condition="IS_EQUAL_STRING(OrdStatus,'03')">
                   <set name="RspCod"    value="06001"/>
                   <set name="RspMsg"    value="该订单状态不能支付"/>
                   <return/>
                </if>
              </else>
            </else>
         </if>
         
         <!--判断金额是否与支付订单中的金额一致-->
         <if condition="IS_NOEQUAL_STRING(ordAmt1,RFAMT)"><!--订单金额加佣金-->
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="08016"/>
            <set name="RspMsg"    value="订单金额与应支付金额不符"/>
            <return/>
         </if>

         <if condition="IS_EQUAL_STRING(BANKCODE,'01010000')"><!-- 银联 -->
            <if condition="IS_EQUAL_STRING(RESPCODE,'00')">
               <set name="PayRet"    value="00"/>
               <!--00:等待付款  01:付款成功  02:付款失败 03:退款申请 04:等待退款 05:退款成功
                   06:退款失败  07:同意撤销  08:拒绝撤销 09:撤销成功 10:撤销失败 12:预付款  
                   17:实付审核中18:实付审核通过 19:实付审核拒绝 99:超时-->
               <set name="OrdStatus" value="01"/>
            </if>
            <else>
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09022"/>
               <set name="RspMsg"    value="银联支付失败"/>
               <set name="OrdStatus" value="03"/>  
            </else> 
         </if>
         
         <!-- 查询原支付方式 -->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryOldTyp" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"           value="08001"/>
            <set name="RspMsg"           value="该支付订单信息不存在"/>
            <return/>
         </if>
         
         <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
            <if condition="IS_EQUAL_STRING(PrdOrdType,'0')">                   <!-- 原消费-直接支付  -->              
               <!--记账处理 start-->
               <set name="TXN_TYP"          value="7"/>                                <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->     
               <if condition="IS_EQUAL_STRING(payType,'01')">                          <!--网银支付-->
                  <set name="netRecAmt"     expr="ordAmt1"/>
                  <!--记账所需数据-->
                  <set name="ACC_TYP"        value="01"/>               <!--现金账户-->
                  <set name="MER_ACC_TYP"    value="02"/>               <!-- 商户结算账户 -->
                  <set name="DR_CR_FLAG"     value="+"/>                <!--账户余额增减标识 + 增加 - 减少-->
                  <set name="CCY"            value="CNY"/>              <!--货币类型-->   
                  <set name="IS_ACT"         value="Y"/>                <!--是否实时记账 Y 是 N 否-->
                  
                  <if condition="IS_EQUAL_STRING(flag,'1')">        <!--有手续费-->
                     <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                     <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                     <set name="PARAMS"     expr="STRCAT(merPar,',',feePar)"/>
                  </if>
                  <else>                                            <!--无手续费-->
                     <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>  <!--商户记账参数-->
                     <set name="PARAMS"     expr="merPar"/>
                  </else>
               </if>
            
               <!--记账处理-->
               <quote name="accProcess"/> 
               <if condition="#RetCod!=0">
                  <set name="ordstatus" value="03"/><!--退款失败更新订单状态-->
                  <do func="ExecSql" error="IGNORE">
                    <para name="SqlCmd" sql="refStatus"/>
                  </do>
                  <set name="RspCod"    value="07001"/>
                  <set name="RspMsg"    expr="STRCAT('交易失败！',RspMsg)"/>
                  <set name="DWZ_STATUS_CODE"     value="300"/>
                  <set name="DWZ_RSP_MSG"         expr="RspMsg"/> 
                  <set name="RspCod"    value="07001"/>
                  <set name="RspMsg"    value="交易失败，请联系客服！"/>
                  <do func="RollBackWork"/>    <!--回滚提交数据-->
                  <return/>
               </if>
               
               <set name="OrdStatus"     value="02"/>              <!-- 退款订单-退款成功-->
               <set name="rfReqDate"     expr="GETDATETIME()"/>    <!--退款成功时间-->
               
               <quote name="SelFrzInf"/>
               <!--将扣除的提现金额解冻 并从账户里扣除-->
               <set name="RCS_PRD_NO"    expr="refOrdNo"/><!--订单号，如果不涉及置空-->
               <set name="PAY_AC_NO"     expr="PAY_AC_NO"/>
               <set name="txAmt"         expr="STRCAT('-',FROZ_AMT)"/>
               <quote name="frezzAmt"/>
               <set name="txAmt"         expr="FROZ_AMT"/>
               <!--更新冻结状态-->
               <quote name="UpdFrezz"/>
               <!--记账处理 end-->
            </if>
            <else>
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09001"/>
               <set name="RspMsg"    value="系统错误"/>
               <return/>
            </else>
         </if>
         <else>
            <quote name="SelFrzInf"/>
            <!--将扣除的提现金额解冻 并从账户里扣除-->
            <set name="RCS_PRD_NO"    expr="refOrdNo"/><!--订单号，如果不涉及置空-->
            <set name="PAY_AC_NO"     expr="PAY_AC_NO"/>
            <set name="txAmt"         expr="STRCAT('-',FROZ_AMT)"/>
            <quote name="frezzAmt"/>
            <set name="txAmt"         expr="FROZ_AMT"/>
            <!--更新冻结状态-->
            <quote name="UpdFrezz"/>
         </else>
         
         <!--更新退款订单-->
         <do func="ExecSql" error="IGNORE">  
             <para name="SqlCmd" sql="UpdRefPrd"/>
         </do>
         <if condition="#RetCod==2">
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="无符合条件记录"/>
            <return/>
         </if>
         <elseif condition="#RetCod!=0">
            <set name="RspCod"    value="06003"/>
            <set name="RspMsg"    value="更新订单信息错误"/>
            <return/>
         </elseif>

         <!--更新商品订单-->
         <if condition="IS_EQUAL_STRING(OrdStatus,'02')">
            <!--虚拟账号的退款，直接累计退款-->
            <do func="ExecSql" error="IGNORE">  
               <para name="SqlCmd" sql="UpdPrdtotal"/>
            </do>
            <if condition="#RetCod==2">
               <set name="RspCod"    value="01003"/>
               <set name="RspMsg"    value="无符合条件记录"/>
               <return/>
            </if>
            <elseif condition="#RetCod!=0">
               <set name="RspCod"    value="06003"/>
               <set name="RspMsg"    value="更新订单信息错误"/>
               <return/>
            </elseif>
         </if>
           
         <!--通知风控系统登记订单信息-->
         <set name="ServiceCode" value="680517"/>
         <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
         <set name="TCODE"       expr="RFPAYORDNO"/>           <!--平台流水号-->
         <set name="CTYPE"       value="1"/>                 <!--客户类型-->
         <set name="CLIENTCODE"  expr="ruserid"/>            <!--客户编号-->
         <set name="CCODE"       expr="merNo"/>              <!--商户编号-->
         <set name="CNAME"       expr="MERREMARK"/>
         <set name="TRANTYPE"    value="8"/>                 <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
         <set name="Tran_type"   value="4"/>                 <!--交易方式 1网银、2终端、3消费卡、4虚拟积分等-->
         <set name="TAMT"        expr="Amt"/>
         <set name="REGDTTIME"   expr="STRCAT(acDate,acTime)"/>
         <set name="Time"        expr="acDate"/>
         <quote name="noticRcs"/>
         
         <set name="MsgTyp"    value="N"/>
         <set name="RspCod"    value="00000" />
         <set name="RspMsg"    value="交易成功!" />
        
      </process>
   </transaction>

   <transaction code="signpaySback" desc="无跳转支付异步回调">
       <sql name="QryURL"> <!--查询订单基本信息-->
        SELECT b.NotifyUrl,a.PrdOrdNo,a.OrdStatus,b.PRDNAME,a.PrdOrdType,
               a.payType,a.MulType,a.txamt,NVL(a.fee,'0') txnComAmt,a.accAmt,a.mulAmt,a.merno,a.BANKCOD,a.BANKCOD bnkCod,a.CUST_ID,a.ActDat,nvl(a.BnkMerNo,' ') BnkMerNo
          FROM StpPayInf a,StpPrdInf b 
         WHERE a.payOrdNo=#{payOrdNo} and a.payOrdNo=b.payOrdNo
       </sql>
       <sql name="UpdPay"> <!-- 更新支付订单表 -->
         payOrdNo=#{payOrdNo}
       </sql>
       <sql name="UpdPrd"> <!-- 更新商品订单表 -->
         prdOrdNo=#{prdOrdNo} and merNo=#{merno} 
       </sql> 
       <sql name="QryPrdInf"> <!-- 查询商品订单 -->
         SELECT bizType FROM StpPrdInf WHERE prdordno=#{prdordno} and merno=#{merno}
       </sql>
       <sql name="UpdReg"> <!-- 更新充值订单表 -->
         prdordno=#{PrdOrdNo} and prdOrdType='1'
       </sql>  
       <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
         SELECT CASH_AC_BAL,FROZ_BALANCE FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNO}
       </sql>
       <sql name="SelBnkFee"><!-- 查询银行费率信息-->
         SELECT FEE_CODE FROM CoopBank WHERE BANK_CODE=#{bnkCod}
       </sql> 
       <sql name="SelBnkMerFee"><!-- 查询银行商户费率信息-->
         SELECT FEE_CODE FROM COOPBANK_FEE WHERE BANK_CODE=#{bnkCod} and BANK_MERNO=#{BnkMerNo}
       </sql>
       <sql name="SelMerFee">
         SELECT fee_code 
           FROM ARP_CUST_FEE 
          WHERE pay_ac_no in (select pay_ac_no from arp_ac_cust_rel where CUST_ID=#{merNo}) and biz_type=#{bizType} and pay_type=#{payType}
       </sql>
       <sql name="SelCusAcc">
         SELECT pay_ac_no FROM arp_ac_cust_rel  WHERE CUST_ID=#{CUST_ID}
       </sql>
       <sql name="QrySendInf1">
         SELECT merNo,prdordno,txamt as ordamt,OrdStatus,ActDat as paytime,'M' as signType FROM stppayinf WHERE payordno=#{orderNo}
       </sql>
       <sql name="QrySendInf2">
         SELECT filed4 as Orddate,FILED5 as  respMode,retUrl as ReturnUrl,notifyUrl as notifyUrl FROM stpprdinf WHERE payordno=#{orderNo}
       </sql>
       <sql name="QryStpBankInf"> <!--  查询用户绑定的银行卡(借记卡、信用卡)  --> 
        SELECT upper(CARD_BANK) AS bank_code,(case when CARD_TYPE='00' then '1' when CARD_TYPE='01' then '2'   else '-1' end) as type_card,CARD_NO as cardno,CARD_NAME as cust_name,CARD_BANK_THREE as cvv2,VALIDITY_M as month,VALIDITY_Y as year,BANK_RES_PHONE as bind_mob,BANK_CONF from STPBANKTB where BAK_SEQ=#{no_agree}
       </sql>
       <sql name="QryUserBank"><!--  检测用户是否绑定了该卡  -->
          SELECT CUST_ID as BIND_CUST_ID,BAK_SEQ FROM STPBANKTB WHERE CARD_TYPE=#{CardType} AND CARD_NO=#{BnkAcNo} 
       </sql>
       <process>
              <set name="payOrdNo" expr="orderId"/><!--商户订单号 用于更新-->
              
              <!-- <do func="WuTZRcvPayResponse" error="IGNORE"></do>
              <if condition="#RetCod!=0">
                  <set name="MsgTyp"    value="E"/>
                  <set name="RspCod"    value="01113"/>
                  <set name="RspMsg"    value="验签失败！"/>
                  <return/>
              </if>
              <elseif condition="#RetCod==0"> -->
              <if condition="IS_NOEQUAL_STRING(respCode,'00')">
                  <set name="MsgTyp"    value="E"/>
                  <set name="RspCod"    value="01114"/>
                  <set name="RspMsg"    value="该交易失败"/>
                  <return/>
              </if>
              <set name="BANKJRNNO"   expr="QUERYID"/>
                <do func="ReadRecord" error="IGNORE">
                   <para name="SqlCmd" sql="QryURL"/>
                </do>
                <if condition="IS_EQUAL_STRING(PrdOrdType,'0')">                           <!-- 消费-快捷支付  -->  
                    <set name="OrdStatus"    value="01"/>
                    <set name="Status"       value="1"/>
		            <set name="acDate"       expr="GETDATE()"/>                             <!--支付成功日期-->
		            <set name="acTime"       expr="GETDATETIME('HHMISS')"/>                 <!--支付成功时间-->
		            <!--计算商户手续费--> 
		            <quote name="CalMerFee"/>
		            
		            <!--记账处理 start-->
		            <set name="TXN_TYP"          value="2"/>                                <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->     
		            	<if condition="IS_EQUAL_STRING(payType,'03')">                          <!--快捷支付-->
			               <set name="txnAmt_fee"    expr="txAmt"/>
			               <set name="BnkJnl"         expr="BANKJRNNO"/>
			               <set name="bankJrnNo"      expr="BANKJRNNO"/>                          <!--银行返回订单号,银行流水号--> 
			               <set name="Tran_type"      value="1"/>                                 <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合-->
			               
			               <!--记账所需数据-->
			               <set name="ACC_TYP"    value="01"/>               <!--现金账户-->
			               <set name="MER_ACC_TYP" value="02"/>              <!-- 商户结算账户 -->
			               <set name="DR_CR_FLAG" value="+"/>                <!--账户余额增减标识 + 增加 - 减少-->
			               <set name="CCY"        value="CNY"/>              <!--货币类型-->
			               <set name="AMT"        expr="TXAMT"/>             <!--金额-->
			               <set name="IS_ACT"     value="Y"/>                <!--是否实时记账 Y 是 N 否-->
			               
			               <if condition="IS_EQUAL_STRING(flag,'1')">        <!--有手续费-->
			                  <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
			                  <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
			                  <set name="PARAMS"     expr="STRCAT(merPar,',',feePar)"/>
               			  </if>
               			  <else>                                            <!--无手续费-->
                  		      <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',AMT,'/',IS_ACT,'/')"/>        <!--商户记账参数-->
                  			  <set name="PARAMS"     expr="merPar"/>
               			  </else>
            			</if>
            			<elseif condition="AND(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(MulType,'03'))">    <!--混合支付-->
               				<set name="txnAmt_fee"    expr="mulAmt"/>
               				<set name="bankJrnNo"     expr="BANKJRNNO"/>                         <!--银行返回订单号--> 
               				<set name="Tran_type"     value="5"/>                               <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合--> 
               
               				<if condition="ISNULL(CASH_AC_BAL)">
                 				<set name="CASH_AC_BAL" value="0"/>
               				</if>
               				<if condition="ISNULL(FROZ_BALANCE)">
                 				<set name="FROZ_BALANCE" value="0"/>
               				</if>
               				<set name="casBal"     expr="SUB(CASH_AC_BAL,FROZ_BALANCE)"/>
               
               				<!--记账所需数据-->
               				<set name="ACC_TYP"    value="01"/>               <!--现金账户-->
               				<set name="MER_ACC_TYP"    value="02"/>           <!-- 商户结算账户 -->
               				<set name="CCY"        value="CNY"/>              <!--货币类型-->
               				<set name="IS_ACT"     value="Y"/>                <!--是否实时记账 Y 是 N 否-->
               				<set name="usrPar"     expr="STRCAT(CUST_ID,'/',ACC_TYP,'/','-','/',CCY,'/',ACCAMT,'/',IS_ACT,'/')"/>  <!--用户记账参数-->
               
               				<if condition="DOUBLECMP(casBal,5,ACCAMT)">        <!--现金账户-->
                  				<if condition="IS_EQUAL_STRING(flag,'1')">   <!--有手续费-->
                     				<set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                     				<set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                     				<set name="PARAMS"     expr="STRCAT(usrPar,',',merPar,',',feePar)"/>
                  				</if>
                  				<else>                                       <!--无手续费-->
                     				<set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',txAmt,'/',IS_ACT,'/')"/>      <!--商户记账参数-->
                     				<set name="PARAMS"     expr="STRCAT(usrPar,',',merPar)"/>
                  				</else>
               				</if>
               				<else>
                				<set name="MsgTyp"    value="E"/>
                      			<set name="RspCod"    value="09999"/>
                				<set name="RspMsg"    value="账户可用余额已不够支付订单部分金额，请重新选择支付方式！"/>
                				<return/>
               				</else>
            			</elseif>

            			<set name="TRANTYPE"     value="2"/>                                    <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->  
            			<set name="TRANWAY"      value="05"/>                                   <!--01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
            			<set name="CCODE"        expr="merNo"/>                                 <!--商户编号-->
            			<set name="CNAME"        expr="MERREMARK"/>          
            
            			<quote name="accProcess"/>
            			<if condition="#RetCod!=0">
               				<set name="RspCod"    value="07005"/>
               				<set name="RspMsg"    value="系统扣款失败，请稍后重试！"/>
                			<do func="RollBackWork"/> 
               				<return/>
            			</if>
            			<!--记账处理 end-->
                        <set name="ORDSTATUS"      value="01"/>
            			<!--计算银行手续费-->
            			<quote name="CalBnkFee"/>
            
            			<quote name="UpdPay"/>    
            			<quote name="UpdPrd"/>
            			<set name="SmsContent"    expr="STRCAT('您好，您在',merRemark,'消费金额：',AMTADDDOT(txAmt),'元，通过商物通付款成功，如有疑问请联系',merRemark,'。')"></set>
            
            			<!--取公共参数配置-->
            			<quote name="sendSms"/>
            
         		</if>
         		<elseif condition="IS_EQUAL_STRING(PrdOrdType,'2')">               <!-- 消费-担保支付  -->  
            		<if condition="ISNULL(merRemark)">
               			<set name="merRemark"         value="商物通"/>
            		</if>
            
            		<set name="Status"       value="1"/>

            		<!--记账处理 start-->
              		<!--计算商户手续费--> 
            		<quote name="CalMerFee"/>
            		<set name="TXN_TYP"          value="2"/>                                <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->     
            		<if condition="IS_EQUAL_STRING(payType,'03')">                          <!--快捷支付-->
               			<set name="txnAmt_fee"    expr="txAmt"/>
               			<set name="BnkJnl"         expr="BANKJRNNO"/>
               			<set name="bankJrnNo"      expr="BANKJRNNO"/>                         <!--银行返回订单号--> 
               			<set name="Tran_type"      value="1"/>                               <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合-->
               
               			<!--记账参数准备-->
               			<set name="pltMidPar"      expr="STRCAT('99999900000001','/','04','/','+','/','CNY','/',txAmt,'/','N','/')"/>        <!--平台担保账户记账参数-->
               			<set name="PARAMS"         expr="pltMidPar"/>
            		</if>
            		<elseif condition="AND(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(MulType,'03'))">    <!--混合支付-->
               			<set name="txnAmt_fee"     expr="mulAmt"/>
               			<set name="bankJrnNo"      expr="BANKJRNNO"/>                           <!--银行返回订单号--> 
               			<set name="Tran_type"      value="5"/>                                  <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合--> 
               
               			<if condition="ISNULL(CASH_AC_BAL)">
                 			<set name="CASH_AC_BAL" value="0"/>
               			</if>
               			<if condition="ISNULL(FROZ_BALANCE)">
                 			<set name="FROZ_BALANCE" value="0"/>
               			</if>
               			<set name="casBal"     expr="SUB(CASH_AC_BAL,FROZ_BALANCE)"/>
               
               			<if condition="DOUBLECMP(casBal,5,ACCAMT)">          <!--现金账户-->
                  			<set name="usrPar"     expr="STRCAT(CUST_ID,'/','01','/','-','/','CNY','/',ACCAMT,'/','Y','/')"/>              <!--用户记账参数-->
                  			<set name="pltMidPar"  expr="STRCAT('99999900000001','/','04','/','+','/','CNY','/',txAmt,'/','N','/')"/>      <!--平台担保账户记账参数-->
                  			<set name="PARAMS"     expr="STRCAT(usrPar,',',pltMidPar)"/> 
               			</if>
               			<else>
                			<set name="MsgTyp"    value="E"/>
                			<set name="RspCod"    value="09999"/>
                			<set name="RspMsg"    value="账户可用余额已不够支付订单部分金额，请重新选择支付方式！"/>
                			<return/>
               			</else>
            	    </elseif>

            	    <set name="TRANTYPE"     value="2"/>                                    <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->  
            	    <set name="TRANWAY"      value="05"/>                                   <!--01网银、02终端、03消费卡、04虚拟账户、05快捷支付-->
                    <set name="CCODE"        expr="merNo"/>                                 <!--商户编号-->

            	    <quote name="accProcess"/>
            		<if condition="#RetCod!=0">
               			<set name="RspCod"    value="07005"/>
               			<set name="RspMsg"    value="系统扣款失败，请稍后重试！"/>
                		<do func="RollBackWork"/> 
               			<return/>
            		</if>
            		<!--记账处理 end-->
                    <set name="ORDSTATUS"      value="01"/>
            		<!--计算银行手续费-->
            		<quote name="CalBnkFee"/>
            
            		<set name="OrdStatus"    value="01"/>  
            		<quote name="UpdPay"/>        <!--更新支付订单表-->
            
            		<set name="OrdStatus"    value="12"/>  
            		<quote name="UpdPrd"/>        <!--更新商品订单表-->
            		<set name="SmsContent"    expr="STRCAT('您好，您在',merRemark,'消费金额：',AMTADDDOT(txAmt),'元，通过商物通付款成功，如有疑问请联系',merRemark,'。')"></set>
            		<quote name="sendSms"/>
            
                </elseif>
         		<elseif condition="IS_EQUAL_STRING(PrdOrdType,'1')">               <!-- 充值  -->
            		<set name="acDate"  expr="GETDATE()"/>              <!--支付日期-->
            		<set name="acTime"  expr="GETDATETIME('HHMISS')"/>  <!--支付时间-->   
            
            		<if condition="ISNULL(txnComAmt)">
               			<set name="txnComAmt" value="0"/>
            		</if>
            		<if condition="DOUBLECMP(txnComAmt,'6','0')">
               			<set name="fee"            expr="txnComAmt"/>
               			<set name="netAmt"         expr="SUB(txAmt,txnComAmt)"/>
               			<set name="usrPar"         expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',netAmt,'/','Y','/')"/>               <!--用户记账参数-->
               			<set name="feePar"         expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',txnComAmt,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
               			<set name="PARAMS"         expr="STRCAT(usrPar,',',feePar)"/>
            		</if>
            		<else>
               			<set name="flag"           value="0"/> 
               			<set name="fee"            value="0"/>   
               			<set name="usrPar"         expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',txAmt,'/','Y','/')"/>  <!--用户记账参数-->
               			<set name="PARAMS"         expr="usrPar"/>
            		</else>
            		<set name="netRecAmt"         expr="SUB(txAmt,txnComAmt)"/>   <!--净额-->  

            		<!--记账处理--> 
            		<set name="TXN_TYP"           value="1"/>                     <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->      
            		<quote name="accProcess"/>
            		<if condition="#RetCod!=0">
               			<set name="RspCod"    value="07005"/>
               			<set name="RspMsg"    value="系统扣款失败，请稍后重试！"/>
                		<do func="RollBackWork"/> 
              		    <return/>
            		</if>
            
            		<!--计算银行手续费-->
            		<set name="txnAmt_fee"     expr="txAmt"/>
            		<quote name="CalBnkFee"/>
                    
                    <set name="ORDSTATUS"      value="01"/>
            		<set name="TRANTYPE"       value="1"/>             <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
            		<set name="TRANWAY"        value="05"/>            <!--交易方式 01网银、02终端、03消费卡、04虚拟账户、05快捷支付--> 
            		<set name="TXCCY"          value="CNY"/>
            		<set name="payType"        expr="payType"/>
            		<set name="merNo"          expr="merNo"/>
            		<quote name="UpdReg"/>               <!--  更新充值订单  --> 
            		<quote name="UpdPay"/>               <!--  更新支付订单  --> 
            		<set name="merRemark"      value="账户充值"/> <!-- 商户信息 -->
         	    </elseif>
         		<else>
            		<set name="MsgTyp"    value="E"/>
            		<set name="RspCod"    value="09001"/>
            		<set name="RspMsg"    value="系统错误"/>
            		<return/>   
         		</else>
         		
         		 <!--通知风控系统登记订单信息-->
         		<set name="ServiceCode" value="680517"/>
         		<set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
         		<set name="TCODE"       expr="payOrdNo"/>           <!--平台流水号 支付订单号-->
         		<set name="CTYPE"       value="1"/>                 <!--客户类型-->
         		<set name="CLIENTCODE"  expr="CUST_ID"/>            <!--客户编号-->
         		<set name="CLIENTNAME"  expr="SESSIONS.USRNAME"/>
         		<set name="MOBILEPHONE" expr="SESSIONS.USRMP"/>
         		<set name="TAMT"        expr="txAmt"/>
         		<set name="TRANWAY"     value="05"/>
         		<set name="REGDTTIME"   expr="STRCAT(acDate,acTime)"/>
         		<set name="Time"        expr="acDate"/>
         		<quote name="noticRcs"/>
         
         		<set name="RspCod"         value="00000"/>
         		<set name="RspMsg"         value="支付成功"/>
              <!-- </elseif> -->

       </process>
   </transaction>

   <transaction code="sendSMSCode" desc="银联发送短信验证码">
       <sql name="qryUserInf">
           SELECT * FROM  STPBANKTB WHERE BAK_SEQ=#{no_agree}
       </sql>
       <sql name="qryCusInf">
         select * from stpcusinf where cust_id=#{userID}
       </sql>
       <process>
       <!-- 检测用户登录状态 此交易必须是登录状态完成-->
		    <set name="userID"          expr="SESSIONS.USRID"/>
		    <set name="cust_name"       expr="SESSIONS.USRNAME"/>
	        <if condition="ISNULL(userID)">
	            <set name="MsgTyp"        value="E"/>
	            <set name="RspCod"        value="02000"/>
	            <set name="RspMsg"        value="用户登录超时"/>
	            <return/>
	        </if>
           <set name="merId"     value="898310049004002"/>
           <set name="no_agree"  expr="no_agree"/>
           <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd" sql="qryUserInf"/>
            </do>
            <if condition="NOT(ISNULL(DES_DECRYPT(card_no)))"><!-- 卡加密转换 -->
              <set name="cardno"      expr="DES_DECRYPT(card_no)"/>
           </if>
           <set name="BIND_MOB"      expr="bank_res_phone"/>
           <set name="CUST_NAME_FMT" expr="cust_name"/>
           <set name="CUSTCREDNO"    expr="DES_DECRYPT(cust_cred_no)"/>
           
           <set name="certifTp"      value="01"/>
           <set name="certifId"      expr="CUSTCREDNO"/>
           <set name="customerNm"    expr="cust_name"/>
           <set name="phoneNo"       expr="BIND_MOB"/>
           
           <do func="ReadRecord" error="IGNORE">
               <para name="SqlCmd" sql="qryCusInf"/>
           </do>
           <do func="WuTZSendSmsCod">
               <para name="txnSubType"     value="02"/>
               <para name="channelType"    value="07"/>
               <para name="accType"        value="01"/>
               <para name="accNo"   	   expr="cardno"/>
               <para name="orderId" 	   expr="payordno"/>
               <para name="txnTime"        expr="GETDATETIME()"/>
               <para name="txnAmt"         expr="AMTPOWER(pay_amt,2)"/>
               <para name="encryptCertId"  value=""/>
           </do>
            <!-- 手机号-部分内容星号隐藏 -->
           <set name="First"             expr="SUBSTR(bind_mob,1,3)"/> 
           <set name="End"               expr="SUBSTR(bind_mob,8,SUB(STRLEN(bind_mob),7))"/>
           <set name="BIND_MOB_FMT"      expr="STRCAT(First,'****',End)"/>
       
           <!-- 卡号解密-部分内容星号隐藏 -->
           <set name="First"             expr="SUBSTR(cardno,1,3)"/> 
           <set name="End"               expr="SUBSTR(cardno,SUB(STRLEN(cardno),3),STRLEN(cardno))"/>
           <set name="CARDNO_FMT"        expr="STRCAT(First,'****',End)"/>
       </process>
   </transaction>
   
   <transaction code="NJReturnedBack" desc="退货订单结果处理-银行回调">
      <sql name="QryQRefInf"> <!--查询通知商城的URL 查询支付订单表-->
        SELECT refOrdNo,rfOrdTime,MerNo,oriPrdOrdNo,oriPayOrdNo,rfPayOrdNo,rfPayDate,txCcy,rfAmt,ACCAMT,MULAMT,fee,netRecAmt,rfSake,CUST_ID,
        bankCode,bankPayAcNo,bankPayUserNm,opkbnkNam,OrdStatus,rfReqDate,bankStlDate,bankJrnNo,BankError,NotifyUrl,oper_id ,Filed1 
         FROM StpRefInf
        WHERE RFPAYORDNO=#{ORDERID}
      </sql>
      <sql name="QryOldTyp"> <!--查询通知商城的URL 查询支付订单表-->
        SELECT a.PRDORDTYPE,b.PAYTYPE
         FROM stpprdinf a,STPPAYINF b
        WHERE a.PAYORDNO=b.PAYORDNO and a.PAYORDNO=#{PayOrdNo}
      </sql>
      <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
         SELECT CASH_AC_BAL,FROZ_BALANCE,TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'FM9999,999,999,990.00') AC_BAL FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNO}
      </sql>
      <sql name="SelCusAcc">
         SELECT pay_ac_no FROM arp_ac_cust_rel  WHERE CUST_ID=#{CUST_ID}
      </sql>
      <sql name="UpdRefPrd">
        UPDATE STPREFINF SET  NETRECAMT=#{NETRECAMT},ORDSTATUS=#{ORDSTATUS},FEE=#{FEE},
          ACCAMT=#{ACCAMT},MULAMT=#{MULAMT},rfReqDate=#{rfReqDate},BANKSTLDATE=#{BANKSTLDATE},BANKJRNNO=#{BANKJRNNO}
       WHERE refOrdNo=#{refOrdNo}
      </sql>
      <sql name="UpdPrdtotal">
         update stpprdinf set rfTotalAmt=(SELECT case when rfTotalAmt is null then 0+${rfAmt} else rfTotalAmt+${rfAmt} end rfTotalAmt FROM stpprdinf WHERE prdOrdNo=#{prdOrdNo} and MerNo=#{MerNo}) 
         where prdOrdNo=#{prdOrdNo} and MerNo=#{MerNo}
      </sql>
      <sql name="refStatus"><!--退款失败更新订单状态-->
        update STPREFINF set ordstatus=#{ordstatus} where refordno=#{REFORDNO}
      </sql>
      <sql name="SelFrzInf">
        select PAY_AC_NO,FROZ_AMT,BIZ_CODE,STATUS,FROZ_NO from ARP_AC_FORZZ_DETAILS where BIZ_CODE=#{CASORDNO} and STATUS='01'
      </sql>
      <sql name="UpdFrezInf"><!-- 更新冻结信息-->
         UPDATE ARP_AC_FORZZ_DETAILS SET STATUS='00',LST_UPT_DATE=#{LST_UPT_DATE},LST_UPT_TIME=#{LST_UPT_TIME} WHERE FROZ_NO=#{FROZ_NO}
      </sql>
      <process>
         <set name="ConfigName" value="NJPaymentInfo"/>
         <quote name="ReadXmlCfg"/>
         <set name="_REQUESTATTR.FORWARDURL"  expr="reqErrPage"/>    <!-- 请求错误页面 -->   

         <if condition="NOT(ISNULL(RESPCODE))">        <!-- 银联 -->
            <do func="WuTZRcvReturnResponse"     error="IGNORE" />
            <!--if condition="#RetCod!=0">
               <set name="RspCod"    value="09002"/>
               <set name="RspMsg"    value="银联返回验证失败"/>
               <return/>
            </if-->

            <set name="RFPAYORDNO"  expr="ORDERID" />
            <set name="BANKJRNNO"   expr="QUERYID" />
            <set name="ordAmt1"     expr="TXNAMT"/>   <!--银联返回订单金额-->
         </if>
         <set name="merRemark"     value="商物通"/>
         <set name="TraceTime"     expr="GETDATETIME()"/>  <!--支付成功时间-->
         <set name="RFREQDATE"     expr="TraceTime"/>  <!--支付成功时间-->
         <set name="BANKSTLDATE" expr="GETDATE()" />
         
         <!-- 用户等待最长时间(该时间必须控制在页面超时前) -->
         <set name="max"           value="8"/>
         <set name="i"             value="1"/>
         <!--对同一个订单号进行加锁-->
         <do func="Lock">
            <para name="RecKey"     expr="RFPAYORDNO" />
            <para name="AutoUnLock" value="yes" />
         </do>
         <if condition="#RetCod!=0">
            <while condition="INTCMP(i,2,max)">
                <do func="Lock">
                    <para name="RecKey"     expr="payOrdNo" />
                    <para name="AutoUnLock" value="yes" />
               </do>
               <if condition="#RetCod!=0">
                   <do func="Sleep">
                       <para name="SleepTime"     value="1" />
                   </do>
                   <set name="i"                  expr="ADD(i,1)"/>
               </if>
               <else>
                   <set name="i"                  value="0"/>
                   <return/>
               </else>
            </while>
         </if>
         <if condition="INTCMP(i,5,max)">
            <set name="RspCod"           value="08001"/>
            <set name="RspMsg"           value="系统交易加锁失败，请稍后重试！"/>
            <return/>
         </if>
         
         <!-- 查询员退货交易订单信息 -->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryQRefInf" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"           value="08001"/>
            <set name="RspMsg"           value="该支付订单信息不存在"/>
            <return/>
         </if>
         
         <set name="RCS_USER_CODE"       expr="CUST_ID"/>  <!--用户ID-->
         <set name="RCS_PAY_TYPE"        value="800019"/>  <!--本次交易码，订单支付-->
         <set name="RCS_PRD_NO"          expr="refOrdNo"/> <!--订单号，如果不涉及置空-->
         <set name="RFAMT"          expr="RFAMT"/>
         <set name="PrdOrdNo"       expr="oriPrdOrdNo"/>
         <set name="PayOrdNo"       expr="oriPayOrdNo"/>
         
         <if condition="IS_NOEQUAL_STRING(OrdStatus,'00')">
            <set name="PrdOrdType"               expr="PrdOrdType"/>
            <if condition="OR(IS_EQUAL_STRING(PrdOrdType,'1'),IS_EQUAL_STRING(PrdOrdType,'3'))">
              <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                <set name="sucDat"                   expr="FMTDATE(GETDATE(),0,4)"/> 
                <set name="SUCAMT"                   expr="AMTADDDOT(txAmt)"/>
                <set name="_REQUESTATTR.FORWARDURL"  expr="RegSucPage"/>
                <return/>
              </if>
              <else>
                <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
                   <set name="RspCod"    value="06001"/>
                   <set name="RspMsg"    value="该订单状态不能支付"/>
                   <return/>
                </if>
              </else>
            </if>
            <else>
              <if condition="IS_EQUAL_STRING(OrdStatus,'03')">
                <set name="_REQUESTATTR.FORWARDURL"  expr="STRCAT(payResult,'?payordno=',payOrdNo)"/>
                <return/>
              </if>
              <else>
                <if condition="IS_EQUAL_STRING(OrdStatus,'03')">
                   <set name="RspCod"    value="06001"/>
                   <set name="RspMsg"    value="该订单状态不能支付"/>
                   <return/>
                </if>
              </else>
            </else>
         </if>
         
         <!--判断金额是否与支付订单中的金额一致-->
         <if condition="IS_NOEQUAL_STRING(ordAmt1,RFAMT)"><!--订单金额加佣金-->
            <set name="MsgTyp"    value="E"/>
            <set name="RspCod"    value="08016"/>
            <set name="RspMsg"    value="订单金额与应支付金额不符"/>
            <return/>
         </if>

         <if condition="IS_EQUAL_STRING(BANKCODE,'01010200')"><!-- 银联 -->
            <if condition="IS_EQUAL_STRING(RESPCODE,'00')">
               <set name="PayRet"    value="00"/>
               <!--00:等待付款  01:付款成功  02:付款失败 03:退款申请 04:等待退款 05:退款成功
                   06:退款失败  07:同意撤销  08:拒绝撤销 09:撤销成功 10:撤销失败 12:预付款  
                   17:实付审核中18:实付审核通过 19:实付审核拒绝 99:超时-->
               <set name="OrdStatus" value="01"/>
            </if>
            <else>
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09022"/>
               <set name="RspMsg"    value="银联支付失败"/>
               <set name="OrdStatus" value="03"/>  
            </else> 
         </if>
         
         <!-- 查询原支付方式 -->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryOldTyp" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"           value="08001"/>
            <set name="RspMsg"           value="该支付订单信息不存在"/>
            <return/>
         </if>
         
         <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
            <if condition="IS_EQUAL_STRING(PrdOrdType,'0')">                   <!-- 原消费-直接支付  -->              
               <!--记账处理 start-->
               <set name="TXN_TYP"          value="7"/>                                <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账-->     
               <if condition="IS_EQUAL_STRING(payType,'01')">                          <!--网银支付-->
                  <set name="netRecAmt"     expr="ordAmt1"/>
                  <!--记账所需数据-->
                  <set name="ACC_TYP"        value="01"/>               <!--现金账户-->
                  <set name="MER_ACC_TYP"    value="02"/>               <!-- 商户结算账户 -->
                  <set name="DR_CR_FLAG"     value="+"/>                <!--账户余额增减标识 + 增加 - 减少-->
                  <set name="CCY"            value="CNY"/>              <!--货币类型-->   
                  <set name="IS_ACT"         value="Y"/>                <!--是否实时记账 Y 是 N 否-->
                  
                  <if condition="IS_EQUAL_STRING(flag,'1')">        <!--有手续费-->
                     <set name="merPar"     expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')"/>  <!--商户记账参数-->
                     <set name="feePar"     expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')"/>   <!--平台账户（手续费）记账参数-->
                     <set name="PARAMS"     expr="STRCAT(merPar,',',feePar)"/>
                  </if>
                  <else>                                            <!--无手续费-->
                     <set name="merPar"     expr="STRCAT(MERNO,'/','01','/','-','/','CNY','/',netRecAmt,'/','Y','/')"/>  <!--商户记账参数-->
                     <set name="PARAMS"     expr="merPar"/>
                  </else>
               </if>
            
               <!--记账处理-->
               <quote name="accProcess"/> 
               <if condition="#RetCod!=0">
                  <set name="ordstatus" value="03"/><!--退款失败更新订单状态-->
                  <do func="ExecSql" error="IGNORE">
                    <para name="SqlCmd" sql="refStatus"/>
                  </do>
                  <set name="RspCod"    value="07001"/>
                  <set name="RspMsg"    expr="STRCAT('交易失败！',RspMsg)"/>
                  <set name="DWZ_STATUS_CODE"     value="300"/>
                  <set name="DWZ_RSP_MSG"         expr="RspMsg"/> 
                  <set name="RspCod"    value="07001"/>
                  <set name="RspMsg"    value="交易失败，请联系客服！"/>
                  <do func="RollBackWork"/>    <!--回滚提交数据-->
                  <return/>
               </if>
               
               <set name="OrdStatus"     value="02"/>              <!-- 退款订单-退款成功-->
               <set name="rfReqDate"     expr="GETDATETIME()"/>    <!--退款成功时间-->
               
               <quote name="SelFrzInf"/>
               <!--将扣除的提现金额解冻 并从账户里扣除-->
               <set name="RCS_PRD_NO"    expr="refOrdNo"/><!--订单号，如果不涉及置空-->
               <set name="PAY_AC_NO"     expr="PAY_AC_NO"/>
               <set name="txAmt"         expr="STRCAT('-',FROZ_AMT)"/>
               <quote name="frezzAmt"/>
               <set name="txAmt"         expr="FROZ_AMT"/>
               <!--更新冻结状态-->
               <quote name="UpdFrezz"/>
               <!--记账处理 end-->
            </if>
            <else>
               <set name="MsgTyp"    value="E"/>
               <set name="RspCod"    value="09001"/>
               <set name="RspMsg"    value="系统错误"/>
               <return/>
            </else>
         </if>
         <else>
            <quote name="SelFrzInf"/>
            <!--将扣除的提现金额解冻 并从账户里扣除-->
            <set name="RCS_PRD_NO"    expr="refOrdNo"/><!--订单号，如果不涉及置空-->
            <set name="PAY_AC_NO"     expr="PAY_AC_NO"/>
            <set name="txAmt"         expr="STRCAT('-',FROZ_AMT)"/>
            <quote name="frezzAmt"/>
            <set name="txAmt"         expr="FROZ_AMT"/>
            <!--更新冻结状态-->
            <quote name="UpdFrezz"/>
         </else>
         
         <!--更新退款订单-->
         <do func="ExecSql" error="IGNORE">  
             <para name="SqlCmd" sql="UpdRefPrd"/>
         </do>
         <if condition="#RetCod==2">
            <set name="RspCod"    value="01003"/>
            <set name="RspMsg"    value="无符合条件记录"/>
            <return/>
         </if>
         <elseif condition="#RetCod!=0">
            <set name="RspCod"    value="06003"/>
            <set name="RspMsg"    value="更新订单信息错误"/>
            <return/>
         </elseif>

         <!--更新商品订单-->
         <if condition="IS_EQUAL_STRING(OrdStatus,'02')">
            <!--虚拟账号的退款，直接累计退款-->
            <do func="ExecSql" error="IGNORE">  
               <para name="SqlCmd" sql="UpdPrdtotal"/>
            </do>
            <if condition="#RetCod==2">
               <set name="RspCod"    value="01003"/>
               <set name="RspMsg"    value="无符合条件记录"/>
               <return/>
            </if>
            <elseif condition="#RetCod!=0">
               <set name="RspCod"    value="06003"/>
               <set name="RspMsg"    value="更新订单信息错误"/>
               <return/>
            </elseif>
         </if>
           
         <!--通知风控系统登记订单信息-->
         <set name="ServiceCode" value="680517"/>
         <set name="DTYPE"       value="1"/>                 <!--操作类型 1新增 2 修改-->
         <set name="TCODE"       expr="RFPAYORDNO"/>           <!--平台流水号-->
         <set name="CTYPE"       value="1"/>                 <!--客户类型-->
         <set name="CLIENTCODE"  expr="ruserid"/>            <!--客户编号-->
         <set name="CCODE"       expr="merNo"/>              <!--商户编号-->
         <set name="CNAME"       expr="MERREMARK"/>
         <set name="TRANTYPE"    value="8"/>                 <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款-->
         <set name="Tran_type"   value="4"/>                 <!--交易方式 1网银、2终端、3消费卡、4虚拟积分等-->
         <set name="TAMT"        expr="Amt"/>
         <set name="REGDTTIME"   expr="STRCAT(acDate,acTime)"/>
         <set name="Time"        expr="acDate"/>
         <quote name="noticRcs"/>
         
         <set name="MsgTyp"    value="N"/>
         <set name="RspCod"    value="00000" />
         <set name="RspMsg"    value="交易成功!" />
        
      </process>
   </transaction>
      
   <transaction code="daishouRechargePay" desc="银联代收充值支付">
      <sql name="UpdPay"> <!-- 更新支付订单表 -->
         payOrdNo=#{payOrdNo}
      </sql>
      <sql name="UpdPrd"> <!-- 更新商品订单表 -->
         prdOrdNo=#{prdOrdNo} and merNo=#{merno} 
      </sql> 
      <sql name="QryPrdInf"> <!-- 查询商品订单 -->
         SELECT bizType FROM StpPrdInf WHERE prdordno=#{prdordno} and merno=#{merno}
      </sql>
      <sql name="UpdReg"> <!-- 更新充值订单表 -->
         prdordno=#{PrdOrdNo} and prdOrdType='1'
      </sql>  
      <sql name="SelAccBal"><!-- 查询客户账户余额信息-->
         SELECT CASH_AC_BAL,FROZ_BALANCE FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNO}
      </sql>
      <sql name="SelBnkFee"><!-- 查询银行费率信息-->
         SELECT FEE_CODE FROM CoopBank WHERE BANK_CODE=#{bnkCod}
      </sql> 
      <sql name="SelBnkMerFee"><!-- 查询银行商户费率信息-->
         SELECT FEE_CODE FROM COOPBANK_FEE WHERE BANK_CODE=#{bnkCod} and BANK_MERNO=#{BnkMerNo}
      </sql>
      <sql name="SelMerFee">
         SELECT fee_code 
           FROM ARP_CUST_FEE 
          WHERE pay_ac_no in (select pay_ac_no from arp_ac_cust_rel where CUST_ID=#{merNo}) and biz_type=#{bizType} and pay_type=#{payType}
      </sql>
      <sql name="SelCusAcc">
         SELECT pay_ac_no FROM arp_ac_cust_rel  WHERE CUST_ID=#{CUST_ID}
      </sql>
      <sql name="QrySendInf1">
         SELECT merNo,prdordno,txamt as ordamt,OrdStatus,ActDat as paytime,'M' as signType FROM stppayinf WHERE payordno=#{orderNo}
      </sql>
      <sql name="QrySendInf2">
         SELECT filed4 as Orddate,FILED5 as  respMode,retUrl as ReturnUrl,notifyUrl as notifyUrl FROM stpprdinf WHERE payordno=#{orderNo}
      </sql>  
      <sql name="QryMerMD5">
         SELECT a.MD5_SECRET_CODE_ID as MD5Key FROM StpMerInf a,StpCusInf b WHERE a.CUST_ID = b.CUST_ID AND a.CUST_ID=#{merNo}
      </sql>  
      <sql name="QryStpBankInf"> <!--  查询用户绑定的银行卡(借记卡、信用卡)  --> 
        SELECT (case when CARD_TYPE='00' then '1' when CARD_TYPE='01' then '2'   else '-1' end) as type_card,CARD_NO as cardno,CARD_NAME as cust_name,CARD_BANK_THREE as cvv2,VALIDITY_M as month,VALIDITY_Y as year,BANK_RES_PHONE as bind_mob,BANK_CONF,AUTH_CODE as bindId from STPBANKTB where BAK_SEQ=#{no_agree}
      </sql>
      <sql name="QryUsrIdverifycode"> <!-- 查询用户注册验证码信息  -->
          SELECT ROUND(TO_NUMBER(sysdate - InsTim) * 24 * 60) timdif,timeout,InsTim,Random 
          FROM STPVERIFY 
          WHERE VER_ID=#{UsrMp} AND VER_TYPE=#{VER_TYPE} and SERVICE_TYPE=#{SERVICE_TYPE} ORDER BY InsTim DESC
      </sql>
      <sql name="QryUserBank"><!--  检测用户是否绑定了该卡  -->
          SELECT CUST_ID as BIND_CUST_ID,BAK_SEQ FROM STPBANKTB WHERE CARD_TYPE=#{CardType} AND CARD_NO=#{BnkAcNo} 
      </sql>
      <sql name="InsUserBankInf"><!--  绑定银行卡  -->
          INSERT INTO STPBANKTB (BAK_SEQ,CUST_ID,CARD_BANK,CARD_NO,CARD_TYPE,CARD_NAME,BANK_NAM,CARD_BANK_THREE,VALIDITY_M,VALIDITY_Y,BANK_CONF,BANK_RES_PHONE)  
          VALUES(#{BAK_SEQ},#{userID},#{bank_code},#{BNKACNO},#{CardType},#{CARD_NAME},#{BANK_NAME},#{cvv2},#{month},#{year},'1',#{bind_mob})
      </sql>
      <sql name="UpdBankInf"><!-- 更新卡信息 -->
          UPDATE STPBANKTB SET BANK_CONF=#{BANK_CONF},BANK_RES_PHONE=#{bind_mob}  WHERE BAK_SEQ=#{no_agree}
      </sql>
      <sql name="QryURL"> <!--查询订单基本信息-->
        SELECT b.NotifyUrl,a.PrdOrdNo,a.OrdStatus,b.PRDNAME,a.PrdOrdType,
               a.payType,a.MulType,a.txamt,NVL(a.fee,'0') txnComAmt,a.accAmt,a.mulAmt,a.merno,a.CUST_ID,a.ActDat,nvl(a.BnkMerNo,' ') BnkMerNo
          FROM StpPayInf a,StpPrdInf b 
         WHERE a.payOrdNo=#{payOrdNo} and a.payOrdNo=b.payOrdNo
      </sql>
      <!--查询身份证号  -->
      <sql name="QryCertificate">
     	  select CUST_CRED_NO as CERTIFID from stpcusinf where CUST_ID=#{USERID}
      </sql>
      <sql name="QryUserLogFail"><!-- 查询用户登录表，查询用户登录失败次数和第一次登录失败时间，以及用户上次登录失败之当前的时间，小时为单位 -->
          SELECT 
          EXTRACT(DAY FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*24*60 + EXTRACT(HOUR FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND) )*60 +  EXTRACT(MINUTE FROM ((sysdate-CURRENT_LOGIN_TIME) DAY TO SECOND )) as timeDifference,
          CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT 
          FROM STPLOGTMP   WHERE   LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} and PWD_TYPE=#{PWDTYPE}
      </sql>
      <sql name="InsUsrLogInfo"> <!-- 添加用户登录失败信息记录 -->
          INSERT INTO STPLOGTMP 
          (LOGIN_NAME,LAST_LOGIN_TIME,CURRENT_LOGIN_TIME,LOGIN_FAIL_COUNT,CUST_TYPE,PWD_TYPE) 
          VALUES (#{USER_ID},sysdate,sysdate,'0',#{CUSTTYPE},#{PWDTYPE})
      </sql>
      <sql name="UptUsrLogFailInfo"><!-- 更新用户登录失败信息记录 -->
          UPDATE STPLOGTMP SET LAST_LOGIN_TIME=SYSDATE ,
          LOGIN_FAIL_COUNT=#{FailFlag} WHERE LOGIN_NAME=#{USER_ID} AND CUST_TYPE=#{CUSTTYPE} AND PWD_TYPE=#{PWDTYPE}
      </sql>
      <sql name="QryPassInf"><!-- 查询客户支付密码信息-->
          SELECT PASSWORD FROM ARP_AC_CUST_REL WHERE PAY_AC_NO=#{PAYACNO}
      </sql>
      <sql name="bindAgain">
      	    update stpbanktb set BANK_RES_PHONE=#{PHONENO},AUTH_CODE=#{bindId} where bak_seq=#{BAK_SEQ}
      </sql>
      <process>
        <!-- 检测用户登录状态 此交易必须是登录状态完成-->
        <set name="userID"          expr="SESSIONS.USRID"/>
        <if condition="ISNULL(userID)">
            <set name="MsgTyp"        value="E"/>
            <set name="RspCod"        value="02000"/>
            <set name="RspMsg"        value="用户登录超时"/>
            <return/>
        </if>
        
        <!-- 订单信息 -->
        <set name="orderNo"       expr="payordno"/>    <!-- 支付订单编号 -->
        <set name="txnAmt"        expr="pay_amt"/>     <!-- 付款金额 单位：元 -->
        <set name="ordAmt1"       expr="AMTPOWER(txnAmt,2)"/>  <!--付款金额：分  -->
        <set name="txnDat"        expr="TACCDT"/>      <!-- 付款日期  YYYYMMDD -->
          
        <set name="no_agree"      expr="no_agree"/>    <!-- 协议编号 -->
        
        <set name="paypwd"      expr="PASSWORD"/>
        <set name="payAcNo"     expr="SESSIONS.PAYACNO"/>  
        <set name="userID"      expr="SESSIONS.USRID"/>
        
         <!--验签 start-->
        <quote name="chkSign"/>
         <!--验签 end-->
        
        <!-- 用户支付密码锁定次数判断 -->
         <set name="USER_ID"   expr="userID" />
         <set name="CUSTTYPE"  value="0"/><!--0用户 1 商户 2企业-->
         <set name="PWDTYPE"   value="1"/><!--0:登录密码 1:支付密码-->
         <set name="FailFlag"  value="0"/>
         <quote name="usrpwdlock"/>
         <!-- 用户支付密码锁定次数判断 -->
         
         <!--校验支付密码 以及转加密-->
         <quote name="chkUsrPayPwd"/>

          <set name="payordno"       expr="payordno"/>
          <!--对同一个订单号进行加锁-->

          <do func="Lock">
             <para name="RecKey"     expr="payordno" />
             <para name="AutoUnLock" value="yes" />
          </do>
          <if condition="#RetCod!=0">
             <set name="RspCod"      value="08001"/>
             <set name="RspMsg"      value="正在处理中,请勿重复请求!"/><!-- 加锁失败的原因：请求频率过高 -->
             <return/>
          </if>
          
         <!--查询订单信息-->
         <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryURL" />
         </do>
         <if condition="#RetCod!=0">
            <set name="RspCod"           value="08001"/>
            <set name="RspMsg"           value="系统繁忙，付款失败。请稍后重试！"/>
            <return/>
         </if>
         
         <!-- 判断订单是否已经付款成功 -->
         <if condition="IS_NOEQUAL_STRING(OrdStatus,'00')">
            <if condition="IS_EQUAL_STRING(OrdStatus,'01')">
             <set name="RspCod"    value="00000"/>
             <set name="RspMsg"    value="已付款成功"/>
             <return/>
            </if>
            <else>
             <set name="RspCod"    value="06001"/>
             <set name="RspMsg"    value="该订单状态不能支付"/>
             <return/>
            </else>
         </if>

         <if condition="IS_NOEQUAL_STRING(txamt,ordAmt1)"><!-- 订单金额 -->
             <set name="MsgTyp"    value="E"/>
             <set name="RspCod"    value="08016"/>
             <set name="RspMsg"    value="支付金额与订单金额不符，请检查订单！"/>
             <return/>
         </if>
            
        <if condition="AND(NOT(ISNULL(no_agree)),IS_NOEQUAL_STRING(no_agree,''))">
           <!-- 查询绑定卡信息 -->
           <do func="ReadRecord"     error="IGNORE">
              <para name="SqlCmd" sql="QryStpBankInf"/>
           </do>
           <if condition="#RetCod==2">
              <set name="MsgTyp"        value="E"/>
              <set name="RspCod"        value="09999"/>
              <set name="RspMsg"        value="银行卡尚未绑定"/>
              <return/>  
           </if>
           <elseif condition="#RetCod!=0">
              <set name="MsgTyp"        value="E"/>
              <set name="RspCod"        value="02003"/>
              <set name="RspMsg"        value="获取卡信息失败，请重新选择！"/>
              <return/>  
           </elseif>
           <set name="BANK_CONF"       expr="BANK_CONF"/><!-- 开通无跳转支付状态 -->
           <set name="sDeData"         expr="cardno"   /><!-- 卡号 -->
           <if condition="NOT(ISNULL(DES_DECRYPT(sDeData)))"><!-- 卡加密转换 -->
              <set name="cardno"      expr="DES_DECRYPT(sDeData)"/>
           </if>
        </if>
        <else>
            <set name="MsgTyp"        value="E"/>
            <set name="RspCod"        value="09999"/>
            <set name="RspMsg"        value="系统出错"/>
            <return/>  
        </else>
       
        <do func="ReadRecord" error="IGNORE">
            <para name="SqlCmd" sql="QryCertificate"/>
        </do>
        <if condition="#RetCod!=0">
            <set name="MsgTyp"        value="E"/>
            <set name="RspCod"        value="02003"/>
            <set name="RspMsg"        value="没有进行实名认证"/>
            <return/>  
         </if>
         <if condition="NOT(ISNULL(DES_DECRYPT(CERTIFID)))"><!-- 身份证转换 -->
              <set name="certifid"      expr="DES_DECRYPT(CERTIFID)"/>
         </if>
        

        
        <set name="cardno"        expr="cardno"/>      <!-- 卡号 -->
        <set name="bind_mob"      expr="bind_mob"/>    <!-- 预留银行绑定手机号 -->
        <set name="type_card"     expr="type_card"/>   <!-- 卡类型 1：借记卡 2：信用卡 -->
        <set name="bank_code"     expr="bank_code"/>   <!-- 银行编码  -->
        <set name="bank_name"     expr="bank_name"/>   <!-- 银行名称  -->
        <set name="CARD_NAME"     expr="SESSIONS.USRNAME"/>
        <!-- 检测基本卡信息 -->
        <if condition="OR(ISNULL(cardno),ISNULL(bind_mob),ISNULL(type_card),ISNULL(bank_code))">
           <set name="MsgTyp"        value="E"/>
           <set name="RspCod"        value="02003"/>
           <set name="RspMsg"        value="卡信息不完整，请重填后再提交付款！"/>
           <return/> 
        </if>
        <if condition="IS_NOEQUAL_STRING(BANK_CONF,'1')">
            <set name="MsgTyp"        value="E"/>
            <set name="RspCod"        value="02003"/>
            <set name="RspMsg"        value="未开通快捷支付，请开通..."/>
            <return/>
        </if>
        <!-- 卡类型转换 -->
        <if condition="IS_EQUAL_STRING(type_card,'1')">
           <set name="CardType"       value="01"/>  <!-- 借记卡 -->
        </if>
        <else>
            <set name="MsgTyp"        value="E"/>
            <set name="RspCod"        value="02007"/>
            <set name="RspMsg"        value="不支持该卡种的消费，请选择其他卡付款！"/><!-- 充值只适用于借记卡 -->
            <return/>
        </else>

        <!--参数配置-->
        <set name="ConfigName"       value="DaiShouBaseInf"/>
        <quote name="ReadXmlCfg"/>
          
        <do func="DaiShou_Pay_BindId"    error="IGNORE">
           <para name="merId"    expr="DaiShouMerId"/>                     <!-- 商户号 -->
           <para name="orderId"   expr="payOrdNo"/>                    <!-- 商户订单号 -->
           <para name="txnTime"    	  expr="ActDat"/>            <!-- 交易时间 yyyyMMddHHmmss -->
           <para name="txnAmt"       expr="ordAmt1"/>       <!-- 交易金额 单位：分 -->
           <para name="bindId"       expr="bindId"/>                <!-- 绑定标识号 -->
           <para name="backUrl"         expr="DaiShouBackUrl"/>          <!-- 后台通知地址 -->
        </do>
       <if condition="#RetCod!=0">
           <set name="MsgTyp"      value="E"/>
           <set name="RspCod"      value="00001"/>
           <set name="RspMsg"      value="respMsg"/>
       </if>
       <else>
       		<set name="MsgTyp"      value="N"/>
       		<set name="RspCod"      value="00000"/>
       		<set name="RspMsg"      value="交易成功"/>
       </else>
       
      </process>
   </transaction>
     
     <transaction code="daishouBackRcvResp" desc="银联代收订单结果处理-银行回调">
     	<sql name="QryURL"> <!--查询通知商城的URL 查询支付订单表 -->
     		SELECT
     		b.NotifyUrl,b.retUrl,b.PRDNAME,a.PrdOrdNo,a.OrdStatus,a.PrdOrdType,a.payType,a.MulType,a.txamt,a.fee
     		txnComAmt,
     		a.accAmt,a.mulAmt,a.merno,a.bankCod bnkCod,a.CUST_ID,a.ActDat,b.bizType,a.BnkMerNo
     		FROM StpPayInf a,StpPrdInf b
     		WHERE a.payOrdNo=#{payOrdNo} and a.prdordno=b.prdordno
     	</sql>
     	<sql name="UpdPay"> <!-- 更新支付订单表 -->
     		payOrdNo=#{payOrdNo}
     	</sql>
     	<sql name="UpdPrd"> <!-- 更新商品订单表 -->
     		prdOrdNo=#{prdOrdNo} and merNo=#{merno}
     	</sql>
     	<sql name="UpdReg"> <!-- 更新充值订单表 -->
     		prdordno=#{PrdOrdNo} and prdOrdType='1'
     	</sql>
     	<sql name="SelAccBal"><!-- 查询客户账户余额信息 -->
     		SELECT
     		CASH_AC_BAL,FROZ_BALANCE,TO_CHAR(to_number(CASH_AC_BAL-FROZ_BALANCE)/100,'FM9999,999,999,990.00')
     		AC_BAL FROM ARP_AC_PROFILE WHERE PAY_AC_NO=#{PAYACNO}
     	</sql>
     	<sql name="SelBnkFee"><!-- 查询银行费率信息 -->
     		SELECT FEE_CODE FROM CoopBank WHERE BANK_CODE=#{bnkCod}
     	</sql>
     	<sql name="SelBnkMerFee"><!-- 查询银行商户费率信息 -->
     		SELECT FEE_CODE FROM COOPBANK_FEE WHERE BANK_CODE=#{bnkCod} and
     		BANK_MERNO=#{BnkMerNo}
     	</sql>
     	<sql name="SelMerFee">
     		SELECT fee_code
     		FROM ARP_CUST_FEE
     		WHERE pay_ac_no in (select pay_ac_no from arp_ac_cust_rel where
     		CUST_ID=#{merNo}) and biz_type=#{bizType} and pay_type=#{payType}
     	</sql>
     	<sql name="SelCusAcc">
     		SELECT pay_ac_no FROM arp_ac_cust_rel WHERE CUST_ID=#{CUST_ID}
     	</sql>
     	<sql name="QrySendInf1">
     		SELECT merNo,prdordno,txamt as ordamt,OrdStatus,ActDat as paytime,'M' as
     		signType FROM stppayinf WHERE payordno=#{orderNo}
     	</sql>
     	<sql name="QryMerMD5">
     		SELECT a.MD5_SECRET_CODE_ID as MD5Key FROM StpMerInf a,StpCusInf b WHERE
     		a.CUST_ID = b.CUST_ID AND a.CUST_ID=#{merNo}
     	</sql>
     
     	<!-- 物业缴费相关表 -->
     	<sql name="QryUtilityBillPayInf"><!-- 查询账单支付信息表 -->
     		select * from UtilityBillPayInf where
     		BillPay_PrdOrdNo=#{Bill_PrdOrdNo}
     	</sql>
     
     	<sql name="updateUtilityBillInf"><!-- 更新客户物业缴费账单信息记录表 -->
     		UPDATE UtilityBillInf SET Bill_Status = #{Status} WHERE
     		Bill_PrdOrdNo=#{Bill_PrdOrdNo}
     	</sql>
     
     	<sql name="updateUtilityBillPayInf"><!-- 更新客户物业缴费缴费信息表 -->
     		UPDATE UtilityBillPayInf SET BillPay_Status = #{Status} WHERE
     		BillPay_PrdOrdNo=#{Bill_PrdOrdNo}
     	</sql>
     
     	<process>
     		<set name="ConfigName" value="SecCfg" />
     		<quote name="ReadXmlCfg" />
     		<set name="_REQUESTATTR.FORWARDURL" expr="reqErrPage" />    <!-- 请求错误页面 -->
     
     		<!-- 银联报文验签 -->
     		<if condition="NOT(ISNULL(RESPCODE))">        <!-- 银联 -->
     			<!--打印ETF树 -->
     			<do func="DumpEtf" />
     			<do func="DaiShou_BackRcvResponse" error="IGNORE" />
     			<if condition="#RetCod!=0">
     				<set name="RspCod" value="09002" />
     				<set name="RspMsg" value="银联返回验证失败" />
     				<return />
     			</if>
     			<set name="payOrdNo" expr="ORDERID" />
     			<set name="orderNo" expr="ORDERID" />
     			<set name="bankJrnNo" expr="queryId" />
     			<set name="bankStlDate" expr="settleDate" />
     			<set name="BnkMerNo" expr="merId" />
     			<set name="ordAmt1" expr="TXNAMT" />   <!--银联返回订单金额 -->
     			<set name="ORDERDATE" expr="SUBSTR(TXNTIME,1,8)" />
     			<set name="bankCode" value="01010200" />
     		</if>
     
     
     		<set name="TraceTime" expr="GETDATETIME()" />  <!--支付成功时间 -->
     		<set name="merRemark" value="商物通" />
     
     		<!-- 用户等待最长时间(该时间必须控制在页面超时前) -->
     		<set name="max" value="8" />
     		<set name="i" value="1" />
     		<!--对同一个订单号进行加锁 -->
     		<do func="Lock">
     			<para name="RecKey" expr="payOrdNo" />
     			<para name="AutoUnLock" value="yes" />
     		</do>
     		<if condition="#RetCod!=0">
     			<while condition="INTCMP(i,2,max)">
     				<do func="Lock">
     					<para name="RecKey" expr="payOrdNo" />
     					<para name="AutoUnLock" value="yes" />
     				</do>
     				<if condition="#RetCod!=0">
     					<do func="Sleep">
     						<para name="SleepTime" value="1" />
     					</do>
     					<set name="i" expr="ADD(i,1)" />
     				</if>
     				<else>
     					<set name="i" value="0" />
     					<return />
     				</else>
     			</while>
     		</if>
     
     		<if condition="INTCMP(i,5,max)">
     			<set name="RspCod" value="08001" />
     			<set name="RspMsg" value="系统交易加锁失败，请稍后重试！" />
     			<return />
     		</if>
     
     		<!--查询URL -->
     		<do func="ReadRecord" error="IGNORE">
     			<para name="SqlCmd" sql="QryURL" />
     		</do>
     		<set name="RCS_USER_CODE" expr="CUST_ID" />  <!--用户ID -->
     		<set name="RCS_PAY_TYPE" value="800019" />  <!--本次交易码，订单支付 -->
     		<set name="RCS_PRD_NO" expr="prdOrdNo" /> <!--订单号，如果不涉及置空 -->
     		<if condition="#RetCod!=0">
     			<set name="RspCod" value="08001" />
     			<set name="RspMsg" value="该支付订单信息不存在" />
     			<return />
     		</if>
     		<!-- 校验用户和账户余额查询 逻辑处理提前 -->
     		<set name="payacno" expr="SESSIONS.PAYACNO" />
     		<if condition="ISNULL(payacno)">
     			<!--查询客户账户 -->
     			<do func="ReadRecord" error="IGNORE">
     				<para name="SqlCmd" sql="SelCusAcc" />
     			</do>
     			<if condition="#RetCod==2">
     				<set name="MsgTyp" value="E" />
     				<set name="RspCod" value="07016" />
     				<set name="RspMsg" value="该用户账户信息不存在" />
     				<return />
     			</if>
     			<elseif condition="#RetCod!=0">
     				<set name="MsgTyp" value="E" />
     				<set name="RspCod" value="09999" />
     				<set name="RspMsg" value="系统错误" />
     				<return />
     			</elseif>
     			<set name="payacno" expr="pay_ac_no" />
     		</if>
     
     		<!--查询账户余额 -->
     		<quote name="selAccBal" />
     		<set name="AC_BAL" expr="AC_BAL" />
     
     
     		<if condition="IS_EQUAL_STRING(PrdOrdType,'1')">
     			<set name="_REQUESTATTR.FORWARDURL" expr="PayErrPage" />
     		</if>
     		<else>
     			<set name="_REQUESTATTR.FORWARDURL" expr="RegErrPage" />
     		</else>
     		<if condition="IS_NOEQUAL_STRING(OrdStatus,'00')">
     			<set name="PrdOrdType" expr="PrdOrdType" />
     			<if condition="IS_EQUAL_STRING(PrdOrdType,'1')">
     				<if condition="IS_EQUAL_STRING(OrdStatus,'01')">
     					<set name="sucDat" expr="FMTDATE(GETDATE(),0,4)" />
     					<set name="SUCAMT" expr="AMTADDDOT(txAmt)" />
     					<set name="_REQUESTATTR.FORWARDURL" expr="RegSucPage" />
     					<return />
     				</if>
     				<else>
     					<if condition="IS_EQUAL_STRING(OrdStatus,'01')">
     						<set name="RspCod" value="06001" />
     						<set name="RspMsg" value="该订单状态不能支付" />
     						<return />
     					</if>
     				</else>
     			</if>
     			<else>
     				<if condition="IS_EQUAL_STRING(OrdStatus,'01')">
     					<set name="sucDat" expr="FMTDATE(GETDATE(),0,4)" />
     					<set name="SUCAMT" expr="AMTADDDOT(txAmt)" />
     					<set name="_REQUESTATTR.FORWARDURL" expr="STRCAT(payResult,'?payordno=',payOrdNo)" />
     					<return />
     				</if>
     				<else>
     					<if condition="IS_EQUAL_STRING(OrdStatus,'01')">
     						<set name="RspCod" value="06001" />
     						<set name="RspMsg" value="该订单状态不能支付" />
     						<return />
     					</if>
     				</else>
     			</else>
     		</if>
     
     		<set name="BANKCODE" expr="bnkCod" />
     
     		<!--判断金额是否与支付订单中的金额一致 -->
     		<if condition="IS_EQUAL_STRING(payType,'04')">
     			<if condition="IS_NOEQUAL_STRING(mulAmt,ordAmt1)">
     				<set name="MsgTyp" value="E" />
     				<set name="RspCod" value="08016" />
     				<set name="RspMsg" value="订单金额与应支付金额不符" />
     				<return />
     			</if>
     		</if>
     		<else>
     			<if condition="ISNULL(txnComAmt)">
     				<set name="txnComAmt" value="0" />
     			</if>
     			<if condition="IS_NOEQUAL_STRING(txamt,ordAmt1)"><!--订单金额加佣金 -->
     				<set name="MsgTyp" value="E" />
     				<set name="RspCod" value="08016" />
     				<set name="RspMsg" value="订单金额与应支付金额不符" />
     				<return />
     			</if>
     		</else>
     
     		<set name="sucDat" expr="FMTDATE(SUBSTR(actdat,1,8),0,4)" />
     		<if condition="IS_EQUAL_STRING(BANKCODE,'01040000')">
     			<quote name="BOCreturn" />      <!-- 中行返回结果 -->
     		</if>
     		<elseif condition="IS_EQUAL_STRING(BANKCODE,'CCB')">
     			<if condition="IS_EQUAL_STRING(SUCCESS,'Y')">
     				<set name="PayRet" value="00" />
     				<set name="OrdStatus" value="01" />
     				<set name="BnkDat" expr="ACCDATE" />
     				<set name="bankStlDate" expr="ACCDATE" />
     			</if>
     		</elseif>
     		<elseif condition="IS_EQUAL_STRING(BANKCODE,'03010000')">
     			<set name="PayRet" value="00" />
     			<set name="OrdStatus" value="01" />
     			<set name="BnkDat" expr="ACCDATE" />
     			<set name="bankStlDate" expr="ACCDATE" />
     		</elseif>
     		<elseif condition="IS_EQUAL_STRING(BANKCODE,'03080000')">
     			<if condition="IS_EQUAL_STRING(SUCCEED,'Y')">
     				<set name="PayRet" value="00" />
     				<set name="OrdStatus" value="01" />
     				<set name="BnkDat" expr="SUBSTR(DATE,1,8)" />
     				<set name="bankStlDate" expr="SUBSTR(DATE,1,8)" />
     			</if>
     		</elseif>
     		<elseif condition="IS_EQUAL_STRING(BANKCODE,'01020000')">
     			<if condition="OR(IS_EQUAL_STRING(TRANSTAT,'1'),IS_EQUAL_STRING(TRANSTAT,'0'))">
     				<set name="PayRet" value="00" />
     				<set name="OrdStatus" value="01" />
     				<set name="BnkDat" expr="SUBSTR(ORDERDATE,1,8)" />
     				<set name="bankStlDate" expr="SUBSTR(ORDERDATE,1,8)" />
     				<set name="ReIcbcUrl" expr="icbcret" />
     			</if>
     		</elseif>
     		<elseif condition="IS_EQUAL_STRING(BANKCODE,'01010000')"><!-- 银联 -->
     			<if condition="IS_EQUAL_STRING(RESPCODE,'00')">
     				<set name="PayRet" value="00" />
     				<!--00:等待付款 01:付款成功 02:付款失败 03:退款申请 04:等待退款 05:退款成功 06:退款失败 07:同意撤销 08:拒绝撤销 
     					09:撤销成功 10:撤销失败 12:预付款 17:实付审核中18:实付审核通过 19:实付审核拒绝 99:超时 -->
     				<set name="OrdStatus" value="01" />
     				<set name="BnkDat" expr="SUBSTR(DATE,1,8)" />
     				<set name="bankStlDate" expr="SUBSTR(DATE,1,8)" />
     			</if>
     			<else>
     				<set name="MsgTyp" value="E" />
     				<set name="RspCod" value="09022" />
     				<set name="RspMsg" value="银联支付失败" />
     				<set name="OrdStatus" value="02" />
     			</else>
     		</elseif>
     		<elseif condition="IS_EQUAL_STRING(BANKCODE,'01010100')"><!-- 银联B2B -->
     			<if condition="IS_EQUAL_STRING(RESPCODE,'00')">
     				<set name="PayRet" value="00" />
     				<!--00:等待付款 01:付款成功 02:付款失败 03:退款申请 04:等待退款 05:退款成功 06:退款失败 07:同意撤销 08:拒绝撤销 
     					09:撤销成功 10:撤销失败 12:预付款 17:实付审核中18:实付审核通过 19:实付审核拒绝 99:超时 -->
     				<set name="OrdStatus" value="01" />
     				<set name="BnkDat" expr="SUBSTR(DATE,1,8)" />
     				<set name="bankStlDate" expr="SUBSTR(DATE,1,8)" />
     			</if>
     			<else>
     				<set name="MsgTyp" value="E" />
     				<set name="RspCod" value="09022" />
     				<set name="RspMsg" value="银联B2B支付失败" />
     				<set name="OrdStatus" value="02" />
     			</else>
     		</elseif>
     		<elseif condition="IS_EQUAL_STRING(BANKCODE,'01010200')"><!-- 银联代收 -->
     			<if condition="IS_EQUAL_STRING(RESPCODE,'00')">
     				<set name="PayRet" value="00" />
     				<!--00:等待付款 01:付款成功 02:付款失败 03:退款申请 04:等待退款 05:退款成功 06:退款失败 07:同意撤销 08:拒绝撤销 
     					09:撤销成功 10:撤销失败 12:预付款 17:实付审核中18:实付审核通过 19:实付审核拒绝 99:超时 -->
     				<set name="OrdStatus" value="01" />
     				<set name="BnkDat" expr="SUBSTR(DATE,1,8)" />
     				<set name="bankStlDate" expr="SUBSTR(DATE,1,8)" />
     			</if>
     			<else>
     				<set name="MsgTyp" value="E" />
     				<set name="RspCod" value="09022" />
     				<set name="RspMsg" value="银联代收支付失败" />
     				<set name="OrdStatus" value="02" />
     			</else>
     		</elseif>
     		<if condition="IS_EQUAL_STRING(PrdOrdType,'0')">                   <!-- 消费-直接支付 -->
     			<set name="NotifyTyp" value="0" />
     			<set name="#url" expr="NotifyUrl" />                    <!-- 同步返回 URL 通知商城地址 -->
     
     			<if condition="IS_NOEQUAL_STRING(PayRet,'00')">
     				<set name="RspCod" expr="RspCod" />
     				<set name="Status" value="2"></set>
     				<quote name="UpdPay" />
     				<quote name="UpdPrd" />
     				<quote name="TimeTouch2" />
     				<return />
     			</if>
     
     			<set name="OrdStatus" value="01" />
     			<set name="Status" value="1" />
     
     			<set name="fee" value="0" />                               <!-- 批量作业时再去计算 -->
     
     			<!--记账处理 start -->
     			<set name="TXN_TYP" value="2" />                                <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账 -->
     			<if condition="IS_EQUAL_STRING(payType,'01')">                          <!--网银支付 -->
     				<set name="txnAmt_fee" expr="txAmt" />
     				<set name="BnkJnl" expr="payOrdNo" />
     				<set name="bankJrnNo" expr="payOrdNo" />                           <!--银行返回订单号,银行流水号 -->
     				<set name="Tran_type" value="1" />                                 <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合 -->
     
     				<!--记账所需数据 -->
     				<set name="ACC_TYP" value="01" />               <!--现金账户 -->
     				<set name="MER_ACC_TYP" value="02" />               <!-- 商户结算账户 -->
     				<set name="DR_CR_FLAG" value="+" />                <!--账户余额增减标识 + 增加 - 减少 -->
     				<set name="CCY" value="CNY" />              <!--货币类型 -->
     				<set name="AMT" expr="TXAMT" />             <!--金额 -->
     
     				<set name="IS_ACT" value="Y" />                <!--是否实时记账 Y 是 N 否 -->
     
     				<if condition="IS_EQUAL_STRING(flag,'1')">        <!--有手续费 -->
     					<set name="merPar"
     						expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')" />  <!--商户记账参数 -->
     					<set name="feePar"
     						expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')" />   <!--平台账户（手续费）记账参数 -->
     					<set name="PARAMS" expr="STRCAT(merPar,',',feePar)" />
     				</if>
     				<else>                                            <!--无手续费 -->
     					<set name="merPar"
     						expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',AMT,'/',IS_ACT,'/')" />        <!--商户记账参数 -->
     					<set name="PARAMS" expr="merPar" />
     				</else>
     			</if>
     			<elseif
     				condition="AND(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(MulType,'01'))">    <!--混合支付 -->
     				<set name="txnAmt_fee" expr="mulAmt" />
     				<set name="bankJrnNo" expr="payOrdNo" />                         <!--银行返回订单号 -->
     				<set name="Tran_type" value="5" />                               <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合 -->
     
     				<if condition="ISNULL(CASH_AC_BAL)">
     					<set name="CASH_AC_BAL" value="0" />
     				</if>
     				<if condition="ISNULL(FROZ_BALANCE)">
     					<set name="FROZ_BALANCE" value="0" />
     				</if>
     				<set name="casBal" expr="SUB(CASH_AC_BAL,FROZ_BALANCE)" />
     
     				<!--记账所需数据 -->
     				<set name="ACC_TYP" value="01" />               <!--现金账户 -->
     				<set name="MER_ACC_TYP" value="02" />           <!-- 商户结算账户 -->
     				<set name="CCY" value="CNY" />              <!--货币类型 -->
     				<set name="IS_ACT" value="Y" />                <!--是否实时记账 Y 是 N 否 -->
     				<set name="usrPar"
     					expr="STRCAT(CUST_ID,'/',ACC_TYP,'/','-','/',CCY,'/',ACCAMT,'/',IS_ACT,'/')" />  <!--用户记账参数 -->
     
     				<if condition="DOUBLECMP(casBal,5,ACCAMT)">        <!--现金账户 -->
     					<if condition="IS_EQUAL_STRING(flag,'1')">   <!--有手续费 -->
     						<set name="merPar"
     							expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',netRecAmt,'/',IS_ACT,'/')" />  <!--商户记账参数 -->
     						<set name="feePar"
     							expr="STRCAT('99999900000001','/','03','/','+','/',CCY,'/',fee,'/','N','/')" />   <!--平台账户（手续费）记账参数 -->
     						<set name="PARAMS" expr="STRCAT(usrPar,',',merPar,',',feePar)" />
     					</if>
     					<else>                                       <!--无手续费 -->
     						<set name="merPar"
     							expr="STRCAT(MERNO,'/',MER_ACC_TYP,'/','+','/',CCY,'/',txAmt,'/',IS_ACT,'/')" />      <!--商户记账参数 -->
     						<set name="PARAMS" expr="STRCAT(usrPar,',',merPar)" />
     					</else>
     				</if>
     			</elseif>
     
     			<set name="TRANTYPE" value="2" />                                    <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款 -->
     			<set name="TRANWAY" value="01" />                                   <!--01网银、02终端、03消费卡、04虚拟账户、05快捷支付 -->
     			<set name="CCODE" expr="merNo" />                                 <!--商户编号 -->
     
     			<quote name="accProcess" />
     			<if condition="#RetCod!=0">
     				<set name="RspCod" value="07005" />
     				<set name="RspMsg" value="银行付款成功，系统入账失败。请等待系统自动调账处理货联系客服人员！" />
     				<return />
     			</if>
     			<!--记账处理 end -->
     
     			<!--计算银行手续费 -->
     			<quote name="CalBnkFee" />
     
     			<quote name="UpdPay" />         <!--更新支付订单表 -->
     			<quote name="UpdPrd" />         <!--更新商品订单表 -->
     
     			<set name="SmsContent"
     				expr="STRCAT('您好，您在',merRemark,'消费金额：',AMTADDDOT(txAmt),'元，通过商物通付款成功，如有疑问请联系',merRemark,'。')"></set>
     			<quote name="sendSms" />
     
     			<set name="sucAmt" expr="AMTADDDOT(TXAMT)" />
     			<set name="sucDat" expr="sucDat" />
     			<if condition="IS_EQUAL_STRING(isProxy,'1')">
     				<if condition="GETCHARPOSFROM(NotifyUrl,0,'?')!=-1">
     					<set name="NxtPag" expr="STRCAT(NotifyUrl,'&amp;orderId=',PRDORDNO)" />
     				</if>
     				<else>
     					<set name="NxtPag" expr="STRCAT(NotifyUrl,'?orderId=',PRDORDNO)" />
     				</else>
     				<set name="_REQUESTATTR.REDIRECTURL" expr="NXTPAG" />    <!--异步通知页面 -->
     			</if>
     			<else>
     				<set name="NXTPAG" expr="succePage" />
     				<set name="_REQUESTATTR.FORWARDURL" expr="NXTPAG" />    <!--异步通知页面 -->
     			</else>
     
     			<!--增加宏文件，处理物业缴费成功，通知第三方 -->
     			<set name="ConfigName" value="PropertyMerId" />
     			<quote name="ReadXmlCfg" />
     			<if condition="IS_EQUAL_STRING(MERNO,ProMerId)">       <!-- 生产商户号为固定商户号 需要配置 -->
     				<quote name="RetBill" />
     			</if>
     			<else>
     				<quote name="TimeTouch2" />    <!--通知商城 -->
     			</else>
     			<set name="_REQUESTATTR.FORWARDURL" expr="STRCAT(payResult,'?payordno=',payOrdNo)" />
     		</if>
     		<elseif condition="IS_EQUAL_STRING(PrdOrdType,'2')">               <!-- 消费-担保支付 -->
     			<set name="NotifyTyp" value="0" />
     			<set name="#url" expr="NotifyUrl" />                    <!-- 同步返回 URL -->
     
     			<if condition="IS_NOEQUAL_STRING(PayRet,'00')">
     				<set name="RspCod" expr="RspCod" />
     				<set name="Status" value="2"></set>
     				<quote name="UpdPay" />
     
     				<quote name="UpdPrd" />
     				<quote name="TimeTouch2" />
     				<return />
     			</if>
     
     			<set name="Status" value="1" />
     
     			<!--记账处理 start -->
     			<!--计算商户手续费 -->
     			<quote name="CalMerFee" />
     			<set name="TXN_TYP" value="2" />                                <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账 -->
     			<if condition="IS_EQUAL_STRING(payType,'01')">                          <!--网银支付 -->
     				<set name="txnAmt_fee" expr="txAmt" />
     				<set name="BnkJnl" expr="payOrdNo" />
     				<set name="bankJrnNo" expr="payOrdNo" />                         <!--银行返回订单号 -->
     				<set name="Tran_type" value="1" />                               <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合 -->
     
     				<!--记账参数准备 -->
     				<set name="pltMidPar"
     					expr="STRCAT('99999900000001','/','04','/','+','/','CNY','/',txAmt,'/','N','/')" />        <!--平台担保账户记账参数 -->
     				<set name="PARAMS" expr="pltMidPar" />
     			</if>
     			<elseif
     				condition="AND(IS_EQUAL_STRING(payType,'04'),IS_EQUAL_STRING(MulType,'01'))">    <!--混合支付 -->
     				<set name="txnAmt_fee" expr="mulAmt" />
     				<set name="bankJrnNo" expr="payOrdNo" />                            <!--银行返回订单号 -->
     				<set name="Tran_type" value="5" />                                  <!--交易方式 1网银、2终端、3消费卡、4虚拟积分 5混合 -->
     
     				<if condition="ISNULL(CASH_AC_BAL)">
     					<set name="CASH_AC_BAL" value="0" />
     				</if>
     				<if condition="ISNULL(FROZ_BALANCE)">
     					<set name="FROZ_BALANCE" value="0" />
     				</if>
     				<set name="casBal" expr="SUB(CASH_AC_BAL,FROZ_BALANCE)" />
     
     				<if condition="DOUBLECMP(casBal,5,ACCAMT)">          <!--现金账户 -->
     					<set name="usrPar"
     						expr="STRCAT(CUST_ID,'/','01','/','-','/','CNY','/',ACCAMT,'/','Y','/')" />            <!--用户记账参数 -->
     					<set name="pltMidPar"
     						expr="STRCAT('99999900000001','/','04','/','+','/','CNY','/',txAmt,'/','N','/')" />      <!--平台担保账户记账参数 -->
     					<set name="PARAMS" expr="STRCAT(usrPar,',',pltMidPar)" />
     				</if>
     			</elseif>
     
     			<set name="TRANTYPE" value="2" />                                    <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款 -->
     			<set name="TRANWAY" value="01" />                                   <!--01网银、02终端、03消费卡、04虚拟账户、05快捷支付 -->
     			<set name="CCODE" expr="merNo" />
     
     			<quote name="accProcess" />
     			<if condition="#RetCod!=0">
     				<do func="RollBackWork" />
     				<set name="RspCod" value="07005" />
     				<set name="RspMsg" value="支付失败" />
     				<set name="RspMsg" value="银行付款成功，系统入账失败。请等待系统自动调账处理货联系客服人员！" />
     				<return />
     			</if>
     			<!--记账处理 end -->
     
     			<!--计算银行手续费 -->
     			<quote name="CalBnkFee" />
     
     			<set name="OrdStatus" value="01" />   <!--支付订单状态 交易成功 -->
     			<quote name="UpdPay" />                   <!--更新支付订单表 -->
     
     			<set name="OrdStatus" value="12" />   <!--商品订单状态 支付成功 -->
     			<quote name="UpdPrd" />
     
     			<set name="SmsContent"
     				expr="STRCAT('您好，您在',merRemark,'消费金额：',AMTADDDOT(txAmt),'元，通过商物通付款成功，如有疑问请联系',merRemark,'。')"></set>
     			<quote name="sendSms" />
     
     
     			<set name="sucAmt" expr="AMTADDDOT(TXAMT)" />
     			<set name="sucDat" expr="sucDat" />
     			<if condition="IS_EQUAL_STRING(isProxy,'1')">
     				<if condition="GETCHARPOSFROM(NotifyUrl,0,'?')!=-1">
     					<set name="NxtPag" expr="STRCAT(NotifyUrl,'&amp;orderId=',PRDORDNO)" />
     				</if>
     				<else>
     					<set name="NxtPag" expr="STRCAT(NotifyUrl,'?orderId=',PRDORDNO)" />
     				</else>
     				<set name="_REQUESTATTR.REDIRECTURL" expr="NXTPAG" />    <!--异步通知页面 -->
     			</if>
     			<else>
     				<set name="NXTPAG" expr="succePage" />
     				<set name="_REQUESTATTR.FORWARDURL" expr="NXTPAG" />    <!--异步通知页面 -->
     			</else>
     
     			<!--增加宏文件，处理物业缴费成功，通知第三方 -->
     			<set name="ConfigName" value="PropertyMerId" />
     			<quote name="ReadXmlCfg" />
     			<if condition="IS_EQUAL_STRING(MERNO,ProMerId)">       <!-- 生产商户号为固定商户号 需要配置 -->
     				<quote name="RetBill" />
     			</if>
     			<else>
     				<quote name="TimeTouch2" />    <!--通知商城 -->
     			</else>
     			<set name="_REQUESTATTR.FORWARDURL" expr="STRCAT(payResult,'?payordno=',payOrdNo)" />
     		</elseif>
     		<elseif condition="IS_EQUAL_STRING(PrdOrdType,'1')">               <!-- 充值 -->
     			<set name="_REQUESTATTR.FORWARDURL" expr="RegErrPage" />        <!-- 设定充值处理失败错误页面 -->
     			<if condition="IS_NOEQUAL_STRING(PayRet,'00')">
     				<set name="RspCod" expr="RspCod" />
     				<set name="Status" value="2"></set>
     				<quote name="UpdPay" />
     				<quote name="UpdReg" />               <!-- 更新充值订单 -->
     				<return />
     			</if>
     
     			<set name="acDate" expr="GETDATE()" />              <!--支付日期 -->
     			<set name="acTime" expr="GETDATETIME('HHMISS')" />  <!--支付时间 -->
     
     			<if condition="ISNULL(txnComAmt)">
     				<set name="txnComAmt" value="0" />
     			</if>
     			<if condition="DOUBLECMP(txnComAmt,'6','0')">
     
     				<set name="fee" expr="txnComAmt" />
     				<set name="netAmt" expr="SUB(txAmt,txnComAmt)" />
     				<set name="usrPar"
     					expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',netAmt,'/','Y','/')" />               <!--用户记账参数 -->
     				<set name="feePar"
     					expr="STRCAT('99999900000001','/','03','/','+','/','CNY','/',txnComAmt,'/','N','/')" />   <!--平台账户（手续费）记账参数 -->
     				<set name="PARAMS" expr="STRCAT(usrPar,',',feePar)" />
     			</if>
     			<else>
     				<set name="flag" value="0" />
     				<set name="fee" value="0" />
     				<set name="usrPar"
     					expr="STRCAT(CUST_ID,'/','01','/','+','/','CNY','/',txAmt,'/','Y','/')" />  <!--用户记账参数 -->
     				<set name="PARAMS" expr="usrPar" />
     			</else>
     			<set name="netRecAmt" expr="SUB(txAmt,txnComAmt)" />   <!--净额 -->
     
     			<!--记账处理 -->
     			<set name="TXN_TYP" value="1" />                     <!--1-充值；2-消费；3-转账；4-提现；5-保证金 6-错账调账 -->
     			<quote name="accProcess" />
     			<if condition="#RetCod!=0">
     				<do func="RollBackWork" />
     				<set name="RspCod" value="07005" />
     				<set name="RspMsg" value="充值失败" />
     				<return />
     			</if>
     
     			<!--计算银行手续费 -->
     			<set name="txnAmt_fee" expr="txAmt" />
     			<quote name="CalBnkFee" />
     
     			<set name="TRANTYPE" value="1" />             <!--交易类型 0其他,1充值、2消费、3撤销、4预授权完成、5预授权完成撤销、6转账(虚拟帐号间)、7提现、8退款 -->
     			<set name="TRANWAY" expr="payType" />        <!--交易方式 01网银、02终端、03消费卡、04虚拟账户、05快捷支付 -->
     			<set name="TXCCY" value="CNY" />
     			<set name="payType" expr="payType" />
     			<quote name="UpdPay" />               <!-- 更新支付订单 -->
     			<quote name="UpdReg" />               <!-- 更新充值订单 -->
     			<set name="merRemark" value="账户充值" /> <!-- 商户信息 -->
     			<set name="_REQUESTATTR.FORWARDURL" expr="RegSucPage" />    <!--异步通知页面 -->
     		</elseif>
     		<else>
     			<set name="MsgTyp" value="E" />
     			<set name="RspCod" value="09001" />
     			<set name="RspMsg" value="系统错误" />
     			<set name="_REQUESTATTR.FORWARDURL" expr="reqErrPage" />
     			<return />
     		</else>
     
     		<!--通知风控系统登记订单信息 -->
     		<set name="ServiceCode" value="680517" />
     		<set name="DTYPE" value="1" />                 <!--操作类型 1新增 2 修改 -->
     		<set name="TCODE" expr="payOrdNo" />           <!--平台流水号 支付订单号 -->
     		<set name="CTYPE" value="1" />                 <!--客户类型 -->
     		<set name="CLIENTCODE" expr="CUST_ID" />            <!--客户编号 -->
     		<set name="CLIENTNAME" expr="SESSIONS.USRNAME" />
     		<set name="MOBILEPHONE" expr="SESSIONS.USRMP" />
     		<set name="TAMT" expr="txAmt" />
     		<set name="TRANWAY" value="01" />
     		<set name="REGDTTIME" expr="STRCAT(acDate,acTime)" />
     		<set name="Time" expr="acDate" />
     		<quote name="noticRcs" />
     
     		<set name="sucAmt" expr="AMTADDDOT(TXAMT)" />
     		<set name="RspCod" value="00000" />
     		<set name="RspMsg" value="支付成功" />
     
     	</process>
    </transaction>
           
   
</application>  
